<?
/*
    Version History
    ====================================

    Version.    Modi.Date       Modi.By         Description
    4.1         2023-01-19      SBK             Task#9222 =>Please fix a bug in this program due to which when we try to post "Audited Returns", it does not work.
	4.0			2022-06-22		Chirag		Task#9151 -> Please fix an issue in both of these programs when we display data in Quantity Received>>>Received Time. It should use locationsystem TIMEO intvar while displaying the actual time.

			Ex: Go to nj_mgmnt and client is in Eastern Time and time posted into database is in Pacific Time and locationsystem TIMEO intvar = 3 for NJ Penn, it should add three hours to the time which exists in database while displaying it in screen.   
   3.9         2020-11-12      NRP             Task#8891 =>Please implement this new report in Dispatch>>>Quantities Received>>Total Quantities and add a new link named as "Draw Count Single Sheet".Also, add a Download CSV option in this report so that it can be exported to csv report.
    3.8         2020-11-10      SBK             Task#8892 =>When we implemented the changes in both these programs to sending the "Delivery Slips" and "Self Reporting" emails separate, we are still sending Self Reporting emails to only those customers where we are sending delivery slips via email as well.
    3.7         2020-11-03      SBK             Task#8884 =>We are modifying the Delivery Slips setting as per Task#8883 to remove DeliverySlipFlag "J"(Print & Interactive) & "K"(Duplicate and Interactive) and only support Interactive setting which will be set now in routelink.pod = 'S' instead of routelink.deliveryslipflag = 'I'.
    3.6         2020-03-18      Chirag          Task#8550 =>In the table produced by the "Calculated Draw" link in "Quantity Received", "Total Quantities", if LocationSystem NJPEN = "Y", add these columns to the right of the quantity:

--> Demographic.Sdesc - Display the DemographicValue.SDesc related to Demographic.RecId = LocationSystem NJPEN intvar.
--> Billing Method - Display the appropriate value depending on StandardDraw.InvoicingEnt: if "D" display "Buy/Sell" and if "W", display "Delivery Fee".
--> Delivery Route - Display the Route.RouteNbr related to transactivity.specificrouteid and transactivity.type = SD, unless location.type = 'R', then use transactivity.type = 'DE'
    3.5         2019-12-12      SBK             Task#6766 => solved a bug in TRA37->Select Route Set, to support new route type "ND"
    3.4         2019-09-11      Nimesh          Task#8329 =We need to add an additional logic to test and find all these Distinct specificroutes where eCommerce orders are added, i.e. transactivity SD,SP records were created based on above Merge logic and if yes, we need to optimize them using Route Smart. If it finds any routes, it will create record in routesmarttrack.Note that program need to wait till records being created are processed and once routesmarttrack record is processed, both programs will create rdsend records. Timeout time is defined in locationsystem FINDR intvar(Default : 60)
    3.3         2019-08-13      Nimesh          Task#8238 =>Please modify these three programs to support Teak Internal Control Systems modifications. 
    3.2         2019-08-06      NIMESH          Task#8253 =>We need to support two ways to filter routes for printing in groups based on locationsystem RFLTR charvar. If charvar = R (Display only Option#1), charvar = C(Display only Option#2), charvar = B(Display both options).Option#1: Filter Routes by Route Group Type.Option#2: Filter Route by Route Number Description. 
    3.1         2019-07-04      Shahbaz         Task#8202 => modify both TRA37/Auto Dispatch to send email
    3.0         2019-05-21      Shahbaz         Task#8128 => trigger EMR67
    2.9         2019-04-18      Shahbaz         Task#8106 => trigger EMR66
    2.8         2019-03-13      Shahbaz         Task#8066 => Modify to allow clients to support additional drivers
    2.7         2019-03-05      Shahbaz         Task#8058 => In order to support a client that wants to use the mid-week update "on demand" instead of automatically every day
   	2.6         2019-02-18      Chirag      Task#8032: Please modify Print Forms to add a link "Print Truck Package" as well which will print TRD53 report for selected Routes.
    2.5         2019-01-30      Shahbaz     Task#8013 => Please modify this program "Create Run Records" process to test if locationsystem ARS65 exists
    2.4         2018-10-12      FSTPL       Task#7884 =>This comment has been added to track that changes have been made in this file to support the switch from PHP5 to PHP7
    2.3         2019-01-08      Nimesh     Task#7973:We realized an issue in "Create Run Records" step, in which currently it would map SPs where PU does not exists to Returns Routes based on below logic:In the Create Run Records process, for ReturnsFlag = "R" locations, we should update TransActivity.SpecificRouteId to the appropriate Returns Route for any SP where no PU exists going back LocationSystem RETNU days. Also, currently program finds the loation Period End Date based on Routelink.BillingPeriodDayCodeId and then find all SP records <= Period End Date upto RETNU days.
    Now, this causes issues to those clients who pick their closed stores returns weekly but still create accounting invoice based on a different billing cycle.So, we need to modify this process to support three modes of linking SPs to Collections routes based on locationsystem CRMOD charvar value.
    If locationsystem CRMOD = "B" or it does not exists(Default), we will do as current and map any uncollected SP <= recent billing period end date based on specificproduct.datex going back LocationSystem RETNU days.
    If locationsystem CRMOD = "N", we will find all uncollected SPs based on specificproduct.datex going back LocationSystem RETNU days.
    If locationsystem CRMOD = "P", we will find any uncollected SPs <= Most Recent Locationsystem PDEND based on specificproduct.datex going back LocationSystem RETNU days.

    2.2         2018-06-06      Chirag      Task#7721: tranactivity PD,PP records and create related SD, SP records if transactivity records are related to Shadow Route only. We have realized now that we should create SD,SP records related to PD,PP for all routes irrespective of route type.
	                                        
											Task#7725:-> Modify the "Create Run Records" process to check in end, if clientsystem WAN46 exists and charvar = 'Y' and if found, it will set the current DateTime into StrVar and the Dispatch Date into DateVar. We should modify the Auto Dispatch as well for the same.
											
				2018-06-06		Nimesh		Task#7720:-> When we modified Check Runs function to display those cases also where "More than one Returns Route" exists , it also started showing error cases in "More than one route" if a location is on one Delivery Route and one Returns Route which is okay and should not be displayed in Check Runs.
											
2.1         2018-05-23      Nimesh      Task#7658:Please modify both "Check Runs" and "Adjust Draw-->Redeploy Multiples" to display those cases where more than two Returns routes exists for a location.
    2.0        2018-04-16       Nimesh	   Task#7655->Add bundle and Loose count  columns to the "Print Forms" > "Route Summary by Group" > "Dispatch Grouping" view. 
	1.10        2018-03-27      Shahbaz     Task#7646->Modify the TRA37 program to not set productdispatch.Closedrawdt.
    1.9         2018-03-20	Shahbaz      Task#7632 -> Please see why in Express, Dispatch-->Run Date : 03/14--->Total Quantities--->New Homes Guide--->Place Order options(Driver Group, Actual Route, Price Code, Normal Route) shows different draws than dispatched draws for New Homes Guide publication.
	1.8          2018-01-24		Chirag		Task#7561 -> In Quantity Received > Total Quantities > Place Order > Route Group, the quantities do not reflect lagged quantities correctly
	1.7         2017-11-01      Chirag     	Task#7423 -> Modify the "Create Run Records" to support an alternate method of updating TransActivity.SpecificRouteId.
	1.6         2017-10-11      Chirag     	Task#7408 -> Ignore Route Logic has error.
	1.5         2017-10-03      Chirag     	Task#7382 -> Shadow routes Logic.
	1.4         2017-07-29      Rahul   	Task#7240: modify programs to support "Regional Access" based on locationsystem REGRB charvar = 'Y'. 
	1.3         2017-05-06     	rahul     	Task#7118 -> make changes in emails subjects to avoid them going to spam folders in both TRA37 and Auto Dispatch.
	1.2         2017-03-03     	Bela     	Task#7000 -> fix the page break issue with Google Chrome when Total Quantities--->Count Sheets by Route does not print each route on a separate page.
    1.1         2016-09-02      Shahbaz     Task#6793 -> Fix an issue in Dispatch ---> Print Forms---->"Route Summary by Group" due to which it does not print it in proper format
    1.0         2016-07-25      Chirag      Task#6759 -> Add 'ND' Route Type support.
    0.0         2015-07-25      Admin       Program registered under version history.
  ====================================
*/
DEFINE("v_what_version", "4.1");
DEFINE("v_what_date", "2023-01-19");
/*
	Route Delivery Services.
	------------------------
	 fs_version:2
     fs_modi_on:10/10/2012
     fs_modi_by:Chinmay
     fs_task_no:4829
     fs_copyrights: Teak System Incorporated 

	AUTHOR              :   FrenzIndia
	CREATED FOR         :   Teak Systems Incorporated

	Date Created        :   11/13/03
	Date Modified       :   05/10/10

	(c) COPYRIGHT 2002-09 Teak Systems Incorporated
	=================================================================

	SCREEN          :   TRA37

	VERSIONS        :

	DESCRIPTION     :   This screen is used by the dispatcher to make sure
	                    that all routes are good, all product quantities are
	                    good, etc. so that, when the drivers download their
	                    routes that all is good.

	CALLED FROM     :   TRB97

	CALL TO         :   DEV01, TRA07, TRA29, TRA30, TRA31, TRA32, TRA70,
	                    SE028, EML07

	ERROR FILE CODE :   20180137 (TRA37)
*/
?>
<?
##################
#	HEADERS:
##################
header("Cache-control: no-cache");
ini_set("max_execution_time","0");
?>
<?
##################
#	INCLUDES:
##################
include('../flagvalidity.php');
include('../cm/asinfo.php');
include('../teakHistory.php');

// OTHER FILES
include('../cm/commonfunc.php');
include('../cm/commonarray.php');
include('../cm/locfunc.php');
include('../rd/standarddraw.php');
include('../cm/getinsqry.php');
include('../cm/csv.php'); //Task#8891
include('../rd/product.php');
include('../rd/trafunc.php');
include('../rd/tradatefunc.php');
include('../rd/transactfunc.php');
include('../cm/htmlMimeMail.php');
include('../cm/htmlMimeMailEx.php');
include('../rd/specificdraw.php');
include('../rd/editionfunc.php');
include('../rd/daycode.php');
include_once('../cm/archivefunc.php');

?>
<?
##################
#	VERSIONING:
##################
//GET PAGENBRVERSION
//$debug=1;
$selectStr = "pagename";
$fromStr = "pagemaster";
$whereStr = "pagenbr = '$PageNbr'";
$fileLineNbr = __LINE__; $valArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
unset($selectStr, $fromStr, $whereStr);

if($valArr) {
	$tempPageFile = $valArr[pagename];
}
else {
	$tempPageFile = "";
}
///// CHANGE HERE /////
switch($tempPageFile) {
		case "../rd/trb97.php":
			$PAGENBRVERSION = "TRB97";
			break;

		default:
			$PAGENBRVERSION = $PageNbr;
			break;
}
?>
<?
/*
	OTHER PAGENBR LOGIC
	NOW WE WILL CHECK WHETHER THE PAGE IS OTHER THAN THE VERSIONS
	OF THIS PAGE - IF IT IS, THEN MAKE IT OTHERPAGENBR AND SET PAGENBR TO ONE OF
	THE ORIGINAL VERSION OF THIS PAGE
	REMEMBER TO SET OTHERPAGENBR TO PAGENBR WHENEVER THIS SCREEN IS CALLED AGAIN
*/
if($PageNbr != "TRA37") {
		$OtherPageNbr = $PageNbr;

		// NOW SET PageNbr ACCORDING TO OtherPageNbr
		switch($PAGENBRVERSION) {
			default:
				$PageNbr = "TRA37";
				break;
		}

		if($debug)
			print("PageNbr = $PageNbr & OtherPageNbr = $OtherPageNbr<br /><br />\n");
}
?>
<?
##################
#	VALIDATION:
##################
// VALIDATION CHECKS

// FOR pdid
if(isset($pdid)) {
	if(!is_numeric($pdid)) $pdid = 0;

	// VALIDITY CHECKS
	$qryChkValidity = "SELECT COUNT(*) cntRec
						FROM productdispatch
						WHERE clientlocid = $ASLocationID
						AND recid = $pdid";
	if($debug) print("$qryChkValidity<br />");
	$rsltChkValidity = mysqli_query( $cvtconnection, $qryChkValidity);
	if(!$rsltChkValidity) {
		$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 1);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($fileLineNbr);
	}
	else {
		$rowChkValidity = mysqli_fetch_assoc($rsltChkValidity);
		if($rowChkValidity[cntRec] == 0)
			header("Location: ../cm/logoff.php");
	}
}

// FOR RSID
if(isset($rsId)) {
	if(!is_numeric($rsId)) $rsId = 0;

	// VALIDITY CHECKS
	$qryChkValidity = "SELECT COUNT(*) cntRec
						FROM routeset
						WHERE clientlocid = $ASLocationID
						AND recid = $rsId";
	if($debug) print("$qryChkValidity<br />");
	$rsltChkValidity = mysqli_query( $cvtconnection, $qryChkValidity);
	if(!$rsltChkValidity) {
		$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 1);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($fileLineNbr);
	}
	else {
		$rowChkValidity = mysqli_fetch_assoc($rsltChkValidity);
		if($rowChkValidity[cntRec] == 0)
			header("Location: ../cm/logoff.php");
	}
}

// FOR SRID
if(isset($srid)) {
	if(!is_numeric($srid)) $srid = 0;

	// VALIDITY CHECKS
	$qryChkValidity = "SELECT COUNT(*) cntRec
						FROM specificroutes sr, route r
						WHERE sr.recid = $srid
						AND sr.dispatchlocid = $ASLocationID
						AND r.recid = sr.routeid
						AND r.locationid = $ASLocationID
						AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
						OR r.endeffdt > '$curDate' )";

	// FOR SPLITTING OF TABLES
	$qryChkValidity = convertToSplitTables($qryChkValidity, $val_SPLIT);

	if($debug) print("$qryChkValidity<br />");
	$rsltChkValidity = mysqli_query( $cvtconnection, $qryChkValidity);
	if(!$rsltChkValidity) {
		$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 1);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($fileLineNbr);
	}
	else {
		$rowChkValidity = mysqli_fetch_assoc($rsltChkValidity);
		if($rowChkValidity[cntRec] == 0)
			header("Location: ../cm/logoff.php");
	}
}

// FOR LOCID
if(isset($locid)) {
	if(!is_numeric($locid)) $locid = 0;

	// VALIDITY CHECKS
	$qryChkValidity = "SELECT COUNT(*) cntRec
						FROM routelink
						WHERE clientid = $ASCompanyID
						AND locationid = $locid";
	if($debug) print("$qryChkValidity<br />");
	$rsltChkValidity = mysqli_query( $cvtconnection, $qryChkValidity);
	if(!$rsltChkValidity) {
		$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 1);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($fileLineNbr);
	}
	else {
		$rowChkValidity = mysqli_fetch_assoc($rsltChkValidity);
		if($rowChkValidity[cntRec] == 0)
			header("Location: ../cm/logoff.php");
	}
}
?>
<?
/*
	DECIDING THE PAGENBR THAT IS TO BEPASSED WITH EACH QUERY
	DEPENDING ON OTHERPAGENBR SET OR NOT
*/
if(!isset($OtherPageNbr) || $OtherPageNbr == "") {
	$PassedPageNbr = $PageNbr;
}
else {
	$PassedPageNbr = $OtherPageNbr;
}

// GET PAGE TITLE DEPENDING ON PassedPageNbr
$qryGetPageTitle = "SELECT sdesc FROM pagemaster WHERE pagenbr = '$PassedPageNbr'";
$rsltGetPageTitle = mysqli_query( $cvtconnection, $qryGetPageTitle) or die ("<br />Invalid query Get Page Title");
if($rowGetPageTitle = mysqli_fetch_assoc($rsltGetPageTitle)) {
	$title = $rowGetPageTitle['sdesc'];
}
?>
<?
##################
#	ARRAYS:
##################

$typeArr = GeneralArray("transactivity.type");

// RETURNS ARRAY IN DAY TO DOW FORMAT
$dayToDowArr = GeneralArray("daytodow");

// PRODUCTDISPATCH FIELDS ARRAY
$pdFieldsArr = GeneralArray("tra37order_buttons");

// FOR GROUP CONCAT
$qrySetSysVar = "SET @@session.group_concat_max_len = 9999999";
if($debug) print("$qrySetSysVar<br />\n");
$rsltSetSysVar = mysqli_query( $cvtconnection, $qrySetSysVar);
?>
<?
##################
#	SYSTEM VARS:
##################
// FINDING System, LocationSystem, ClientSystem and PersonSystem RECORDS
if($debug) print("<b>{$ASCompanyID} : {$ASLocationID} : {$PersonId} : {$RecIdAS} : {$val_SPLIT}</b><br />\n");

// GETTING System INDEF - FOR INDEFINITE DATE
$val_INDEF = GetSysVar("INDEF", "DATE_FORMAT(datevar, '%Y-%m-%d')", $cvtconnection);
if($debug) print("INDEF = $val_INDEF<br />\n");

// GETTING ClientSystem DELCO - FOR DELETE COMPANY RECID
$val_DELCO = GetCSVar("DELCO", "intvar", $ASCompanyID, $cvtconnection);
if(!is_numeric($val_DELCO)) $val_DELCO = 0;
if($debug) print("DELCO = $val_DELCO<br />\n");

// GETTING ClientSystem DEMPO - FOR DEMOGRAPHIC REPORT
$val_DEMPO = GetLSVar("DEMPO", "intvar", $ASLocationID, $cvtconnection);
if(!is_numeric($val_DEMPO)) $val_DEMPO = 0;
if($debug) print("DEMPO = $val_DEMPO<br />\n");

// GETTING LocationSystem SLUGR - FOR SLUGS REQUIRED FLAG
$val_SLUGR = GetLSVar("SLUGR", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("SLUGR = $val_SLUGR<br />\n");

// GETTING LocationSystem PBDEL - FOR PRE-BUNDLING FEATURE FLAG
$val_PBDEL = GetLSVar("PBDEL", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("PBDEL = $val_PBDEL<br />\n");

// GETTING LocationSystem CSBDL - FOR CUSTOMER SPECIFIC PRE-BUNDLING FEATURE FLAG
$val_CSBDL = GetLSVar("CSBDL", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("CSBDL = $val_CSBDL<br />\n");

// GETTING LocationSystem REDIS - FOR REGIONAL DISPATCH FLAG
$val_REDIS = GetLSVar("REDIS", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("REDIS = $val_REDIS<br />\n");

// GETTING LocationSystem REGIN - FOR REGION FLAG
$val_REGIN = GetLSVar("REGIN", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("REGIN = $val_REGIN<br />");

// GETTING LocationSystem VSGRT - FOR VENDING SUBGROUP ROUTE LINK
$val_VSGRT = GetLSVar("VSGRT", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("VSGRT = $val_VSGRT<br />\n");

// GETTING LocationSystem VMCPY - FOR VENDING MACHINE COMPANY RECID
$val_VMCPY = GetLSVar("VMCPY", "intvar", $ASLocationID, $cvtconnection);
if(!is_numeric($val_VMCPY)) $val_VMCPY = 0;
if($debug) print("VMCPY = $val_VMCPY<br />");

// GETTING LocationSystem ESRTE - FOR EARLY SUPPLY ROUTE FLAG
$val_ESRTE = GetLSVar("ESRTE", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("ESRTE = $val_ESRTE<br />\n");

// GETTING LocationSystem RSMAX - FOR CHECKING OF RESUPPLY ROUTES
$val_RSMAX = GetLSVar("RSMAX", "intvar", $ASLocationID, $cvtconnection);
if(!is_numeric($val_RSMAX)) $val_RSMAX = 0;
if($debug) print("RSMAX = $val_RSMAX<br />\n");

// GETTING LocationSystem BURND - FOR ROUTE ROUNDING FACTOR
$val_BURND = GetLSVar("BURND", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("BURND = $val_BURND<br />\n");

// GETTING LocationSystem PLORD - FOR DISPATCH PLACE ORDER FLAG - CHARVAR
$val_PLORD = GetLSVar("PLORD", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("PLORD = $val_PLORD<br />");

// GETTING LocationSystem PLORD - FOR DISPATCH PLACE ORDER FLAG - INTVAR
$lsIntPlord = GetLSVar("PLORD", "intvar", $ASLocationID, $cvtconnection);
if(!is_numeric($lsIntPlord)) $lsIntPlord = 0;
if($debug) print("lsIntPlord = $lsIntPlord<br />\n");

// GETTING LocationSystem HOMED - FOR PRINTING HOME DELIVERY ROUTE SHEETS
$val_HOMED = GetLSVar("HOMED", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("HOMED = $val_HOMED<br />\n");

// GETTING LocationSystem ESTTD - FOR ESTIMATED TIME BETWEEN STOPS
$val_ESTTD = GetLSVar("ESTTD", "intvar", $ASLocationID, $cvtconnection);
if(!is_numeric($val_ESTTD)) $val_ESTTD = 0;
if($debug) print("ESTTD = $val_ESTTD<br />\n");

if($val_ESTTD < 10) {
	$tempRelTime = "00:0" . $val_ESTTD . ":00";
}
else {
	$tempRelTime = "00:" . $val_ESTTD . ":00";
}

// GETTING LocationSystem DRREQ - FOR DRIVER REQUIRED FLAG
$val_DRREQ = GetLSVar("DRREQ", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("DRREQ = $val_DRREQ<br />\n");

// GETTING LocationSystem RDSZP - FOR ZIP CODE ON ROUTE DELIVERY SHEET
$val_RDSZP = GetLSVar("RDSZP", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("RDSZP = $val_RDSZP<br />\n");

// GETTING LocationSystem TRA37 - FOR PAGE BREAK FOR COUNT SHEETS - ROUTE
$val_TRA37 = GetLSVar("TRA37", "intvar", $ASLocationID, $cvtconnection);
if(!is_numeric($val_TRA37)) $val_TRA37 = 30;
if($debug) print("TRA37 = $val_TRA37<br />\n");

// GETTING LocationSystem DSINS - FOR DELIVERY SLIP INSTRUCTIONS
$val_DSINS = GetLSVar("DSINS", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("DSINS = $val_DSINS<br />\n");

// GETTING LocationSystem RDSND - FOR NUMBER OF DAYS PER RUN
$val_RDSND = GetLSVar("RDSND", "intvar", $ASLocationID, $cvtconnection);
if(!is_numeric($val_RDSND)) $val_RDSND = 1;
if($debug) print("RDSND = $val_RDSND<br />\n");

// GETTING LocationSystem HWKPR - FOR HAWKER PAYROLL LOCATIONS
$val_HWKPR = GetLSVar("HWKPR", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("HWKPR = $val_HWKPR<br />\n");

// GETTING LocationSystem MNZIP - FOR MAIN ZIP CODE FLAG
$val_MNZIP = GetLSVar("MNZIP", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("MNZIP = $val_MNZIP<br />\n");

// GETTING LocationSystem EMREG - FOR EMAIL ROUTE DELIVERY SHEETS
$val_EMREG = GetLSVar("EMREG", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("EMREG = $val_EMREG<br />\n");

// GETTING LocationSystem SRTDI - FOR ROUTE SHEET COMMENT - STRVAR
$str_RTMSG = GetLSVar("RTMSG", "strvar", $ASLocationID, $cvtconnection);
if($debug) print("RTMSG = $val_RTMSG<br />");

// GETTING LocationSystem SRVCE - FOR SERVICE PROVIDED - DT or RD
$val_SRVCE = GetLSVar("SRVCE", "strvar", $ASLocationID, $cvtconnection);
if($debug) print("SRVCE = $val_SRVCE<br />\n");

// GETTING LocationSystem RDSCO - FOR ROUTE DELIVERY SHEET FORMAT
$val_RDSCO = GetLSVar("RDSCO", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("RDSCO = $val_RDSCO<br />\n");

// GETTING LocationSystem VMONY - FOR VENDING MACHINE ONLY
$val_VMONY = GetLSVar("VMONY", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("VMONY = $val_VMONY<br />");

// GETTING LocationSystem RSCMT - FOR DELIVERY INSTRUCTIONS
$val_RSCMT = GetLSVar("RSCMT", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("RSCMT = $val_RSCMT<br />\n");

// GETTING LocationSystem RDSRT - FOR SORTING OF PUBLICATION EXCEPT THE REQUIRE DRAW
$val_RDSRT = GetLSVar("RDSRT", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("RDSRT = $val_RDSRT<br />\n");

// GETTING LocationSystem SKIPS - FOR DISPLAYING SKIP SECTION
$val_SKIPS = GetLSVar("SKIPS", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("SKIPS = $val_SKIPS<br />\n");

// GETTING LocationSystem SRTDI - FOR DELIVERY ORDER NOTIFICATION
$val_SRTDI = GetLSVar("SRTDI", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("SRTDI = $val_SRTDI<br />\n");

// GETTING LocationSystem SMILY - FOR SMILE/FROWN - ROUTE DELIV SHEET
$val_SMILY = GetLSVar("SMILY", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("SMILY = $val_SMILY<br />\n");

// GETTING LocationSystem RTMSG - FOR ROUTE SHEET COMMENT - CHARVAR
$chr_RTMSG = GetLSVar("RTMSG", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("RTMSG = $val_RTMSG<br />\n");

// GETTING LocationSystem RDDEM - FOR DEMOGRAPHIC COLUMN IN TRA32 - INTVAR
$RDDEM_int = GetLSVar("RDDEM", "intvar", $ASLocationID, $cvtconnection);
if(!is_numeric($RDDEM_int)) $RDDEM_int = 0;
if($debug) print("RDDEM = $RDDEM_int<br />\n");

// GETTING LocationSystem RDDEM - FOR DEMOGRAPHIC COLUMN IN TRA32 - CHARVAR
$RDDEM_char = GetLSVar("RDDEM", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("RDDEM = $RDDEM_char<br />\n");

// GETTING LocationSystem EDITN - FOR DISPLAYING EDITION Quantity Recieved
$val_EDITN = GetLSVar("EDITN", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("EDITN = $val_EDITN<br />\n");

// GETTING LocationSystem RTGRP - FOR ROUTE GROUP
$val_RTGRP = GetLSVar("RTGRP", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("RTGRP = $val_RTGRP<br />\n");

// GETTING LocationSystem HAWKS - FOR HAWKER LOCATIONS
$val_HAWKS = GetLSVar("HAWKS", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("HAWKS = $val_HAWKS<br />\n");

// GETTING LocationSystem EMLID - FOR FROM EMAIL
$val_EMLID = GetLSVar("EMLID", "strvar", $ASLocationID, $cvtconnection);
if($debug) print("EMLID = $val_EMLID<br />\n");
if($val_EMLID == "") {
	$val_EMLID = "noreply@teakwce.com";
}

// GETTING LocationSystem CDRWP - FOR AUTOMATIC CLOSE DRAW IN PROCESS
$date_CDRWP = GetLSVar("CDRWP", "datevar", $ASLocationID, $cvtconnection);
if($debug) print("CDRWP = $val_CDRWP<br />");

// GETTING LocationSystem MERGE - TO DISPLAY MERGE ROUTE LINK
$val_MERGE = GetLSVar("MERGE", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("MERGE = $val_MERGE<br />\n");

// GETTING LocationSystem DCART - FOR DISPATCHER COMMENT
$val_DCART = GetLSVar("DCART", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("DCART = $val_DCART<br />\n");

// GETTING LocationSystem RAGRP - FOR PRINTING Route Group Sort for Returns Audit
$val_RAGRP = GetLSVar("RAGRP", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("RAGRP = $val_RAGRP<br />\n");

// GETTING LocationSystem RTDIS  - FOR ignore Route 
$val_RTDIS  = GetLSVar("RTDIS ", "strvar", $ASLocationID, $cvtconnection);
if($debug) print("RTDIS  = $val_RTDIS<br />\n");

$ignoreRtType = '';
if($val_RTDIS)
{
	$splitVal = explode("~",$val_RTDIS);
	foreach($splitVal as $RouteType)
	{
		if($ignoreRtType)
		{
			$ignoreRtType .= ",'$RouteType'";
		}else{
			$ignoreRtType = "'$RouteType'";
		}
		
		
	}
}
if(!$ignoreRtType)
	$ignoreRtType = 0;

// GETTING LocationSystem ARS65
$char_ARS65 = GetLSVar("ARS65", "charvar", $ASLocationID, $cvtconnection);
if ($debug)
    print("ARS65 = $char_ARS65<br />\n");

// GETTING LocationSystem ARS66
$char_ARS66 = GetLSVar("ARS66", "charvar", $ASLocationID, $cvtconnection);
if ($debug)
    print("ARS66 = $char_ARS66<br />\n");

// GETTING LocationSystem ARS67
$char_ARS67 = GetLSVar("ARS67", "charvar", $ASLocationID, $cvtconnection);
if ($debug)
    print("ARS67 = $char_ARS67<br />\n");
	
/*Task#8550 Start*/
// GETTING LocationSystem NJPEN
$char_NJPEN = GetLSVar("NJPEN", "charvar", $ASLocationID, $cvtconnection);
if ($debug)
    print("NJPEN = $char_NJPEN<br />\n");
	
$int_NJPEN = GetLSVar("NJPEN", "intvar", $ASLocationID, $cvtconnection);
if ($debug)
    print("NJPEN = $int_NJPEN<br />\n");
/*Task#8550 End*/


/* 3.2*/
// GETTING LocationSystem RFLTR -  FOR SUPPORT TWO WAYS TO FILTER ROUTES
$val_RFLTR = GetLSVar("RFLTR", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("RFLTR = $val_RFLTR<br />\n");

$Intvar_RFLTR = GetLSVar("RFLTR", "intvar", $ASLocationID, $cvtconnection);
if(!is_numeric($Intvar_RFLTR)) $Intvar_RFLTR = 6;
if($Intvar_RFLTR > 10) $Intvar_RFLTR = 10;
if($debug) print("Intvar_RFLTR = $Intvar_RFLTR<br />\n");
/* 3.2*/

//Task#9151 Start
// GETTING LocationSystem TIMEO - FOR LOCAL TIME OFFSET
$val_TIMEO = GetLSVar("TIMEO", "intvar", $ASLocationID, $cvtconnection);
if(!is_numeric($val_TIMEO)) $val_TIMEO = 0;
if($debug) print("TIMEO = $val_TIMEO<br />\n");
//Task#9151 End

/*3.3*/
$disp_flag_1 = $disp_flag_2 = 1;
//GETTING CLIENT SYSTEM ICSYS -  FOR SUPPORT TEAK INTERNAL CONTROL SYSTEM
$char_ICSYS = GetCSVar("ICSYS", "charvar", $ASCompanyID, $cvtconnection);
if ($char_ICSYS == "Y") {
    include('../cl/perpoint.php');
    $objperpoint = new perpoint();
    $perpointDataArray = $objperpoint->select_perpoint($PAGENBRVERSION);
    if ($debug) {
        echo '<pre>';
        print_r($perpointDataArray);
        echo '</pre>';
    }

    if (!array_key_exists('1', $perpointDataArray['perpointnbr']) || $perpointDataArray['perpointnbr']['1']['viewok'] == "N") {
        $disp_flag_1 = 0;
    }

    if (!array_key_exists('2', $perpointDataArray['perpointnbr']) || $perpointDataArray['perpointnbr']['2']['viewok'] == "N") {
        $disp_flag_2 = 0;
        
    }
    
}//END if($char_ICSYS == "Y")
/*3.3*/

?>
<?
##################
#	ERROR CHECK:
##################
$flagError = false;
$errorMsg = "";

/*
	THIS ERROR CASE WILL ENSURE THAT FOR VARIOUS BUTTONS IF THERE ALREADY EXIST DE, AD, OR
	PU RECORDS THEN DONT ALLOW USER TO USE THAT BUTTON
*/
if( in_array($doAction, array("ToSelRouteSet", "ToCheckRuns", "ToAdjDraw") ) ) {
	if(!is_numeric($pdid)) $pdid = 0;

	if($pdid != 0) {
		// GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		// CHECK
		if(IsActualActivitiyDone_TRA37($dbEffDt)) {
			$flagError = true;
			$errorMsg = "Sorry, the current set is already in use for this day and cannot be changed.";
			$PrevAction = $doAction;
			$doAction = "ActExistMsg";
		}
		elseif(isCreateRunRecsDone_TRA37($pdid)) {

			$flagError = true;
			$msgText = ($doAction == "ToSelRouteSet") ? "Select Route Set" : ( ($doAction == "ToCheckRuns") ? "Check Runs" : "Adjust Draw");
			$errorMsg = "Sorry, you can not run the \"$msgText\" now. Please do the \"Close Draw\" process again.";
			$PrevAction = $doAction;
			$doAction = "ActExistMsg";

		}
		elseif($doAction == "ToAdjDraw") {
			$effdt = set_date($dbEffDt, "YYYY-MM-DD", "MMDDYY");
			header("Location: ../rd/tra29.php?PageNbr=$PassedPageNbr&effdt=$effdt");
			exit();
		}
	}
}

if($doAction == "CreateRunRecs") {
	/*
		WHEN CREATE RUN RECS IS USED, AND IF THERE IS SOME REDEPLOY MULTIPLE CASE,
		IT SHOULD BE TAKEN FROM THE LAST WEEK BUT IF NOT THEN IT SHOULD BE GIVEN
		WARNING MSG.
	*/
	if(!is_numeric($pdid))	$pdid = 0;
	if($pdid != 0) {
		// GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {

			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		if($debug)
			print("<b>createrunrecs here $dbEffDt</b><br /><br />");

		$rsltArr = ReDepMulExists_TRA37($dbEffDt);
		if($rsltArr[flagExist]) {
			$PrevAction = $doAction;
			$doAction = "ActExistMsg";
			$Act = "ReDepMul";
		}
		else {
			// SET THE ARRAY TO SOME OTHER ARRAY SO THAT IT CAN BE USED IN
			// CREATE RUN RECORD PROCEDURE DIRECTLY.
			$redepmul_array = $rsltArr[redepmul_array];
		}
		unset($rsltArr);
	}
}

/*
	IF ROUTESET IS selected=\"selected\" MAKE SURE THAT THERE IS ONLY ONE STANDARDROUTE(DELIVERY)
	AND ONLY ONE RETURNS ROUTE.
*/
if($doAction == "SelRouteSet") {

	// VALIDATION
	ValidateForInt(false, "pdid");

	// GET EFFDT
	$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid,
		"DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
	if($rsltArr[rtvalue]) {
		$dbEffDt = $rsltArr[dbEffDt];
	}
	else {
		$dbEffDt = "";
	}
	unset($rsltArr, $fileLineNbr);

	// GET DOW
	$dow_effdt = strtoupper(date("D", mktime(0, 0, 0, substr($dbEffDt, 5, 2), substr($dbEffDt, 8, 2), substr($dbEffDt, 0, 4))));

	$routesettype_array = GeneralArray("routeset.type");
	$rs2route_array = GeneralArray("routeset2route");

	if($debug) {
		print("rsIdArr = ");
		print_r($rsIdArr);
		print("<br />\n");
	}

	foreach($rsTypeArr AS $cntid => $rstype) {
		// GET RELATED ROUTETYPE
		$routetype_array = $rs2route_array[$rstype];
		$routetype_str = MakeStrFromArray($routetype_array, ", ", "'");
		if($routetype_str == "") $routetype_str = "''";

		// GET ONE BY ONE ROUTESET TYPES AND CHECK WHETHER IT IS NECESSARY OR NOT
		// AND IF YES THAT A ROUTESET IS selected=\"selected\" OR NOT.
		$qryChkRecs = "SELECT COUNT(*) FROM routefrequency rf, route r
						WHERE r.locationid = $ASLocationID
						AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
						OR r.endeffdt > '$dbEffDt' )
						AND r.type IN ($routetype_str)
						AND rf.routeid = r.recid
						AND rf.dow = '$dow_effdt'
						AND ( rf.endeffdt IS NULL OR rf.endeffdt = '0000-00-00'
						OR rf.endeffdt > '$dbEffDt' )";
		if($debug)
			print($qryChkRecs . "<br />\n");
		$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
		$flagExist = false;
		if(!$rsltChkRecs) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(1, 1);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($rowChkRecs = mysqli_fetch_row($rsltChkRecs)) {
				$NoRecs = $rowChkRecs[0];
				if(!is_numeric($NoRecs)) $NoRecs = 0;
				if($NoRecs > 0) $flagExist = true;
			}
		}

		if($flagExist) {
			if(!is_numeric($rsIdArr[$cntid])) $rsIdArr[$cntid] = 0;
			if($rsIdArr[$cntid] == 0) {
				$flagError = true;
				$errorMsg = "Please select {$routesettype_array[$rstype]}";
				$PrevAction = $doAction;
				$doAction = "ToSelRouteSet";
				break;
			}
		}
	}
	if($val_DRREQ == "Y") {
		$rsIdArr = array_values($rsIdArr);
		for($tempi = 0; $tempi < count($rsIdArr); $tempi++) {
			if(!is_numeric($rsIdArr[$tempi])) $rsIdArr[$tempi] = 0;
			if($rsIdArr[$tempi] == 0)
				unset($rsIdArr[$tempi]);
		}
		$rsIdArr = array_values($rsIdArr);

		$routeSetIdStr = MakeStr_TRA37($rsIdArr);
		if($routeSetIdStr == "") $routeSetIdStr = "0";

		$qryChkRecs = "SELECT COUNT(DISTINCT(r.recid)) routeCnt
						FROM routesetdetail rsd, route r
						WHERE rsd.routesetid IN (" . $routeSetIdStr . ")
						AND r.recid = rsd.routeid
						AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
						OR r.endeffdt > '$dbEffDt' )
						AND ( rsd.endeffdt IS NULL OR rsd.endeffdt = '0000-00-00' OR rsd.endeffdt > '$curDate' )
						AND ( r.defaultdriverid IS NULL OR r.defaultdriverid = 0 OR r.defaultdriverid = '')";
		if($debug)
			print($qryChkRecs . "<br />\n");
		$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
		$flagExist = false;
		if(!$rsltChkRecs) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(1, 1);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			$rowChkRecs = mysqli_fetch_assoc($rsltChkRecs);
			$routeCnt = $rowChkRecs[routeCnt];
		}

		if($routeCnt > 0) {
			$PrevAction = $doAction;
			$doAction = "DispRoute";
		}
	}
}

/*
	CHECKING FOR CLOSEDRAW PROCESS IS RUNNING OR NOT.
*/
if($doAction == "ToCloseDraw") {

	$qryGetLsCDRWP = " SELECT charvar, DATE_FORMAT(datevar, '%m/%d/%y') dateVal
						FROM locationsystem
						WHERE recid = 'CDRWP'
						AND locationid = $ASLocationID";
	if($debug) print("$qryGetLsCDRWP<br />");
	$rsltGetLsCDRWP = mysqli_query( $cvtconnection, $qryGetLsCDRWP);

	if(!$rsltGetLsCDRWP) {
		$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(1, 1);
		print("<br /><br /><span class=\"dataerror\">Error Occurred. ErrorCode: " .
		$strErrorCode . "</span><br /><br />\n");
		unset($fileLineNbr);
	}
	else {
		$rowGetLsCDRWP = mysqli_fetch_assoc($rsltGetLsCDRWP);
		$val_CDRWP = $rowGetLsCDRWP[charvar];
		$dateVal_CDRWP = $rowGetLsCDRWP[dateVal];
	}

	//$val_CDRWP = GetLSVar("CDRWP", "charvar", $ASLocationID, $cvtconnection);

	if($debug) {
		print("CDRWP = $val_CDRWP<br />\n");
		print("dateVal_CDRWP = $dateVal_CDRWP<br />\n");
	}

	if($val_CDRWP == "P") {
		$flagError = true;
		$errorMsg = "Close Draw process is already running for " . $dateVal_CDRWP . ".";
		$PrevAction = $doAction;
		$doAction = "";
	}
}

/*
	WHEN NO "LOCATION ON MORE THAN ONE ROUTE" LOCATIONS EXISTS
	THEN IT WILL DIRECTLY REDIRECT TO THE CHECK RUNS PROCESS
	INSTEAD TO MERGE ROUTES POPUP
*/
if($doAction == "ToMergeRoutes") {

	// FINDING THE PRODUCTDISPATCH DETAILS
	$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "rundate dbRunDate", "routesetid routeSetId");
	if($rsltArr[rtvalue]) {
		$dbRunDate = $rsltArr[dbRunDate];
	}
	else {
		$dbRunDate = "";
	}
	unset($rsltArr, $fileLineNbr);

	$stdRtArr = GeneralArray("routetype_standard");
	$stdRtStr = MakeStrFromArray($stdRtArr, ", ", "'");
	if($stdRtStr == "") $stdRtStr = "''";
	$stdRtStr .= ", 'RR', 'SS', 'CR', 'PR'";

	if($val_ESRTE == "Y") {
		$stdRtStr .= ", 'ER'";
	}

	if($val_HAWKS == "Y") {
		$stdRtStr .= ", 'AM', 'PM', 'TR'";
	}

	$locIdStr = implode(", ", $_SESSION[TRA37MERGEROUTELOCS]);
	if($locIdStr == "")
		$locIdStr = "0";

	// THE TWO QUERIES ARE THERE FOR OPTIMISATION
	$tempSrIdStr = "";
	$qryGetSrId = "SELECT sr.recid srId
					FROM specificroutes sr, route r
					WHERE sr.dispatchlocid = $ASLocationID
					AND sr.datesked = '$dbRunDate'
					AND r.recid = sr.routeid
					AND r.locationid = $ASLocationID
					AND r.type IN ($stdRtStr)";

	// FOR SPLITTING OF TABLES
	$qryGetSrId = convertToSplitTables($qryGetSrId, $val_SPLIT);

	if($debug) print("$qryGetSrId<br />");
	$rsltGetSrId = mysqli_query( $cvtconnection, $qryGetSrId);
	if(!$rsltGetSrId) {
		$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(1, 1);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($fileLineNbr);
	}
	else {
		if(mysqli_num_rows($rsltGetSrId) == 0) {
			$tempSrIdStr = "";
		}
		else {
			while($rowGetSrId = mysqli_fetch_assoc($rsltGetSrId)) {
				$srId = $rowGetSrId[srId];
				if(!is_numeric($srId)) $srId = 0;
				if($tempSrIdStr == "") {
					$tempSrIdStr = $srId;
				}
				else {
					$tempSrIdStr .= ", " . $srId;
				}
			}
		}
	}

	if($tempSrIdStr == "") {
		$tempSrIdStr = "0";
	}
	$qryGetInfo = "SELECT srl.locationid, COUNT(srl.specificrouteid) srCnt
					FROM specificrouteloc srl
					WHERE srl.specificrouteid IN (" . $tempSrIdStr . ")
					AND srl.clientlocid = $ASLocationID
					AND srl.locationid IN ($locIdStr)
					GROUP BY srl.locationid
					HAVING srCnt > 1";

	// FOR SPLITTING OF TABLES
	$qryGetInfo = convertToSplitTables($qryGetInfo, $val_SPLIT);

	if($debug)
		print($qryGetInfo . "<br />\n");
	$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
	if(!$rsltGetInfo) {
		$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($fileLineNbr);
	}
	else {
		if(mysqli_num_rows($rsltGetInfo) == 0) {

			remove_teakHistory($cvtconnection, $RecIdAS);
			$Back = getLast_teakHistory($cvtconnection, $RecIdAS);

			if($debug) {
				print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
			}
			else {
				header("Location: " . urldecode($Back));
			}
			exit();
		}
	}
}
if($doAction == "EmailRegion") {

	ValidateForInt(false, "pdid");

	//GET EFFDT
	$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
	if($rsltArr[rtvalue]) {
		$dbEffDt = $rsltArr[dbEffDt];
	}
	else {
		$dbEffDt = "";
	}
	unset($rsltArr, $fileLineNbr);

	if($debug)
		print("dbEffDt = $dbEffDt<br />");

	reset($rec);
	$srArray = array();
	while(list($cntId, $srId) = each($rec)) {
		if(!is_numeric($srId)) $srId = 0;
		if($srId != 0) array_push($srArray, $srId);
	}

	$specRouteIdStr = implode(", ", $srArray);
	if($specRouteIdStr == "") $specRouteIdStr = "0";

	if($debug)
		print("SpecRouteId :" . $specRouteIdStr . "<br />\n");

	$qryChkRecs = "SELECT COUNT(sr.routeid) rtCnt
					FROM vendinggroup vg, vendingsubgroup vsg, specificroutes sr
					WHERE sr.dispatchlocid = $ASLocationID
					AND sr.datesked = '$dbEffDt'
					AND vg.clientlocid = $ASLocationID
					AND vg.sortseqnbr < 10
					AND vg.recid = vsg.vendinggroupid
					AND vsg.routeid = sr.routeid
					AND sr.recid NOT IN (" . $specRouteIdStr . ")";
	// FOR SPLITTING OF TABLES
	$qryChkRecs = convertToSplitTables($qryChkRecs, $val_SPLIT);

	if($debug)
		print($qryChkRecs . "<br />\n");
	$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
	if(!$rsltChkRecs) {
		$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(9, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " .
		$strErrorCode ."</span><br /><br />\n");
		unset($fileLineNbr);
	}
	else {
		$rowChkRecs = mysqli_fetch_assoc($rsltChkRecs);
		$rtCnt = $rowChkRecs[rtCnt];
	}

	if($rtCnt > 0) {
		$PrevAction = $doAction;
		$doAction = "WarnEmRegion";
	}
}
if($doAction == "AddExtraDrawSplit") {
	ValidateForInt(false, "lstEditionId", "srId", "spId");

	$qryChkRecs = "SELECT COUNT(*) recCnt
					FROM rdaextradrawsplit
					WHERE clientlocid = $ASLocationID
					AND editionid = $lstEditionId
					AND specificproductid = $spId
					AND specificrouteid = $srId";

	if($debug) print($qryChkRecs . "<br />\n");
	$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
	if(!$rsltChkRecs) {
		$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " .
		$strErrorCode ."</span><br /><br />\n");
		unset($fileLineNbr);
	}
	else {
		$rowChkRecs = mysqli_fetch_assoc($rsltChkRecs);
		$recCnt = $rowChkRecs[recCnt];
	}

	if($recCnt > 0) {
		$flagError = true;
		$dispEditionStr = GetDescription("edition", $lstEditionId, "sdesc");
		if($lstEditionId != 9) {
			$errorMsg = "Edition \"" . htmlentities($dispEditionStr) . "\" already exist";
		}
		else {
			$errorMsg = "\"" . htmlentities($dispEditionStr) . "\" already exist";
		}

		$PrevAction = $doAction;
		$doAction = "ToAddExtraDrawSplit";
	}
}
?>
<?
##################
#	TOP HEADER:
##################
//// SETTING TOP HEADER HTML
include('../cm/html-top1.php');
?>
<?
##################
#	STYLE:
##################
?>
<style type="text/css">
.redButton {
	background-color:#FF6633;
}

.padClass {
	padding-left: 2px;
	padding-right: 2px;
}

.menuskin{
	position:absolute;
	width:135px;
	background-color:#A8BCD4;
	border:2px solid black;
	font-style: normal;
	font-family: Arial;
	line-height:18px;
	z-index:100;
	visibility:hidden;
}

.menuskin a{
	text-decoration:none;
	color:black;
	padding-left:10px;
	padding-right:10px;
}

#mouseoverstyle{
	background-color:#008080;
}

#mouseoverstyle a{
	color:white;
}

.pagebreakdata
{
page-break-before: always;
}

</style>
<?
##################
#	SCRIPT FILES:
##################
// SCRIPT FILE INCLUDED OVER HERE
if(!isset($doAction) || $doAction == "") {
	print("<script language=\"javascript\" type=\"text/javascript\" src=\"../cm/calendar.js\"></script>\n");
	print("<script language=\"javascript\" type=\"text/javascript\" src=\"../cm/date.js\"></script>\n");
}

if($doAction == "ToQtyRecd") {
	print("<script language=\"javascript\" type=\"text/javascript\" src=\"../cm/trim.js\"></script>\n");
	print("<script language=\"javascript\" type=\"text/javascript\" src=\"../cm/date.js\"></script>\n");
	print("<script language=\"javascript\" type=\"text/javascript\" src=\"../cm/time.js\"></script>\n");
}
?>
<?
##################
#	T JAVASCRIPT:
##################
?>
<script language="JavaScript" type="text/javascript" src="rdfunc_ajax.js"></script>
<script language="javascript" type="text/javascript" src="../ff/common_popup.js"></script>
<script language="javascript" type="text/javascript">
<?if($doAction == "ToMergeRoutes") {?>

// FUNCTION TO SELECT OR DESELECT ALL CHECKBOXS
function checkBoxAll(objForm, flagCheckAll, groupName) {
	var tempChkObj;
	for(var i = 0; i < objForm.noRecords.value; i++) {
		tempChkObj = document.getElementsByName("" + groupName + "[" + i + "]");

		if(flagCheckAll) {
			tempChkObj[0].checked = true;
		}
		else {
			tempChkObj[0].checked = false;
		}
	}
	return;
}

// FUNCTION WHEN THE INDIVIDUAL CHECKBOX IS checked=\"checked\"
function checkBoxSingle(objForm, flagChecked) {
	/*if(!flagChecked)
		if(objForm.chkAll.checked)
			objForm.chkAll.checked = false;*/
}

// FUNCTION TO CHECK SINGLE CHECKBOX - FROM SOME FUNCTION
function checkOne(groupName, i) {
	var tempobj = document.getElementsByName("" + groupName + "[" + i + "]");
	if(!tempobj[0].checked)
		tempobj[0].checked = true;
}

function submitMergeRoutes(objForm, act, groupName) {

	// CODE FOR SELECTION OF AT LEAST ONE CHECKBOX WHEN PAGE IS SUBMITTED.
	var flagChecked = false;
	for(var i = 0; i < objForm.noRecords.value; i++) {
		tempStr = groupName + "[" + i + "]";
		tempobj = document.getElementsByName(tempStr);
		if(tempobj[0].checked) {
			flagChecked = true;
			break;
		}
	}

	if(!flagChecked) {
		alert("Please Select Atleast One");
		return;
	}

	objForm.doAction.value = act;
	objForm.submit();
}
<?}?>
<?if($doAction == "ToCheckRuns" || ( ( $doAction == "ToQtyRecd" || $doAction == "PrintRecdReport" ) && $Act == "Total") ) {?>
function msgMergeRoute(strLink) {

	alert("Warning: this function causes locations to be visited by a single route.  If you have locations that should be visited by more than one route on this run date, make sure those routes are not checked.");

	location.href = strLink;
}

function submitBundleRounding(flagCheck, urlStr) {
	if(flagCheck == 1) {
		alert("Sorry, the current set is already in use for this day and cannot be changed.");
		return;
	}
	else {
		location.href = urlStr;
	}
}

// Displaying Menu
function actionpopup(event, PassedPageNbr, spId, pubGrpMethod, flagDistRgn, effDt, qtySked) {

	var which;
	which=""

	which += "<div class='menuitems' align='center'><a href=\"javascript:openpopup1('tra37.php?PageNbr=" + PassedPageNbr + "&spId=" + spId + "&effDt=" + effDt + "&doAction=ShowCostCode');\">Price Code<\/A><\/DIV>"

	if(pubGrpMethod != "N") {
		which += "<div class='menuitems' align='center'><a href=\"javascript:openpopup1('tra37.php?PageNbr=" + PassedPageNbr + "&spId=" + spId + "&effDt=" + effDt + "&doAction=PubRegion');\">Publisher Region<\/A><\/DIV>"
	}

	if(flagDistRgn) {
		which += "<div class='menuitems' align='center'><a href=\"javascript:openpopup1('tra37.php?PageNbr=" + PassedPageNbr + "&spId=" + spId + "&effDt=" + effDt + "&doAction=DistRegion');\">Distributor Region<\/A><\/DIV>"
	}

	which += "<div class='menuitems' align='center'><a href=\"javascript:openpopup1('tra37.php?PageNbr=" + PassedPageNbr + "&spId=" +  spId + "&effDt=" + effDt + "&doAction=Group');\">Driver Group<\/A><\/DIV>"

	which += "<div class='menuitems' align='center'><a href=\"javascript:openpopup1('tra37.php?PageNbr=" + PassedPageNbr + "&spId=" +  spId + "&effDt=" + effDt + "&totCalculatedDraw=" + qtySked + "&doAction=RouteGroup');\">Route Group<\/A><\/DIV>"

	which += "<div class='menuitems' align='center'><a href=\"javascript:openpopup1('tra37.php?PageNbr=" + PassedPageNbr + "&spId=" + spId + "&effDt=" + effDt + "&doAction=Route');\">Normal Route<\/A><\/DIV>"

	which += "<div class='menuitems' align='center'><a href=\"javascript:openpopup1('tra37.php?PageNbr=" + PassedPageNbr + "&spId=" + spId + "&effDt=" + effDt + "&doAction=ActualRoute');\">Actual Route<\/A><\/DIV>"

	which += "<div class='menuitems' align='center'><a href=\"javascript:openpopup1('tra37.php?PageNbr=" + PassedPageNbr + "&spId=" + spId + "&effDt=" + effDt + "&doAction=Manual');\">Manual<\/A><\/DIV>"
	
	var val_DEMPO = "<?=$val_DEMPO?>";
	
	if(val_DEMPO != "" && val_DEMPO != 0 ) {
	which += "<div class='menuitems' align='center'><a href=\"javascript:openpopup1('tra37.php?PageNbr=" + PassedPageNbr + "&spId=" + spId + "&effDt=" + effDt + "&doAction=Demographic');\">Demographic<\/A><\/DIV>"
	}

	showmenu(event, which);
}
<?}?>
<? if($doAction == "Route" || $doAction == "ActualRoute") { ?>
	// FUNCTION TO CHECK SINGLE CHECKBOX - FROM SOME FUNCTION
	function checkOne(groupName, cnt) {
		var tempChkObj = document.getElementsByName("" + groupName + "[" + cnt + "]");
		if(!tempChkObj[0].checked)
			tempChkObj[0].checked = true;
	}

	function submitLevel1FormRoute(objForm, act, groupName) {
		var flagChecked = false;
		for(var i = 0; i < objForm.noRecords.value; i++) {
			tempStr = groupName + "[" + i + "]";
			tempObj = document.getElementsByName(tempStr);
			if(tempObj[0].checked) {
				flagChecked = true;
				break;
			}
		}

		if(!flagChecked) {
			alert("Please Select Atleast One row");
			return;
		}
		for(var i = 0; i < objForm.noRecords.value; i++) {
			tempStr = groupName + "[" + i + "]";
			tempObj = document.getElementsByName(tempStr);
			if(tempObj[0].checked) {
				routeIdObj = document.getElementsByName("routeIdArr[" + i + "]");
				if(routeIdObj[0].value == "") {
					alert("Select Route");
					return;
				}
			}

		}

		objForm.doAction.value = act;
		objForm.submit();
	}
<? } ?>
<? if($doAction == "Manual") { ?>

	function SubmitAdd(Act) {
		// FOR NAME
		if(document.level1Form.qtyReq.value == "") {
			alert("Enter Quantity Requested");
			return;
		}
		else if(isNaN(document.level1Form.qtyReq.value)) {
			alert("Enter Number as Quantity Requested");
			return;
		}

		document.level1Form.doAction.value = Act;
		document.level1Form.submit();
	}
<? } ?>
<? if($doAction == "CreateRunRecs" || $doAction == "EmBack") { ?>
	function openpopup(URL) {
	     var popupHandle1;

	     // OPEN A NEW WINDOW TO SHOW THE CONTACT INFORMATION
	     popupHandle1 = window.open(URL, '', 'resizable=yes,scrollbars=1,menubar=1');
	     popupHandle1.moveTo(0,0);
	     popupHandle1.resizeTo(screen.availWidth, screen.availHeight);
	}

	function CallBack(Back, passedPageNbr, pdId) {
		openpopup("tra37.php?PageNbr=" + passedPageNbr + "&doAction=EmBack&pdid=" + pdId + "");
		location.href = Back;
	}
<? } ?>
<? if(!isset($doAction) || $doAction == "") { ?>
	function SubmitViewMode() {
		if(!ValidateDateNew(document.viewmode.effdt.value, "Run Date", true, "MMDDYY")) return false;
		document.viewmode.submit();
	}

	function SubmitLevel0Form(Act) {
		if(Act == "Update") {
			document.Level0Form.doAction.value = Act;
			document.Level0Form.submit();
		}
		/*
		else if(Act == "ToAdjDraw")
			location.href = "../rd/tra29.php?PageNbr=" + document.Level0Form.PageNbr.value + "&effdt=" + document.Level0Form.effdt.value;
		*/
		else {
			location.href = "tra37.php?PageNbr=" + document.Level0Form.PageNbr.value + "&doAction=" + Act + "&pdid=" + document.Level0Form.pdid.value;
		}
	}

	function ChangeRefreshButton() {
		document.viewmode.Refresh.style.background = "#FF6633";
		document.viewmode.Refresh.style.color = "#FFFFFF";
	}
<? } ?>
<? if($doAction == "AddQtyRoute" ) { ?>
function SubmitQtyRecd(Act) {
	
	
	if(Act == "InsertQtyRoute") {
			
				ProdId = document.Level2Form.ProdId.value;
				ProdDate = document.Level2Form.ProdDate.value;
				RQty = document.Level2Form.RetQty.value;
			
				if(ProdId == '')
				{
					alert ("Please Select Product...");
				}
				else if(ProdDate == '')
				{
					alert ("Please Select Product Date...");
				}
				else if(RQty == '')
				{
					alert ("Please Enter valid QTY...");
				}
		}
		
		document.Level2Form.doAction.value = Act;
		document.Level2Form.submit();
}

<? } ?>
<? if($doAction == "ToQtyRecd" ) { ?>
	function SubmitQtyRecd(Act,postVal) { //Task#8891
		
		if (Act == "LagSlips") {
			// DO NOTHING HERE
		}
		else {

			// CODE FOR SELECTION OF AT LEAST ONE CHECKBOX WHEN PAGE IS SUBMITTED.
			var flagChecked = false;
			for(var i = 0; i < document.Level1Form.norecords.value; i++) {
				tempstr = "sp_array[" + i + "]";
				tempobj = document.getElementsByName(tempstr);
				if(tempobj[0]) {
					if(tempobj[0].checked) {
						flagChecked = true;
						break;
					}
				}
			}

			if(!flagChecked && Act == "QtyRoute") {
				for(var i = 0; i < document.Level1Form.noRecRet.value; i++) {
					tempstr = "spRetArr[" + i + "]";
					tempobj = document.getElementsByName(tempstr);
					if(tempobj[0].checked) {
						flagChecked = true;
						break;
					}
				}
			}

			if(!flagChecked) {
				alert("Please Select Atleast One");
				return;
			}
		}

		if(Act == "QtyRecd") {
			for(var i = 0; i < document.Level1Form.norecords.value; i++) {
				tempstr = "sp_array[" + i + "]";
				tempobj = document.getElementsByName(tempstr);
				if(tempobj[0].checked) {

					tempobj1 = document.getElementsByName("recTime[" + i + "]");
					recTimeStr = trim(tempobj1[0].value);
					if(recTimeStr != "") {
						dateTimeStr = recTimeStr.split(" ");

						if(dateTimeStr.length <= 1) {
							alert("Enter Receive Time");
							return;
						}

						if(dateTimeStr[1] == "HHMM") {
						}
						else {

							// VALIDATIONS FOR DATE
							if(!ValidateDateNew(dateTimeStr[0], "Receive Time", true, "MMDDYY")) {
								return;
							}

							// VALIDATIONS FOR TIME
							if(!ValidateTimeHHMMNew(dateTimeStr[1], "Receive Time")) {
								return;
							}
						}
					}
				}
			}
		}
			
		

		document.Level1Form.doAction.value = Act;
                //Task#9222 Starts
                if(postVal){
                    document.Level1Form.postVal.value = postVal; //Task#8891
                }
                //Task#9222 Ends
		document.Level1Form.submit();
	}

	function SubmitLevel1ViewMode(Act) {
		document.Level1viewmode.Act.value = Act;
		document.Level1viewmode.submit();
	}

	function submitLevel1FormUp(Act) {
		document.Level1Form.doAction.value = Act;
		document.Level1Form.submit();

	}
<? } ?>
<? if($doAction == "ToSelRouteSet") { ?>
	function SubmitSelRouteSet(Act, caption) {
		/*
		if(document.Level1Form.rsId.value == "") {
			alert("Select Route Set");
			return;
		}
		*/

		// CODE FOR SELECTION OF AT LEAST ONE CHECKBOX WHEN PAGE IS SUBMITTED.
		var flagChecked = false;
		var checkCnt = 0;
		var totalRecords = document.Level1Form.norecords.value;
		for(var i = 0; i < totalRecords; i++) {
			tempstr = "rsIdArr[" + i + "]";
			tempobj = document.getElementsByName(tempstr);
			if(tempobj[0].value != "") {
				checkCnt++;
			}

			/*
			if(tempobj[0].checked) {
				flagChecked = true;
				break;
			}
			*/
		}

		if(checkCnt != totalRecords) {
			alert(" Select Route Set ");
			return;
		}

		if(caption == "Create Runs for the Selected Date") {
			document.Level1Form.selRoute.value = "Processing - Please Wait";

			nextButton = document.getElementById("nextStep");
			if(nextButton)
				nextButton.style.display = "none";

			document.Level1Form.doAction.value = Act;
			document.Level1Form.submit();
		}
		else if(caption == "Processing - Please Wait") {
			alert("Processing Runs - Please Wait");
			return;
		}

		/*document.Level1Form.doAction.value = Act;
		document.Level1Form.submit();*/
	}

	// FUNCTION TO SELECT OR DESELECT ALL CHECKBOXS
	function CheckBoxAll(formname, flagCheckAll, groupName) {
		var tempobj;
		for(var i = 0; i < formname.norecords.value; i++) {
			tempobj = document.getElementsByName("" + groupName + "[" + i + "]");

			if(flagCheckAll) {
				tempobj[0].checked = true;
			}
			else {
				tempobj[0].checked = false;
			}
		}
		return;
	}

	//FUNCTION WHEN THE INDIVIDUAL CHECKBOX IS checked=\"checked\"
	function CheckBoxSingle(formname, flagChecked) {
		if(!flagChecked) if(formname.checkall.checked) formname.checkall.checked = false;
	}

	function delConfirmSpecificRoute(pageNbr, srId) {

		if( confirm(" Are you sure? ") ){
			location.href = "../rd/tra37.php?PageNbr=" + pageNbr + "&doAction=DelSpecificRoute&srid=" + srId + "";
		}
		else {
			return;
		}

	}
<? } ?>
<?if($doAction == "ToAddSpecificRoute") {?>
	function submitRoute(act) {

		if(document.level2Form.routeId.value == "") {
			alert("Select Route");
			return;
		}

		document.level2Form.doAction.value = act;
		document.level2Form.submit();
	}
<?}?>
<? if($doAction == "EditDriver") { ?>
	function SubmitEditDriver(Act) {
		document.level2Form.doAction.value = Act;
		document.level2Form.submit();
	}
<? } ?>
<? if($doAction == "ToDelLoc") { ?>
	function DelConfirm(pageNbr, specRtLocId, routeId, cflag) {
	
		if(cflag == 1)
		{
			alert("Sorry, selected route delivers to  other publications as well., Please fix this in next step Adjust Draw - Redeploy Multiples");
			return;
		}
		else
		{
			if(confirm("Are you sure?")){
			location.href = "../rd/tra06.php?PageNbr=" + pageNbr + "&specRtLocRecId=" + specRtLocId + "&doAction=Delete&routeRecId=" + routeId + "";
			}
			else {
				return;
			}
		}
		

	}
<? } ?>
<? if($doAction == "PrintForms") { ?>
	function SubmitPrintForms(disp) {
		// CODE FOR SELECTION OF AT LEAST ONE CHECKBOX WHEN PAGE IS SUBMITTED.
		var flagChecked = false;
		for(var i = 0; i < document.Level1Form.norecords.value; i++) {
			tempstr = "rec[" + i + "]";
			tempobj = document.getElementsByName(tempstr);
			if(tempobj[0].checked) {
				flagChecked = true;
				break;
			}
		}

		if(!flagChecked) {
			alert("Please Select atleast one record");
			return;
		}

		// now if here disp = SS(Separator Sheet - TRA31) then we need to define a
		// link itself
		if(disp == "SS") {
			// check that only one is selected
			check_cnt = 0;
			srid = 0;
			routeid = 0;
			for(var i = 0; i < document.Level1Form.norecords.value; i++) {
				tempstr = "rec[" + i + "]";
				tempobj = document.getElementsByName(tempstr);
				if(tempobj[0].checked) {
					check_cnt++;

					// here we will assign srid and routeid so that they can be
					// directly used in location.href
					srid = tempobj[0].value;

					tempobj2 = document.getElementsByName("subrec[" + i + "]");
					routeid = tempobj2[0].value
					if(check_cnt > 1) break;
				}
			}

			if(check_cnt > 1) {
				alert("Select only one Route");
				return;
			}
			else {
				// redirect to TRA31
				url_str = "../rd/tra31.php?PageNbr=" + document.Level1Form.PageNbr.value + "&routeId=" + routeid + "&srId=" + srid;
				location.href = url_str;
			}
		}
		else {
			//decide the file based on disp
			var filename;
			switch(disp) {
				case "DS":
					filename = "tra30.php";
					break;

				case "RS":
					document.Level1Form.ScreenSource.value = "RouteSheet";
					filename = "tra32.php";
					break;

				case "RC":
					document.Level1Form.ScreenSource.value = "RouteSheet";
					filename = "trc35.php";
					break;

				case "VS":
					filename = "tra70.php";
					break;
					
				case "TP":
					filename = "trd53.php";
					break;
				
				case "HS":
					document.Level1Form.ScreenSource.value = "RouteSheet";
					filename = "trc43.php";
					break;					

				case "SG":
				case "ER":
				case "EL":
					filename = "tra37.php";
					break;

				default:
					filename = "tra37.php";
					break;
			}

                        //3.2
			if(document.Level0Form.rdMode[0].checked) {
				document.Level0Form.mode.value = "Normal";
			}
			else {
				document.Level0Form.mode.value = "Compressed";
			} 
                        //3.2
			if(disp == "SG") {
				document.Level1Form.action = filename;
				document.Level1Form.doAction.value = "PrintRouteSummary";
				document.Level1Form.submit();
			}
			else if(disp == "ER") {
				document.Level1Form.action = filename;
				document.Level1Form.doAction.value = "EmailRegion";
				document.Level1Form.submit();
			}
			else if(disp == "EL") {
				document.Level1Form.action = filename;
				document.Level1Form.doAction.value = "PrintEditionLocation";
				document.Level1Form.submit();
			}
			else if(disp == "DS") {
				document.Level1Form.action = filename;
				document.Level1Form.doAction.value = "ShowDeliveryslip";
				document.Level1Form.submit();
			}else if(disp == "TP") {
				document.Level1Form.action = filename;
				document.Level1Form.doAction.value = "ShowDeliveryslip";
				document.Level1Form.submit();
			}
			else {
				document.Level1Form.action = filename;
				document.Level1Form.doAction.value = "";
				document.Level1Form.submit();
			}
		}
	}
        /* 3.2  */
        //FUNCTION TO RE-SET THE ENTERD ROUTE NUMBER USING RESET FILTER LINK AND SUBMIT FORM
        function submitLevel0FormSearch(objForm , Act) {
            
         if(Act == 'RS')
         {
             for(var i = 1; i <= objForm.txtcount.value; i++) {
                var tempName = "txtLookUpText[" + i + "]";
		 document.getElementsByName(tempName)[0].value = '';
               }
         }
            
        objForm.submit();
	}
        //FUNCTION TO FOCUS NEXT INPUT BOX ON KEYUP EVENT
        function inputFocus(event,id)
        {
            var x = event.which || event.keycode;
            
            if( x==9 ||(x>=13&& x<=40)|| x==46)
            {
               return false;
            }
            else
            {   
               if( x==8 && id > 1)
               {
               id = id - 2; 
               }
               var tempName = "txtLookUpText[" + id + "]";
               document.getElementsByName(tempName)[0].focus(); 
            }
        }
        /* 3.2  */
<? } ?>
<? if($doAction == "WarnEmRegion" || $doAction == "EmailRegion" ||  $doAction == "EmailRegionForce") { ?>
	function submitLevel3FormEmail(objForm) {
		objForm.doAction.value = "EmailRegionForce";
		objForm.submit();
	}

	function submitEmailRegion(objForm, disp) {
		switch(disp) {
			case "ER":
				objForm.action = "tra32.php";
				break;

			case "EC":
				objForm.action = "trc35.php";
				break;
		}
		objForm.doAction.value = "";
		objForm.submit();
	}
<? } ?>
// HERE COMES ALL CHECKBOX RELATED FUNCS
<? if($doAction == "ToQtyRecd" || $doAction == "PrintForms" || $doAction == "PrintReturns") { ?>
	// FUNCTION TO SELECT OR DESELECT ALL CHECKBOXS
	function CheckBoxAll(formname, flagCheckAll, groupName) {
		//Task#9222 Starts
		var rowCnt = '';
		if(groupName == 'spRetArr') {
                    rowCnt = formname.noRecRet.value;
		} else {
                    rowCnt = formname.norecords.value;
		}
		var tempobj;
		for(var i = 0; i < rowCnt; i++) {
			tempobj = document.getElementsByName("" + groupName + "[" + i + "]");

			if(flagCheckAll) {
				tempobj[0].checked = true;
			}
			else {
				tempobj[0].checked = false;
			}
		}
                //Task#9222 Ends
		return;
	}

	//FUNCTION WHEN THE INDIVIDUAL CHECKBOX IS checked=\"checked\"
	function CheckBoxSingle(formname, flagChecked) {
		if(!flagChecked) if(formname.checkall.checked) formname.checkall.checked = false;
	}

	// FUNCTION TO CHECK SINGLE CHECKBOX - FROM SOME FUNCTION
	function CheckOne(groupName, i) {
		var tempobj = document.getElementsByName("" + groupName + "[" + i + "]");
		if(!tempobj[0].checked) tempobj[0].checked = true;
	}
<? } ?>
<? if($doAction == "ToAddAddlDr") { ?>
	function SubmitLevel2Form(Act) {
		if(document.level2Form.driverid.value == "") {
			alert("Select Driver");
			return;
		}

		document.level2Form.doAction.value = Act;
		document.level2Form.submit();
	}
<? } ?>
<? if($doAction == "SelRoutes") { ?>

	function submitLevel2Form(objForm, strAct) {
		// CODE FOR SELECTION OF AT LEAST ONE CHECKBOX WHEN PAGE IS SUBMITTED.
		var flagChecked = false;
		for(var i = 0; i < objForm.noRecords.value; i++) {
			tempstr = "chkRouteIdArr[" + i + "]";
			tempobj = document.getElementsByName(tempstr);

			if(tempobj[0].checked) {
				flagChecked = true;
				break;
			}
		}

		if(!flagChecked) {
			alert("Please select atleast one.");
			return;
		}

		//window.opener.document.frmViewMode.Limit.value = '';
		objForm.doAction.value = strAct;
		objForm.submit();
	}

	// FUNCTION TO SELECT OR DESELECT ALL CHECKBOXS
	function CheckBoxAll(objForm, flagCheckAll, groupName) {
		var tempobj;
		for(var i = 0; i < objForm.noRecords.value; i++) {
			tempobj = document.getElementsByName("" + groupName + "[" + i + "]");
			if(flagCheckAll) {
				tempobj[0].checked = true;
			}
			else {
				tempobj[0].checked = false;
			}
		}
		return;
	}

	//FUNCTION WHEN THE INDIVIDUAL CHECKBOX IS checked=\"checked\"
	function CheckBoxSingle(objForm, flagChecked) {
		if(!flagChecked) {
			if(objForm.checkall) {
				if(objForm.checkall.checked)
					objForm.checkall.checked = false;
			}

			if(objForm.selrecs) {
				cnt = objForm.selrecs.value;
				cnt--;
				objForm.selrecs.value = cnt;
			}
		}
		else {
			if(objForm.selrecs) {
				cnt = objForm.selrecs.value;
				cnt++;
				objForm.selrecs.value = cnt;
			}
		}
	}

<? } ?>
<? if($doAction == "ShowDeliverySlips") { ?>
	// FUNCTION TO SELECT OR DESELECT ALL CHECKBOXS
	function CheckBoxAll(formname, flagCheckAll, groupName) {
		var tempobj;
		for(var i = 0; i < formname.norecords.value; i++) {
			tempobj = document.getElementsByName("" + groupName + "[" + i + "]");

			if(flagCheckAll) {
				tempobj[0].checked = true;
			}
			else {
				tempobj[0].checked = false;
			}
		}
		return;
	}

	//FUNCTION WHEN THE INDIVIDUAL CHECKBOX IS checked=\"checked\"
	function CheckBoxSingle(formname, flagChecked) {
		if(!flagChecked) if(formname.checkall.checked) formname.checkall.checked = false;
	}

	function SubmitLevel2Form(Act) {
		// CODE FOR SELECTION OF AT LEAST ONE CHECKBOX WHEN PAGE IS SUBMITTED.
		var flagChecked = false;
		for(var i = 0; i < document.level2Form.norecords.value; i++) {
			tempstr = "srlid_array[" + i + "]";
			tempobj = document.getElementsByName(tempstr);
			if(tempobj[0].checked) {
				flagChecked = true;
				break;
			}
		}

		if(!flagChecked) {
			alert("Please select atleast one");
			return;
		}

		document.level2Form.doAction.value = Act;
		document.level2Form.submit();
	}
<? } ?>
<? if($doAction == "DispExtraDrawSplit" || $doAction == "ToAddExtraDrawSplit" || $doAction == "DispReturnsAudit") { ?>
	function SubmitLevel1Form(objForm, act) {
		objForm.doAction.value = act;
		objForm.submit();
	}

	function SubmitLevel2Form(objForm, act) {
		if(act == "AddExtraDrawSplit") {
			/*if(objForm.lstEditionId.value == "") {
				alert("Please select Edition");
				return;
			}*/
		}

		if(act == "AddReturnsAudit") {
			var flagChecked = false;
			for(var i = 0; i < objForm.noRecords.value; i++) {
				tempstr = "auditRtRDAIdArr[" + i + "]";
				tempobj = document.getElementsByName(tempstr);
				if(tempobj[0].checked) {
					flagChecked = true;
					break;
				}
			}

			if(!flagChecked) {
				alert("Please select atleast one");
				return;
			}
		}

		objForm.doAction.value = act;
		objForm.submit();
	}

	function delConfirmExtraDrawSplit(pageNbr, edsId, srId, spId) {

		if( confirm(" Are you sure? ") ){
			location.href = "../rd/tra37.php?PageNbr=" + pageNbr + "&doAction=DeleteExtraDrawSplit&edsId=" + edsId + "&srId=" + srId + "&spId=" + spId;
		}
		else {
			return;
		}
	}

	// FUNCTION TO SELECT OR DESELECT ALL CHECKBOXS
	function CheckBoxAll(formName, flagCheckAll, groupName) {
		var tempObj;
		for(var i = 0; i < formName.noRecords.value; i++) {
			tempObj = document.getElementsByName("" + groupName + "[" + i + "]");

			if(flagCheckAll) {
				tempObj[0].checked = true;
			}
			else {
				tempObj[0].checked = false;
			}
		}
		return;
	}

	//FUNCTION WHEN THE INDIVIDUAL CHECKBOX IS checked=\"checked\"
	function CheckBoxSingle(formName, flagChecked) {
		if(!flagChecked) if(formName.checkall.checked) formName.checkall.checked = false;
	}

	// FUNCTION TO CHECK SINGLE CHECKBOX - FROM SOME FUNCTION
	function CheckOne(groupName, i) {
		var tempObj = document.getElementsByName("" + groupName + "[" + i + "]");
		if(!tempObj[0].checked) tempObj[0].checked = true;
	}
<? } ?>
<? if($doAction == "PrintEditionLocation") { ?>
	function submitLevelFormEmail(objForm, act) {
		objForm.doAction.value = act;
		objForm.submit();
	}

<? } ?>
<? if($doAction == "ToSelectRoutes") { ?>
	function checkBoxAll(formName, flagCheckAll, groupName) {
		var tempObj;
		for(var i = 0; i < formName.noRecords.value; i++) {
			tempObj = document.getElementsByName("" + groupName + "[" + i + "]");

			if(tempObj[0]) {
				if(flagCheckAll) {
					tempObj[0].checked = true;
				}
				else {
					tempObj[0].checked = false;
				}
			}
		}
		return;
	}

	//FUNCTION WHEN THE INDIVIDUAL CHECKBOX IS checked=\"checked\"
	function checkBoxSingle(formName, flagChecked) {
		if(!flagChecked) {
			if(formName.checkAll.checked)
			formName.checkAll.checked = false;
		}
	}

	function submitLevelForm(objForm, strAct) {

		// CODE FOR SELECTION OF AT LEAST ONE CHECKBOX WHEN PAGE IS SUBMITTED.
		var flagChecked = false;
		for(var i = 0; i < objForm.noRecords.value; i++) {
			tempstr = "routeIdArr[" + i + "]";
			tempobj = document.getElementsByName(tempstr);
			if(tempobj[0].checked) {
				flagChecked = true;
				break;
			}
		}

		if(!flagChecked) {
			alert("Please select atleast one record");
			return;
		}

		objForm.doAction.value = strAct;
		objForm.submit();
	}

<? } ?>
 /* 3.2  */
<? if($doAction == "ToSelRouteGroup") { ?>
//FUNCTION TO CHECK ALL CHECKBOX
function CheckBoxAll(formname, flag_checkall, groupName) {
	var tempobj;
	for(var i = 0; i < formname.norecords.value; i++) {
		tempobj = document.getElementsByName("" + groupName + "[" + i + "]");
		if(flag_checkall) {
			tempobj[0].checked = true;
		}
		else {
			tempobj[0].checked = false;
		}
	}
	return;
}

//FUNCTION WHEN THE INDIVIDUAL CHECKBOX IS checked=\"checked\"
function CheckBoxSingle(formname, flag_checked) {
	if(!flag_checked) if(formname.checkall.checked) formname.checkall.checked = false;
}

//FUNCTION TO CHECK WEATHER ROUTE IS selected=\"selected\" OR NOT
function SubmitLevel2Form(Act) {
	// CODE FOR SELECTION OF AT LEAST ONE CHECKBOX WHEN PAGE IS SUBMITTED.
        var flagChecked = false;
	for(var i = 0; i < document.level2Form.norecords.value; i++) {
		switch(Act) {
			case "SelRouteGroup":
				tempStr = "routeGroupIdArray[" + i + "]";
				break;
		}
		tempObj = document.getElementsByName(tempStr);
		if(tempObj[0].checked) {
			flagChecked = true;
			break;
		}
	}
	if(!flagChecked) {
		alert("Please select atleast one row");
		return;
	}
	document.level2Form.doAction.value = Act;
	document.level2Form.submit();
}


<? } ?>
  /* 3.2  */

function openpopup1(URL) {
     var popupHandle1;

     // OPEN A NEW WINDOW TO SHOW THE CONTACT INFORMATION
     popupHandle1 = window.open(URL, '', 'resizable=yes,scrollbars=1,menubar=0');
     popupHandle1.moveTo(0,0);
     popupHandle1.resizeTo(screen.availWidth, screen.availHeight);
}

</script>
<?
##################
#	BACK LOGIC:
##################
//// SETTING BACK VALUES
$titlewidth = "30";

if(!isset($doAction) || $doAction == "" || $doAction == "ToQtyRecd" || $doAction == "ToSelRouteSet" || $doAction == "ToCheckDrivers" || $doAction == "EditDriver" || $doAction == "ToCheckRuns" || $doAction == "ToAddLoc" || $doAction == "ToDelLoc" || $doAction == "PrintForms" || $doAction == "ToAddAddlDr" || $doAction == "ToAddSpecificRoute" || $doAction == "ToMergeRoutes"  || $doAction == "DispExtraDrawSplit" || $doAction == "ToAddExtraDrawSplit" || $doAction == "DispReturnsAudit"  ) {

	// GET CURRENT PATH FILENAME
	$urlArr = parse_url($REQUEST_URI);
	$CURRFILE = basename($urlArr[path]);

	$Back = getLast_teakHistory($cvtconnection, $RecIdAS);

	//get last page from history
	$valHistory = GetPageQueryStringInfo($Back, $cvtconnection, $RecIdAS);
	$doActionHistory = $valHistory[doAction];
	if( ( $doActionHistory == $doAction ) && ( $valHistory[LASTFILE] == $CURRFILE ) ) {
		if(!isset($doAction) || $doAction == "" || $doAction == "ToQtyRecd" || $doAction == "PrintForms" || $doAction == "ToMergeRoutes") {
			$prevUrl = $REQUEST_URI;
		}
		else {
			$prevUrl = $Back;
		}

	    remove_teakHistory($cvtconnection, $RecIdAS);
	    $Back = getLast_teakHistory($cvtconnection, $RecIdAS);
		add_teakHistory($prevUrl, $cvtconnection, $RecIdAS);
	}
	else {
		add_teakHistory($REQUEST_URI, $cvtconnection, $RecIdAS);
	}
}

if($doAction == "PrintSheet" || $doAction == "LagSlips" || $doAction == "PrintRecdReport" || $doAction == "WarnSelRouteSet" || $doAction == "ToCloseDraw" || $doAction == "ToCloseDrawForce" || $doAction == "CreateRunRecs" || $doAction == "ActExistMsg" || $doAction == "PreBundleSlip" || $doAction == "MergeRoutes" || $doAction == "PrintRouteSummary" || $doAction == "EmailRegion" || $doAction == "EmailRegionForce" || $doAction == "WarnEmRegion" || $doAction == "PrintEditionLocation" || $doAction == "EmailEditionLocation" || $doAction == "ToSelectRoutes" || $doAction == "PrintRouteSheet" || $doAction == "DrawPrintSheet" || $doAction == "RouteNotifyGroupEmail" || $doAction == 'AuditQtyEmail') { //Task#8891
	$Back = getLast_teakHistory($cvtconnection, $RecIdAS);
}

/* 3.2 */
if($doAction == "EmBack" || $doAction == "SelRoutes" || $doAction == "ToSelRouteGroup"  ||  $doAction == "SelRouteGroup" || $doAction == "AutoFillRemaining" || $doAction == "ShowDeliverySlips" || $doAction == "DeliverySlipPost" || $doAction == "ShowDraw" || $doAction == "ShowCalculatedDraw" || $doAction == "ShowCostCode" || $doAction == "PubRegion" || $doAction == "DistRegion" || $doAction == "Group" || $doAction == "Route" || $doAction == "Manual" || $doAction == "Demographic" || $doAction == "DemoEmail" || $doAction == "ShowCostCodeEmail" || $doAction == "PubRegionEmail" || $doAction == "DistRegionEmail" || $doAction == "GroupEmail" || $doAction == "ManualEmail" || $doAction == "RouteEmail" || $doAction == "ActualRoute" || $doAction == "ActualRouteEmail" || $doAction == "RouteGroup" || $doAction == "RouteGroupEmail" || $doAction == "AddQtyRoute" || $doAction == "InsertQtyRoute" || $doAction == "ProcessERP") {
	$Back = "javascript:self.close();";
	if($doAction == "ShowCostCode" || $doAction == "PubRegion" || $doAction == "DistRegion" || $doAction == "SelRouteGroup" || $doAction == "Group" || $doAction == "Route" || $doAction == "Manual" || $doAction == "ShowCostCodeEmail" || $doAction == "PubRegionEmail" || $doAction == "DistRegionEmail" || $doAction == "GroupEmail" || $doAction == "ManualEmail"  || $doAction == "DemoEmail" || $doAction == "RouteEmail" || $doAction == "ActualRoute" || $doAction == "ActualRouteEmail" || $doAction == "RouteGroup" || $doAction == "RouteGroupEmail"|| $doAction == "InsertQtyRoute") {//Task#9222
		$Back .= "window.opener.location.reload();";
	}
}
/* 3.2 */
if($doAction == "UpdateDriver" || $doAction == "AddSpecificRoute" || $doAction == "AddExtraDrawSplit"  || $doAction == "UpdateExtraDrawSplit" || $doAction == "AddReturnsAudit" ) {
	remove_teakHistory($cvtconnection, $RecIdAS);
	$Back = getLast_teakHistory($cvtconnection, $RecIdAS);
}

if($doAction == "Update" || $doAction == "UpdateRegDispatch" || $doAction == "SelRouteSet" || $doAction == "DeleteAddlDr" || $doAction == "AddAddlDr" || $doAction == "QtyRecd" || $doAction == "SelRouteSetForce" || $doAction == "QtyRoute"  || $doAction == "DelSpecificRoute" || $doAction == "SetBundleRound" || $doAction == "DispRoute" || $doAction == "DeleteExtraDrawSplit"  ) {
	$Back = getLast_teakHistory($cvtconnection, $RecIdAS);
}

/*if($doAction == "ShowDraw") {
	$Back = "javascript:self.close()";
}*/
?>
<?
##################
#	SUB HEADER:
##################

// AUTO REFRESHING THE SCREEN WHEN CDRWP IS SET TO P OR ON DEMAND IS SET.
$val_CDRWP = GetLSVar("CDRWP", "charvar", $ASLocationID, $cvtconnection);
if($debug) print("CDRWP = $val_CDRWP<br />\n");

if(!isset($effdt) || $effdt == "") {
	$dbEffDt = Date("Y-m-d");
}
else {
	$dbEffDt = makedate($effdt, "MMDDYY");
}

// CHECKING FOR ON DEMAND IS SET OR NOT.
$qryGetOnDemCount = "SELECT COUNT(*) cnt
					FROM locationsystem
					WHERE recid = 'CDRWO'
					AND locationid = $ASLocationID
					AND datevar = '$curDate'
					AND (strvar IS NOT NULL && strvar != 0)
					AND charvar = 'Y'";
if($debug)
	print($qryGetOnDemCount . "<br />\n");
$rsltGetOnDemCount = mysqli_query( $cvtconnection, $qryGetOnDemCount);
if(!$rsltGetOnDemCount) {
	$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
	print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
	unset($fileLineNbr);
}
else {
	$rowGetOnDemCount = mysqli_fetch_assoc($rsltGetOnDemCount);
	$onDemandCnt = $rowGetOnDemCount[cnt];
}

if( ($val_CDRWP == "P" || $onDemandCnt != 0 ) && $doAction == "" ) {

	if($val_CDRWP == "P") {
		$effdt = get_date($date_CDRWP, "MMDDYY");
	}

	$effDtStr = "";
	if(isset($effdt) && $effdt != "")
		$effDtStr = "&effdt=$effdt";

	if (isset($holiday) && $holiday != "")
		$holidayStr = "&holiday=$holiday";

	print("<meta http-equiv=\"Refresh\" content=\"5; url='" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr" . $effDtStr . "" . $holidayStr . "", ENT_QUOTES) . "'\" />\n");
}
unset($rsltGetOnDemCount, $rowGetOnDemCount);

switch($doAction) {
		case "ToQtyRecd":
		case "ToSelRouteSet":
                case "ToCheckDrivers":
		case "EditDriver":
		case "ToCheckRuns":
		case "ToAddLoc":
		case "ToDelLoc":
		case "PrintForms":
		case "ToAddAddlDr":
		case "ToAddSpecificRoute":
		case "ToMergeRoutes":
		case "DispExtraDrawSplit":
		case "ToAddExtraDrawSplit":
		case "DispReturnsAudit":
		case "ToSelectRoutes":
			include('../cm/html-topentryscreen.php');
			break;

		case "PrintSheet":
		case "DrawPrintSheet": //Task#8891
		case "PrintRouteSheet":
		case "PrintRecdReport":
		case "EmBack":
		case "WarnSelRouteSet":
		case "ToCloseDraw":
		case "ToCloseDrawForce":
		case "ActExistMsg":
		case "SelRoutes":
		case "AutoFillRemaining":
		case "ShowDeliverySlips":
		case "DeliverySlipPost":
		case "ShowDraw":
		case "PreBundleSlip":
		case "ShowCalculatedDraw":
		case "ShowCostCode":
		case "PubRegion":
		case "DistRegion":
		case "Group":
		case "Route":
		case "Manual":
		case "Demographic":
		case "LagSlips":
		case "DispRoute":
		case "PrintRouteSummary":
		case "PrintEditionLocation":
		case "EmailRegion":
		case "WarnEmRegion":
		case "EmailRegionForce":
		case "ActualRoute":
		case "RouteGroup":
		case "AddQtyRoute":
		case "InsertQtyRoute":
      /* 3.2 */ case "ToSelRouteGroup": /* 3.2 */
                case "ProcessERP":
			include('../cm/html-secondwindow.php');
			break;

		case "QtyRecd":
		case "QtyRoute":
		case "SelRouteSet":
		case "SelRouteSetForce":
		case "UpdateDriver":
		case "Update":
		case "UpdateRegDispatch":
		case "AddAddlDr":
		case "DeleteAddlDr":
		case "AddSpecificRoute":
		case "DelSpecificRoute":
		case "MergeRoutes":
		case "SetBundleRound":
		case "ShowCostCodeEmail":
		case "PubRegionEmail":
		case "DistRegionEmail":
		case "GroupEmail":
		case "RouteEmail":
		case "ActualRouteEmail":
		case "ManualEmail":
		case "DemoEmail":
		case "PostRoute":
		case "AddExtraDrawSplit":
		case "DelExtraDrawSplit":
		case "UpdateExtraDrawSplit":
		case "AddReturnsAudit":
		case "RouteGroupEmail":
		case "RouteNotifyGroupEmail":
		case "AuditQtyEmail":
		case "EmailEditionLocation":
      /* 3.2 */ case "SelRouteGroup": /* 3.2 */    
			break;

		case "CreateRunRecs":
			// ABOVE ALL ARE CASE WHICH ARE CALLING BACK LINK
			// AND THEIR BACK VALUE SET IN THAT CASE ONLY
			break;

		default:
			if(!isset($OtherPageNbr) || $OtherPageNbr == "") {
				include('../cm/html-top3.php');
			}
			else {
				include('../cm/html-topentryscreen.php');
			}
			break;
}
?>
<?
##################
#	VARIABLES:
##################
// UNSETTING THE SEESION VARIABLE IF IT IS SET.
if (isset($_SESSION[TRA29REDEPMUL]))
	unset($_SESSION[TRA29REDEPMUL]);
?>
<?
##################
#	CODE CASES:
##################

// WE WILL WRITE FOLLOWING MESSAGE IN EACH CASE WHEN IT IS REQUIRED.
if($flagError) {
	print("<div class=\"datawhite\" align=\"center\" style=\"color:#ff0000\">");
	print("" . htmlentities($errorMsg, ENT_QUOTES) . "<br /><br />");
	print("</div>\n");
}

// FOR DISPLAYING doAction CASE TEXT.
if($debug)
	print("<b>" . ($doAction == "" ? "Main Display" : $doAction) . "</b> is called.<br />\n");

switch($doAction) {
	case "":
		print("<div class=\"datawhite\">\n");

		print("<form name=\"viewmode\" method=\"get\" action=\"tra37.php#here\" onsubmit=\"return SubmitViewMode()\">\n");
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");

		if(!isset($effdt)) {
			$val_STDAY = GetLSVar("STDAY", "strvar", $ASLocationID, $cvtconnection);
			if($val_STDAY == "") $val_STDAY = "0000";
			if($debug) print("STDAY = $val_STDAY<br />\n");

			$currtime = date("Hi");

			if($currtime >= $val_STDAY) {
				$effdt = date("mdy", mktime(0, 0, 0, date("m"), date("d") + 1, date("Y")));
			}
			else {
				$effdt = date("mdy");
			}

			$dbEffDt = makedate($effdt, "MMDDDYY");
		}

		if($val_CDRWP == "P") {
			$effdt = get_date($date_CDRWP, "MMDDYY");
		}

		print("<b>Run Date : </b>\n");
		print("<input type=\"text\" name=\"effdt\" value=\"$effdt\" size=\"6\" maxlength=\"6\"");
		print(" onkeydown=\"ChangeRefreshButton()");
		print("\" />\n");
		print("&nbsp;<a href=\"javascript:ChangeRefreshButton();show_calendar('viewmode.effdt','viewmode.effdt','" . ( date("n") - 1 ) . "','" . date("Y") . "','MMDDYY');\"><img src=\"../img/cal.gif\" width=\"24\" height=\"22\" border=\"0\" alt=\"\" style=\"vertical-align: bottom;\" /></a>\n");

		print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
		//print("<input type=\"submit\" name=\"Refresh\" value=\"Refresh\" onclick=\"SubmitViewMode()\" />");
		print("<input type=\"submit\" name=\"Refresh\" value=\"Refresh\" />\n");

		// CHECKING FOR PUBLICATIONS
		$qryGetInfo = "SELECT sp.recid
						FROM specificproduct sp, product p
						WHERE p.clientid = $ASCompanyID
						AND sp.productid = p.recid
						AND sp.datex = '$dbEffDt'
						AND ( sp.endeffdt IS NULL OR sp.endeffdt = '0000-00-00' OR sp.endeffdt > '$dbEffDt' )
						AND ( p.endeffdt IS NULL OR p.endeffdt = '0000-00-00' OR p.endeffdt > '$dbEffDt' )";
		if($debug)
			print("<br />" . $qryGetInfo . "<br />\n");
		$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
		if(!$rsltGetInfo) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetInfo) == 0 && $holiday != "N") {

				$flagPublications = false;
				$qryCheck = "SELECT COUNT(*) rowcnt
							FROM transactivity
							WHERE locationid = $ASLocationID
							AND datet = '$dbEffDt'
							AND customerlocid = 0
							AND specificproductid = 0
							AND type = 'SD'";

				// FOR SPLITTING OF TABLES
				$qryCheck = convertToSplitTables($qryCheck, $val_SPLIT);

				if($debug)
					print($qryCheck . "<br />\n");
				$rsltCheck = mysqli_query( $cvtconnection, $qryCheck);
				if(!$rsltCheck) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					$rowCheck = mysqli_fetch_assoc($rsltCheck);
					if($rowCheck[rowcnt] == 0) {

						print("<span id=\"holMsg\" style=\"display:inline\">\n");
						print("<br /><br />Is this date a holiday or a day when no runs are scheduled?\n");
						print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
						print("<a href=\"" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&effdt=$effdt&holiday=Y", ENT_QUOTES) . "\">Yes</a>\n");
						print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
						print("<a href=\"" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&effdt=$effdt&holiday=N", ENT_QUOTES) . "\">No</a>\n");
						print("</span>\n");
					}
					else {
						$flagPublications = true;
					}
				}
			}
			elseif(mysqli_num_rows($rsltGetInfo) > 0 && $holiday != "N")
			{	
				$flagPublications = false;
				//$spIdArray = array();
				while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo))
				{
					$spId = $rowGetInfo['recid'];
					//if(!is_numeric($spId)) $spId = 0;
					//array_push($spIdArray, $spId);
				
					//$spIdStr = implode(", ", $spIdArray);	
					//if($spIdStr == "") $spIdStr ="0";
					//$result = count('$spIdStr');
					//echo $result;
					$flagsp = false;
					$qryCheck1 = "SELECT qtyprojected
									FROM totaldrawaccounting 
									WHERE clientlocid = $ASLocationID
									AND actspecificproductid = '$spId' ";
								
					// FOR SPLITTING OF TABLES
					
					if($debug)
					print($qryCheck1 . "<br />\n");
					$rsltCheck1 = mysqli_query( $cvtconnection, $qryCheck1);
					if(!$rsltCheck1)
					{
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
						else
						{
							$rowCheck1 = mysqli_fetch_assoc($rsltCheck1);
							if($rowCheck1['qtyprojected'] > 0)
							{
								$flagsp = true;
								$flagPublications = true;
								break;
							}
						}
					}		
					if($flagsp == false)
					{
						$qryCheck = "SELECT COUNT(*) rowcnt
									FROM transactivity
									WHERE locationid = $ASLocationID
									AND datet = '$dbEffDt'
									AND customerlocid = 0
									AND specificproductid = 0
									AND type = 'SD'";

						// FOR SPLITTING OF TABLES
						$qryCheck = convertToSplitTables($qryCheck, $val_SPLIT);
		
						if($debug)
							print($qryCheck . "<br />\n");
						$rsltCheck = mysqli_query( $cvtconnection, $qryCheck);
						if(!$rsltCheck) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else
						{
							$rowCheck = mysqli_fetch_assoc($rsltCheck);
							if($rowCheck[rowcnt] == 0)
							{
								print("<span id=\"holMsg\" style=\"display:inline\">\n");
								print("<br /><br />Is this date a holiday or a day when no runs are scheduled?\n");
								print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
								print("<a href=\"" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&effdt=$effdt&holiday=Y", ENT_QUOTES) . "\">Yes</a>\n");
								print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
								print("<a href=\"" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&effdt=$effdt&holiday=N", ENT_QUOTES) . "\">No</a>\n");
								print("</span>\n");
							}
							
								else 	
								{
									$flagPublications = true;
								}
						
						}
					}
				}			
			else {
				$flagPublications = true;
			}
		}
		print("</form>");


		print("<br />\n");

		//NOW GET THE EFFDT AND APPROPRIATE PRODUCTDISPATCH RECORD
		$dbEffDt = makedate($effdt, "MMDDYY");

		if($holiday == "Y" && $flagPublications === false) {
		
			$qryChkRecs = "SELECT recid FROM productdispatch
							WHERE rundate = '$dbEffDt'
							AND clientlocid = $ASLocationID";
			if($debug)
			print($qryChkRecs . "<br />\n");
			$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
			if(!$rsltChkRecs) 
			{
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else
			{
				if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) 
				{
					$pdid = $rowChkRecs[recid];
					if(!is_numeric($pdid)) $pdid = 0;
				
					 $qryUp = "UPDATE productdispatch
								SET closedrawstartdt = now()
								WHERE recid = $pdid";
								if($debug)
									print("<b>" . $qryUp . "</b><br />\n");
								$rsltUp = mysqli_query( $cvtconnection, $qryUp);
								if(!$rsltUp) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}
								else {
									if($debug)
										print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
								}
				}
			}

			$qryCheck = "SELECT COUNT(*) rowcnt
						FROM transactivity
						WHERE locationid = $ASLocationID
						AND datet = '$dbEffDt'
						AND customerlocid = 0
						AND specificproductid = 0
						AND type = 'SD'";

			// FOR SPLITTING OF TABLES
			$qryCheck = convertToSplitTables($qryCheck, $val_SPLIT);
			if($debug)
				print($qryCheck . "<br />\n");
			$rsltCheck = mysqli_query( $cvtconnection, $qryCheck);
			if(!$rsltCheck) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				$rowCheck = mysqli_fetch_assoc($rsltCheck);
				if($rowCheck[rowcnt] == 0) {

					$qryIns = "INSERT INTO transactivity(locationid, datet, type,
								customerlocid, specificproductid, closeddatecust, closeddatevend,
								closeddatevendinv, closeddatecustpay, activesession)
								VALUES($ASLocationID, '$dbEffDt', 'SD',
								0, 0, '$val_INDEF', '$val_INDEF',
								'$val_INDEF', '$val_INDEF', $RecIdAS)";

					// FOR SPLITTING OF TABLES
					$qryIns = convertToSplitTables($qryIns, $val_SPLIT);

					if($debug)
						print("qryins : <b>" . $qryIns . "</b><br />\n");
					$rsltIns = mysqli_query( $cvtconnection, $qryIns);
					if(!$rsltIns) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if($debug)
							print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
					}
				}
			}
		}

		$qryChkRecs = "SELECT recid FROM productdispatch
						WHERE rundate = '$dbEffDt'
						AND clientlocid = $ASLocationID";
		if($debug)
			print($qryChkRecs . "<br />\n");
		$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
		if(!$rsltChkRecs) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
				$pdid = $rowChkRecs[recid];
				if(!is_numeric($pdid)) $pdid = 0;
			}
			else {
				//INSERT A RECORD AND GET THE ID
				$qryIns = "INSERT INTO productdispatch(clientlocid, rundate)
							VALUES($ASLocationID, '$dbEffDt')";
				if($debug)
					print("<b>" . $qryIns . "</b><br />\n");
				$rsltIns = mysqli_query( $cvtconnection, $qryIns);
				if(!$rsltIns) {


					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if($debug)
						print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");

					$pdid = getLastInsertId();
				}
			}
		}
		if(!is_numeric($pdid)) $pdid = 0;

		// HERE WE WILL CREATE ONE ENTRY PRODUCT REGIO DISPATCH IF THERE DOESNOT EXIST ONE.
		if($pdid != 0 && $val_REDIS == "Y" && ( ($val_REGIN == "S" && $val_VSGRT == "Y") || $val_REGIN == "G")) {
			// FIND ALL THE REGIONS.
			$qryGetRegion = "SELECT recid regionId
							FROM vendinggroup
							WHERE clientlocid = $ASLocationID
							ORDER BY sortseqnbr";
			if($debug)
				print($qryGetRegion . "<br />\n");
			$rsltGetRegion = mysqli_query( $cvtconnection, $qryGetRegion);
			if(!$rsltGetRegion) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				while($rowGetRegion = mysqli_fetch_assoc($rsltGetRegion)) {
					$regionId = $rowGetRegion[regionId];

					// NOW CHECK FOR THE EXISTANCE OF PRODUCTREGIONDISPATCH RECORD IF NOT EXIST CREATE ONE.
					$qryChkRecs = "SELECT recid FROM productregiondispatch
									WHERE rundate = '$dbEffDt'
									AND clientlocid = $ASLocationID
									AND vendinggroupid = $regionId";
					if($debug)
						print($qryChkRecs . "<br />\n");
					$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
					if(!$rsltChkRecs) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
							$prodRegDispId = $rowChkRecs[recid];
							if(!is_numeric($prodRegDispId)) $prodRegDispId = 0;
						}
						else {
							//INSERT A RECORD AND GET THE ID
							$qryIns = "INSERT INTO productregiondispatch(clientlocid, vendinggroupid, rundate)
										VALUES($ASLocationID, $regionId, '$dbEffDt')";
							if($debug)
								print("<b>" . $qryIns . "</b><br />\n");
							$rsltIns = mysqli_query( $cvtconnection, $qryIns);
							if(!$rsltIns) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if($debug)
									print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
								$prodRegDispId = getLastInsertId();
								if(!is_numeric($prodRegDispId)) $prodRegDispId = 0;
							}
						}
					}
				}
			}
		}

		// NOW CHECKING THE CLOSEDRAW PROCES RUNNING OR COMPLETED.
		$val_CDRWP = GetLSVar("CDRWP", "charvar", $ASLocationID, $cvtconnection);
		if($debug) print("CDRWP = $val_CDRWP<br />\n");

		if($val_CDRWP == "P") {
			$flag_running = true;

			/*for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
				if($pdFieldsArr[$tempi] == "closedraw") {
					$closedraw_index = $tempi;
					break;
				}
			}

			// prepare string
			$setStr = "";
			for($tempi = $closedraw_index + 1; $tempi < count($pdFieldsArr); $tempi++) {
				$setStr .= ", {$pdFieldsArr[$tempi]}as = 0, {$pdFieldsArr[$tempi]}dt = NULL";
			}

			$qryUp = "UPDATE productdispatch
						SET closedrawdt = NULL,
						closedrawas = 0
						" . $setStr . "
						WHERE recid = $pdid";
			if($debug) print("$qryUp<br />");
			$rsltUp = mysql_query($qryUp, $cvtconnection);
			if(!$rsltUp) print("<b>Can't update productdispatch</b><br />");*/

		}
		else {
			$flag_running = false;

			// CHECK ONDEMAND IS SET OR NOT
			$qryGetOnDemCount = "SELECT COUNT(*) cnt
								FROM locationsystem
								WHERE recid = 'CDRWO'
								AND locationid = $ASLocationID
								AND datevar = '$curDate'
								AND strvar = '$dbEffDt'
								AND charvar = 'Y'";
			if($debug)
				print($qryGetOnDemCount . "<br />\n");
			$rsltGetOnDemCount = mysqli_query( $cvtconnection, $qryGetOnDemCount);
			if(!$rsltGetOnDemCount) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				$rowGetOnDemCount = mysqli_fetch_assoc($rsltGetOnDemCount);
				$cnt = $rowGetOnDemCount[cnt];
				if($cnt != 0) {
					// DO NOTHING IN THIS CASE.
				}
				else {
					// NOW CHECKING FOR "SD" OR "SP" RECORDS EXISTS IN TRANSACTIVITY OR NOT
					$qryGetCount = "SELECT COUNT(*) cnt
									FROM transactivity
									WHERE locationid = $ASLocationID
									AND datet = '$dbEffDt'
									AND type IN ('SD', 'SP','DE')";

					// FOR SPLITTING OF TABLES
					$qryGetCount = convertToSplitTables($qryGetCount, $val_SPLIT);
					if($debug)
						print($qryGetCount . "<br />\n");
					$rsltGetCount = mysqli_query( $cvtconnection, $qryGetCount);
					if(!$rsltGetCount) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						$rowGetCount = mysqli_fetch_assoc($rsltGetCount);
						$transCnt = $rowGetCount[cnt];
						
						$prodRegDispclsDraw = 0;
						$qryChkRecs = "SELECT closedrawstartdt  FROM productdispatch
									WHERE rundate = '$dbEffDt'
									AND clientlocid = $ASLocationID
									";
						
					if($debug)
						print($qryChkRecs . "<br />\n");
					$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
					if(!$rsltChkRecs) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
						
							$prodRegDispclsDraw = $rowChkRecs[closedrawstartdt];
							
						}
					}
						if($transCnt != 0 && $prodRegDispclsDraw !=0) {

							$fileLineNbr = __LINE__; $proddisp = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "closedrawdt", "closedrawas");
							if($proddisp[rtvalue]) {
								$flagRecExist = true;
							}
							else {
								$flagRecExist = false;
							}
							unset($fileLineNbr);

							//if(!is_numeric($proddisp[closedrawas])) $proddisp[closedrawas] = 0;
							if($holiday == "Y" && $flagPublications === false) {
								// PREPARE STRING
								$strSet = "";

								for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
									if($strSet == "") {
										$strSet .= " {$pdFieldsArr[$tempi]}as = $RecIdAS, {$pdFieldsArr[$tempi]}dt = now()";
									}
									else {
										$strSet .= ", {$pdFieldsArr[$tempi]}as = $RecIdAS, {$pdFieldsArr[$tempi]}dt = now()";
									}
								}

								$qryUp = "UPDATE productdispatch
											SET " . $strSet . "
											WHERE recid = $pdid";
								if($debug)
									print("<b>" . $qryUp . "</b><br />\n");
								$rsltUp = mysqli_query( $cvtconnection, $qryUp);
								if(!$rsltUp) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}
								else {
									if($debug)
										print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
								}

								$flagPublications = true;
								?>
								<script language=javascript type="text/javascript">
									objSpan = document.getElementById("holMsg");
									objSpan.style.display = "none";
								</script>
								<?
							}
							else {

								if($proddisp[closedrawas] == "" || $proddisp[closedrawas] == 0) {

									for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
										if($pdFieldsArr[$tempi] == "closedraw") {
											$closedraw_index = $tempi;
											break;
										}
									}

									// PREPARE STRING
									$strSet = "";
									for($tempi = $closedraw_index + 1; $tempi < count($pdFieldsArr); $tempi++) {
										$strSet .= ", {$pdFieldsArr[$tempi]}as = 0, {$pdFieldsArr[$tempi]}dt = NULL";
									}

									$qryUp = "UPDATE productdispatch
												SET /*closedrawdt = now(),*/
												closedrawas = $RecIdAS
												" . $strSet . "
												WHERE recid = $pdid";
									if($debug)
										print("<b>" . $qryUp . "</b><br />\n");
									$rsltUp = mysqli_query( $cvtconnection, $qryUp);
									if(!$rsltUp) {
										$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
										print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
										unset($fileLineNbr);
									}
									else {
										if($debug)
											print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
									}
								}
							}
							unset($proddisp);
						} // END OF SETTING THE CLOSEDRAW FLAG IF NOT SET.
					}
				} // END OF ON DEMAND CHECK
			}
		} // END OF PROCESS RUNNING FLAG

		$fileLineNbr = __LINE__; $proddisp = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid);
		if($proddisp[rtvalue]) {
			$flagRecExist = true;
		}
		else {
			$flagRecExist = false;
		}
		unset($fileLineNbr);

		//DECIDE THE BUTTON STYLE AND COLOR STYLE
		$button_style = "width:0.95IN ; height:0.5IN";
		$red_style = "background-color:#FF6633 ; color:#FFFFFF";
		$green_style = "background-color:#339900 ; color:#FFFFFF";
		//$orange_style = "background-color:#FF9933 ; color:#FFFFFF";
		$orange_style = "background-color:#FFC184 ; color:#FFFFFF";

		print("<form name=\"Level0Form\" method=\"post\" action=\"tra37.php\" style=\"margin: 0;\">\n");

		if($flagPublications) {

			print("<table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" width=\"100%\">");
			print("<tr>\n");

			//DECIDE THE COMMON WIDTH OF ALL TDS
			$no_buttons = 8;
			$tdwidth = (100 / $no_buttons);
                        /* 3.3*/
                        if($disp_flag_1)
                        { /* 3.3*/
			/* CLOSE DRAW */
			// GET ITS INDEX
			for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
				if($pdFieldsArr[$tempi] == "closedraw") {
					$closedraw_index = $tempi;
					break;
				}
			}
			print("<td align=\"center\" style=\"width:" . $tdwidth . "%\">\n");
			print("<input type=\"button\" value=\"Close Draw\" onclick=\"");
			if($flagRecExist) print("SubmitLevel0Form('ToCloseDraw')");
			print("\" style=\"" . $button_style . "");
			if($flagRecExist) {

				if($flag_running) {
					print(" ; " . $orange_style . "");
				}
				else {
					//if(!is_numeric($proddisp[closedrawas])) $proddisp[closedrawas] = 0;
					if($proddisp[closedrawdt] == "") {
						print(" ; " . $red_style . "");
					}
					else {
						print(" ; " . $green_style . "");
					}
				}
			}
			print("\"");
			if($flag_running)
				print("  disabled=\"disabled\"");
			print(" />\n");
			print("<br /><br />\n");
			print("</td>\n");

			/* SELECT ROUTE SET */
			// GET ITS INDEX
			for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
				if($pdFieldsArr[$tempi] == "routeset") {
					$routeSetIndex = $tempi;
					break;
				}
			}
			print("<td align=\"center\" style=\"width:" . $tdwidth . "%\">\n");
			print("<input type=\"button\" value=\"Select\nRoute Set\" onclick=\"");
			if($flagRecExist) print("SubmitLevel0Form('ToSelRouteSet')");
			print("\" style=\"" . $button_style . "");
			if($flagRecExist) {
				//if(!is_numeric($proddisp[routesetas])) $proddisp[routesetas] = 0;
				if($proddisp[routesetdt] == "") {
					print(" ; " . $red_style . "");
				}
				else {
					print(" ; " . $green_style . "");
				}
			}
			print("\"");
                       
                        
			if($flagRecExist) {
				if($flag_running) {
					print("  disabled=\"disabled\"");
				}
				else {
					$comp_field = $pdFieldsArr[$routeSetIndex - 1] . "as";
					if(!is_numeric($proddisp[$comp_field])) $proddisp[$comp_field] = 0;
					if($proddisp[$comp_field] == 0) print("  disabled=\"disabled\"");
				}
			}
			print(" />\n");
			print("<br /><br />\n");
			print("</td>\n");
 
			/* CHECK RUNS */
			// GET ITS INDEX
			for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
				if($pdFieldsArr[$tempi] == "checkruns") {
					$checkruns_index = $tempi;
					break;
				}
			}
			print("<td align=\"center\" style=\"width:" . $tdwidth . "%\">");
			print("<input type=\"button\" value=\"Check Runs\" onclick=\"");
			if($flagRecExist) print("SubmitLevel0Form('ToCheckRuns')");
			print("\" style=\"" . $button_style . "");
			if($flagRecExist) {
				//if(!is_numeric($proddisp[checkrunsas])) $proddisp[checkrunsas] = 0;
				if($proddisp[checkrunsdt] == 0) {
					print(" ; " . $red_style . "");
				}
				else {
					print(" ; " . $green_style . "");
				}
			}
			print("\"");
			if($flagRecExist) {
				if($flag_running) {
					print("  disabled=\"disabled\"");
				}
				else {
					$comp_field = $pdFieldsArr[$checkruns_index - 1] . "as";
					if(!is_numeric($proddisp[$comp_field])) $proddisp[$comp_field] = 0;
					if($proddisp[$comp_field] == 0)
						print("  disabled=\"disabled\"");
				}
			}
			print(" />\n");
			print("<br /><br />\n");
			print("</td>\n");

			/* ADJUST DRAW */
			// GET ITS INDEX
			for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
				if($pdFieldsArr[$tempi] == "adjustdraw") {
					$adjustdraw_index = $tempi;
					break;
				}
			}
			print("<td align=\"center\" style=\"width:" . $tdwidth . "%\">\n");
			print("<input type=\"button\" value=\"Adjust Draw\" onclick=\"");
			if($flagRecExist) print("SubmitLevel0Form('ToAdjDraw')");
			print("\" style=\"" . $button_style . "");
			if($flagRecExist) {
				//if(!is_numeric($proddisp[adjustdrawas])) $proddisp[adjustdrawas] = 0;
				if($proddisp[adjustdrawdt] == 0) {
					print(" ; " . $red_style . "");
				}
				else {
					print(" ; " . $green_style . "");
				}
			}
			print("\"");
			if($flagRecExist) {
				if($flag_running) {
					print("  disabled=\"disabled\"");
				}
				else {
					$comp_field = $pdFieldsArr[$adjustdraw_index - 1] . "as";
					if(!is_numeric($proddisp[$comp_field])) $proddisp[$comp_field] = 0;
					if($proddisp[$comp_field] == 0) print("  disabled=\"disabled\"");
				}
			}
			print(" />\n");
			print("<br /><br />\n");
			print("</td>\n");
                /*3.3*/ } /*3.3*/
			/* QUANTITY RECEIVED */
			// GET ITS INDEX
			for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
				if($pdFieldsArr[$tempi] == "qtyrecd") {
					$qtyrecd_index = $tempi;
					break;
				}
			}
			print("<td align=\"center\" style=\"width:" . $tdwidth . "%\">\n");
			print("<input type=\"button\" value=\"Quantity\nReceived\" onclick=\"");
			if($flagRecExist) print("SubmitLevel0Form('ToQtyRecd')");
			print("\" style=\"" . $button_style . "");
			if($flagRecExist) {
				//if(!is_numeric($proddisp[qtyrecdas])) $proddisp[qtyrecdas] = 0;
				if($proddisp[qtyrecddt] == 0) {
					print(" ; " . $red_style . "");
				}
				else {
					print(" ; " . $green_style . "");
				}
			}
			print("\"");
			if($flagRecExist) {
				if($flag_running) {
					print("  disabled=\"disabled\"");
				}
				else {
					$comp_field = $pdFieldsArr[$qtyrecd_index - 1] . "as";
					if(!is_numeric($proddisp[$comp_field])) $proddisp[$comp_field] = 0;
					if($proddisp[$comp_field] == 0) print("  disabled=\"disabled\"");
				}
			}
			print(" />\n");
			print("<br /><br />\n");
			print("</td>");

			/* CHECK DRIVERS */
			// GET ITS INDEX
			for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
				if($pdFieldsArr[$tempi] == "checkdrivers") {
					$checkdrivers_index = $tempi;
					break;
				}
			}
			print("<td align=\"center\" style=\"width:" . $tdwidth . "%\">\n");
			print("<input type=\"button\" value=\"Check Drivers\" onclick=\"");
			if($flagRecExist /*&& $proddisp[routesetas] != "" && $proddisp[routesetas] != 0*/) {
					print("SubmitLevel0Form('ToCheckDrivers')");
			}
			print("\" style=\"" . $button_style . "");
			if($flagRecExist /*&& $proddisp[routesetas] != "" && $proddisp[routesetas] != 0*/) {
				//if(!is_numeric($proddisp[checkdriversas])) $proddisp[checkdriversas] = 0;
				if($proddisp[checkdriversdt] == 0) {
					print(" ; " . $red_style . "");
				}
				else {
					print(" ; " . $green_style . "");
				}
			}
			print("\"");
			if($flagRecExist) {
				if($flag_running) {
					print("  disabled=\"disabled\"");
				}
				else {
					$comp_field = $pdFieldsArr[$checkdrivers_index - 1] . "as";
					if(!is_numeric($proddisp[$comp_field])) $proddisp[$comp_field] = 0;
					if($proddisp[$comp_field] == 0)
						print("  disabled=\"disabled\"");
				}
			}
			print(" />\n");
			print("<br /><br />\n");
			print("</td>\n");

			/* CREATE RUN RECORDS */
			// GET ITS INDEX
			for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
				if($pdFieldsArr[$tempi] == "runrecords") {
					$runRecordsIndex = $tempi;
					break;
				}
			}
			print("<td align=\"center\" style=\"width:" . $tdwidth . "%\">\n");
			print("<input type=\"button\" value=\"Create\nRun Records\" onclick=\"");
			if($flagRecExist) print("SubmitLevel0Form('CreateRunRecs')");
			print("\" style=\"" . $button_style . "");
			if($flagRecExist) {
				//if(!is_numeric($proddisp[runrecordsas])) $proddisp[runrecordsas] = 0;
				if($proddisp[runrecordsdt] == 0) {
					print(" ; " . $red_style . "");
				}
				else {
					print(" ; " . $green_style . "");
				}
			}
			print("\"");
			if($flagRecExist) {
				if($flag_running) {
					print("  disabled=\"disabled\"");
				}
				else {
					$comp_field = $pdFieldsArr[$runRecordsIndex - 1] . "as";
					if(!is_numeric($proddisp[$comp_field])) $proddisp[$comp_field] = 0;
					if($proddisp[$comp_field] == 0)
						print("  disabled=\"disabled\"");
				}
			}
			print(" />\n");
			print("<br /><br />\n");
			print("</td>\n");

			/* PRINT DEL SLIPS */
			// GET ITS INDEX
			for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
				if($pdFieldsArr[$tempi] == "forms") {
					$forms_index = $tempi;
					break;
				}
			}
			print("<td align=\"center\" style=\"width:" . $tdwidth . "%\">\n");
			print("<input type=\"button\" value=\"Print\nForms\" onclick=\"");
			if($flagRecExist) print("SubmitLevel0Form('PrintForms')");
			print("\" style=\"" . $button_style . "");
			if($flagRecExist) {
				//if(!is_numeric($proddisp[formsas])) $proddisp[formsas] = 0;
				if($proddisp[formsdt] == 0) {
					print(" ; " . $red_style . "");
				}
				else {
					print(" ; " . $green_style . "");
				}
			}
			print("\"");
			if($flagRecExist) {
				if($flag_running) {
					print(" disabled=\"disabled\"");
				}
				else {
					$comp_field = $pdFieldsArr[$forms_index - 1] . "as";
					if(!is_numeric($proddisp[$comp_field])) $proddisp[$comp_field] = 0;
					if($proddisp[$comp_field] == 0)
						print(" disabled=\"disabled\"");
				}
			}
			print(" />\n");
			print("<br /><br />\n");
			print("</td>\n");

			print("</tr>\n");
			print("</table>\n");
			print("<br /><br />\n");
			$qryChkPerson =  "SELECT p.type
					 		FROM person p
							WHERE p.recid  = $PersonId";
			if($debug)
			print($qryChkPerson . "<br />\n");
			$rsltChkPerson = mysqli_query( $cvtconnection, $qryChkPerson);
			if(!$rsltChkPerson) 
			{
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
				else
				{
					if($rowChkPerson = mysqli_fetch_assoc($rsltChkPerson))
					{
						$type = $rowChkPerson['type'];	
					}
				}					
		
		
					
						$qryChkRecs = "SELECT pd.closedrawstartdt , pd.closedrawdt, pd.closedrawas
										FROM productdispatch pd
										WHERE pd.rundate = '$dbEffDt'
										AND pd.clientlocid = $ASLocationID ";
						
						if($debug)
						print($qryChkRecs . "<br />\n");
						$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
						if(!$rsltChkRecs)
						{
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
							else 
							{
								if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs))
								{
									$closedrawstartdt = $rowChkRecs['closedrawstartdt'];
									$closedrawdt = $rowChkRecs['closedrawdt'];
									$closedrawas = $rowChkRecs['closedrawas'];
									$newclosedrawdt = substr("$closedrawdt", -8);
							
							
								}
							}
				
									if(($closedrawas !=('' || '0')) && ($type != 'E'))
									{
								
										print("<font color='Red'>Close Draw: $closedrawstartdt - $newclosedrawdt.");
								
									}
										else
										{
											 print("<td>&nbsp;</td>\n");
										}
			print("<table border=\"0\" width=\"80%\" cellspacing=\"0\">\n");

			// FOR INSTRUCTIONS
			print("<tr class=\"datagrey\">\n");
			print("<td>");
			print("<b>Message To Dispatcher</b>");
			print("</td>\n");
			print("</tr>\n");

			print("<tr class=\"datawhite\">\n");
			print("<td>");
			print("<textarea name=\"instructions\" style=\"width:100%\" rows=\"4\" cols=\"100\">" . htmlentities($proddisp[instructions], ENT_QUOTES) . "</textarea>\n");
			print("<br /><br />\n");
			print("</td>\n");
			print("</tr>\n");

			// FOR DISPATCHER COMMENTS
			print("<tr class=\"datagrey\">\n");
			print("<td>");
			print("<b>Dispatcher Comments</b>");
			print("</td>\n");
			print("</tr>\n");

			print("<tr class=\"datawhite\">\n");
			print("<td>");
			print("<textarea name=\"dispatchcomment\" style=\"width:100%\" rows=\"4\" cols=\"100\">" . htmlentities($proddisp[dispatchcomment], ENT_QUOTES) . "</textarea>\n");
			print("<br /><br />\n");
			print("</td>\n");
			print("</tr>\n");

			// FOR MESSAGE TO DRIVERS
			print("<tr class=\"datagrey\">\n");
			print("<td>");
			print("<b>Message To Drivers</b>");
			print("</td>\n");
			print("</tr>\n");

			print("<tr class=\"datawhite\">\n");
			print("<td>");
			print("<textarea name=\"msgtodrivers\" style=\"width:100%\" rows=\"3\" cols=\"100\">" . htmlentities($proddisp[msgtodrivers], ENT_QUOTES) . "</textarea>\n");
			print("<br /><br />\n");
			print("</td>\n");
			print("</tr>\n");

			print("</table>\n");

			print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
			print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
			print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
			print("<input type=\"hidden\" name=\"effdt\" value=\"$effdt\" />\n");
			print("<input type=\"hidden\" name=\"holiday\" value=\"$holiday\" />\n");
			print("<a href=\"javascript:SubmitLevel0Form('Update')\">Post</a>\n");
		}

		print("</form>\n");
		print("</div>\n");
		break;

	case "ToQtyRecd":
	case "PrintRecdReport":
		
		//$debug = 1;
		// VALIDATION
		ValidateForInt(false, "pdid");
		print("<div class=\"datawhite\">\n");
		print("<div id=\"popmenu\" class=\"menuskin\" onMouseover=\"clearhidemenu();highlightmenu(event,'on')\" onMouseout=\"highlightmenu(event,'off');dynamichide(event)\">");
		print("</div>\n");

		// GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$effdt = "";
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		$dispEffDt = set_date($dbEffDt, "YYYY-MM-DD", "MM/DD/YY");
		print("<b><u>Run Date - $dispEffDt</u></b><br /><br />");

		// HERE WE WILL CHECK WHETHER PRODUCTDISPATCH.QTYRECDAS IS SET OR NOT
		// IF NOT SET THEN UPDATE APPROPRIATE SPECIFICPRODUCT.BUNDLECOUNT WITH
		// THE BUNDLE COUNT OF PREVIOUS WEEK
		Update_SPBundleCount($pdid);

		if($doAction == "PrintRecdReport") {
		}
		else {
			// HERE WE NEED TO GIVE TWO BUTTONS
			$button_style = "width:1.5IN ; height:0.5IN";
			$currbt = " ; background-color : #8CA9C8 ; color:#FFFFFF";

			print("<form name=\"Level1viewmode\" method=\"get\" action=\"tra37.php\">\n");
			print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
			print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
			print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
			print("<input type=\"hidden\" name=\"Act\" value=\"\" />\n");
			//print("<input type=\"hidden\" name=\"incLoc\" value=\"\" />");

			print("<input type=\"button\" value=\"Total Quantities\" onclick=\"SubmitLevel1ViewMode('Total')\" style=\"" . $button_style . "");
			if($Act == "Total") print("" . $currbt . "");
			print("\"");
			print(" />\n");
			print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");

			print("<input type=\"button\" value=\"Route Quantities\" onclick=\"SubmitLevel1ViewMode('Route')\" style=\"" . $button_style . "");
			if($Act == "Route") print("" . $currbt . "");
			print("\"");
			print(" />\n");

			if( ( ($val_REGIN == "S" && $val_VSGRT == "Y") || $val_REGIN == "G") && (isset($Act) && $Act != "") ) {
				if(!isset($incLoc) || $incLoc == "") {
					$incLoc = "all";
				}
				print("<br /><div class=\"datawhite\" align=\"left\">\n");
				print("<b>Include : </b>\n");
				print("&nbsp;&nbsp;&nbsp;&nbsp;");

				print("<label for=\"rdIncLocAll\">All</label>\n");
				print("<input id=\"rdIncLocAll\" type=\"radio\" name=\"incLoc\" value=\"all\" onclick=\"SubmitLevel1ViewMode('$Act');\"");
				if($incLoc == "all") print(" checked=\"checked\"");
				print(" />\n");
				print("&nbsp;&nbsp;&nbsp;&nbsp;");

				print("<label for=\"rdIncLocRegion\">Region</label>\n");
				print("<input id=\"rdIncLocRegion\" type=\"radio\" name=\"incLoc\" value=\"region\" onclick=\"SubmitLevel1ViewMode('$Act');\"");
				if($incLoc == "region") print(" checked=\"checked\"");
				print(" />\n");
				print("</div>\n");
			}
			else {
				$incLoc = "all";
			}

			if(isset($incLoc) && $incLoc == "region") {

				// NOW CHECKING FOR LOCATION.SUBGROUPID IS NOT SET
				$qryCheck = "SELECT COUNT(*) rowCnt
							FROM location l, routelink rl
							WHERE rl.clientid = $ASCompanyID
							AND l.recid = rl.locationid
							AND (l.subgroupid = 0 OR l.subgroupid IS NULL)
							AND ( l.endeffdate IS NULL OR l.endeffdate = '0000-00-00' OR l.endeffdate > '$curDate' )";
				if($debug)
					print($qryCheck . "<br />\n");
				$rsltCheck = mysqli_query( $cvtconnection, $qryCheck);
				if(!$rsltCheck) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					$rowCheck = mysqli_fetch_assoc($rsltCheck);
					if($rowCheck[rowCnt] != 0) {
						$msgStr = "Warning: some locations do not have a region defined";
						print("<br /><div class=\"datawhite\" align=\"center\" style=\"color:#ff0000\">");
						print("" .$msgStr . "");
						print("</div>\n");
						unset($msgStr);
					}
				}

				// HERE LETS PROVIDE REGION DROPLIST
				print("<br /><b>Region : </b>");
				$qryGetRegion = "SELECT recid, sdesc
									FROM vendinggroup
									WHERE clientlocid = $ASLocationID
									ORDER BY sortseqnbr";
				if($debug)
					print($qryGetRegion . "<br />\n");
				$rsltGetRegion = mysqli_query( $cvtconnection, $qryGetRegion);
				if(!$rsltGetRegion) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}


				print("<select name=\"region\" onchange=\"SubmitLevel1ViewMode('$Act');\">");
				print("\t<option value=\"\">Select Region</option>\n");
				if($rsltGetRegion) {
					while($rowGetRegion = mysqli_fetch_assoc($rsltGetRegion)) {
						print("\t<option value=\"" . $rowGetRegion[recid] . "\"");
						if($region == $rowGetRegion[recid])
							print(" selected=\"selected\"");
						print(">");
						if($debug)
							print("" . $rowGetRegion[recid] . " - ");
						print("" . htmlentities($rowGetRegion[sdesc], ENT_QUOTES) . "</option>\n");
					}
				}
				print("</select>\n");
			}
			print("</form>\n");
		}
		if(!is_numeric($region)) $region = 0;
		$tempLocIdStr = "";
		if($incLoc == "region" && $region != 0) {
			// NOW LETS GET THE LOCATIONS CORRESPONDING TO THE selected=\"selected\" REGION
			$qryGetLoc = "SELECT DISTINCT l.recid
							FROM location l, vendingsubgroup vsg, vendinggroup vg
							WHERE vg.clientlocid = $ASLocationID
							AND vg.recid = $region
							AND vsg.vendinggroupid = vg.recid
							AND l.subgroupid = vsg.recid
							AND ( l.endeffdate IS NULL OR l.endeffdate = '0000-00-00'
							OR l.endeffdate > '$curDate' )";
			if($debug)
				print($qryGetLoc . "<br />\n");
			$rsltGetLoc = mysqli_query( $cvtconnection, $qryGetLoc);
			if(!$rsltGetLoc) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if(mysqli_num_rows($rsltGetLoc) == 0) {
					$tempLocIdStr = "";
				}
				else {
					$tempLocIdStr = "";
					while($rowGetLoc = mysqli_fetch_assoc($rsltGetLoc)) {
						$locid = $rowGetLoc[recid];
						if(!is_numeric($locid)) $locid = 0;
						if($tempLocIdStr == "") {
							$tempLocIdStr = $locid;
						}
						else {
							$tempLocIdStr .= ", " . $locid;
						}
					}
				}
			}

			if($val_REDIS == "Y") {
				$qryChkRecs = "SELECT recid
								FROM productregiondispatch
								WHERE rundate = '$dbEffDt'
								AND clientlocid = $ASLocationID
								AND vendinggroupid = $region";
				if($debug)
					print($qryChkRecs . "<br />\n");
				$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
				if(!$rsltChkRecs) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
						$prodRegDispId = $rowChkRecs[recid];
						if(!is_numeric($prodRegDispId)) $prodRegDispId = 0;
					}
					else {
						//INSERT A RECORD AND GET THE ID
						$qryIns = "INSERT INTO productregiondispatch(clientlocid, vendinggroupid, rundate)
									VALUES($ASLocationID, $regionId, '$dbEffDt')";
						if($debug)
							print("<b>" . $qryIns . "</b><br />\n");
						$rsltIns = mysqli_query( $cvtconnection, $qryIns);
						if(!$rsltIns) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
							$prodRegDispId = getLastInsertId();
							if(!is_numeric($prodRegDispId)) $prodRegDispId = 0;
						}
					}
				}
			}
		}

		if($Act == "Total" /*&& ($incLoc == "all" || ($incLoc == "region" && $region != 0))*/) {
			$incWhereStr = "";
			if($incLoc == "region") {
				if($tempLocIdStr == "") {
					$tempLocIdStr = "0";
				}
				$incWhereStr = " AND ta.customerlocid IN ( " . $tempLocIdStr . " )";
			}

			$val_RDSRI = GetLSVar("RDSRI", "charvar", $ASLocationID, $cvtconnection);
			if($debug) print("RDSRI = $val_RDSRI<br />\n");

			$fromStr = "";
			$whereStr = "";
			$orderByStr = "";
			// FOR GETTING STRINGS FOR SORTING
			switch($val_RDSRI) {
				case "Q":
					$orderByStr = " tda.qtyprojected, p.ldesc";
					break;

				case "A":
					$fromStr = ", location l, locationlink ll, company c";

					$whereStr = " AND l.recid = p.vendorlocid
								AND ll.locationid = l.recid
								AND c.recid = ll.companyid";

					$orderByStr = " c.name, l.sdesc, p.ldesc";
					break;

				case "S":
					$orderByStr = " p.sortseqnbr";
					break;

				case "C":
					$orderByStr = " p.sdesc";
					break;

				case "B":
					$orderByStr = " p.adesc";
					break;

				default:
					$orderByStr = " p.ldesc";
					break;
			}

			// first get proper specificproductid list and prepare the string
			/*$qryGetSP = "SELECT DISTINCT(sp2.recid) spid
						FROM transactivity ta, specificproduct sp1, specificproduct sp2
						WHERE ta.locationid = $ASLocationID
						AND ta.datet = '$dbEffDt'
						AND ta.type = 'SD'
						AND sp1.recid = ta.specificproductid
						AND ( sp1.endeffdt IS NULL OR sp1.endeffdt = '0000-00-00' OR sp1.endeffdt > '$dbEffDt' )
						AND sp2.productid = sp1.productid
						AND sp2.datex = sp1.datex
						//AND sp2.datex = sp2.skeddeliv//
						ORDER BY sp2.recid";*/
			$qryGetSP = "SELECT DISTINCT(sp.recid) spid
						FROM transactivity ta, specificproduct sp,location l
						WHERE ta.locationid = $ASLocationID
						AND ta.datet = '$dbEffDt'
						" . $incWhereStr . "
						AND ta.customerlocid = l.recid
						AND IF(l.type = 'R', ta.type = 'DE' ,ta.type =  'SD' )
						AND sp.recid = ta.specificproductid
						AND ( sp.endeffdt IS NULL OR sp.endeffdt = '0000-00-00' OR sp.endeffdt > '$dbEffDt' )
						ORDER BY sp.recid";

			// FOR SPLITTING OF TABLES
			$qryGetSP = convertToSplitTables($qryGetSP, $val_SPLIT);

			if($debug)
				print($qryGetSP . "<br />\n");
			$rsltGetSP = mysqli_query( $cvtconnection, $qryGetSP);
			$spid_str = "";
			if(!$rsltGetSP) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				while($rowGetSP = mysqli_fetch_assoc($rsltGetSP)) {
					$temp_spid = $rowGetSP[spid];
					if(!is_numeric($temp_spid)) $temp_spid = 0;
					if($temp_spid != 0) {
						if($spid_str == "") {
							$spid_str = $temp_spid;
						}
						else {
							$spid_str .= ", $temp_spid";
						}
					}
				}
			}
			//print "spid_str:$spid_str";
			if($spid_str == "") $spid_str = "0";

			//QUERY TO GET INFORMATION
			$qryGetInfo = "SELECT DISTINCT(sp.recid) spId, p.ldesc prodDesc,
							p.recid prodId,
							DATE_FORMAT(sp.datex, '%Y-%m-%d') dbdatex,
							DATE_FORMAT(sp.datex, '%m/%d/%y') datex,
							tda.qtyprojected qtyproj, tda.qtyrequested qtyreqt,
							tda.qtyrecd qtyrecd, tda.qtysked qtysked, sp.bundlecount,
							IF(tda.receivetime = NULL OR tda.receivetime = 0 OR tda.receivetime = '', NULL, DATE_FORMAT(DATE_ADD(tda.receivetime,INTERVAL $val_TIMEO HOUR), '%m/%d/%y %H:%i')) receivetime,
							IF(tda.receivetime = NULL OR tda.receivetime = 0 OR tda.receivetime = '', NULL, DATE_FORMAT(DATE_ADD(tda.receivetime,INTERVAL $val_TIMEO HOUR), '%m%d%y %H%i')) rectime "; //Task#9151 
			if( ( $val_REGIN == "S" && $val_VSGRT == "Y") || $val_REGIN == "G") {
				$qryGetInfo .= " , rda.qtyrecd regQtyRecd,
							IF(rda.receivetime = NULL OR rda.receivetime = 0 OR rda.receivetime = '', NULL, DATE_FORMAT(DATE_ADD(rda.receivetime,INTERVAL $val_TIMEO HOUR), '%m/%d/%y %H:%i')) regReceivetime,
							IF(rda.receivetime = NULL OR rda.receivetime = 0 OR rda.receivetime = '', NULL, DATE_FORMAT(DATE_ADD(rda.receivetime,INTERVAL $val_TIMEO HOUR), '%m%d%y %H%i')) regRectime "; //Task#9151 
			}

			$qryGetInfo .= " FROM product p,
							totaldrawaccounting tda" . $fromStr . ", specificproduct sp";
			if( ( $val_REGIN == "S" && $val_VSGRT == "Y") || $val_REGIN == "G") {
				$qryGetInfo .= " LEFT JOIN regiondrawaccounting rda
							ON rda.specificproductid = sp.recid
							AND rda.vendinggroupid = $region
							AND rda.clientlocid = $ASLocationID ";
			}
			$qryGetInfo .= " WHERE tda.clientlocid = $ASLocationID
							AND tda.actspecificproductid = sp.recid
							AND tda.type = 'S'
							AND ( sp.endeffdt IS NULL OR sp.endeffdt = '0000-00-00'
							OR sp.endeffdt > '$curDate' )
							AND p.recid = sp.productid
							AND p.clientid = $ASCompanyID
							AND ( p.endeffdt IS NULL OR p.endeffdt = '0000-00-00'
							OR p.endeffdt > '$curDate' )
							AND sp.recid IN ($spid_str)" . $whereStr . "
							ORDER BY " . $orderByStr . ", prodDesc";
			if($debug)
				print($qryGetInfo . "<br />\n");
			
			if($doAction == "ToQtyRecd") {
				print("<form name=\"Level1Form\" method=\"post\" action=\"tra37.php\">\n");
			}

			print("<table border=\"1\" width=\"100%\">\n");
			print("<tr class=\"datatblhdr\">\n");
			if($debug) print("<td>spId</td>\n");
			if($debug) print("<td>prodId</td>\n");
			if($doAction == "ToQtyRecd") {
				print("<td align=\"center\"><input type=\"checkbox\" name=\"checkall\" value=\"checkall\" onclick=\"CheckBoxAll(this.form, this.checked, 'sp_array')\" /></td>\n");
			}
			print("<td>Publication</td>\n");
			print("<td align=\"center\">Date</td>\n");
			if($incLoc != "region") {
				print("<td align=\"right\">Requested</td>\n");
				print("<td align=\"right\">Projected</td>\n");
			}
			print("<td align=\"right\">Calculated Draw</td>\n");
			print("<td align=\"right\">Extra Copies</td>\n");
		/*	print("<td>Issued to Driver</td>");
			print("<td>Excess Undelivered</td>");*/

			if($doAction == "ToQtyRecd" && $val_REDIS == "Y" && $incLoc == "region") {
				print("<td align=\"center\">Recalc</td>\n");
			}

			if($incLoc != "region" || ( $val_REDIS == "Y" && $incLoc == "region")) {
				print("<td");
				if($doAction == "ToQtyRecd") {
					print(">");
				}
				else {
					print(" align=\"right\">");
				}
				print("Received</td>\n");
			}

			print("<td");
			if($doAction == "ToQtyRecd") {
				print(">");
			}
			else {
				print(" align=\"right\">");
			}
			print("Bundle Count</td>\n");
			if($doAction == "ToQtyRecd" && $incLoc == "all") {
				if($val_BURND == "Y") {
					print("<td align=\"center\">Bundle Rounding</td>\n");
				}
				if($val_PLORD == "Y") {
					print("<td align=\"center\">Place Order</td>\n");
				}
			}

			if($incLoc != "region" || ( $val_REDIS == "Y" && $incLoc == "region")) {
				print("<td");
				if($doAction == "ToQtyRecd") {
					print(">");
				}
				else {
					print(" align=\"center\">");
				}
				print("Received Time</td>");
			}
			print("</tr>\n");

			$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
			$oddEven = 0;
			$cntid = 0;
			if(!$rsltGetInfo) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
					if( ( $oddEven++ % 2 ) == 0 ) {
						print("<tr class=\"datawhite\">\n");
					}
					else {
						print("<tr class=\"datagrey\">\n");
					}

					// FOR SPID
					$spId = $rowGetInfo[spId];
					$dbdatex = $rowGetInfo[dbdatex];
					if(!is_numeric($spId)) $spId = 0;
					if($debug) print("<td>$spId</td>\n");

					// FOR PRODID
					$prodId = $rowGetInfo[prodId];
					if(!is_numeric($prodId)) $prodId = 0;
					if($debug) print("<td>$prodId</td>\n");

					// FOR CHECKBOX
					if($doAction == "ToQtyRecd") {
						print("<td align=\"center\"><input type=\"checkbox\" name=\"sp_array[" . $cntid . "]\" value=\"" . $spId . "\" onclick=\"CheckBoxSingle(this.form, this.checked)\" /></td>\n");
					}

					// FOR PUBLICATION
					$prodDesc = $rowGetInfo[prodDesc];
					print("<td>" . ($prodDesc != "" ? htmlentities($prodDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");

					// FOR DATE
					$datex = $rowGetInfo[datex];
					print("<td align=\"center\"");
					if($dbdatex != $dbEffDt) {
						print(" style=\"color:#ff0000\"");
					}
					print(">" . ($datex != "" ? htmlentities($datex, ENT_QUOTES) : "&nbsp;") . "</td>\n");

					if($incLoc != "region") {
						// FOR REQUESTED - GET DIFFERENT QUANTITIES
						$qtyreqt = $rowGetInfo[qtyreqt];
						print("<td align=\"right\">" . ($qtyreqt != "" ? $qtyreqt : "&nbsp;") . "</td>\n");

						// FOR REQUIRED
						$qtyproj = $rowGetInfo[qtyproj];
						print("<td align=\"right\">" . ($qtyproj != "" ? $qtyproj : "&nbsp;") . "</td>\n");
					}

					// FOR CALCULATED DRAW - GET IT FROM RELATED ROUTEDRAWACCOUNTING RECORDS
					$qtyArr = GetQtySked_TRA37($pdid, $spId, $incLoc, $region);
					$qtysked = $qtyArr[QTYSKED];
					$qtyissued = $qtyArr[QTYISSUED];

					$extraQty = $qtyissued - $qtysked;
					if(!is_numeric($extraQty)) $extraQty = 0;

					//$qtysked = $rowGetInfo[qtysked];
					if($doAction == "ToQtyRecd") {
						if($qtysked != "") {
							print("<td align=\"right\"><a href=\"javascript:openpopup1('". htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&doAction=ShowCalculatedDraw&pdid=$pdid&spId=$spId&incLoc=$incLoc" . (isset($region) ? "&regionId=$region" : "") . "", ENT_QUOTES) . "');\">" . ($qtysked != "" ? $qtysked : "&nbsp;") . "</a></td>\n");
						}
						else {
							print("<td align=\"right\">" . ($qtysked != "" ? $qtysked : "&nbsp;") . "</td>\n");
						}
					}
					else {
						print("<td align=\"right\">" . ($qtysked != "" ? $qtysked : "&nbsp;") . "</td>\n");
					}

					// FOR EXTRA PAPERS
					print("<td align=\"right\">" . ($extraQty != "" ? $extraQty : "&nbsp;") . "</td>\n");

				/*	// FOR Issued to Driver
					print("<td>");
					print("<input type=\"text\" name=\"qtyissued[" . $spId . "]\" value=\"$qtysked\" size=\"5\" maxlength=\"5\" onchange=\"CheckOne('sp_array', '" . $cntid . "')\" />");
					print("</td>");

					// FOR Excess Undelivered QtyUndelivered
					print("<td>");
					print("<input type=\"text\" name=\"qtyundelivered[" . $spId . "]\" value=\"0\" size=\"5\" maxlength=\"5\" onchange=\"CheckOne('sp_array', '" . $cntid . "')\" />");
					print("</td>");*/


					if($doAction == "ToQtyRecd" && $val_REDIS == "Y" && $incLoc == "region") {

						print("<td align=\"center\">\n");
						print("<a href=\"" . htmlspecialchars("../rd/trb97.php?PageNbr=$PassedPageNbr&doAction=EditGlobDraw&spId=$spId&effDt=$effdt&regionId=$region", ENT_QUOTES) . "\"><img src=\"../img/sel.gif\" border=\"0\" height=\"12\" width=\"12\" alt=\"\" /></a>\n");
						print("</td>\n");
					}

					// FOR RECEIVED
					$qtyrecd = $rowGetInfo[qtyrecd];
					$regQtyRecd = $rowGetInfo[regQtyRecd];
					if($incLoc != "region" || ( $val_REDIS == "Y" && $incLoc == "region")) {
						print("<td");
						if($doAction == "ToQtyRecd") {
							print(">");
							print("<input type=\"text\" name=\"qtyrecd[" . $spId . "]\" value=\"" . ( ($val_REDIS == "Y" && $incLoc == "region") ? $regQtyRecd : $qtyrecd ) . "\" size=\"6\" maxlength=\"6\" onchange=\"CheckOne('sp_array', '" . $cntid . "')\" />");
						}
						else {
							print(" align=\"right\">");
							if($val_REDIS == "Y" && $incLoc == "region") {
								print("" . ($regQtyRecd != "" ? $regQtyRecd : "&nbsp;") . "");
							}
							else {
								print("" . ($qtyrecd != "" ? $qtyrecd : "&nbsp;") . "");
							}
						}
						print("</td>\n");
					}

					// FOR BUNDLE COUNT
					$bCount = $rowGetInfo[bundlecount];
					print("<td");
					if($incLoc == "region") {
						print(" align=\"right\">");
						print("$bCount");
					}
					else {
						if($doAction == "ToQtyRecd") {
							print(">");
							print("<input type=\"text\" name=\"b_cnt[" . $spId . "]\" value=\"$bCount\" size=\"5\" maxlength=\"5\" onchange=\"CheckOne('sp_array', '" . $cntid . "')\" />");
						}
						else {
							print(" align=\"right\">");
							print("" . ($bCount != "" ? $bCount : "&nbsp;") . "");
						}
					}
					print("</td>\n");

					// BUNDLE ROUNDING
					if($doAction == "ToQtyRecd" && $incLoc == "all" ) {
						$flagDispRounding = false;

						// HERE LETS CHECK WHETHER DISPATH IS FINISHED OR NOT (RUN RECIRDS CREATED OR NOT)
						$flagRunCreated  = false;
						if(isCreateRunRecsDone_TRA37($pdid)) {
							$flagRunCreated = true;
						}

						if($val_BURND == "Y") {

							$routeTypeStr = "'SR', 'PR'";

							if($val_HAWKS == "Y") {
								$routeTypeStr .= ", 'AM', 'PM', 'TR'";
							}

							// LETS FIRST GET THE LOCATIONID AND ROUTEID USING ROUTEDRAWACCOUNTING
							$srRecIdArray = array();
							$srRouteIdArray = array();
							$qryGetRouteLoc = "SELECT DISTINCT sr.recid srRecId,
												sr.routeid routeId
												FROM routedrawaccounting rda, specificroutes sr, route r
												WHERE rda.clientlocid = $ASLocationID
												AND rda.actspecificproductid = $spId
												AND rda.type = 'SD'
												AND rda.specificrouteid = sr.recid
												AND sr.dispatchlocid = $ASLocationID
												AND sr.datesked = '$dbEffDt'
												AND r.recid = sr.routeid
												AND r.type IN ($routeTypeStr)";

							// FOR SPLITTING OF TABLES
							$qryGetRouteLoc = convertToSplitTables($qryGetRouteLoc, $val_SPLIT);

							if($debug)
								print($qryGetRouteLoc . "<br />\n");
							$rsltGetRouteLoc = mysqli_query( $cvtconnection, $qryGetRouteLoc);
							if(!$rsltGetRouteLoc) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if(mysqli_num_rows($rsltGetRouteLoc) == 0) {
								}
								else {
									while($rowGetRouteLoc = mysqli_fetch_assoc($rsltGetRouteLoc)) {
										$locId = $rowGetRouteLoc[locId];
										$srRecId = $rowGetRouteLoc[srRecId];
										$routeId = $rowGetRouteLoc[routeId];
										ValidateForInt(false, "routeId", "srRecId");

										if(is_array($srRouteIdArray) && !in_array($routeId, $srRouteIdArray)) {
											array_push($srRouteIdArray, $routeId);
										}
										if(is_array($srRecIdArray) && !in_array($srRecId, $srRecIdArray)) {
											array_push($srRecIdArray, $srRecId);
										}

									}
									$srRouteIdStr = implode(", ", $srRouteIdArray);
									$srRecIdStr = implode(", ", $srRecIdArray);
								}
							}

							if($srRouteIdStr == "") {
								$srRouteIdStr = "0";
							}

							if($srRecIdStr == "") {
								$srRecIdStr = "0";
							}

							while(list($key, $srRecId) = each($srRecIdArray)) {
								$qryGetSRLInfo = "SELECT DISTINCT locationid locId
													FROM specificrouteloc
													WHERE clientlocid = $ASLocationID
													AND specificrouteid = $srRecId";

								// FOR SPLITTING OF TABLES
								$qryGetSRLInfo = convertToSplitTables($qryGetSRLInfo, $val_SPLIT);

								if($GLOBALS[debug])
									print($qryGetSRLInfo . "<br />\n");
								$rsltGetSRLInfo = mysqli_query( $GLOBALS[cvtconnection], $qryGetSRLInfo);
								$srlLocIdStr = "";
								if(!$rsltGetSRLInfo) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}
								else {
									while($rowGetSRLInfo = mysqli_fetch_assoc($rsltGetSRLInfo)) {

										$locId = $rowGetSRLInfo[locId];
										if(!is_numeric($locId))	$locId = 0;

										if($srlLocIdStr == "") {
											$srlLocIdStr = $locId;
										}
										else {
											$srlLocIdStr .= ", " . $locId;
										}
									}
								}
								if($srlLocIdStr == "")
									$srlLocIdStr = "0";

								$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "specificroutes", $srRecId, "routeid");
								if($rsltArr[rtvalue]) {
									$routeId = $rsltArr[routeid];
									if(!is_numeric($routeId)) $routeId = 0;
								}
								else {
									$routeId = 0;
								}
								unset($rsltArr, $fileLineNbr);

								// HERE LETS DECIDE WHETHERE WE NEED TO DISPLAY THE BUNDLE ROUNDING COLUMN OR NOT
								$qryGetSDQty = "SELECT
												SUM(IF(ta.specificrouteid = $srRecId, ta.actquantity, IF((ta.specificrouteid IS NULL OR ta.specificrouteid = 0 OR ta.specificrouteid = '') , ta.actquantity, 0))) actQty
												FROM transactivity ta
												WHERE ta.locationid = $ASLocationID
												AND ta.specificproductid = $spId
												AND ta.datet = '$dbEffDt'
												AND ta.type = 'SD'
												AND ta.customerlocid IN (" . $srlLocIdStr . ")";

								// FOR SPLITTING OF TABLES
								$qryGetSDQty = convertToSplitTables($qryGetSDQty, $val_SPLIT);

								if($debug)
									print($qryGetSDQty . "<br />\n");
								$rsltGetSDQty = mysqli_query( $cvtconnection, $qryGetSDQty);
								if(!$rsltGetSDQty) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}
								else {
									$rowGetSDQty = mysqli_fetch_assoc($rsltGetSDQty);
									$routeId = $rowGetSDQty[routeId];
									$actQty = $rowGetSDQty[actQty];
									if(!is_numeric($actQty)) $actQty = 0;
									
									//Task#8550 Start
									if($bCount != 0 && $actQty != 0)
									{
										if( ($actQty % $bCount) != 0) {
											$flagDispRounding = true;
											break;
										}
									}
									// Task#8550 End
								}
							}
							$urlStr = "";
							if($flagDispRounding) {
								$urlStr = htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=SetBundleRound&spId=$spId&effdt=$effdt&bCount=$bCount", ENT_QUOTES);
								print("<td align=\"center\"><a href=\"javascript:submitBundleRounding('$flagRunCreated','$urlStr');\"><img src=\"../img/red.gif\" border=\"0\" height=\"12\" width=\"12\" alt=\"\" /></a></td>\n");
							}
							else {
								print("<td align=\"center\"><img src=\"../img/green.gif\" border=\"0\" height=\"12\" width=\"12\" alt=\"\" /></td>\n");
							}
						}

						if($val_PLORD == "Y") {
							$qryChkRecs = "SELECT COUNT(*) FROM vendinggroup
											WHERE clientlocid = $ASLocationID";
							if($debug) print($qryChkRecs . "<br />\n");
							$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
							$flagDistRgn = false;
							if(!$rsltChkRecs) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if($rowChkRecs = mysqli_fetch_row($rsltChkRecs)) {
									$noRecs = $rowChkRecs[0];
									if(!is_numeric($noRecs)) $noRecs = 0;
									if($noRecs > 1) $flagDistRgn = true;
								}
							}

							// GET PUBGRPMETHOD
							$qryGetPbGroupM = "SELECT DISTINCT pubgroupmethod pubGrpMethod
												FROM product p, specificproduct sp
												WHERE sp.recid = $spId
												AND p.recid = sp.productid";
							if($debug)
								print($qryGetPbGroupM . "<br />\n");
							$rsltGetPbGroupM = mysqli_query( $cvtconnection, $qryGetPbGroupM);
							if(!$rsltGetPbGroupM) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								$rowGetPbGroupM = mysqli_fetch_assoc($rsltGetPbGroupM);
								$pubGrpMethod = $rowGetPbGroupM[pubGrpMethod];
							}

							/*if($flagRunCreated) {
								print("<td align=\"center\"><a href=\"javascript:submitBundleRounding('$flagRunCreated', '');\"><img src=\"../img/green.gif\" border=\"0\" height=\"12\" width=\"12\" /></a></td>");
							}
							else {*/
								if(!is_numeric($qtyreqt)) $qtyreqt = 0;
								print("<td align=\"center\"><a href=\"javascript:openpopup1('" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&doAction=ShowCostCode&spId=$spId&effDt=$effdt", ENT_QUOTES) . "');\" onMouseover=\"actionpopup(event, '$PassedPageNbr', '$spId', '$pubGrpMethod', '$flagDistRgn', '$effdt', '$qtysked')\" onMouseout=\"delayhidemenu()\"><img src=\"../img/" . ( $qtyreqt == 0 ? "red.gif" : "green.gif") . "\" border=\"0\" height=\"12\" width=\"12\" alt=\"\" /></a></td>\n");
							//}
						}
					}

					// FOR Bundle Count
					if($val_REDIS == "Y") {
						if($doAction == "ToQtyRecd") {
							$receiveTime = $rowGetInfo[regRectime];
							//Task#9151 Start
							if($receiveTime == "")
							{
								$newtime = time() + ($val_TIMEO * 60 * 60);
								
								$receiveTime = Date('mdy',$newtime) . " HHMM";
								
							}	
							//Task#9151 End
						}
						else {
							$receiveTime = $rowGetInfo[regReceivetime];
							if($receiveTime == "")
								$receiveTime = "&nbsp;";
						}
					}
					else {
						if($doAction == "ToQtyRecd") {
							$receiveTime = $rowGetInfo[rectime];
							//Task#9151 Start
							if($receiveTime == "")
							{
								$newtime = time() + ($val_TIMEO * 60 * 60);
								$receiveTime = Date('mdy',$newtime) . " HHMM";
							}	
							//Task#9151 End
						}
						else {
							$receiveTime = $rowGetInfo[receivetime];
							if($receiveTime == "")
								$receiveTime = "&nbsp;";
						}
					}
					if($incLoc != "region" || ( $val_REDIS == "Y" && $incLoc == "region")) {
						
						
						print("<td");
						if($doAction == "ToQtyRecd") {
							print(">");
							print("<input type=\"text\" name=\"recTime[" . $cntid . "]\" value=\"$receiveTime\" size=\"12\" maxlength=\"11\" onchange=\"CheckOne('sp_array', '" . $cntid . "')\" />\n");
						}
						else {
							print(" align=\"center\">");
							print("$receiveTime");
						}
						print("</td>\n");
					}

					print("</tr>\n");
					$cntid++;
				}
			}
			print("</table>\n");
			print("<br />\n");

			if($doAction == "ToQtyRecd") {
				print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
				print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
				print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
				print("<input type=\"hidden\" name=\"norecords\" value=\"$cntid\" />\n");
				print("<input type=\"hidden\" name=\"Act\" value=\"$Act\" />\n");
				print("<input type=\"hidden\" name=\"incLoc\" value=\"$incLoc\" />\n");
				print("<input type=\"hidden\" name=\"region\" value=\"$region\" />\n");
				print("<input type=\"hidden\" name=\"prodRegDispId\" value=\"$prodRegDispId\" />\n");
				print("<input type=\"hidden\" name=\"postVal\" />\n"); //Task#8891
				

				if(mysqli_num_rows($rsltGetInfo) > 0) {
					if($incLoc != "region" || ( $val_REDIS == "Y" && $incLoc == "region")) {
						print("<a href=\"javascript:SubmitQtyRecd('QtyRecd')\">Post</a>\n");
						print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
						print("<a href=\"" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&doAction=PrintRecdReport&Act=$Act&pdid=$pdid&incLoc=$incLoc&region=$region", ENT_QUOTES) . "\">Received Report</a>\n");
						print("<br /><br />\n");
					}
					print("<a href=\"javascript:SubmitQtyRecd('PrintSheet');\">Count Sheets by Publication</a>\n");
					print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
					
					print("<a href=\"javascript:SubmitQtyRecd('ToSelectRoutes','DrawPrintSheet');\">Draw Count Single Sheet</a>\n"); //Task#8891
					print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"); //Task#8891
					
				}

				print("<a href=\"javascript:SubmitQtyRecd('LagSlips');\">Lag Slips by Publication</a>\n");

				if(mysqli_num_rows($rsltGetInfo) > 0) {

					if(isset($_SESSION[TRA37ROUTEIDSTR])) {
						unset($_SESSION[TRA37ROUTEIDSTR]);
					}

					print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
					print("<a href=\"javascript:SubmitQtyRecd('ToSelectRoutes','PrintRouteSheet');\">Count Sheets by Route</a>\n"); //Task#8891
					if($val_PBDEL == "Y") {
						print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
						print("<a href=\"javascript:SubmitQtyRecd('PreBundleSlip');\">Print Pre-bundle Slips</a>\n");
					}
				}

			//	if($val_RAGRP == "Y"){
					print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
					print("<a href=\"" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&doAction=DispReturnsAudit&Act=$Act&pdid=$pdid&incLoc=$incLoc", ENT_QUOTES) . "\">Record Returns Audit Quantities</a>\n");
			//	}
				if($val_REDIS == "Y" && $incLoc == "region" && $region != 0) {

					$fileLineNbr = __LINE__; $prodRegDisp = GetTableInfo($debug, $cvtconnection, "productregiondispatch", $prodRegDispId);
					unset($fileLineNbr);

					print("<br /><br />\n");
					print("<table border=\"0\" width=\"80%\" cellspacing=\"0\">\n");

					// FOR INSTRUCTIONS
					print("<tr class=\"datagrey\">\n");
					print("<td>\n");
					print("<b>Message To Dispatcher</b>\n");
					print("</td>\n");
					print("</tr>\n");

					print("<tr class=\"datawhite\">\n");
					print("<td>\n");
					print("<textarea name=\"instructions\" style=\"width:100%\" rows=\"4\" cols=\"0\">" . htmlentities($prodRegDisp[instructions], ENT_QUOTES) . "</textarea>\n");
					print("<br /><br />\n");
					print("</td>\n");
					print("</tr>\n");

					// FOR DISPATCHER COMMENTS
					print("<tr class=\"datagrey\">\n");
					print("<td>\n");
					print("<b>Dispatcher Comments</b>");
					print("</td>\n");
					print("</tr>\n");

					print("<tr class=\"datawhite\">\n");
					print("<td>\n");
					print("<textarea name=\"dispatchcomment\" style=\"width:100%\" rows=\"4\" cols=\"0\">" . htmlentities($prodRegDisp[dispatchcomment], ENT_QUOTES) . "</textarea>");
					print("<br /><br />\n");
					print("</td>\n");
					print("</tr>\n");

					// FOR MESSAGE TO DRIVERS
					print("<tr class=\"datagrey\">\n");
					print("<td>\n");
					print("<b>Message To Drivers</b>\n");
					print("</td>\n");
					print("</tr>\n");

					print("<tr class=\"datawhite\">\n");
					print("<td>\n");
					print("<textarea name=\"msgtodrivers\" style=\"width:100%\" rows=\"3\" cols=\"0\">" . htmlentities($prodRegDisp[msgtodrivers], ENT_QUOTES) . "</textarea>");
					print("<br /><br />\n");
					print("</td>\n");
					print("</tr>\n");

					print("</table>\n");
					print("<a href=\"javascript:submitLevel1FormUp('UpdateRegDispatch')\">Post</a>\n");

				}
				print("</form>\n");
			}
		}
		elseif($Act == "Route" && ($incLoc == "all" || ($incLoc == "region" && $region != 0))) {
			################################################3
			#  ROUTE BUTTON CASE
			################################################3
			print("<form name=\"Level1viewmode1\" method=\"get\" action=\"tra37.php\">\n");
			print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
			print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
			print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
			print("<input type=\"hidden\" name=\"Act\" value=\"$Act\" />\n");
			print("<input type=\"hidden\" name=\"incLoc\" value=\"$incLoc\" />\n");
			print("<input type=\"hidden\" name=\"region\" value=\"$region\" />\n");

			$incFromStr = "";
			$incWhereStr = "";
			if($incLoc == "region") {
				$incFromStr = ", vendingsubgroup vsg ";
				$incWhereStr = " AND vsg.vendinggroupid = $region
								 AND vsg.routeid = sr.routeid ";
			}
			if($ignoreRtType != 0 && $ignoreRtType != '')
				$chkRtType = " AND r.type NOT IN ($ignoreRtType) ";
			// DISPLAY ROUTE DROPLIST
			$qryGetR = "SELECT DISTINCT(sr.recid),
						CONCAT_WS(' - ', NULLIF(r.routenbr, ''), NULLIF(r.sdesc, ''), TIME_FORMAT(sr.timesked, '%H:%i:%s')) routeinfo, sr.driverid
						FROM specificroutes sr, route r/*, routesetdetail rsd*/,
						productdispatch pd " . $incFromStr . "
						WHERE sr.datesked = '$dbEffDt'
						AND r.recid = sr.routeid
						$chkRtType
						AND r.locationid = $ASLocationID
						AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
						OR r.endeffdt > '$curDate' )
						/*AND rsd.routeid = r.recid
						AND pd.routesetid = rsd.routesetid*/
						AND pd.recid = $pdid " . $incWhereStr . "
						ORDER BY r.sortseqnbr, routeinfo";

			// FOR SPLITTING OF TABLES
			$qryGetR = convertToSplitTables($qryGetR, $val_SPLIT);
			if($debug)
				print($qryGetR . "<br />\n");

			print("<b>Route : </b>");
			print("<select name=\"srid\" onchange=\"document.Level1viewmode1.submit()\">\n");
			if(!is_numeric($srid)) $srid = 0;
			if($srid == 0)
				print("\t<option value=\"\">Select Route</option>\n");
			$rsltGetR = mysqli_query( $cvtconnection, $qryGetR);
			if(!$rsltGetR) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				while($rowGetR = mysqli_fetch_assoc($rsltGetR)) {
					$fileLineNbr = __LINE__; $drivername = GetPer($rowGetR[driverid], $cvtconnection);
					if($drivername != "") $drivername = " - " . $drivername;

					print("\t<option value=\"" . $rowGetR[recid] . "\"");
					if($srid == $rowGetR[recid])
						print(" selected=\"selected\"");
					print(">");
					if($debug)
						print("" . $rowGetR[recid] . " - ");
					print("" . htmlentities($rowGetR[routeinfo] . $drivername, ENT_QUOTES) . "</option>\n");
				}
			}
			print("</select>\n");
			print("</form>\n");

			if($srid != 0) {

				$val_RDSRI = GetLSVar("RDSRI", "charvar", $ASLocationID, $cvtconnection);
				if($debug) print("RDSRI = $val_RDSRI<br />\n");

				$fromStr = "";
				$whereStr = "";
				$orderByStr = "";
				// FOR GETTING STRINGS FOR SORTING
				switch($val_RDSRI) {
					case "Q":
						$orderByStr = " rda.qtysked, p.ldesc";
						break;

					case "A":
						$fromStr = ", location l, locationlink ll, company c";

						$whereStr = " AND l.recid = p.vendorlocid
									AND ll.locationid = l.recid
									AND c.recid = ll.companyid";

						$orderByStr = " c.name, l.sdesc, p.ldesc";
						break;

					case "S":
						$orderByStr = " p.sortseqnbr";
						break;

					case "C":
						$orderByStr = " p.sdesc";
						break;

					case "B":
						$orderByStr = " p.adesc";
						break;

					default:
						$orderByStr = " p.ldesc";
						break;
				}

				//QUERY TO GET INFORMATION
				$qryGetInfo = "SELECT DISTINCT(sp.recid) spid, p.recid prodid,
								p.ldesc prod_desc, DATE_FORMAT(sp.datex, '%m/%d/%y') datex,
								rda.qtysked, rda.qtyissued, rda.qtyundelivered, rda.qtyretd,
								sp.bundlecount
								FROM routedrawaccounting rda, specificproduct sp,
								product p" . $fromStr . "
								WHERE rda.clientlocid = $ASLocationID
								AND rda.specificrouteid = $srid
								AND rda.type = 'SD'
								AND sp.recid = rda.actspecificproductid
								AND ( sp.endeffdt IS NULL OR sp.endeffdt = '0000-00-00'
								OR sp.endeffdt > '$dbEffDt' )
								AND p.recid = sp.productid
								AND p.clientid = $ASCompanyID
								AND ( p.endeffdt IS NULL OR p.endeffdt = '0000-00-00'
								OR p.endeffdt > '$dbEffDt' )" . $whereStr . "
								ORDER BY " . $orderByStr . ", prod_desc";

				// FOR SPLITTING OF TABLES
				$qryGetInfo = convertToSplitTables($qryGetInfo, $val_SPLIT);
				if($debug)
					print($qryGetInfo . "<br />\n");

				print("<form name=\"Level1Form\" method=\"post\" action=\"tra37.php\">\n");

				print("<table border=\"1\" width=\"100%\">\n");
				print("<tr class=\"datatblhdr\">\n");
				if($debug) print("<td>spid</td>\n");
				if($debug) print("<td>prodid</td>\n");
				if($incLoc != "region") {
					print("
						<td align=\"center\">
						<input type=\"checkbox\" name=\"checkall\" value=\"checkall\" onclick=\"CheckBoxAll(this.form, this.checked, 'sp_array')\" />
						</\ntd>
					");
				}
				print("<td>Publication</td>\n");
				if($val_EDITN == "Y") {
					print("<td>Edition</td>\n");
				}
				print("<td align=\"center\">Date</td>\n");
				print("<td align=\"right\">Calculated Draw</td>\n");
				if($incLoc != "region") {
					print("<td>Issued to Driver</td>\n");
					print("<td>Extra Copies</td>\n");
					print("<td>Excess Undelivered</td>\n");
				}

				/*
				print("<td align=\"right\">Bundles</td>");
				print("<td align=\"right\">Loose</td>");
				*/
				//print("<td>Issued</td>");
				print("<td align=\"right\">Bundles</td>\n");
				print("<td align=\"right\">Loose</td>\n");
				//print("<td>Returned</td>");

				//if($incLoc != "region") print("<td>Returns Audit</td>");
				print("</tr>");

				$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
				$oddEven = 0;
				$cntid = 0;

				if(!$rsltGetInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
						if( ( $oddEven++ % 2 ) == 0 ) {
							print("<tr class=\"datawhite\">\n");
						}
						else {
							print("<tr class=\"datagrey\">\n");
						}

						// FOR SPID
						$spid = $rowGetInfo[spid];
						if(!is_numeric($spid)) $spid = 0;
						if($debug) print("<td>$spid</td>\n");

						// FOR PRODID
						$prodid = $rowGetInfo[prodid];
						if(!is_numeric($prodid)) $prodid = 0;
						if($debug) print("<td>$prodid</td>\n");

						if($incLoc != "region") {
							// FOR SEL
							print("<td align=\"center\"><input type=\"checkbox\" name=\"sp_array[" . $cntid . "]\" value=\"" . $spid . "\" onclick=\"CheckBoxSingle(this.form, this.checked)\" /></td>\n");
						}

						// FOR PUBLICATION
						$prodDesc = $rowGetInfo[prod_desc];
						print("<td>" . ($prodDesc != "" ? htmlentities($prodDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");

						// FOR EDITION
						if($val_EDITN == "Y") {
							$dispEditionStr = "";
							// HERE FIND THE EDITIONID FROM ROUTEDRAW ACCOUNTING
							$qryGetEdition = "SELECT editionid editionId
											FROM routedrawaccounting
											WHERE clientlocid = $ASLocationID
											AND specificrouteid = $srid
											AND actspecificproductid = $spid
											AND type = 'SD'";

							$qryGetEdition = convertToSplitTables($qryGetEdition, $val_SPLIT);

							if($debug)
								print($qryGetEdition . "<br />\n");
							$rsltGetEdition = mysqli_query( $cvtconnection, $qryGetEdition);
							if(!$rsltGetEdition) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if(mysqli_num_rows($rsltGetEdition) == 0) {
								}
								else {
									$rowGetEdition = mysqli_fetch_assoc($rsltGetEdition);
									$editionId = $rowGetEdition[editionId];
									if(!is_numeric($editionId))	$editionId = 0;
								}
							}

							$fileLineNbr = __LINE__; $dispEditionStr = GetDescription("edition", $editionId, "sdesc");
							$dbEffDate = $dbEffDt;

							print("<td><a href=\"" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&doAction=DispExtraDrawSplit&dbEffDate=$dbEffDate&prodId=$prodid&srId=$srid&spId=$spid", ENT_QUOTES) . "\">" . htmlentities($dispEditionStr, ENT_QUOTES) . "</a>&nbsp;</td>\n");
						}

						// FOR DATE
						$datex = $rowGetInfo[datex];
						print("<td align=\"center\"");
						if(IsDateXDifferent_TRA37($spid))
							print(" style=\"color:#ff0000\"");
						print(">" . ($datex != "" ? htmlentities($datex, ENT_QUOTES) : "&nbsp;") . "</td>\n");

						// FOR ACTUAL DRAW
						$qtysked = $rowGetInfo[qtysked];
						if(!is_numeric($qtysked)) $qtysked = 0;
						print("<td align=\"right\">" . ($qtysked != "" ? $qtysked : "&nbsp;") . "</td>\n");

						if($incLoc != "region") {
							// FOR ISSUED TO DRIVER
							$qtyissued = $rowGetInfo[qtyissued];
							if(!is_numeric($qtyissued)) $qtyissued = 0;
							if($qtyissued != 0)	$disp_issueqty = $qtyissued;
							else $disp_issueqty = 0;
							$dispExtQty = $qtyissued - $qtysked;

							if($val_EDITN !== "Y") {
								print("<td>");
								print("<input type=\"text\" name=\"qtyiss_array[" . $cntid . "]\" value=\"$disp_issueqty\" size=\"5\" maxlength=\"5\" onchange=\"CheckOne('sp_array', '" . $cntid . "')\" tabindex=\"" . ( $cntid + 1 ) . "\" />");
								print("</td>\n");


								print("<td>");
								print("<input type=\"text\" name=\"qtyext_array[" . $cntid . "]\" value=\"$dispExtQty\" size=\"5\" maxlength=\"5\" onchange=\"CheckOne('sp_array', '" . $cntid . "')\" tabindex=\"" . ( $cntid + 1 ) . "\" />");
								print("</td>\n");
							}
							else {
								if($editionId == 2 || $editionId == 1) {
									print("<td>" . $disp_issueqty . "</td>\n");
									print("<td>" . $dispExtQty . "");

									print("<input type=\"hidden\" name=\"qtyiss_array[" . $cntid . "]\" value=\"$disp_issueqty\" />\n");

									print("<input type=\"hidden\" name=\"qtyext_array[" . $cntid . "]\" value=\"$dispExtQty\" />\n");
									print("</td>\n");
								}
								else {
									print("<td>");
									print("<input type=\"text\" name=\"qtyiss_array[" . $cntid . "]\" value=\"$disp_issueqty\" size=\"5\" maxlength=\"5\" onchange=\"CheckOne('sp_array', '" . $cntid . "')\" tabindex=\"" . ( $cntid + 1 ) . "\"");
									print(" />");
									print("</td>\n");

									print("<td>");
									print("<input type=\"text\" name=\"qtyext_array[" . $cntid . "]\" value=\"$dispExtQty\" size=\"5\" maxlength=\"5\" onchange=\"CheckOne('sp_array', '" . $cntid . "')\" tabindex=\"" . ( $cntid + 1 ) . "\" />");
									print("</td>\n");
								}
							}

							// FOR EXCESS UNDELIVERED QTYUNDELIVERED
							$qtyundelivered = $rowGetInfo[qtyundelivered];
							if(!is_numeric($qtyundelivered)) $qtyundelivered = 0;
							if($qtyundelivered != 0) {
								$disp_qtyundelivered = $qtyundelivered;
							}
							else {
								$disp_qtyundelivered = 0;
							}

							print("<td>");
							print("<input type=\"text\" name=\"qtyundelivered_array[" . $cntid . "]\" value=\"$disp_qtyundelivered\" size=\"5\" maxlength=\"5\" onchange=\"CheckOne('sp_array', '" . $cntid . "')\" tabindex=\"" . ( $cntid + 1 ) . "\" />\n");
							print("</td>\n");
						}

						// FOR BUNDLES AND QUANTITIES
						$bundle_cnt = $rowGetInfo[bundlecount];
						if(!is_numeric($bundle_cnt)) $bundle_cnt = 0;

						/*
						// FOR Bundles
						if($bundle_cnt == 0) $act_bundle_cnt = 0;
						else $act_bundle_cnt = (int)($qtysked / $bundle_cnt);
						if(!is_numeric($act_bundle_cnt)) $act_bundle_cnt = 0;
						print("<td align=\"right\">$act_bundle_cnt</td>");

						// FOR Loose
						if($bundle_cnt == 0) $act_lost = 0;
						else $act_lost = ( $qtysked % $bundle_cnt );
						if(!is_numeric($act_lost)) $act_lost = 0;
						print("<td align=\"right\">$act_lost</td>");
						*/

						/*// FOR Issued
						$qtyissued = $rowGetInfo[qtyissued];
						if(!is_numeric($qtyissued)) $qtyissued = 0;
						print("<td>");
						print("<input type=\"text\" name=\"qtyiss_array[" . $cntid . "]\" value=\"$qtyissued\" size=\"5\" maxlength=\"5\" onchange=\"CheckOne('sp_array', '" . $cntid . "')\" tabindex=\"" . ( $cntid + 1 ) . "\" />");
						print("</td>");*/

						// FOR BUNDLES
						if($bundle_cnt == 0) {
							$iss_bundle_cnt = 0;
						}
						else {
							$iss_bundle_cnt = (int)($qtyissued / $bundle_cnt);
						}
						if(!is_numeric($iss_bundle_cnt)) $iss_bundle_cnt = 0;
						print("<td align=\"right\">" . ($iss_bundle_cnt != "" ? $iss_bundle_cnt : "&nbsp;") . "</td>\n");

						// FOR LOOSE
						if($bundle_cnt == 0) {
							$iss_lost = 0;
						}
						else {
							$iss_lost = ( $qtyissued % $bundle_cnt );
						}
						if(!is_numeric($iss_lost)) $iss_lost = 0;
						print("<td align=\"right\">" . ($iss_lost != "" ? $iss_lost : "&nbsp;") . "</td>\n");

						/*if($incLoc != "region") {
							// FOR Returned
							$qtyretd = $rowGetInfo[qtyretd];
							if(!is_numeric($qtyretd)) $qtyretd = 0;
							print("<td>");
							print("<input type=\"text\" name=\"qtyretd_array[" . $cntid . "]\" value=\"$qtyretd\" size=\"5\" maxlength=\"5\" onchange=\"CheckOne('sp_array', '" . $cntid . "')\" tabindex=\"" . ( $cntid + 1 ) . "\" />");
							print("</td>");
						}*/

						print("</tr>\n");
						$cntid++;
					}
				}
				print("</table>\n");
				print("<br />\n");

				if($incLoc == "all") {

					$selectStr = "routeid routeId";
					$fromStr = "specificroutes";
					$whereStr = "recid = $srid";
					$fileLineNbr = __LINE__; $rsltArray = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
					unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

					if($rsltArray) {
						$routeId = $rsltArray[routeId];
					}
					else {
						$routeId = 0;
					}
					unset($rsltArray);
					if(!is_numeric($routeId)) $routeId = 0;

					// LETS GET THE SPECIFICPRODUCTID FOR THE 'SP' RECORDS HERE
					/*$qryGetSp = "SELECT DISTINCT ta.specificproductid tmpSpId
								FROM transactivity ta
								WHERE ta.locationid = $ASLocationID
								AND ta.specificrouteid = $srid
								AND ta.datet = '$dbEffDt'
								AND ta.type = 'SP'";

					// FOR SPLITTING OF TABLES
					$qryGetSp = convertToSplitTables($qryGetSp, $val_SPLIT);
					if($debug)
						print($qryGetSp . "<br />\n");

					$rsltGetSp = mysql_query($qryGetSp, $cvtconnection);
					$spIdStr = "";*/
					/*if(!$rsltGetSp) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if(mysql_num_rows($rsltGetSp) == 0) {
						}
						else {
							while($rowGetSp = mysql_fetch_assoc($rsltGetSp)) {
								$tmpSpId = $rowGetSp[tmpSpId];
								if(!is_numeric($tmpSpId)) $tmpSpId = 0;
								if($spIdStr == "") {
									$spIdStr = $tmpSpId;
								}
								else {
									$spIdStr .= ", ". $tmpSpId;
								}
							}
						}
					}*/

					if($spIdStr == "") $spIdStr = "0";

					//QUERY TO GET INFORMATION
					$qryGetInfo = "SELECT DISTINCT(sp.recid) spIdRet, p.recid prodIdRet,
									p.ldesc prodDesc, DATE_FORMAT(sp.datex, '%m/%d/%y') dateXRet, rda.qtyretd qtyRetd
									FROM routedrawaccounting rda, specificproduct sp,
									product p" . $fromStr . "
									WHERE rda.clientlocid = $ASLocationID
									AND rda.specificrouteid = $srid
									AND rda.type = 'SP'
									AND sp.recid = rda.actspecificproductid
									/*AND sp.recid IN (" . $spIdStr . ")*/
									AND ( sp.endeffdt IS NULL OR sp.endeffdt = '0000-00-00'
									OR sp.endeffdt > '$dbEffDt' )
									AND p.recid = sp.productid
									AND p.clientid = $ASCompanyID
									AND ( p.endeffdt IS NULL OR p.endeffdt = '0000-00-00'
									OR p.endeffdt > '$dbEffDt' )" . $whereStr . "
									ORDER BY " . $orderByStr . ", prodDesc";

					// FOR SPLITTING OF TABLES
					$qryGetInfo = convertToSplitTables($qryGetInfo, $val_SPLIT);

					if($debug)
						print($qryGetInfo . "<br />\n");
					print("<table  width=\"100%\">\n");
					print("<tr >");
					 print("<td>");
					 print("&nbsp;&nbsp;&nbsp;<a href=\"javascript:openpopup1('" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&doAction=AddQtyRoute&pdid=$pdid&srid=$srid&norecords=$cntid&noRecRet=$cntIdRet&Act=$Act&prodRegDispId=$prodRegDispId&locId=$locId&effDt=" . get_date($dbEffDt, "MMDDYY") . "", ENT_QUOTES) . "');\">Add Returns Audit Publication Issue</a>\n");
					 print("</td>\n");
					 print("</tr>");
					 print("</table>");
					
					print("<table border=\"1\" width=\"100%\">\n");
					print("<tr class=\"datatblhdr\">\n");
					if($debug) print("<td>spid</td>\n");
					if($debug) print("<td>prodid</td>\n");
					print("<td align=\"center\"><input type=\"checkbox\" name=\"checkall\" value=\"checkall\" onclick=\"CheckBoxAll(this.form, this.checked, 'spRetArr')\" /></td>\n");
					print("<td>Publication</td>\n");
					print("<td align=\"center\">Date</td>\n");
					print("<td>Returns Audit</td>\n");
					print("</tr>\n");

					$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
					$oddEven = 0;
					$cntIdRet = 0;
					if(!$rsltGetInfo) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
							if( ( $oddEven++ % 2 ) == 0 ) {
								print("<tr class=\"datawhite\">\n");
							}
							else {
								print("<tr class=\"datagrey\">\n");
							}

							// FOR SPID
							$spIdRet = $rowGetInfo[spIdRet];
							if(!is_numeric($spIdRet)) $spIdRet = 0;
							if($debug)
								print("<td>$spIdRet</td>");

							// FOR PRODID
							$prodIdRet = $rowGetInfo[prodIdRet];
							if(!is_numeric($prodIdRet)) $prodIdRet = 0;
							if($debug)
								print("<td>$prodIdRet</td>");

							// FOR SEL
							print("<td align=\"center\"><input type=\"checkbox\" name=\"spRetArr[" . $cntIdRet . "]\" value=\"" . $spIdRet . "\" onclick=\"CheckBoxSingle(this.form, this.checked)\" /></td>\n");

							// FOR PUBLICATION
							$prodDesc = $rowGetInfo[prodDesc];
							print("<td>" . ($prodDesc != "" ? htmlentities($prodDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");

							// FOR DATE
							$dateXRet = $rowGetInfo[dateXRet];
							print("<td align=\"center\"");
							print(">" . ($dateXRet != "" ? htmlentities($dateXRet, ENT_QUOTES) : "&nbsp;") . "</td>\n");

							// FOR RETURNED
							$qtyRetd = $rowGetInfo[qtyRetd];
							if(!is_numeric($qtyRetd)) $qtyRetd = 0;
							print("<td>");
							print("<input type=\"text\" name=\"qtyRetdArr[" . $cntIdRet . "]\" value=\"$qtyRetd\" size=\"5\" maxlength=\"5\" onchange=\"CheckOne('spRetArr', '" . $cntIdRet . "')\" tabindex=\"" . ( $cntIdRet + 1 ) . "\" />");
							print("</td>\n");

							print("</tr>\n");
							$cntIdRet++;
						}
					}
					print("</table>\n");
					print("<br />\n");
				}

				print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
				print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
				print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
				print("<input type=\"hidden\" name=\"srid\" value=\"$srid\" />\n");
				print("<input type=\"hidden\" name=\"norecords\" value=\"$cntid\" />\n");
				print("<input type=\"hidden\" name=\"noRecRet\" value=\"$cntIdRet\" />\n");
				print("<input type=\"hidden\" name=\"Act\" value=\"$Act\" />\n");
				print("<input type=\"hidden\" name=\"prodRegDispId\" value=\"$prodRegDispId\" />\n");
				if($incLoc != "region") {
					print("<a href=\"javascript:SubmitQtyRecd('QtyRoute')\" tabindex=\"" . ( $cntid + 1 ) . "\">Post</a>\n");
					
					//print("<a href=\"javascript:SubmitQtyRecd('AddQtyRoute')\" tabindex=\"" . ( $cntid + 1 ) . "\">Add</a><br />\n");
				}

				if($val_REDIS == "Y" && $incLoc == "region" && $region != 0) {

					$fileLineNbr = __LINE__; $prodRegDisp = GetTableInfo($debug, $cvtconnection, "productregiondispatch", $prodRegDispId);
					unset($fileLineNbr);

					print("<br /><br />\n");
					print("<table border=\"0\" width=\"80%\" cellspacing=\"0\">\n");

					// FOR INSTRUCTIONS
					print("<tr class=\"datagrey\">\n");
					print("<td>");
					print("<b>Message To Dispatcher</b>");
					print("</td>\n");
					print("</tr>\n");

					print("<tr class=\"datawhite\">\n");
					print("<td>");
					print("<textarea name=\"instructions\" style=\"width:100%\" rows=\"4\" cols=\"0\">" . htmlentities($prodRegDisp[instructions], ENT_QUOTES) . "</textarea>");
					print("<br /><br />\n");
					print("</td>\n");
					print("</tr>\n");

					// FOR DISPATCHER COMMENTS
					print("<tr class=\"datagrey\">\n");
					print("<td>");
					print("<b>Dispatcher Comments</b>");
					print("</td>\n");
					print("</tr>\n");

					print("<tr class=\"datawhite\">\n");
					print("<td>");
					print("<textarea name=\"dispatchcomment\" style=\"width:100%\" rows=\"4\" cols=\"0\">" . htmlentities($prodRegDisp[dispatchcomment], ENT_QUOTES) . "</textarea>");
					print("<br /><br />\n");
					print("</td>\n");
					print("</tr>\n");

					// FOR MESSAGE TO DRIVERS
					print("<tr class=\"datagrey\">\n");
					print("<td>");
					print("<b>Message To Drivers</b>");
					print("</td>\n");
					print("</tr>\n");

					print("<tr class=\"datawhite\">\n");
					print("<td>");
					print("<textarea name=\"msgtodrivers\" style=\"width:100%\" rows=\"3\" cols=\"0\">" . htmlentities($prodRegDisp[msgtodrivers], ENT_QUOTES) . "</textarea>");
					print("<br /><br />\n");
					print("</td>\n");
					print("</tr>\n");

					print("</table>\n");
					print("<a href=\"javascript:submitLevel1FormUp('UpdateRegDispatch')\">Post</a><br />\n");
				}
				print("</form>\n");
			}
		}

		if($doAction == "ToQtyRecd") {
			print("<br /><div>");
			print("<input type=\"button\" value=\"Proceed to the Next Step\" onclick=\"location.href='../cm/doback.php?Back=$Back'\" />");
			print("</div>\n");
		}

		//UPDATE QTYRECDDT AND QTYRECDAS
		$qryUp = "UPDATE productdispatch
				SET qtyrecddt = now(),
				qtyrecdas = $RecIdAS
				WHERE recid = $pdid";
		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
		}
		print("</div>\n");
		break;

	case "QtyRecd":
		// VALIDATION
		ValidateForInt(false, "pdid", "region");

		// GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$effdt = "";
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		// WE HAVE ARRAY JUST GO THROUGH IT AND UPDATE THE QTYS
		$flagRecUpdated = false;
		while(list($cntid, $spid) = each($sp_array)) {
			ValidateForInt(false, "cntid", "spid");
			$qty = $qtyrecd[$spid];
			$issued = $qtyissued[$spid];
			$undelivered = $qtyundelivered[$spid];
			ValidateForInt(false, "qty", "issued", "undelivered");
			$recTimeArr = explode(" ", $recTime[$cntid]);
			if($recTimeArr[1] == "HHMM") {
				$recTimeStr = "";
			}
			else {
				$recTimeStr = makedate($recTimeArr[0], "MMDDYY") . " " . MakeTime($recTimeArr[1]);
			}

			if($val_REDIS == "Y" && $incLoc == "region") {

				$qryChkRecs = "SELECT COUNT(*)
								FROM regiondrawaccounting
								WHERE clientlocid = $ASLocationID
								AND specificproductid = $spid
								AND vendinggroupid = $region";
				if($debug)
					print($qryChkRecs . "<br />\n");
				$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
				$flagExist = false;
				if(!$rsltChkRecs) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if($rowChkRecs = mysqli_fetch_row($rsltChkRecs)) {
						$noRecs = $rowChkRecs[0];
						if(!is_numeric($noRecs)) $noRecs = 0;
						if($noRecs > 0) $flagExist = true;
					}
				}

				if($flagExist) {

					$qryUp = "UPDATE regiondrawaccounting
								SET qtyrecd = $qty";
					if($recTimeStr != "") {
						$qryUp .= ",  receivetime = '$recTimeStr'";
					}
					else {
						$qryUp .= ",  receivetime = NULL";
					}
					$qryUp .= ", archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
								WHERE clientlocid = $ASLocationID
								AND specificproductid = $spid
								AND vendinggroupid = $region";
					if($debug)
						print("<b>" . $qryUp . "</b><br />\n");
					$rsltUp = mysqli_query( $cvtconnection, $qryUp);
					if(!$rsltUp) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if($debug)
							print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");

						$flagRecUpdated = true;
					}
				}
				else {
					$qtyArr = GetQtySked_TRA37($pdid, $spid, 'region', $region);
					$qtysked = $qtyArr[QTYSKED];
					$qryIns = "INSERT INTO regiondrawaccounting
								(clientlocid , vendinggroupid , specificproductid, qtyrecd , qtysked , receivetime)
								values ($ASLocationID , $region, $spid, $qty , $qtysked, " . ($recTimeStr != "" ? "'$recTimeStr'" : "NULL" ) . ")";
					if($debug)
						print("<b>" . $qryIns . "</b><br />\n");
					$rsltIns = mysqli_query( $cvtconnection, $qryIns);
					if(!$rsltIns) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if($debug)
							print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
					}
				}
			}
			else {
				$qryUp = "UPDATE totaldrawaccounting
							SET qtyrecd = $qty";
				if($recTimeStr != "") {
					$qryUp .= ",  receivetime = '$recTimeStr'";
				}
				else {
					$qryUp .= ",  receivetime = NULL";
				}
				$qryUp .= ", archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
							WHERE clientlocid = $ASLocationID
							AND actspecificproductid = $spid
							AND type = 'S'";
				if($debug)
					print("<b>" . $qryUp . "</b><br />\n");
				$rsltUp = mysqli_query( $cvtconnection, $qryUp);
				if(!$rsltUp) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if($debug)
						print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
				}
			}


			/*#Update Routedraw accounting
			$qryUp = "UPDATE routedrawaccounting
						SET qtyissued = $issued,
							qtyundelivered = $undelivered
						WHERE clientlocid = $ASLocationID
						AND actspecificproductid = $spid
						AND type = 'SD'";
			if($debug) print("$qryUp<br />");
			$rsltUp = mysql_query($qryUp, $cvtconnection);
			if(!$rsltUp) print("<b>Can't update </b><br />");*/

			// NOW UDPATE BUNDLECOUNT
			$bCount = $b_cnt[$spid];
			if(!is_numeric($bCount)) $bCount = 0;

			$qryUp = "UPDATE specificproduct
					SET bundlecount = $bCount,
					archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
					WHERE recid = $spid";
			if($debug)
				print("<b>" . $qryUp . "</b><br />\n");
			$rsltUp = mysqli_query( $cvtconnection, $qryUp);
			if(!$rsltUp) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if($debug)
					print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
			}
		}

		/*
		if($flagRecUpdated) {
			//UPDATE QTYRECDDT AND QTYRECDAS
			$qryUp = "UPDATE productdispatch
					SET qtyrecddt = now(),
					qtyrecdas = $RecIdAS
					WHERE recid = $pdid";
			if($debug) print("$qryUp<br />");
			$rsltUp = mysql_query($qryUp, $cvtconnection);
			if(!$rsltUp) print("<b>Can't update productdispatch</b><br />");
		}
		*/

		if($debug) {
			print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
		}
		else {
		    header("Location: " . urldecode($Back));
		}
		break;

	case "QtyRoute":
		// VALIDATION
		ValidateForInt(false, "pdid");

		// GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$effdt = "";
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		// WE HAVE ARRAY JUST GO THROUGH IT AND UPDATE THE QTYS
		$flagRecUpdated = false;
		if(is_array($sp_array)) {

			while(list($cntid, $spid) = each($sp_array)) {
				ValidateForInt(false, "cntid", "spid");
				$qtyiss = $qtyiss_array[$cntid];
				//$qtyretd = $qtyretd_array[$cntid];
				$qtyundelivered = $qtyundelivered_array[$cntid];
				$qtyExtra = $qtyext_array[$cntid];
				ValidateForInt(false, "qtyiss", "qtyretd", "qtyundelivered", "qtyExtra");

				// GET EXISTING QTYISSUED VALUE
				$selectStr = "qtyissued, qtysked";
				$fromStr = "routedrawaccounting";
				$whereStr = "clientlocid = $ASLocationID
							AND actspecificproductid = $spid
							AND specificrouteid = $srid
							AND type = 'SD'";
				$fileLineNbr = __LINE__; $rsltArray = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
				unset($selectStr, $fromStr, $whereStr);

				if($rsltArray) {
					$oldQtyIssued = $rsltArray[qtyissued];
					$qtysked = $rsltArray[qtysked];
				}
				else {
					$oldQtyIssued = 0;
					$qtysked = 0;
				}
				unset($rsltArray, $fileLineNbr);

				$qryUp = "UPDATE routedrawaccounting
							SET qtyissued = $qtyiss,
							qtyundelivered = $qtyundelivered,
							archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
							WHERE clientlocid = $ASLocationID
							AND actspecificproductid = $spid
							AND specificrouteid = $srid
							AND type = 'SD'";

				// FOR SPLITTING OF TABLES
				$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

				if($debug)
					print("<b>" . $qryUp . "</b><br />\n");
				$rsltUp = mysqli_query( $cvtconnection, $qryUp);
				if(!$rsltUp) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 03);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					$flagRecUpdated = true;
				}

				if($oldQtyIssued == $qtyiss) {
					// HERE WE NEED TO CONSIDER THE EXTRAPAPER CASE
					$qtyiss = $qtysked + $qtyExtra;

					$qryUp = "UPDATE routedrawaccounting
								SET qtyissued = $qtyiss,
								archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
								WHERE clientlocid = $ASLocationID
								AND actspecificproductid = $spid
								AND specificrouteid = $srid
								AND type = 'SD'";

					// FOR SPLITTING OF TABLES
					$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

					if($debug)
						print("<b>" . $qryUp . "</b><br />\n");
					$rsltUp = mysqli_query( $cvtconnection, $qryUp);
					if(!$rsltUp) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 03);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if($debug)
							print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");

						$flagRecUpdated = true;
					}
				}
			}
		}

		if(is_array($spRetArr)) {
			while(list($cntRetId, $spIdRet) = each($spRetArr)) {
				ValidateForInt(false, "cntRetId", "spIdRet");

				$qtyretd = $qtyRetdArr[$cntRetId];
				ValidateForInt(false, "qtyretd");

				// CHECK WHETHER ROUTEDRAWACCOUNTING TYPE 'SP' RECORD EXIST
				$qryChkRecs = "SELECT COUNT(recid) rdCnt
								FROM routedrawaccounting
								WHERE clientlocid = $ASLocationID
								AND actspecificproductid = $spIdRet
								AND specificrouteid = $srid
								AND type = 'SP'";

				// FOR SPLITTING OF TABLES
				$qryChkRecs = convertToSplitTables($qryChkRecs, $val_SPLIT);

				if($debug)


					print($qryChkRecs . "<br />\n");
				$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);

				if(!$rsltChkRecs) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					$rowChkRecs = mysqli_fetch_assoc($rsltChkRecs);
					$rdCnt = $rowChkRecs[rdCnt];

					if($rdCnt == 0) {
						$qryIns = "INSERT INTO routedrawaccounting
									(clientlocid, specificrouteid, actspecificproductid, qtyretd, type)
									VALUES
									($ASLocationID, $srid, $spIdRet, $qtyretd, 'SP')";

						// FOR SPLITTING OF TABLES
						$qryIns = convertToSplitTables($qryIns, $val_SPLIT);

						if($debug)
							print("<b>" . $qryIns . "</b><br />\n");
						$rsltIns = mysqli_query( $cvtconnection, $qryIns);
						if(!$rsltIns) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 02);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
						}
					}
					else {
						$qryUp = "UPDATE routedrawaccounting
									SET qtyretd = $qtyretd,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE clientlocid = $ASLocationID
									AND actspecificproductid = $spIdRet
									AND specificrouteid = $srid
									AND type = 'SP'";

						// FOR SPLITTING OF TABLES
						$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
							$flagRecUpdated = true;
						}
					}
				}
			}
		}

		/*
		if($flagRecUpdated) {
			//UPDATE QTYRECDDT AND QTYRECDAS
			$qryUp = "UPDATE productdispatch
					SET qtyrecddt = now(),
					qtyrecdas = $RecIdAS
					WHERE recid = $pdid";
			if($debug) print("$qryUp<br />");
			$rsltUp = mysql_query($qryUp, $cvtconnection);
			if(!$rsltUp) print("<b>Can't update productdispatch</b><br />");
		}
		*/

		if($debug) {
			print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
		}
		else {
		    header("Location: " . urldecode($Back));
		}
		break;
	case "InsertQtyRoute";
		//	echo "<br>";
		//print_r($_POST);
		//print $ProdId."---".$ProdDate."-------".$RetQty."<br>";
	// CHECK IF ROUTEDRAWACCOUNTING RECORD EXIST THEN UPDATE IT ELSE CREATE IT
				$qryChkRecs = "SELECT recid
								FROM routedrawaccounting
								WHERE clientlocid = $GLOBALS[ASLocationID]
								AND specificrouteid = $srid
								AND actspecificproductid = $ProdDate
								AND type = 'SP'";

				// FOR SPLITTING OF TABLES
				$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);

				if($GLOBALS[debug])
					print($qryChkRecs . "<br />\n");
				$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
				if(!$rsltChkRecs) {
					$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($GLOBALS[fileLineNbr]);
				}
				else {
						$rowChkRecs = mysqli_fetch_assoc($rsltChkRecs); 
						$rdaId = $rowChkRecs[recid];
				}
				
			if($rdaId)
			{
				print "<font color= 'red'>Return audit exist for Product...........</font><br>";
			}else			
			{
		$qryIns = "INSERT INTO routedrawaccounting(clientlocid, specificrouteid, actspecificproductid, qtyretd, type)
						VALUES($GLOBALS[ASLocationID], '$srid', '$ProdDate', '$RetQty', 'SP')";

						// FOR SPLITTING OF TABLES
						$qryIns = convertToSplitTables($qryIns, $GLOBALS[val_SPLIT]);

						if($GLOBALS[debug])
							print("<b>" . $qryIns . "</b><br />\n");
						$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
						if(!$rsltIns) {
							$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 02);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($GLOBALS[fileLineNbr]);
						}else
						{
							print "Return Audit created for Product...........<br>";
							
						}
	
		}
		//echo "<br>";
	break; 
	case "AddQtyRoute":
		//print "AddQtyReouteCall";
		//print_r($_GET);
		print("<form name=\"Level2Form\" method=\"post\" action=\"\" style=\"margin: 0;\">\n");
		print("<table  border=\"0\" cellpadding=\"6\" cellspacing=\"2\" width=\"55%\">\n");
		print("<tr><td class=\"entryscreenborder\">\n");
		print("<table  width=\"100%\" border=\"0\" bgcolor=\"white\" cellpadding=\"1\" cellspacing=\"1\">\n");

		// FOR Publicatin
		print("<tr>\n");
		print("<td class=\"datagrey\">Publication</td>\n");
		$getProd = "Select recid,sdesc,ldesc from product where clientid = $ASCompanyID and (endeffdt = '0000-00-00' OR endeffdt IS NULL OR endeffdt > '$curDate')";
		
		$numRows = mysqli_fetch_row($rslProd);
		//if($numRows)
		//{
		print("<td class=\"datawhite\">\n");
			print("<select name=\"ProdId\" onchange=\"getData(this.value)\">\n");
			if(!is_numeric($ProdId)) $ProdId = 0;
			if($ProdId == 0)
				print("\t<option value=\"\">Select Product</option>\n");
			$rslProd = mysqli_query( $cvtconnection, $getProd);
			//$rsltGetR = mysql_query($qryGetR, $cvtconnection);
			if(!$rslProd) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				while($rowGetP = mysqli_fetch_assoc($rslProd)) {
					
					print("\t<option value=\"" . $rowGetP[recid] . "\"");
					if($ProdId == $rowGetP[recid])
						print(" selected=\"selected\"");
					print(">");
					if($debug)
						print("" . $rowGetP[recid] . " - ");
					print("" . htmlentities($rowGetP[ldesc] ."(". $rowGetP[sdesc].")", ENT_QUOTES) . "</option>\n");
				}
			}
			print("</select>\n");
				
		//}else
		//{
		
		print("&nbsp;</td>");
		//}
		print ("</tr>");
		
		// FOR Publicatin Date
		print("<tr>\n");
		print("<td class=\"datagrey\">Publication Date</td>\n");
		print("<td class=\"datawhite\">\n");
		
	   //AJAX DIV for DATE
	    print ("<div id=\"divSelection\">");
			print("<select name=\"ProdDate\" id=\"ProdDate\">\n");
			print("<option value=\"\">Select Date</option>\n");
			print("</select>\n"); 
		print ("</div>");
		
		print("</td>");
		print ("</tr>");
		
		// FOR Returns Quantity
		print("<tr>\n");
		print("<td class=\"datagrey\">Returns Quantity</td>\n");
		print("<td class=\"datawhite\">\n");
		
			print ("<input type=\"text\" maxlength=\"4\" name=\"RetQty\" id=\"RetQty\" size=\"4\" />");
		
		print("</td>");
		print ("</tr>");
		
		print("<tr>");
		print("<td>");
		print("&nbsp;");
		print("</td>");
		
		print("<td>");
		print("<a href=\"javascript:SubmitQtyRecd('InsertQtyRoute')\" >Add</a>\n");
		print("</td>");
		print("</tr>");
		
		
		print("</table>");
		print("</td>");
		print("</tr>");
		print ("</table>");
		
		

		
		
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
				print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
				print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
				print("<input type=\"hidden\" name=\"srid\" value=\"$srid\" />\n");
				print("<input type=\"hidden\" name=\"norecords\" value=\"$cntid\" />\n");
				print("<input type=\"hidden\" name=\"noRecRet\" value=\"$cntIdRet\" />\n");
				print("<input type=\"hidden\" name=\"Act\" value=\"$Act\" />\n");
				print("<input type=\"hidden\" name=\"prodRegDispId\" value=\"$prodRegDispId\" />\n");
		print("</form>");
		
	break;
	
	case "PrintSheet":

		// VALIDATION
		ValidateForInt(false, "pdid", "region");
		$incFromStr = "";
		$incWhereStr = "";
		if($incLoc == "region") {
			$incFromStr = ", vendingsubgroup vsg ";
			$incWhereStr = " AND vsg.vendinggroupid = $region
							 AND vsg.routeid = sr.routeid ";
		}

		print("<div class=\"datawhite\">");

		// GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$effdt = "";
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

if($val_CSBDL == "Y") {

			$qryFormula = "SELECT strvar FROM locationsystem
							WHERE SUBSTRING(recid,1,4) = 'BNDL'
							AND locationid = $ASLocationID ";
			$xqryFormula = mysqli_query($cvtconnection, $qryFormula);
			$fqryFormula = mysqli_fetch_array($xqryFormula);
			$strFormula = $fqryFormula['strvar'];
			$formulaArray = array();
			$formulaArray = explode('~',$strFormula);
			$minAmt = $formulaArray[0];
			$maxAmt = $formulaArray[1];	
			$diffAmt = $maxAmt - $minAmt;	
			
}

		// FIND THE VARIOUS ROUTES
		$qryGetR = "SELECT DISTINCT(sr.recid),
					CONCAT_WS(' - ', NULLIF(r.sdesc, ''), NULLIF(r.routenbr, ''), TIME_FORMAT(sr.timesked, '%H:%i:%s')) routeinfo
					FROM productdispatch pd, routesetdetail rsd, route r, specificroutes sr " . $incFromStr . "
					WHERE pd.recid = $pdid
					AND rsd.routesetid = pd.routesetid
					AND r.recid = rsd.routeid
					AND r.locationid = $ASLocationID
					AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
					OR r.endeffdt > '$curDate' )
					AND ( rsd.endeffdt IS NULL OR rsd.endeffdt = '0000-00-00'
							OR rsd.endeffdt > '$curDate' )
					AND sr.routeid = r.recid
					AND sr.datesked = '$dbEffDt'
					AND sr.dispatchlocid = $ASLocationID " . $incWhereStr . "
					ORDER BY r.sortseqnbr, routeinfo";

		// FOR SPLITTING OF TABLES
		$qryGetR = convertToSplitTables($qryGetR, $val_SPLIT);
		if($debug)
			print($qryGetR . "<br />\n");
		$rsltGetR = mysqli_query( $cvtconnection, $qryGetR);
		if(!$rsltGetR) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
			print("<br /><br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetR) == 0) {
				print("<b>No Routes Found</b><br /><br />\n");
				print("<a href=\"" . urldecode(htmlspecialchars($Back, ENT_QUOTES)) . "\">Back</a><br />\n");
			}
			else {
				print("<br clear=\"all\" style=\"page-break-after:always\">\n");

				if($incLoc == "region") {
					// LETS DISPLAY THE REGIN DESCRIPTION HERE
					$fileLineNbr = __LINE__; $groupDesc = GetDescription("vendinggroup", $region, "sdesc");
					print("<div class=\"datawhite\" align=\"center\">");
					print("<b><u>" . htmlentities($groupDesc, ENT_QUOTES) . "</u></b><br /><br />\n");
					print("</div>\n");
				}
				//NOW WE HAVE SPIDS IN THE FORM OF SP_ARRAY
				//FETCH THEM AND PRINT A REPORT FOR ALL OF THEM
				while(list($cntid, $spid) = each($sp_array)) {
					ValidateForInt(false, "cntid", "spid");

					//Print header
					$selectStr = "CONCAT_WS(' - ', NULLIF(p.ldesc, ''), DATE_FORMAT(sp.datex, '%m/%d/%y')) prod_desc";
					$fromStr = "specificproduct sp, product p";
					$whereStr = "sp.recid = $spid
								AND p.recid = sp.productid";
					$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
					unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

					if($rsltArr) {
						$prod_desc = $rsltArr[prod_desc];
					}
					else {
						$prod_desc = "";
					}
					unset($rsltArr);

					// FIND BUNDLE_CNT
					$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "specificproduct", $spid, "bundlecount");
					if($rsltArr[rtvalue]) {
						$bundle_cnt = $rsltArr[bundlecount];
						if(!is_numeric($bundle_cnt)) $bundle_cnt = 0;
					}
					else {
						$bundle_cnt = 0;
					}
					unset($rsltArr, $fileLineNbr);

					print("<b><u>" . htmlentities($prod_desc, ENT_QUOTES) . "</u></b><br /><br />\n");

					//QUERY TO GET INFORMATION
					print("<table border=\"1\" width=\"100%\">\n");
					if($val_PBDEL == "Y" || $val_CSBDL == "Y") {
						print("<tr class=\"datatblhdr\">\n");
						if($debug) print("<td>&nbsp;</td>");
						print("<td>&nbsp;</td>\n");
						print("<td align=\"center\" colspan=\"2\">Pre-Bundled</td>");
						print("<td align=\"center\" colspan=\"3\">Not Pre-Bundled</td>\n");
						print("</tr>\n");
					}
					
					print("<tr class=\"datatblhdr\">\n");
					if($debug) print("<td>srid</td>\n");
					print("<td>Route</td>\n");
					if($val_PBDEL != "Y" && $val_CSBDL != "Y") {
						print("<td align=\"right\">Quantity</td>\n");
					}
					if($val_PBDEL == "Y" || $val_CSBDL == "Y") {
						print("<td align=\"right\">Quantity</td>\n");
						print("<td align=\"right\">Bundles</td>\n");
						print("<td align=\"right\">Quantity</td>\n");
						print("<td align=\"right\">Bundles</td>\n");
						print("<td align=\"right\">Loose</td>\n");										
					}
					
					if($val_PBDEL != "Y" && $val_CSBDL != "Y") {														
						print("<td align=\"right\">Extra Copies</td>\n");
						print("<td align=\"right\">Bundles</td>\n");
						print("<td align=\"right\">Loose</td>\n");
					}
					print("</tr>\n");
	

					

					$oddEven = 0;
					mysqli_data_seek($rsltGetR,  0);
					$totQty = 0;
					$totBQty = 0;
					$totLooseQty = 0;
					$totExtra = 0;
					$totPreBundQty = 0;
					$totPreBundBQty = 0;
					$totPreBundLostQty = 0;
					while($rowGetR = mysqli_fetch_assoc($rsltGetR)) {
						if( ( $oddEven++ % 2 ) == 0 ) {
							print("<tr class=\"datawhite\">\n");
						}
						else {
							print("<tr class=\"datagrey\">\n");
						}

						// FOR SRID
						$srid = $rowGetR[recid];
						if(!is_numeric($srid)) $srid = 0;
						if($debug) print("<td>$srid</td>\n");

						// FOR ROUTE
						$routeinfo = $rowGetR[routeinfo];
						print("<td>" . htmlentities($routeinfo, ENT_QUOTES) . "</td>\n");

/****					
						// FOR QUANTITY
						$selectStr = "SUM(IF(ta.specificrouteid IS NULL OR ta.specificrouteid = 0 OR ta.specificrouteid = '', ta.actquantity, 0)) qty, SUM( IF( ta.specificrouteid = sr.recid, ta.actquantity, 0)) srqty";
						$fromStr = "transactivity ta, specificroutes sr, specificrouteloc srl";
						$whereStr = "ta.locationid = $ASLocationID
									AND ta.type = 'SD'
									AND ta.specificproductid = $spid
									AND ta.datet = sr.datesked
									AND sr.recid = $srid
									AND sr.dispatchlocid = $ASLocationID
									AND srl.specificrouteid = sr.recid
									AND ta.customerlocid = srl.locationid
									AND srl.clientlocid = $ASLocationID";
****/


						// FOR QUANTITY
						if($val_PBDEL == "Y") {	
						$selectStr = "SUM(IF(((ta.specificrouteid IS NULL OR ta.specificrouteid = 0 
										OR ta.specificrouteid = '') 
										AND rl.prebundle = 'Y'), ta.actquantity, 0)) preBundQty, 
										SUM( IF( ((ta.specificrouteid = sr.recid) AND rl.prebundle = 'Y'),
										ta.actquantity, 0)) preBundSrQty,
										SUM(IF(((ta.specificrouteid IS NULL OR ta.specificrouteid = 0 
										OR ta.specificrouteid = '') 
										AND rl.prebundle = 'N'), ta.actquantity, 0)) qty, 
										SUM( IF((( ta.specificrouteid = sr.recid) 
										AND rl.prebundle = 'N'), ta.actquantity, 0)) srqty,
										sp.bundlecount bundlecount";
 						$fromStr = "transactivity ta, specificroutes sr,specificproduct sp, specificrouteloc srl, routelink rl, location l";
						$whereStr = "ta.locationid = $ASLocationID
									AND ta.customerlocid = l.recid
									AND ((ta.type = 'SD' AND l.type != 'R') OR (ta.type = 'DE' AND l.type = 'R' ))
									AND ta.specificproductid = $spid
									AND sp.recid = ta.specificproductid
									AND ta.datet = sr.datesked
									AND sr.recid = $srid
									AND sr.dispatchlocid = $ASLocationID
									AND srl.specificrouteid = sr.recid
									AND ta.customerlocid = srl.locationid
									AND srl.clientlocid = $ASLocationID
									AND rl.locationid = srl.locationid 
									AND rl.clientid = $ASCompanyID
									GROUP BY ta.specificproductid
									HAVING qty > 0 OR srqty > 0 OR preBundQty > 0 OR preBundSrQty > 0 ";		
//echo $whereStr; exit;													
						}
						else {
						$selectStr = "SUM(IF(ta.specificrouteid IS NULL OR ta.specificrouteid = 0 OR ta.specificrouteid = '', ta.actquantity, 0)) qty, SUM( IF( ta.specificrouteid = sr.recid, ta.actquantity, 0)) srqty, sp.bundlecount ";
						$fromStr = "transactivity ta, specificroutes sr, specificrouteloc srl, specificproduct sp, location l ";
						$whereStr = "ta.locationid = $ASLocationID
									AND ta.customerlocid = l.recid
									AND ((ta.type = 'SD' AND l.type != 'R') OR (ta.type = 'DE' AND l.type = 'R' ))
									AND ta.specificproductid = $spid
									AND sp.recid = ta.specificproductid										
									AND ta.datet = sr.datesked
									AND sr.recid = $srid
									AND sr.dispatchlocid = $ASLocationID
									AND srl.specificrouteid = sr.recid
									AND ta.customerlocid = srl.locationid
									AND srl.clientlocid = $ASLocationID 
									GROUP BY ta.specificproductid";						
						}
						


			
						$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
						unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

						if($rsltArr) {
							$qty = $rsltArr[qty];
							if(!is_numeric($qty))	$qty = 0;

							$srQty = $rsltArr[srqty];
							if(!is_numeric($srQty))	$srQty = 0;
							
							$preBundQty = $rsltArr[preBundQty];
							if(!is_numeric($preBundQty))	$preBundQty = 0;

							$preBundSrQty = $rsltArr[preBundSrQty];
							if(!is_numeric($preBundSrQty))	$preBundSrQty = 0;
							
							$bundle_cnt = $rsltArr[bundlecount];
							if(!is_numeric($bundle_cnt))	$bundle_cnt = "";
							
//							echo "bundlecount $bundlecount <br>";
							
//							echo "$qty<br>$srQty<br>$prebundleqty<br>$prebundsrqty<br>";

						}
						else {
							$qty = 0;
							$srQty = 0;
							$preBundQty = 0;
							$preBundSrQty = 0;
							
						}
				$preBundSrQty1 = 0;
				$totSrQty = 0;
				$mathbundQty = 0;
				$totCSbundQty = 0;
				$totCSQty1 = 0;
				$totNonPBQty = 0;
if($val_CSBDL == "Y") {
	

		$qryCSBDL = " SELECT DISTINCT(ta.customerlocid) custloc, 
						SUM(IF(((ta.specificrouteid IS NULL OR ta.specificrouteid = 0 
						OR ta.specificrouteid = '') 
						AND rl.prebundle = 'Y'), ta.actquantity, 0)) preBundQty, 
						SUM( IF( ((ta.specificrouteid = sr.recid) AND rl.prebundle = 'Y'),
						ta.actquantity, 0)) preBundSrQty,
						SUM(IF(((ta.specificrouteid IS NULL OR ta.specificrouteid = 0 
						OR ta.specificrouteid = '') 
						AND rl.prebundle = 'N'), ta.actquantity, 0)) qty, 
						SUM( IF((( ta.specificrouteid = sr.recid) 
						AND rl.prebundle = 'N'), ta.actquantity, 0)) srqty,
						sp.bundlecount bundlecount
						FROM transactivity ta, specificroutes sr,specificproduct sp,specificrouteloc srl, routelink rl, editioncustomer ec, editionproduct ep, location l
						WHERE ta.locationid = $ASLocationID
						AND ta.customerlocid = l.recid
						AND ((ta.type = 'SD' AND l.type != 'R') OR (ta.type = 'DE' AND l.type = 'R' ))
						AND ta.specificproductid = $spid
						AND sp.recid = ta.specificproductid
						AND ta.datet = sr.datesked
						AND sr.recid = $srid
						AND sr.dispatchlocid = $ASLocationID
						AND srl.specificrouteid = sr.recid
						AND ta.customerlocid = srl.locationid
						AND srl.clientlocid = $ASLocationID
						AND rl.locationid = srl.locationid 
						AND rl.clientid = $ASCompanyID
						AND ec.customerlocid = ta.customerlocid
						AND ec.productid = ep.productid
						AND ec.effdt IN(SELECT MAX(effdt) FROM editioncustomer WHERE customerlocid = ta.customerlocid AND productid = sp.productid )
						AND ep.productid = sp.productid
						AND ep.bundlesystem IS NOT NULL
						GROUP BY ta.customerlocid
						HAVING qty > 0 OR srqty > 0 OR preBundQty > 0 OR preBundSrQty > 0 ";	
	
	$qryCSBDL = convertToSplitTables($qryCSBDL, $val_SPLIT);
	$xqryCSBDL = mysqli_query($cvtconnection, $qryCSBDL);
	while($rsltArr1 = mysqli_fetch_array($xqryCSBDL)) {

				$totQty1 = 0;
				$mathpreBundQty = 0;
				if($rsltArr1) {
				$qty1 = $rsltArr1[qty];
				if(!is_numeric($qty1))	$qty1 = 0;
				if($qty1 > 0) {
					$qty = $qty - $qty1;
				}

				$srQty1 = $rsltArr1[srqty];
				if(!is_numeric($srQty1))	$srQty1 = 0;
				if($srQty1 > 0) {
					$srQty = $srQty - $srQty1;
				}
				
				$preBundQty1 = $rsltArr1[preBundQty];
				if(!is_numeric($preBundQty1))	$preBundQty1 = 0;
				if($preBundQty1 > 0 && $val_PBDEL != "Y") {
					$qty = $qty - $preBundQty1;
				}

				$preBundSrQty1 = $rsltArr1[preBundSrQty];
				if(!is_numeric($preBundSrQty1))	$preBundSrQty1 = 0;
				if($preBundSrQty1 > 0 && $val_PBDEL != "Y") {
					$srQty = $srQty - $preBundSrQty1;					
				}
				$totSrQty = $totSrQty + $preBundSrQty1;
				
				$bundle_cnt = $rsltArr1[bundlecount];
				if(!is_numeric($bundle_cnt))	$bundle_cnt = "";
				
				$totQty1 = $qty1 + $srQty1 + $preBundQty1 + $preBundSrQty1;
				$nonPBQty = $qty1 + $srQty1;
				
				$mathpreBundQty = $totQty1;
				$totCSQty = $totCSQty + $totQty1;
				$totCSQty1 += $totQty1;
				$totNonPBQty += $nonPBQty;
								
				$mathbundQty = 0;
				if($mathpreBundQty <= $maxAmt && $mathpreBundQty > 0) {
					$mathbundQty = "1";
				}
				else {
					while($mathpreBundQty > 0) {
						if($mathpreBundQty > $minAmt) {
							$mathpreBundQty = $mathpreBundQty - $minAmt;
							$mathbundQty = $mathbundQty + 1;
						}
						else {
							$mathpreBundQty = 0;
							$mathbundQty = $mathbundQty + 1;
						}
					
						if($mathpreBundQty <= $diffAmt ) {
							$mathpreBundQty = 0;
						}
					}
				}
				
				$totCSbundQty = $totCSbundQty + $mathbundQty;
			}
			else {
				$qty = 0;
				$srQty = 0;
				$preBundQty = 0;
				$preBundSrQty = 0;
				
			}
							
			}

	
} // if CSBDL

		if($val_PBDEL == "Y") {
				// FOR QUANTITY
				$preBundQty  += $preBundSrQty ;
				if($val_CSBDL == "Y") {
					$preBundQty += $totNonPBQty;
				}
				$totPreBundQty += $preBundQty;
				print("<td align=\"right\">" . ($preBundQty  != "" ? $preBundQty  : "&nbsp;") . "</td>\n");

				// FOR BUNDLES
				//$bundle_cnt = $routeTotArr[$spId][BCNT];

				if($val_CSBDL == "Y") {
					$bundQty = $preBundQty - $totCSQty1 ;
					$bundQty = $bundQty + $totCSbundQty;
				}
				else {
					$bundQty = $preBundQty;
				}
			
				$totPreBundBQty += $bundQty; 
				print("<td align=\"right\">" . ($bundQty != "" ? $bundQty : "&nbsp;") . "</td>\n");

											// FOR LOOSE
//JAY - As per discussion there can not be loose in bundles column
/*				if($bundle_cnt == 0) {
					$perBundLost = "";
				}
				else {
					$perBundLost = ( $preBundQty % $bundle_cnt );
				}
				
				$totPreBundLostQty += $perBundLost;*/
//				print("<td align=\"right\">" . ($perBundLost != "" ? $perBundLost : "&nbsp;") . "</td>\n");
				}
//if($val_PBDEL == "Y")

if($val_CSBDL == "Y" && $val_PBDEL != "Y") {
	$totPreBundQty += $totCSQty1;
	$totPreBundBQty += $totCSbundQty;
	print("<td align=\"right\">" . ($totCSQty1  > 0  ? $totCSQty1  : "&nbsp;") . "</td>\n");
	print("<td align=\"right\">" . ($totCSbundQty > 0 ? $totCSbundQty : "&nbsp;") . "</td>\n");

}//if($val_CSBDL == "Y" && $val_PBDEL != "Y")
				
						// HERE WE WILL FIND THE EXTRA PAPERS (ROUTEDRAWAACCOUNTING.QTYISSUED - ROUTEDRAWACCOUNTING.QTYSKED)
						$qty += $srQty;

						unset($rsltArr);
						print("<td align=\"right\">$qty</td>\n");
						$totQty += $qty;
						
						$qryGetExtra = "SELECT
										SUM(qtyissued) qtyIssued,
										SUM(qtysked) qtySked
										FROM routedrawaccounting
										WHERE clientlocid = $ASLocationID
										AND specificrouteid = $srid
										AND actspecificproductid = $spid";

						// FOR SPLITTING OF TABLES
						$qryGetExtra = convertToSplitTables($qryGetExtra, $val_SPLIT);

						if($debug)
							print($qryGetExtra . "<br />\n");
						$rsltGetExtra = mysqli_query( $cvtconnection, $qryGetExtra);

						if(!$rsltGetExtra) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if(mysqli_num_rows($rsltGetExtra) == 0) {
							}
							else {
								$rowGetExtra = mysqli_fetch_assoc($rsltGetExtra);
								$qtyIssued = $rowGetExtra[qtyIssued];
								$qtySked = $rowGetExtra[qtySked];
								ValidateForInt(false, "qtySked", "qtyIssued");
							}
						}

						$extraQty = $qtyIssued - $qtySked;
						if($val_PBDEL != "Y" && $val_CSBDL != "Y") {
						print("<td align=\"right\">$extraQty</td>\n");
						}
						$totExtra += $extraQty;
						$qty = $qty + $extraQty;
						// FOR EXTRA COPIES


						// FOR BUNDLES
						if($bundle_cnt == 0) {
							$b_qty = "";
						}
						else {
							$b_qty = (int)( $qty / $bundle_cnt );
						}
						print("<td align=\"right\">$b_qty</td>\n");
						$totBQty += $b_qty;

						// FOR LOOSE
						if($bundle_cnt == 0) {
							$lost = "";
						}
						else {
							$lost = ( $qty % $bundle_cnt );
						}
						print("<td align=\"right\">$lost</td>\n");
						$totLooseQty += $lost;

						print("</tr>\n");
					}
					print("<tr class=\"datawhite\">\n");
					if($debug) print("<td>&nbsp;</td>\n");
					print("<td><b>Total</b></td>\n");
					if($val_PBDEL == "Y" || $val_CSBDL == "Y") {
					print("<td align=\"right\"><b>$totPreBundQty</b></td>\n");
					print("<td align=\"right\"><b>$totPreBundBQty</b></td>\n");
//JAY - As per discussion there can not be loose in bundles column
//					print("<td align=\"right\"><b>$totPreBundLostQty</b></td>\n");
					}					
					print("<td align=\"right\"><b>$totQty</b></td>\n");
					if($val_PBDEL != "Y" && $val_CSBDL != "Y") {
					print("<td align=\"right\"><b>$totExtra</b></td>\n");					
					}
					print("<td align=\"right\"><b>$totBQty</b></td>\n");
					print("<td align=\"right\"><b>$totLooseQty</b></td>\n");
					print("</tr>\n");
					print("</table>\n");
					print("<br clear=\"all\" style=\"page-break-after:always\">\n\n");
				}
			}
		}

		print("</div>\n");
		break;

	case "ToSelectRoutes":
		// VALIDATION
		ValidateForInt(false, "pdid", "region");
		print("<div class=\"datawhite\" align=\"center\">\n");
		print("<form name=\"level2Form\" method=\"post\" action=\"tra37.php\" style=\"margin: 0;\">\n");

		// HIDDEN VARS
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"incLoc\" value=\"$incLoc\" />\n");
		print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
		print("<input type=\"hidden\" name=\"region\" value=\"$region\" />\n");

		if($debug) {
			print("noRecs = $norecords<br />\n");
			print("<pre style=\"text-align : left\">");
			print_r($sp_array);
			print("</pre>\n");
		}

		while(list($key, $spId) = each($sp_array)) {
			print("<input type=\"hidden\" name=\"sp_array[" . $key . "]\" value=\"" . $spId . "\" />\n");
		}

		$incFromStr = "";
		$incWhereStr = "";
		if($incLoc == "region") {
			$incFromStr = ", vendingsubgroup vsg ";
			$incWhereStr = " AND vsg.vendinggroupid = $region
							 AND vsg.routeid = sr.routeid ";
		}

		//GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$effdt = "";
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		// HERE WE NEED TO PROVIDE THE ROUTE SELECTION
		$qryGetRoutes = "SELECT DISTINCT r.recid routeId,
						CONCAT_WS(' - ', NULLIF(r.routenbr, ''), NULLIF(r.sdesc, '')) routeDesc
						FROM productdispatch pd, routesetdetail rsd, route r, specificroutes sr " . $incFromStr . "
						WHERE pd.recid = $pdid
						AND rsd.routesetid = pd.routesetid
						AND r.recid = rsd.routeid
						AND r.locationid = $ASLocationID
						AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
						OR r.endeffdt > '$curDate' )
						AND ( rsd.endeffdt IS NULL OR rsd.endeffdt = '0000-00-00'
							OR rsd.endeffdt > '$curDate' )
						AND sr.routeid = r.recid
						AND sr.datesked = '$dbEffDt'
						AND sr.dispatchlocid = $ASLocationID " . $incWhereStr . "
						ORDER BY r.sortseqnbr";

		// FOR SPLITTING OF TABLES
		$qryGetRoutes = convertToSplitTables($qryGetRoutes, $val_SPLIT);

		if($debug)
			print($qryGetRoutes . "<br />\n");
		$rsltGetRoutes = mysqli_query( $cvtconnection, $qryGetRoutes);
		if(!$rsltGetRoutes) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);


		}
		else {
			if(mysqli_num_rows($rsltGetRoutes) == 0) {
				print("<b>No Information Available</b>\n");
			}
			else {
				print("<table border=\"1\" width=\"100%\">\n");
				print("<tr class=\"datatblhdr\">\n");

				print("<td align=\"center\" width=\"10%\"><input id=\"rdChkAll\" type=\"checkbox\" name=\"checkAll\" value=\"checkAll\" onclick=\"checkBoxAll(this.form, this.checked, 'routeIdArr')\" checked=\"checked\" /></td>\n");
				print("<td><label for=\"rdChkAll\">Routes</label></td>\n");
				print("</tr>\n");

				$oddEven = 0;
				$cntId = 0;
				while($rowGetRoutes = mysqli_fetch_assoc($rsltGetRoutes)) {
					if( ( $oddEven++ % 2 ) == 0 ) {
						print("<tr class=\"datawhite\">\n");
					}
					else {
						print("<tr class=\"datagrey\">\n");
					}

					$routeId = $rowGetRoutes[routeId];
					$routeDesc = $rowGetRoutes[routeDesc];
					if(!is_numeric($routeId)) $routeId = 0;

					// FOR SELECTING SINGLE CHECKBOX
					print("<td align=\"center\"><input id=\"rdChkSingle" . $cntId ."\" type=\"checkbox\" name=\"routeIdArr[" . $cntId . "]\" value=\"" . $routeId . "\" onclick=\"checkBoxSingle(this.form, this.checked)\" checked=\"checked\" /></td>\n");

					// FOR ROUTEINFO
					print("<td><label for=\"rdChkSingle" . $cntId ."\">" . ($routeDesc != "" ? htmlentities($routeDesc, ENT_QUOTES) : "&nbsp;") . "</label></td>\n");

					print("</tr>\n");
					$cntId++;
				}
				print("</table>\n");
			}
		}
		// FOR HIDDEN VARS
		print("<input type=\"hidden\" name=\"noRecords\" value=\"$cntId\" />\n");


		print("<br />\n");
		if(mysqli_num_rows($rsltGetRoutes) > 0) //Task#8891
		print("<a href=\"javascript:submitLevelForm(document.level2Form,'$postVal');\">Post</a>\n"); //Task#8891

		print("</form>\n");
		print("</div>\n");
		break;
	//Task#8891 Starts
	case "DrawPrintSheet":
		// VALIDATION
		ValidateForInt(false, "pdid", "region");
		print("<div class=\"datawhite\" align=\"center\">\n");
		print("<form name=\"level2Form\" method=\"post\" action=\"tra37.php\" style=\"margin: 0;\">\n");
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"incLoc\" value=\"$incLoc\" />\n");
		print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
		print("<input type=\"hidden\" name=\"region\" value=\"$region\" />\n");

		$incFromStr = "";
		$incWhereStr = "";
		if($incLoc == "region") {
			$incFromStr = ", vendingsubgroup vsg ";
			$incWhereStr = " AND vsg.vendinggroupid = $region
							 AND vsg.routeid = sr.routeid ";
		}

		if($debug) {
			print("<pre style=\"text-align : left\">");
			print_r($sp_array);
			print("</pre>\n");
		}

		if($debug) {
			print("<pre style=\"text-align : left\">");
			print_r($routeIdArr);
			print("</pre>\n");
		}

		$routeIdStr == "";
		while(list($key, $routeId) = each($routeIdArr)) {
			if(!is_numeric($routeId)) $routeId = 0;

			if($routeIdStr == "") {
				$routeIdStr = $routeId;
			}
			else {
				$routeIdStr .= ", " . $routeId;
			}
		}
		if($routeIdStr == "") {
			$routeIdStr = 0;
		}

		//GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$effdt = "";
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		$flagNoInfo = true;
		
		$routeInfoArr = array();
		$productInfoArr = array();
		$displayArr = array();
		// FIND THE VARIOUS ROUTES
		$qryGetR = "SELECT /*tra37*/ DISTINCT(sr.recid),r.routenbr routeinfo
		            FROM productdispatch pd, routesetdetail rsd, route r, specificroutes sr " . $incFromStr . "
					WHERE pd.recid = $pdid
					AND rsd.routesetid = pd.routesetid
					AND r.recid IN ($routeIdStr)
					AND r.recid = rsd.routeid
					AND r.locationid = $ASLocationID
					AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
					OR r.endeffdt > '$curDate' )
					AND ( rsd.endeffdt IS NULL OR rsd.endeffdt = '0000-00-00'
							OR rsd.endeffdt > '$curDate' )
					AND sr.routeid = r.recid
					AND sr.datesked = '$dbEffDt'
					AND sr.dispatchlocid = $ASLocationID " . $incWhereStr . "
					ORDER BY r.sortseqnbr, routeinfo";

		// FOR SPLITTING OF TABLES
		$qryGetR = convertToSplitTables($qryGetR, $val_SPLIT);

		if($debug)
			print($qryGetR . "<br />\n");
		$rsltGetR = mysqli_query( $cvtconnection, $qryGetR);

		if(!$rsltGetR) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
			print("<br /><br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetR) == 0) {
				print("<b>No Routes Found</b><br /><br />\n");
			}
			else {
				while($rowGetR = mysqli_fetch_assoc($rsltGetR)) {
	
					// FOR srid
					$srid = $rowGetR[recid];
					$routeInfoArr[$srid] = $rowGetR[routeinfo];
					ValidateForInt(false, "srid");

					reset($sp_array);
					$spIdStr = implode(", ", $sp_array);
					if($spIdStr == "") {
						$spIdStr = "0";
					}
                    
					// GETTING THE QTY FOR EACH ROUTE.
					$qryGetRouteQty = " SELECT /*tra37*/ p.recId prodId,p.ldesc,
										SUM( IF( ta.specificrouteid = sr.recid, ta.actquantity, 0)) qty
										FROM transactivity ta, specificroutes sr, specificrouteloc srl,
										specificproduct sp, product p, location l
										WHERE ta.locationid = $ASLocationID
										AND ta.customerlocid = l.recid
										AND ((ta.type = 'SD' AND l.type != 'R') OR (ta.type = 'DE' AND l.type = 'R' ))
										AND ta.specificproductid IN ($spIdStr)
										AND ta.datet = sr.datesked
										AND sr.dispatchlocid = $ASLocationID
										AND sr.recid = $srid
										AND srl.specificrouteid = sr.recid
										AND srl.clientlocid = $ASLocationID
										AND ta.customerlocid = srl.locationid
										AND sp.recid = ta.specificproductid
										AND p.recid = sp.productid
										GROUP BY ta.specificproductid
										HAVING qty > 0
										ORDER BY p.ldesc ";
						
					
					// FOR SPLITTING OF TABLES
					$qryGetRouteQty = convertToSplitTables($qryGetRouteQty, $val_SPLIT);
					if($debug)
						print($qryGetRouteQty . "<br />\n");
					$rsltGetRouteQty = mysqli_query( $cvtconnection, $qryGetRouteQty);

					if(!$rsltGetRouteQty) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
						else {
							if(mysqli_num_rows($rsltGetRouteQty) == 0) {
							}
							else {
								
								$flagNoInfo = false;
								while($rowGetRouteQty = mysqli_fetch_assoc($rsltGetRouteQty)) {
									$qty = $rowGetRouteQty[qty];
									$prodDesc = $rowGetRouteQty[ldesc];
									$prodId = $rowGetRouteQty[prodId];
									$productInfoArr[$prodId] = $prodDesc;
									$displayArr[$srid][$prodId][qty] += $qty;
								}
							}
						}
					
				}
				
				asort($productInfoArr);
				if(count($displayArr) > 0)
				{
				  $dirPath = "/usr/local/twceconf/temp/" . $ASLocationID . "";
                  if (!file_exists($dirPath))
                     mkdir($dirPath);
                  $fileName = "" . $dirPath . "/TRA37_" . date("Y-m-d") . "_" . $RecIdAS . ".csv";
                  $csvObj = new CSV($fileName, 'W');

                  $InfoArray = array();
				  print("<table border=\"1\">\n");
				  print("<tr class=\"datatblhdr\" style=\"font-weight: bold;color: #000000;\">\n");
				  print("<td align=\"right\">Route Number</td>\n");
				  array_push($InfoArray, "Route Number");
				  
				  //publication coulmn
				  while(list($productid, $prodDesc) = each($productInfoArr))
				  {
				     print("<td align=\"right\">$prodDesc</td>\n");
					 array_push($InfoArray, $prodDesc);
				  }
				  print("</tr>\n");
				  $csvObj->AddArray($InfoArray);
                  unset($InfoArray);
				  
				  while(list($srid, $prodArr) = each($displayArr)) 
				  {
					 $InfoArray = array(); 
					 if( ( $oddEven++ % 2 ) == 0 ) {
						print("<tr class=\"datawhite\">\n");
					 }
					 else{
						print("<tr class=\"datagrey\">\n");
					 }
					 //route number
					 $routeinfo = $routeInfoArr[$srid];	
					 print("<td style=\"font-weight: bold\">" . ($routeinfo != "" ? htmlentities($routeinfo, ENT_QUOTES) : "&nbsp;") . "</td>\n");
					 array_push($InfoArray, $routeinfo);
					 
					 reset($productInfoArr); 
					 while(list($prodId, $prodDesc) = each($productInfoArr)) 
					 {	 
				         //qty
					     $qty = $prodArr[$prodId][qty];
                         print("<td align=\"right\">" . ($qty != "" ? $qty : "&nbsp;") . "</td>\n");
						 array_push($InfoArray, $qty);
						
				     }
					 print("</tr>\n");
					 $csvObj->AddArray($InfoArray);
                     unset($InfoArray);
				  }
				  $csvObj->Close();
				  print("</table>\n");
				  
				  print("</br><div class=\"datawhite\" align=\"center\">");
				  print("<a href=\"" . htmlspecialchars("../cm/downloadfile.php?PageNbr=$PassedPageNbr&effdt=$effdt", ENT_QUOTES) . "\">Download CSV File</a>");
				  print("&nbsp;&nbsp;&nbsp;&nbsp;");
				  print("</div>");
				}
		        else {
					 print("<b>No Information Available</b>\n");
				}
		   }
		}
		print("</form>\n");
		print("</div>\n");
		break;
	//Task#8891 Ends
	case "PrintRouteSheet":

		// VALIDATION
		ValidateForInt(false, "pdid", "region");
		print("<div class=\"datawhite\" align=\"center\">\n");
		print("<form name=\"level2Form\" method=\"post\" action=\"tra37.php\" style=\"margin: 0;\">\n");
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"incLoc\" value=\"$incLoc\" />\n");
		print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
		print("<input type=\"hidden\" name=\"region\" value=\"$region\" />\n");

		$incFromStr = "";
		$incWhereStr = "";
		if($incLoc == "region") {
			$incFromStr = ", vendingsubgroup vsg ";
			$incWhereStr = " AND vsg.vendinggroupid = $region
							 AND vsg.routeid = sr.routeid ";
		}

		if($debug) {
			print("<pre style=\"text-align : left\">");
			print_r($sp_array);
			print("</pre>\n");
		}

		if($debug) {
			print("<pre style=\"text-align : left\">");
			print_r($routeIdArr);
			print("</pre>\n");
		}

		$routeIdStr == "";
		while(list($key, $routeId) = each($routeIdArr)) {
			if(!is_numeric($routeId)) $routeId = 0;

			if($routeIdStr == "") {
				$routeIdStr = $routeId;
			}
			else {
				$routeIdStr .= ", " . $routeId;
			}
		}
		if($routeIdStr == "") {
			$routeIdStr = 0;
		}

		$flagDispSlugs = false;
		if(count($sp_array) == $norecords && $val_SLUGR == "Y") {
			$flagDispSlugs = true;
		}

		//GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$effdt = "";
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		$flagNoInfo = true;
		
		if($val_CSBDL == "Y") {

			$qryFormula = "SELECT strvar FROM locationsystem
							WHERE SUBSTRING(recid,1,4) = 'BNDL'
							AND locationid = $ASLocationID ";
			$xqryFormula = mysqli_query($cvtconnection, $qryFormula);
			$fqryFormula = mysqli_fetch_array($xqryFormula);
			$strFormula = $fqryFormula['strvar'];
			$formulaArray = array();
			$formulaArray = explode('~',$strFormula);
			$minAmt = $formulaArray[0];
			$maxAmt = $formulaArray[1];	
			$diffAmt = $maxAmt - $minAmt;	
			
			}

		// FIND THE VARIOUS ROUTES
		$qryGetR = "SELECT DISTINCT(sr.recid),
					CONCAT_WS(' - ', NULLIF(r.routenbr, ''), NULLIF(r.sdesc, ''), TIME_FORMAT(sr.timesked, '%H:%i:%s')) routeinfo,
					sr.driverid
					FROM productdispatch pd, routesetdetail rsd, route r, specificroutes sr " . $incFromStr . "
					WHERE pd.recid = $pdid
					AND rsd.routesetid = pd.routesetid
					AND r.recid IN ($routeIdStr)
					AND r.recid = rsd.routeid
					AND r.locationid = $ASLocationID
					AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
					OR r.endeffdt > '$curDate' )
					AND ( rsd.endeffdt IS NULL OR rsd.endeffdt = '0000-00-00'
							OR rsd.endeffdt > '$curDate' )
					AND sr.routeid = r.recid
					AND sr.datesked = '$dbEffDt'
					AND sr.dispatchlocid = $ASLocationID " . $incWhereStr . "
					ORDER BY r.sortseqnbr, routeinfo";

		// FOR SPLITTING OF TABLES
		$qryGetR = convertToSplitTables($qryGetR, $val_SPLIT);

		if($debug)
			print($qryGetR . "<br />\n");
		$rsltGetR = mysqli_query( $cvtconnection, $qryGetR);

		if(!$rsltGetR) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
			print("<br /><br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetR) == 0) {
				print("<b>No Routes Found</b><br /><br />\n");
			}
			else {
				//print("<br clear=\"all\" style=\"page-break-after:always\">\n");

				// NOW WE HAVE SPIDS IN THE FORM OF SP_ARRAY
				// FETCH THEM AND PRINT A REPORT FOR ALL OF THEM

				while($rowGetR = mysqli_fetch_assoc($rsltGetR)) {
	
					print("<div style=\" page-break-after: always;\"></div>\n");
					// FOR srid
					$srid = $rowGetR[recid];
					$driverid = $rowGetR[driverid];
					$routeinfo = $rowGetR[routeinfo];
					ValidateForInt(false, "srid", "driverid");

					if($driverid != 0) {
						$drivername = GetPer($driverid, $cvtconnection);
						$routeinfo .= " - " . $drivername;
					}

					reset($sp_array);
					$spIdStr = implode(", ", $sp_array);
					if($spIdStr == "") {
						$spIdStr = "0";
					}


					if($val_RDSZP == "Y") {
						$routeTotArr = array();
						$noZipCodeArr = array();
						$zipCodeArr = array();

						if($val_PBDEL == "Y") {
							$qryGetRouteQty = "SELECT ta.specificproductid spid,
												SUM(IF(((ta.specificrouteid IS NULL OR ta.specificrouteid = 0 OR ta.specificrouteid = '') AND rl.prebundle = 'Y'), ta.actquantity, 0)) preBundQty,
												SUM( IF( ((ta.specificrouteid = sr.recid)  AND rl.prebundle = 'Y'), ta.actquantity, 0)) preBundSrQty,

												SUM(IF(((ta.specificrouteid IS NULL OR ta.specificrouteid = 0 OR ta.specificrouteid = '') AND rl.prebundle = 'N'), ta.actquantity, 0)) qty,
												SUM( IF((( ta.specificrouteid = sr.recid) AND rl.prebundle = 'N'), ta.actquantity, 0)) srqty,

												CONCAT_WS(' - ', NULLIF(p.ldesc, ''), DATE_FORMAT(sp.datex, '%m/%d/%y') ) prod_desc, sp.bundlecount, a.postalcode zipCode
												FROM transactivity ta, specificroutes sr, specificrouteloc srl,
												specificproduct sp, product p, routelink rl, location l LEFT JOIN address a ON a.recid = l.addressid
												WHERE ta.locationid = $ASLocationID
												AND ta.customerlocid = l.recid
												AND ((ta.type = 'SD' AND l.type != 'R') OR (ta.type = 'DE' AND l.type = 'R' ))
												AND ta.specificproductid IN ($spIdStr)
												AND ta.datet = sr.datesked
												AND sr.dispatchlocid = $ASLocationID
												AND sr.recid = $srid
												AND srl.specificrouteid = sr.recid
												AND srl.clientlocid = $ASLocationID
												AND ta.customerlocid = srl.locationid
												AND rl.locationid = srl.locationid
												AND rl.clientid = $ASCompanyID
												AND srl.locationid = l.recid
												AND sp.recid = ta.specificproductid
												AND p.recid = sp.productid
												GROUP BY a.postalcode, ta.specificproductid
												HAVING qty > 0 OR srqty > 0
												OR preBundQty > 0 OR preBundSrQty > 0
												ORDER BY a.postalcode, prod_desc";
						}
						else {
							// GETTING THE QTY FOR EACH ROUTE.
							$qryGetRouteQty = "SELECT ta.specificproductid spid,
												SUM(IF(ta.specificrouteid IS NULL OR ta.specificrouteid = 0 OR ta.specificrouteid = '', ta.actquantity, 0)) qty,
												SUM( IF( ta.specificrouteid = sr.recid, ta.actquantity, 0)) srqty,
												CONCAT_WS(' - ', NULLIF(p.ldesc, ''), DATE_FORMAT(sp.datex, '%m/%d/%y') ) prod_desc, sp.bundlecount, a.postalcode zipCode
												FROM transactivity ta, specificroutes sr, specificrouteloc srl,
												specificproduct sp, product p, location l
												LEFT JOIN address a ON a.recid = l.addressid
												WHERE ta.locationid = $ASLocationID
												AND ta.customerlocid = l.recid
												AND ((ta.type = 'SD' AND l.type != 'R') OR (ta.type = 'DE' AND l.type = 'R' ))
												AND ta.specificproductid IN ($spIdStr)
												AND ta.datet = sr.datesked
												AND sr.dispatchlocid = $ASLocationID
												AND sr.recid = $srid
												AND srl.specificrouteid = sr.recid
												AND srl.clientlocid = $ASLocationID
												AND ta.customerlocid = srl.locationid
												AND srl.locationid = l.recid
												AND sp.recid = ta.specificproductid
												AND p.recid = sp.productid
												GROUP BY a.postalcode, ta.specificproductid
												HAVING qty > 0 OR srqty > 0
												ORDER BY a.postalcode, prod_desc";
						}

						// FOR SPLITTING OF TABLES
						$qryGetRouteQty = convertToSplitTables($qryGetRouteQty, $val_SPLIT);

						if($debug)
							print($qryGetRouteQty . "<br />\n");
						$rsltGetRouteQty = mysqli_query( $cvtconnection, $qryGetRouteQty);

						if(!$rsltGetRouteQty) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if(mysqli_num_rows($rsltGetRouteQty) == 0) {
							}
							else {

								$flagNoInfo = false;
								// NOW FINDING SLUGS IF FLAGDISPSLUGS = TRUE
								$slugsStr = "";
								if($flagDispSlugs) {

									$qryGetSlugs = "SELECT SUM(vll.slugsperday) slugsRequired
													FROM transactivity ta, location l, vendinglocationlink vll,
													specificroutes sr, specificrouteloc srl
													WHERE ta.locationid = $ASLocationID
													AND ta.type = 'SD'
													AND ta.specificproductid IN ($spIdStr)
													AND ta.datet = sr.datesked
													AND sr.dispatchlocid = $ASLocationID
													AND sr.recid = $srid
													AND srl.specificrouteid = sr.recid
													AND srl.clientlocid = $ASLocationID
													AND ta.customerlocid = srl.locationid
													AND l.recid = ta.customerlocid
													AND l.type = 'M'
													AND vll.locationid = l.recid";

									// FOR SPLITTING OF TABLES
									$qryGetSlugs = convertToSplitTables($qryGetSlugs, $val_SPLIT);

									if($debug)
										print($qryGetSlugs . "<br />\n");
									$rsltGetSlugs = mysqli_query( $cvtconnection, $qryGetSlugs);

									if(!$rsltGetSlugs) {
										$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
										print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
										unset($fileLineNbr);
									}
									else {
										if(mysqli_num_rows($rsltGetSlugs) == 0) {
											$slugsRequired = 0;
										}
										else {
											$rowGetSlugs = mysqli_fetch_assoc($rsltGetSlugs);
											$slugsRequired = $rowGetSlugs[slugsRequired];
											if(!is_numeric($slugsRequired))	$slugsRequired = 0;
										}
									}
									$slugsStr = " - Slugs Required: " . $slugsRequired;
								}
								while($rowGetRouteQty = mysqli_fetch_assoc($rsltGetRouteQty)) {

									$spId = $rowGetRouteQty[spid];
									if(!is_numeric($spId))	$spId = 0;

									$zipCode = $rowGetRouteQty[zipCode];

									// FOR SPID
									//if($debug) print("<td>$spId</td>");

									if(!is_array($routeTotArr[$spId])) {
										$routeTotArr[$spId] = array();
									}

									if(!is_array($zipCodeArr[$zipCode][$spId]) && strlen(trim($zipCode)) > 0 ) {
										$zipCodeArr[$zipCode][$spId] = array();
									}

									if(!is_array($noZipCodeArr[$spId]) && ($zipCode == "" || $zipCode == 0 || $zipCode == NULL)) {
										$noZipCodeArr[$spId] = array();
									}


if($val_PBDEL == "Y") {
		// FOR QUANTITY
		$preBundQty  = $rowGetRouteQty[preBundQty];
		if(!is_numeric($preBundQty ))	$preBundQty  = 0;

		$routeTotArr[$spId][PREBQTY] += $preBundQty;
		if($zipCode == "" || $zipCode == 0) {
			$noZipCodeArr[$spId][PREBQTY] += $preBundQty;
		}
		else {
			$zipCodeArr[$zipCode][$spId][PREBQTY] += $preBundQty;
		}

		$preBundSrQty  = $rowGetRouteQty[preBundSrQty];
		if(!is_numeric($preBundSrQty ))	$preBundSrQty  = 0;

		$routeTotArr[$spId][PREBSRQTY] += $preBundSrQty;
		if($zipCode == "" || $zipCode == 0) {
			$noZipCodeArr[$spId][PREBSRQTY] += $preBundSrQty;
		}
		else {
			$zipCodeArr[$zipCode][$spId][PREBSRQTY] += $preBundSrQty;
		}
		$preBundQty  += $preBundSrQty ;
}

		// FOR QUANTITY FOR NON-PREBUNDLE
		$qty = $rowGetRouteQty[qty];
		if(!is_numeric($qty))	$qty = 0;
		$routeTotArr[$spId][QTY] += $qty;
		if($zipCode == "" || $zipCode == 0) {
			$noZipCodeArr[$spId][QTY] += $qty;
		}
		else {
			$zipCodeArr[$zipCode][$spId][QTY] += $qty;
		}

		$srQty = $rowGetRouteQty[srqty];
		if(!is_numeric($srQty))	$srQty = 0;
		$routeTotArr[$spId][SRQTY] += $srQty;
		if($zipCode == "" || $zipCode == 0) {
			$noZipCodeArr[$spId][SRQTY] += $srQty;
		}
		else {
			$zipCodeArr[$zipCode][$spId][SRQTY] += $srQty;
		}

$preBundSrQty1 = 0;
$totSrQty = 0;
$mathbundQty = 0;
$totCSbundQty = 0;
$totCSQty1 = 0;
$totNonPBQty = 0;
if($val_CSBDL == "Y") {
		$qryCSBDL = " SELECT DISTINCT(ta.customerlocid) custloc, 
						SUM(IF(((ta.specificrouteid IS NULL OR ta.specificrouteid = 0 
						OR ta.specificrouteid = '') 
						AND rl.prebundle = 'Y'), ta.actquantity, 0)) preBundQty, 
						SUM( IF( ((ta.specificrouteid = sr.recid) AND rl.prebundle = 'Y'),
						ta.actquantity, 0)) preBundSrQty,
						SUM(IF(((ta.specificrouteid IS NULL OR ta.specificrouteid = 0 
						OR ta.specificrouteid = '') 
						AND rl.prebundle = 'N'), ta.actquantity, 0)) qty, 
						SUM( IF((( ta.specificrouteid = sr.recid) 
						AND rl.prebundle = 'N'), ta.actquantity, 0)) srqty,
						sp.bundlecount bundlecount
						FROM transactivity ta, specificroutes sr,specificproduct sp,specificrouteloc srl, routelink rl, editioncustomer ec, editionproduct ep, location l
						WHERE ta.locationid = $ASLocationID
						AND ta.customerlocid = l.recid
						AND ((ta.type = 'SD' AND l.type != 'R') OR (ta.type = 'DE' AND l.type = 'R' ))
						AND ta.specificproductid = $spid
						AND sp.recid = ta.specificproductid
						AND ta.datet = sr.datesked
						AND sr.recid = $srid
						AND sr.dispatchlocid = $ASLocationID
						AND srl.specificrouteid = sr.recid
						AND ta.customerlocid = srl.locationid
						AND srl.clientlocid = $ASLocationID
						AND rl.locationid = srl.locationid 
						AND rl.clientid = $ASCompanyID
						AND ec.customerlocid = ta.customerlocid
						AND ec.productid = ep.productid
						AND ec.effdt IN(SELECT MAX(effdt) FROM editioncustomer WHERE customerlocid = ta.customerlocid AND productid = sp.productid )
						AND ep.productid = sp.productid
						AND ep.bundlesystem IS NOT NULL
						GROUP BY ta.customerlocid
						HAVING qty > 0 OR srqty > 0 OR preBundQty > 0 OR preBundSrQty > 0 ";	
	
	$qryCSBDL = convertToSplitTables($qryCSBDL, $val_SPLIT);
	$xqryCSBDL = mysqli_query($cvtconnection, $qryCSBDL);
	while($rsltArr1 = mysqli_fetch_array($xqryCSBDL)) {

				$totQty1 = 0;
				$mathpreBundQty = 0;
				if($rsltArr1) {
				$qty1 = $rsltArr1[qty];
				if(!is_numeric($qty1))	$qty1 = 0;
				if($qty1 > 0) {
					$qty = $qty - $qty1;
				}

				$srQty1 = $rsltArr1[srqty];
				if(!is_numeric($srQty1))	$srQty1 = 0;
				if($srQty1 > 0) {
					$srQty = $srQty - $srQty1;
				}
				
				$preBundQty1 = $rsltArr1[preBundQty];
				if(!is_numeric($preBundQty1))	$preBundQty1 = 0;
				if($preBundQty1 > 0 && $val_PBDEL != "Y") {
					$qty = $qty - $preBundQty1;
				}

				$preBundSrQty1 = $rsltArr1[preBundSrQty];
				if(!is_numeric($preBundSrQty1))	$preBundSrQty1 = 0;
				if($preBundSrQty1 > 0 && $val_PBDEL != "Y") {
					$srQty = $srQty - $preBundSrQty1;					
				}
				$totSrQty = $totSrQty + $preBundSrQty1;
				
				$bundle_cnt = $rsltArr1[bundlecount];
				if(!is_numeric($bundle_cnt))	$bundle_cnt = "";
				
				$totQty1 = $qty1 + $srQty1 + $preBundQty1 + $preBundSrQty1;
				$nonPBQty = $qty1 + $srQty1;
				
				$mathpreBundQty = $totQty1;
				$totCSQty = $totCSQty + $totQty1;
				$totCSQty1 += $totQty1;
				$totNonPBQty += $nonPBQty;
								
				$mathbundQty = 0;
				if($mathpreBundQty <= $maxAmt && $mathpreBundQty > 0) {
					$mathbundQty = "1";
				}
				else {
					while($mathpreBundQty > 0) {
						if($mathpreBundQty > $minAmt) {
							$mathpreBundQty = $mathpreBundQty - $minAmt;
							$mathbundQty = $mathbundQty + 1;
						}
						else {
							$mathpreBundQty = 0;
							$mathbundQty = $mathbundQty + 1;
						}



					
						if($mathpreBundQty <= $diffAmt ) {
							$mathpreBundQty = 0;
						}
					}
				}
				
				$totCSbundQty = $totCSbundQty + $mathbundQty;
			}
			else {
				$qty = 0;
				$srQty = 0;
				$preBundQty = 0;
				$preBundSrQty = 0;
				
			}
							
			}

}//if($val_CSBDL == "Y") {

if($val_CSBDL == "Y" && $val_PBDEL != "Y") {
	$totPreBundQty += $totCSQty1;
	$totPreBundBQty += $totCSbundQty;
	print("<td align=\"right\">" . ($totCSQty1  > 0  ? $totCSQty1  : "&nbsp;") . "</td>\n");
	print("<td align=\"right\">" . ($totCSbundQty > 0 ? $totCSbundQty : "&nbsp;") . "</td>\n");

}//if($val_CSBDL == "Y" && $val_PBDEL != "Y")


									// FOR PRODCUT DESCRIPTION
									$prodDesc = $rowGetRouteQty[prod_desc];
									$routeTotArr[$spId][PROD] = $prodDesc;
									if($zipCode == "" || $zipCode == 0) {
										$noZipCodeArr[$spId][PROD] = $prodDesc;
									}
									else {
										$zipCodeArr[$zipCode][$spId][PROD] = $prodDesc;
									}

									if($val_PBDEL == "Y") {

										if($val_CSBDL == "Y") {
											$preBundQty += $totNonPBQty;
										}

										// FOR BUNDLES
										$bundle_cnt = $rowGetRouteQty[bundlecount];

										$routeTotArr[$spId][BCNT] = $bundle_cnt;

										if($zipCode == "" || $zipCode == 0) {
											$noZipCodeArr[$spId][BCNT] = $bundle_cnt;
										}
										else {
											$zipCodeArr[$zipCode][$spId][BCNT] = $bundle_cnt;
										}

										if($val_CSBDL == "Y") {
											$bundQty = $preBundQty - $totCSQty1 ;
											$bundQty = $bundQty + $totCSbundQty;
										}
										else {
											$bundQty = $preBundQty;
										}


/*										if($bundle_cnt == 0) {
											$bundQty = "";
										}
										else {
											$bundQty = (int)( $preBundQty / $bundle_cnt );
										}
*/
										// FOR LOOSE
										if($bundle_cnt == 0) {
											$perBundLost = "";
										}
										else {
											$perBundLost = ( $preBundQty % $bundle_cnt );
										}
									}


									$qty += $srQty;

									// FOR BUNDLES
									$bundle_cnt = $rowGetRouteQty[bundlecount];

									$routeTotArr[$spId][BCNT] = $bundle_cnt;
									if($zipCode == "" || $zipCode == 0) {
										$noZipCodeArr[$spId][BCNT] = $bundle_cnt;
									}
									else {
										$zipCodeArr[$zipCode][$spId][BCNT] = $bundle_cnt;
									}

									if($bundle_cnt == 0) {
										$b_qty = "";
									}
									else {
										$b_qty = (int)( $qty / $bundle_cnt );
									}

									// FOR loose
									if($bundle_cnt == 0) {
										$lost = "";
									}
									else {
										$lost = ( $qty % $bundle_cnt );
									}
								}

								sort($routeTotArr);

								$rowCnt = 0;
								$pageCnt = 0;
								if(count($routeTotArr) > 0) {
									print("<b><u>" . htmlentities($routeinfo, ENT_QUOTES) . $slugsStr . "</u></b><br /><br />\n");

									print("<table border=\"1\" width=\"100%\">\n");

									if($val_PBDEL == "Y" || $val_CSBDL == "Y") {
										print("<tr class=\"datatblhdr\">\n");
										if($debug) print("<td>&nbsp;</td>");
										print("<td>&nbsp;</td>\n");

										print("<td align=\"center\" colspan=\"2\">Pre-Bundled</td>");
										print("<td align=\"center\" colspan=\"3\">Not Pre-Bundled</td>\n");
										print("</tr>\n");
										$rowCnt++;
									}

									print("<tr class=\"datatblhdr\">\n");
									if($debug) print("<td>spid</td>");
									print("<td>Publication</td>\n");

									if($val_PBDEL == "Y" || $val_CSBDL == "Y") {
										print("<td align=\"right\">Quantity</td>\n");
										print("<td align=\"right\">Bundles</td>\n");
//										print("<td align=\"right\">Loose</td>\n");
									}

									print("<td align=\"right\">Quantity</td>\n");
									if($val_PBDEL != 'Y' && $val_CSBDL != 'Y') print("<td align=\"right\">Extra Copies</td>\n");
									print("<td align=\"right\">Bundles</td>\n");
									print("<td align=\"right\">Loose</td>\n");

									print("</tr>\n");

									$rowCnt++;
									$oddEven = 0;
									while(list($spId, $value) = each($routeTotArr)) {
										if( ( $oddEven++ % 2 ) == 0 ) {
											print("<tr class=\"datawhite\">\n");
										}
										else {
											print("<tr class=\"datagrey\">\n");
										}

										// FOR SPID
										if($debug)
											print("<td>$spId</td>");

										// FOR PRODCUT DESCRIPTION
										$prodDesc = $routeTotArr[$spId][PROD];
										print("<td>" . ($prodDesc != "" ? htmlentities($prodDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");

										if($val_PBDEL == "Y") {
											// FOR QUANTITY
											$preBundQty  = $routeTotArr[$spId][PREBQTY];
											if(!is_numeric($preBundQty ))	$preBundQty  = 0;

											$preBundSrQty  = $routeTotArr[$spId][PREBSRQTY];
											if(!is_numeric($preBundSrQty ))	$preBundSrQty  = 0;
											$preBundQty  += $preBundSrQty ;
											
											if($val_CSBDL == "Y") {
												$preBundQty += $totNonPBQty;
											}

											print("<td align=\"right\">" . ($preBundQty  != "" ? $preBundQty  : "&nbsp;") . "</td>\n");

											// FOR BUNDLES
											$bundle_cnt = $routeTotArr[$spId][BCNT];

											if($val_CSBDL == "Y") {
												$bundQty = $preBundQty - $totCSQty1 ;
												$bundQty = $bundQty + $totCSbundQty;
											}
											else {
												$bundQty = $preBundQty;
											}


/*											if($bundle_cnt == 0) {
												$bundQty = "";
											}
											else {
												$bundQty = (int)( $preBundQty / $bundle_cnt );
											}*/

											print("<td align=\"right\">" . ($bundQty != "" ? $bundQty : "&nbsp;") . "</td>\n");

//JAY - Loose Column Removed
											// FOR LOOSE
/*											if($bundle_cnt == 0) {
												$perBundLost = "";
											}
											else {
												$perBundLost = ( $preBundQty % $bundle_cnt );
											}

											print("<td align=\"right\">" . ($perBundLost != "" ? $perBundLost : "&nbsp;") . "</td>\n");
*/
										}

										// FOR QUANTITY
										$qty = $routeTotArr[$spId][QTY];
										if(!is_numeric($qty))	$qty = 0;

										$srQty = $routeTotArr[$spId][SRQTY];
										if(!is_numeric($srQty))	$srQty = 0;

										$qty += $srQty;

										print("<td align=\"right\">" . ($qty != "" ? $qty : "&nbsp;") . "</td>\n");

										if($val_PBDEL != 'Y') {
											// HERE LETS FIND THE EXTRA PAPERS (IT IS FROM ROUTEDRAWepCCOUNTING)

											$qryGetExtra = "SELECT
															SUM(qtyissued) qtyIssued,
															SUM(qtysked) qtySked
															FROM routedrawaccounting
															WHERE clientlocid = $ASLocationID
															AND specificrouteid = $srid
															AND actspecificproductid = $spId";

											// FOR SPLITTING OF TABLES
											$qryGetExtra = convertToSplitTables($qryGetExtra, $val_SPLIT);
											if($debug)
												print($qryGetExtra . "<br />\n");
											$rsltGetExtra = mysqli_query( $cvtconnection, $qryGetExtra);

											if(!$rsltGetExtra) {
												$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
												print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
												unset($fileLineNbr);
											}
											else {
												if(mysqli_num_rows($rsltGetExtra) == 0) {
												}
												else {
													$rowGetExtra = mysqli_fetch_assoc($rsltGetExtra);
													$qtyIssued = $rowGetExtra[qtyIssued];
													$qtySked = $rowGetExtra[qtySked];
													ValidateForInt(false, "qtySked", "qtyIssued");
												}
											}

											$extraQty = $qtyIssued - $qtySked;
											$qty = $qty + $extraQty;
											// FOR EXTRA COPIES
											 print("<td align=\"right\">$extraQty</td>\n");
										}

										// FOR BUNDLES
										$bundle_cnt = $routeTotArr[$spId][BCNT];

										if($bundle_cnt == 0) {
											$b_qty = "";
										}
										else {
											$b_qty = (int)( $qty / $bundle_cnt );
										}
										print("<td align=\"right\">" . ($b_qty != "" ? $b_qty : "&nbsp;") . "</td>\n");

										// FOR LOOSE
										if($bundle_cnt == 0) {
											$lost = "";
										}
										else {
											$lost = ( $qty % $bundle_cnt );
										}
										print("<td align=\"right\">" . ($lost != "" ? $lost : "&nbsp;") . "</td>\n");

										print("</tr>\n");
										$rowCnt++;
									}
									print("</table>\n");
								}
								print("<br />\n");

								if($rowCnt >= $val_TRA37) {
									print("<br clear=\"all\" style=\"page-break-after:always\">\n");
									$rowCnt = 0;
								}
								$htmlStr = "";
								if(count($zipCodeArr) > 0) {

									while(list($zipCode, $spIdArr) = each($zipCodeArr)) {

										$htmlStr .= ("<b>Zip Code " . htmlentities($zipCode, ENT_QUOTES) . "</b><br /><br />\n");
										$rowCnt+= 3;

										$htmlStr .= ("<table border=\"1\" width=\"100%\">\n");

										if($val_PBDEL == "Y" || $val_CSBDL == "Y") {
											$htmlStr .= ("<tr class=\"datatblhdr\">\n");
											if($debug) $htmlStr .= ("<td>&nbsp;</td>\n");
											$htmlStr .= ("<td>&nbsp;</td>\n");

											$htmlStr .= ("<td align=\"center\" colspan=\"2\">Pre-Bundled</td>\n");
											$htmlStr .= ("<td align=\"center\" colspan=\"3\">Not Pre-Bundled</td>\n");
											$htmlStr .= ("</tr>\n");
											$rowCnt++;
										}

										$htmlStr .= ("<tr class=\"datatblhdr\">\n");
										if($debug) $htmlStr .= ("<td>spid</td>\n");
										$htmlStr .= ("<td>Publication</td>\n");

										if($val_PBDEL == "Y" || $val_CSBDL == "Y") {
											$htmlStr .= ("<td align=\"right\">Quantity</td>\n");
											$htmlStr .= ("<td align=\"right\">Bundles</td>\n");
											$htmlStr .= ("<td align=\"right\">Loose</td>\n");
										}

										$htmlStr .= ("<td align=\"right\">Quantity</td>\n");
										$htmlStr .= ("<td align=\"right\">Bundles</td>\n");
										$htmlStr .= ("<td align=\"right\">Loose</td>\n");


										$htmlStr .= ("</tr>\n");
										$rowCnt++;
										$oddEven = 0;
										while(list($spId, $value) = each($spIdArr)) {
											if( ( $oddEven++ % 2 ) == 0 ) {
												$htmlStr .= ("<tr class=\"datawhite\">");
											}
											else {
												$htmlStr .= ("<tr class=\"datagrey\">");
											}

											// FOR SPID
											if($debug) $htmlStr .= ("<td>$spId</td>\n");

											// FOR PRODCUT DESCRIPTION
											$prodDesc = $spIdArr[$spId][PROD];
											$htmlStr .= ("<td>" . ($prodDesc != "" ? htmlentities($prodDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");

											if($val_PBDEL == "Y" || $val_CSBDL == "Y") {
												// FOR QUANTITY
												$preBundQty  = $spIdArr[$spId][PREBQTY];
												if(!is_numeric($preBundQty ))	$preBundQty  = 0;

												$preBundSrQty  = $spIdArr[$spId][PREBSRQTY];
												if(!is_numeric($preBundSrQty ))	$preBundSrQty  = 0;
												$preBundQty  += $preBundSrQty ;
												
												if($val_CSBDL == "Y") {
													$preBundQty += $totNonPBQty;
												}

												$htmlStr .= ("<td align=\"right\">" . ($preBundQty  != "" ? $preBundQty  : "&nbsp;") . "</td>\n");

												// FOR BUNDLES
												$bundle_cnt = $spIdArr[$spId][BCNT];

/*												if($bundle_cnt == 0) {
													$bundQty = "";
												}
												else {
													$bundQty = (int)( $preBundQty / $bundle_cnt );
												}*/
												
												if($val_CSBDL == "Y") {
													$bundQty = $preBundQty - $totCSQty1 ;
													$bundQty = $bundQty + $totCSbundQty;
												}
												else {
													$bundQty = $preBundQty;
												}

												$htmlStr .= ("<td align=\"right\">" . ($bundQty != "" ? $bundQty : "&nbsp;") . "</td>\n");

												// FOR LOOSE
												if($bundle_cnt == 0) {
													$perBundLost = "";
												}
												else {
													$perBundLost = ( $preBundQty % $bundle_cnt );
												}

//												$htmlStr .= ("<td align=\"right\">" . ($perBundLost != "" ? $perBundLost : "&nbsp;") . "</td>\n");

											}

											// FOR QUANTITY
											$qty = $spIdArr[$spId][QTY];
											if(!is_numeric($qty))	$qty = 0;

											$srQty = $spIdArr[$spId][SRQTY];
											if(!is_numeric($srQty))	$srQty = 0;

											$qty += $srQty;

											$htmlStr .= ("<td align=\"right\">" . ($qty != "" ? $qty : "&nbsp;") . "</td>\n");

											// FOR BUNDLES
											$bundle_cnt = $spIdArr[$spId][BCNT];

											if($bundle_cnt == 0) {
												$b_qty = "";
											}
											else {
												$b_qty = (int)( $qty / $bundle_cnt );
											}
											$htmlStr .= ("<td align=\"right\">" . ($b_qty != "" ? $b_qty : "&nbsp;") . "</td>\n");

											// FOR LOOSE
											if($bundle_cnt == 0) {
												$lost = "";
											}
											else {
												$lost = ( $qty % $bundle_cnt );
											}
											$htmlStr .= ("<td align=\"right\">" . ($lost != "" ? $lost : "&nbsp;") . "</td>\n");

											$htmlStr .= ("</tr>\n");
											$rowCnt++;
										}
										$htmlStr .= ("</table>\n");
										$htmlStr .= ("<br />\n");
										$rowCnt++;
										if($rowCnt >= $val_TRA37) {
											print("<br clear=\"all\" style=\"page-break-after:always\">\n");
											$rowCnt = $rowCnt - $val_TRA37;
										}
										print("$htmlStr");
										$htmlStr = "";
									}
								}

								if(count($noZipCodeArr) > 0) {
									$htmlStr = "";
									$htmlStr .= ("<b>Zip Code None</b><br /><br />");
									$rowCnt+= 2;
									$htmlStr .= ("<table border=\"1\" width=\"100%\">\n");

									if($val_PBDEL == "Y" || $val_CSBDL == "Y") {
										$htmlStr .= ("<tr class=\"datatblhdr\">");
										if($debug) $htmlStr .= ("<td>&nbsp;</td>\n");
										$htmlStr .= ("<td>&nbsp;</td>\n");

										$htmlStr .= ("<td align=\"center\" colspan=\"2\">Pre-Bundled</td>\n");
										$htmlStr .= ("<td align=\"center\" colspan=\"3\">Not Pre-Bundled</td>\n");
										$htmlStr .= ("</tr>\n");
										$rowCnt++;
									}

									$htmlStr .= ("<tr class=\"datatblhdr\">\n");
									if($debug) $htmlStr .= ("<td>spid</td>\n");
									$htmlStr .= ("<td>Publication</td>\n");

									if($val_PBDEL == "Y" || $val_CSBDL == "Y") {
										$htmlStr .= ("<td align=\"right\">Quantity</td>\n");
										$htmlStr .= ("<td align=\"right\">Bundles</td>\n");
										$htmlStr .= ("<td align=\"right\">Loose</td>\n");
									}

									$htmlStr .= ("<td align=\"right\">Quantity</td>\n");
									$htmlStr .= ("<td align=\"right\">Bundles</td>\n");
									$htmlStr .= ("<td align=\"right\">Loose</td>\n");

									$htmlStr .= ("</tr>\n");
									$rowCnt++;
									$oddEven = 0;
									while(list($spId, $value) = each($noZipCodeArr)) {
										if( ( $oddEven++ % 2 ) == 0 ) {
											$htmlStr .= ("<tr class=\"datawhite\">");
										}
										else {
											$htmlStr .= ("<tr class=\"datagrey\">");
										}

										// FOR SPID
										if($debug) $htmlStr .= ("<td>$spId</td>\n");

										// FOR PRODCUT DESCRIPTION
										$prodDesc = $noZipCodeArr[$spId][PROD];
										$htmlStr .= ("<td>" . ($prodDesc != "" ? htmlentities($prodDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");

										if($val_PBDEL == "Y" || $val_CSBDL == "Y") {
											// FOR QUANTITY
											$preBundQty  = $noZipCodeArr[$spId][PREBQTY];
											if(!is_numeric($preBundQty ))	$preBundQty  = 0;

											$preBundSrQty  = $noZipCodeArr[$spId][PREBSRQTY];
											if(!is_numeric($preBundSrQty ))	$preBundSrQty  = 0;
											$preBundQty  += $preBundSrQty ;
											if($val_CSBDL == "Y") {
												$preBundQty += $totNonPBQty;
											}

											$htmlStr .= ("<td align=\"right\">" . ($preBundQty  != "" ? $preBundQty  : "&nbsp;") . "</td>");

											// FOR BUNDLES
											$bundle_cnt = $noZipCodeArr[$spId][BCNT];

/*											if($bundle_cnt == 0) {
												$bundQty = "";
											}
											else {
												$bundQty = (int)( $preBundQty / $bundle_cnt );
											}*/
											if($val_CSBDL == "Y") {
												$bundQty = $preBundQty - $totCSQty1 ;
												$bundQty = $bundQty + $totCSbundQty;
											}
											else {
												$bundQty = $preBundQty;
											}

											$htmlStr .= ("<td align=\"right\">" . ($bundQty != "" ? $bundQty : "&nbsp;") . "</td>\n");

											// FOR LOOSE
											if($bundle_cnt == 0) {
												$perBundLost = "";
											}
											else {
												$perBundLost = ( $preBundQty % $bundle_cnt );
											}

//											$htmlStr .= ("<td align=\"right\">" . ($perBundLost != "" ? $perBundLost : "&nbsp;") . "</td>\n");

										}

										// FOR QUANTITY
										$qty = $noZipCodeArr[$spId][QTY];

										if(!is_numeric($qty))	$qty = 0;

										$srQty = $noZipCodeArr[$spId][SRQTY];
										if(!is_numeric($srQty))	$srQty = 0;

										$qty += $srQty;

										$htmlStr .= ("<td align=\"right\">" . ($qty != "" ? $qty : "&nbsp;") . "</td>\n");

										// FOR BUNDLES
										$bundle_cnt = $noZipCodeArr[$spId][BCNT];

										if($bundle_cnt == 0) {

											$b_qty = "";
										}
										else {
											$b_qty = (int)( $qty / $bundle_cnt );
										}
										$htmlStr .= ("<td align=\"right\">" . ($b_qty != "" ? $b_qty : "&nbsp;") . "</td>\n");

										// FOR LOOSE
										if($bundle_cnt == 0) {
											$lost = "";
										}
										else {
											$lost = ( $qty % $bundle_cnt );
										}
										$htmlStr .= ("<td align=\"right\">" . ($lost != "" ? $lost : "&nbsp;") . "</td>\n");

										$htmlStr .= ("</tr>\n");
										$rowCnt++;
									}
									$htmlStr .= ("</table>\n");
									$htmlStr .= ("<br />");
									if($rowCnt >= $val_TRA37) {
										print("<br clear=\"all\" style=\"page-break-after:always\">\n");
										$rowCnt = $rowCnt - $val_TRA37;
									}
									print("$htmlStr");
									$htmlStr = "";

								}

								print("<br clear=\"all\" style=\"page-break-after:always\">\n");
							}
						}
					}
					else {

						if($val_PBDEL == "Y") {
							$qryGetRouteQty = "SELECT ta.specificproductid spid,
												SUM(IF(((ta.specificrouteid IS NULL OR ta.specificrouteid = 0 OR ta.specificrouteid = '') AND rl.prebundle = 'Y'), ta.actquantity, 0)) preBundQty,
												SUM( IF( ((ta.specificrouteid = sr.recid)  AND rl.prebundle = 'Y'), ta.actquantity, 0)) preBundSrQty,

												SUM(IF(((ta.specificrouteid IS NULL OR ta.specificrouteid = 0 OR ta.specificrouteid = '') AND rl.prebundle = 'N'), ta.actquantity, 0)) qty,
												SUM( IF((( ta.specificrouteid = sr.recid) AND rl.prebundle = 'N'), ta.actquantity, 0)) srqty,

												CONCAT_WS(' - ', NULLIF(p.ldesc, ''), DATE_FORMAT(sp.datex, '%m/%d/%y') ) prod_desc, sp.bundlecount
												FROM transactivity ta, specificroutes sr, specificrouteloc srl,
												specificproduct sp, product p, routelink rl, location l
												WHERE ta.locationid = $ASLocationID
												AND ta.customerlocid = l.recid
												AND ((ta.type = 'SD' AND l.type != 'R') OR (ta.type = 'DE' AND l.type = 'R' ))
												AND ta.specificproductid IN ($spIdStr)
												AND ta.datet = sr.datesked
												AND sr.dispatchlocid = $ASLocationID
												AND sr.recid = $srid
												AND srl.specificrouteid = sr.recid
												AND srl.clientlocid = $ASLocationID
												AND ta.customerlocid = srl.locationid
												AND rl.locationid = srl.locationid
												AND rl.clientid = $ASCompanyID
												AND sp.recid = ta.specificproductid
												AND p.recid = sp.productid
												GROUP BY ta.specificproductid
												HAVING qty > 0 OR srqty > 0
												OR preBundQty > 0 OR preBundSrQty > 0
												ORDER BY prod_desc";
						}
						else {
							// GETTING THE QTY FOR EACH ROUTE.
							$qryGetRouteQty = "SELECT ta.specificproductid spid,
												SUM(IF(ta.specificrouteid IS NULL OR ta.specificrouteid = 0 OR ta.specificrouteid = '', ta.actquantity, 0)) qty,
												SUM( IF( ta.specificrouteid = sr.recid, ta.actquantity, 0)) srqty,

												CONCAT_WS(' - ', NULLIF(p.ldesc, ''), DATE_FORMAT(sp.datex, '%m/%d/%y') ) prod_desc, sp.bundlecount
												FROM transactivity ta, specificroutes sr, specificrouteloc srl,
												specificproduct sp, product p, location l
												WHERE ta.locationid = $ASLocationID
												AND ta.customerlocid = l.recid
												AND ((ta.type = 'SD' AND l.type != 'R') OR (ta.type = 'DE' AND l.type = 'R' ))
												AND ta.specificproductid IN ($spIdStr)
												AND ta.datet = sr.datesked
												AND sr.dispatchlocid = $ASLocationID
												AND sr.recid = $srid
												AND srl.specificrouteid = sr.recid
												AND srl.clientlocid = $ASLocationID
												AND ta.customerlocid = srl.locationid
												AND sp.recid = ta.specificproductid
												AND p.recid = sp.productid
												GROUP BY ta.specificproductid
												HAVING qty > 0 OR srqty > 0
												ORDER BY prod_desc";
						}

						// FOR SPLITTING OF TABLES
						$qryGetRouteQty = convertToSplitTables($qryGetRouteQty, $val_SPLIT);
						if($debug)
							print($qryGetRouteQty . "<br />\n");
						$rsltGetRouteQty = mysqli_query( $cvtconnection, $qryGetRouteQty);

						if(!$rsltGetRouteQty) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if(mysqli_num_rows($rsltGetRouteQty) == 0) {
							}
							else {
								$flagNoInfo = false;
								// NOW FINDING SLUGS if flagDispSlugs = true
								$slugsStr = "";
								if($flagDispSlugs) {

									$qryGetSlugs = "SELECT SUM(vll.slugsperday) slugsRequired
													FROM transactivity ta, location l, vendinglocationlink vll,
													specificroutes sr, specificrouteloc srl
													WHERE ta.locationid = $ASLocationID
													AND ta.type = 'SD'
													AND ta.specificproductid IN ($spIdStr)
													AND ta.datet = sr.datesked
													AND sr.dispatchlocid = $ASLocationID
													AND sr.recid = $srid
													AND srl.specificrouteid = sr.recid
													AND srl.clientlocid = $ASLocationID
													AND ta.customerlocid = srl.locationid
													AND l.recid = ta.customerlocid
													AND l.type = 'M'
													AND vll.locationid = l.recid";

									// FOR SPLITTING OF TABLES
									$qryGetSlugs = convertToSplitTables($qryGetSlugs, $val_SPLIT);

									if($debug)
										print($qryGetSlugs . "<br />\n");
									$rsltGetSlugs = mysqli_query( $cvtconnection, $qryGetSlugs);

									if(!$rsltGetSlugs) {
										$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
										print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
										unset($fileLineNbr);
									}
									else {
										if(mysqli_num_rows($rsltGetSlugs) == 0) {
											$slugsRequired = 0;
										}
										else {
											$rowGetSlugs = mysqli_fetch_assoc($rsltGetSlugs);
											$slugsRequired = $rowGetSlugs[slugsRequired];
											if(!is_numeric($slugsRequired))	$slugsRequired = 0;
										}
									}
									$slugsStr = " - Slugs Required: " . $slugsRequired;
								}

								print("<b><u>" . htmlentities($routeinfo, ENT_QUOTES) . $slugsStr . "</u></b><br /><br />\n");

								print("<table border=\"1\" width=\"100%\">\n");

								if($val_PBDEL == "Y" || $val_CSBDL == "Y") {
									print("<tr class=\"datatblhdr\">\n");
									if($debug) print("<td>&nbsp;</td>\n");
									print("<td>&nbsp;</td>\n");

									print("<td align=\"center\" colspan=\"2\">Pre-Bundled</td>\n");
									print("<td align=\"center\" colspan=\"3\">Not Pre-Bundled</td>\n");
									print("</tr>\n");
								}

								print("<tr class=\"datatblhdr\">\n");
								if($debug) print("<td>spid</td>\n");
								print("<td>Publication</td>\n");

								if($val_PBDEL == "Y" || $val_CSBDL == "Y") {
									print("<td align=\"right\">Quantity</td>\n");
									print("<td align=\"right\">Bundles</td>\n");
//									print("<td align=\"right\">Loose</td>\n");
								}

								print("<td align=\"right\">Quantity</td>\n");
								if($val_PBDEL != 'Y' && $val_CSBDL != 'Y') print("<td align=\"right\">Extra Copies</td>\n");
								print("<td align=\"right\">Bundles</td>\n");
								print("<td align=\"right\">Loose</td>\n");

								print("</tr>\n");

								$oddEven = 0;
								while($rowGetRouteQty = mysqli_fetch_assoc($rsltGetRouteQty)) {

									$spId = $rowGetRouteQty[spid];
									if(!is_numeric($spId))	$spId = 0;

									if( ( $oddEven++ % 2 ) == 0 ) {
										print("<tr class=\"datawhite\">\n");
									}
									else {
										print("<tr class=\"datagrey\">\n");
									}

									// FOR SPID
									if($debug) print("<td>$spId</td>\n");

									// FOR PRODCUT DESCRIPTION
									$prodDesc = $rowGetRouteQty[prod_desc];
									print("<td>" . ($prodDesc != "" ? htmlentities($prodDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");

									

if($val_PBDEL == "Y") {
		// FOR QUANTITY
		$preBundQty  = $rowGetRouteQty[preBundQty];
		if(!is_numeric($preBundQty ))	$preBundQty  = 0;
		$preBundSrQty  = $rowGetRouteQty[preBundSrQty];
		if(!is_numeric($preBundSrQty ))	$preBundSrQty  = 0;
}
											
									// FOR QUANTITY
									$qty = $rowGetRouteQty[qty];
									if(!is_numeric($qty))	$qty = 0;
									$srQty = $rowGetRouteQty[srqty];
									if(!is_numeric($srQty))	$srQty = 0;
									
									

$preBundSrQty1 = 0;
$totSrQty = 0;
$mathbundQty = 0;
$totCSbundQty = 0;
$totCSQty1 = 0;
$totNonPBQty = 0;

if($val_CSBDL == "Y") {
	

		$qryCSBDL = " SELECT DISTINCT(ta.customerlocid) custloc, 
						SUM(IF(((ta.specificrouteid IS NULL OR ta.specificrouteid = 0 
						OR ta.specificrouteid = '') 
						AND rl.prebundle = 'Y'), ta.actquantity, 0)) preBundQty, 
						SUM( IF( ((ta.specificrouteid = sr.recid) AND rl.prebundle = 'Y'),
						ta.actquantity, 0)) preBundSrQty,
						SUM(IF(((ta.specificrouteid IS NULL OR ta.specificrouteid = 0 
						OR ta.specificrouteid = '') 
						AND rl.prebundle = 'N'), ta.actquantity, 0)) qty, 
						SUM( IF((( ta.specificrouteid = sr.recid) 
						AND rl.prebundle = 'N'), ta.actquantity, 0)) srqty,
						sp.bundlecount bundlecount
						FROM transactivity ta, specificroutes sr,specificproduct sp,specificrouteloc srl, routelink rl, editioncustomer ec, editionproduct ep, location l
						WHERE ta.locationid = $ASLocationID
						AND ta.customerlocid = l.recid
						AND ((ta.type = 'SD' AND l.type != 'R') OR (ta.type = 'DE' AND l.type = 'R' ))
						AND ta.specificproductid = $spId
						AND sp.recid = ta.specificproductid
						AND ta.datet = sr.datesked
						AND sr.recid = $srid
						AND sr.dispatchlocid = $ASLocationID
						AND srl.specificrouteid = sr.recid
						AND ta.customerlocid = srl.locationid
						AND srl.clientlocid = $ASLocationID
						AND rl.locationid = srl.locationid 
						AND rl.clientid = $ASCompanyID
						AND ec.customerlocid = ta.customerlocid
						AND ec.productid = ep.productid
						AND ec.effdt IN(SELECT MAX(effdt) FROM editioncustomer WHERE customerlocid = ta.customerlocid AND productid = sp.productid )
						AND ep.productid = sp.productid
						AND ep.bundlesystem IS NOT NULL
						GROUP BY ta.customerlocid
						HAVING qty > 0 OR srqty > 0 OR preBundQty > 0 OR preBundSrQty > 0 ";	
	
	$qryCSBDL = convertToSplitTables($qryCSBDL, $val_SPLIT);
	$xqryCSBDL = mysqli_query($cvtconnection, $qryCSBDL);
	while($rsltArr1 = mysqli_fetch_array($xqryCSBDL)) {

				$totQty1 = 0;
				$mathpreBundQty = 0;
				if($rsltArr1) {
				$qty1 = $rsltArr1[qty];
				if(!is_numeric($qty1))	$qty1 = 0;
				if($qty1 > 0) {
					$qty = $qty - $qty1;
				}

				$srQty1 = $rsltArr1[srqty];
				if(!is_numeric($srQty1))	$srQty1 = 0;
				if($srQty1 > 0) {
					$srQty = $srQty - $srQty1;
				}
				
				$preBundQty1 = $rsltArr1[preBundQty];
				if(!is_numeric($preBundQty1))	$preBundQty1 = 0;
				if($preBundQty1 > 0 && $val_PBDEL != "Y") {
					$qty = $qty - $preBundQty1;
				}

				$preBundSrQty1 = $rsltArr1[preBundSrQty];
				if(!is_numeric($preBundSrQty1))	$preBundSrQty1 = 0;
				if($preBundSrQty1 > 0 && $val_PBDEL != "Y") {
					$srQty = $srQty - $preBundSrQty1;					
				}
				$totSrQty = $totSrQty + $preBundSrQty1;
				
				$bundle_cnt = $rsltArr1[bundlecount];
				if(!is_numeric($bundle_cnt))	$bundle_cnt = "";
				
				$totQty1 = $qty1 + $srQty1 + $preBundQty1 + $preBundSrQty1;
				$nonPBQty = $qty1 + $srQty1;
				
				$mathpreBundQty = $totQty1;
				$totCSQty = $totCSQty + $totQty1;
				$totCSQty1 += $totQty1;
				$totNonPBQty += $nonPBQty;
								
				$mathbundQty = 0;
				if($mathpreBundQty <= $maxAmt && $mathpreBundQty > 0) {
					$mathbundQty = "1";
				}
				else {
					while($mathpreBundQty > 0) {
						if($mathpreBundQty > $minAmt) {
							$mathpreBundQty = $mathpreBundQty - $minAmt;
							$mathbundQty = $mathbundQty + 1;
						}
						else {
							$mathpreBundQty = 0;
							$mathbundQty = $mathbundQty + 1;
						}
					
						if($mathpreBundQty <= $diffAmt ) {
							$mathpreBundQty = 0;
						}
					}
				}
				
				$totCSbundQty = $totCSbundQty + $mathbundQty;
			}
			else {
				$qty = 0;
				$srQty = 0;
				$preBundQty = 0;
				$preBundSrQty = 0;
				
			}
							
			}

	
} // if CSBDL

									if($val_PBDEL == "Y") {

										$preBundQty  += $preBundSrQty ;
										if($val_CSBDL == "Y") {
											$preBundQty += $totNonPBQty;
										}
										print("<td align=\"right\">" . ($preBundQty  != "" ? $preBundQty  : "&nbsp;") . "</td>\n");

										// FOR BUNDLES
										$bundle_cnt = $rowGetRouteQty[bundlecount];

/*										if($bundle_cnt == 0) {
											$bundQty = "";
										}
										else {
											$bundQty = (int)( $preBundQty / $bundle_cnt );
									}*/
									
										if($val_CSBDL == "Y") {
											$bundQty = $preBundQty - $totCSQty1 ;
											$bundQty = $bundQty + $totCSbundQty;
										}
										else {
											$bundQty = $preBundQty;
										}
										print("<td align=\"right\">" . ($bundQty != "" ? $bundQty : "&nbsp;") . "</td>\n");

										// FOR LOOSE
										if($bundle_cnt == 0) {
											$perBundLost = "";
										}
										else {
											$perBundLost = ( $preBundQty % $bundle_cnt );
										}
//										print("<td align=\"right\">" . ($perBundLost != "" ? $perBundLost : "&nbsp;") . "</td>\n");
									}

if($val_CSBDL == "Y" && $val_PBDEL != "Y") {
	$totPreBundQty += $totCSQty1;
	$totPreBundBQty += $totCSbundQty;
	print("<td align=\"right\">" . ($totCSQty1  > 0  ? $totCSQty1  : "&nbsp;") . "</td>\n");
	print("<td align=\"right\">" . ($totCSbundQty > 0 ? $totCSbundQty : "&nbsp;") . "</td>\n");

}//if($val_CSBDL == "Y" && $val_PBDEL != "Y")

									
									$qty += $srQty;

									print("<td align=\"right\">" . ($qty != "" ? $qty : "&nbsp;") . "</td>\n");

									if($val_PBDEL != 'Y' && $val_CSBDL != 'Y') {
										// HERE LETS FIND THE EXTRA PAPERS (IT IS FROM ROUTEDRAWepCCOUNTING)

										$qryGetExtra = "SELECT
														SUM(qtyissued) qtyIssued,
														SUM(qtysked) qtySked
														FROM routedrawaccounting
														WHERE clientlocid = $ASLocationID
														AND specificrouteid = $srid
														AND actspecificproductid = $spId";

										// FOR SPLITTING OF TABLES
										$qryGetExtra = convertToSplitTables($qryGetExtra, $val_SPLIT);

										if($debug)
											print($qryGetExtra . "<br />\n");
										$rsltGetExtra = mysqli_query( $cvtconnection, $qryGetExtra);

										if(!$rsltGetExtra) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											if(mysqli_num_rows($rsltGetExtra) == 0) {
											}
											else {
												$rowGetExtra = mysqli_fetch_assoc($rsltGetExtra);
												$qtyIssued = $rowGetExtra[qtyIssued];
												$qtySked = $rowGetExtra[qtySked];
												ValidateForInt(false, "qtySked", "qtyIssued");
											}
										}

										$extraQty = $qtyIssued - $qtySked;
										$qty = $qty + $extraQty;
										// FOR EXTRA COPIES
										 print("<td align=\"right\">$extraQty</td>\n");
									}

									// FOR BUNDLES
									$bundle_cnt = $rowGetRouteQty[bundlecount];

									if($bundle_cnt == 0) {
										$b_qty = "";
									}
									else {
										$b_qty = (int)( $qty / $bundle_cnt );
									}
									print("<td align=\"right\">" . ($b_qty != "" ? $b_qty : "&nbsp;") . "</td>\n");

									// FOR LOOSE
									if($bundle_cnt == 0) {
										$lost = "";
									}
									else {
										$lost = ( $qty % $bundle_cnt );
									}
									print("<td align=\"right\">" . ($lost != "" ? $lost : "&nbsp;") . "</td>\n");

									print("</tr>\n");
								}

								print("</table>\n");
								print("<br clear=\"all\" style=\"page-break-after:always\">\n");
							}
						}
					}
				}
				if($flagNoInfo) {
					print("<b>No Information Available</b>\n");
				}
			}
		}

		print("</form>\n");
		print("</div>\n");
		break;

	case "ToSelRouteSet":
		// VALIDATION
		ValidateForInt(false, "pdid");

		print("<div class=\"datawhite\">\n");

		//GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt", "routesetdt", "routesetas");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
			$routeSetDt = $rsltArr[routesetdt];
			$routeSetAs = $rsltArr[routesetas];
		}
		else {
			$effdt = "";
			$dbEffDt = "";
			$routeSetDt = "";
			$routeSetAs = "";
		}
		unset($rsltArr, $fileLineNbr);

		// show disp_rundate
		$dispEffDt = set_date($dbEffDt, "YYYY-MM-DD", "MM/DD/YY");
		print("<b><u>Run Date - $dispEffDt</u></b><br /><br />\n");

		print("<b>Select Route Set</b><br /><br />\n");

		/*
		//FIRST SET THE DEFAULT ROUTESETID
		$rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "routesetid");
		if($rsltArr[rtvalue]) {
			$rsId = $rsltArr[routesetid];
			if(!is_numeric($rsId)) $rsId = 0;
		}
		else {
			$rsId = 0;
		}
		unset($rsltArr);
		*/

		// GET THE ROUTESETS FROM PRODUCTDISPATCH AND STORE THEM. LETS THEM PRE-SELECTED
		// WHEN THIS SCREEN IS PREVISITED.
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "routesetid", "returnsroutesetid");
		$rsIdArr = array();
		if($rsltArr[rtvalue]) {
			$rsId = $rsltArr[routesetid];
			$rsRsId = $rsltArr[returnsroutesetid];
			ValidateForInt(false, "rsId", "rsRsId");

			array_push($rsIdArr, $rsId);
			array_push($rsIdArr, $rsRsId);
		}
		else {
			$rsId = 0;
			$rsRsId = 0;
		}
		unset($rsltArr, $fileLineNbr);

		$rsTypeArr = GeneralArray("routeset.type");

		print("<form name=\"Level1Form\" method=\"post\" action=\"tra37.php\">\n");

		print("<table border=\"1\" width=\"70%\">\n");
		print("<tr class=\"datatblhdr\">\n");
		print("<td>Type</td>\n");
		print("<td>Route Set</td>\n");
		print("</tr>");

		$oddEven = 0;
		$cntid = 0;
		//while($rowGetInfo = mysql_fetch_assoc($rsltGetInfo)) {
		// FOR($cntrt = 0; $cntrt < count($rsTypeArr); $cntrt++) {
		foreach($rsTypeArr AS $rsType => $rsTypeDesc) {
			if(!in_array($rsType, array("SR", "RR")))
				continue;

			// now check if any routeset exist for this type
			$qryGetRT = "SELECT DISTINCT(recid) rsId, sdesc rsDesc
						FROM routeset
						WHERE clientlocid = $ASLocationID
						AND type = '$rsType'
						ORDER BY sdesc";
			// AND " . ($rsType == "RR" ? "type IN ('RR', 'CO')" : "type = '$rsType'") ."
			if($debug)
				print($qryGetRT . "<br />\n");
			$rsltGetRT = mysqli_query( $cvtconnection, $qryGetRT);
			if(!$rsltGetRT) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if(mysqli_num_rows($rsltGetRT) == 0) continue;
			}

			if( ( $oddEven++ % 2 ) == 0 ) {
				print("<tr class=\"datawhite\">\n");
			}
			else {
				print("<tr class=\"datagrey\">\n");
			}

			// TYPE
			print("<td>\n");
			print("" . htmlentities($rsTypeDesc, ENT_QUOTES) . "");
			print("<input type=\"hidden\" name=\"rsTypeArr[$cntid]\" value=\"$rsType\" />\n");
			print("</td>\n");

			// FOR ROUTE SET
			print("<td>");
			print("<select name=\"rsIdArr[" . $cntid . "]\">\n");
			print("\t<option value=\"\">Select Route Set</option>\n");
			while($rowGetRT = mysqli_fetch_assoc($rsltGetRT)) {
				print("\t<option value=\"" . $rowGetRT[rsId] . "\"");
				if($rsId == $rowGetRT[rsId] || $rsRsId == $rowGetRT[rsId])
					print(" selected=\"selected\"");
				print(">");
				if($debug)
					print("" . $rowGetRT[rsId] . " - ");
				print("" . htmlentities($rowGetRT[rsDesc], ENT_QUOTES) . "</option>\n");
			}
			print("</select>\n");
			print("</td>\n");

			print("</tr>\n");
			$cntid++;
		}
		print("</table>\n");


		/*
		# QUERY TO GET INFORMATION
		$qryGetInfo = "SELECT DISTINCT(recid) rsId, sdesc rsDesc, type
					FROM routeset
					WHERE clientlocid = $ASLocationID
					AND type IN ('SR', 'HO', 'RR')
					ORDER BY type, sdesc";
		if($debug) print("$qryGetInfo<br />");
		$rsltGetInfo = mysql_query($qryGetInfo, $cvtconnection);

		print("<table border=\"1\" width=\"70%\">");
		print("<tr class=\"datatblhdr\">");
		print("
			<td align=\"center\">
			<input type=\"checkbox\" name=\"checkall\" value=\"checkall\" onclick=\"CheckBoxAll(this.form, this.checked, 'rsIdArr')\" />
			</td>
		");
		print("<td>Route Set</td>");
		print("<td align=\"center\">Type</td>");
		print("</tr>");

		$oddEven = 0;
		$cntid = 0;
		while($rowGetInfo = mysql_fetch_assoc($rsltGetInfo)) {
			if( ( $oddEven++ % 2 ) == 0 ) print("<tr class=\"datawhite\">\n");
			else print("<tr class=\"datagrey\">\n");

			$rsId = $rowGetInfo[rsId];
			if(!is_numeric($rsId)) $rsId = 0;

			// FOR sel
			print("
				<td align=\"center\">
				<input type=\"checkbox\" name=\"rsIdArr[" . $cntid . "]\" value=\"" . $rsId . "\" onclick=\"CheckBoxSingle(this.form, this.checked)\"");
			if(in_array($rsId, $rsIdArr)) print(" checked=\"checked\"");
			print(" />
				</td>
			");

			// FOR Route Set
			$rsDesc = $rowGetInfo[rsDesc];
			print("<td>");
			if($debug) print("$rsId - ");
			print("" . htmlentities($rsDesc, ENT_QUOTES) . "</td>");

			// type
			$rsType = $rowGetInfo[type];
			print("<td align=\"center\">{$rsTypeArr[$rsType]}</td>");

			print("</tr>");
			$cntid++;
		}
		print("</table>");
		*/

		print("<br />\n");

		print("<input type=\"button\" name=\"selRoute\" value=\"Create Runs for the Selected Date\" onclick=\"SubmitSelRouteSet('SelRouteSet', this.value)\" />\n");

		if($routeSetDt != "") {
			print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
			print("<span id=\"nextStep\" style=\"display: inline;\">");
			print("<input type=\"button\" value=\"Runs Created - Proceed to the Next Step\" onclick=\"location.href='../cm/doback.php?Back=$Back'\" />\n");
			print("</span>\n");
		}

		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
		print("<input type=\"hidden\" name=\"norecords\" value=\"$cntid\" />\n");

		print("</form>\n");
		print("<br />\n");

		//HERE DISPLAY THE SPECIFICROUTES IF ANY
		/*if(!is_numeric($rsId)) $rsId = 0;
		if(isset($rsId) && $rsId != 0) {*/
		if(isset($rsIdArr) && count($rsIdArr) > 0) {
			// PREPARE STR
			$rsIdStr = MakeStr_TRA37($rsIdArr);
			if($rsIdStr == "") $rsIdStr = "0";

			//QUERY TO GET INFORMATION
			$qryGetInfo = "SELECT DISTINCT(sr.recid) srid, r.routenbr, r.sdesc,
							TIME_FORMAT(sr.timesked, '%H:%i:%s') timesked,
							sr.driverid
							FROM routesetdetail rsd,
							specificroutes sr, route r
							WHERE rsd.routesetid IN (" . $rsIdStr . ")/*= $rsId*/
							AND sr.routeid = rsd.routeid
							AND sr.dispatchlocid = $ASLocationID
							AND sr.datesked = '$dbEffDt'
							AND r.recid = sr.routeid
							AND r.locationid = $ASLocationID
							AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
							OR r.endeffdt > '$curDate' )
							AND ( rsd.endeffdt IS NULL OR rsd.endeffdt = '0000-00-00'
							OR rsd.endeffdt > '$curDate' )
							ORDER BY r.routenbr, r.sdesc, datesked";

			// FOR SPLITTING OF TABLES
			$qryGetInfo = convertToSplitTables($qryGetInfo, $val_SPLIT);

			if($debug)
				print("<b>" . $qryGetInfo . "</b><br />\n");
			$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);

			print("<b><u>Runs</u></b><br /><br />\n");

			if($routeSetDt != "") {
				print("<div align=\"left\"><a href=\"" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&doAction=ToAddSpecificRoute&pdid=$pdid", ENT_QUOTES) . "\">Add Route</a></div><br />\n");
			}

			$typeStr = "'SR', 'RS', 'SS', 'LR', 'PR'";

			if($val_ESRTE == "Y") {
				$typeStr .= ", 'ES', 'ER'";
			}

			if($val_HAWKS == "Y") {
				$typeStr .= ", 'AM', 'PM', 'TR'";
			}

			// FINDING EXTRA ROUTES WHICH ARE NOT IN CURRENT ROUTESET.
			$qryGetExtraRoutes = "SELECT DISTINCT(sr.recid) srId, r.routenbr routeNbr,
									r.sdesc routeDesc, TIME_FORMAT(sr.timesked, '%H:%i:%s') dbTimeSked,
									sr.driverid driverId, COUNT(rsd.recid) rsdCnt
									FROM specificroutes sr, route r
									LEFT JOIN routesetdetail rsd ON rsd.routeid = r.recid
									AND rsd.routesetid IN (" . $rsIdStr . ")
									AND ( rsd.endeffdt IS NULL OR rsd.endeffdt = '0000-00-00'
									OR rsd.endeffdt > '$curDate' )
									WHERE sr.dispatchlocid = $ASLocationID
									AND sr.datesked = '$dbEffDt'
									AND r.recid = sr.routeid
									AND r.type IN ($typeStr)
									AND r.locationid = $ASLocationID
									AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
									OR r.endeffdt > '$curDate' )
									GROUP BY sr.recid
									HAVING rsdCnt = 0
									ORDER BY r.routenbr, r.sdesc, datesked";

			// FOR SPLITTING OF TABLES
			$qryGetExtraRoutes = convertToSplitTables($qryGetExtraRoutes, $val_SPLIT);
			if($debug)
				print($qryGetExtraRoutes . "<br />\n");
			$rsltGetExtraRoutes = mysqli_query( $cvtconnection, $qryGetExtraRoutes);
			$dispDelCol = false;
			if(!$rsltGetExtraRoutes) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if(mysqli_num_rows($rsltGetExtraRoutes) != 0) {
					$dispDelCol = true;
				}
			}

			print("<table border=\"1\" width=\"100%\">\n");
			print("<tr class=\"datatblhdr\">\n");
			if($debug)
				print("<td>srid</td>\n");
			if($dispDelCol) {
				print("<td align=\"center\">Del</td>\n");
			}
			print("<td align=\"center\">Route Number</td>\n");
			print("<td>Description</td>\n");
			print("<td align=\"center\">Time</td>\n");
			print("<td>Driver</td>\n");
			print("</tr>\n");

			$oddEven = 0;
			while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
				if( ( $oddEven++ % 2 ) == 0 ) {
					print("<tr class=\"datawhite\">\n");
				}
				else {
					print("<tr class=\"datagrey\">\n");
				}

				// FOR SRID
				$srid = $rowGetInfo[srid];
				if(!is_numeric($srid)) $srid = 0;
				if($debug) print("<td>$srid</td>\n");

				// FOR DELETE COLUMN
				if($dispDelCol) {
					print("<td align=\"center\">&nbsp;</td>\n");
				}

				// FOR ROUTE NUMBER
				$routeNbr = $rowGetInfo[routenbr];
				print("<td align=\"center\">" . ($routeNbr != "" ? htmlentities($routeNbr, ENT_QUOTES) : "&nbsp;") . "</td>\n");

				// FOR ROUTE
				$routeDesc = $rowGetInfo[sdesc];
				print("<td>" . ($routeDesc != "" ? htmlentities($routeDesc, ENT_QUOTES) : "&nbsp;"). "</td>\n");

				// FOR TIME
				$timeSked = $rowGetInfo[timesked];

				print("<td align=\"center\">" . ($timeSked != "" ? $timeSked : "&nbsp;") . "</td>\n");

				// FOR DRIVER
				$driverId = $rowGetInfo[driverid];
				if(!is_numeric($driverId)) $driverId = 0;
				if($driverId == 0) {
					$driverName = "";
				}
				else {
					$driverName = GetPer($driverId, $cvtconnection);
				}
				print("<td>" . ($driverName != "" ? htmlentities($driverName, ENT_QUOTES) : "&nbsp;") . "</td>\n");

				print("</tr>\n");
			}

			// NOW DISPLAYING EXTRA ROUTE WHICH ARE ADDED BY ADD ROUTE LINK
			while($rowGetExtraRoutes = mysqli_fetch_assoc($rsltGetExtraRoutes)) {
				if( ( $oddEven++ % 2 ) == 0 ) {
					print("<tr class=\"datawhite\">\n");
				}
				else {
					print("<tr class=\"datagrey\">\n");
				}

				// FOR SRID
				$srId = $rowGetExtraRoutes[srId];
				if(!is_numeric($srId)) $srId = 0;
				if($debug) print("<td>$srId</td>\n");

				// FOR DELETE COLUMN
				print("<td align=\"center\"><a href=\"javascript:delConfirmSpecificRoute('$PassedPageNbr','$srId');\"><img src=\"../img/del.gif\" border=\"0\" height=\"12\" width=\"12\" alt=\"\" /></a></td>\n
				");

				// FOR ROUTE NUMBER
				$routeNbr = $rowGetExtraRoutes[routeNbr];
				print("<td align=\"center\">" . ($routeNbr != "" ? htmlentities($routeNbr, ENT_QUOTES) : "&nbsp;") . "</td>");

				// FOR ROUTE
				$routeDesc = $rowGetExtraRoutes[routeDesc];
				print("<td>" . ($routeDesc != "" ? htmlentities($routeDesc, ENT_QUOTES) : "&nbsp;"). "</td>\n");

				// FOR TIME
				$timeSked = $rowGetExtraRoutes[dbTimeSked];
				print("<td align=\"center\">" . ($timeSked != "" ? $timeSked : "&nbsp;") . "</td>\n");

				// FOR DRIVER
				$driverId = $rowGetExtraRoutes[driverId];
				if(!is_numeric($driverId)) $driverId = 0;
				if($driverId == 0) {
					$driverName = "";
				}
				else {
					$driverName = GetPer($driverId, $cvtconnection);
				}
				print("<td>" . ($driverName != "" ? htmlentities($driverName, ENT_QUOTES) : "&nbsp;") . "</td>\n");

				print("</tr>\n");
			}

			print("</table>\n");
		}

		print("</div>\n");
		break;
                
        /* 3.2 */       
        case "ToSelRouteGroup":
                
		print("<div class=\"datawhite\" align=\"left\">");
		print("<form name=\"level2Form\" method=\"post\" action=\"tra37.php\">");

		// ROUTE GROUP DROPLIST
                if($rdGroupType != "A")
                $wherTableStr = " AND rg.type = '$rdGroupType' ";
		$qryGetRouteGroups = "SELECT /*tra37*/ rg.recid rgRecId,CONCAT_WS(' - ', NULLIF(rg.groupsdesc, ''), NULLIF(subGroupSDesc, '')) routeGroupDesc
								FROM routegroup rg
								WHERE rg.clientlocid = $ASLocationID
								$wherTableStr
								AND ( rg.endeffdt IS NULL OR rg.endeffdt = '0000-00-00' OR rg.endeffdt > NOW())
								ORDER BY sortSeqNbr";
                
                if($debug)
			print($qryGetRouteGroups . "<br />");
			$rsltGetRouteGroups = mysqli_query( $cvtconnection, $qryGetRouteGroups);
		if(!$rsltGetRouteGroups) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(12, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {  
                        if(mysqli_num_rows($rsltGetRouteGroups) == 0) {
			    print("<div class=\"datawhite\" align=\"center\">");
			    print("<b>No Information Available</b>");
			    print("</div>");
			}
                        else
                        {   
			print("<table border=\"1\" width=\"100%\">");
			print("<tr class=\"datatblhdr\">");
			if($debug) print("<td align=\"center\">Route group id</td>");
			print("
				<td align=\"center\" width=\"10%\">
				<input id=\"chkSelAll\" type=\"checkbox\" name=\"checkall\" value=\"checkall\" onclick=\"CheckBoxAll(this.form, this.checked, 'routeGroupIdArray')\" />
				</td>
			");

			print("<td><label for=\"chkSelAll\">Route Group</label></td>");
			print("</tr>");
			$oddEven = 0;
			$cntId = 0;
                        
                        #fetches information from the route table
			while($rowGetRouteGroups = mysqli_fetch_assoc($rsltGetRouteGroups)) {
				if( ( $oddEven++ % 2 ) == 0 ) {
					print("<tr class=\"datawhite\">");
				}
				else {
					print("<tr class=\"datagrey\">");
				}
				//FOR ROUTEGROUPID
				$routeGroupId = $rowGetRouteGroups[rgRecId];
				if(!is_numeric($routeGroupId)) $routeGroupId = 0;
				if($debug) print("<td>$routeGroupId</td>");

				//FOR Selecting single checkbox
				print("
					<td align=\"center\">
					<input id=\"chkRouteGroup" . $cntId . "\" type=\"checkbox\" name=\"routeGroupIdArray[" . $cntId . "]\" value=\"" . $routeGroupId . "\" onclick=\"CheckBoxSingle(this.form, this.checked)\" />
					</td>
				");

				//FOR routegroupinfo
				$routeGroupDesc = $rowGetRouteGroups[routeGroupDesc];
				print("<td><label for=\"chkRouteGroup" . $cntId . "\">" . htmlentities($routeGroupDesc, ENT_QUOTES) . "</label></td>");

				print("</tr>");
				$cntId++;
			}
                           
			print("</table>");
                    }
		}

		
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />");
		print("<input type=\"hidden\" name=\"norecords\" value=\"$cntId\" />");
                print("<input type=\"hidden\" name=\"rdGroupType\" value=\"$rdGroupType\" />");
             

		print("<div class=\"datawhite\" align=\"center\">");
		if($cntId > 0) {
			print("<br />");
			print("<a href=\"javascript:SubmitLevel2Form('SelRouteGroup');\">Post</a>");
		}
		print("</div>");
		print("</form>");

		print("</div>");
		break;
        case "SelRouteGroup":
		$routeGroupIdStr = implode(", ", $routeGroupIdArray);

		# now set it to session var
		if(isset($_SESSION[TRA37ROUTEGROUPIDSTR]))
			unset($_SESSION[TRA37ROUTEGROUPIDSTR]);

		$_SESSION[TRA37ROUTEGROUPIDSTR] = $routeGroupIdStr;

		if(!isset($_SESSION[TRA37ROUTEGROUPIDSTR]) || $_SESSION[TRA37ROUTEGROUPIDSTR] == "") {
			$routeGroupIdStr = "";
		}
		else {
			$routeGroupIdStr = $_SESSION[TRA37ROUTEGROUPIDSTR];
		}

		if($debug) {
			print("TRA37ROUTEGROUPIDSTR = ");
			print_r($_SESSION[TRA37ROUTEGROUPIDSTR]);
			print("<br />");
		}


		//$Back = "javascript:refreshParent()";
                print("<meta http-equiv=\"Refresh\" content=\"1; url=" . urldecode($Back) . "\" />");
		include('../cm/html-secondwindow.php');
		print("<div class=\"datawhite\">");

		print("<b>Route Group Selected.</b><br /><br />");

		if($debug){
		    print("<a href=\"" . urldecode($Back) . "\">Back</a><br />");
		}
		else {
			
                    print("<script language=\"JavaScript\" type=\"text/javascript\">" . $Back . "</script>");
		}
		print("</div>");
		include('../cm/html-bottom-secondwindow.php');

		break;     
        /* 3.2 */
	case "WarnSelRouteSet":
		// VALIDATION
		ValidateForInt(false, "rsId", "pdid");

		print("<div class=\"datawhite\">");

		if($flag_sched_exist) {
			print("<b>Warning :</b> you are about to <b>clear</b> the <b>Route Delivery Sheet</b> data previously created.<br /><br />  Are you sure?");
			print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
			print("<a href=\"" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=SelRouteSetForce&rsId=$rsId&pdid=$pdid", ENT_QUOTES) . "\">Yes</a>\n");
			print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
			print("<a href=\"" . urldecode(htmlspecialchars($Back, ENT_QUOTES)) . "\">No</a>\n");
		}
		else {
			print("Sorry, the current set is already in use for this day and cannot be changed.<br /><br />");
			print("<a href=\"" . urldecode(htmlspecialchars($Back, ENT_QUOTES)) . "\">OK</a>\n");
		}

		print("</div>\n");
		break;

	case "SelRouteSet":
	case "SelRouteSetForce":

		
		// VALIDATION
		//ValidateForInt(false, "rsId", "pdid");
		ValidateForInt(false, "pdid");


		// PHRTE - Find any SpecificRouteLocs on Shadow routes
		$val_PHRTE = GetLSVar("PHRTE", "charvar", $ASLocationID, $cvtconnection);
		if($debug) print("PHRTE = $val_PHRTE<br />\n");


		// GET OUR STANDARD ARRAYS THEY WILL BE USED AT VARIOUS PLACES
		$stdRouteArr = GeneralArray("routetype_standard");
		if($val_HAWKS == 'Y') {
			if(!in_array('AM', $stdRouteArr)) {
				array_push($stdRouteArr, 'AM');
			}

			if(!in_array('PM', $stdRouteArr)) {
				array_push($stdRouteArr, 'PM');
			}

			if(!in_array('TR', $stdRouteArr)) {
				array_push($stdRouteArr, 'TR');
			}
		}
		$retrunColRouteArr = GeneralArray("routetype_returncol");

		$rsIdArr = array_values($rsIdArr);
		for($tempi = 0; $tempi < count($rsIdArr); $tempi++) {
			if(!is_numeric($rsIdArr[$tempi])) $rsIdArr[$tempi] = 0;
			if($rsIdArr[$tempi] == 0)
				unset($rsIdArr[$tempi]);
		}
		$rsIdArr = array_values($rsIdArr);

		$routeSetIdStr = MakeStr_TRA37($rsIdArr);
		if($routeSetIdStr == "") $routeSetIdStr = "0";

		// GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effDt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$effDt = $rsltArr[effDt];
			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$effDt = "";
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		// GET ROUTESETTYPE
		//$rstype = GetDescription("routeset", $rsId, "type");

		// FIRST DELETE ALL ADDITIONAL DRIVERS RECORDS IF ANY EXIST
		$qryDel = "DELETE FROM tempdata
					WHERE jobtable = 'TRA37'
					AND activesessionid = $RecIdAS";
		if($debug)
			print("<b>" . $qryDel . "</b><br />\n");
		$rsltDel = mysqli_query( $cvtconnection, $qryDel);
		if(!$rsltDel) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 04);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
		}

		/*
			HERE WE HAVE TO DO TWO THINGS. THIS PROCESS WILL BE DONE IN TWO PHASES: 1)
			FIRST WE WILL DELETE THOSE RECORDS WHERE THE SPECIFICROUTEID IS SET AND
			THEN DELETE THOSE RECORDS WHERE SPECIFICROUTEID IS NOT SET. AND THIS PROCESS
			WILL BE DONE ACCORDING TO THE selected=\"selected\" ROUTESET TYPES ONLY.
		*/
		$qryGetRS = "SELECT DISTINCT(r.recid) routeId, r.type routeType,
					r.message routeMsg
					FROM routesetdetail rsd, route r, routefrequency rf
					WHERE rsd.routesetid IN (" . $routeSetIdStr . ")
					AND r.recid = rsd.routeid
					AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
					OR r.endeffdt > '$dbEffDt' )
					AND rf.routeId = r.recid
					AND UCASE(rf.dow) = UCASE(DATE_FORMAT('$dbEffDt','%a'))
					AND ( rsd.endeffdt IS NULL OR rsd.endeffdt = '0000-00-00'
							OR rsd.endeffdt > '$curDate' )
					AND ( rf.endeffdt IS NULL OR rf.endeffdt = '0000-00-00' OR rf.endeffdt > '$dbEffDt' )";
		if($debug)
			print($qryGetRS . "<br />\n");
		$rsltGetRS = mysqli_query( $cvtconnection, $qryGetRS);
		$routeIdArr = array();
		$routeTypeArr = array();
		$routeMsgArr = array();
		if(!$rsltGetRS) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			while($rowGetRS = mysqli_fetch_assoc($rsltGetRS)) {
				$routeId = $rowGetRS[routeId];
				$routeType = $rowGetRS[routeType];
				$routeMsg = $rowGetRS[routeMsg];
				if(!is_numeric($routeId)) $routeId = 0;

				array_push($routeIdArr, $routeId);
				array_push($routeTypeArr, $routeType);
				array_push($routeMsgArr, $routeMsg);
			}
		}
		// Hear we will fetch "SH" routes
		$SHrouteIdArr = array();
		$qryGetRS = "SELECT DISTINCT(r.recid) routeId, r.type routeType, r.message routeMsg,
												specificproductid  FROM transactivity ta, specificroutes sp , route r
												WHERE ta.specificrouteid = sp.recid
												AND sp.dispatchlocid = $ASLocationID
												AND sp.datesked = '$dbEffDt'
												AND sp.routeid = r.recid
												AND ta.locationid = $ASLocationID
												
												AND ta.type IN ('PP','PD')
												AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00' OR r.endeffdt > '$dbEffDt' )
												AND ta.actquantity > 0";
		
                $qryGetPD = convertToSplitTables($qryGetRS, $val_SPLIT);
                if($debug)
			print($qryGetPD . "<br />\n");
                
		$rsltGetRS = mysqli_query( $cvtconnection, $qryGetPD);
		
		if(!$rsltGetRS) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			while($rowGetRS = mysqli_fetch_assoc($rsltGetRS)) {
				$routeId = $rowGetRS[routeId];
				$routeType = $rowGetRS[routeType];
				$routeMsg = $rowGetRS[routeMsg];
				if(!is_numeric($routeId)) $routeId = 0;

				array_push($SHrouteIdArr, $routeId);
				//array_push($routeTypeArr, $routeType);
				//array_push($routeMsgArr, $routeMsg);
			}
		}
		
		
		

		// HERE WE WILL HAVE THE WEEK OF MONTH IMPLEMENTATION
		$occurArr = getDayOccurrenceOfMonth_TRADATE($dbEffDt);

		$occurNum = $occurArr[0];
		$occurDay = $occurArr[1];

		$checkDow = strtoupper(substr($occurDay, 0,2)) . $occurNum;

		if($debug)
			print("checkDow = $checkDow<br />\n");

		// HERE WE WILL HAVE THE SECTION TO INCLIDE PRODUCT DELIVERY ROUTE
		$qryGetProdId = "SELECT GROUP_CONCAT(DISTINCT(sp.productid) SEPARATOR ', ') prodIdStr
							FROM transactivity ta, specificproduct sp
							WHERE ta.locationid = $ASLocationID
							AND ta.type IN( 'SD', 'PD')
							AND ta.datet = '$dbEffDt'
							AND ta.specificproductid = sp.recid";

		$qryGetProdId = convertToSplitTables($qryGetProdId, $val_SPLIT);

		if($debug) print("$qryGetProdId<br />\n");
		$rsltGetProdId = mysqli_query( $cvtconnection, $qryGetProdId);
		if(!$rsltGetProdId) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetProdId) == 0) {
			}
			else {
				while($rowGetProdId = mysqli_fetch_assoc($rsltGetProdId)){
					$prodIdStr = $rowGetProdId[prodIdStr];
				}
			}
		}

		// CHECK IN ROUTEFREQUENCY WHERE THERE EXIST RECORDS WITH PRODUCTID SET

		if($prodIdStr == "")  $prodIdStr = "0";

		$qryGetRfRoute = "SELECT DISTINCT(r.recid) routeId, r.type routeType,
							r.message routeMsg
							FROM route r, routefrequency rf
							WHERE r.locationid = $ASLocationID
							AND rf.productid IN (" . $prodIdStr . ")
							AND rf.routeId = r.recid
							AND r.type = 'PR'
							AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
							OR r.endeffdt > '$dbEffDt' )
							AND ( rf.endeffdt IS NULL OR rf.endeffdt = '0000-00-00' OR rf.endeffdt > '$dbEffDt' )";
		if($debug) print("$qryGetRfRoute<br />\n");
		$rsltGetRfRoute = mysqli_query( $cvtconnection, $qryGetRfRoute);
		if(!$rsltGetRfRoute) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetRfRoute) == 0) {
			}
			else {
				while($rowGetRfRoute = mysqli_fetch_assoc($rsltGetRfRoute)){
					$routeId = $rowGetRfRoute[routeId];
					$routeType = $rowGetRfRoute[routeType];
					$routeMsg = $rowGetRfRoute[routeMsg];
					if(!is_numeric($routeId)) $routeId = 0;

					if(!in_array($routeId, $routeIdArr)) {
						array_push($routeIdArr, $routeId);
						array_push($routeTypeArr, $routeType);
						array_push($routeMsgArr, $routeMsg);
					}
				}
			}
		}

		// WEEK OF THE MONTH CASE
		$qryGetRfRoute = "SELECT DISTINCT(r.recid) routeId, r.type routeType,
							r.message routeMsg
							FROM route r, routefrequency rf
							WHERE r.locationid = $ASLocationID
							AND UCASE(rf.dow) = '$checkDow'
							AND r.type = 'PR'
							AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
							OR r.endeffdt > '$dbEffDt' )
							AND ( rf.endeffdt IS NULL OR rf.endeffdt = '0000-00-00' OR rf.endeffdt > '$dbEffDt' )";
		if($debug) print("$qryGetRfRoute<br />\n");
		$rsltGetRfRoute = mysqli_query( $cvtconnection, $qryGetRfRoute);
		if(!$rsltGetRfRoute) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetRfRoute) == 0) {
			}
			else {
				while($rowGetRfRoute = mysqli_fetch_assoc($rsltGetRfRoute)){
					$routeId = $rowGetRfRoute[routeId];
					$routeType = $rowGetRfRoute[routeType];
					$routeMsg = $rowGetRfRoute[routeMsg];
					if(!is_numeric($routeId)) $routeId = 0;

					if(!in_array($routeId, $routeIdArr)) {
						array_push($routeIdArr, $routeId);
						array_push($routeTypeArr, $routeType);
						array_push($routeMsgArr, $routeMsg);
					}
				}
			}
		}
		$SHrouteIdStr = implode(", ", $SHrouteIdArr);
		if($SHrouteIdStr == "") $SHrouteIdStr = "0";
		
		$routeIdStr = implode(", ", $routeIdArr);
		if($routeIdStr == "") $routeIdStr = "0";

		// DELETE ALL ROUTEDRAWACCOUNTING RECORDS WHICH ARE OF DIFFERENT ROUTES
		$qryDel = "DELETE FROM routedrawaccounting
					USING routedrawaccounting, specificroutes
					WHERE routedrawaccounting.clientlocid = $ASLocationID
					AND specificroutes.recid = routedrawaccounting.specificrouteid
					AND specificroutes.dispatchlocid = $ASLocationID
					AND specificroutes.datesked = '$dbEffDt'
					AND specificroutes.routeid NOT IN (" . $routeIdStr.",".$SHrouteIdStr. ")
					AND routedrawaccounting.archupdt = 'N'";

		// FOR SPLITTING OF TABLES
		$qryDel = convertToSplitTables($qryDel, $val_SPLIT);

		if($debug)
			print("<b>" . $qryDel . "</b><br />\n");
		$rsltDel = mysqli_query( $cvtconnection, $qryDel);
		if(!$rsltDel) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 04);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> affected.<br />\n");
		}

		$qryUp = "UPDATE routedrawaccounting rda, specificroutes sr
					SET rda.clientlocid = $val_DELCO,
					rda.archupdt = IF(rda.archupdt IN ('X', 'P'), 'U', rda.archupdt)
					WHERE rda.clientlocid = $ASLocationID
					AND sr.recid = rda.specificrouteid
					AND sr.dispatchlocid = $ASLocationID
					AND sr.datesked = '$dbEffDt'
					AND sr.routeid NOT IN (" . $routeIdStr .",".$SHrouteIdStr. ")";

		// FOR SPLITTING OF TABLES
		$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> affected.<br />");
		}

		// DELETE ALL RDAEXTRADRAWSPLIT RECORDS WHICH ARE OF DIFFERENT ROUTES
		$qryDel = "DELETE FROM rdaextradrawsplit
					USING rdaextradrawsplit, specificroutes
					WHERE rdaextradrawsplit.clientlocid = $ASLocationID
					AND specificroutes.recid = rdaextradrawsplit.specificrouteid
					AND specificroutes.dispatchlocid = $ASLocationID
					AND specificroutes.datesked = '$dbEffDt'
					AND specificroutes.routeid IN (" . $routeIdStr . ")";

		// FOR SPLITTING OF TABLES
		$qryDel = convertToSplitTables($qryDel, $val_SPLIT);

		if($debug)
			print("<b>" . $qryDel . "</b><br />\n");
		$rsltDel = mysqli_query( $cvtconnection, $qryDel);
		if(!$rsltDel) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 04);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> affected.<br />");
		}


		// NOW FINDING THE OTHER SPECIALLY ADDED ROUTES WHICH ARE NOT IN ANY ROUTESETS.
		$qryGetExtraRoutes = "SELECT DISTINCT sr.recid srId, r.recid routeId, r.type routeType,
								r.message routeMsg
								FROM specificroutes sr, route r
								WHERE r.locationid = $ASLocationID
								AND r.recid = sr.routeid
								AND sr.dispatchlocid = $ASLocationID
								AND sr.datesked = '$dbEffDt'
								AND sr.routeid NOT IN (" . $routeIdStr .",".$SHrouteIdStr. ")
								AND r.type != 'SH'
								AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
								OR r.endeffdt > '$dbEffDt' )";

		// FOR SPLITTING OF TABLES
		$qryGetExtraRoutes = convertToSplitTables($qryGetExtraRoutes, $val_SPLIT);

		if($debug)
			print($qryGetExtraRoutes . "<br />\n");
		$rsltGetExtraRoutes = mysqli_query( $cvtconnection, $qryGetExtraRoutes);
		if(!$rsltGetExtraRoutes) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetExtraRoutes) == 0) {
			}
			else {
				while($rowGetExtraRoutes = mysqli_fetch_assoc($rsltGetExtraRoutes)) {

					$srId = $rowGetExtraRoutes[srId];
					if(!is_numeric($srId))	$srId = 0;

					if($val_HWKPR == "Y") {
						$qryDel = "DELETE FROM hawkerrouteloclink
									USING hawkerrouteloclink, specificrouteloc
									WHERE specificrouteloc.clientlocid = $ASLocationID
									AND specificrouteloc.specificrouteid = $srId
									AND specificrouteloc.recid = hawkerrouteloclink.specificroutelocid";

						// FOR SPLITTING OF TABLES
						$qryDel = convertToSplitTables($qryDel, $val_SPLIT);

						if($debug)
							print("<b>" . $qryDel . "</b><br />\n");
						$rsltDel = mysqli_query( $cvtconnection, $qryDel);
						if(!$rsltDel) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 04);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
						}
					}
					
					
					
					if($val_PHRTE == "Y")
					{
					//DELETE specificProductLink
					$qryUp = "UPDATE specificrouteloc srl, specificproductlink spl
								SET spl.clientlocid = $val_DELCO
								WHERE spl.clientlocid = $ASLocationID
								AND srl.specificrouteid = $srId
								AND srl.recid = spl.specificroutelocid
								AND srl.clientlocid = $ASLocationID";

					// FOR SPLITTING OF TABLES
					$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

					if($debug)
						print("<b>" . $qryUp . "</b><br />\n");
					$rsltUp = mysqli_query( $cvtconnection, $qryUp);
					if(!$rsltUp) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if($debug)
							print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
					}
					
				}
					// DELETE THE SPECIFICROUTELOC RECORDS
					$qryUp = "UPDATE specificrouteloc
								SET clientlocid = $val_DELCO,
								archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
								WHERE clientlocid = $ASLocationID
								AND specificrouteid = $srId";

					// FOR SPLITTING OF TABLES
					$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

					if($debug)
						print("<b>" . $qryUp . "</b><br />\n");
					$rsltUp = mysqli_query( $cvtconnection, $qryUp);
					if(!$rsltUp) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if($debug)
							print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
					}
				}
			}
		}

		// dELETE SUCH TRANSACTIVITY RECORDS. THIS SHOULD NOT HAPPEN ACTUALLY BUT THIS
		// IS TO JUST ENSURE THAT NO INCONSISTENCY HAPPENED
		$qryDel = "DELETE FROM transactivity
					USING transactivity, specificroutes
					WHERE specificroutes.dispatchlocid = $ASLocationID
					AND specificroutes.datesked = '$dbEffDt'
					AND specificroutes.routeid NOT IN (" . $routeIdStr .",".$SHrouteIdStr. ")
					AND transactivity.specificrouteid = specificroutes.recid
					AND transactivity.locationid = $ASLocationID
					AND transactivity.archupdt = 'N'";

		// FOR SPLITTING OF TABLES
		$qryDel = convertToSplitTables($qryDel, $val_SPLIT);
		if($debug)
			print("<b>" . $qryDel . "</b><br />\n");
		$rsltDel = mysqli_query( $cvtconnection, $qryDel);
		if(!$rsltDel) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 04);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
		}

		$qryUp = "UPDATE transactivity ta, specificroutes sr
					SET ta.locationid = $val_DELCO,
					ta.archupdt = IF(ta.archupdt IN ('X', 'P'), 'U', ta.archupdt)
					WHERE sr.dispatchlocid = $ASLocationID
					AND sr.datesked = '$dbEffDt'
					AND sr.routeid NOT IN (" . $routeIdStr .",".$SHrouteIdStr. ")
					AND ta.specificrouteid = sr.recid
					AND ta.locationid = $ASLocationID";

		// FOR SPLITTING OF TABLES
		$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");

		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> affected.<br />");
		}

		// DELETE the RDSEND RECORDS
		$qryDel = "DELETE FROM rdsend
					USING rdsend, specificroutes
					WHERE rdsend.devicestatus IN ('N', 'P')
					AND rdsend.datastatus = 'Y'
					AND rdsend.type = 'T'
					AND rdsend.specificroutesid = specificroutes.recid
					AND specificroutes.dispatchlocid = $ASLocationID
					AND specificroutes.datesked = '$dbEffDt'
					AND specificroutes.routeid NOT IN (" . $routeIdStr .",".$SHrouteIdStr. ")";

		// FOR SPLITTING OF TABLES
		$qryDel = convertToSplitTables($qryDel, $val_SPLIT);

		if($debug)
			print("RDSEND :: <b>" . $qryDel . "</b><br />\n");
		$rsltDel = mysqli_query( $cvtconnection, $qryDel);
		if(!$rsltDel) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 04);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
		}

		// DELETE SPECIFICROUTES
		$qryDel = "DELETE FROM specificroutes
					WHERE dispatchlocid = $ASLocationID
					AND datesked = '$dbEffDt'
					AND routeid NOT IN (" . $routeIdStr .",".$SHrouteIdStr. ")
					AND archupdt = 'N'";

		// FOR SPLITTING OF TABLES
		$qryDel = convertToSplitTables($qryDel, $val_SPLIT);

		if($debug)
			print("<b>" . $qryDel . "</b><br />\n");
		$rsltDel = mysqli_query( $cvtconnection, $qryDel);
		if(!$rsltDel) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 04);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . " records deleted</b><br />");
		}

		$qryUp = "UPDATE specificroutes
					SET dispatchlocid = $val_DELCO,
					archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
					WHERE dispatchlocid = $ASLocationID
					AND datesked = '$dbEffDt'
					AND routeid NOT IN (" . $routeIdStr .",".$SHrouteIdStr. ")";

		// FOR SPLITTING OF TABLES
		$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");

			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> affected.<br />");
		}

		// NOW SET ALL TRANSACTIVITY.SPECIFICROUTEID = NULL FOR TODAY'S RUN
		$qryUp = "UPDATE transactivity
				SET specificrouteid = NULL,
				archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
				WHERE locationid = $ASLocationID
				AND datet = '$dbEffDt'
				AND type IN ('SD', 'SP')";

		// FOR SPLITTING OF TABLES
		$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
		    if($debug)
		        print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . " rows updated.</b><br />");
		}

		//NOW GET ALL ROUTES AND CREATE SPECIFICROUTES AND SPECIFICROUTELOC RECS
		/*
		$qryGetInfo = "SELECT DISTINCT(routeId)
						FROM routesetdetail
						WHERE routesetid = $rsId
						ORDER BY routeId";
		$rsltGetInfo = mysql_query($qryGetInfo, $cvtconnection);
		if(mysql_num_rows($rsltGetInfo) == 0) {
			$msg = "No Routes Found.";
		}
		else {
			while($rowGetInfo = mysql_fetch_assoc($rsltGetInfo)) {
						*/
		if(count($routeIdArr) > 0) {
			for($cntId = 0; $cntId < count($routeIdArr); $cntId++) {
				//$routeId = $rowGetInfo[routeId];
				$routeId = $routeIdArr[$cntId];
				if(!is_numeric($routeId)) $routeId = 0;

				$routeType = $routeTypeArr[$cntId];

				$routeMsg = $routeMsgArr[$cntId];
				ValidateForStr(false, "routeMsg");

				/*
				//HERE CHECK IF SPECIFICROUTES RECORD DOESN'T EXIST THEN CREATE IT ELSE  NOT
				$qryChkRecs = "SELECT COUNT(*) FROM specificroutes
								WHERE dispatchlocid = $ASLocationID
								AND routeId = $routeId
								AND datesked = '$dbEffDt'";
				if($debug) print($qryChkRecs . "<br />\n");
				$rsltChkRecs = mysql_query($qryChkRecs, $cvtconnection);
				$flagExist = false;
				if($rowChkRecs = mysql_fetch_row($rsltChkRecs)) {
					$NoRecs = $rowChkRecs[0];
					if(!is_numeric($NoRecs)) $NoRecs = 0;
					if($NoRecs > 0) $flagExist = true;
				}

				if(!$flagExist) {
					*/
					//FIRST CHECK IN ROUTEFREQUENCY RECORD AND IF FOUND THEN ONLY PROCEED AHEAD
					$selectStr = "deviceid, driverid, TIME_FORMAT(timeX, '%H:%i:%s') timeX";
					$fromStr = "routefrequency";
					if($routeType == "PR") {
						$whereStr = "routeId = $routeId
									AND UCASE(dow) = UCASE($checkDow)
									AND ( endeffdt IS NULL OR endeffdt = '0000-00-00' OR endeffdt > '$dbEffDt' )";
					}
					else {
						$whereStr = "routeId = $routeId
									AND UCASE(dow) = UCASE(DATE_FORMAT('$dbEffDt','%a'))
									AND ( endeffdt IS NULL OR endeffdt = '0000-00-00' OR endeffdt > '$dbEffDt' )";
					}
					$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
					unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

					if($rsltArr) {
						$deviceId = $rsltArr[deviceid];
						$driverId = $rsltArr[driverid];
						$timeX = $rsltArr[timeX];
						unset($rsltArr);

						ValidateForInt(false, "deviceId", "driverId");

						$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "route", $routeId, "sdesc",
									"defaultdeviceid defaultDeviceId",
									"defaultdriverid defaultDriverId",
									"defaultvehicleid defaultVehicleId",
									"TIME_FORMAT(defaultstarttime, '%H:%i:%s') defaultStartTime",
									"TIME_FORMAT(defaultendtime, '%H:%i:%s') defaultEndTime");
						if($rsltArr[rtvalue]) {
							$sDesc = $rsltArr[sdesc];
							$defaultDeviceId = $rsltArr[defaultDeviceId];
							$defaultDriverId = $rsltArr[defaultDriverId];
							$defaultVehicleId = $rsltArr[defaultVehicleId];
							$defaultStartTime = $rsltArr[defaultStartTime];
							$defaultEndTime = $rsltArr[defaultEndTime];

							ValidateForInt(false, "defaultDeviceId", "defaultDriverId", "defaultVehicleId");
						}
						else {
							$sDesc = "";
							$defaultDeviceId = 0;
							$defaultDriverId = 0;
							$defaultVehicleId = 0;
							$defaultStartTime = "00:00:00";
							$defaultEndTime = "00:00:00";
						}
						unset($rsltArr, $fileLineNbr);

						if($deviceId == 0) $deviceId = $defaultDeviceId;
						if($driverId == 0) $driverId = $defaultDriverId;
						$vehicleId = $defaultVehicleId;
						if($timeX == "" || $timeX == "00:00:00") $timeX = $defaultStartTime;
						$dbEndTimeX = $defaultEndTime;

						// NOW HERE WE NEED TO CREATE ONE RECORD IF IT DOES NOT EXIST
						// ELSE UPDATE IT.
						$qryChkRecs = "SELECT recid
										FROM specificroutes
										WHERE dispatchlocid = $ASLocationID
										AND routeId = $routeId
										AND datesked = '$dbEffDt'";

						// FOR SPLITTING OF TABLES
						$qryChkRecs = convertToSplitTables($qryChkRecs, $val_SPLIT);

						if($debug)
							print($qryChkRecs . "<br />\n");
						$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
						if(!$rsltChkRecs) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");

							unset($fileLineNbr);
						}
						else {
							if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
								$specificRouteId = $rowChkRecs[recid];
								if(!is_numeric($specificRouteId)) $specificRouteId = 0;
							}
							else {
								$specificRouteId = 0;
							}
						}

						if($specificRouteId == 0) {
							// NOW INSERT A RECORD IN SPECIFICROUTES
							$qryIns = "INSERT INTO specificroutes(dispatchlocid, routeId, datesked,
										timesked, endtimesked, sdesc, status,
										driverid, vehicleid, deviceid, sentflag,
										message)
										VALUES($ASLocationID, $routeId, '$dbEffDt',
										'$timeX', " . ($dbEndTimeX != "" ? "'$dbEndTimeX'" : "NULL") . ", '" . addslashes($sDesc) . "', 'P',
										$driverId, $vehicleId, $deviceId, 'N',
										'" . addslashes($routeMsg) . "')";

							// FOR SPLITTING OF TABLES
							$qryIns = convertToSplitTables($qryIns, $val_SPLIT);

							if($debug)
								print("<b>" . $qryIns . "</b><br />\n");
							$rsltIns = mysqli_query( $cvtconnection, $qryIns);
							if(!$rsltIns) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								$specificRouteId = getLastInsertId();
								if(!is_numeric($specificRouteId)) $specificRouteId = 0;
							}
						}
						else {
							// UPDATE IT
							$qryUp = "UPDATE specificroutes
									SET status = 'P',
									driverid = $driverId,
									vehicleid = $vehicleId,
									deviceid = $deviceId,
									sentflag = 'N',
									message = '" . addslashes($routeMsg) . "',
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE recid = $specificRouteId";

							// FOR SPLITTING OF TABLES
							$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

							if($debug)
								print("<b>" . $qryUp . "</b><br />\n");
							$rsltUp = mysqli_query( $cvtconnection, $qryUp);
							if(!$rsltUp) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if($debug)
									print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
							}
						}

						if($specificRouteId != 0) {

							if($val_HWKPR == "Y") {
								$qryDel = "DELETE FROM hawkerrouteloclink
											USING hawkerrouteloclink, specificrouteloc
											WHERE specificrouteloc.clientlocid = $ASLocationID
											AND specificrouteloc.specificrouteid = $specificRouteId
											AND specificrouteloc.recid = hawkerrouteloclink.specificroutelocid";

								// FOR SPLITTING OF TABLES
								$qryDel = convertToSplitTables($qryDel, $val_SPLIT);

								if($debug)
									print("<b>" . $qryDel . "</b><br />\n");
								$rsltDel = mysqli_query( $cvtconnection, $qryDel);
								if(!$rsltDel) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 04);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}
								else {
									if($debug)
										print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
								}
							}
							
							
								
				
					if($val_PHRTE == "Y")
					{
					//DELETE specificProductLink
					$qryUp = "UPDATE specificrouteloc srl, specificproductlink spl
								SET spl.clientlocid = $val_DELCO
								WHERE spl.clientlocid = $ASLocationID
								AND srl.specificrouteid = $specificRouteId
								AND srl.recid = spl.specificroutelocid
								AND srl.clientlocid = $ASLocationID";

					// FOR SPLITTING OF TABLES
					$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

					if($debug)
						print("<b>" . $qryUp . "</b><br />\n");
					$rsltUp = mysqli_query( $cvtconnection, $qryUp);
					if(!$rsltUp) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if($debug)
							print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
					}
					
				}
							
							// DELETING RECORDS FORM SPECIFICROUTELOC TABLE
							$qryDel = "DELETE FROM specificrouteloc
										WHERE specificrouteid = $specificRouteId
										AND clientlocid = $ASLocationID
										AND archupdt = 'N'";

							// FOR SPLITTING OF TABLES
							$qryDel = convertToSplitTables($qryDel, $val_SPLIT);

							if($debug)
								print("<b>" . $qryDel . "</b><br />\n");

							$rsltDel = mysqli_query( $cvtconnection, $qryDel);
							if(!$rsltDel) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 04);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if($debug)
									print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> affected.<br />");
							}

							$qryUp = "UPDATE specificrouteloc
										SET clientlocid = $val_DELCO,
										archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
										WHERE specificrouteid = $specificRouteId
										AND clientlocid = $ASLocationID";

							// FOR SPLITTING OF TABLES
							$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

							if($debug)
								print("<b>" . $qryUp . "</b><br />\n");
							$rsltUp = mysqli_query( $cvtconnection, $qryUp);
							if(!$rsltUp) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if($debug)
									print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> affected.<br />");
							}

							// DELETING RECORDS FORM ROUTEDRAWACCOUNTING TABLE
							$qryDel = "DELETE FROM routedrawaccounting
										WHERE specificrouteid = $specificRouteId
										AND clientlocid = $ASLocationID
										AND archupdt = 'N'";

							// FOR SPLITTING OF TABLES
							$qryDel = convertToSplitTables($qryDel, $val_SPLIT);

							if($debug)
								print("<b>" . $qryDel . "</b><br />\n");
							$rsltDel = mysqli_query( $cvtconnection, $qryDel);
							if(!$rsltDel) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 04);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if($debug)
									print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> affected.<br />");
							}

							$qryUp = "UPDATE routedrawaccounting
										SET clientlocid = $val_DELCO,
										archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
										WHERE specificrouteid = $specificRouteId
										AND clientlocid = $ASLocationID";

							// FOR SPLITTING OF TABLES
							$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

							if($debug)
								print("<b>" . $qryUp . "</b><br />\n");
							$rsltUp = mysqli_query( $cvtconnection, $qryUp);
							if(!$rsltUp) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if($debug)
									print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> affected.<br />");
							}

							//NOW CREATE SPECIFICROUTELOC RECS FROM STANDARDROUTES
							$qryGetSR = "SELECT DISTINCT(sr.locationid), sr.subrouteid,
										TIME_FORMAT(sr.relativetime, '%H:%i:%s') reltime,
										sr.comment
										FROM standardroutes sr
										WHERE sr.routeId = $routeId
										AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00'
										OR sr.endeffdt > '$dbEffDt' )
										ORDER BY reltime";
							if($debug)
								print($qryGetSR . "<br />\n");
							$rsltGetSR = mysqli_query( $cvtconnection, $qryGetSR);

							if(!$rsltGetSR) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								while($rowGetSR = mysqli_fetch_assoc($rsltGetSR)) {
									$locid = $rowGetSR[locationid];
									$subrouteid = $rowGetSR[subrouteid];
									$reltime = $rowGetSR[reltime];
									$comment = $rowGetSR[comment];

									ValidateForInt(false, "locid", "subrouteid");

									// CHECK WHETHER THERE ALREADY EXIST ONE RECOR OR NOT AND IF EXIST
									$qryChkRecs = "SELECT recid FROM specificrouteloc
												WHERE specificrouteid = $specificRouteId
												AND locationid = $locid
												AND clientlocid = $ASLocationID";

									// FOR SPLITTING OF TABLES
									$qryChkRecs = convertToSplitTables($qryChkRecs, $val_SPLIT);

									if($debug)
										print($qryChkRecs . "<br />\n");
									$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
									if(!$rsltChkRecs) {
										$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
										print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
										unset($fileLineNbr);
									}
									else {
										if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
											$srlid = $rowChkRecs[recid];
											if(!is_numeric($srlid)) $srlid = 0;
										}
										else {
											$srlid = 0;
										}
									}

									if($srlid == 0) {
										$qryIns = "INSERT INTO specificrouteloc(specificrouteid, locationid, subrouteid, relativetime, comment, sentflag, clientlocid)
													VALUES($specificRouteId, $locid, $subrouteid,  '$reltime', '" . addslashes($comment) . "',  'N', $ASLocationID)";

										// FOR SPLITTING OF TABLES
										$qryIns = convertToSplitTables($qryIns, $val_SPLIT);

										if($debug)
											print("<b>" . $qryIns . "</b><br />\n");
										$rsltIns = mysqli_query( $cvtconnection, $qryIns);
										if(!$rsltIns) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 02);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											$srLocId = getLastInsertId();
											if($val_HWKPR == "Y") {
												// HERE WE NEED TO CONSIDER THE HAWKERROUTELOCLINK

												// FIRST LETS GET THE ROUTEID VALUE
												$selectStr = "routeid routeId";
												$fromStr = "specificroutes";
												$whereStr = "recid = $specificRouteId";
												$fileLineNbr = __LINE__;
												$fileLineNbr = __LINE__; $rsltArray = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
												unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

												if($rsltArray) {
													$routeId = $rsltArray[routeId];
													if(!is_numeric($routeId)) $routeId = 0;
												}
												else {
													$routeId = 0;
												}
												unset($rsltArray, $fileLineNbr);

												// LETS CHECK FOR EXISTANCE OF HAWKERROUTELOCSETUP
												$qryGetLocSetUp = "SELECT hls.recid lsRecId,
																	hls.standardrouteid hlsSrId,
																	hls.hawkernbr hlsHwkNbr,
																	hls.personid hlsPersId,
																	hls.role hlsRole,
																	hls.supervisorid hlsSupervisorId,
																	hls.shift hlsShift,
																	hls.schedstart hlsSchedStart,
																	hls.schedend hlsSchedEnd
																	FROM hawkerroutelocsetup hls, standardroutes sr
																	WHERE sr.routeid = $routeId
																	AND sr.locationid = $locid
																	AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00'
																	OR sr.endeffdt > '$curDate' )
																	AND sr.recid = hls.standardrouteid";
												if($debug)
													print($qryGetLocSetUp . "<br />\n");
												$rsltGetLocSetUp = mysqli_query( $cvtconnection, $qryGetLocSetUp);

												if(!$rsltGetLocSetUp) {
													$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
													print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
													unset($fileLineNbr);
												}
												else {
													if(mysqli_num_rows($rsltGetLocSetUp) == 0) {
													}
													else {
														while($rowGetLocSetUp = mysqli_fetch_assoc($rsltGetLocSetUp)) {
															$hlsRecId = $rowGetLocSetUp[hlsRecId];
															$hlsSrId = $rowGetLocSetUp[hlsSrId];
															$hlsHwkNbr = $rowGetLocSetUp[hlsHwkNbr];
															$hlsPersId = $rowGetLocSetUp[hlsPersId];
															$hlsRole = $rowGetLocSetUp[hlsRole];
															$hlsSupervisorId = $rowGetLocSetUp[hlsSupervisorId];
															$hlsShift = $rowGetLocSetUp[hlsShift];
															$hlsSchedStart = $rowGetLocSetUp[hlsSchedStart];
															$hlsSchedEnd = $rowGetLocSetUp[hlsSchedEnd];

															ValidateForInt(false, "hlsRecId", "hlsSrId", "hlsPersId", "hlsSupervisorId");

															// CHECK WHETHERE THERE ALREADY EXISTS HAWKERROUTELOCLINK RECORDS FOR THE SPECIFICROUTELOC
															if(!is_numeric($srLocId)) $srLocId = 0;

															$qryChkRecs = "SELECT
																			COUNT(recid) hrlCnt
																			FROM hawkerrouteloclink
																			WHERE specificroutelocid = $srLocId
																			AND hawkernbr = '$hlsHwkNbr'
																			AND personid = $hlsPersId
																			AND supervisorid = $hlsSupervisorId";
															if($debug)
																print($qryChkRecs . "<br />\n");
															$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
															$flagExist = false;

															if(!$rsltChkRecs) {
																$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
																print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
																unset($fileLineNbr);
															}
															else {
																$rowChkRecs = mysqli_fetch_assoc($rsltChkRecs);
																$hrlCnt = $rowChkRecs[hrlCnt];
															}

															if($hrlCnt == 0) {
																// HERE WE WILL CREATE NEW HAWKERROUTELOCLINK RECORDS
																$qryIns = "INSERT INTO hawkerrouteloclink
																			(specificroutelocid, hawkernbr,
																			personid, role, supervisorid,
																			shift, schedstart, schedend )
																			VALUES
																			($srLocId, '$hlsHwkNbr', $hlsPersId, '$hlsRole', $hlsSupervisorId, '$hlsShift', '$hlsSchedStart', '$hlsSchedEnd')";
																if($debug)
																	print("<b>" . $qryIns . "</b><br />\n");
																$rsltIns = mysqli_query( $cvtconnection, $qryIns);
																if(!$rsltIns) {
																	$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 02);
																	print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
																	unset($fileLineNbr);
																}
															}
														}
													}
												}
											}
										}
									}
									else {
										
										
										
				
										if($val_PHRTE == "Y")
										{
										//DELETE specificProductLink
										$qryUp = "UPDATE specificrouteloc srl, specificproductlink spl
													SET spl.clientlocid = $val_DELCO
													WHERE spl.clientlocid = $ASLocationID
													AND srl.recid = $srlid
													AND srl.recid = spl.specificroutelocid
													AND srl.clientlocid = $ASLocationID";
					
										// FOR SPLITTING OF TABLES
										$qryUp = convertToSplitTables($qryUp, $val_SPLIT);
					
										if($debug)
											print("<b>" . $qryUp . "</b><br />\n");
										$rsltUp = mysqli_query( $cvtconnection, $qryUp);
										if(!$rsltUp) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											if($debug)
												print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
										}
										
									}
										
										$qryUp = "UPDATE specificrouteloc
												SET sentflag = 'N',
												archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)

												WHERE recid = $srlid
												AND clientlocid = $ASLocationID";

										// FOR SPLITTING OF TABLES
										$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

										if($debug)
											print("<b>" . $qryUp . "</b><br />\n");
										$rsltUp = mysqli_query( $cvtconnection, $qryUp);
										if(!$rsltUp) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											if($debug)
												print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
										}
									}
								}
							}

							// SET APPROPRIATE ENTRIES IN ROUTEDRAWACCOUNTING IF DELIVERY ROUTE

							/*if($val_ESRTE == 'Y') {
								if(!in_array('ES', $stdRouteArr)) {
									array_push($stdRouteArr, 'ES');
								}

								if(!in_array('ER', $stdRouteArr)) {
									array_push($stdRouteArr, 'ER');
								}
							}*/

							if(in_array($routeType, $stdRouteArr) || $routeType == 'SS' || $routeType == 'RD' || $routeType == 'PR' || $routeType == 'RS' || $routeType == 'LR' || ( $val_ESRTE == "Y" && ($routeType == 'ES' || $routeType == 'ER') ) || $routeType == 'ND' )//Task#6766 -> added $routeType == 'ND'
								SetRouteDraw_TRA37($specificRouteId, $routeType);

							SetRouteDrawSP_TRA37($specificRouteId, $routeType);
						}
					}
				//}
			}

			$msg = "Runs Created.";
		}

		//UPDATE ROUTESET FLAGS

		// HERE FIND THE DELIVERY ROUTE AND RETURNS ROUTE
		$qryGetRT = "SELECT recid, type
					FROM routeset
					WHERE recid IN (" . $routeSetIdStr . ")";
		if($debug)
			print($qryGetRT . "<br />\n");
		$rsltGetRT = mysqli_query( $cvtconnection, $qryGetRT);
		if(!$rsltGetRT) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			while($rowGetRT = mysqli_fetch_assoc($rsltGetRT)) {
				if(in_array($rowGetRT[type], $stdRouteArr)) {
					$rsId = $rowGetRT[recid];
				}
				elseif(in_array($rowGetRT[type], $retrunColRouteArr)) {
					$rtRsId = $rowGetRT[recid];
				}
			}
		}
		ValidateForInt(false, "rsId", "rtRsId");

		// GET ITS INDEX
		for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
			if($pdFieldsArr[$tempi] == "routeset") {
				$routeSetIndex = $tempi;
				break;
			}
		}

		// PREPARE STRING
		$setStr = "";
		for($tempi = $routeSetIndex + 1; $tempi < count($pdFieldsArr); $tempi++) {
			$setStr .= ", {$pdFieldsArr[$tempi]}as = 0, {$pdFieldsArr[$tempi]}dt = NULL";
		}

		$qryUp = "UPDATE productdispatch
					SET routesetdt = now(),
					routesetas = $RecIdAS,
					routesetid = $rsId,
					returnsroutesetid = $rtRsId
					" . $setStr . "
					WHERE recid = $pdid";
		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
		}

		// FOR COPYING RECORDS
		$command = "perl ../rd/tra50.pl " . $ASCompanyID . " specificroutes specificrouteloc";
		exec($command);
		if($debug) print("<b>$command</b><br />\n");

		if($debug) {
			print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
		}
		else {
		    header("Location: " . urldecode($Back));
		}
		break;

	case "ToCheckDrivers":
		// VALIDATION
		ValidateForInt(false, "pdid");

		//GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt", "routesetid rsId", "returnsroutesetid rsRsId");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
			$rsId = $rsltArr[rsId];
			$rsRsId = $rsltArr[rsRsId];
			ValidateForInt(false, "rsId", "rsRsId");
		}
		else {
			$effdt = "";
			$dbEffDt = "";
			$rsId = 0;
			$rsRsId = 0;
		}
		unset($rsltArr, $fileLineNbr);

		$rsIdArr = array($rsId, $rsRsId);
		$rsIdStr = MakeStr_TRA37($rsIdArr);
		if($rsIdStr == "") $rsIdStr = "0";

		print("<div class=\"datawhite\">");

		//PRINT HEADER
		print("<b><u>Check Drivers</u></b><br /><br />");

		//QUERY TO GET INFORMATION
//		$qryGetInfo = "SELECT DISTINCT(sr.recid) srid, r.routenbr, r.sdesc,
//						TIME_FORMAT(sr.timesked, '%H:%i:%s') timesked,
//						sr.driverid, sr.message, r.type routeType
//						FROM routesetdetail rsd,
//						specificroutes sr, route r
//						WHERE /*pd.recid = $pdid
//						AND rsd.routesetid = pd.routesetid*/
//						rsd.routesetid IN (" . $rsIdStr . ")
//						AND sr.routeid = rsd.routeid
//						AND sr.dispatchlocid = $ASLocationID
//						AND sr.datesked = '$dbEffDt'
//						AND r.recid = sr.routeid
//						AND r.locationid = $ASLocationID
//						AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
//						OR r.endeffdt > '$curDate' )
//						ORDER BY r.routenbr, r.sdesc, datesked";
	if($ignoreRtType != 0 && $ignoreRtType != '')
				$chkRtType = " AND r.type NOT IN ($ignoreRtType) ";
		$qryGetInfo = "SELECT DISTINCT(sr.recid) srid, r.routenbr, r.sdesc,
                                TIME_FORMAT(sr.timesked, '%H:%i:%s') timesked,
                                sr.driverid, sr.message, r.type routeType,
                                str.integer1, CONCAT_WS(', ', NULLIF(p1.lastname, ''), NULLIF(p1.firstname, '')) persName1,
                                str.integer2, CONCAT_WS(', ', NULLIF(p2.lastname, ''), NULLIF(p2.firstname, '')) persName2,
                                str.integer3, CONCAT_WS(', ', NULLIF(p3.lastname, ''), NULLIF(p3.firstname, '')) persName3,
                                str.integer4, CONCAT_WS(', ', NULLIF(p4.lastname, ''), NULLIF(p4.firstname, '')) persName4,
                                str.integer5, CONCAT_WS(', ', NULLIF(p5.lastname, ''), NULLIF(p5.firstname, '')) persName5,
                                str.integer6, CONCAT_WS(', ', NULLIF(p6.lastname, ''), NULLIF(p6.firstname, '')) persName6
                                FROM specificroutes sr, route r
                                    LEFT JOIN storeretrieve str
                                        ON str.clientid = '$ASCompanyID'
                                        AND str.clientlocid = '$ASLocationID'
                                        AND str.type = 'H'
                                        AND str.bigint1 = r.recid
                                    LEFT JOIN person p1
                                        ON str.integer1 = p1.recid
                                    LEFT JOIN person p2
                                        ON str.integer2 = p2.recid
                                    LEFT JOIN person p3
                                        ON str.integer3= p3.recid
                                    LEFT JOIN person p4
                                        ON str.integer4 = p4.recid
                                    LEFT JOIN person p5
                                        ON str.integer5 = p5.recid
                                    LEFT JOIN person p6
                                        ON str.integer6 = p6.recid
                                WHERE sr.dispatchlocid = $ASLocationID
                                AND sr.datesked = '$dbEffDt'
                                AND r.recid = sr.routeid
                                $chkRtType
                                AND r.locationid = $ASLocationID
                                AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
                                OR r.endeffdt > '$curDate' )
                                ORDER BY r.routenbr, r.sdesc, datesked";

		// FOR SPLITTING OF TABLES
		$qryGetInfo = convertToSplitTables($qryGetInfo, $val_SPLIT);
		if($debug)
			print($qryGetInfo . "<br />\n");

		print("<table border=\"1\" width=\"100%\">\n");
		print("<tr class=\"datatblhdr\">\n");
		if($debug) print("<td>srid</td>\n");
		print("<td align=\"center\">Mod</td>\n");
		print("<td align=\"center\">Route Number</td>\n");
		print("<td>Route</td>\n");
		print("<td align=\"center\">Time</td>\n");
		print("<td>Driver</td>\n");
		print("<td>Message</td>\n");
		print("<td align=\"center\">Temp Drivers</td>\n");
                print("<td align=\"center\">Additional Drivers</td>\n");
		print("</tr>\n");

		$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
		$oddEven = 0;
		if(!$rsltGetInfo) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
				$driverId = $rowGetInfo[driverid];
				if(!is_numeric($driverId)) $driverId = 0;

				$routeType = $rowGetInfo[routeType];
				$deviceStr = GetDeviceFromPers($driverId, $routeType);
				list($deviceId, $deviceTypeId) = explode("~~", $deviceStr);

				if( ( $oddEven++ % 2 ) == 0 ) {
					print("<tr class=\"datawhite\"");
				}
				else {
					print("<tr class=\"datagrey\"");
				}

				// SHOW IN RED IF DEVICEID = 0
				#if($deviceId == 0)
				#	print(" style=\"color:#ff0000\"");

				print(">");

				// FOR srid
				$srid = $rowGetInfo[srid];
				if(!is_numeric($srid)) $srid = 0;
				if($debug) print("<td>$srid</td>");

				// FOR MOD
				print("<td align=\"center\"><a href=\"" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&doAction=EditDriver&pdid=$pdid&srid=$srid", ENT_QUOTES) . "\"><img src=\"../img/mod.gif\" border=\"0\" height=\"12\" width=\"12\" alt=\"\" /></a></td>\n");

				// FOR ROUTE NUMBER
				$routeNbr = $rowGetInfo[routenbr];
				print("<td align=\"center\"");
                                if($deviceId == 0)
                                    print(" style=\"color:#ff0000\"");
                                print (">".($routeNbr != "" ? htmlentities($routeNbr, ENT_QUOTES) : "&nbsp;") . "</td>\n");

				// FOR ROUTE
				$routeDesc = $rowGetInfo[sdesc];
				print("<td");
                                if($deviceId == 0)
                                    print(" style=\"color:#ff0000\"");
                                print(">" . ($routeDesc != "" ? htmlentities($routeDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");

				// FOR TIME
				$timeSked = $rowGetInfo[timesked];
				print("<td align=\"center\" ");
                                if($deviceId == 0)
                                    print(" style=\"color:#ff0000\"");
                                print(">" . ($timeSked != "" ? $timeSked : "&nbsp;") . "</td>\n");

				// FOR DRIVER
				if($driverId == 0) {
					$driverName = "";
				}
				else {
					$fileLineNbr = __LINE__; $driverName = GetPer($driverId, $cvtconnection);
				}
				print("<td>");
				if($driverName != "") {
					if($deviceId == 0) print("<a href=\"" . htmlspecialchars("../cm/dev01.php?PageNbr=$PassedPageNbr", ENT_QUOTES) . "\">");
					print("" . htmlentities($driverName, ENT_QUOTES) . "");
					if($deviceId == 0) print("</a>");
				}
				else {
					print("&nbsp;");
				}
				print("</td>");

				// FOR MESSAGE
				$msgStr = $rowGetInfo[message];
				print("<td");
                                if($deviceId == 0)
                                    print(" style=\"color:#ff0000\"");
                                print(">" . ($msgStr != "" ? htmlentities($msgStr, ENT_QUOTES) : "&nbsp;") . "</td>\n");


				// FOR Temp Drivers
				print("<td align=\"center\">");
				print("<a href=\"" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=ToAddAddlDr&pdid=$pdid&srid=$srid", ENT_QUOTES) . "\">\n");

				// PRINT ALL ADDITIONAL DRIVERS
				$qryGetAD = "SELECT DISTINCT(p.recid), CONCAT_WS(', ', NULLIF(p.lastname, ''),
							NULLIF(p.firstname, '')) persname
							FROM person p, tempdata td
							WHERE td.jobtable = 'TRA37'
							AND td.activesessionid = $RecIdAS
							AND td.tablerecid = $srid
							AND p.recid = td.intvar
							ORDER BY p.lastname, p.firstname";
				if($debug)
					print($qryGetAD . "<br />\n");
				$rsltGetAD = mysqli_query( $cvtconnection, $qryGetAD);
				if(!$rsltGetAD) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetAD) == 0) {
						print("No Temp Drivers");
					}
					else {
						$flag_first = true;
						while($rowGetAD = mysqli_fetch_assoc($rsltGetAD)) {
							if($flag_first) $flag_first = false;
							else print("<br />\n");
							print("" . htmlentities($rowGetAD[persname], ENT_QUOTES) . "");
						}
					}
				}
				print("</a>");
				print("</td>\n");
                                
                                //For Additional Drivers
                                print("<td align=\"center\">");
                                $flag_first = true;
                                for ($i = 1; $i <= 6; $i++) {
                                    $integer = "integer" . $i;
                                    $persName = "persName" . $i;
                                    $personId = $rowGetInfo[$integer];
                                    $personName = $rowGetInfo[$persName];
                                    if (!is_numeric($personId))
                                        $personId = 0;
                                    if ($personId != 0) {
                                        if($flag_first) 
                                            $flag_first = false;
                                        else 
                                            print("<br />\n");
                                        $addi_deviceStr = GetDeviceFromPers($personId, $routeType);
                                        list($addi_deviceId, $addi_deviceTypeId) = explode("~~", $addi_deviceStr);
                                        print("<font");
                                        if($addi_deviceId == 0){
                                            print(" style=\"color:#ff0000\"");
                                        }
                                        print("/>");
                                        print("" . htmlentities($personName, ENT_QUOTES) . "");
                                        print("</font>");
                                    }
                                }//END for ($i = 1; $i <= 6; $i++)
                                print("</td>\n");
                                
				print("</tr>\n");
			}
		}
		print("</table>\n");

		print("<br /><div>");
		print("<input type=\"button\" value=\"Proceed to the Next Step\" onclick=\"location.href='../cm/doback.php?Back=$Back'\" />\n");
		print("</div>\n");

		// GET ITS INDEX
		for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
			if($pdFieldsArr[$tempi] == "checkdrivers") {
				$checkdrivers_index = $tempi;
				break;
			}
		}

		// prepare string
		$setStr = "";
		for($tempi = $checkdrivers_index + 1; $tempi < count($pdFieldsArr); $tempi++) {
			$setStr .= ", {$pdFieldsArr[$tempi]}as = 0, {$pdFieldsArr[$tempi]}dt = NULL";
		}

		//UPDATE PRODUCTDISPATCH RECORD
//		$qryUp = "UPDATE productdispatch
//					SET checkdriversdt = now(),
//					checkdriversas = $RecIdAS
//					" . $setStr . "
//					WHERE recid = $pdid";
		$qryUp = "UPDATE productdispatch
					SET checkdriversdt = now(),
					checkdriversas = $RecIdAS
					WHERE recid = $pdid";
		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
		}
		print("</div>\n");
		break;

	case "EditDriver":
		// VALIDATION
		ValidateForInt(false, "pdid", "srid");

		//GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$effdt = "";
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		print("<div class=\"datawhite\">");
		print("<b><u>Edit Driver</u></b><br /><br />\n");

		//GET DETAILS
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "specificroutes", $srid, "driverid", "message");
		if($rsltArr[rtvalue]) {
			$tempdriverid = $rsltArr[driverid];
			$msg = $rsltArr[message];
			if(!is_numeric($tempdriverid)) $tempdriverid = 0;
		}
		else {
			$tempdriverid = 0;
			$msg = "";
		}
		unset($rsltArr, $fileLineNbr);

		print("<form name=\"level2Form\" method=\"post\" action=\"tra37.php\">\n");
		print("<table  border=\"0\" cellpadding=\"6\" cellspacing=\"2\" width=\"50%\">\n");

		print("<tr><td class=\"entryscreenborder\">\n");
		print("<table  width=\"100%\" border=\"0\" bgcolor=\"white\" cellpadding=\"1\" cellspacing=\"1\">\n");

		// FOR DRIVER
		print("<tr>\n");
		print("<td class=\"datagrey\">Driver</td>\n");
		print("<td class=\"datawhite\">\n");

		if(!isset($driverid)) $driverid = $tempdriverid;

		$qryGetDR = "SELECT DISTINCT(p.recid), CONCAT_WS(', ' , NULLIF(p.lastname, ''),  NULLIF(p.firstname, '')) persname
					FROM person p, personlink pl, rolelink rl
					WHERE rl.role = 'DR'
					AND ( rl.endeffdt IS NULL OR rl.endeffdt = '0000-00-00'
					OR rl.endeffdt > '$curDate' )
					AND pl.recid = rl.personlinkid
					AND pl.locationid = $ASLocationID
					AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00'
					OR pl.endeffdt > '$curDate' )
					AND p.recid = pl.personid
					ORDER BY persname";
		if($debug)
			print($qryGetDR . "<br />\n");
		$rsltGetDR = mysqli_query( $cvtconnection, $qryGetDR);
		if(!$rsltGetDR) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}

		print("<select name=\"driverid\">\n");
		print("\t<option value=\"\">Select Driver</option>\n");
		if($rsltGetDR) {
			while($rowGetDR = mysqli_fetch_assoc($rsltGetDR)) {
				print("\t<option value=\"" . $rowGetDR[recid] . "\"");
				if($driverid == $rowGetDR[recid])
					print(" selected=\"selected\"");
				print(">");
				if($debug)
					print("" . $rowGetDR[recid] . " - ");
				print("" . htmlentities($rowGetDR[persname], ENT_QUOTES) . "</option>\n");
			}
		}
		print("</select>\n");

		print("</td>\n");
		print("</tr>\n");

		// FOR MESSAGE
		print("<tr>\n");
		print("<td class=\"datagrey\">Message</td>\n");
		print("<td class=\"datawhite\">");
		if(!isset($msg)) $msg = $tempmsg;
		print("<textarea name=\"msg\" style=\"width:100%\" rows=\"3\" cols=\"0\">" . htmlentities($msg, ENT_QUOTES) . "</textarea>\n");
		print("</td>\n");
		print("</tr>\n");

		print("</table>\n");
		print("</td></tr>\n");

		print("<tr><td>\n");
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
		print("<input type=\"hidden\" name=\"srid\" value=\"$srid\" />\n");
		print("<a href=\"javascript:SubmitEditDriver('UpdateDriver');\">Update</a>\n");
		print("</td></tr>\n");

		print("</table>\n");
		print("</form>\n");

		print("</div>\n");
		break;

	case "UpdateDriver":
		// VALIDATION
		ValidateForInt(false, "pdid", "srid", "driverid");
		ValidateForStr(false, "msg");

		// GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$effdt = "";
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		//UPDATE DRIVER
		$qryUp = "UPDATE specificroutes
					SET driverid = $driverid,
					message = '" . addslashes($msg) . "',
					archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
					WHERE recid = $srid
					AND dispatchlocid = $ASLocationID";

		// FOR SPLITTING OF TABLES
		$qryUp = convertToSplitTables($qryUp, $val_SPLIT);


		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
		}

		if($debug) {
			print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
		}
		else {
		    header("Location: " . urldecode($Back));
		}
		break;

	case "ToAddAddlDr":
		// VALIDATION
		ValidateForInt(false, "pdid", "srid");

		print("<div class=\"datawhite\">\n");

		// DISPLAY SPECIFICROUTINFO
		$selectStr = "CONCAT_WS(' - ', NULLIF(r.routenbr, ''), NULLIF(r.sdesc, ''), DATE_FORMAT(datesked, '%m/%d/%y'), TIME_FORMAT(timesked, '%H:%i:%s')) routeinfo";
		$fromStr = "specificroutes sr, route r";
		$whereStr = "sr.recid = $srid
					AND r.recid = sr.routeid
					AND sr.dispatchlocid = $ASLocationID";
		$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
		unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

		if($rsltArr) {
			$routeinfo = $rsltArr[routeinfo];
		}
		else {
			$routeinfo = "";
		}
		unset($rsltArr);

		print("<u><b>" . htmlentities($routeinfo, ENT_QUOTES) . "</b></u><br /><br />");
		print("<b>Temp Drivers</b><br /><br />\n");

		// QUERY TO GET INFORMATION
		$qryGetInfo = "SELECT DISTINCT(p.recid) persid, CONCAT_WS(', ', NULLIF(p.lastname, ''),
						NULLIF(p.firstname, '')) persname
						FROM tempdata td, person p
						WHERE td.jobtable = 'TRA37'
						AND activesessionid = $RecIdAS
						AND tablerecid = $srid
						AND p.recid = td.intvar
						ORDER BY p.lastname, p.firstname";
		if($debug)
			print($qryGetInfo . "<br />\n");

		print("<table border=\"1\" width=\"50%\">\n");
		print("<tr class=\"datatblhdr\">\n");
		print("<td align=\"center\">Del</td>\n");
		print("<td>Driver</td>\n");
		print("</tr>\n");

		$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
		$oddEven = 0;
		if(!$rsltGetInfo) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
				if( ( $oddEven++ % 2 ) == 0 ) {
					print("<tr class=\"datawhite\">\n");
				}
				else {
					print("<tr class=\"datagrey\">\n");
				}

				$persid = $rowGetInfo[persid];
				if(!is_numeric($persid)) $persid = 0;

				// FOR DEL
				$del = $rowGetInfo[del];
				print("<td align=\"center\"><a href=\"" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&doAction=DeleteAddlDr&pdid=$pdid&srid=$srid&persid=$persid", ENT_QUOTES) . "\"><img src=\"../img/del.gif\" border=\"0\" height=\"12\" width=\"12\" alt=\"\" /></a></td>\n");

				// FOR DRIVER
				$drivername = $rowGetInfo[persname];
				print("<td>");
				if($debug) print("$persid - ");
				print("" . htmlentities($drivername, ENT_QUOTES) . "</td>");

				print("</tr>\n");
			}
		}
		print("</table>\n");
		print("<br /><br />\n");

		print("<form name=\"level2Form\" method=\"post\" action=\"tra37.php\">\n");
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
		print("<input type=\"hidden\" name=\"srid\" value=\"$srid\" />\n");

		// GIVE DRIVER DROPLIST TO ADD
		$qryGetDR = "SELECT DISTINCT(p.recid), CONCAT_WS(', ' , NULLIF(p.lastname, ''), NULLIF(p.firstname, '')) persname
					FROM person p, personlink pl, rolelink rl
					WHERE rl.role = 'DR'
					AND ( rl.endeffdt IS NULL OR rl.endeffdt = '0000-00-00'
					OR rl.endeffdt > '$curDate' )
					AND pl.recid = rl.personlinkid
					AND pl.locationid = $ASLocationID
					AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00'
					OR pl.endeffdt > '$curDate' )
					AND p.recid = pl.personid
					ORDER BY persname";
		if($debug)
			print($qryGetDR . "<br />\n");
		$rsltGetDR = mysqli_query( $cvtconnection, $qryGetDR);
		if(!$rsltGetDR) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}

		print("<b>Driver : </b>");
		print("<select name=\"driverid\">\n");
		print("\t<option value=\"\">Select Driver</option>\n");
		if($rsltGetDR) {
			while($rowGetDR = mysqli_fetch_assoc($rsltGetDR)) {
				print("\t<option value=\"" . $rowGetDR[recid] . "\"");
				if($driverid == $rowGetDR[recid])
					print(" selected=\"selected\"");
				print(">");
				if($debug)
					print("" . $rowGetDR[recid] . " - ");
				print("" . htmlentities($rowGetDR[persname], ENT_QUOTES) . "</option>\n");
			}
		}
		print("</select>\n");
		print("<br /><br />\n");

		print("<a href=\"javascript:SubmitLevel2Form('AddAddlDr');\">Add</a>\n");
		print("</form>\n");
		print("</div>\n");
		break;

	case "AddAddlDr":
		// VALIDATION
		ValidateForInt(false, "pdid", "srid", "driverid");

		// FIRST CHECK IF TEMPDATA RECORD EXIST FOR SRID OR NOT
		$qryChkRecs = "SELECT COUNT(*) FROM tempdata
						WHERE jobtable = 'TRA37'
						AND activesessionid = $RecIdAS
						AND tablerecid = $srid
						AND intvar = $driverid";
		if($debug)
			print($qryChkRecs . "<br />\n");
		$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
		$flagExist = false;
		if(!$rsltChkRecs) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($rowChkRecs = mysqli_fetch_row($rsltChkRecs)) {
				$NoRecs = $rowChkRecs[0];
				if(!is_numeric($NoRecs)) $NoRecs = 0;
				if($NoRecs > 0) $flagExist = true;
			}
		}

		if(!$flagExist) {
			// INSERT A NEW RECORD
			$qryIns = "INSERT INTO tempdata(jobtable, activesessionid, tablerecid,
						intvar)
						VALUES('TRA37', $RecIdAS, $srid,
						" . $driverid . ")";
			if($debug)
				print("<b>" . $qryIns . "</b><br />\n");
			$rsltIns = mysqli_query( $cvtconnection, $qryIns);
			if(!$rsltIns) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if($debug)
					print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
			}
		}

		if($debug) {
			print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
		}
		else {
		    header("Location: " . urldecode($Back));
		}
		break;

	case "DeleteAddlDr":
		// VALIDATION
		ValidateForInt(false, "pdid", "srid", "persid");

		// DELETE THE RECORD FROM TEMPDATA TABLE
		$qryDel = "DELETE FROM tempdata
					WHERE jobtable = 'TRA37'
					AND activesessionid = $RecIdAS
					AND tablerecid = $srid
					AND intvar = $persid";
		if($debug)
			print("<b>" . $qryDel . "</b><br />\n");
		$rsltDel = mysqli_query( $cvtconnection, $qryDel);
		if(!$rsltDel) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 04);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
		}

		if($debug) {
			print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
		}
		else {
		    header("Location: " . urldecode($Back));
		}
		break;

	case "CreateRunRecs":
		#$debug = 1;
		// VALIDATION
		ValidateForInt(false, "pdid");

		// VERSR - VERSION OF DP PROGRAM USED FOR STANDARD ROUTES
		$val_VERSR = GetLSVar("VERSR", "strvar", $ASLocationID, $cvtconnection);
		if($debug) print("VERSR = $val_VERSR<br />\n");

		// VERRR - VERSION OF DP PROGRAM USED FOR RETURNS ROUTES
		$val_VERRR = GetLSVar("VERRR", "strvar", $ASLocationID, $cvtconnection);
		if($debug) print("VERRR = $val_VERRR<br />\n");

		// VERCO - VERSION OF DP PROGRAM USED FOR COLLECTION ROUTES
		$val_VERCO = GetLSVar("VERCO", "strvar", $ASLocationID, $cvtconnection);
		if($debug) print("VERCO = $val_VERCO<br />\n");
		
		// PHRTE - Find any SpecificRouteLocs on Shadow routes
		$val_PHRTE = GetLSVar("PHRTE", "charvar", $ASLocationID, $cvtconnection);
		if($debug) print("PHRTE = $val_PHRTE<br />\n");
                /*Task#8329 Start*/ 
                // FINDR - TIMEOUT TIME DEFINE IN INTVAR
		$intvar_FINDR = GetLSVar("FINDR", "intvar", $ASLocationID, $cvtconnection);
		if($debug) print("FINDR = $intvar_FINDR<br />\n");
                if (!is_numeric($intvar_FINDR))
                $intvar_FINDR = 60;
                /*Task#8329 End*/
		// GET OUR STANDARD ARRAYS
		$stdrt_array = GeneralArray("routetype_standard");
		if($val_HAWKS == 'Y') {
			if(!in_array('AM', $stdrt_array)) {
				array_push($stdrt_array, 'AM');
			}
			if(!in_array('PM', $stdrt_array)) {
				array_push($stdrt_array, 'PM');
			}
			if(!in_array('TR', $stdrt_array)) {
				array_push($stdrt_array, 'TR');
			}
		}
		$rtcolrt_array = GeneralArray("routetype_returncol");

		if($val_ESRTE == "Y") {
			array_push($rtcolrt_array, 'ER');
		}

		// GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt", "routesetid rsId", "returnsroutesetid rsRsId");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
			$rsId = $rsltArr[rsId];
			$rsRsId = $rsltArr[rsRsId];
			ValidateForInt(false, "rsId", "rsRsId");
		}
		else {
			$effdt = "";
			$dbEffDt = "";
			$rsId = 0;
			$rsRsId = 0;
		}
		unset($rsltArr, $fileLineNbr);

		$rsIdArr = array($rsId, $rsRsId);
		$rsIdStr = MakeStr_TRA37($rsIdArr);
		if($rsIdStr == "") $rsIdStr = "0";
		
		if($rsId != 0)$rsIdN = $rsId;

		// LETS FIRST SET THE REDEPLOY CASE TRANSACTIVITY RECORDS.
		//SetReDepMulTA_TRA37($redepmul_array, $dbEffDt);
		
		
		// Now Setting for SHADOW Route
		//$debug = 1;
                
		if($val_PHRTE == "Y")
		{
		
			$DelRouteIdArr = array(); /*Task#8329*/ 
			if($debug)
				print("######## SHADOW Route  LOGIC START ###########<br />\n");

			$qryGetESSrlInfo = "SELECT sr.recid, r.redeliveryrouteid,srl.locationid,srl.recid SpLocRecId,  srl.relativetime, srl.comment , r.type  rtype
								FROM route r, specificroutes sr, specificrouteloc srl, location l, transactivity ta
								WHERE r.locationid = $ASLocationID
								AND ta.specificrouteid = sr.recid 
								AND ta.locationid = $ASLocationID
								AND ta.customerlocid = srl.locationid
								AND ta.type IN ('PP','PD')
								AND ta.actquantity > 0
								/*AND r.type IN ('SH')*/
								AND sr.routeid = r.recid
								AND sr.dispatchlocid = $ASLocationID
								AND sr.datesked = '$dbEffDt'
								AND srl.specificrouteid = sr.recid
								AND srl.clientlocid = $ASLocationID
								AND srl.locationid = l.recid
								AND l.type != 'G'
								GROUP BY srl.locationid,sr.recid
								ORDER BY srl.locationid
								";

			// FOR SPLITTING OF TABLES
			$qryGetESSrlInfo = convertToSplitTables($qryGetESSrlInfo, $val_SPLIT);

			if($debug)
				print("qryGetESSrlInfo:".$qryGetESSrlInfo . "<br />\n");
			$rsltGetESSrlInfo = mysqli_query( $cvtconnection, $qryGetESSrlInfo);
			if(!$rsltGetESSrlInfo) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				while($rowGetESSrlInfo = mysqli_fetch_assoc($rsltGetESSrlInfo)) {
				
					$SrRecId = $rowGetESSrlInfo[recid];
					$SrLocationId = $rowGetESSrlInfo[locationid];
					$SrRelativeTime = $rowGetESSrlInfo[relativetime];
					$Srcomment = $rowGetESSrlInfo[comment];
					$ReDelRouteId = $rowGetESSrlInfo[redeliveryrouteid];
					$SpLocRecId =  $rowGetESSrlInfo[SpLocRecId];
					$rtype =  $rowGetESSrlInfo[rtype];
					ValidateForInt(false, "ReDelRouteId");
					if($debug)
						print("SHADOW ReDelRouteId:-->$ReDelRouteId ---$SrRecId--$SrLocationId--$SrRelativeTime--$Srcomment--------SpLocRecId :$SpLocRecId-------RouteType:$rtype <br />\n");
					
					$NewSPLocRecId = '';
					if($rtype  != 'SH')
					{
						$selInfo = "SELECT locationid, if(type = 'PP','SP','SD') newtype, specificproductid  
												FROM transactivity ta
												WHERE ta.specificrouteid = $SrRecId 
												AND ta.locationid = $ASLocationID
												AND ta.customerlocid = $SrLocationId
												AND ta.type IN ('PP','PD')
												AND ta.actquantity > 0";
									$selInfo = convertToSplitTables($selInfo, $GLOBALS[val_SPLIT]);
									

										if($debug)
											print("<b>" . $selInfo . "</b><br />\n");
										$rslUpdInfo = mysqli_query( $cvtconnection, $selInfo);
										if(!$rslUpdInfo) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 03);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
									while($rowupdInfo = mysqli_fetch_assoc($rslUpdInfo))
									{
										$SpProdId = $rowupdInfo['specificproductid'];
										$UpdType = $rowupdInfo['newtype'];
										
										$updTr = "Update transactivity ta
												  SET locationid = $val_DELCO,archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
												  WHERE locationid = $ASLocationID  
												  /*AND ta.specificrouteid = $SrRecId*/
												AND ta.locationid = $ASLocationID
												AND ta.customerlocid = $SrLocationId
												AND ta.specificproductid = '$SpProdId'
												AND ta.type = '$UpdType'
												AND ta.actquantity > 0";
										$qryUpd = convertToSplitTables($updTr, $val_SPLIT);

										if($debug)
											print("<b>" . $qryUpd . "</b><br />\n");
										$rsltUp = mysqli_query( $cvtconnection, $qryUpd);
										if(!$rsltUp) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 03);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
									
									}
									
											$qryIns = "INSERT INTO transactivity(locationid, type,
																		customerlocid, specificrouteid, personid,
																		specificproductid, actquantity,
																		datet,timet, unitcost , unitsales,unitcostcust,unitsalesvend,activesession,
																		closeddatecust,closeddatevend, closeddatevendinv, closeddatecustpay)
												SELECT locationid, if(type = 'PP','SP','SD') newtype,
													   customerlocid, specificrouteid, personid,
														specificproductid, actquantity,
														datet,timet, unitcost , unitsales,unitcostcust,unitsalesvend, '$GLOBALS[RecIdAS]', 
														closeddatecust,closeddatevend, closeddatevendinv, closeddatecustpay  FROM transactivity ta
												WHERE ta.specificrouteid = $SrRecId 
												AND ta.locationid = $ASLocationID
												AND ta.customerlocid = $SrLocationId
												AND ta.type IN ('PP','PD')
												AND ta.actquantity > 0";
											$qryIns = convertToSplitTables($qryIns, $GLOBALS[val_SPLIT]);

											if($debug)
												print("<b>" . $qryIns . "</b><br />\n");
											$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
											if(!$rsltIns) {
												$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 02);
												print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
														
											}
					}else
					{
					
					if($ReDelRouteId)
					{
						$getSpRtId =  "Select recid from specificroutes where dispatchlocid = '$ASLocationID' AND routeid = $ReDelRouteId AND  datesked = '$dbEffDt'";
						$getSpRtId = convertToSplitTables($getSpRtId, $val_SPLIT);
						if($debug)
							print($getSpRtId . "<br />\n");
						$rsltGetSpRtId = mysqli_query( $cvtconnection, $getSpRtId);
						if(!$rsltGetSpRtId) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
						
							$rowSpRtId = mysqli_fetch_assoc($rsltGetSpRtId);
							$NewSpRtId = $rowSpRtId['recid'];
							if($NewSpRtId)
							{
								
								
								$qryCnt = "SELECT recid  from specificrouteloc WHERE clientlocid ='$ASLocationID' AND specificrouteid = $NewSpRtId AND locationid = $SrLocationId";
								$qryCnt = convertToSplitTables($qryCnt, $val_SPLIT);
								if($debug)
									print($qryCnt . "<br />\n");
								$rsltGetCnt = mysqli_query( $cvtconnection, $qryCnt);
								if(!$rsltGetCnt) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}else
								{
									$rowCnt = mysqli_fetch_assoc($rsltGetCnt);
									$NewSPLocRecId = $rowCnt['recid'];
									if(!$NewSPLocRecId)
									{
									$qryIns = "INSERT INTO specificrouteloc(clientlocid , specificrouteid, locationid,  relativetime, comment ) VALUES('$ASLocationID','$NewSpRtId','$SrLocationId','$SrRelativeTime','$Srcomment')";
									$InsSpRtLoc = convertToSplitTables($qryIns, $val_SPLIT);
									if($debug)
										print($InsSpRtLoc . "<br />\n");
									$rsltInsSpRtLoc = mysqli_query( $cvtconnection, $InsSpRtLoc); 
									$NewSPLocRecId = getLastInsertId();
									if(!$rsltInsSpRtLoc) { /*Task#8329*/
										$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
										print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
										unset($fileLineNbr);
									}//END IF /*Task#8329 Start*/ 
                                                                        else
                                                                        {
                                                                           if(!in_array($ReDelRouteId, $DelRouteIdArr))
                                                                               array_push ($DelRouteIdArr, $ReDelRouteId);
                                                                        } /*Task#8329 End*/
									}//END IF (CntRow = 0)
									
									/*$qryTR = "SELECT *  FROM transactivity ta
												WHERE ta.specificrouteid = $SrRecId 
												AND ta.locationid = $ASLocationID
												AND ta.customerlocid = $SrLocationId
												AND ta.type IN ('PP','PD')
												AND ta.actquantity != 0";
								$qryTR = convertToSplitTables($qryTR, $val_SPLIT);
								if($debug)
									print($qryTR . "<br />\n");
								$rsltGetTR = mysql_query($qryTR, $cvtconnection);
								if(!$rsltGetTR) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}else
								{	
									while($rowGetTR = mysql_fetch_assoc($rsltGetTR))
									{*/
									$selInfo = "SELECT locationid, if(type = 'PP','SP','SD') newtype,specificproductid  
												FROM transactivity ta
												WHERE ta.specificrouteid = $SrRecId 
												AND ta.locationid = $ASLocationID
												AND ta.customerlocid = $SrLocationId
												AND ta.type IN ('PP','PD')
												AND ta.actquantity > 0";
									$selInfo = convertToSplitTables($selInfo, $GLOBALS[val_SPLIT]);
									

										if($debug)
											print("<b>" . $selInfo . "</b><br />\n");
										$rslUpdInfo = mysqli_query( $cvtconnection, $selInfo);
										if(!$rslUpdInfo) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 03);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
									while($rowupdInfo = mysqli_fetch_assoc($rslUpdInfo))
									{
										$SpProdId = $rowupdInfo['specificproductid'];
										$UpdType = $rowupdInfo['newtype'];
										
										$updTr = "Update transactivity ta
												  SET locationid = $val_DELCO,archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
												  WHERE locationid = $ASLocationID  
												 /* AND ta.specificrouteid = $NewSpRtId*/
												AND ta.locationid = $ASLocationID
												AND ta.customerlocid = $SrLocationId
												AND ta.specificproductid = '$SpProdId'
												AND ta.type = '$UpdType'
												AND ta.actquantity > 0";
										$qryUpd = convertToSplitTables($updTr, $val_SPLIT);

										if($debug)
											print("<b>" . $qryUpd . "</b><br />\n");
										$rsltUp = mysqli_query( $cvtconnection, $qryUpd);
										if(!$rsltUp) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 03);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
									
									}
									
											$qryIns = "INSERT INTO transactivity(locationid, type,
																		customerlocid, specificrouteid, personid,
																		specificproductid, actquantity,
																		datet,timet, unitcost , unitsales,unitcostcust,unitsalesvend,activesession,
																		closeddatecust,closeddatevend, closeddatevendinv, closeddatecustpay)
												SELECT locationid, if(type = 'PP','SP','SD') newtype,
													   customerlocid, $NewSpRtId, personid,
														specificproductid, actquantity,
														datet,timet, unitcost , unitsales,unitcostcust,unitsalesvend, '$GLOBALS[RecIdAS]', 
														closeddatecust,closeddatevend, closeddatevendinv, closeddatecustpay  FROM transactivity ta
												WHERE ta.specificrouteid = $SrRecId 
												AND ta.locationid = $ASLocationID
												AND ta.customerlocid = $SrLocationId
												AND ta.type IN ('PP','PD')
												AND ta.actquantity > 0";
											$qryIns = convertToSplitTables($qryIns, $GLOBALS[val_SPLIT]);

											if($debug)
												print("<b>" . $qryIns . "</b><br />\n");
											$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
											if(!$rsltIns) {
												$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 02);
												print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
														
											}
											
											$sleSpLink = "Select spl.specificproductid,spl.pude from specificproductlink spl, transactivity tr 
														WHERE spl.clientlocid = '$ASLocationID' 
														AND spl.specificproductid = tr.specificproductid 
														AND tr.specificrouteid = '$SrRecId' 
														AND tr.customerlocid = $SrLocationId 
														AND spl.specificroutelocid = '$SpLocRecId'";								
											$sleSpLink = convertToSplitTables($sleSpLink, $GLOBALS[val_SPLIT]);

											if($debug)
												print("<b>" . $sleSpLink . "</b><br />\n");
											$rsltSpLink = mysqli_query( $GLOBALS[cvtconnection], $sleSpLink);
											if(!$rsltSpLink) {
												$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 02);
												print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
														
											}else{
											while($rowSpLink = mysqli_fetch_assoc($rsltSpLink))
											{
												$splProdId = $rowSpLink[specificproductid];
												$splProdpude = $rowSpLink[pude];
												$getCnt = "Select COUNT(1) rowcnt From specificproductlink spl where spl.clientlocid = '$ASLocationID' 
														AND spl.specificproductid = $splProdId 
														AND spl.specificroutelocid = '$NewSPLocRecId' ";
												if($debug)
												print("<b>" . $getCnt . "</b><br />\n");
												$rsltCnt = mysqli_query( $GLOBALS[cvtconnection], $getCnt);
												if(!$rsltCnt) {
													$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 02);
													print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
															
													}else{
													
														$RowProdcnt = mysqli_fetch_assoc($rsltCnt);
														
														$ProdCnt = $RowProdcnt['rowcnt'];
														if($ProdCnt == 0)
														{
															$insQry = "Insert into specificproductlink (clientlocid,specificproductid,specificroutelocid,pude) VALUES('$ASLocationID','$splProdId ','$NewSPLocRecId','$splProdpude')";
															
															if($debug)
															print("<b>" . $insQry . "</b><br />\n");
															$rsltInsQry = mysqli_query( $GLOBALS[cvtconnection], $insQry);
															if(!$rsltInsQry) {
																$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 02);
																print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
																		
																}
														}
													
													
													}		
											
											}
											
											}
									
									 //}END While
									//}END Else
								}//END CNT Else
							}//END IF (NewSpRtId)
						
						}//END Else

					}//IF(ReDelRouteId)
					
					}//else(rtype != 'SH')
				}//  END ReRouteId While
			}//Else ReRouteId fetch	
		
		
		/*Task#8329 Start*/ 
		if(count($DelRouteIdArr)>0)
                {
                    $routeIdStr = implode(',', $DelRouteIdArr);
                    $cnt = 0;
                    $qryIns = "INSERT /*tra37*/ INTO routesmarttrack(clientlocid, solvertype, routeid, deliverydate,datetime, processstatus)
				      VALUES($ASLocationID, 'Sequence Existing Routes', '$routeIdStr', '$dbEffDt', NOW(),0)";
	                if($debug) print("<b>" . $qryIns . "</b><br />\n");
	                $rsltIns = mysqli_query( $cvtconnection, $qryIns);
                        
                    if(!$rsltIns) {
	                $fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
	                print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
	                unset($fileLineNbr);
	                  }
		    else{
                    $rsmtRecid = mysqli_insert_id($cvtconnection);  
		    }	
                    if($rsmtRecid != '')
                    {
                    while($cnt < $intvar_FINDR && $rsmtRecid != '')
                    {
                           $qryGetStatus1 = "SELECT /*tra37*/ recid,processstatus ,DATE_FORMAT(datetime, '%m/%d/%y %T') datetime from routesmarttrack WHERE clientlocid = '$ASLocationID' AND recid = '$rsmtRecid' ";
               
                            if($debug) print($qryGetStatus1."<br />\n");
                            $rsltGetStatus1 = mysqli_query( $cvtconnection, $qryGetStatus1);
                            if (!$rsltGetStatus1)
                            {
                             $fileLineNbr = __LINE__;
                             $strErrorCode = getErrorCode(01, 01);
                             print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
                             unset($fileLineNbr);
                            }
                            else
                            {
                            $rowGetStatus1 = mysqli_fetch_assoc($rsltGetStatus1);
                            $processstatus = $rowGetStatus1['processstatus'];
                            $procesdttime = $rowGetStatus1['datetime'];
                            }
              
               
                            if(isset($processstatus) && $processstatus > 0)
                            {
                            $cnt = $intvar_FINDR + 10;
                            }
                            else
                            {
                            sleep(1);
                            $cnt++; 
                            }
             
                    }
                    }
                }
		/*Task#8329 End*/  
		if($debug)
				print("######## SHADOW Route  LOGIC END ###########<br />\n");
		
	
		}//if(val_PHRTE)
		
		
		// NOW SETTING EARLY SUPPLY ROUTES.
		if($val_ESRTE == "Y") {

			if($debug)
				print("######## EARLY SUPPLY START ###########<br />\n");

			$qryGetESSrlInfo = "SELECT sr.recid srId, srl.locationid srLocId,
								sr.driverid srDriverId
								FROM route r, specificroutes sr, specificrouteloc srl, location l
								WHERE r.locationid = $ASLocationID
								AND r.type IN ('ES', 'ER')
								AND sr.routeid = r.recid
								AND sr.dispatchlocid = $ASLocationID
								AND sr.datesked = '$dbEffDt'
								AND srl.specificrouteid = sr.recid
								AND srl.clientlocid = $ASLocationID
								AND srl.locationid = l.recid
								AND l.type != 'G'
								ORDER BY srl.locationid";

			// FOR SPLITTING OF TABLES
			$qryGetESSrlInfo = convertToSplitTables($qryGetESSrlInfo, $val_SPLIT);

			if($debug)
				print($qryGetESSrlInfo . "<br />\n");
			$rsltGetESSrlInfo = mysqli_query( $cvtconnection, $qryGetESSrlInfo);
			if(!$rsltGetESSrlInfo) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				while($rowGetESSrlInfo = mysqli_fetch_assoc($rsltGetESSrlInfo)) {

					$srId = $rowGetESSrlInfo[srId];
					$srLocId = $rowGetESSrlInfo[srLocId];
					$srDriverId = $rowGetESSrlInfo[srDriverId];
					ValidateForInt(false, "srId", "srLocId", "srDriverId");
					if($debug)
						print("$srId, $srLocId, $srDriverId<br />\n");

					// NOW CHECKING TRANSACTIVITY SD RECORDS
					$qryGetTransActInfo = "SELECT ta.recid taId, ta.specificproductid spId,
											sp.productid spProdId, ta.actquantity taQty,
											DATE_FORMAT(sp.datex, '%Y-%m-%d') dbDateX,
											COUNT(IF(ta.specificrouteid = $srId, 1, NULL)) esCnt
											FROM transactivity ta, specificproduct sp
											WHERE ta.locationid = $ASLocationID
											AND ta.customerlocid = $srLocId
											AND ta.type = 'SD'
											AND ta.datet = '$dbEffDt'
											AND ta.actquantity != 0
											AND sp.recid = ta.specificproductid
											GROUP BY ta.specificproductid
											HAVING esCnt = 0";

					// FOR SPLITTING OF TABLES
					$qryGetTransActInfo = convertToSplitTables($qryGetTransActInfo, $val_SPLIT);

					if($debug)
						print($qryGetTransActInfo . "<br />\n");
					$rsltGetTransActInfo = mysqli_query( $cvtconnection, $qryGetTransActInfo);
					if(!$rsltGetTransActInfo) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						while($rowGetTransActInfo = mysqli_fetch_assoc($rsltGetTransActInfo)) {

							$taId = $rowGetTransActInfo[taId];
							$spId = $rowGetTransActInfo[spId];
							$spProdId = $rowGetTransActInfo[spProdId];
							$taQty = $rowGetTransActInfo[taQty];
							$dbDateX = $rowGetTransActInfo[dbDateX];
							ValidateForInt(false, "taId", "spId", "spProdId", "taQty");

							if($debug)
								print("$taId, $spId, $spProdId, $taQty, $dbDateX<br />\n");

							// CHECK WHETHER THERE EXISTS RELATED 'SR' ENTRY FOR THE LOCATION IF NOT WE WILL BE CONSIDERING qtyXXX VALUE INSTEAD OF qtyes

							$routeTypeStr = "'SR', 'PR'";

							if($val_HAWKS == "Y") {
								$routeTypeStr .= ", 'AM', 'PM', 'TR'";
							}

							$qryChkRecs = "SELECT COUNT(DISTINCT(sr.recid)) srCnt
											FROM route r, specificroutes sr, specificrouteloc srl 
											WHERE r.locationid = $ASLocationID
											AND r.type IN($routeTypeStr)
											AND sr.routeid = r.recid
											AND sr.dispatchlocid = $ASLocationID
											AND sr.datesked = '$dbEffDt'
											AND srl.specificrouteid = sr.recid
											AND srl.clientlocid = $ASLocationID
											AND srl.locationid = $srLocId";

							// FOR SPLITTING OF TABLES
							$qryChkRecs = convertToSplitTables($qryChkRecs, $val_SPLIT);

							if($debug)
								print($qryChkRecs . "<br />\n");
							$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
							if(!$rsltChkRecs) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
								$srCnt = 0;
							}
							else {
								$rowChkRecs = mysqli_fetch_assoc($rsltChkRecs);
								$srCnt = $rowChkRecs[srCnt];
							}

							if($srCnt == 0) {

								// FETCH THE DAY
								$dowEffDt = strtolower(date("D", mktime(0, 0, 0, substr($dbEffDt, 5, 2), substr($dbEffDt, 8, 2), substr($dbEffDt, 0, 4))));

								// NOW FINDING THE STANDARDRAW RECORD
								$strQty = "qty" . $dowEffDt;
								$selectStr = "$strQty sdQty, qtyes esQty";
								$fromStr = "standarddraw";
								$whereStr = "clientlocid = $ASLocationID
											AND customerlocid = $srLocId
											AND productid = $spProdId
											AND effdt <= '$dbDateX'
											ORDER BY effdt DESC
											LIMIT 1";
								$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
								unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

								if($rsltArr) {
									$sdQty = $rsltArr[sdQty];
									if(!is_numeric($sdQty))	$sdQty = 0;
								}
								else {
									$sdQty = 0;
								}
								unset($rsltArr);
								if($debug)
									print("<b>sdQty = $sdQty</b><br />\n");

								// CHECK WHETHERE ANY SPECIALDRAW EXISTS ON THAT DATE
								$selectStr = "COUNT(recid) spCnt, SUM(quantity) spQty";
								$fromStr = "specialdraw";
								$whereStr = "clientlocid = $ASLocationID
											AND productid = $spProdId
											AND specificproductdate = '$dbEffDt'
											AND locationid = $srLocId";
								$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
								unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

								if($rsltArr) {
									$spCnt = $rsltArr[spCnt];
									$spQty = $rsltArr[spQty];
									if(!is_numeric($spQty)) $spQty = 0;
								}
								else {
									$spQty = 0;
									$spCnt = 0;
								}

								unset($rsltArr);

								if($spCnt > 0) {
									$sdQty = $spQty;
								}
								if(!is_numeric($sdQty)) $sdQty = 0;

								if($sdQty != 0) {

									$qtyDiff = $taQty - $sdQty;
									if(!is_numeric($qtyDiff))	$qtyDiff = 0;

									if($qtyDiff == 0) {

										$qryUp = "UPDATE transactivity
													SET specificrouteid = $srId,
													personid = $srDriverId,
													activesession = $RecIdAS,
													archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
													WHERE recid = $taId";

										// FOR SPLITTING OF TABLES
										$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

										if($debug)
											print("<b>" . $qryUp . "</b><br />\n");
										$rsltUp = mysqli_query( $cvtconnection, $qryUp);
										if(!$rsltUp) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 03);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											if($debug)
												print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
										}
									}
									elseif($qtyDiff > 0) {

										// INSERTING NEW SD RECORD FOR "ES" ROUTE
										$fileLineNbr = __LINE__; $qryIns = CreateRecordCopyGeneral("transactivity", $taId, $cvtconnection,
											"specificrouteid", $srId,
											"personid", $srDriverId,
											"actquantity", $sdQty,
											"activesession", $RecIdAS
										);

										// FOR SPLITTING OF TABLES
										$qryIns = convertToSplitTables($qryIns, $val_SPLIT);

										if($debug)
											print("<b>" . $qryIns . "</b><br />\n");
										$rsltIns = mysqli_query( $cvtconnection, $qryIns);
										if(!$rsltIns) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 02);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											if($debug)
												print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
										}

										// UPDATING CURRENT RECORD TO DECREASE ES QUANTITY
										$qryUp = "UPDATE transactivity
													SET actquantity = $qtyDiff,
													archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
													WHERE recid = $taId";

										// FOR SPLITTING OF TABLES
										$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

										if($debug)
											print("<b>" . $qryUp . "</b><br />\n");
										$rsltUp = mysqli_query( $cvtconnection, $qryUp);
										if(!$rsltUp) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 03);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											if($debug)
												print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
										}
									}
								}
							}
							else {
								// NOW FINDING THE STANDARDRAW RECORD
								$selectStr = "qtyes esQty";
								$fromStr = "standarddraw";
								$whereStr = "clientlocid = $ASLocationID
											AND customerlocid = $srLocId
											AND productid = $spProdId
											AND effdt <= '$dbDateX'
											ORDER BY effdt DESC
											LIMIT 1";
								$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
								unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

								if($rsltArr) {
									$esQty = $rsltArr[esQty];
									if(!is_numeric($esQty))	$esQty = 0;
								}
								else {
									$esQty = 0;
								}
								unset($rsltArr);
								if($debug)
									print("<b>esQty = $esQty</b><br />\n");

								if($esQty != 0) {

									$qtyDiff = $taQty - $esQty;
									if(!is_numeric($qtyDiff))	$qtyDiff = 0;

									if($qtyDiff == 0) {

										$qryUp = "UPDATE transactivity
													SET specificrouteid = $srId,

													personid = $srDriverId,
													activesession = $RecIdAS,
													archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
													WHERE recid = $taId";

										// FOR SPLITTING OF TABLES
										$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

										if($debug)
											print("<b>" . $qryUp . "</b><br />\n");
										$rsltUp = mysqli_query( $cvtconnection, $qryUp);
										if(!$rsltUp) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 03);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											if($debug)
												print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
										}
									}
									elseif($qtyDiff > 0) {

										// INSERTING NEW SD RECORD FOR "ES" ROUTE
										$fileLineNbr = __LINE__; $qryIns = CreateRecordCopyGeneral("transactivity", $taId, $cvtconnection,
											"specificrouteid", $srId,
											"personid", $srDriverId,
											"actquantity", $esQty,
											"activesession", $RecIdAS
										);

										// FOR SPLITTING OF TABLES
										$qryIns = convertToSplitTables($qryIns, $val_SPLIT);

										if($debug)
											print("<b>" . $qryIns . "</b><br />\n");
										$rsltIns = mysqli_query( $cvtconnection, $qryIns);
										if(!$rsltIns) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 02);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											if($debug)
												print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
										}

										// UPDATING CURRENT RECORD TO DECREASE ES QUANTITY
										$qryUp = "UPDATE transactivity
													SET actquantity = $qtyDiff,
													archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
													WHERE recid = $taId";

										// FOR SPLITTING OF TABLES
										$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

										if($debug)
											print("<b>" . $qryUp . "</b><br />\n");
										$rsltUp = mysqli_query( $cvtconnection, $qryUp);
										if(!$rsltUp) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 03);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											if($debug)
												print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
										}
									}
								}
							}
						}
					}
				}
			}

			if($debug)
				print("######## EARLY SUPPLY END ###########<br />\n");
		}

		// NOW CREATING RESUPPLY ROUTE RELATED RECORDS
		createReSupplyRecs_TRA37($dbEffDt);

		// GET THEIR TYPES
		$qryGetRST = "SELECT recid, type
					FROM routeset
					WHERE recid IN (" . $rsIdStr . ")";
		if($debug)
			print($qryGetRST . "<br />\n");
		$rsltGetRST = mysqli_query( $cvtconnection, $qryGetRST);
		$rsinfo_array = array();
		if(!$rsltGetRST) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			while($rowGetRST = mysqli_fetch_assoc($rsltGetRST)) {
				$rsId = $rowGetRST[recid];
				$rsType = $rowGetRST[type];
				if(!is_numeric($rsId)) $rsId = 0;

				$rsinfo_array[$rsId] = $rsType;
			}
		}

		// GET ROUTESET.TYPE
		//$rsType = GetDescription("routeset", $rsId, "type");

		//FIRST WE NEED TO DELETE SPECIFICROUTES RECORDS WHOSE ROUTEID
		//DOES NOT EXIST IN THE PD.ROUTESETID
		$routes_str = "";
		/*
			NOW GET ALL RELATED SPECIFICROUTES ONE BY ONE AND DO THE FOLLOWING
			SET IT'S STATUS TO A
			SET RELATD TRANSACTIVITY.SPECIFICROUTESID
			CREATE RDSEND RECORD IF NOT EXIST
		*/
		/*$qryGetInfo = "SELECT DISTINCT(sr.recid), sr.driverid
						FROM specificroutes sr, route r, routesetdetail rsd
						WHERE rsd.routesetid = $rsId
						AND r.recid = rsd.routeid
						AND r.locationid = $ASLocationID
						AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
						OR r.endeffdt > '$curDate' )
						AND sr.routeid = r.recid
						AND sr.datesked = '$dbEffDt'
						AND sr.sentflag = 'N'
						ORDER BY sr.recid";*/

		//IF LOCATIONSYSTEM RRCOM = "N", DO NOT CREATE RDSEND RECORDS FOR RETURNS ROUTES.  IN OTHER WORDS, IF RRCOM = N, RETURNS ROUTES WILL NOT BE LOADED TO THE HANDHELD DEVICE
		$val_RRCOM = GetLSVar("RRCOM", "charvar", $ASLocationID, $cvtconnection);

		$qryGetInfo = "SELECT DISTINCT sr.recid srId, sr.driverid srDriverId, r.type routeType,
                                str.integer1, str.integer2, str.integer3, 
                                str.integer4, str.integer5, str.integer6
                                FROM specificroutes sr, route r
                                    LEFT JOIN storeretrieve str
                                        ON str.clientid = '$ASCompanyID'
                                        AND str.clientlocid = '$ASLocationID'
                                        AND str.type = 'H'
                                        AND str.bigint1 = r.recid
                                WHERE r.locationid = $ASLocationID
                                AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
                                OR r.endeffdt > '$curDate' )
                                AND sr.routeid = r.recid
                                AND sr.datesked = '$dbEffDt'
                                AND sr.dispatchlocid = $ASLocationID
                                ORDER BY sr.recid";
                                /*AND sr.sentflag = 'N'*/

		// FOR SPLITTING OF TABLES
		$qryGetInfo = convertToSplitTables($qryGetInfo, $val_SPLIT);

		if($debug)
			print($qryGetInfo . "<br />\n");
		$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
		if(!$rsltGetInfo) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
				$srId = $rowGetInfo[srId];
				$srDriverId = $rowGetInfo[srDriverId];
				$routeType = $rowGetInfo[routeType];
				ValidateForInt(false, "srId", "srDriverId");

				//SET STATUS TO A
				$qryUp = "UPDATE specificroutes
							SET status = 'A',
							archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
							WHERE recid = $srId
							AND dispatchlocid = $ASLocationID";

				// FOR SPLITTING OF TABLES
				$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

				if($debug)
					print("<b>" . $qryUp . "</b><br />\n");
				$rsltUp = mysqli_query( $cvtconnection, $qryUp);
				if(!$rsltUp) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 03);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if($debug)
						print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
				}

				// IF ROUTESET.TYPE = RR OR CR
				// LET'S FIRST SET ANY PREVIOUS SP RECORDS FOR WHICH THERE DOES NOT EXIST
				// A CORRESPONDING PU RECORD.
				/*
				if($debug) print("rsType = $rsType<br />");
				if($rsType == "RR" || $rsType == "CR")
				*/
				if($debug) {
					print("routeType = $routeType<br />");
					print("rtcolrt_array = ");
					print_r($rtcolrt_array);
					print("<br />\n");
				}

				if(in_array($routeType, $rtcolrt_array))
					MapPreviousSP_TRA37($srId);

				//UPDATE TRANSACTIVITY RECORDS - IN A FUNCTION
				if(MapSpecRtToSched($srId, $routeType)) {
					// NOW WE WILL CREATE OR EDIT RDSEND RECORD
					// BUT FOR THAT WE NEED TO CHECK THAT ALL LOCATIONS
					// INVOLVED HAVE A PROPER BARCODE
					if(NullBarcode($srId)) {
						$chrDeviceStatus = "P";
					}
					else {
						$chrDeviceStatus = "N";
					}

					// GET DEVICEID
					$fileLineNbr = __LINE__; $deviceStr = GetDeviceFromPers($srDriverId, $routeType);
					list($deviceId, $deviceTypeId) = explode("~~", $deviceStr);

					if($val_RRCOM == "N" && $routeType == "RR") {
						// DO NOT CREATE THE RDSEND RECORD.
					}
					else {
						// THIS FUNCTION WILL PROCESS THE RDSEND RECORDS
						if($deviceId != 0){
							
							//FIND THE DEVICETYPEID ----------------
										$qryGetAD = "SELECT devicetypeid 
													FROM device 
													WHERE recid  = $deviceId";
										if($debug)
											print($qryGetAD . "<br />\n");
										$rsltGetAD = mysqli_query( $cvtconnection, $qryGetAD);
										if(!$rsltGetAD) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											while($rowGetAD = mysqli_fetch_assoc($rsltGetAD)) {
													$deviceTypeId = $rowGetAD[devicetypeid];
												}
												
										}	
								//-----------------------------
									
							SetRDSend_TRA37($srId, $deviceId, $deviceTypeId, $chrDeviceStatus, $routeType);
							
							}

					}

					// NOW WE WANT TO PROCESS THE RDSEND RECORDS FOR OTHER ADDL DRIVERS
					$qryGetAD = "SELECT DISTINCT intvar tdPersId
								FROM tempdata td
								WHERE jobtable = 'TRA37'
								AND activesessionid = $RecIdAS
								AND tablerecid = $srId";
					if($debug)
						print($qryGetAD . "<br />\n");
					$rsltGetAD = mysqli_query( $cvtconnection, $qryGetAD);
					if(!$rsltGetAD) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						while($rowGetAD = mysqli_fetch_assoc($rsltGetAD)) {

							$tdPersId = $rowGetAD[tdPersId];
							if(!is_numeric($tdPersId)) $tdPersId = 0;

							// GET DEVICEID
							$deviceStr = GetDeviceFromPers($tdPersId, $routeType);
							list($deviceId, $deviceTypeId) = explode("~~", $deviceStr);

							if($val_RRCOM == "N" && $routeType == "RR") {
								// DO NOT CREATE THE RDSEND RECORD.
							}
							else {
								// THIS FUNCTION WILL PROCESS THE RDSEND RECORDS
								if($deviceId != 0){
									//FIND THE DEVICETYPEID ----------------
										$qryGetAD = "SELECT devicetypeid 
													FROM device 
													WHERE recid  = $deviceId";
										if($debug)
											print($qryGetAD . "<br />\n");
										$rsltGetAD = mysqli_query( $cvtconnection, $qryGetAD);
										if(!$rsltGetAD) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											while($rowGetAD = mysqli_fetch_assoc($rsltGetAD)) {
													$deviceTypeId = $rowGetAD[devicetypeid];
												}
												
										}	
								//-----------------------------
									

									SetRDSend_TRA37($srId, $deviceId, $deviceTypeId, $chrDeviceStatus, $routeType);
									
									}
							}
						}
					}

					/// NOW DELETE THEM
					$qryDel = "DELETE FROM tempdata
								WHERE jobtable = 'TRA37'
								AND activesessionid = $RecIdAS
								AND tablerecid = $srId";
					if($debug)
						print("<b>" . $qryDel . "</b><br />\n");
					$rsltDel = mysqli_query( $cvtconnection, $qryDel);
					if(!$rsltDel) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 03);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if($debug)
							print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
					}
                                        
                                        //For Additional Drivers RDSend
                                        for ($i = 1; $i <= 6; $i++) {
                                            $integer = "integer" . $i;
                                            $addi_PersonId = $rowGetInfo[$integer];
                                            if (!is_numeric($addi_PersonId))
                                                $addi_PersonId = 0;
                                            
                                            if ($addi_PersonId != 0) {
                                                // GET DEVICEID
                                                $addi_deviceStr = GetDeviceFromPers($addi_PersonId, $routeType);
                                                list($addi_deviceId, $addi_deviceTypeId) = explode("~~", $addi_deviceStr);
                                                if($val_RRCOM == "N" && $routeType == "RR") {
                                                    // DO NOT CREATE THE RDSEND RECORD.
                                                } else {
                                                    if($addi_deviceId != 0){
                                                        //FIND THE DEVICETYPEID ----------------
                                                        $qryGetAD = "SELECT devicetypeid
                                                                        FROM device 
                                                                        WHERE recid = '$addi_deviceId'";
                                                        if($debug)
                                                            print($qryGetAD . "<br />\n");
                                                        $rsltGetAD = mysqli_query( $cvtconnection, $qryGetAD);
                                                        if(!$rsltGetAD) {
                                                            $fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
                                                            print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
                                                            unset($fileLineNbr);
                                                        }
                                                        else {
                                                            while($rowGetAD = mysqli_fetch_assoc($rsltGetAD)) {
                                                                $addi_deviceTypeId = $rowGetAD[devicetypeid];
                                                            }
                                                        }
                                                        //-----------------------------
                                                        SetRDSend_TRA37($srId, $addi_deviceId, $addi_deviceTypeId, $chrDeviceStatus, $routeType);
                                                    }//END if($addi_deviceId != 0)
                                                }//END else
                                            }//END if ($addi_PersonId != 0)
                                        }//END for ($i = 1; $i <= 6; $i++)
				}//END if(MapSpecRtToSched($srId, $routeType))
			}//END while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo))
		}

		// NOW SETTING OLDER RDSEND RECORDS TO SET DATASTATUS = 'N'
		$qryUp = "UPDATE rdsend rs, specificroutes{$val_SPLIT} sr
					SET rs.datastatus = 'N'
					WHERE sr.dispatchlocid = " . $ASLocationID . "
					AND sr.datesked < CURDATE() - INTERVAL $val_RDSND DAY
					AND rs.specificroutesid = sr.recid
					AND rs.type = 'T'
					AND rs.datastatus = 'Y'";
		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
		}

		// DELETING THE UNLINK RECORDS FROM TRANSACTIVITY
		/*$qryDel = "DELETE FROM transactivity
					USING transactivity ta, routelink rl
					WHERE ta.locationid = $ASLocationID
					AND ta.datet = '$dbEffDt'
					AND (ta.specificrouteid IS NULL OR ta.specificrouteid = 0)
					AND ta.type IN ('SD', 'SP')
					AND rl.clientid = $ASCompanyID
					AND rl.locationid = ta.customerlocid
					AND rl.returnsflag IN ('D', 'R')";*/
		$qryDel = "DELETE FROM transactivity
					WHERE locationid = $ASLocationID
					AND datet = '$dbEffDt'
					AND ( specificrouteid IS NULL OR specificrouteid = 0 )
					AND type = 'SD'
					AND archupdt = 'N'";

		// FOR SPLITTING OF TABLES
		$qryDel = convertToSplitTables($qryDel, $val_SPLIT);

		if($debug)
			print("<br /><b>" . $qryDel . "</b><br />\n");
		$rsltDel = mysqli_query( $cvtconnection, $qryDel);
		if(!$rsltDel) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 04);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> unlink reocrds deleted from TransActivity.<br /><br />");
		}

		$qryUp = "UPDATE transactivity
					SET locationid = $val_DELCO,
					archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
					WHERE locationid = $ASLocationID
					AND datet = '$dbEffDt'
					AND ( specificrouteid IS NULL OR specificrouteid = 0 )
					AND type = 'SD'";

		// FOR SPLITTING OF TABLES
		$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> affected.<br />");
		}

		// FINDING THE ROUTELINK LOCATIONS WHICH HAVE RETURNSFLAG = 'D'
		$qryGetDelRouteLocInfo = "SELECT DISTINCT locationid locId
									FROM routelink
									WHERE clientid = $ASCompanyID
									AND returnsflag = 'D'
									AND ( endeffdt IS NULL OR endeffdt = '0000-00-00' OR endeffdt > '$curDate' )";
		if($debug)
			print($qryGetDelRouteLocInfo . "<br />\n");
		$rsltGetDelRouteLocInfo = mysqli_query( $cvtconnection, $qryGetDelRouteLocInfo);
		$delvRouteLocStr = "";
		if(!$rsltGetDelRouteLocInfo) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			while($rowGetDelRouteLocInfo = mysqli_fetch_assoc($rsltGetDelRouteLocInfo)) {

				$locId = $rowGetDelRouteLocInfo[locId];
				if(!is_numeric($locId))	$locId = 0;

				if($delvRouteLocStr == "") {
					$delvRouteLocStr = $locId;
				}
				else {
					$delvRouteLocStr .= ", " . $locId;
				}
			}
		}

		if($delvRouteLocStr == "") {
			$delvRouteLocStr = "0";
		}

		// DELETING UNMAPPED SP RECORDS
		$qryUp = "UPDATE transactivity ta FORCE INDEX (datet)
					SET ta.locationid = $val_DELCO,
					ta.archupdt = IF(ta.archupdt IN ('X', 'P'), 'U', ta.archupdt)
					WHERE ta.locationid = " . $ASLocationID . "
					AND ta.datet = '" . $dbEffDt . "'
					AND ( ta.specificrouteid IS NULL OR ta.specificrouteid = 0 )
					AND ta.type = 'SP'
					AND ta.customerlocid IN (" . $delvRouteLocStr . ")";

		// FOR SPLITTING OF TABLES
		$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

		if($debug)
			print("<u>" . $qryUp . "</u><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> affected.<br />");
		}

		///////////////////////////////////////////////////////////////
		
		//DELETE THE DELIVERY TRANACTION RECORDS WHOSE ROUTE ARE NOT SET		
		
			$qryGetCDCust = "SELECT DISTINCT(sr.routeid) routeid , ta.customerlocid custLocId
							FROM transactivity ta , route r, standardroutes sr LEFT JOIN routefrequency rf ON rf.routeid = sr.routeid
							AND rf.routeid = sr.routeid
							AND rf.dow = UCASE(DATE_FORMAT('$dbEffDt', '%a'))
							AND ( rf.endeffdt = '0000-00-00'  OR rf.endeffdt IS NULL
							OR rf.endeffdt > '$dbEffDt' ) 
							WHERE ta.locationid = $ASLocationID
							AND ta.type IN ('DE')
							AND ta.datet = '$dbEffDt'
							AND ta.customerlocid = sr.locationid							
							AND r.recid = sr.routeid
							AND r.locationid = $ASLocationID
							AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
							OR r.endeffdt > '$curDate' )
							AND r.type = 'SR'							
							/*AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00'
							OR sr.endeffdt > '$dbEffDt' )*/";
							
			// FOR SPLITTING OF TABLES
			$qryGetCDCust = convertToSplitTables($qryGetCDCust, $val_SPLIT);				
			
			if($debug)
			   print($qryGetCDCust . "<br />\n");
			$rsltGetCDCust = mysqli_query( $cvtconnection, $qryGetCDCust);
			   							
			if(!$rsltGetCDCust) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if(mysqli_num_rows($rsltGetCDCust) == 0) {
				}
				else {
					while($rowGetCDCust = mysqli_fetch_assoc($rsltGetCDCust)) {
						$custLocId = $rowGetCDCust[custLocId];
						$routeid = $rowGetCDCust[routeid];
						
							$qryChkRecs = "SELECT COUNT(DISTINCT(r.recid)) routeCnt
											FROM routesetdetail rsd, route r
											WHERE rsd.routesetid = '$rsIdN'
											AND r.recid = rsd.routeid
											AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
											OR r.endeffdt > '$dbEffDt' )
											AND ( rsd.endeffdt IS NULL OR rsd.endeffdt = '0000-00-00'
											OR rsd.endeffdt > '$curDate' )
											AND rsd.routeid = '$routeid' ";
							if($debug)
								print($qryChkRecs . "<br />\n");
							$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
							$flagExist = false;
							if(!$rsltChkRecs) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								$rowChkRecs = mysqli_fetch_assoc($rsltChkRecs);
								$routeCnt = $rowChkRecs[routeCnt];
							}
					
							if($routeCnt == 0) {
		
							// dELETE SUCH TRANSACTIVITY RECORDS. THIS SHOULD NOT HAPPEN ACTUALLY BUT THIS
								// IS TO JUST ENSURE THAT NO INCONSISTENCY HAPPENED
								$qryDel = "DELETE FROM transactivity
											WHERE datet = '$dbEffDt'
											AND customerlocid = '$custLocId'
											AND type = 'DE'
											AND ( specificrouteid IS NULL OR specificrouteid = 0 )
											AND locationid = $ASLocationID
											AND archupdt = 'N'";
						
								// FOR SPLITTING OF TABLES
								$qryDel = convertToSplitTables($qryDel, $val_SPLIT);
								if($debug)
									print("<b>" . $qryDel . "</b><br />\n");
								$rsltDel = mysqli_query( $cvtconnection, $qryDel);
								if(!$rsltDel) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 04);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}
								else {
									if($debug)
										print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
								}
						
								$qryUp = "UPDATE transactivity ta
											SET ta.locationid = $val_DELCO,
											ta.archupdt = IF(ta.archupdt IN ('X', 'P'), 'U', ta.archupdt)
											WHERE datet = '$dbEffDt'
											AND customerlocid = '$custLocId'
											AND type = 'DE'
											AND ( specificrouteid IS NULL OR specificrouteid = 0 )											
											AND ta.locationid = $ASLocationID";
						
								// FOR SPLITTING OF TABLES
								$qryUp = convertToSplitTables($qryUp, $val_SPLIT);
						
								if($debug)
									print("<b>" . $qryUp . "</b><br />\n");
						
								$rsltUp = mysqli_query( $cvtconnection, $qryUp);
								if(!$rsltUp) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}
								else {
									if($debug)
										print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> affected.<br />");
								}
							}						
						}
					}
				}
							
		
		///////////////////////////////////////////////////////////////
		
		
		///////////////////////////////////////////////////////////////
		//// HERE WE WILL CREATER THE TRANSACTIVITYMC RECORDS  FOR
		//// HAWKER LOCATIONS
		if($val_HAWKS == "Y") {
			createHawkerTransMC_TRA37($dbEffDt);
		}
		///////////////////////////////////////////////////////////////
		
		//WAN46 Login
		
		$GetWAN = "Select count(1) WANcount from clientsystem WHERE recid = 'WAN46' AND clientid = '$ASCompanyID' AND charvar = 'Y'";
		if($debug)
			print "<br>$GetWAN<br>";
		$rslWAN = mysqli_query($GLOBALS["___mysqli_ston"], $GetWAN);
		$rowWAN = mysqli_fetch_assoc($rslWAN);
		
		$count_WAN = $rowWAN['WANcount'];
		
		if($count_WAN > 0 && $dbEffDt >= $curDate)
		{
			$GetWAN = "UPDATE clientsystem set strvar = NOW(),datevar = '$dbEffDt' WHERE recid = 'WAN46' AND clientid = '$ASCompanyID' AND charvar = 'Y'";
			if($debug)
			print "<br>$GetWAN<br>";
			$rslWAN = mysqli_query($GLOBALS["___mysqli_ston"], $GetWAN);
			$rowWAN = mysqli_fetch_assoc($rslWAN);
		
		}
		
		
		
		

		// GET ITS INDEX
		for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
			if($pdFieldsArr[$tempi] == "runrecords") {
				$runRecordsIndex = $tempi;
				break;
			}
		}

		// PREPARE STRING
		$setStr = "";
		for($tempi = $runRecordsIndex + 1; $tempi < count($pdFieldsArr); $tempi++) {
			$setStr .= ", {$pdFieldsArr[$tempi]}as = 0, {$pdFieldsArr[$tempi]}dt = NULL";
		}

		//NOW UPDATE PRODUCTDISPATCH RECORD
//		$qryUp = "UPDATE productdispatch
//					SET runrecordsdt = now(),
//					runrecordsas = $RecIdAS
//					" . $setStr . "
//					WHERE recid = $pdid";
		$qryUp = "UPDATE productdispatch
					SET runrecordsdt = now(),
					runrecordsas = $RecIdAS
					WHERE recid = $pdid";
		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
		}
                
                ###Task 6582 Sbz
                $char_DTIIO = GetLSVar("DTIIO", "charvar", $ASLocationID, $cvtconnection);
		if($debug) print("DTIIO = $char_DTIIO<br />\n");
                if($char_DTIIO == 'Y'){
                    $val_ARSIO = GetLSVar("ARSIO", "strvar", $ASLocationID, $cvtconnection);
                    if($debug) print("ARSIO = $val_ARSIO<br />\n");
                    
                    if($val_ARSIO != '2099-01-01 00:00:00'){
                        //Send Email
                        $fromCompName = GetComp($ASCompanyID, $cvtconnection);
                        
                        $strSubject = "DTI In/Out files could not be created";
                        $msg = "<p>DTI In/Out files could not be created for $fromCompName for Run Date " . get_date($dbEffDt, "MM/DD/YY") . ", Please check System setting ARSIO and set it to run manually</p>";
                        
                        
                        $from = "\"$fromCompName\" <$val_EMLID>";
                        $to = "support@teaksi.com";
                        
                        // CREATING MAIL CLASS OBJECT\
                        $mailExObj = new htmlMimeMailEx();

                        // SETTING THE "FROM" VALUES
                        $mailExObj->setFrom($from);

                        // SETTING THE "TO" VALUES
                        $mailExObj->addTo($to);

                        // SETTING THE "SUBJECT" VALUES
                        $mailExObj->setSubject($strSubject);

                        // SETTING THE "MESSAGE" VALUES
                        $mailExObj->setHtml($msg);

                        if ($mailExObj->send("mail")) {
                            if($debug){
                                echo "Mail send to $to<br>";
                            }
                        } else {
                            if($debug){
                                echo "Mail Not Sent - Some problem exist<br>";
                            }
                        }
                    } else {
                        $datevar_ARSIO = GetLSVar("ARSIO", "datevar", $ASLocationID, $cvtconnection);
                        if(strtotime($dbEffDt) < strtotime($datevar_ARSIO)){
                        }
                        else {
                            $qryUp = "UPDATE locationsystem
                                    SET datevar = '$dbEffDt',
                                    strvar = NOW()
                                    WHERE locationid = '$ASLocationID'
                                    AND recid = 'ARSIO'";
                            if($debug)
                                print("<b>" . $qryUp . "</b><br />\n");
                            $rsltUp = mysqli_query( $cvtconnection, $qryUp);
                            if(!$rsltUp) {
                                $fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
                                print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
                                unset($fileLineNbr);
                            }
                        }
                    }
                }
                ###Task 6582 Ends Sbz
                
                ###Task 8013
                if($debug) print("char_ARS65 = $char_ARS65<br />\n");
                if($char_ARS65 == "Y"){
                    fn_process_EMR("65", $dbEffDt, $debug, $cvtconnection);
                }
                ###Task 8013 Ends Sbz
                
                ###Task 8106
                if($char_ARS66 == "Y"){
                    fn_process_EMR("66", $dbEffDt, $debug, $cvtconnection);
                }
                ###Task 8106 Ends Sbz
                
                ###Task 8128
                if($char_ARS67 == "Y"){
                    fn_process_EMR("67", $dbEffDt, $debug, $cvtconnection);
                }
                ###Task 8128 Ends Sbz
                /*3.3*/
                if($disp_flag_2)
                { /*3.3*/
		// SETTING BACK WINDOW
		$callFunc = "CallBack('$Back','$PassedPageNbr','$pdid');";
		$Back = "javascript:$callFunc";
       /*3.3*/  } /*3.3*/
		include('../cm/html-secondwindow.php');

		print("<div class=\"datawhite\">");

		print("<b>Run Records Created.</b><br /><br />\n");

		print("</div>\n");
      /*3.3*/   if($disp_flag_2)
                { /*3.3*/
		if($debug) {
			print("<a href=\"javascript:" . $callFunc . "\">Back</a><br />\n");
		}
		else {
			print("<script language=\"javascript\" type=\"text/javascript\">self.setTimeout(\"" . $callFunc . "\", 2000);</script>\n");
		}
       /*3.3*/  }
                else
                {
                    if($debug){
		    print("<a href=\"" . urldecode($Back) . "\">Back</a><br />");
		    }
		    else {
                        print("<meta http-equiv=\"Refresh\" content=\"2; url=" . urldecode($Back) . "\" />");
	            }
                }  /*3.3*/
               
		include('../cm/html-bottom-secondwindow.php');
		break;

	case "Update":
	case "UpdateRegDispatch":
		// VALIDATION
		ValidateForInt(false, "pdid", "prodRegDispId");
		ValidateForStr(false, "instructions", "dispatchcomment", "msgtodrivers");

		print("prodRegDispId = $prodRegDispId<br />");
		if($doAction == "UpdateRegDispatch") {
			// UPDATE THE RECORD
			$qryUp = "UPDATE productregiondispatch
						SET instructions = '" . addslashes($instructions) . "',
						dispatchcomment = '" . addslashes($dispatchcomment) . "',
						msgtodrivers = '" . addslashes($msgtodrivers) . "'
						WHERE recid = $prodRegDispId";
			if($debug)
				print("<b>" . $qryUp . "</b><br />\n");
			$rsltUp = mysqli_query( $cvtconnection, $qryUp);
			if(!$rsltUp) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if($debug)
					print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
			}
		}
		else {
			//UPDATE THE RECORD
			$qryUp = "UPDATE productdispatch
						SET instructions = '" . addslashes($instructions) . "',
						dispatchcomment = '" . addslashes($dispatchcomment) . "',
						msgtodrivers = '" . addslashes($msgtodrivers) . "'
						WHERE recid = $pdid";
			if($debug)
				print("<b>" . $qryUp . "</b><br />\n");
			$rsltUp = mysqli_query( $cvtconnection, $qryUp);
			if(!$rsltUp) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if($debug)
					print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
			}
		}

		if($debug) {
			print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
		}
		else {
		    header("Location: " . urldecode($Back));
		}
		break;

	case "ToCheckRuns":
	//$debug = 1;
		// VALIDATION
		ValidateForInt(false, "pdid");

		print("<div class=\"datawhite\">");

		// LETS GET THE STANDARDROUTETYPES THEY WILL BE USED IN THE QUERY
		$stdrt_array = GeneralArray("routetype_standard");
		if($val_HAWKS == 'Y') {
			if(!in_array('AM', $stdrt_array)) {
				array_push($stdrt_array, 'AM');
			}
			if(!in_array('PM', $stdrt_array)) {
				array_push($stdrt_array, 'PM');
			}
			if(!in_array('TR', $stdrt_array)) {
				array_push($stdrt_array, 'TR');
			}
		}
		$rtcolrt_array = GeneralArray("routetype_returncol");
		$stdrt_str = MakeStr_TRA37($stdrt_array, ",", "'");
		$rtcolrt_str = MakeStr_TRA37($rtcolrt_array, ",", "'");

		if($val_ESRTE == "Y") {
			array_push($rtcolrt_array, 'ER');
		}

		//GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt", "routesetid");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
			$rsId = $rsltArr[routesetid];
			if(!is_numeric($rsId)) $rsId = 0;
		}
		else {
			$effdt = "";
			$dbEffDt = "";
			$rsId = 0;
		}
		unset($rsltArr, $fileLineNbr);


		// CHECKING FOR EARLY SUPPLY ROUTES WHICH HAVE MORE
		// SAME LOCATION ON DIFFERENT ROUTES
		if($val_ESRTE == "Y") {
			if($debug) {
				print("##################################################<br />\n");
				print("Early Supply Checking called.<br />\n");
				print("##################################################<br />\n");
			}

			// FINDING LOCATION WHICH ARE DUPLICATED ON EARLY SUPPLY ROUTES.

			// THE TWO QUERIES ARE THERE FOR OPTIMISATION
			$tempSrIdStr = "";
			$qryGetSrId = "SELECT sr.recid srId
							FROM specificroutes sr, route r
							WHERE sr.dispatchlocid = $ASLocationID
							AND sr.datesked = '$dbEffDt'
							AND r.recid = sr.routeid
							AND r.locationid = $ASLocationID
							AND r.type IN ('ES', 'ER')";

			// FOR SPLITTING OF TABLES
			$qryGetSrId = convertToSplitTables($qryGetSrId, $val_SPLIT);

			if($debug)
				print($qryGetSrId . "<br />\n");
			$rsltGetSrId = mysqli_query( $cvtconnection, $qryGetSrId);
			if(!$rsltGetSrId) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if(mysqli_num_rows($rsltGetSrId) == 0) {
					$tempSrIdStr = "";
				}
				else {
					while($rowGetSrId = mysqli_fetch_assoc($rsltGetSrId)) {
						$srId = $rowGetSrId[srId];
						if(!is_numeric($srId)) $srId = 0;
						if($tempSrIdStr == "") {
							$tempSrIdStr = $srId;
						}
						else {
							$tempSrIdStr .= ", " . $srId;
						}
					}
				}
			}

			if($tempSrIdStr == "") {
				$tempSrIdStr = "0";
			}

			$qryGetDupESLocInfo = "SELECT srl.locationid locId,
									COUNT(srl.specificrouteid) srCnt
									FROM specificrouteloc srl, location l
									WHERE srl.specificrouteid IN (" . $tempSrIdStr . ")
									AND srl.clientlocid = $ASLocationID
									AND srl.locationid = l.recid
									AND l.type != 'G'
									GROUP BY srl.locationid
									HAVING srCnt > 1";

			// FOR SPLITTING OF TABLES
			$qryGetDupESLocInfo = convertToSplitTables($qryGetDupESLocInfo, $val_SPLIT);

			if($debug)
				print($qryGetDupESLocInfo . "<br />\n");
			$rsltGetDupESLocInfo = mysqli_query( $cvtconnection, $qryGetDupESLocInfo);
			$esLocIdStr = "";

			if(!$rsltGetDupESLocInfo) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if(mysqli_num_rows($rsltGetDupESLocInfo) != 0) {
					while($rowGetDupESLocInfo = mysqli_fetch_assoc($rsltGetDupESLocInfo)) {

						$locId = $rowGetDupESLocInfo[locId];
						if(!is_numeric($locId))	$locId = 0;

						if($esLocIdStr == "") {
							$esLocIdStr = $locId;
						}
						else {
							$esLocIdStr .= ", " . $locId;
						}
					}
				}
			}

			if($esLocIdStr != "") {

				// NOW DELETING THE ES SPECIFICROUTES WHICH HAVE SAME LOCATION
				$qryGetEsSrInfo = "SELECT DISTINCT sr.recid srId
									FROM specificrouteloc srl, specificroutes sr, route r
									WHERE srl.clientlocid = $ASLocationID
									AND srl.locationid IN ($esLocIdStr)
									AND sr.recid = srl.specificrouteid
									AND sr.datesked = '$dbEffDt'
									AND sr.dispatchlocid = $ASLocationID
									AND sr.routeid = r.recid
									AND r.type IN ('ES', 'ER')
									AND r.locationid = $ASLocationID";

				// FOR SPLITTING OF TABLES
				$qryGetEsSrInfo = convertToSplitTables($qryGetEsSrInfo, $val_SPLIT);

				if($debug)
					print($qryGetEsSrInfo . "<br />\n");
				$rsltGetEsSrInfo = mysqli_query( $cvtconnection, $qryGetEsSrInfo);
				if(!$rsltGetEsSrInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					while($rowGetEsSrInfo = mysqli_fetch_assoc($rsltGetEsSrInfo)) {

						$srId = $rowGetEsSrInfo[srId];
						if(!is_numeric($srId))	$srId = 0;

						if($val_HWKPR == "Y") {
							$qryDel = "DELETE FROM hawkerrouteloclink
										USING hawkerrouteloclink, specificrouteloc
										WHERE specificrouteloc.clientlocid = $ASLocationID
										AND specificrouteloc.specificrouteid = $srId
										AND specificrouteloc.recid = hawkerrouteloclink.specificroutelocid";

							// FOR SPLITTING OF TABLES
							$qryDel = convertToSplitTables($qryDel, $val_SPLIT);

							if($debug)
								print("<b>" . $qryDel . "</b><br />\n");
							$rsltDel = mysqli_query( $cvtconnection, $qryDel);
							if(!$rsltDel) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 04);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if($debug)
									print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
							}
						}

						// DELETING SPECIFICROUTELOC RECORDS
						$qryUp = "UPDATE specificrouteloc
									SET clientlocid = $val_DELCO,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE clientlocid = $ASLocationID
									AND specificrouteid = $srId";

						// FOR SPLITTING OF TABLES
						$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
						}

						// DELETING ROUTEDRAWACCOUNTING RECORDS
						$qryUp = "UPDATE routedrawaccounting
									SET clientlocid = $val_DELCO,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE clientlocid = $ASLocationID
									AND specificrouteid = $srId";

						// FOR SPLITTING OF TABLES
						$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
						}

						// DELETING SPECIFICROUTE RECORDS
						$qryUp = "UPDATE specificroutes
									SET dispatchlocid = $val_DELCO,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE dispatchlocid = $ASLocationID
									AND recid = $srId";

						// FOR SPLITTING OF TABLES
						$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
						}
					}
				}

				// NOW DISPLAYING LOCATIONS WHICH ARE DUPLICATED
				print("<div align=\"left\">");
				print("<b>Sorry, Early Supply routes had to be removed since the following location(s) were on more than one Early Supply route:</b><br />");
				$qryGetInfo = "SELECT l.recid locId, c.name compName,
								CONCAT_WS(' - ', NULLIF(l.storenbr, ''), NULLIF(l.sdesc, ''), NULLIF(a.address1, ''), NULLIF(a.address2, ''), NULLIF(a.address3, ''), NULLIF(a.address4, '')) locDesc
								FROM routelink rl, locationlink ll,
								company c, location l
								LEFT JOIN address a ON a.recid = l.addressid
								WHERE rl.clientid = $ASCompanyID
								AND l.recid = rl.locationid
								ANd l.recid IN ($esLocIdStr)
								AND ll.locationid = l.recid
								AND c.recid = ll.companyid";
				if($debug)
					print($qryGetInfo . "<br />\n");
				$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);

				print("<br /><table border=\"1\" width=\"100%\">\n");
				print("\t<tr class=\"datatblhdr\">\n");
				if($debug) print("\t\t<td>locid</td>\n");
				print("\t\t<td>Customer</td>\n");
				print("\t\t<td>Location</td>\n");
				print("\t</tr>\n");

				$oddEven = 0;
				if(!$rsltGetInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {

						$locId = $rowGetInfo[locId];
						$compName = $rowGetInfo[compName];
						$locDesc = $rowGetInfo[locDesc];
						if(!is_numeric($locId))	$locId = 0;

						if( ( $oddEven++ % 2 ) == 0 ) {
							print("\t<tr class=\"datawhite\">\n");
						}
						else {
							print("\t<tr class=\"datagrey\">\n");
						}

						// FOR LOCID
						if($debug) print("\t\t<td>$locId</td>\n");

						print("\t\t<td>" . ($compName != "" ? htmlentities($compName, ENT_QUOTES) : "") . "</td>\n");

						print("\t\t<td>" . ($locDesc != "" ? htmlentities($locDesc, ENT_QUOTES) : "") . "</td>\n");

						print("\t</tr>\n");
					}
				}
				print("</table>\n");
				print("</div><br /><br />\n");
			}

			if($debug) {
				print("##################################################<br />\n");
				print("END OF Early Supply Checking -- CHECK RUNS<br />\n");
				print("##################################################<br />\n");
			}
		}

		## Checking of Redeploy Multiples case
		/*$rsltArray = ReDepMulExists_TRA37($dbEffDt);
		if($rsltArray[flagExist]) {
		}
		else {
			// set the array to some other array so that it can be used in
			// create run record procedure directly.
			$reDepMulArray = $rsltArray[redepmul_array];
		}
		unset($rsltArray);*/
		$stdrt_array = GeneralArray("routetype_standard");
		$stdrt_str = MakeStrFromArray($stdrt_array, ", ", "'");
		if($stdrt_str == "") $stdrt_str = "''";

		$stdrt_str .= ", 'RR', 'SS', 'CR','PR','ND'";

		if($val_ESRTE == "Y") {
			$stdrt_str .= ", 'ER'";
		}

		if($val_HAWKS == 'Y') {
			$stdrt_str .= ", 'AM', 'PM', 'TR'";
		}


		/*// FINDING ALL SPECIFICROUTES RECORDS
		$tSrIdStr = "";
		$qryGetSrInfo = "SELECT recid tSrId
						FROM specificroutes
						WHERE dispatchlocid = $ASLocationID
						AND datesked = '$dbEffDt'";

		// FOR SPLITTING TABLES
		$qryGetSrInfo = convertToSplitTables($qryGetSrInfo, $val_SPLIT);

		if($debug)
			print($qryGetSrInfo . "<br />\n");
		$rsltGetSrInfo = mysql_query($qryGetSrInfo, $cvtconnection);
		while($rowGetSrInfo = mysql_fetch_assoc($rsltGetSrInfo)) {

			$tSrId = $rowGetSrInfo[tSrId];
			if(!is_numeric($tSrId))	$tSrId = 0;

			if($tSrIdStr == "") {
				$tSrIdStr .= $tSrId;
			}
			else {
				$tSrIdStr .= ", " . $tSrId;
			}
		}
		$tSrIdStr = ($tSrIdStr == "" ? "0" : $tSrIdStr);*/

		// NOW CREATING TEMPORARY TABLE FOR SPECIFICROUTES AND SPECIFICROUTELOC
		// CREATING TEMPORARY TABLE
		$qryCreateTemp = "CREATE TEMPORARY TABLE tmpTRA37ChkRuns (
			srid BIGINT(20) NOT NULL,
			routeid BIGINT(20) NOT NULL,
			locationid BIGINT(20) NOT NULL,
			routetype char(2) NOT NULL,
			datesked DATE NOT NULL DEFAULT '0000-00-00',
			KEY srid (srid),
			KEY locationid (locationid),
			KEY datesked (datesked)
		)";
		if($debug)
			print("<b>" . $qryCreateTemp . "</b><br />\n");
		$rsltCreateTemp = mysqli_query( $cvtconnection, $qryCreateTemp);
		if(!$rsltCreateTemp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 05);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}

		$qryIns = "INSERT INTO tmpTRA37ChkRuns SELECT sr.recid, sr.routeid, srl.locationid, r.type, sr.datesked FROM specificroutes sr, specificrouteloc srl, route r WHERE r.locationid = $ASLocationID AND r.type IN ($stdrt_str) AND r.recid = sr.routeid AND sr.dispatchlocid = $ASLocationID AND sr.datesked = '$dbEffDt' AND sr.recid = srl.specificrouteid AND srl.clientlocid = $ASLocationID";

		// FOR SPLITTING OF TABLES -- ADDED ON
		$qryIns = convertToSplitTables($qryIns, $val_SPLIT);

		if($debug)
			print("<b>" . $qryIns . "</b><br />\n");
		$rsltIns = mysqli_query( $cvtconnection, $qryIns);
		if(!$rsltIns) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 06);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
		}

		// FINDING MULTIPLE RECORDS
		$reDepMulArray = array();
		$reDepMulLocArr = array();
		/*AND sr.recid IN ($tSrIdStr)*/
		/*$qryGetRM = "SELECT ta.customerlocid locid, ta.specificproductid spid,
					ta.type tatype, COUNT( DISTINCT( IF( ta.type = 'SP' AND rl.returnsflag = 'R' AND r.type IN ('RR', 'SS', 'ER', 'CR'), sr.recid, IF( ta.type = 'SP' AND rl.returnsflag = 'D' AND r.type IN ('SR', 'HO'), sr.recid, IF( ta.type = 'SD' AND r.type <> 'RR' AND r.type <> 'SS' AND r.type <> 'ER' AND r.type <> 'CR',  sr.recid, NULL) ) ) ) ) cnt_rt, rl.returnsflag
					FROM transactivity ta, specificrouteloc srl, specificroutes sr, route r, routelink rl
					WHERE ta.locationid = $ASLocationID
					AND ta.datet = '$dbEffDt'
					AND ta.type IN ('SD', 'SP')
					AND ( ta.specificrouteid IS NULL OR ta.specificrouteid = 0 )
					AND ( ta.specificproductid IS NOT NULL AND ta.specificproductid != 0 )
					AND srl.locationid = ta.customerlocid
					AND srl.clientlocid = $ASLocationID
					AND sr.recid = srl.specificrouteid
					AND ta.datet = sr.datesked
					AND sr.dispatchlocid = $ASLocationID
					AND sr.routeid = r.recid
					AND r.locationid = $ASLocationID
					AND r.type IN ($stdrt_str)
					AND rl.clientid = $ASCompanyID
					AND srl.locationid = rl.locationid
					GROUP BY ta.customerlocid, ta.specificproductid, ta.type
					HAVING cnt_rt > 1
					ORDER BY ta.customerlocid, ta.specificproductid";*/

		$routeTypeStr = "'SR', 'HO', 'PR','ND'";

		if($val_HAWKS == "Y") {
			$routeTypeStr .= ", 'AM', 'PM', 'TR'";
		}

		$qryGetRM = "SELECT ta.customerlocid locid, ta.specificproductid spid,
					ta.type tatype, COUNT( DISTINCT( IF( ta.type = 'SP' AND rl.returnsflag = 'R' AND tsr.routetype IN ('RR', 'SS', 'ER', 'CR'), tsr.srid, IF( ta.type = 'SP' AND rl.returnsflag = 'D' AND tsr.routetype IN ($routeTypeStr), tsr.srid, IF( ta.type = 'SD' AND tsr.routetype <> 'RR' AND tsr.routetype <> 'SS' AND tsr.routetype <> 'ER' AND tsr.routetype <> 'CR',  tsr.srid, NULL) ) ) ) ) cnt_rt, rl.returnsflag
					FROM transactivity ta, routelink rl, tmpTRA37ChkRuns tsr
					WHERE ta.locationid = $ASLocationID
					AND ta.datet = '$dbEffDt'
					AND ta.type IN ('SD', 'SP')
					AND ( ta.specificrouteid IS NULL OR ta.specificrouteid = 0 )
					AND ( ta.specificproductid IS NOT NULL AND ta.specificproductid != 0 )
					AND ta.customerlocid = tsr.locationid
					AND ta.datet = tsr.datesked
					AND rl.clientid = $ASCompanyID
					AND tsr.locationid = rl.locationid
					GROUP BY ta.customerlocid, ta.specificproductid, ta.type
					HAVING cnt_rt > 1
					ORDER BY ta.customerlocid, ta.specificproductid";

		/*$qryGetRM = "SELECT ta.customerlocid locid, ta.specificproductid spid,
					ta.type tatype,COUNT( DISTINCT( IF( ta.type = 'SP' AND tsrl.rlReturnsFlag = 'R' AND tsrl.routeType IN ('RR', 'SS', 'ER', 'CR'), tsrl.srId, IF( ta.type = 'SP' AND tsrl.rlReturnsFlag = 'D' AND tsrl.routeType IN ('SR', 'HO'), tsrl.srId, IF( ta.type = 'SD' AND tsrl.routeType NOT IN ('RR', 'SS', 'ER', 'CR'), tsrl.srId, NULL) ) ) ) ) cnt_rt, tsrl.rlReturnsFlag returnsflag
					FROM transactivity ta,
					(
						SELECT srl.locationid srlLocId, rl.returnsflag rlReturnsFlag, r.type routeType, sr.recid srId
						FROM specificrouteloc srl, specificroutes sr, route r, routelink rl
						WHERE srl.clientlocid = $ASLocationID
						AND sr.recid = srl.specificrouteid
						AND sr.dispatchlocid = $ASLocationID
						AND sr.routeid = r.recid
						AND r.locationid = $ASLocationID
						AND r.type IN ($stdrt_str)
						AND rl.clientid = $ASCompanyID
						AND srl.locationid = rl.locationid
						AND sr.datesked = '$dbEffDt'
					) tsrl
					WHERE ta.locationid = $ASLocationID
					AND ta.customerlocid = tsrl.srlLocId
					AND ta.datet = '$dbEffDt'
					AND ta.type IN ('SD', 'SP')
					AND ( ta.specificrouteid IS NULL OR ta.specificrouteid = 0 )
					AND ( ta.specificproductid IS NOT NULL AND ta.specificproductid != 0 )
					GROUP BY ta.customerlocid, ta.specificproductid, ta.type
					HAVING cnt_rt > 1
					ORDER BY ta.customerlocid, ta.specificproductid";*/

		// FOR SPLITTING OF TABLES
		$qryGetRM = convertToSplitTables($qryGetRM, $val_SPLIT);

		if($debug)
			print($qryGetRM . "<br />\n");
		$rsltGetRM = mysqli_query( $cvtconnection, $qryGetRM);

		if(!$rsltGetRM) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetRM) == 0) {
			}
			else {
				while($rowGetRM = mysqli_fetch_assoc($rsltGetRM)) {
					// FOR EACH SUCH LOCID AND SPID WE NEED TO SEE WHETHER THERE EXIST DATA
					// IN PREVIOUS WEEK OR NOT
					$locId = $rowGetRM[locid];
					$spId = $rowGetRM[spid];
					$type = $rowGetRM[tatype];
					$returnsFlag = $rowGetRM[returnsflag];
					ValidateForInt(false, "locId", "spId");

					if($type == "SP" && $retunsFlag == "S") {
					}
					else {
						$old_SrId = ReDupMulPrevWeekExist_TRA37($locId, $spId, $dbEffDt, $type, true);
						if($old_SrId != 0) {

							array_push($reDepMulArray,
								array(
									"locid" => $locId,
									"spid" => $spId,
									"srid" => $old_SrId,
									"type" => $type
								));
						}

						if(!in_array($locid, $reDepMulLocArr))
							array_push($reDepMulLocArr, $locid);
					}
				}
			}
		}

		if($debug) {
			print("<pre style=\"text-align: left;\">");
			print_r($reDepMulArray);
			print("</pre><br />\n");
		}

		// IF FOUND THEN SET REDEPLOY MULTIPLES
		if(is_array($reDepMulArray) && count($reDepMulArray) > 0) {
			SetReDepMulTA_TRA37($reDepMulArray, $dbEffDt);
		}

		// GETTING DATE FOR DISPLAY
		$dispEffDt = set_date($dbEffDt, "YYYY-MM-DD", "MM/DD/YY");

		//GET ROUTESETTYPE
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "routeset", $rsId, "type");
		if($rsltArr[rtvalue]) {
			$rstype = $rsltArr[type];
		}
		else {
			$rstype = "";
		}
		unset($rsltArr, $fileLineNbr);

		print("<b><u>Check Runs - $dispEffDt</u></b><br /><br />\n");
		ob_flush();

		/*// LETS CREATE TEMPORARY TABLE WHICH WILL BE USED IN THE PROCESS
		CreateTemp_StdDraw("", array("flag_donotinsert" => true));*/

		//WE NEED TO CHECK FOR EACH LOCATIONS IN ROUTELINK WITH
		//QUERY TO GET INFORMATION
		/*$qryGetInfo = "SELECT DISTINCT(rl.locationid)
						FROM routelink rl, locationlink ll
						WHERE rl.clientid = $ASCompanyID
						AND ( rl.endeffdt IS NULL OR rl.endeffdt = '0000-00-00'
						OR rl.endeffdt > '$curDate' )
						AND rl.type IN ('D', 'X', 'M', 'R')
						AND ll.locationid = rl.locationid
						AND ( ll.endeffdt IS NULL OR ll.endeffdt = '0000-00-00'
						OR ll.endeffdt > '$curDate' )
						ORDER BY rl.locationid";*/
		$qryGetInfo = "( SELECT DISTINCT(l.recid) locId
						FROM location l, locationlink ll, customerlink cl
						WHERE l.type IN ('D', 'R')
						AND ( l.endeffdate IS NULL OR l.endeffdate = '0000-00-00' OR l.endeffdate > '$curDate' )
						AND ll.locationid = l.recid
						AND cl.customerid = ll.companyid
						AND cl.clientid = $ASCompanyID
						AND cl.clientlocid = $ASLocationID
						AND ( cl.endeffdt IS NULL OR cl.endeffdt = '0000-00-00' OR cl.endeffdt > '$curDate' )
						) UNION (
						SELECT DISTINCT(l.recid) locId
						FROM location l, locationlink ll
						WHERE l.type = 'M'
						AND ( l.endeffdate IS NULL OR l.endeffdate = '0000-00-00' OR l.endeffdate > '$curDate' )
						AND ll.locationid = l.recid
						AND ll.companyid = $val_VMCPY )
						ORDER BY locId";
		if($debug)
			print($qryGetInfo . "<br />\n");

		print("<table border=\"1\" width=\"100%\">\n");
		print("<tr class=\"datatblhdr\">\n");
		if($debug) print("<td>locid</td>\n");
		print("<td align=\"center\">Type</td>\n");
		print("<td>Customer</td>\n");
		print("<td>Location</td>\n");
		print("<td align=\"center\">Route</td>\n");
		print("<td align=\"center\">Fix</td>\n");
		print("</tr>\n");

		ob_flush();
		$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);

		/*  HERE WE HAVE SPEED PROBLEM. THEREFORE WE WILL DO THE PROCESS OF CHECKING
		WHETHER THE LOCATIOM IS OPEN OR NOT IN BATCH. HOW MANY LOCATIONS SHOULD BE
		PROCESSED IN A BATCH WILL BE DECIDED BY THE BATCHFACTOR VARIABLE.
		*/
		$batchFactor = 20;

		$oddEven = 0;
		$cntLocs = 0;
		$batchCnt = 0;
		$totalCnt = 0;
		$totalLocCnt = 0;
		$locIdArr = array();
		$problemFlag = false;
		$mergeFlag = false;
		$_SESSION[TRA37MERGEROUTELOCS] = array();
		if(!$rsltGetInfo) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {

			while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
				$locId = $rowGetInfo[locId];
				if(!is_numeric($locId)) $locId = 0;

				array_push($locIdArr, $locId);

				$batchCnt++;
				$totalCnt++;
				if($batchCnt == $batchFactor || $totalCnt == mysqli_num_rows($rsltGetInfo)) {
					// PROCESS BATCH
					$locIdArr = IsActiveLocArray_TRA37($locIdArr, $dbEffDt);

					if($debug) {
						print("<pre><b>locIdArr = </b>");
						print_r($locIdArr);
						print("</pre><br />");
					}

					// PREPARE AN ARRAY THAT WILL STORE THE RELATED ROUTES FOR THE LOCATIONS
					#############################
					$locrt_array = array();
					for($tempi = 0; $tempi < count($locIdArr); $tempi++) {
						$locrt_array[$locIdArr[$tempi]] = array();
					}

					$locIdStr = MakeStrFromArray($locIdArr, ", ", "");
					if($locIdStr == "") $locIdStr = "0";

					//CHECK IF ACTIVE THEN CHECK FOR THE TWO CONDITIONS
					//if(IsActiveLoc($locId, $rstype, $dbEffDt)) {
					//if(IsActiveLoc($locId, $dbEffDt)) {
					
					for($cntIdLoc = 0; $cntIdLoc < count($locIdArr); $cntIdLoc++) {
						$locId = $locIdArr[$cntIdLoc];
                                                $srCnt = 0;
                                                $rrCnt = 0;
						//CHECK THAT ON HOW MANY SPECIFICROUTES DOES IT EXIST
						//IT SHOULD BE EXACTLY ONE
						$qryGetR = "SELECT DISTINCT(r.recid), r.routenbr, r.type
									FROM tmpTRA37ChkRuns tsr, route r
									WHERE tsr.locationid = $locId
									AND r.recid = tsr.routeid
									AND r.locationid = $ASLocationID
									AND r.type IN (" . $stdrt_str . ")
									ORDER BY r.routenbr";

						/*// FOR SPLITTING OF TABLES
						$qryGetR = convertToSplitTables($qryGetR, $val_SPLIT);*/

						if($debug)
							print($qryGetR . "<br />\n");
						$rsltGetR = mysqli_query( $cvtconnection, $qryGetR);
						if(!$rsltGetR) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							$noRoutes = mysqli_num_rows($rsltGetR);
							if(!is_numeric($noRoutes)) $noRoutes = 0;
						}

						// FIND RETURNSFLAG
						$selectStr = "returnsflag";
						$fromStr = "routelink";
						$whereStr = "clientid = $ASCompanyID
									AND locationid = $locId";
						$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
						unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

						if($rsltArr) {
							$returnsFlag = $rsltArr[returnsflag];
						}
						else {
							$returnsFlag = "";
						}
						unset($rsltArr);
						if($debug)
							print("<b>Returns Flag = $returnsFlag :: noRoutes = $noRoutes</b><br />\n");

						// THIS FLAG WILL DECIDE WHETHER TO LIST THIS LOCATION OR NOT
						// IF LOCATION IS OF RETURNSFLAG = R AND THEN IF HE IS ON ONE DELIVERY
						// ROUTE AND ONE ON RETURNS ROUTE THEN IT IS OKAY.
						$flagProb = false;
						$flagNotInDelRoute = false;
                                                $flagSDProb = false;
                                                $flagSPProb = false;
						if($noRoutes >= 2) {
							$flagProb = true;
                                                        $returnsRouteExistFlag = false;
							$routeTypeStr = "'SR', 'HO', 'PR','ND'";

							if($val_HAWKS == "Y") {
								$routeTypeStr .= ", 'AM', 'PM', 'TR'";
							}

							$qryGetRouteCntInfo = "SELECT COUNT(IF(r.type IN ($routeTypeStr), r.recid, NULL)) srCnt,
													COUNT(IF(r.type IN ('RR', 'SS', 'ER', 'CR'), r.recid, NULL)) rrCnt
													FROM tmpTRA37ChkRuns tsr, route r
													WHERE tsr.locationid = $locId

													AND r.recid = tsr.routeid
													AND r.locationid = $ASLocationID
													AND r.type IN (" . $stdrt_str . ")";

							/*// FOR SPLITTING OF TABLES
							$qryGetRouteCntInfo = convertToSplitTables($qryGetRouteCntInfo, $val_SPLIT);*/

							if($debug)
								print($qryGetRouteCntInfo . "<br />\n");
							$rsltGetRouteCntInfo = mysqli_query( $cvtconnection, $qryGetRouteCntInfo);

							if(!$rsltGetRouteCntInfo) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								$rowGetRouteCntInfo = mysqli_fetch_assoc($rsltGetRouteCntInfo);
								$srCnt = $rowGetRouteCntInfo[srCnt];
								$rrCnt = $rowGetRouteCntInfo[rrCnt];
							}
							if(!is_numeric($srCnt))	$srCnt = 0;
							if(!is_numeric($rrCnt))	$rrCnt = 0;
                                                        
                                                        if ($rrCnt >= 1)
                                                        {
                                                            $returnsRouteExistFlag = true; 
                                                        }
                                                        
                                                        if($noRoutes == 2) {
							$returnsRouteExistFlag = false;
                                                        $flagProb = false;
							/* if($returnsFlag == "D") {
								$flagProb = true;
							}
							else { */
                                                        
								$tempRtArr = array();
								while($rowGetR = mysqli_fetch_assoc($rsltGetR)) {
									if(in_array($rowGetR[type], $rtcolrt_array)) {
										$routeType = "RR";
										$returnsRouteExistFlag = true;
									}
									else {
										$routeType = "SR";
									}

									if(!in_array($routeType, $tempRtArr))
										array_push($tempRtArr, $routeType);
								}
								if(count($tempRtArr) == 1)
									$flagProb = true;
							//}
						}
						}
						elseif($noRoutes <= 0) {
							$flagProb = true;
						}
						/* elseif($noRoutes == 2) {
							$returnsRouteExistFlag = false;

							if($returnsFlag == "D") {
								$flagProb = true;
							}
							else {
								$tempRtArr = array();
								while($rowGetR = mysql_fetch_assoc($rsltGetR)) {
									if(in_array($rowGetR[type], $rtcolrt_array)) {
										$routeType = "RR";
										$returnsRouteExistFlag = true;
									}
									else {
										$routeType = "SR";
									}

									if(!in_array($routeType, $tempRtArr))
										array_push($tempRtArr, $routeType);
								}

								if(count($tempRtArr) == 1)
									$flagProb = true;
							}
						} */
						if($debug)
							print("<b>$srCnt, $rrCnt, $returnsRouteExistFlag, $flagProb</b><br />\n");

						// THIS IS FOR CHECKING OF PREVIOUS WEEK RECORDS ARE
						// EXISTS OR NOT, IF EXISTS DO NOT DISPLAY LOCATION.
						if($flagProb) {

							if($noRoutes >= 2) {
                                                                    
								if($debug)
									print("<u><b>$locId have multiple routes.</b></u><br />\n");

								/*
									FOLLOWING CODE IS ADDED FOR CHECKING OF RETURNS ROUTE
									AND SP RECORD DOES NOT HAVE ANY RETURNS ROUTE AND IT SHOULD
									NOT BE DISPLAYED.
								*/
								if($returnsFlag == "R") {
									$typeStr = "ta.type = 'SD'";
								}
								else {
									$typeStr = "ta.type IN ('SD', 'SP')";
								}

								$qryGetTaInfo = "SELECT DISTINCT ta.specificproductid spId, ta.type
												FROM transactivity ta
												WHERE ta.locationid = $ASLocationID
												AND ta.customerlocid = $locId
												AND $typeStr
												AND ta.datet = '$dbEffDt'";

								// FOR SPLITTING OF TABLES
								$qryGetTaInfo = convertToSplitTables($qryGetTaInfo, $val_SPLIT);

								if($debug)
									print($qryGetTaInfo . "<br />\n");
								$rsltGetTaInfo = mysqli_query( $cvtconnection, $qryGetTaInfo);
								if(!$rsltGetTaInfo) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}
								else {
									while($rowGetTaInfo = mysqli_fetch_assoc($rsltGetTaInfo)) {

										$spId = $rowGetTaInfo[spId];
										if(!is_numeric($spId))	$spId = 0;
										$type = $rowGetTaInfo[type];
                                                                                
										$prevWeekSrId = ReDupMulPrevWeekExist_TRA37($locId, $spId, $dbEffDt, $type, true);
										if($debug)
											print("<b>SD prevWeekSrId = $prevWeekSrId</b><br />\n");

										if($prevWeekSrId == 0) {
											$flagSDProb = true;
                                                                                        break;
										}
										else {
											$flagSDProb = false;
										}
                                                                                
									}
								}

								// NOW CHECKING FOR 'SP' RECORDS IF RETURNSFLAG = 'R'
								if($returnsFlag == "R" && $returnsRouteExistFlag && $rrCnt > 1) {
                                                      
									$qryGetTaInfo = "SELECT DISTINCT ta.specificproductid spId, ta.type
													FROM transactivity ta 
													WHERE ta.locationid = $ASLocationID
													AND ta.customerlocid = $locId
													AND ta.type = 'SP'
													AND ta.datet = '$dbEffDt'";

									// FOR SPLITTING OF TABLES
									$qryGetTaInfo = convertToSplitTables($qryGetTaInfo, $val_SPLIT);

									if($debug)
										print($qryGetTaInfo . "<br />\n");
									$rsltGetTaInfo = mysqli_query( $cvtconnection, $qryGetTaInfo);
									if(!$rsltGetTaInfo) {
										$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
										print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
										unset($fileLineNbr);
									}
									else {
										while($rowGetTaInfo = mysqli_fetch_assoc($rsltGetTaInfo)) {

											$spId = $rowGetTaInfo[spId];
											if(!is_numeric($spId))	$spId = 0;
											$type = $rowGetTaInfo[type];

											$prevWeekSrId = ReDupMulPrevWeekExist_TRA37($locId, $spId, $dbEffDt, $type, true);
											if($debug)
												print("<b>SP prevWeekSrId = $prevWeekSrId</b><br />\n");

											if($prevWeekSrId == 0) {
												$flagSPProb = true;
												break;
											}
											else {
												$flagSPProb = false;
											}
										}
									}
								}
								else {
									$flagSPProb = false;
								}
                                                                       
								if($flagSDProb || $flagSPProb) {
									$flagProb = true;
								}
								else {
									$flagProb = false;
								}
                                                                
							}
                                                        
						}

						if($noRoutes >= 1 && !$flagProb) {
                                                   
							$qryGetTaInfo = "SELECT COUNT(recid) taCnt
												FROM transactivity
												WHERE locationid = $ASLocationID
												AND type = 'SD'
												AND datet = '$dbEffDt'
												AND customerlocid = $locId";

							// FOR SPLITTING OF TABLES
							$qryGetTaInfo = convertToSplitTables($qryGetTaInfo, $val_SPLIT);

							if($debug)
								print($qryGetTaInfo . "<br />\n");
							$rsltGetTaInfo = mysqli_query( $cvtconnection, $qryGetTaInfo);
							if(!$rsltGetTaInfo) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								$rowGetTaInfo = mysqli_fetch_assoc($rsltGetTaInfo);
								$taCnt = $rowGetTaInfo[taCnt];
							}

							if($taCnt > 0) {
								$routeTypeStr = "'SR', 'PR','ND'";

								if($val_HAWKS == "Y") {
									$routeTypeStr .= ", 'AM', 'PM', 'TR'";
								}

								// CHECK WHETHER THE LOCATION EXSIT ON ANY SR ROUTE
								$qryGetSRCnt = "SELECT COUNT(*) srCnt
												FROM tmpTRA37ChkRuns tsr, route r
												WHERE tsr.locationid = $locId
												AND r.recid = tsr.routeid
												AND r.locationid = $ASLocationID
												AND r.type IN($routeTypeStr)";

								/*// FOR SPLITTING OF TABLES
								$qryGetSRCnt = convertToSplitTables($qryGetSRCnt, $val_SPLIT);*/

								if($debug)
									print($qryGetSRCnt . "<br />\n");
								$rsltGetSRCnt = mysqli_query( $cvtconnection, $qryGetSRCnt);
								if(!$rsltGetSRCnt) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}
								else {
									$rowGetSRCnt = mysqli_fetch_assoc($rsltGetSRCnt);
									$srCnt = $rowGetSRCnt[srCnt];
									if($srCnt == 0) {
										$flagProb = true;
										$flagNotInDelRoute = true;
									}
								}
							}
						}

						if($noRoutes == 0) {
							// CHECKING FOR "SD" AND "SP" RECORDS COUNT
							$qryGetSdSpInfo = "SELECT COUNT(IF(ta.type = 'SD', ta.type, NULL)) sdCnt,
												COUNT(IF(ta.type = 'SP', ta.type, NULL)) spCnt
												FROM transactivity ta 
												WHERE ta.locationid = $ASLocationID
												AND ta.type IN ('SD', 'SP')
												AND ta.datet = '$dbEffDt'
												AND ta.customerlocid = $locId";

							// FOR SPLITTING OF TABLES
							$qryGetSdSpInfo = convertToSplitTables($qryGetSdSpInfo, $val_SPLIT);

							if($debug)
								print("<b>" . $qryGetSdSpInfo . "</b><br />\n");
							$rsltGetSdSpInfo = mysqli_query( $cvtconnection, $qryGetSdSpInfo);
							if(!$rsltGetSdSpInfo) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								$rowGetSdSpInfo = mysqli_fetch_assoc($rsltGetSdSpInfo);
								$sdCnt = $rowGetSdSpInfo[sdCnt];
								$spCnt = $rowGetSdSpInfo[spCnt];

								if($sdCnt == 0 && $spCnt > 0 && $returnsFlag == "R") {
									$flagProb = false;
								}
							}
						}

						//if($noRoutes != 1) {

						if($flagProb) {
                                                        $mergeFlag = False;
							$problemFlag = true;
							if( ( $oddEven++ % 2 ) == 0 ) {
								print("<tr class=\"datawhite\">\n");
							}
							else {
								print("<tr class=\"datagrey\">\n");
							}

							// FOR LOCID
							if($debug) print("<td>$locId</td>");

							// FOR TYPE
							if($flagNotInDelRoute) {
								$type = "Not on any Delivery route";
							}
							else {
								if($noRoutes == 0) {
									if($sdCnt == 0 && $spCnt > 0) {
										$type = "Returns scheduled but not on any route";
									}
									else {
										$type = "Not on any route";
									}
								}
								else {
									$type = "More than one route";
									$mergeFlag = true;
									array_push($_SESSION[TRA37MERGEROUTELOCS], $locId);
								}
							}
                                                      
                                                    
							print("<td align=\"center\"><a href=\"javascript:openpopup1('" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&doAction=ShowDraw&locId=$locId&effDt=" . get_date($dbEffDt, "MMDDYY") . "", ENT_QUOTES) . "');\">" . htmlentities($type, ENT_QUOTES) . "</a></td>\n");

							// FOR CUSTOMER AND LOCATION
							$selectStr = "c.name, CONCAT_WS(' - ', NULLIF(l.storenbr, ''), NULLIF(l.sdesc, ''), NULLIF(a.address1, ''), NULLIF(a.address2, ''), NULLIF(a.address3, ''), NULLIF(a.address4, ''), NULLIF(a.city, ''), NULLIF(a.state, ''), NULLIF(a.postalcode, '')) locDesc";
							$fromStr = "company c, locationlink ll, location l
										LEFT JOIN address a ON l.addressid = a.recid";
							$whereStr = "l.recid = $locId
										AND ll.locationid = l.recid
										AND c.recid = ll.companyid";
							$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
							unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

							if($rsltArr) {
								$custName = $rsltArr[name];
								$locDesc = $rsltArr[locDesc];
							}
							else {
								$custName = "";
								$locDesc = "";
							}
							unset($rsltArr);
							print("<td>" . ($custName != "" ? htmlentities($custName, ENT_QUOTES) : "&nbsp;") . "</td>\n");

							// FOR LOCATION
							print("<td>" . ($locDesc != "" ? htmlentities($locDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");
                                                      

							// FOR ROUTE
							print("<td align=\"center\">");
							if($noRoutes != 0) 
                                                        {
                                                            
                                                           
                                                         if ($mergeFlag)
                                                         {
                                                             $chksdProb = false;
                                                             $chkspProb = false ; 
                                                             $chkProb = false;
                                                             $chkBoProb = false;
                                                          
                                                             if($flagSDProb && $flagSPProb)
                                                             {
                                                                $chkBoProb = true;
                                                                if ($srCnt >=2 && $rrCnt >= 2)
                                                                {
                                                                  $strProb = "$stdrt_str";
                                                                  $chkProb = true;
                                                                }
                                                                 if ($srCnt >=2 && !$chkProb )
                                                                {
                                                                 $strProb = "$routeTypeStr";
                                                                
                                                                }
                                                                if ($rrCnt >=2 && !$chkProb )
                                                                {
                                                                 $strProb = "'RR', 'SS', 'ER', 'CR'";
                                                                 
                                                                }
                                                                 
                                                             }
                                                             
                                                             if($flagSDProb && !$chkBoProb)
                                                             {
                                                                 
                                                                if ($srCnt >=2 && $rrCnt >= 2)
                                                                {
                                                                  $strProb = "$stdrt_str";
                                                                  $chksdProb = true;
                                                                }
                                                                 if ($srCnt >=2 && !$chksdProb )
                                                                {
                                                                 $strProb = "$routeTypeStr";
                                                                }
                                                                if ($rrCnt >=2 && !$chksdProb )
                                                                {
                                                                 $strProb = "'RR', 'SS', 'ER', 'CR'";
                                                                }
                                                                 
                                                             }
                                                             if($flagSPProb && !$chkBoProb)
                                                             {
                                                                 if($rrCnt >=2)
                                                                 {
                                                                 $strProb = "'RR', 'SS', 'ER', 'CR'";
                                                                 }
                                                                 
                                                             }
                                                            
                                                           
                                                          
                                                               $qryGetProb = "SELECT DISTINCT(r.recid), r.routenbr, r.type
									FROM tmpTRA37ChkRuns tsr, route r
									WHERE tsr.locationid = $locId
									AND r.recid = tsr.routeid
									AND r.locationid = $ASLocationID
									AND r.type IN (" . $strProb . ")
									ORDER BY r.routenbr";
                                                                if($debug)
                                                                print($qryGetProb . "<br />\n");
                                                                $rsltGetProb = mysqli_query( $cvtconnection, $qryGetProb);
                                                                
                                                                if(!$rsltGetProb)
                                                                {
                                                                     $fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
                                                                     print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
                                                                     unset($fileLineNbr);
                                                                }
                                                          
                                                                else 
                                                                 {
							             $flagFirstTime = true;
								     if(mysqli_num_rows($rsltGetProb) > 0)
							             mysqli_data_seek($rsltGetProb,  0);
								      while($rowGetProb = mysqli_fetch_assoc($rsltGetProb)) {
									if($flagFirstTime) {
										$flagFirstTime = false;
									}
									else {
										print("<br />\n");
									}
									print("" . htmlentities($rowGetProb[routenbr], ENT_QUOTES) . "");
								                                             }
						                  }
                                                          }
                                                          else
                                                          {
                                                              $flagFirstTime = true;
								if(mysqli_num_rows($rsltGetR) > 0)
									mysqli_data_seek($rsltGetR,  0);
								while($rowGetR = mysqli_fetch_assoc($rsltGetR)) {
									if($flagFirstTime) {
										$flagFirstTime = false;
									}
									else {
										print("<br />\n");
									}
									print("" . htmlentities($rowGetR[routenbr], ENT_QUOTES) . "");
								}
                                                              
                                                          }
                                                        }
							
                                                
							else {
								print("&nbsp;");
							}
							print("</td>\n");

							// FOR FIX
							print("<td align=\"center\">");
							print("<a href=\"");
							if($noRoutes == 0 || $flagNotInDelRoute) {
								print("" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=ToAddLoc&pdid=$pdid&locid=$locId", ENT_QUOTES) . "");
							}
							else {
								print("" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=ToDelLoc&pdid=$pdid&locid=$locId&flagSDProb=$flagSDProb&flagSPProb=$flagSPProb&mulroute=$mergeFlag&srCnt=$srCnt&rrCnt=$rrCnt&Rundate=$dbEffDt", ENT_QUOTES) . "");
							}
							print("\">");
							print("<img src=\"../img/sel.gif\" border=\"0\" height=\"12\" width=\"12\" alt=\"\" /></a></td>\n");

							print("</tr>\n");
							$cntLocs++;



						}


						ob_flush();
						$totalLocCnt++;
					}

					// UNSET THE ARRAY AND AGAIN SET IT
					unset($locIdArr);

					$locIdArr = array();
					$batchCnt = 0;
				}//for loop
			}//while($rowGetInfo = mysql_fetch_assoc($rsltGetInfo))
				if($cntLocs > 0){
				print "<font color= 'red'>WARNING! Problems found.  Please correct before proceeding to avoid incorrect routes.</font><br>";
				}
			
		}
		print("</table>\n");

		if($debug) {
			print("Locs Found = $cntLocs<br />");
			print("Locs Proccesed = $totalLocCnt<br />");
		}

		// THE TWO QUERIES ARE THERE FOR OPTIMISATION
		$tempSrIdStr = "";
		$qryGetSrId = "SELECT sr.recid srId
						FROM specificroutes sr, route r
						WHERE sr.dispatchlocid = $ASLocationID
						AND sr.datesked = '$dbEffDt'
						AND r.recid = sr.routeid
						AND r.locationid = $ASLocationID
						AND r.type IN (" . $stdrt_str . ")";

		// FOR SPLITTING OF TABLES

		$qryGetSrId = convertToSplitTables($qryGetSrId, $val_SPLIT);

		if($debug)
			print($qryGetSrId . "<br />\n");
		$rsltGetSrId = mysqli_query( $cvtconnection, $qryGetSrId);
		if(!$rsltGetSrId) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetSrId) == 0) {
				$tempSrIdStr = "";
			}
			else {
				while($rowGetSrId = mysqli_fetch_assoc($rsltGetSrId)) {
					$srId = $rowGetSrId[srId];
					if(!is_numeric($srId)) $srId = 0;
					if($tempSrIdStr == "") {
						$tempSrIdStr = $srId;
					}
					else {
						$tempSrIdStr .= ", " . $srId;
					}
				}
			}
		}

		if($tempSrIdStr == "") {
			$tempSrIdStr = "0";
		}

		// NOW FINDING THE LOCATIONS WHICH HAVE TWO DIFFERENT ROUTES
		$qryGetSRLLocInfo = "SELECT srl.locationid locId, COUNT(DISTINCT(srl.specificrouteid)) srCnt
							FROM specificrouteloc srl, location l
							WHERE srl.specificrouteid IN (" . $tempSrIdStr . ")
							AND srl.clientlocid = $ASLocationID
							AND srl.locationid = l.recid
							AND l.type != 'G'
							GROUP BY srl.locationid
							HAVING srCnt > 1
							ORDER BY srl.locationid";

		// FOR SPLITTING OF TABLES
		$qryGetSRLLocInfo = convertToSplitTables($qryGetSRLLocInfo, $val_SPLIT);

		if($debug)
			print($qryGetSRLLocInfo . "<br />\n");
		$rsltGetSRLLocInfo = mysqli_query( $cvtconnection, $qryGetSRLLocInfo);

		if(!$rsltGetSRLLocInfo) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			while($rowGetSRLLocInfo = mysqli_fetch_assoc($rsltGetSRLLocInfo)) {

				$locId = $rowGetSRLLocInfo[locId];
				if(!is_numeric($locId))	$locId = 0;

				if(!in_array($locId, $_SESSION[TRA37MERGEROUTELOCS]))
					array_push($_SESSION[TRA37MERGEROUTELOCS], $locId);
			}
		}

		if($debug)
			print("MergeLocs : " . COUNT($_SESSION[TRA37MERGEROUTELOCS]) . "<br />\n");

		//if($mergeFlag)
		if(COUNT($_SESSION[TRA37MERGEROUTELOCS]) > 0 && $val_MERGE == "Y") {

			$mergeRouteLink = htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&doAction=ToMergeRoutes&pdid=$pdid", ENT_QUOTES);
			print("<br /><br /><div>");
			print("<a href=\"javascript:msgMergeRoute('$mergeRouteLink');\">Merge Routes</a>\n");
			print("</div>\n");
		}

		if(!$problemFlag) {
			print("<br /><br /><div>");
			print("<input type=\"button\" value=\"Runs Checked  - Proceed to the Next Step\" onclick=\"location.href='../cm/doback.php?Back=$Back'\"/>");

			print("</div>\n");
		}

		// GET ITS INDEX
		for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
			if($pdFieldsArr[$tempi] == "checkruns") {
				$checkruns_index = $tempi;
				break;
			}
		}

		// PREPARE STRING
		$setStr = "";
		for($tempi = $checkruns_index + 1; $tempi < count($pdFieldsArr); $tempi++) {
			$setStr .= ", {$pdFieldsArr[$tempi]}as = 0, {$pdFieldsArr[$tempi]}dt = NULL";
		}


		//NOW UPDATE PRODUCT DISPATCH RECORD
		$qryUp = "UPDATE productdispatch
					SET checkrunsdt = now(),
					checkrunsas = $RecIdAS
					" . $setStr . "
					WHERE recid = $pdid";
		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
		}
		print("</div>\n");
		break;

	case "ToAddLoc":
	case "ToDelLoc":
		// VALIDATION
		ValidateForInt(false, "pdid", "locid");
		print("<div class=\"datawhite\">");

		//DISPLAY LOCATION
		$fileLineNbr = __LINE__; $comploc = GetCompLoc($locid, $cvtconnection, 2);
		print("<b><u>" . htmlentities($comploc, ENT_QUOTES) . "</u></b><br /><br />");

		if($doAction == "ToDelLoc") {
			print("<b>Delete</b>");
		}
		else {
			print("<b>Add</b>\n");
		}
		print("<br /><br />\n");

		//QUERY TO GET INFORMATION
		$qryGetInfo = "SELECT DISTINCT(sr.recid) srid,
						CONCAT_WS(', ', NULLIF(r.routenbr, ''), NULLIF(r.sdesc, ''), NULLIF(TIME_FORMAT(sr.timesked, '%H:%i:%s'), '')) specrouteinfo,
						sr.driverid, r.recid routeid
						FROM route r/*, routesetdetail rsd*/, productdispatch pd,
						specificroutes sr";
		if($doAction == "ToDelLoc")
			$qryGetInfo .= ", specificrouteloc srl";
                
                
                
                
                
                
                
                
                
                
                
		$qryGetInfo .= " WHERE pd.recid = $pdid
						/*AND rsd.routesetid = pd.routesetid
						AND r.recid = rsd.routeid*/
						AND r.locationid = $ASLocationID
						AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
						OR r.endeffdt > '$curDate' )
						AND sr.routeid = r.recid
						AND sr.datesked = pd.rundate
						AND sr.dispatchlocid = $ASLocationID";
                
                if($doAction == "ToDelLoc")
                {
                 if ($mulroute)
                  {
                    $stdrt_array = GeneralArray("routetype_standard");
		    $stdrt_str = MakeStrFromArray($stdrt_array, ", ", "'");
		    if($stdrt_str == "") $stdrt_str = "''";

		    $stdrt_str .= ", 'RR', 'SS', 'CR','PR','ND'";

		    if($val_ESRTE == "Y") {
			$stdrt_str .= ", 'ER'";
		    }

		    if($val_HAWKS == 'Y') {
			$stdrt_str .= ", 'AM', 'PM', 'TR'";
		      }
                     
                    $routeTypeStr = "'SR', 'PR'";
                    if($val_HAWKS == "Y") {
			$routeTypeStr .= ", 'AM', 'PM', 'TR'";
		      }

                                                             $chksdProb = false;
                                                             $chkspProb = false ; 
                                                             $chkProb = false;
                                                             $chkBoProb = false;
                                                             
                                                             if($flagSDProb && $flagSPProb)
                                                             {
                                                                 $chkBoProb = true;
                                                                if ($srCnt >=2 && $rrCnt >= 2)
                                                                {
                                                                  $strProb = "$stdrt_str";
                                                                  $chkProb = true;
                                                                }
                                                                 if ($srCnt >=2 && !$chkProb )
                                                                {
                                                                 $strProb = "$routeTypeStr";
                                                                }
                                                                if ($rrCnt >=2 && !$chkProb)
                                                                {
                                                                 $strProb = "'RR', 'SS', 'ER', 'CR'";
                                                                }
                                                                 
                                                             }
                                                             if($flagSDProb && !$chkBoProb)
                                                             {
                                                                if ($srCnt >=2 && $rrCnt >= 2)
                                                                {
                                                                  $strProb = "$stdrt_str";
                                                                  $chksdProb = true;
                                                                }
                                                                 if ($srCnt >=2 && !$chksdProb )
                                                                {
                                                                 $strProb = "$routeTypeStr";
                                                                }
                                                                if ($rrCnt >=2 && !$chksdProb )
                                                                {
                                                                 $strProb = "'RR', 'SS', 'ER', 'CR'";
                                                                }
                                                                 
                                                             }
                                                             if($flagSPProb && !$chkBoProb)
                                                             {
                                                               
                                                                if ($rrCnt >=2  )
                                                                {
                                                                 $strProb = "'RR', 'SS', 'ER', 'CR'";
                                                                }
                                                                 
                                                             }
                                                    $qryGetInfo .= " AND r.type IN($strProb)" ; 
                    }
                
                }
		if($doAction == "ToDelLoc") {
			$qryGetInfo .= " AND srl.specificrouteid = sr.recid
							AND srl.locationid = $locid
							AND srl.clientlocid = $ASLocationID";
		}
		$qryGetInfo .= " ORDER BY specrouteinfo";

		// FOR SPLITTING OF TABLES
		$qryGetInfo = convertToSplitTables($qryGetInfo, $val_SPLIT);

		if($debug)
			print($qryGetInfo . "<br />\n");

		print("<table border=\"1\" width=\"100%\">\n");
		print("<tr class=\"datatblhdr\">\n");
		if($debug) print("<td>srid - routeid</td>\n");
		print("<td align=\"center\" width=\"10%\">Sel</td>\n");
		print("<td>Route</td>\n");
		print("</tr>\n");

		$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
		$oddEven = 0;
		if(!$rsltGetInfo) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
			
				$CFlag = 0;
				if( ( $oddEven++ % 2 ) == 0 ) {
					print("<tr class=\"datawhite\">\n");
				}
				else {
					print("<tr class=\"datagrey\">\n");
				}

				// FOR ROUTEID
				$srid = $rowGetInfo[srid];
				$routeid = $rowGetInfo[routeid];

				ValidateForInt(false, "srid", "routeid");
				if($debug) print("<td>$srid - $routeid</td>\n");

				// FOR SEL
				print("<td align=\"center\">\n");
				if($doAction == "ToDelLoc") {
						
					$qryGetCount = "SELECT count(ta.recid) Total
							FROM transactivity ta
							WHERE ta.locationid = $ASLocationID
							AND ta.type IN ('SD','SP')
							AND ta.datet = '$Rundate'
							AND specificrouteid = '$srid'
							AND ta.customerlocid = $locid
							";
					
					// FOR SPLITTING OF TABLES
					$qryGetCount = convertToSplitTables($qryGetCount, $val_SPLIT);
			
					if($debug)
						print($qryGetCount . "<br />\n");
					
					$rsltGetCount = mysqli_query( $cvtconnection, $qryGetCount);
					$rowGetCount = mysqli_fetch_assoc($rsltGetCount);
					if($rowGetCount[Total] >= 1)
					{
						$CFlag = 1;	
					}
					else
					{
						$CFlag = 0;	
					}
					
				
					//FIND SRLID
					$qryChkRecs = "SELECT recid
									FROM specificrouteloc
									WHERE specificrouteid = $srid
									AND locationid = $locid
									AND clientlocid = $ASLocationID";

					// FOR SPLITTING OF TABLES
					$qryChkRecs = convertToSplitTables($qryChkRecs, $val_SPLIT);

					if($debug) print($qryChkRecs . "<br />\n");
					$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
					if(!$rsltChkRecs) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
							$srlid = $rowChkRecs[recid];
							if(!is_numeric($srlid)) $srlid = 0;
						}
						else {
							$srlid = 0;
						}
					}
					print("<a href=\"javascript:DelConfirm('$PassedPageNbr','$srlid','$routeid','$CFlag');\"><img src=\"../img/del.gif\" border=\"0\" height=\"12\" width=\"12\" alt=\"\" /></a>\n");
				}
				else {
					print("<a href=\"" . htmlspecialchars("../rd/tra06.php?PageNbr=$PassedPageNbr&doAction=ToAddRecord&specRtRecId=$srid&newLocId=$locid", ENT_QUOTES) . "\"><img src=\"../img/sel.gif\" border=\"0\" height=\"12\" width=\"12\" alt=\"\" /></a>");
				}
				print("</td>\n");

				// FOR ROUTE
				$specRouteInfo = $rowGetInfo[specrouteinfo];
				$driverId = $rowGetInfo[driverid];
				if(!is_numeric($driverId)) $driverId = 0;

				if($driverId != 0) $specRouteInfo .= " - " . GetPer($driverId, $cvtconnection);;

				print("<td>" . ($specRouteInfo != "" ? htmlentities($specRouteInfo, ENT_QUOTES) : "&nbsp;") . "</td>\n");

				print("</tr>\n");
			}
		}
		print("</table>\n");
		print("</div>\n");
		break;

	case "ToCloseDraw":
	case "ToCloseDrawForce":
		// VALIDATION
		ValidateForInt(false, "pdid");

		$val_NIDIS = GetLSVar("NIDIS", "charvar", $ASLocationID, $cvtconnection);
		if($debug) print("NIDIS = $val_NIDIS<br />\n");

		print("<div class=\"datawhite\">");

		//GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt", "routesetid");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
			$rsId = $rsltArr[routesetid];
			if(!is_numeric($rsId)) $rsId = 0;
		}
		else {
			$effdt = "";
			$dbEffDt = "";
			$rsId = 0;
		}
		unset($rsltArr, $fileLineNbr);

		// HERE WE NEED TO CHECK FIRST WHETHER THERE ALREADY EXIST DE/PU RECORDS
		// AND IF YES, DONT ALLOW THE USER TO RUN THIS. ELSE IF SD/SP RECORDS
		// EXIST WARN HIM BEFORE CREATING RECORDS BECAUSE SD/SP RECORDS ARE GOING TO BE
		// DELETED
		if(IsActualActivitiyDone_TRA37($dbEffDt)) {
			print("Sorry, the current set is already in use for this day and cannot be changed.<br /><br />");
			print("<a href=\"" . urldecode(htmlspecialchars($Back, ENT_QUOTES)) . "\">OK</a>\n");
		}
		elseif($doAction == "ToCloseDraw" && $val_NIDIS == "Y" && IsNextDayCloseDrawDtSet_TRA37($dbEffDt)) {
			print("<b>Sorry, since tomorrow has already been dispatched, today cannot be re-dispatched</b><br /><br />");
			print("<a href=\"" . urldecode(htmlspecialchars($Back, ENT_QUOTES)) . "\">OK</a>\n");
		}
		elseif($doAction == "ToCloseDraw" && IsScheduledActivityDone_TRA37($dbEffDt)) {
			print("<b>Warning :</b> you are about to <b>clear</b> the <b>Route Delivery Sheet</b> data previously created.<br /><br />  Are you sure?");
			print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
			print("<a href=\"" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=ToCloseDrawForce&pdid=$pdid", ENT_QUOTES) . "\">Yes</a>\n");
			print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
			print("<a href=\"" . urldecode(htmlspecialchars($Back, ENT_QUOTES)) . "\">No</a>\n");
		}
		elseif($doAction == "ToCloseDraw" && !IsPrevDayRunExists_TRA37($dbEffDt)) {
			if($val_NIDIS == "Y") {
				print("Sorry, yesterday was not dispatched. Dates must be processed in sequence to avoid mis-scheduling returns.<br /><br />");
				print("<a href=\"" . urldecode(htmlspecialchars($Back, ENT_QUOTES)) . "\">Back</a>\n");
			}
			else {
				print("<b>Warning : Yesterday was not dispatched.</b> <br />Dates must be processed in sequence to avoid  mis-scheduling returns.<br /><br />  Are you sure?");
				print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
				print("<a href=\"" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=ToCloseDrawForce&pdid=$pdid", ENT_QUOTES) . "\">Yes</a>\n");
				print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
				print("<a href=\"" . urldecode(htmlspecialchars($Back, ENT_QUOTES)) . "\">No</a>\n");
			}
		}
		else {
			/*if($pdid != 0) {
				$command = "perl ../rd/tra37.pl " . $_SESSION[db] . " " . $_SESSION[tempusr] . " " . $_SESSION[temppwd] . " " . $pdid . " " . $RecIdAS . "";
				//$output = `$command`;
				$output = exec($command);
				if($debug) print("<pre>$output</pre><br />");
			}*/

			if($doAction == "ToCloseDrawForce" ) {

				/* Log01 details
				Date - Date that the entry occurred
				Time - Time that the entry occurred
				Service - TRA37
				TransType - NULL
				ImpNbr - NULL
				ErrCode - "N003"
				Seriousness - "4"
				CommNbr - NULL
				ClientId - ActiveSession.CompanyId
				PersonId - ActiveSEssion.PersonId
				DeviceId - NULL
				NotifyFlag - NULL
				Comment  - "Run Date:" Active run date.*/

				/*if(IsScheduledActivityDone_TRA37($dbEffDt) && !IsPrevDayRunExists_TRA37($dbEffDt)) {
					$comment = "Run Date: " . get_date($dbEffDt, 'MM/DD/YY') . " and SD / SP exists.";
				} elseif(!IsPrevDayRunExists_TRA37($dbEffDt)) {
					$comment = "Run Date: " . get_date($dbEffDt, 'MM/DD/YY');
				}

				$qryIns = "INSERT INTO log01(date, time, service, errcode, seriousness,
							clientid, personid, comment)
							VALUES(CURDATE(), CURTIME(), 'TRA37', 'N003', '4',
							$ASCompanyID, $PersonId, '" . addslashes($comment) . "')";
				if($debug) print("<b>" . $qryIns . "</b><br />\n");
				$rsltIns = mysql_query($qryIns, $cvtconnection);
				if(!$rsltIns) print("<b>Can't insert into log01</b><br />");*/

				if(!IsPrevDayRunExists_TRA37($dbEffDt)) {

					$comment = "Run Date: " . get_date($dbEffDt, 'MM/DD/YY');

					if(IsScheduledActivityDone_TRA37($dbEffDt))
						$comment .= " and SD / SP exists.";

					$qryIns = "INSERT INTO log01(date, time, service, errcode, seriousness,
								clientid, personid, comment)
								VALUES(CURDATE(), CURTIME(), 'TRA37', 'N003', '4',
								$ASCompanyID, $PersonId, '" . addslashes($comment) . "')";
					if($debug)
						print("<b>" . $qryIns . "</b><br />\n");
					$rsltIns = mysqli_query( $cvtconnection, $qryIns);
					if(!$rsltIns) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if($debug)
							print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
					}
				}
			}

			// UPDATE SYSTEM TABLE
			$qryUp = "UPDATE locationsystem
						SET datevar = CURDATE(),
						strvar = '$dbEffDt',
						charvar = 'Y'
						WHERE locationid = $ASLocationID
						AND recid = 'CDRWO'";
			if($debug)
				print("<b>" . $qryUp . "</b><br />\n");
			$rsltUp = mysqli_query( $cvtconnection, $qryUp);
			if(!$rsltUp) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if($debug)
					print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
			}

			//NOW UPDATE THE CLOSEDRAWAS AND CLOSEDRAWDT and all next functions to NULL
			// GET ITS INDEX
			for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
				if($pdFieldsArr[$tempi] == "closedraw") {
					$closedraw_index = $tempi;
					break;
				}
			}

			// PREPARE STRING
			$setStr = "";
			for($tempi = $closedraw_index + 1; $tempi < count($pdFieldsArr); $tempi++) {
				$setStr .= ", {$pdFieldsArr[$tempi]}as = 0, {$pdFieldsArr[$tempi]}dt = NULL";
			}

			$qryUp = "UPDATE productdispatch
						SET closedrawdt = NULL,
						closedrawas = 0
						" . $setStr . "
						WHERE recid = $pdid";
			if($debug)
				print("<b>" . $qryUp . "</b><br />\n");
			$rsltUp = mysqli_query( $cvtconnection, $qryUp);
			if(!$rsltUp) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if($debug)
					print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
			}
			

			//print("<b>Delivery and Returns Instructions Created.</b><br /><br />");

			if($debug) {
				print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
			}
			else {
				header("Location: " . urldecode($Back));
			}
		}
		print("</div>\n");
		break;

	case "EmBack":
		// VALIDATION
		ValidateForInt(false, "pdid");

		print("<div class=\"datawhite\">");

		// HERE FIRST WE NEED TO GIVE THE MESSAGE TO THE USER TO ASK
		// ASKING FOR EMERGENCY BACKUP
		print("Do you want to create an <b>Emergency Backup</b>?<br />\n");
		print("<a href=\"javascript:openpopup('" . htmlspecialchars("../rd/tra32.php?PageNbr=$PassedPageNbr&pdId=$pdid", ENT_QUOTES) . "')\">Yes</a>\n");
		print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
		print("<a href=\"javascript:self.close();\">No</a>\n");

		// CHECKING FOR SHOWING EMAIL DELIVERY SLIPS.
		$val_DISDS = GetLSVar("DISDS", "charvar", $ASLocationID, $cvtconnection);
		if($debug) print("<br />DISDS = $val_DISDS<br />\n");

		if($val_DISDS == "Y") {

			print("<br /><br />Do you want to eMail Delivery Slips?<br />");
			print("<a href=\"javascript:openpopup('" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&pdid=$pdid&doAction=ShowDeliverySlips", ENT_QUOTES) . "')\">Yes</a>\n");
			print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
			print("<a href=\"javascript:self.close();\">No</a>\n");
		}

		// CHECKING FOR SHOWING AUTOFIL.
		$val_AUFIL = GetLSVar("AUFIL", "charvar", $ASLocationID, $cvtconnection);
		if($debug) print("<br />AUFIL = $val_AUFIL<br />\n");

		if($val_AUFIL == "Y") {

			print("<br /><br />Do you want to Auto-fill deliveries?<br />");
			print("<a href=\"javascript:openpopup('" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&pdid=$pdid&doAction=SelRoutes&dayVal=0&flagAutoFill=1", ENT_QUOTES) . "')\">Yes, for today</a>\n");
			print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
			print("<a href=\"javascript:openpopup('" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&pdid=$pdid&doAction=SelRoutes&dayVal=-1&flagAutoFill=1", ENT_QUOTES) . "')\">Yes, for yesterday</a>\n");
			print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
			print("<a href=\"javascript:self.close();\">No</a>\n");
		}
                
                
                if($char_ARS65 == "S"){
                    print("<br /><br />Do you want to update the ERP draw?<br />");
                    //print("<a href=\"javascript:openpopup('" . htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&pdid=$pdid&doAction=ShowDeliverySlips", ENT_QUOTES) . "')\">Yes</a>\n");
                    print("<a href=\"" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=ProcessERP&pdid=$pdid", ENT_QUOTES) . "\">Yes</a>");
                    print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
                    print("<a href=\"javascript:self.close();\">No</a>\n");
                }

		print("</div>\n");
		break;
                
        case "ProcessERP":
            #$debug=1;
            if($debug){
                echo '<pre>';print_r($_REQUEST);
            }
            if(!is_numeric($rsId)) $rsId = 0;
            $fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
            if($rsltArr[rtvalue]) {
                $dbEffDt = $rsltArr[dbEffDt];
            }
            else {
                $dbEffDt = "";
            }
            unset($rsltArr, $fileLineNbr);
            
            if($debug) {
                print("char_ARS65 = $char_ARS65<br />\n");
                print("dbEffDt = $dbEffDt<br />\n");
            }
            
            fn_process_EMR("65", $dbEffDt, $debug, $cvtconnection);

            if ($debug) {
                print("<a href=\"javascript:" . urldecode($Back) . "\">Back</a><br />\n");
            } else {
                print("<script language=\"JavaScript\" type=\"text/javascript\">" . $Back . "</script>\n");
            }
            break;
        
	case "PrintForms":
		// VALIDATION
		ValidateForInt(false, "pdid");
	
		// GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt", "routesetid", "returnsroutesetid rsRsId");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
			$rsId = $rsltArr[routesetid];
			$rsRsId = $rsltArr[rsRsId];
			ValidateForInt(false, "rsId", "rsRsId");
		}
		else {
			$effdt = "";
			$dbEffDt = "";
			$rsId = 0;
			$rsRsId = 0;
		}
		unset($rsltArr, $fileLineNbr);

		$rsIdArr = array($rsId, $rsRsId);
		$rsIdStr = MakeStr_TRA37($rsIdArr);
		if($rsIdStr == "") $rsIdStr = "0";

		print("<div class=\"datawhite\">");

		// PRINT THE DATE
		$dispEffDt = set_date($effdt, "MMDDYY", "MM/DD/YY");
		print("<b><u>Run Date - $dispEffDt</u></b><br /><br />");

		//HERE DISPLAY THE SPECIFICROUTES IF ANY
//		$qryGetInfo = "SELECT DISTINCT(sr.recid) srId, r.routenbr routeNbr, r.sdesc routeDesc,
//						TIME_FORMAT(sr.timesked, '%H:%i:%s') timeSked,
//						sr.driverid driverId, r.recid routeId
//						FROM routesetdetail rsd,
//						specificroutes sr, route r
//						WHERE rsd.routesetid IN ($rsIdStr)
//						/*rsd.routesetid = $rsId*/
//						AND sr.routeid = rsd.routeid
//						AND sr.dispatchlocid = $ASLocationID
//						AND sr.datesked = '$dbEffDt'
//						AND r.recid = sr.routeid
//						AND r.locationid = $ASLocationID
//						AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
//						OR r.endeffdt > '$curDate' )
//						ORDER BY r.sortseqnbr, r.routenbr, r.sdesc, datesked";


     /* 3.2 */  print("<form name=\"Level0Form\" method=\"get\" action=\"tra37.php\">\n");
                print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n"); /* 3.2 */ 
                
		print("<div align=\"left\">\n");
		// RADIO BUTTONS FOR INCLUDE
		if(!isset($rdMode)) $rdMode = "Normal";

		print("<b>Mode : </b>\n");
		print("<label for=\"rdModeN\">Normal</label>\n");
		print("<input id=\"rdModeN\" type=\"radio\" name=\"rdMode\" value=\"Normal\" onclick=\"\"");
		if($rdMode == "Normal")
			print(" checked=\"checked\"");
		print(" />\n");
		print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");

		print("<label for=\"rdModeC\">Compressed</label>\n");
		print("<input id=\"rdModeC\" type=\"radio\" name=\"rdMode\" value=\"Compressed\" onclick=\"\"");
		if($rdMode == "Compressed")
			print(" checked=\"checked\"");
		print(" />\n");
		print("<br /><br />\n");
                
                /* 3.2 */
                 if($val_RFLTR == 'R')
                 {
                    $filterMode = "R";
                 }
                 else if($val_RFLTR == 'C')
                 {
                    $filterMode = "C";
                 }
                 else if($val_RFLTR == 'B')
                 {
                    
                        if(!isset($filterMode) || $filterMode == "")
		        $filterMode = "R";
                        
                        // FOR FILTER ROUTE BY MODE RADIO BUTTONS
                        print("<b>Filter Route By : </b>\n");
                        
                        // FOR FILTER ROUTE BY ROUTE GROUP MODE RADIO BUTTONS 
			print("<label for=\"filtertModeR\">Route Group</label>");
			print("<input id=\"filterModeR\" type=\"radio\" name=\"filterMode\" value=\"R\" onclick=\"this.form.submit();\"");
			if($filterMode == "R")
				print(" checked=\"checked\"");
			print(">\n");
			print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
                        
                        // FOR FILTER ROUTE BY ROUTE NUMBER DESCRIPTION MODE RADIO BUTTONS 
                        print("<label for=\"filterModeC\">Route Number Description</label>");
			print("<input id=\"filterModeC\" type=\"radio\" name=\"filterMode\" value=\"C\" onclick=\"this.form.submit();\"");
			if($filterMode == "C")
				print(" checked=\"checked\"");
			print(">\n");
			print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
                        print("<br /><br>");
                 }
                if($filterMode == 'R' )
                {
                  
                // FOR FILTER ROUTE BY ROUTE GROUP MODE 
                    
                if(!isset($rdGroupType) || $rdGroupType == "") {
			$rdGroupType = "A";
		}
                // FOR TYPE RADIO BUTTONS
		print("<b>Type :</b>\n");
                
                // FOR ALL GROUPING
		print("<label for=\"rdA\">All</label>\n");
		print("<input id=\"rdA\" type=\"radio\" name=\"rdGroupType\" value=\"A\" onclick=\"this.form.submit();\"");
		if($rdGroupType == "A") {
			print(" checked=\"checked\"");
		}
		print(" />\n");
		print("&nbsp;&nbsp;&nbsp;&nbsp;");
                
		//FOR DISPATCH GROUPING
		print("<label for=\"rdD\">Dispatch Grouping</label>\n");
		print("<input id=\"rdD\" type=\"radio\" name=\"rdGroupType\" value=\"D\" onclick=\"this.form.submit();\"");
		if($rdGroupType == "D") {
			print(" checked=\"checked\"");
		}
		print(" />\n");
		print("&nbsp;&nbsp;&nbsp;&nbsp;");

		// FOR TRUCK LOADING - PLAN A
		print("<label for=\"rdT\">Truck Loading - Plan A</label>\n");
		print("<input id=\"rdT\" type=\"radio\" name=\"rdGroupType\" value=\"T\" onclick=\"this.form.submit();\"");
		if($rdGroupType == "T") {
			print(" checked=\"checked\"");
		}
		print(" />\n");
		print("&nbsp;&nbsp;&nbsp;&nbsp;");

		// FOR TRUCK LOADING - PLAN B
		print("<label for=\"rdB\">Truck Loading - Plan B</label>\n");
		print("<input id=\"rdB\" type=\"radio\" name=\"rdGroupType\" value=\"B\" onclick=\"this.form.submit();\"");
		if($rdGroupType == "B") {
			print(" checked=\"checked\"");
		}
		print(" />\n");
		print("<br /><br />");
                
              
                if($rdGroupType != '' && $rdGroupType != "A")
                {
                  // FOR SELECT ROUTE GROUP(S)
                  print("<a href=\"javascript:openpopup1('" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=ToSelRouteGroup&rdGroupType=$rdGroupType", ENT_QUOTES) . "');\">Select Route Group</a>\n");
	          print("<br /><br />");
                }
                
                # display selected route group set from session variable
		if(!isset($_SESSION[TRA37ROUTEGROUPIDSTR]) || $_SESSION[TRA37ROUTEGROUPIDSTR] == "") {
			$routeGroupIdStr = "";
                  
		}
		else {
			$routeGroupIdStr = $_SESSION[TRA37ROUTEGROUPIDSTR];
                        $_SESSION[TRA37ROUTEGROUPIDSTRDIS][$rdGroupType] = $routeGroupIdStr;
                        unset($_SESSION[TRA37ROUTEGROUPIDSTR]);
		}

		if($routeGroupIdStr == "") $routeGroupIdStr = "0";
                
                if(isset($_SESSION[TRA37ROUTEGROUPIDSTRDIS][$rdGroupType])) {
				# display route group set 
				print("<b>Selected Route Group: </b>");
				echo GetRouteGroupDesc($_SESSION[TRA37ROUTEGROUPIDSTRDIS][$rdGroupType]);
				$routeGroupIdStr = $_SESSION[TRA37ROUTEGROUPIDSTRDIS][$rdGroupType];
				print("<br /><br />\n");
		}
                
                $fromTable = "" ;
                $whereTable = "";
                if($rdGroupType != "A")
                {
                   
                $fromTable = " , routegroup rg, routegrouplink rgl ";
                $whereTable = " AND rg.clientlocid = $ASLocationID
				AND rg.type = '$rdGroupType'
				AND (rg.endeffdt IS NULL OR rg.endeffdt = '0000-00-00' OR rg.endeffdt > '$curDate')
				AND rgl.clientlocid = $ASLocationID
				AND rgl.routegroupid = rg.recid
                                AND r.recid = rgl.routeid ";
                if($routeGroupIdStr != "0" )
                $whereTable .= " AND rg.recid IN ($routeGroupIdStr) ";
                }
                
                }
                if($filterMode == 'C' )
                {
                  // FOR FILTER ROUTE BY ROUTE NUMBER DESCRIPTION MODE
                  
                   print("<b>Route Number Description :</b>\n"); 
                   
                   $lookUpText = '';
                   $txtcount = 0;
                   for($i=1; $i <= $Intvar_RFLTR; $i++ )
                   {
                      // char data entry Search boxes as many defined in locationsystem RFLTR intvar(Default = 6)
                      $txtvalue = $txtLookUpText[$i];
                      $k = $i + 1;
                      print("<input type=\"text\" name=\"txtLookUpText[".$i."]\" value=\"$txtvalue\" size=\"1\" maxlength=\"1\"  onkeyup=\"inputFocus(event,$k)\" \" />\n"); 
		   
                      $txtcount++;
                   }
                  
                   print("<input type=\"hidden\" name=\"txtcount\" value=\"$txtcount\" />\n");
                   
                   // FOR FILTER ROUTE LINK
                   print("&nbsp;&nbsp; <a href=\"javascript:submitLevel0FormSearch(document.Level0Form,'FS');\">Filter Routes</a>\n");
                   // FOR RESET ROUTE LINK
                   print("&nbsp;&nbsp; <a href=\"javascript:submitLevel0FormSearch(document.Level0Form, 'RS');\">Reset Filter</a>\n");
                   
                   if (empty($txtLookUpText) || !isset($txtLookUpText)) {
                        $lookUpText = '';
                   }
                   else
                   {
                       // This section is used for create look up text string for like query
                        foreach ($txtLookUpText as $value) {
                        if($value == '')
                        $lookUpText .= '_';
                        else
                        $lookUpText .= $value;
                        }
                       
                         
                        $j = 0;
                        for($i=strlen($lookUpText); $i >= 1 ; $i--)
                        {
                         // find the postion of last character enterd in serch box    
                         if(substr($lookUpText,$i-1,1) == "_" || substr($lookUpText,$i-1,1) == ""  ) 
                         {
                         }
                         else
                         {   $j = $i;
                             break;  
                         }
                                 
                        }
                        
                        // get the string before the last character enterd in the serch box
                        $fistchr = substr($lookUpText,0,$j);
                        $lookUpText = $fistchr;
                        
                        if($lookUpText == '')
                        $whereTable = '';
                        else
                        $whereTable = " And r.routenbr LIKE '$lookUpText%' ";
                         
                   }
                    
                }
                
                
                print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
                print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
	        print("<input type=\"hidden\" name=\"dispEffDt\" value=\"$dispEffDt\" />\n");
                print("<input type=\"hidden\" name=\"mode\" value=\"$rdMode\" />\n");
                
                print("</div>\n");
                print("</form>\n");
                
                if($ignoreRtType != 0 && $ignoreRtType != '')
				$chkRtType = " AND r.type NOT IN ($ignoreRtType) ";
		$qryGetInfo = "SELECT /* tra37 */ DISTINCT sr.recid srId, r.routenbr routeNbr, r.sdesc routeDesc,
						TIME_FORMAT(sr.timesked, '%H:%i:%s') timeSked,
						sr.driverid driverId, r.recid routeId
						FROM specificroutes sr, route r $fromTable
						WHERE sr.dispatchlocid = $ASLocationID
						AND sr.datesked = '$dbEffDt'
						AND r.recid = sr.routeid
						$chkRtType
						AND r.locationid = $ASLocationID
						AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
						OR r.endeffdt > '$curDate' ) $whereTable
                                                ORDER BY r.sortseqnbr, r.routenbr, r.sdesc, datesked";

		// FOR SPLITTING OF TABLES
		$qryGetInfo = convertToSplitTables($qryGetInfo, $val_SPLIT);

		if($debug)
			print($qryGetInfo . "<br />\n");
		$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
                
                
                print("<form name=\"Level1Form\" method=\"Post\" action=\"tra37.php\" style=\"margin: 0;\">\n");
                /* 3.2 */
                print("<table border=\"1\" width=\"100%\">\n");
		print("<tr class=\"datatblhdr\">\n");
		if($debug) print("<td>routeid - srid</td>\n");
		print("<td align=\"center\" width=\"10%\"><input type=\"checkbox\" name=\"checkall\" value=\"checkall\" onclick=\"CheckBoxAll(this.form, this.checked, 'rec')\" /></td>\n");
		print("<td align=\"center\">Route Number</td>\n");
		print("<td>Description</td>\n");
		print("<td align=\"center\">Time</td>\n");
		print("<td>Driver</td>\n");
		print("</tr>\n");

		$oddEven = 0;
		$cntid = 0;
		$routeIdStr = "";
		if(!$rsltGetInfo) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
				if( ( $oddEven++ % 2 ) == 0 ) {
					print("<tr class=\"datawhite\">\n");
				}
				else {
					print("<tr class=\"datagrey\">\n");
				}

				// FOR SRID
				$srId = $rowGetInfo[srId];
				$routeId = $rowGetInfo[routeId];
				ValidateForInt(false, "routeId", "srId");
				if($debug) print("<td>$routeId - $srId</td>");

				$routeId = $rowGetInfo[routeId];
				if($routeIdStr == "") {
					$routeIdStr = $routeId;
				}
				else {
					$routeIdStr .= ", " . $routeId;
				}

				// CHECKBOX
				print("<td align=\"center\"><input type=\"checkbox\" name=\"rec[" . $cntid . "]\" value=\"" . $srId . "\" onclick=\"CheckBoxSingle(this.form, this.checked)\" /></td>\n");

				// FOR ROUTE NUMBER
				$routeNbr = $rowGetInfo[routeNbr];
				print("<td align=\"center\">");
				print("" . ($routeNbr != "" ? htmlentities($routeNbr, ENT_QUOTES) : "&nbsp;") . "");
				// HERE A HIDDEN FIELD IS ADDED WHICH IS ROUTEID ARRAY THAT STORES THE
				// CORRESPONDING ROUTEID
				print("<input type=\"hidden\" name=\"subrec[" . $cntid . "]\" value=\"" . $routeId . "\" />");
				print("</td>\n");

				// FOR ROUTE
				$routeDesc = $rowGetInfo[routeDesc];
				print("<td>" . ($routeDesc != "" ? htmlentities($routeDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");

				// FOR TIME
				$timeSked = $rowGetInfo[timeSked];
				print("<td align=\"center\">" . ($timeSked != "" ? $timeSked : "&nbsp;") . "</td>\n");

				// FOR DRIVER
				$driverId = $rowGetInfo[driverId];
				if(!is_numeric($driverId)) $driverId = 0;
				if($driverId == 0) $driverName = "";
				else $driverName = GetPer($driverId, $cvtconnection);
				print("<td>" . ($driverName != "" ? htmlentities($driverName, ENT_QUOTES) : "&nbsp;") . "</td>\n");

				print("</tr>\n");
				$cntid++;
			}
		}
		print("</table>\n");

		print("<br />\n");

		


		if($routeIdStr == "") {
			$routeIdStr = "0";
		}

		// NOW GIVE THE PRINT LINKS HERE
		
		
		print("<a href=\"javascript:SubmitPrintForms('DS');\">Print Del Slips</a>\n");
		print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");

		print("<a href=\"javascript:SubmitPrintForms('RS');\">Print Route Delivery Sheets</a>\n");
		print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");

		print("<a href=\"javascript:SubmitPrintForms('RC');\">Print Compact Route Delivery Sheets</a>\n");
		print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");

		/*
		print("
			<a href=\"javascript:SubmitPrintForms('VS');\">
			Print VM Coll Labels</a>
		");
		print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
		*/

		print("<br /><br />\n");
		if($val_HOMED == "Y") {
			print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
			print("<a href=\"javascript:SubmitPrintForms('HS');\">Print Home Delivery Sheets</a>\n");
			print("<br /><br />\n");			
		}
		
		
		print("<a href=\"javascript:SubmitPrintForms('SS');\">Print Returns Separator Sheets</a>\n");
		print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");

		print("<a href=\"javascript:SubmitPrintForms('SG');\">Route Summary by Group</a>\n");
		

		if($val_EDITN == "Y") {
			print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
			print("<a href=\"javascript:SubmitPrintForms('EL');\">Edition Locations by Route</a>\n");
		}
		
		print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
		print("<a href=\"javascript:SubmitPrintForms('TP');\">Print Truck Package</a>\n");
		

		if($val_EMREG == 'R' || $val_EMREG == 'C') {

			print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
			print("<a href=\"javascript:SubmitPrintForms('ER');\">eMail Regions</a>\n");
		}
                
                /* 3.2 */
                print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"ScreenSource\" value=\"\" />\n");
		print("<input type=\"hidden\" name=\"norecords\" value=\"$cntid\" />\n");
                print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
		print("<input type=\"hidden\" name=\"dispEffDt\" value=\"$dispEffDt\" />\n");
                print("<input type=\"hidden\" name=\"mode\" value=\"$rdMode\" />\n");
                /* 3.2 */
                
		print("</form>\n");

		// GET ITS INDEX
		for($tempi = 0; $tempi < count($pdFieldsArr); $tempi++) {
			if($pdFieldsArr[$tempi] == "forms") {
				$forms_index = $tempi;
				break;
			}
		}

		// PREPARE STRING
		$setStr = "";
		for($tempi = $forms_index + 1; $tempi < count($pdFieldsArr); $tempi++) {
			$setStr .= ", {$pdFieldsArr[$tempi]}as = 0, {$pdFieldsArr[$tempi]}dt = NULL";
		}

		//NOW UPDATE THE FORMSAS AND FORMSDT
		$qryUp = "UPDATE productdispatch
					SET formsdt = now(),
					formsas = $RecIdAS
					" . $setStr . "
					WHERE recid = $pdid";
		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
		}
		print("</div>\n");
                
                
		break;

	case "PrintRouteSummary":

		print("<div class=\"datawhite\" align=\"left\">\n");
		print("<form name=\"level0Form\" method=\"post\" action=\"tra37.php\" style=\"margin: 0;\">\n");
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"dispEffDt\" value=\"$dispEffDt\" />\n");


		//echo 'rundate is'.$dispEffDt;
		// FOR TYPE RADIO BUTTONS
		print("<b>Type :</b>&nbsp;&nbsp;&nbsp;\n");
		if(!isset($rdType) || $rdType == "") {
			$rdType = "G";
		}

		// FOR DRIVER GROUP
		print("<label for=\"rdG\">Driver Group</label>\n");
		print("<input id=\"rdG\" type=\"radio\" name=\"rdType\" value=\"G\" onclick=\"this.form.submit();\"");
		if($rdType == "G") {
			print(" checked=\"checked\"");
		}
		print(" />\n");
		print("&nbsp;&nbsp;&nbsp;&nbsp;");

		// FOR DISPATCH GROUPING
		print("<label for=\"rdD\">Dispatch Grouping</label>\n");
		print("<input id=\"rdD\" type=\"radio\" name=\"rdType\" value=\"D\" onclick=\"this.form.submit();\"");
		if($rdType == "D") {
			print(" checked=\"checked\"");
		}
		print(" />\n");
		print("&nbsp;&nbsp;&nbsp;&nbsp;");

		// FOR TRUCK LOADING - PLAN A
		print("<label for=\"rdT\">Truck Loading - Plan A</label>\n");
		print("<input id=\"rdT\" type=\"radio\" name=\"rdType\" value=\"T\" onclick=\"this.form.submit();\"");
		if($rdType == "T") {
			print(" checked=\"checked\"");
		}
		print(" />\n");
		print("&nbsp;&nbsp;&nbsp;&nbsp;");

		// FOR TRUCK LOADING - PLAN B
		print("<label for=\"rdB\">Truck Loading - Plan B</label>\n");
		print("<input id=\"rdB\" type=\"radio\" name=\"rdType\" value=\"B\" onclick=\"this.form.submit();\"");
		if($rdType == "B") {
			print(" checked=\"checked\"");
		}
		print(" />\n");
		print("<br /><br />\n");

		// CREATE AN ARRAY OF SPECIFICROUTES selected=\"selected\"
		reset($rec);
		$srArray = array();
		while(list($cntId, $srId) = each($rec)) {
			if(!is_numeric($srId)) $srId = 0;
			if($srId != 0) array_push($srArray, $srId);
		
			print("<input type=\"hidden\" name=\"rec[" . $cntId . "]\" value=\"$srId\" />\n");
		}
		print("</form>\n");
		print("</div>\n");

	
		print("<div align=\"center\">\n");
		$specRouteIdStr = implode(", ", $srArray);
		
		if($specRouteIdStr == "") $specRouteIdStr = "0";

		if($debug)
			print("SpecRouteId :" . $specRouteIdStr . "<br />\n");
		
		
		$htmlStr = "";
		$htmlStr .= ("<div class=\"datawhite\">");

		if($rdType != 'G') {

			$tempSpecRtIdStr = "";
			// HERE WE NEED TO FIND THE SPECIFICROUTEID BASED ON ROUTEGROUP
			$qryGetSpecRoutes = "SELECT DISTINCT(sr.recid) spRouteId
								FROM transactivity ta, specificroutes sr, routegroup rg, routegrouplink rgl
								WHERE sr.recid IN ($specRouteIdStr)
								AND sr.dispatchlocid = $ASLocationID
								AND ta.specificrouteid = sr.recid
								AND ta.locationid = $ASLocationID
								AND ta.type = 'SD'
								AND rgl.routeid = sr.routeid
								AND rgl.clientlocid = $ASLocationID
								AND rg.recid = rgl.routegroupid
								AND rg.clientlocid = $ASLocationID
								AND rg.type = '$rdType'";

			// FOR SPLITTING OF TABLES -- ADDED ON 05/03/07
			$qryGetSpecRoutes = convertToSplitTables($qryGetSpecRoutes, $GLOBALS[val_SPLIT]);

			if($debug)
				print($qryGetSpecRoutes . "<br />\n");
			$rsltGetSpecRoutes = mysqli_query( $cvtconnection, $qryGetSpecRoutes);
			if(!$rsltGetSpecRoutes) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if(mysqli_num_rows($rsltGetSpecRoutes) == 0) {
				}
				else {

					while($rowGetSpecRoutes = mysqli_fetch_assoc($rsltGetSpecRoutes)) {
						$spRouteId = $rowGetSpecRoutes[spRouteId];
						if(!is_numeric($spRouteId))	$spRouteId = 0;

						if($tempSpecRtIdStr == "") {
							$tempSpecRtIdStr = $spRouteId;
						}
						else {
							$tempSpecRtIdStr .= ", " . $spRouteId;
						}
					}
				}
			}

			if($tempSpecRtIdStr == "") {
				$tempSpecRtIdStr = 0;
			}
			
			$specRouteIdStr = $tempSpecRtIdStr;
		}

		// QRY TO FIND TOTAL REQUIRED DRAW
		$qryGetInfo = "SELECT p.recid prodId, p.ldesc prodDesc,sp.recid as specificrecid,
						SUM(ta.actquantity) totQty, sp.datex spDateX
						FROM transactivity ta, specificproduct sp, product p, location l
						WHERE ta.specificrouteid  IN ($specRouteIdStr)
						AND ta.locationid = $ASLocationID
						AND ta.customerlocid = l.recid
						AND ((ta.type = 'SD' AND l.type != 'R') OR (ta.type = 'DE' AND l.type = 'R' ))
						AND sp.recid = ta.specificproductid
						AND ( sp.endeffdt IS NULL OR sp.endeffdt = '0000-00-00' OR sp.endeffdt > '$curDate')
						AND p.recid = sp.productid
						AND p.clientid = $ASCompanyID
						AND ( p.endeffdt IS NULL OR p.endeffdt = '0000-00-00' OR p.endeffdt > '$curDate')
						GROUP BY prodId, spDateX
						ORDER BY prodDesc";

		// FOR SPLITTING OF TABLES -- ADDED ON 05/03/07
		$qryGetInfo = convertToSplitTables($qryGetInfo, $GLOBALS[val_SPLIT]);

		if($debug)
			print($qryGetInfo . "<br />\n");
		$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);

		// FOR INITIAL PAGE BREAK
		//print("<br clear=\"all\" style=\"page-break-after:always\">\n");

		if(!$rsltGetInfo) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			$drawrec= mysqli_num_rows($rsltGetInfo);
			if(mysqli_num_rows($rsltGetInfo) == 0) {
				if($rdType != 'G') {
					print("<b>No Information Available</b>\n");
				}
			}
			else {
				
				//$htmlStr .= ("<div class=\"datawhite\">");
				$htmlStr .=("<div style=\"padding-bottom: 3px; text-align: left;font-size: 1.6em; page-break-before: always;\"><b><u>Required Draw - All Groups:</u></b></div>\n");
				$htmlStr .=("<table border=\"1\" width=\"100%\" cellspacing=\"0\" cellpadding=0>\n");
				$htmlStr .=("<tr class=\"datawhite\">\n");
				if($debug)
					$htmlStr .=("<td align=\"right\"><b>prodId</b></td>\n");
				$htmlStr .=("<td align=\"right\" class=\"padClass\"><b>Publication</b></td>\n");
				$htmlStr .=("<td align=\"center\"><b>Publication Date</b></td>\n");
				$htmlStr .=("<td align=\"right\" class=\"padClass\"><b>Quantity</b></td>\n");
				$htmlStr .=("<td align=\"right\" class=\"padClass\"><b>Extra Copies</b></td>\n");
				$htmlStr .=("<td align=\"right\" class=\"padClass\"><b>Total</b></td>\n");
                                if($rdType == "D") 
                                {
                                 
                                $htmlStr .=("<td align=\"right\" class=\"padClass\"><b>Bundles</b></td>\n");
                                $htmlStr .=("<td align=\"right\" class=\"padClass\"><b>Loose</b></td>\n");
                                }
				$htmlStr .=("</tr>\n");

				while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {

					$specificrecid = $rowGetInfo[specificrecid];
					
                                        if($rdType == "D") 
                                        {
                                        $qryGetextracopy = "SELECT sum(qtyissued  - qtysked)  extracopy , sum(FLOOR(qtyissued  / sp.bundlecount )) bundle , sum(qtyissued  % sp.bundlecount ) lost
					      FROM routedrawaccounting,specificproduct sp 
						  WHERE sp.recid = '$specificrecid'
                                                  AND clientlocid='$ASLocationID' 
						  AND actspecificproductid=sp.recid
						  AND specificrouteid IN ($specRouteIdStr)
						  AND type =  'SD'
						  GROUP BY actspecificproductid";
                                         }
                                        else
                                        {    
					$qryGetextracopy = "SELECT sum(qtyissued) rdaQtyIssued, sum(qtysked) rdaQtysked
					      FROM routedrawaccounting 
						  WHERE clientlocid='$ASLocationID' 
						  AND actspecificproductid='$specificrecid'
						  AND specificrouteid IN ($specRouteIdStr)
						  AND type =  'SD'
						  GROUP BY  `actspecificproductid`" ;
                                        }
							
					// FOR SPLITTING OF TABLES 
					$qryGetextracopy = convertToSplitTables($qryGetextracopy, $GLOBALS[val_SPLIT]);

					if($debug)
						print($qryGetextracopy . "<br />\n");
					$rsltGetextracopy = mysqli_query( $cvtconnection, $qryGetextracopy);
				
					if(!$rsltGetextracopy) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}else{
						$rowGetextracpoy = mysqli_fetch_assoc($rsltGetextracopy);
						if($rdType == "D") 
                                                {
                                                   $Extacopy = $rowGetextracpoy[extracopy];
						   $b_qty = $rowGetextracpoy[bundle];
						   $lost = $rowGetextracpoy[lost]; 
                                                }
						else
                                                {
                                                   $rdaQtyIssued = $rowGetextracpoy[rdaQtyIssued];
						   $rdaQtysked = $rowGetextracpoy[rdaQtysked];
                                                }
					}
                                        
                                        if($rdType != 'D')
                                        {
					$Extacopy = $rdaQtyIssued - $rdaQtysked;
                                        }
                                        
					$totQty = $rowGetInfo[totQty];
					$prodId = $rowGetInfo[prodId];
					$prodDesc = $rowGetInfo[prodDesc];
					$spDateX = $rowGetInfo[spDateX];
					
					$totalcopy= $totQty + $Extacopy;
					ValidateForInt(false, "prodId", "totQty");

					$htmlStr .=("<tr class=\"datawhite\">\n");

					// FOR PRODID
					if($debug)
						$htmlStr .=("<td align=\"right\"><b>$prodId</b></td>\n");

					// FOR PUBLICATION
					$htmlStr .=("<td  align=\"right\" class=\"padClass\"><b>" . htmlentities($prodDesc, ENT_QUOTES) . "</b></td>\n");

					// FOR DATEX
					$htmlStr .=("<td  align=\"center\"><b>" . get_date($spDateX, 'MM/DD/YY') . "&nbsp;</b></td>\n");

					// FOR QUANTITY
					$htmlStr .=("<td align=\"right\" class=\"padClass\"><b>$totQty</b></td>\n");
					
					// FOR Extracopy
					$htmlStr .=("<td align=\"right\" class=\"padClass\"><b>$Extacopy</b></td>\n");
					
					// FOR Total
					$htmlStr .=("<td align=\"right\" class=\"padClass\"><b>$totalcopy</b></td>\n");
                                        
                                        if($rdType == "D") 
                                        {
                                            
                                         $htmlStr .=("<td align=\"right\" class=\"padClass\"><b>$b_qty</b></td>\n");
                                         $htmlStr .=("<td align=\"right\" class=\"padClass\"><b>$lost</b></td>\n"); 
                                        }  
                                        
					$htmlStr .=("</tr>\n");
				}
				$htmlStr .=("</table><br />\n");
				
			//	print($htmlStr);

			}
		}


		$groupArray = array();
		if($rdType == 'G') {
			// HERE WE NEED CREATE AN ARRAY OF SPECIFICROUTESID SEPERATED BY GROUPS
			// QRY TO GET THE SPECIFICROUTE INFORMATION
			$qryGetInfo = "SELECT DISTINCT sr.recid specRouteId, sr.driverid driverId,
							CONCAT_WS(' ', NULLIF(p.firstname, ''), NULLIF(p.lastname, '')) personName,
							r.routenbr routeNbr, r.sdesc routeDesc, pl.role persGroup,
							DATE_FORMAT(sr.datesked, '%Y-%m-%d') dbDateSked,
							g.sdesc grpDesc
							FROM route r, specificroutes sr
							LEFT JOIN person p ON  p.recid = sr.driverid
							LEFT JOIN personlink pl ON pl.personid = p.recid
							AND pl.locationid = $ASLocationID
							LEFT JOIN groups g ON g.code = pl.role
							AND g.locationid = $ASLocationID
							WHERE sr.dispatchlocid = $ASLocationID
							AND sr.recid IN ($specRouteIdStr)
							AND sr.routeid = r.recid
							GROUP BY persGroup, specRouteId
							ORDER BY g.sdesc, r.sortseqnbr, r.routenbr, r.sdesc";

			// FOR SPLITTING OF TABLES 
			$qryGetInfo = convertToSplitTables($qryGetInfo, $GLOBALS[val_SPLIT]);

			if($debug)
				print($qryGetInfo . "<br />\n");
			$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
			if(!$rsltGetInfo) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if(mysqli_num_rows($rsltGetInfo) == 0) {
				}
				else {
					while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
						$specRouteId = $rowGetInfo[specRouteId];
						$routeNbr = $rowGetInfo[routeNbr];
						$routeDesc = $rowGetInfo[routeDesc];
						$persGroup = $rowGetInfo[persGroup];
						$personName = $rowGetInfo[personName];
						$dbDateSked = $rowGetInfo[dbDateSked];

						if(!is_numeric($specRouteId)) $specRouteId = 0;

					if(!isset($groupArray[$persGroup][$specRouteId]) || $groupArray[$persGroup][$specRouteId] == "")
						$groupArray[$persGroup][$specRouteId] = array(
							"routeNbr" => $routeNbr,
							"routeDesc" => $routeDesc,
							"personName" => $personName,
							"dbDateSked" => $dbDateSked
						);
					}
				}
			}
		}
		else {
			// HERE WE NEED CREATE AN ARRAY OF SPECIFICROUTESID SEPERATED BY GROUPS
			// QRY TO GET THE SPECIFICROUTE INFORMATION
			$qryGetInfo = "SELECT DISTINCT sr.recid specRouteId, sr.driverid driverId,
							CONCAT_WS(' ', NULLIF(p.firstname, ''), NULLIF(p.lastname, '')) personName,
							r.routenbr routeNbr, r.sdesc routeDesc, pl.role persGroup,
							DATE_FORMAT(sr.datesked, '%Y-%m-%d') dbDateSked, rg.recid rgId
							FROM route r, routegroup rg, routegrouplink rgl, specificroutes sr
							LEFT JOIN person p ON  p.recid = sr.driverid
							LEFT JOIN personlink pl ON pl.personid = p.recid
							AND pl.locationid = $ASLocationID
							WHERE sr.recid IN ($specRouteIdStr)
							AND sr.routeid = r.recid
							AND sr.dispatchlocid = $ASLocationID
							AND rg.clientlocid = $ASLocationID
							AND rg.type = '$rdType'
							AND rgl.clientlocid = $ASLocationID
							AND rgl.routegroupid = rg.recid
							AND rgl.routeid = sr.routeid
							GROUP BY persGroup, specRouteId
							ORDER BY rg.sortseqnbr,r.sortseqnbr";
			// remove order by --r.sortseqnbr, r.routenbr, r.sdesc	
			// FOR SPLITTING OF TABLES -- ADDED ON 03/09/07
			$qryGetInfo = convertToSplitTables($qryGetInfo, $GLOBALS[val_SPLIT]);

			if($debug)
				print($qryGetInfo . "<br />\n");
			$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
			if(!$rsltGetInfo) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if(mysqli_num_rows($rsltGetInfo) == 0) {
				}
				else {
					while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
						$specRouteId = $rowGetInfo[specRouteId];
						$routeNbr = $rowGetInfo[routeNbr];
						$routeDesc = $rowGetInfo[routeDesc];
						$rgId = $rowGetInfo[rgId];
						$personName = $rowGetInfo[personName];
						$dbDateSked = $rowGetInfo[dbDateSked];

						if(!is_numeric($specRouteId)) $specRouteId = 0;

					if(!isset($groupArray[$rgId][$specRouteId]) || $groupArray[$rgId][$specRouteId] == "")
						$groupArray[$rgId][$specRouteId] = array(
							"routeNbr" => $routeNbr,
							"routeDesc" => $routeDesc,
							"personName" => $personName,
							"dbDateSked" => $dbDateSked
						);
					}
				}
			}
		}

		if($debug) {
			print("<pre style=\"text-align : left\">");
			print_r($groupArray);
			print("</pre>\n");
		}

		// FOR PAGE BREAK
		$htmlStr.= ("<br clear=\"all\" style=\"page-break-after:always\">\n");

		while(list($groupCode, $specRouteArr) = each($groupArray)) {
			if($rdType == 'G') {

				// FIND THE GROUPDESCRIPTION
				$qryGetGroups = "SELECT sdesc groupDesc
								FROM groups
								WHERE code = '$groupCode'
								AND locationid = $ASLocationID";
				if($debug)
					print($qryGetGroups . "<br />\n");
				$rsltGetGroups = mysqli_query( $cvtconnection, $qryGetGroups);
				if(!$rsltGetGroups) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetGroups) == 0) {
						$groupDesc = "";
					}
					else {
						$rowGetGroups = mysqli_fetch_assoc($rsltGetGroups);
						$groupDesc = $rowGetGroups[groupDesc];
					}
				}
			}
			else {
				if(!is_numeric($groupCode)) $groupCode = 0;

				$fileLineNbr = __LINE__; $rsltArray = GetTableInfo($debug, $cvtconnection, "routegroup", $groupCode, "CONCAT_WS(' - ', NULLIF(groupsdesc, ''), NULLIF(subgroupsdesc, '')) groupDesc");
				if($rsltArray[rtvalue]) {
					$groupDesc = $rsltArray[groupDesc];
				}
				else {
					$groupDesc = "";
				}
				unset($rsltArray, $fileLineNbr);

			}
			$htmlStr.= ("<div style=\" text-align: center;font-size: 1.6em; page-break-before: always;\"><b>Group: " . htmlentities($groupDesc, ENT_QUOTES) . "</b></div><br /><br />");

			// FIND THE SPECIFIC ROUTEID
			$specRouteIdStr = "";
			while(list($specRouteId, $infoArr) = each($specRouteArr)) {
				if($specRouteIdStr == "") {
					$specRouteIdStr = $specRouteId;
				}
				else {
					$specRouteIdStr .= ", " . $specRouteId;
				}
				$dbDateSked = $infoArr[dbDateSked];
			}

			if($specRouteIdStr == "") {
				$specRouteIdStr = 0;
			}
			if($debug)
				print("SpecRouteIdStr = " . $specRouteIdStr . "<br />\n");

			// QRY TO FIND THE REQUIRED DRAW
			$qryGetInfo = "SELECT p.recid prodId, p.ldesc prodDesc,sp.recid as specifiproductid,
							SUM(ta.actquantity) totQty, sp.datex spDateX
							FROM transactivity ta, specificproduct sp, product p, location l
							WHERE ta.specificrouteid  IN ($specRouteIdStr)
							AND ta.locationid = $ASLocationID

							AND ta.customerlocid = l.recid
							AND ((ta.type = 'SD' AND l.type != 'R') OR (ta.type = 'DE' AND l.type = 'R' ))
							AND sp.recid = ta.specificproductid
							AND ( sp.endeffdt IS NULL OR sp.endeffdt = '0000-00-00' OR sp.endeffdt > '$dbDateSked')
							AND p.recid = sp.productid
							AND p.clientid = $ASCompanyID
							AND ( p.endeffdt IS NULL OR p.endeffdt = '0000-00-00' OR p.endeffdt > '$dbDateSked')
							GROUP BY prodId, spDateX
							ORDER BY prodDesc";

			// FOR SPLITTING OF TABLES -- ADDED ON
			$qryGetInfo = convertToSplitTables($qryGetInfo, $GLOBALS[val_SPLIT]);

			if($debug)
				print($qryGetInfo . "<br />\n");
			$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);

			$htmlStr.= ("<div style=\"padding-bottom: 3px; text-align: left;font-size: 1.6em;\"><b><u>Required Draw :</u></b></div>\n");

			$htmlStr.= ("<table border=\"1\" width=\"100%\" cellspacing=\"0\" cellpadding=0>\n");
			$htmlStr.= ("<tr class=\"datawhite\">\n");
			if($debug)
				$htmlStr.= ("<td align=\"right\"><b>prodId</b></td>\n");
			$htmlStr.= ("<td align=\"right\" class=\"padClass\"><b>Publication</b></td>\n");
			$htmlStr.= ("<td align=\"center\"><b>Publication Date</b></td>\n");
			$htmlStr.= ("<td align=\"right\" class=\"padClass\"><b>Quantity</b></td>\n");
			$htmlStr .=("<td align=\"right\" class=\"padClass\"><b>Extra Copies</b></td>\n");
			$htmlStr .=("<td align=\"right\" class=\"padClass\"><b>Total</b></td>\n");
                        
                        if($rdType == "D") 
                        {
                        $htmlStr .=("<td align=\"right\" class=\"padClass\"><b>Bundles</b></td>\n");
                        $htmlStr .=("<td align=\"right\" class=\"padClass\"><b>Loose</b></td>\n");
                        }
                        
			$htmlStr.= ("</tr>\n");

			if(!$rsltGetInfo) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
					$specifiproductid = $rowGetInfo[specifiproductid];
			
                                        if($rdType == "D") 
                                        {
                                        $qryGetextracopy = "SELECT sum(qtyissued  - qtysked)  extracopy , sum(FLOOR(qtyissued  / sp.bundlecount )) bundle , sum(qtyissued  % sp.bundlecount ) lost
					      FROM routedrawaccounting,specificproduct sp 
						  WHERE sp.recid = '$specifiproductid'
                                                  AND clientlocid='$ASLocationID' 
						  AND actspecificproductid= sp.recid 
						  AND specificrouteid IN ($specRouteIdStr)
						  AND type =  'SD'
						  GROUP BY actspecificproductid";
                                         }
                                        else
                                        {    
					$qryGetextracopy = "SELECT sum(qtyissued) rdaQtyIssued, sum(qtysked) rdaQtysked
					      FROM routedrawaccounting 
						  WHERE clientlocid='$ASLocationID' 
						  AND actspecificproductid='$specifiproductid'
						  AND specificrouteid IN ($specRouteIdStr)
						  AND type =  'SD'
						  GROUP BY  `actspecificproductid`" ;
                                        }
							
					// FOR SPLITTING OF TABLES
					$qryGetextracopy = convertToSplitTables($qryGetextracopy, $GLOBALS[val_SPLIT]);

					if($debug)
						print($qryGetextracopy . "<br />\n");
					$rsltGetextracopy = mysqli_query( $cvtconnection, $qryGetextracopy);
				
					if(!$rsltGetextracopy) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}else{
						$rowGetextracpoy = mysqli_fetch_assoc($rsltGetextracopy);
						 if($rdType == "D") 
                                                 {
                                                     $Extacopy = $rowGetextracpoy[extracopy];
						     $b_qty = $rowGetextracpoy[bundle];
						     $lost = $rowGetextracpoy[lost]; 
                                                 }
						 else
                                                 {
                                                     $rdaQtyIssued = $rowGetextracpoy[rdaQtyIssued];
						     $rdaQtysked = $rowGetextracpoy[rdaQtysked];
                                                 }   
					}
                                        
                                        if($rdType != 'D')
                                        {
					$Extacopy = $rdaQtyIssued - $rdaQtysked;
                                        }
					
					$totQty = $rowGetInfo[totQty];
					$prodId = $rowGetInfo[prodId];
					$prodDesc = $rowGetInfo[prodDesc];
					$spDateX = $rowGetInfo[spDateX];
					ValidateForInt(false, "prodId", "totQty");
					
					$total= $totQty + $Extacopy;
					$htmlStr.= ("<tr class=\"datawhite\">\n");

					// FOR PRODID
					if($debug)
						$htmlStr.= ("<td align=\"right\"><b>$prodId</b></td>\n");

					// FOR PUBLICATION
					$htmlStr.= ("<td  align=\"right\" class=\"padClass\"><b>" . htmlentities($prodDesc, ENT_QUOTES) . "</b></td>\n");

					// FOR DATEX
					$htmlStr.= ("<td  align=\"center\"><b>" . get_date($spDateX, 'MM/DD/YY') . "&nbsp;</b></td>\n");

					// FOR QUANTITY
					$htmlStr.= ("<td align=\"right\" class=\"padClass\"><b>$totQty</b></td>\n");
					
					// FOR Extra Copy
					$htmlStr.= ("<td align=\"right\" class=\"padClass\"><b>$Extacopy</b></td>\n");
					
					// FOR Total
					$htmlStr.= ("<td align=\"right\" class=\"padClass\"><b>$total</b></td>\n");
                                        if($rdType == "D") 
                                        {
                                            $htmlStr .=("<td align=\"right\" class=\"padClass\"><b>$b_qty</b></td>\n");
                                            $htmlStr .=("<td align=\"right\" class=\"padClass\"><b>$lost</b></td>\n"); 
                                        } 
                                        
					$htmlStr.= ("</tr>\n");
				}
			}
			$htmlStr.= ("</table>\n");
			$htmlStr.= ("<br />\n");

			reset($specRouteArr);

			// FOR DETAIL INFORMATION
			$htmlStr.= ("<table border=\"1\" width=\"100%\" cellspacing=\"0\" cellpadding=0>\n");

			$htmlStr.= ("<tr class=\"datawhite\" style=\"font-weight: bold;\">\n");
				$htmlStr.= ("<td class=\"padClass\">Route Number</td>\n");
				$htmlStr.= ("<td class=\"padClass\">Description</td>\n");
				$htmlStr.= ("<td class=\"padClass\">Driver</td>\n");
				$htmlStr.= ("<td class=\"padClass\">Publication</td>\n");
				$htmlStr.= ("<td align=\"center\">Date</td>\n");
				$htmlStr.= ("<td align=\"right\" class=\"padClass\">Quantity</td>\n");
				$htmlStr .=("<td align=\"right\" class=\"padClass\"><b>Extra Copies</b></td>\n");
				$htmlStr .=("<td align=\"right\" class=\"padClass\"><b>Total</b></td>\n");
                                
                                if($rdType == "D") 
                                {
                                $htmlStr .=("<td align=\"right\" class=\"padClass\"><b>Bundles</b></td>\n");
				$htmlStr .=("<td align=\"right\" class=\"padClass\"><b>Loose</b></td>\n");
                                }
			print("</tr>\n");

			while(list($specRouteId, $infoArr) = each($specRouteArr)) {
				$routeNbr = $infoArr[routeNbr];
				$routeDesc = $infoArr[routeDesc];
				$personName = $infoArr[personName];
				if(!is_numeric($specRouteId)) $specRouteId = 0;

				// QRY TO GET THE NUMBER OF PUBLICATION
				$qryGetProd = "SELECT COUNT(DISTINCT(sp.productid)) prodCnt
								FROM transactivity ta, specificproduct sp
								WHERE ta.specificrouteid = $specRouteId
								AND ta.locationid = $ASLocationID
								AND ta.type IN ('SD', 'DE')
								AND sp.recid = ta.specificproductid
								AND ( sp.endeffdt IS NULL OR sp.endeffdt = '0000-00-00' OR sp.endeffdt > '$dbDateSked')";

				// FOR SPLITTING OF TABLES -- ADDED ON
				$qryGetProd = convertToSplitTables($qryGetProd, $GLOBALS[val_SPLIT]);

				if($debug)
					print($qryGetProd . "<br />\n");
				$rsltGetProdCnt = mysqli_query( $cvtconnection, $qryGetProd);
				if(!$rsltGetProdCnt) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					$rowGetProdCnt = mysqli_fetch_assoc($rsltGetProdCnt);
					$prodCnt = $rowGetProdCnt[prodCnt];
				}
				if(!is_numeric($prodCnt))	$prodCnt = 0;

				if($prodCnt == 0) {
					continue;
				}

				// FOR PRINTING EACH ROW FOR A ROUTE
				$htmlStr.= ("<tr class=\"datawhite\">\n");

				// FOR ROUTE NUMBER
				$htmlStr.= ("<td rowspan=\"" . $prodCnt . "\" class=\"padClass\">" . ($routeNbr != ""? htmlentities($routeNbr) : "&nbsp;" ) . "</td>\n");

				// FOR ROUTE DESCRIPTION
				$htmlStr.= ("<td rowspan=\"" . $prodCnt . "\" class=\"padClass\">" . ($routeDesc != ""? htmlentities($routeDesc) : "&nbsp;" ) . "</td>\n");

				// FOR DRIVER
				$htmlStr.= ("<td rowspan=\"" . $prodCnt . "\" class=\"padClass\">" . ($personName != ""? htmlentities($personName) : "&nbsp;" ) . "</td>\n");

				// QRY TO FETCH THE QUANTITY FOR EACH PRODUCT
				$qryGetInfo = "SELECT p.recid prodId, p.ldesc prodDesc,ta.specificrouteid,sp.recid as specificrouteid,
								SUM(ta.actquantity) qty, sp.datex spDateX,sp.bundlecount
								FROM transactivity ta, specificproduct sp, product p, location l
								WHERE ta.specificrouteid  = $specRouteId
								AND ta.locationid = $ASLocationID
								AND ta.customerlocid = l.recid
								AND ((ta.type = 'SD' AND l.type != 'R') OR (ta.type = 'DE' AND l.type = 'R' ))
								AND sp.recid = ta.specificproductid
								AND ( sp.endeffdt IS NULL OR sp.endeffdt = '0000-00-00' OR sp.endeffdt > '$dbDateSked')
								AND p.recid = sp.productid
								AND p.clientid = $ASCompanyID
								AND ( p.endeffdt IS NULL OR p.endeffdt = '0000-00-00' OR p.endeffdt > '$dbDateSked')
								GROUP BY prodid, spDateX
								ORDER BY prodDesc";

				// FOR SPLITTING OF TABLES -- ADDED ON
				$qryGetInfo = convertToSplitTables($qryGetInfo, $GLOBALS[val_SPLIT]);

				if($debug)
					print($qryGetInfo . "<br />\n");
				$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);

				if(!$rsltGetInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo) == 0) {
					
						// FOR PUBLICATION
						$htmlStr.= ("<td align=\"left\" class=\"padClass\">&nbsp;</td>\n");

						// FOR DATEX
						$htmlStr.= ("<td align=\"center\" class=\"padClass\">&nbsp;</td>\n");

						// FOR QUANTITY
						$htmlStr.= ("<td align=\"right\" class=\"padClass\">&nbsp;</td>\n");
						
						// FOR Extracpoy
							$htmlStr.= ("<td align=\"right\" class=\"padClass\">$nbsp</td>\n");
							
					// FOR total
							$htmlStr.= ("<td align=\"right\" class=\"padClass\">$nbsp</td>\n");
                                                       
                                                       if($rdType == "D") 
                                                       {
                                                        // FOR BUNDLES
                                                        $htmlStr.= ("<td align=\"right\" class=\"padClass\">$nbsp</td>\n");
                                                       // FOR LOOSE
                                                        $htmlStr.= ("<td align=\"right\" class=\"padClass\">$nbsp</td>\n");
                                                       }
					}
					else {
					
						$rowCnt = $prodCnt;
						while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
							$specificrouteid = $rowGetInfo[specificrouteid];
							//$specificrecid = $rowGetInfo[specificrouteid];
							
							$qryGetextracopy = "SELECT qtyissued rdaQtyIssued, qtysked rdaQtysked
					      FROM routedrawaccounting 
						  WHERE clientlocid='$ASLocationID' 
						  AND actspecificproductid='$specificrouteid'
						  AND specificrouteid='$specRouteId'" ;

							
					// FOR SPLITTING OF TABLES -- ADDED ON 05/03/07
					$qryGetextracopy = convertToSplitTables($qryGetextracopy, $GLOBALS[val_SPLIT]);

					if($debug)
						print($qryGetextracopy . "<br />\n");
					$rsltGetextracopy = mysqli_query( $cvtconnection, $qryGetextracopy);
				
					if(!$rsltGetextracopy) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}else{
						$rowGetextracpoy = mysqli_fetch_assoc($rsltGetextracopy);
						
						 $rdaQtyIssued = $rowGetextracpoy[rdaQtyIssued];
						 $rdaQtysked = $rowGetextracpoy[rdaQtysked];
					}
		
					$Extacopy = $rdaQtyIssued - $rdaQtysked;
					
							
							$qty = $rowGetInfo[qty];
							$total=$qty + $Extacopy ;
							$prodDesc = $rowGetInfo[prodDesc];
							$spDateX = $rowGetInfo[spDateX];

							// FOR PUBLICATION
							$htmlStr.= ("<td align=\"left\" class=\"padClass\">" . htmlentities($prodDesc, ENT_QUOTES) . "</td>\n");

							// FOR DATEX
							$htmlStr.= ("<td align=\"center\">" . get_date($spDateX, 'MM/DD/YY') . "</td>\n");

							// FOR QUANTITY
							$htmlStr.= ("<td align=\"right\" class=\"padClass\">$qty</td>\n");
							
							// FOR Extracpoy
							$htmlStr.= ("<td align=\"right\" class=\"padClass\">$Extacopy</td>\n");
							
							// FOR total
							$htmlStr.= ("<td align=\"right\" class=\"padClass\">$total</td>\n");
                                                        
                                                        if($rdType == "D") 
                                                        {       
                                                        // FOR BUNDLES
					                $bundle_cnt = $rowGetInfo[bundlecount];;
					                if($bundle_cnt == 0) {
					                   $b_qty = "";
					                }
					                else 
                                                        {
					                   $b_qty = (int)( $total / $bundle_cnt );
					                }
					                $htmlStr .=("<td align=\"right\" class=\"padClass\">$b_qty</td>\n");

					               // FOR LOOSE
					                if($bundle_cnt == 0) 
                                                        {
					                   $lost = "";
					                }
                                                       else 
                                                        {
					                    $lost = (  $total % $bundle_cnt );
					                }
                                                        $htmlStr .=("<td align=\"right\" class=\"padClass\">$lost</td>\n");
                                                        }
							
							$rowCnt--;
							if($rowCnt > 0) {
								$htmlStr.= ("</tr>\n<tr class=\"datawhite\">\n");
							}
						}
					}
					
					
				}
				
				$htmlStr.= ("</tr>\n");
			}
			$htmlStr.= ("</table><br />\n");

			// FOR PAGE BREAK
			$htmlStr.= ("<br clear=all style=\"page-break-after:always\">\n");
			
			
		}
		//print($htmlStr);
			
		$_SESSION[TRA37DISPHTMLSTR]=$htmlStr;
			print($htmlStr);
		if($drawrec != 0){
			
			// HERE DISPLAY THE EMAIL LINK
				print("<br />\n");
				print("<div class=\"datawhite\" align=\"center\">\n");
				print("<br /><a href=\"" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=RouteNotifyGroupEmail&rdType=$rdType&dispEffDt=$dispEffDt", ENT_QUOTES) . "\">EMail</a>\n");
				print("</div>\n");
			
			}
		
				
		print("</div>\n");
		break;
		
		case "RouteNotifyGroupEmail":
				if( isset($_SESSION[TRA37DISPHTMLSTR]) )
					$dispHtmlStr = $_SESSION[TRA37DISPHTMLSTR];
			
				if($debug)
					print($dispHtmlStr);
			

				$groupname= $_GET['rdType'];
				$dispEffDt= $_GET['dispEffDt'];
				
				
				
				
				if($groupname == 'G')
					$dispachgroup="Driver Group";
				else if($groupname == 'D')
					$dispachgroup="Dispatch Grouping";
				else if($groupname == 'T')
					$dispachgroup="Truck Loading - Plan A";
				else if($groupname == 'B')
					$dispachgroup="Truck Loading - Plan B";
					
				$persEmailIdArray = array();
				$qryGetInfo = "SELECT pl.personid, p.email
								FROM personlink pl, person p, notifyperson np
								WHERE pl.locationid = $ASLocationID
								AND pl.personid = p.recid
								AND pl.recid = np.personlinkid
								AND np.groupcode = 'DIS'
								AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00'
								OR pl.endeffdt > '$dbEffDt' )";

				if($debug)
					print($qryGetInfo . "<br />\n");
				//$persEmailIdArray = array();
				$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
				if(!$rsltGetInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo) == 0) {
						
						$persEmailId = "";
					}
					else {
						
						while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
							$persEmailId = $rowGetInfo[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}
				
				if(count($persEmailIdArray) == 0) {
					$mailMsg = "Email Address - not found for Person <br /><br />";
				}
				else {
					$fileLineNbr = __LINE__; $fromCompName = GetComp($ASCompanyID, $cvtconnection);
					if($debug)
						print("$fromCompName <br />\n");
						
						
						
					$dispEffDt= date('d-M-Y', strtotime($dispEffDt));
					$dispachgroups = $dispachgroup . " for " . $dispEffDt;
					$from = "\"$fromCompName\" <$val_EMLID>";
					$toArr = $persEmailIdArray;
					$subject = $dispachgroups;
					$msg = $dispHtmlStr;
					$mail = new htmlMimeMail();

					// SET MESSAGE
					$mail->setHtml($msg);

					// SEND MAIL
					$mail->setFrom($from);
					$mail->setSubject($subject);
					if($mail->send($toArr, "mail")) {
						$to = implode(', ', $toArr);
						$mailMsg = "Mail Sent to $to";
					}
					else {
						$mailMsg = "Mail Not Sent for Route Group- Some problem exist";
					}
				}

				include('../cm/html-secondwindow.php');
				print("<div class=\"datawhite\">");
				print("<br /><b>$mailMsg</b><br />");
				print("<br /><a href=\"" . htmlspecialchars($Back, ENT_QUOTES) . "\">OK</a>");
				print("</div>\n");
				include('../cm/html-bottom-secondwindow.php');
			break;
				

	case "PrintEditionLocation":
		print("<div class=\"datawhite\" align=\"center\">\n");
		print("<form name=\"level0Form\" method=\"get\" action=\"tra37.php\" style=\"margin: 0;\">\n");
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");


		// CREATE AN ARRAY OF SPECIFICROUTES selected=\"selected\"
		reset($rec);
		$srArray = array();
		while(list($cntId, $srId) = each($rec)) {
			if(!is_numeric($srId)) $srId = 0;
			if($srId != 0) array_push($srArray, $srId);
			print("<input type=\"hidden\" name=\"rec[" . $cntId . "]\" value=\"$srId\" />\n");
		}

		$specRouteIdStr = implode(", ", $srArray);
		if($specRouteIdStr == "") $specRouteIdStr = "0";

		if($debug)
			print("SpecRouteId :" . $specRouteIdStr . "<br />\n");

		// GET EFFDT
		if(!isset($pdId) || $pdId == "")
			$pdId = $_REQUEST[pdid];

		if(!is_numeric($pdId))	$pdId = 0;


		$fileLineNbr = __LINE__; $rsltArray = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdId, "DATE_FORMAT(rundate, '%m%d%y') effDt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt", "routesetid rsId", "returnsroutesetid rtRsId");
		if($rsltArray[rtvalue]) {
			$effDt = $rsltArray[effDt];
			$dbEffDt = $rsltArray[dbEffDt];
			$rsId = $rsltArray[rsId];
			$rtRsId = $rsltArray[rtRsId];
			ValidateForInt(false, "rsId", "rtRsId");
		}
		else {
			$effDt = "";
			$dbEffDt = "";
			$rsId = 0;
			$rtRsId = 0;
		}
		unset($rsltArray, $fileLineNbr);

		// FOR HIDDEN VARIABLE
		print("<input type=\"hidden\" name=\"pdId\" value=\"$pdId\" />\n");
		print("<input type=\"hidden\" name=\"dbEffDt\" value=\"$dbEffDt\" />\n");

		list($year, $month, $day) = preg_split("/-/", $dbEffDt);
		$effDtDay = DATE("D", mktime(0, 0, 0, $month, $day, $year));
		$effDtDay = strtolower($effDtDay);

		// CREATE TEMPORARY TABLE TO FETCH THE LOCATION FROM EDITIONCUSTOMER
		$qryIns = "CREATE TEMPORARY TABLE tmpEditCust_TRA37 (
			customerlocid BIGINT(20) NOT NULL,
			productid BIGINT(20) NOT NULL,
			effdt DATE NOT NULL DEFAULT '0000-00-00',
			KEY customerlocid (customerlocid),
			KEY productid (productid),
			KEY effdt (effdt)
		)";
		if($debug)
			print("<b>" . $qryIns . "</b><br />\n");
		$rsltIns = mysqli_query( $cvtconnection, $qryIns);
		if(!$rsltIns) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 05);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}

		$qryGetEditCust = "SELECT ec.customerlocid customerlocid, ec.productid productid,
							MAX(ec.effdt) effdt
							FROM editioncustomer ec
							WHERE ec.clientlocid = $ASLocationID
							AND ec.effdt <= '$dbEffDt'
							AND ( ec.endeffdt IS NULL OR ec.endeffdt = '0000-00-00' OR ec.endeffdt > '$dbEffDt')
							GROUP BY ec.customerlocid, ec.productid";
		if($debug)
			print($qryGetEditCust . "<br />\n");

		// TO INSERT RECORD IN tmpEditCust_TRA37 WHERE THE EFFDT IS LESS THAN FORMDATE
		$qryInsTempTable = "INSERT INTO tmpEditCust_TRA37 " . $qryGetEditCust . " ";
		if($debug)
			print("<b>" . $qryInsTempTable . "</b><br />\n");
		$rsltInsTempTable = mysqli_query( $cvtconnection, $qryInsTempTable);
		if(!$rsltInsTempTable) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 06);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}

		$editionArr = array();
		$prodxArr = array();
		// HERE WE NEED TO FETCH THE DISTINCT EDITION BASED ON THE selected=\"selected\" SPECIFIC ROUTE
		$qryGetEdition = "SELECT DISTINCT ec.editionid{$effDtDay} editionId, ec.productid prodIdx
						FROM transactivity ta, editioncustomer ec, tmpEditCust_TRA37 tmp
						WHERE ta.locationid = $ASLocationID
						AND ta.type = 'SD'
						AND ta.specificrouteid IN($specRouteIdStr)
						AND ta.customerlocid = tmp.customerlocid
						AND ec.customerlocid = tmp.customerlocid
						AND ec.effdt = tmp.effdt
						AND ec.productid = tmp.productid";

		// FOR SPLITTING OF TABLES
		$qryGetEdition = convertToSplitTables($qryGetEdition, $val_SPLIT);

		if($debug)
			print($qryGetEdition . "<br />\n");
		$rsltGetEdition = mysqli_query( $cvtconnection, $qryGetEdition);
		if(!$rsltGetEdition) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetEdition) == 0) {
			}
			else {
				while($rowGetEdition = mysqli_fetch_assoc($rsltGetEdition)) {
					$editionId = $rowGetEdition[editionId];
					$prodIdx = $rowGetEdition[prodIdx];

					if(!is_numeric($prodIdx))	$prodIdx = 0;
					array_push($prodxArr, $prodIdx);
					
					if(!is_numeric($editionId))	$editionId = 0;
					array_push($editionArr, $editionId);
				}
			}
		}

		if(count($editionArr) > 0) {
			// HERE IF THERE EXIST TWO OR MORE EDITION THEN WE NEED TO PROVIDE EDITION DROP LIST
			if(count($editionArr) > 1) {
				print("<b>Select Edition : </b>\n");
				print("<select name=\"lstEditionId\" onchange=\"this.form.submit();\">\n");
				print("\t<option value=\"\">Select Edition</option>\n");

				while(list($editKey, $editionId) = each($editionArr)) {
					if(!is_numeric($editionId))	$editionId = 0;
					
					$tempProdx = $prodxArr[$editKey];
					if(!is_numeric($tempProdx))	$tempProdx = 0;

					print("\t<option value=\"" . $editionId . "\"");
					if($lstEditionId == $editionId)
						print(" selected=\"selected\"");
					print(">");

					// GET EDITION DESCRIPTION
					$fileLineNbr = __LINE__; $editionDesc = GetDescription("edition", $editionId, "sdesc");
					
					// GET EDITION DESCRIPTION
					$fileLineNbr = __LINE__; $prodXDesc = GetDescription("product", $tempProdx, "ldesc");
					

					if($debug)
						print("" . $editionId . " - ");
						
						$prodEdi = "$prodXDesc - $editionDesc";
//					print("" . htmlentities($editionDesc, ENT_QUOTES) . "</option>\n");
					print("" . htmlentities($prodEdi, ENT_QUOTES) . "</option>\n");

				}
				print("</select>\n");
				print("<br /><br />\n");
			}
			else {
				list($editKey, $editionId) = each($editionArr);
				if(!is_numeric($editionId))	$editionId = 0;
				$lstEditionId = $editionId;
				print("<input type=\"hidden\" name=\"lstEditionId\" value=\"$lstEditionId\" />\n");

				if($debug)
					print("EditionId = " . $lstEditionId  . "<br />\n");

			}
			if(!is_numeric($lstEditionId))	$lstEditionId = 0;

			$routeTypeStr = "'SR', 'RD', 'RS', 'LR', 'PR'";
			if($val_HAWKS == "Y") {
				$routeTypeStr .= ", 'AM', 'PM', 'TR'";
			}

			// THE DISPLAY STARTS FROM HERE
			$qryGetInfo = "SELECT DISTINCT(r.recid) routeId, r.sdesc routeDesc,
								vg.recid vgId, vg.sdesc vgDesc, sr.recid srId
								FROM specificroutes sr, specificrouteloc srl, tmpEditCust_TRA37 tmp, route r
								LEFT JOIN vendingsubgroup vsg ON vsg.routeid = r.recid
								LEFT JOIN vendinggroup vg ON vg.recid = vsg.vendinggroupid
								WHERE r.locationid = $ASLocationID
								AND sr.routeid = r.recid
								AND sr.dispatchlocid = $ASLocationID
								AND sr.recid IN ($specRouteIdStr)
								AND srl.specificrouteid = sr.recid
								AND srl.clientlocid = $ASLocationID
								AND srl.locationid = tmp.customerlocid
								AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00' OR r.endeffdt > '$curDate' )
								ORDER BY vgDesc, routeDesc";

			// FOR SPLITTING OF TABLES
			$qryGetInfo = convertToSplitTables($qryGetInfo, $val_SPLIT);

			if($debug)
				print($qryGetInfo . "<br />\n");
			$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
			if(!$rsltGetInfo) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if($lstEditionId != 0) {
					$fileLineNbr = __LINE__; $editionDesc = GetDescription("edition", $lstEditionId, "sdesc");

					$htmlStr = "";
					$htmlStr .= ("<u><b>" . htmlentities($editionDesc, ENT_QUOTES) . " by Route</b></u><br /><br />");
					$htmlStr .= ("<table border=\"1\" width=\"60%\">\n");
					$htmlStr .= ("<tr class=\"datatblhdr\">\n");
					$htmlStr .= ("<td>Customer</td> <td align=\"right\">Quantity</td>\n");
					$htmlStr .= ("</tr>\n");

					$oldVgId = 0;
					$oldRouteId = 0;
					$grandTotal = 0;
					while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
						$routeId = $rowGetInfo[routeId];
						$vgId = $rowGetInfo[vgId];
						$srId = $rowGetInfo[srId];
						$routeDesc = $rowGetInfo[routeDesc];
						$vgDesc = $rowGetInfo[vgDesc];
						ValidateForInt(false, "routeId", "vgId", "srId");

						if($vgId != $oldVgId) {
							$htmlStr .= ("<tr class=\"datawhite\">\n");
							// DISPLAY ROUTE
							$htmlStr .= ("<td colspan=\"2\" align=\"center\">");
							$htmlStr .= ("<b>Region : &nbsp;" . htmlentities($vgDesc, ENT_QUOTES) . "</b>");
							$htmlStr .= ("&nbsp;</td>\n");
							$htmlStr .= ("</tr>\n");
						}

						if($routeId != $oldRouteId) {
							$htmlStr .= ("<tr class=\"datawhite\">\n");
							// DISPLAY ROUTE
							$htmlStr .= ("<td colspan=\"2\" align=\"left\">");
							$htmlStr .= ("<b>Route &nbsp;" . htmlentities($routeDesc, ENT_QUOTES) . "</b>");
							$htmlStr .= ("&nbsp;</td>\n");
							$htmlStr .= ("</tr>\n");
						}


						$oldVgId = $vgId;
						$oldRouteId = $routeId;

						$subTotal = 0;
						// HERE WE NEED TO DISPLAY THE LOCATIONS FOR EACH ROUTE
						$qryGetTransAct = "SELECT DISTINCT ta.customerlocid locId,
											SUM(ta.actquantity) sdQty, CONCAT_WS('-', NULLIF(l.sdesc, ''), NULLIF(a.address1, ''), NULLIF(a.address2, ''), NULLIF(a.address3, ''), NULLIF(a.address4, '')) locDesc
											FROM transactivity ta, editioncustomer ec, tmpEditCust_TRA37 tmp, location l
											LEFT JOIN address a ON a.recid = l.addressid
											WHERE ta.locationid = $ASLocationID
											AND ta.type = 'SD'
											AND ta.specificrouteid = $srId
											AND ta.customerlocid = tmp.customerlocid
											AND ec.customerlocid = tmp.customerlocid
											AND ec.effdt = tmp.effdt
											AND ec.productid = tmp.productid
											AND ec.editionid{$effDtDay} = $lstEditionId
											AND l.recid = ta.customerlocid
											GROUP BY locId
											ORDER BY locDesc";

						// FOR SPLITTING OF TABLES
						$qryGetTransAct = convertToSplitTables($qryGetTransAct, $val_SPLIT);

						if($debug)
							print($qryGetTransAct . "<br />\n");
						$rsltGetTransAct = mysqli_query( $cvtconnection, $qryGetTransAct);
						if(!$rsltGetTransAct) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if(mysqli_num_rows($rsltGetTransAct) == 0) {
							}
							else {
								while($rowGetTransAct = mysqli_fetch_assoc($rsltGetTransAct)) {
									$locId = $rowGetTransAct[locId];
									$sdQty = $rowGetTransAct[sdQty];
									$locDesc = $rowGetTransAct[locDesc];
									ValidateForInt(false, "locId", "sdQty");

									$htmlStr .= ("<tr class=\"datawhite\">\n");

									// FOR LOCATION
									$htmlStr .= ("<td>" . ($locDesc != "" ? htmlentities($locDesc, ENT_QUOTES) : "&nbsp;"). "</td>\n");

									// FOR EDITION QTY
									$htmlStr .= ("<td align=\"right\">" . $sdQty . "</td>\n");

									$htmlStr .= ("</tr>\n");
									$subTotal += $sdQty;

								}
							}
						}

						if($subTotal != 0) {
							// HERE WE NEED TO DISPLAY THE SUB TOTAL
							$htmlStr .= ("<tr class=\"datawhite\">\n");
							$htmlStr .= ("<td><b>Sub Total</b></td>\n");
							$htmlStr .= ("<td align=\"right\"><b>" . $subTotal . "</b></td>\n");
							$htmlStr .= ("</tr>\n");
						}

						// HERE WE NEED TO DISPLAY THE EXTRA DRAW QUANTITY
						$editionArr = array();
						// HERE LETS GET THE EXTRA PAPERS VALUES
						$qryGetExtra = "SELECT SUM(rda.qtyissued) qtyIssued,
										SUM(rda.qtysked) qtySked, rda.editionid editionId
										FROM routedrawaccounting rda
										WHERE rda.clientlocid = $ASLocationID
										AND rda.specificrouteid = $srId
										AND rda.editionid <> 2
										GROUP BY editionId";

						// FOR SPLITTING OF TABLES
						$qryGetExtra = convertToSplitTables($qryGetExtra, $val_SPLIT);

						if($debug)
							print($qryGetExtra . "<br />\n");
						$rsltGetExtra = mysqli_query( $cvtconnection, $qryGetExtra);

						if(!$rsltGetExtra) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if(mysqli_num_rows($rsltGetExtra) == 0) {
							}
							else {
								$qtyIssuedTot = 0;
								$qtySkedTot = 0;
								$dispExtraDrawQty = 0;
								while($rowGetExtra = mysqli_fetch_assoc($rsltGetExtra)) {
									$editionId = $rowGetExtra[editionId];
									$qtyIssued = $rowGetExtra[qtyIssued];
									$qtySked = $rowGetExtra[qtySked];
									ValidateForInt(false, "qtySked", "qtyIssued", "editionId");

									$qtyIssuedTot += $qtyIssued;
									$qtySkedTot += $qtySked;
									if($editionId == $lstEditionId) {
										$dispExtraDrawQty +=  $qtyIssued - $qtySked;


									}
									elseif($editionId == 1) {

										// HERE WE NEED TO FETCH THE QUANTITIES FROM RDAEXTRADRAWSPLIT
										$qryGetRdaExtraDraw = "SELECT SUM(res.quantity) rdaExtraQty
																FROM rdaextradrawsplit res
																WHERE res.clientlocid = $ASLocationID
																AND res.specificrouteid = $srId
																AND res.editionid = $lstEditionId";

										$qryGetRdaExtraDraw = convertToSplitTables($qryGetRdaExtraDraw, $val_SPLIT);

										if($debug)
											print($qryGetRdaExtraDraw . "<br />\n");
										$rsltGetRdaExtraDraw = mysqli_query( $cvtconnection, $qryGetRdaExtraDraw);
										if(!$rsltGetRdaExtraDraw) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											if(mysqli_num_rows($rsltGetRdaExtraDraw) == 0) {
												$dispExtraDrawQty = 0;
											}
											else {
												while($rowGetRdaExtraDraw = mysqli_fetch_assoc($rsltGetRdaExtraDraw)) {
													$dispExtraDrawQty = $rowGetRdaExtraDraw[rdaExtraQty];

													ValidateForInt(false, "rdaEditionId", "rdaExtraQty");
												}
											}
										}
									}
								}

								if($dispExtraDrawQty != 0) {
									// FOR EXTRADRAW QUANTITY
									$htmlStr .= ("<tr class=\"datawhite\">\n");
									$htmlStr .= ("<td><b>Extra Copies</b></td>\n");
									$htmlStr .= ("<td align=\"right\"><b>" . $dispExtraDrawQty  . "</b></td>\n");
									$htmlStr .= ("</tr>\n");
								}
							}

							$total = $subTotal + $dispExtraDrawQty;
							if($total != 0) {
								// HERE WE NEED TO DISPLAY THE TOTAL
								$htmlStr .= ("<tr class=\"datawhite\">\n");
								$htmlStr .= ("<td><b>Total</b></td>\n");
								$htmlStr .= ("<td align=\"right\"><b>" . $total . "</b></td>\n");
								$htmlStr .= ("</tr>\n");
							}

							$grandTotal += $total;

						}
					}

					if($grandTotal != 0) {
						// HERE WE NEED TO DISPLAY THE TOTAL
						$htmlStr .= ("<tr class=\"datawhite\">\n");
						$htmlStr .= ("<td><b>Grand Total</b></td>\n");
						$htmlStr .= ("<td align=\"right\"><b>" . $grandTotal . "</b></td>\n");
						$htmlStr .= ("</tr>\n");
					}

					$htmlStr .= ("</table>\n");
				}
			}

			if($lstEditionId != 0) {
				print($htmlStr);
				$_SESSION[TRA37DISPHTMLSTR] = $htmlStr;

				// HERE DISPLAY THE EMAIL LINK
				print("<br />\n");
				print("<div class=\"datawhite\" align=\"center\">\n");
				print("<a href=\"javascript:submitLevelFormEmail(document.level0Form,'EmailEditionLocation');\">Email</a>\n");
				print("</div>\n");
			}
		}
		else {
			print("<div>\n");
			print("<b> No Information Available.</b><br /><br />\n");
			print("</div>\n");
		}

		// TO DELETE ALL RECORD FORM tmpEditCust_TRA37
		$qryDel = "TRUNCATE TABLE tmpEditCust_TRA37";
		if($debug)
			print("<b>" . $qryDel . "</b><br />\n");
		$rsltDel = mysqli_query( $cvtconnection, $qryDel);
		if(!$rsltDel) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 07);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}

		print("</form>\n");
		print("</div>\n");
		break;

	case "EmailEditionLocation":

		if( isset($_SESSION[TRA37DISPHTMLSTR]) )

			$dispHtmlStr = $_SESSION[TRA37DISPHTMLSTR];

		if($debug)
			print($dispHtmlStr);

		$qryGetInfo = "SELECT pl.personid, p.email
						FROM personlink pl, person p, notifyperson np
						WHERE pl.locationid = $ASLocationID
						AND pl.personid = p.recid
						AND pl.recid = np.personlinkid
						AND np.groupcode = 'DIS'
						AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00'
						OR pl.endeffdt > '$dbEffDt' )";

		if($debug)
			print($qryGetInfo . "<br />\n");
		$persEmailIdArray = array();
		$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);

		if(!$rsltGetInfo) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetInfo) == 0) {
				$persEmailId = "";
			}
			else {
				while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
					$persEmailId = $rowGetInfo[email];
					array_push($persEmailIdArray, $persEmailId);
				}
			}
		}
		if(COUNT($persEmailIdArray) == 0) {
			$mailMsg = "Email Address - not found for Person <br /><br />";
		}
		else {
			$fileLineNbr = __LINE__; $fromCompName = GetComp($ASCompanyID, $cvtconnection);
			if($debug)
				print("$fromCompName <br />\n");

			$dispDateX = set_date($dbEffDt, "YYYY-MM-DD", "MM/DD/YY");

			$from = "\"$fromCompName\" <$val_EMLID>";
			$toArr = $persEmailIdArray;
			$subject = "Edition Locations by Route";
			$msg = $dispHtmlStr;
			$mail = new htmlMimeMail();

			// SET MESSAGE
			$mail->setHtml($msg);

			// SEND MAIL
			$mail->setFrom($from);
			$mail->setSubject($subject);
			if($mail->send($toArr, "mail")) {
				$to = implode(', ', $toArr);
				$mailMsg = "Mail Sent to $to";
			}
			else {
				$mailMsg = "Mail Not Sent - Some problem exist <br /><br /> File $FileName Created Not sent";
			}

			// DELETE FILE
			exec("rm -f $FileNameCreated");
			if($CompLogo != "") {
				exec("rm -f $imgCreated");
			}
		}
		include('../cm/html-secondwindow.php');
		print("<div class=\"datawhite\">");
		print("<br /><b>$mailMsg</b><br />");

		print("<br /><a href=\"" . htmlspecialchars($Back, ENT_QUOTES) . "\">OK</a>");

		print("</div>\n");
		include('../cm/html-bottom-secondwindow.php');
		break;

	case "WarnEmRegion":

		print("<div class=\"datawhite\">\n");
		print("<form name=\"level3Form\" method=\"post\" action=\"tra37.php\" style=\"margin: 0;\">\n");
		//GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$dbEffDt = $rsltArr[dbEffDt];
		}

		else {
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		if($debug) print("dbEffDt = $dbEffDt<br />");

		reset($rec);
		$srArray = array();

		while(list($cntId, $srId) = each($rec)) {
			if(!is_numeric($srId)) $srId = 0;
			if($srId != 0) 	array_push($srArray, $srId);

			print("<input type=\"hidden\" name=\"rec[" . $cntId . "]\" value=\"$srId\" />\n");
		}

		$specRouteIdStr = implode(", ", $srArray);
		if($specRouteIdStr == "") $specRouteIdStr = "0";

		if($debug)
			print("SpecRouteId :" . $specRouteIdStr . "<br />\n");

		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"ScreenSource\" value=\"RouteSheet\" />\n");
		print("<input type=\"hidden\" name=\"mode\" value=\"$rdMode\" />\n");
		print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");

		print("<b>Warning: please check the following routes if you wish them to be included in the eMails:</b><br /><br />\n");

		print("<a href=\"" . urldecode(htmlspecialchars($Back, ENT_QUOTES)) . "\">Back</a>\n");
		print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");

		print("<a href=\"javascript:submitLevel3FormEmail(document.level3Form);\">Print</a>\n");

		print("</form>\n");

		ValidateForInt(false, "pdid");

		$qryGetRT = "SELECT DISTINCT sr.routeid routeId,
						r.routenbr rtNbr, r.sdesc routeDesc
						FROM vendinggroup vg, vendingsubgroup vsg, specificroutes sr, route r
						WHERE sr.dispatchlocid = $ASLocationID
						AND sr.datesked = '$dbEffDt'
						AND vg.clientlocid = $ASLocationID
						AND vg.sortseqnbr < 10
						AND vg.recid = vsg.vendinggroupid
						AND vsg.routeid = sr.routeid
						AND sr.recid NOT IN (" . $specRouteIdStr . ")
						AND r.locationid = $ASLocationID
						AND r.recid = sr.routeid";

		// FOR SPLITTING OF TABLES
		$qryGetRT = convertToSplitTables($qryGetRT, $val_SPLIT);

		if($debug)
			print($qryGetRT . "<br />\n");
		$rsltGetRT = mysqli_query( $cvtconnection, $qryGetRT);

		if(!$rsltGetRT) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode ."</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {

			print("<br />\n");
			print("<table border=\"1\" width=\"80%\">\n");
			print("<tr class=\"datatblhdr\">\n");
			if($debug) print("<td>routeid</td>\n");
			print("<td align=\"center\">Route Number</td>\n");
			print("<td>Description</td>\n");
			print("</tr>\n");

			$oddEven = 0;
			$cntid = 0;
			while($rowGetRT = mysqli_fetch_assoc($rsltGetRT)) {

				if( ( $oddEven++ % 2 ) == 0 ) {
					print("<tr class=\"datawhite\">\n");
				}
				else {
					print("<tr class=\"datagrey\">\n");
				}

				$routeId = $rowGetRT[routeId];
				$rtNbr = $rowGetRT[rtNbr];
				$routeDesc = $rowGetRT[routeDesc];
				if(!is_numeric($routeId)) $routeId = 0;

				// FOR ROUTEID
				if($debug) print("<td>$routeId</td>\n");

				// FOR ROUTE NUMBER
				print("<td align=\"center\">" . htmlentities($rtNbr, ENT_QUOTES) . "</td>\n");

				// FOR DESCRIPTION
				print("<td>" . htmlentities($routeDesc, ENT_QUOTES) . "</td>\n");

				print("</tr>\n");
			}
			print("</table>\n");
		}
		print("</div>\n");
		break;

	case "EmailRegion":
	case "EmailRegionForce":

		print("<div class=\"datawhite\">\n");
		print("<form name=\"level3Form\" method=\"post\" action=\"tra37.php\" style=\"margin: 0;\">\n");

		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"ScreenSource\" value=\"RouteSheet\" />\n");
		print("<input type=\"hidden\" name=\"mode\" value=\"$mode\" />\n");
		print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
		print("<input type=\"hidden\" name=\"emailRegion\" value=\"YES\" />\n");

		// CREATE AN ARRAY OF SPECIFICROUTES selected=\"selected\"
		reset($rec);
		$srArray = array();

		while(list($cntId, $srId) = each($rec)) {
			if(!is_numeric($srId)) $srId = 0;
			if($srId != 0) array_push($srArray, $srId);

			print("<input type=\"hidden\" name=\"rec[" . $cntId . "]\" value=\"$srId\" />\n");
		}

		$specRouteIdStr = implode(", ", $srArray);
		if($specRouteIdStr == "") $specRouteIdStr = "0";

		if($debug)
			print("SpecRouteId :" . $specRouteIdStr . "<br />\n");

		$qryGetVG = "SELECT DISTINCT vg.recid vgId, vg.sortseqnbr srtSeqNbr
					FROM vendinggroup vg, vendingsubgroup vsg, specificroutes sr
					WHERE vg.clientlocid = $ASLocationID
					AND vg.sortseqnbr < 10
					AND vg.recid = vsg.vendinggroupid
					AND vsg.routeid = sr.routeid
					AND sr.recid IN (" . $specRouteIdStr . ")";

		// FOR SPLITTING OF TABLES
		$qryGetVG = convertToSplitTables($qryGetVG, $val_SPLIT);

		if($debug)
			print($qryGetVG . "<br />\n");
		$rsltGetVG = mysqli_query( $cvtconnection, $qryGetVG);

		$persIdStr = "";
		if(!$rsltGetVG) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode ."</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetVG) != 0) {
				while($rowGetVG = mysqli_fetch_assoc($rsltGetVG)) {
					$vgId = $rowGetVG[vgId];
					$srtSeqNbr = $rowGetVG[srtSeqNbr];
					if(!is_numeric($vgId)) $vgId = 0;
					if($debug) print("vgId = $vgId :: srtSeqNbr = $srtSeqNbr<br />");

					// NOW LETS FIND THE NOTIFYGROUPLINK.GROUPCODE
					$grpCode = "RN" . $srtSeqNbr;

					$qryGetNotifyRec = "SELECT DISTINCT pl.personid persId
											FROM notifyperson np, notifygrouplink ngl, personlink pl
											WHERE ngl.locationid = $ASLocationID
											AND ngl.groupcode = '$grpCode'
											AND ngl.groupcode = np.groupcode
											AND np.personlinkid = pl.recid
											AND pl.locationid = $ASLocationID";
					if($debug)
						print($qryGetNotifyRec . "<br />\n");
					$rsltGetNotifyRec = mysqli_query( $cvtconnection, $qryGetNotifyRec);
					if(!$rsltGetNotifyRec) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if(mysqli_num_rows($rsltGetNotifyRec) == 0) {
						}
						else {
							while($rowGetNotifyRec = mysqli_fetch_assoc($rsltGetNotifyRec)) {
								$persId = $rowGetNotifyRec[persId];
								if(!is_numeric($persId)) $persId = 0;

								if($debug) print("persId = $persId<br />");
								if($persIdStr == "") {
									$persIdStr = $persId;
								}
								else {
									$persIdStr .= ", " . $persId;
								}
							}
						}
					}
				}
			}
		}
		if($persIdStr == "") {
			$persIdStr = "0";
		}

		if($persIdStr != "0") {
			if($val_EMREG == "R" ) {
				print("<script language=\"javascript\" type=\"text/javascript\">submitEmailRegion(document.level3Form,'ER');</script>\n");
			}
			elseif($val_EMREG == "C" ) {
				print("<script language=\"javascript\" type=\"text/javascript\">submitEmailRegion(document.level3Form,'EC');</script>\n");
			}
		}
		else {
			print("<b>No Person found</b>");
		}
		print("</form>");
		print("</div>\n");
		break;


	case "ActExistMsg":
		print("<div class=\"datawhite\">");

		if($debug) print("Act = $Act<br />");
		if(isset($Act) && $Act != "") {
			switch($Act) {
				case "ReDepMul":
					print("<b>Warning:</b> you have not indicated which route should be used for certain publications.  Please go back to <b>\"Redeploy Multiples\"</b> in the <b>\"Adjust Draw\"</b> section and <b>\"Post\"</b> your selections.<br /><br />");
					break;
			}
		}

		// give back link
		print("<a href=\"" . urldecode(htmlspecialchars($Back, ENT_QUOTES)) . "\">Back</a><br />");

		print("</div>\n");
		break;

	case "SelRoutes":

		if(!is_numeric($pdid))	$pdid = 0;

		if($debug)
			print("dbRouteDt = $dbRouteDt, pdid = $pdid, dayVal = $dayVal<br />\n");

		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt", "routesetid", "returnsroutesetid rsRsId");
		if($rsltArr[rtvalue]) {
			$effDt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
			$rsId = $rsltArr[routesetid];
			if(!is_numeric($rsId))	$rsId = 0;
		}
		else {
			$effDt = "";
			$dbEffDt = "";
			$rsId = 0;
		}
		unset($rsltArr, $fileLineNbr);

		$dbRouteDt = DateOperations_TRADATE($dbEffDt, $dayVal, "ADD");

		if($debug)
			print("dbRouteDt = $dbRouteDt, dbEffDt = $dbEffDt <br />\n");

		print("<div class=\"datawhite\">\n");

		$dbEffDt = makedate($effdt, "MMDDYY");

		#Qury to get the information
#		$qryGetR = "SELECT DISTINCT(r.recid), CONCAT_WS(' - ', r.routenbr, r.sdesc) routeinfo
#						FROM route r, routesetdetail rsd, productdispatch pd
#						WHERE r.locationid = $ASLocationID
#						AND r.type IN ('SR', 'HO')
#						AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
#						OR r.endeffdt > '$curDate' )
#						AND pd.recid = $pdid
#						AND rsd.routesetid = pd.routesetid
#						AND r.recid = rsd.routeid
#						ORDER BY r.sortseqnbr, routeinfo";

		$routeTypeStr = "'SR', 'HO', 'PR'";

		if($val_HAWKS == "Y") {
			$routeTypeStr .= ", 'AM', 'PM', 'TR'";
		}

		if($flagAutoFill) {
			$routeTypeStr .= ", 'ER', 'ES', 'LR'";
		}

		$qryGetR = "SELECT DISTINCT(sr.recid), CONCAT_WS(' - ', NULLIF(r.routenbr, ''),
					NULLIF(r.sdesc, ''), TIME_FORMAT(sr.timesked, '%H:%i:%s')) routeinfo, sr.driverid
					FROM specificroutes sr, route r
					WHERE sr.dispatchlocid = $ASLocationID
					AND sr.datesked = '$dbRouteDt'
					AND r.recid = sr.routeid
					AND r.locationid = $ASLocationID
					AND r.type IN ($routeTypeStr)
					AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00' OR r.endeffdt > '$curDate' )
					ORDER BY r.sortseqnbr, routeinfo";

		// FOR SPLITTING OF TABLES
		$qryGetR = convertToSplitTables($qryGetR, $val_SPLIT);

		if($debug)
			print($qryGetR . "<br />\n");
		$rsltGetR= mysqli_query( $cvtconnection, $qryGetR);

		print("<form name=\"level2Form\" method=\"post\" action=\"tra37.php\" style=\"margin: 0;\">\n");
		print("<table border=\"1\" width=\"100%\">\n");
		print("<tr class=\"datatblhdr\">\n");
		if($debug) print("<td align=\"center\">Routeid</td>\n");
		print("<td align=\"center\" width=\"10%\"><input type=\"checkbox\" name=\"checkall\" value=\"checkall\" onclick=\"CheckBoxAll(this.form, this.checked, 'chkRouteIdArr')\" /></td>\n");
		print("<td>Routes</td>\n");
		print("</tr>\n");

		// FETCHES INFORMATION FROM THE ROUTE TABLE
		$oddEven = 0;
		$cntId = 0;
		if(!$rsltGetR) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			while($rowGetR = mysqli_fetch_assoc($rsltGetR)) {

				if( ( $oddEven++ % 2 ) == 0 ) {
					print("<tr class=\"datawhite\">\n");
				}
				else {
					print("<tr class=\"datagrey\">\n");
				}

				// FOR ROUTEID
				$srId = $rowGetR[recid];
				if(!is_numeric($srId)) $srId = 0;
				if($debug) print("<td>$srId</td>\n");

				// FOR SELECTING SINGLE CHECKBOX
				print("<td align=\"center\"><input type=\"checkbox\" name=\"chkRouteIdArr[" . $cntId . "]\" value=\"" . $srId . "\" onclick=\"CheckBoxSingle(this.form, this.checked)\" /></td>\n");

				// FOR ROUTEINFO
				$routeDesc = $rowGetR[routeinfo];
				print("<td>" . ($routeDesc != "" ? htmlentities($routeDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");

				print("</tr>\n");
				$cntId++;
			}
		}
		print("</table>\n");

		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"noRecords\" value=\"$cntId\" />\n");
		print("<input type=\"hidden\" name=\"dbRouteDt\" value=\"$dbRouteDt\" />\n");
		print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");

		if($cntId > 0) {
			print("<br />\n");
			print("<a href=\"javascript:submitLevel2Form(document.level2Form,'AutoFillRemaining');\">Post</a>\n");
		}

		print("</form>\n");
		print("</div>\n");
		break;

	case "AutoFillRemaining":

		if($debug)
			print("$pdid, $dbRouteDt, $noRecords <br />\n");

		print("<div align=\"left\" class=\"datawhite\">");

		if($debug) {
			print("chkRouteIdArr: <pre style=\"text-align : left\">");
			print_r($chkRouteIdArr);
			print("</pre>\n");
		}

		$chkRouteIdArr = array_values($chkRouteIdArr);

		for($cntId = 0; $cntId < count($chkRouteIdArr); $cntId++) {

			$srId = $chkRouteIdArr[$cntId];
			if(!is_numeric($srId))	$srId = 0;

			if($debug)
				print("srId = $srId <br />\n");

			// FINDING VALUES OF STARTTIME, ENDTIME AND DATECOMP
			$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "specificroutes", $srId, "DATE_FORMAT(datesked, '%Y-%m-%d') dbdatesked", "DATE_FORMAT(datecompleted, '%Y-%m-%d') dbdatecomp", "timestarted", "timecompleted", "driverid");
			if($rsltArr[rtvalue]) {
				// if $db_datecomp = 0000-00-00 set it to specificroutes.datesked
				if($rsltArr[datecomp] != "" && $rsltArr[datecomp] != "0000-00-00") {
					$dbDateComp = $rsltArr[datecomp];
				}
				else {
					$dbDateComp = $rsltArr[dbdatesked];
				}
				$dbTimeStarted = $rsltArr[timestarted];
				$dbTimeCompleted = $rsltArr[timecompleted];
				$driverId = $rsltArr[driverid];
				if(!is_numeric($driverId))	$driverId = 0;
			}
			else {
				$dbDateComp = "";
				$dbTimeStarted = "";
				$dbTimeCompleted = "";
				$driverId = 0;
			}
			unset($fileLineNbr);

			if($srId != 0) {
				# LETS CREATE TEMPTABLE FOR DE RECS AND ON THIS ROUTE
				//CreateTempDE_TRA($srId);

				$qryGetTA = "SELECT customerlocid, specificproductid,
							count(IF(type = 'SD', recid, NULL)) sd_cnt,
							count(IF(type = 'DE', recid, NULL)) de_cnt
							FROM transactivity
							WHERE locationid = $ASLocationID
							AND type IN ('SD', 'DE')
							AND specificrouteid = $srId
							GROUP BY customerlocid, specificproductid
							HAVING de_cnt = 0";

				// FOR SPLITTING OF TABLES
				$qryGetTA = convertToSplitTables($qryGetTA, $val_SPLIT);

				if($debug)
					print($qryGetTA . "<br />\n");
				$rsltGetTA = mysqli_query( $cvtconnection, $qryGetTA);
				if(!$rsltGetTA) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					$cntDECreated = 0;
					while($rowGetTA = mysqli_fetch_assoc($rsltGetTA)) {

						$locId = $rowGetTA[customerlocid];
						$spId = $rowGetTA[specificproductid];

						ValidateForInt(false, "locId", "spId");

						// GET ONE RECORD AND CREATE IT'S COPY
						$selectStr = "ta.recid taId, DATE_FORMAT(datet, '%Y-%m-%d') dbDateT";
						$fromStr = "transactivity ta, specificroutes sr";
						$whereStr = "ta.locationid = $ASLocationID
									AND ta.customerlocid = $locId
									AND ta.specificproductid = $spId
									AND type = 'SD'
									AND ta.datet = sr.datesked
									AND sr.recid = $srId
									AND sr.dispatchlocid = $ASLocationID";
						$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
						unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

						if($rsltArr) {
							$taId = $rsltArr[taId];
							$dbDateT = $rsltArr[dbDateT];
						}
						else {
							$taId = 0;
							$dbDateT = "";
						}
						unset($rsltArr);
						if(!is_numeric($taid)) $taid = 0;

						if($taId != 0) {

							$archInfoArr = array(
								"tableName" => "transactivity",
								"dbFromDate" => $dbDateT,
								"dbToDate" => $dbDateT
							);

							$fileLineNbr = __LINE__; $amtArr = GetPrices_Transact($taId, "SD", $archInfoArr);
							$salesAmt = $amtArr[salesamt];
							$costAmt = $amtArr[costamt];
							$vendAmt = $amtArr[vendamt];
							$priceCodeId = $amtArr[pricecodeidsales];
							$costCodeId = $amtArr[pricecodeidcost];
							$priceCodeVendId = $amtArr[pricecodeidvend];
							unset($amtArr);

							$fileLineNbr = __LINE__; $qryIns = CreateRecordCopyGeneral("transactivity", $taId, $cvtconnection,
								"type", "DE",
								"specificrouteid", $srId,
								"activesession", $RecIdAS,
								"datet", $dbDateComp,
								"timet", $dbTimeCompleted,
								"personid", $driverId,
								"closeddatecust", ($priceCodeId != 0 ? NULL : $val_INDEF),
								"closeddatevend", ($costCodeId != 0 ? NULL : $val_INDEF),
								"closeddatevendinv", ($priceCodeVendId != 0 ? NULL : $val_INDEF),
								"closeddatecustpay", $val_INDEF,
								"unitsales", $salesAmt,
								"unitcost", $costAmt,
								"unitsalesvend", $vendAmt
							);

							// FOR SPLITTING OF TABLES
							$qryIns = convertToSplitTables($qryIns, $val_SPLIT);

							if($debug)
								print("<b>" . $qryIns . "</b><br />\n");
							$rsltIns = mysqli_query( $cvtconnection, $qryIns);
							if(!$rsltIns) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 02);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if($debug)
									print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");

								$cntDECreated++;

								// UPDATE SPECIFICROUTELOC
								$fileLineNbr = __LINE__; UpdateSpecRtLoc_TRA($srId, $locId, $dbDateComp, $dbTimeStarted);
								$fileLineNbr = __LINE__; UpdateTotalDrawAccounting_TRA($spId);
								$fileLineNbr = __LINE__; UpdateRouteDrawAccounting_TRA($srId, $spId);
							}
						}
					}
				}
			}

			// UPDATE SPECIFICROUTEID
			$fileLineNbr = __LINE__; UpdateSpecRt_TRA($srId, $driverId, $dbDateComp, $dbTimeStarted, $dbTimeCompleted);

			// SHOW ROUTEINFO
			$selectStr = "CONCAT_WS(' - ', NULLIF(r.routenbr, ''), DATE_FORMAT(sr.datesked, '%m/%d/%y')) routeInfo, sr.driverid driverId";
			$fromStr = "route r, specificroutes sr";
			$whereStr = "sr.recid = $srId
						AND r.recid = sr.routeid
						AND sr.dispatchlocid = $ASLocationID";
			$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
			unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

			if($rsltArr) {
				$routeInfo = $rsltArr[routeInfo];
				$driverId = $rsltArr[driverId];
				$driverName = GetPer($driverId, $cvtconnection);

				if($driverName != "") $routeInfo .= " - " . $driverName;
			}
			else {
				$routeInfo = "";
			}
			unset($rsltArr);

			//print("<div align=\"left\" class=\"datawhite\">\n");

			print("<b><u>" . htmlentities($routeInfo, ENT_QUOTES) . "</u></b><br /><br />\n");

			print("<b>" . $cntDECreated . "</b> Location/Publications auto-filled.<br /><br /><br />\n");
		}

		print("</div>\n");
		break;

	case "ShowDeliverySlips":

		if($debug)
			print("ShowDeliverySlips is called.<br />\n");

		ValidateForInt(false, "pdid");

		print("<div class=\"datawhite\">");

		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "rundate");
		if($rsltArr[rtvalue]) {
			$dbEffDt = $rsltArr[rundate];
			$effDt = get_date($dbEffDt, "MMDDYY", "YYYY-MM-DD");
		}
		else {
			$dbEffDt = "";
			$effDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		// GETTING unset locations information
		$qryGetInfo = "SELECT /*tra37*/ DISTINCT(srl.recid) srlid,
						CONCAT_WS(' - ', NULLIF(r.routenbr, ''), NULLIF(r.sdesc, '')) routeinfo,
						c.name custname, l.sdesc locdesc, rl.billingpersonid,
						srl.locationid locid, sr.recid srid, rl.deliveryslipflag delslip
						FROM route r, specificroutes sr, specificrouteloc srl,
						routelink rl, location l, locationlink ll, company c, transactivity ta
						WHERE r.locationid = $ASLocationID
						AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00' OR r.endeffdt > '$dbEffDt' )
						AND sr.routeid = r.recid
						AND r.type = 'SR'
						AND sr.dispatchlocid = $ASLocationID
						AND sr.datesked = '$dbEffDt'
						AND srl.specificrouteid = sr.recid
						AND srl.clientlocid = $ASLocationID
						AND ( srl.dateemailsent = 0 OR srl.dateemailsent IS NULL )
						AND rl.locationid = srl.locationid
						AND rl.clientid = $ASCompanyID
						AND ( rl.endeffdt IS NULL OR rl.endeffdt = '0000-00-00' OR rl.endeffdt > '$dbEffDt' )
						/*AND rl.deliveryslipflag IN ('E', 'I', 'B', 'J', 'K')*/
						AND (rl.deliveryslipflag IN ('E', 'B') OR rl.pod = 'S')
						AND l.recid = rl.locationid
						AND ( l.endeffdate IS NULL OR l.endeffdate = '0000-00-00' OR l.endeffdate > '$dbEffDt' )
						AND ll.locationid = l.recid
						AND c.recid = ll.companyid
						AND ta.locationid = $ASLocationID
						AND ta.customerlocid = rl.locationid
						AND ta.type IN ('SD', 'SP')
						AND ta.specificrouteid = sr.recid
						ORDER BY r.sortseqnbr, routeinfo, sr.datesked DESC, srl.dateactual DESC, srl.timeactual, custname, locdesc";//Task#8892

		// FOR SPLITTING OF TABLES
		$qryGetInfo = convertToSplitTables($qryGetInfo, $val_SPLIT);

		if($debug)
			print($qryGetInfo . "<br />\n");
		$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);

		print("<form name=\"level2Form\" method=\"post\" action=\"tra37.php\">");

		print("<table border=\"1\" width=\"100%\">\n");
		print("<tr class=\"datatblhdr\">\n");
		if($debug) print("<td>srlid</td>\n");
		if($debug) print("<td>locid</td>\n");
		print("<td align=\"center\"><input type=\"checkbox\" name=\"checkall\" value=\"checkall\" onclick=\"CheckBoxAll(this.form, this.checked, 'srlid_array')\" /></td>\n");
		if($debug) print("<td align=\"center\">Del Slip</td>\n");
		print("<td>Route</td>\n");
		print("<td>Customer</td>\n");
		print("<td>Location</td>\n");
		print("<td>Person</td>\n");
		print("<td>eMail Address</td>\n");
		if($debug) print("<td>spid</td>\n");
		print("<td>Publication</td>\n");
		print("<td align=\"center\">Date</td>\n");
		print("<td align=\"center\">Del/Ret</td>\n");
		print("<td align=\"right\">Quantity</td>\n");
		print("</tr>\n");

		$oddEven = 0;
		$cntId = 0;
		if(!$rsltGetInfo) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
				$srlId = $rowGetInfo[srlid];
				$locId = $rowGetInfo[locid];
				$srId = $rowGetInfo[srid];
				ValidateForInt(false, "srlId", "locId", "srId");

				$spArr = GetTASkedQty_TRA37($srlId);

				if(is_array($spArr)) {
					$noRows = count($spArr);
				}
				else {
					$noRows = 0;
				}

				if($debug) {
					print("<pre style=\"text-align: left;\">");
					print_r($spArr);
					print("</pre>\n");
				}

				//if($noRows != 0) {

					if($noRows == 0) $noRows = 1;

					for($cntRow = 0; $cntRow < $noRows; $cntRow++) {

						if($cntRow == 0) {

							if( ( $oddEven++ % 2 ) == 0 ) {
								print("<tr class=\"datawhite\">\n");
							}
							else {
								print("<tr class=\"datagrey\">\n");
							}

							// FOR SRLID
							if($debug) print("<td rowspan=\"" . $noRows . "\">$srlId</td>");
							if($debug) print("<td rowspan=\"" . $noRows . "\">$locId</td>");

							// FOR SEL
							print("<td align=\"center\" rowspan=\"" . $noRows . "\"><input type=\"checkbox\" name=\"srlid_array[" . $cntId . "]\" value=\"" . $srlId . "\" onclick=\"CheckBoxSingle(this.form, this.checked)\" /></td>\n");

							// FOR DELSLIP
							$delSlip = $rowGetInfo[delslip];
							if($debug) print("<td  rowspan=\"" . $noRows . "\" align=\"center\">" . $delSlip . "</td>\n");

							// FOR ROUTE
							$routeInfo = $rowGetInfo[routeinfo];
							print("<td rowspan=\"" . $noRows . "\">" . htmlentities($routeInfo, ENT_QUOTES) . "</td>\n");

							// FOR CUSTOMER
							$custName = $rowGetInfo[custname];
							print("<td rowspan=\"" . $noRows . "\">" . htmlentities($custName, ENT_QUOTES) . "</td>\n");

							// FOR LOCATION
							$locDesc = $rowGetInfo[locdesc];
							print("<td rowspan=\"" . $noRows . "\">" . htmlentities($locDesc, ENT_QUOTES) . "</td>");

							// FOR PERSON
							$persId = $rowGetInfo[billingpersonid];
							if(!is_numeric($persId)) $persid = 0;

							$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "person", $persId, "CONCAT_WS(', ', NULLIF(lastname, ''), NULLIF(firstname, '')) persname", "email");
							if($rsltArr[rtvalue]) {
								$persName = $rsltArr[persname];
								$eMail = $rsltArr[email];
							}
							else {
								$persName = "";
								$eMail = "";
							}
							unset($rsltArr, $fileLineNbr);

							print("<td rowspan=\"" . $noRows . "\">" . htmlentities($persName, ENT_QUOTES) . "</td>");

							// FOR EMAIL ADDRESS
							print("<td rowspan=\"" . $noRows . "\">" . htmlentities($eMail, ENT_QUOTES) . "</td>");
						}

						// NOW HERE WE NEED TO FIND THE DE QUANTITIES
						if(is_array($spArr)) {

							if(list($spId, $infoArr) = each($spArr)) {

								if($cntRow != 0) {
									if( ( ( $oddEven - 1 ) % 2 ) == 0 ) {
										print("<tr class=\"datawhite\">\n");
									}
									else {
										print("<tr class=\"datagrey\">\n");
									}
								}

								if(!is_numeric($spId)) $spId = 0;
								if($debug) print("<td>$spId</td>\n");

								// FOR PUBLICATION
								$prodDesc = $infoArr[proddesc];
								print("<td>" . htmlentities($prodDesc, ENT_QUOTES) . "</td>\n");

								// FOR DATE
								$dateX = $infoArr[datex];
								print("<td align=\"center\">" . htmlentities($dateX, ENT_QUOTES) . "</td>\n");

								// FOR DEL/RET
								$type = $infoArr[type];
								print("<td align=\"center\">" . htmlentities($typeArr[$type], ENT_QUOTES) . "</td>\n");

								// FOR QUANTITY
								$qty = $infoArr[qty];
								if(!is_numeric($qty)) $qty = 0;
								print("<td align=\"right\">$qty</td>\n");

								if($cntRow != 0) print("</tr>\n");
							}
							else {
								if($debug) print("<td>&nbsp;</td>\n");
								print("<td>&nbsp;</td>\n");
								print("<td>&nbsp;</td>\n");
								print("<td>&nbsp;</td>\n");
								print("<td>&nbsp;</td>\n");
							}
						}
						else {
							if($debug) print("<td>&nbsp;</td>\n");
							print("<td>&nbsp;</td>\n");
							print("<td>&nbsp;</td>\n");
							print("<td>&nbsp;</td>\n");
							print("<td>&nbsp;</td>\n");
						}

						if($cntRow == 0) {
							print("</tr>\n");
						}
					}

					$cntId++;
				//} // End of NoRows != 0
			}
		}

		print("</table>\n");

		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"effdt\" value=\"$effDt\" />\n");
		print("<input type=\"hidden\" name=\"norecords\" value=\"$cntId\" />\n");
		if($cntId > 0) {
			print("<br />\n");
			print("<a href=\"javascript:SubmitLevel2Form('DeliverySlipPost');\">Post</a>\n");
		}
		print("</form>\n");
		print("</div>\n");
		break;

	case "DeliverySlipPost":
                #$debug=1;
		if($debug)
			print("DeliverySlipPost is called.<br />\n");

		$dbEffDt = makedate($effdt, "MMDDYY");
		$dispEffDt = set_date($effdt, "MMDDYY", "MM/DD/YY");

		print("<div class=\"datawhite\">\n");

		print("<b><u>Mail Sending</u></b><br /><br />\n");

		print("<table border=\"1\" width=\"60%\">\n");
		print("<tr class=\"datatblhdr\">\n");
		print("<td width=\"75%\">Customer</td>\n");
		print("<td align=\"center\" width=\"25%\">Mail Sent</td>\n");
		print("</tr>\n");

		// WE HAVE SRLID_ARRAY
		while(list($cntId, $srlId) = each($srlid_array)) {

			// FIND THE PERSON
			$selectStr = "p.recid, CONCAT_WS(', ', NULLIF(p.lastname, ''), NULLIF(p.firstname, ''))
						persname, p.email,
						CONCAT_WS(' - ', NULLIF(c.name, ''), NULLIF(l.sdesc, '')) custname,
						l.recid locid, sr.datesked dbDateSked";
			$fromStr = "company c, locationlink ll, specificrouteloc srl,
						location l, specificroutes sr, routelink rl
						LEFT JOIN person p ON p.recid = rl.billingpersonid";
			$whereStr = "srl.recid = $srlId
						AND srl.clientlocid = $ASLocationID
						AND sr.recid = srl.specificrouteid
						AND sr.dispatchlocid = $ASLocationID
						AND l.recid = srl.locationid
						AND ll.locationid = l.recid
						AND c.recid = ll.companyid
						AND rl.locationid = srl.locationid
						AND rl.clientid = $ASCompanyID
						AND ( l.endeffdate IS NULL OR l.endeffdate = '0000-00-00' OR l.endeffdate > '$curDate' )";

			$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
			unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

			if($rsltArr) {
				$persid = $rsltArr[recid];
				$persname = $rsltArr[persname];
				$email = $rsltArr[email];
				$custname = $rsltArr[custname];
				$locid = $rsltArr[locid];
				$dbDateSked = $rsltArr[dbDateSked];

				ValidateForInt(false, "locid", "persid");
			}
			else {
				$persid = 0;
				$persname = "";
				$email = "";
				$custname = "";
				$locid = 0;
				$dbDateSked = "";
			}
			unset($rsltArr);

			if( ( $oddEven++ % 2 ) == 0 ) {
				print("<tr class=\"datawhite\">\n");
			}
			else {
				print("<tr class=\"datagrey\">\n");
			}

			// FOR CUSTOMER
			print("<td>" . htmlentities($custname, ENT_QUOTES) . "</td>\n");
			print("<td align=\"center\">\n");

			if($email != "") {
				// NOW HERE WE NEED TO DECIDE WHETHER TO SEND AS EML06 LINK
				// OR AN ATTACHMENT WITH TRA30 REPORT
				$selectStr = "deliveryslipflag, pod";//Task#8884
				$fromStr = "routelink";
				$whereStr = "clientid = $ASCompanyID
							AND locationid = $locid";
				$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
				unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

				if($rsltArr) {
					$chrDelSlip = $rsltArr[deliveryslipflag];
					$rl_pod = $rsltArr[pod];//Task#8884
				}
				else {
					$chrDelSlip = $rl_pod = "";//Task#8884
				}
				unset($rsltArr);

				// GETTING LocationSystem VARIABLE EMLID FOR FROM EMAIL
				$val_EMLID = GetLSVar("EMLID", "strvar", $ASLocationID, $cvtconnection);
				if($debug) print("EMLID = $val_EMLID<br />\n");
				if($val_EMLID == "") {
					$val_EMLID = "noreply@teakwce.com";
				}

				//if($chrDelSlip == "I" || $chrDelSlip == "J" || $chrDelSlip == "K") //Task#8884 comment
				if($rl_pod == 'S')//Task#8884
				{
					//NOW FOR SENDING EMAIL, WE WANT TO, FROM AND MSG

					//LET'S GET FROM ADDRESSFIRST
					$val_EMLNM = GetLSVar("EMLNM", "strvar", $ASLocationID, $cvtconnection);
					if($debug) print("EMLNM = $val_EMLNM<br />\n");

					$from = "\"$val_EMLNM\" <$val_EMLID>";

					$val_HOSTN = GetSysVar("HOSTN", "strvar", $cvtconnection);
					if($debug) print("HOSTN = $val_HOSTN<br />\n");

					$encodedstr = "PageNbr=EML07&srlId=" . $srlId . "&clientlocid=" . $ASLocationID . "";
					if($debug) print("qrystr = " . htmlentities($encodedstr, ENT_QUOTES) . "<br />\n");
					$encodedstr = StringEncode($cvtconnection, $encodedstr);
					$encodedstr = urlencode($encodedstr);

					// FINDING LOCATION DESCRIPTION
					$selectStr = "CONCAT_WS(' - ', NULLIF(c.name, ''), NULLIF(l.storenbr, ''), NULLIF(l.sdesc, ''), NULLIF(a.address1, ''), NULLIF(a.address2, ''), NULLIF(a.address3, ''), NULLIF(a.address4, '')) locDesc, CONCAT_WS(' - ', NULLIF(c.name, ''), NULLIF(l.storenbr, ''), NULLIF(l.sdesc, '')) locDesc2";
					$fromStr = " locationlink ll, company c, location l
								LEFT JOIN address a ON a.recid = l.addressid";
					$whereStr = "l.recid = $locid
								AND ll.locationid = l.recid
								AND c.recid = ll.companyid";
					$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
					unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

					if($rsltArr) {
						$locDesc = $rsltArr[locDesc];
						$locDesc2 = $rsltArr[locDesc2];
					}
					else {
						$locDesc = "";
						$locDesc2 = "";
					}
					unset($rsltArr);

                                        $uurl = "https://" . $val_HOSTN . dirname(dirname($REQUEST_URI)) . "/em/eml06.php?db=" . $db . "&" . $encodedstr . "e";
                                        
					$msg = "";
					$msg .= "Location : " . $locDesc . "<br /><br />";

                                        $msg .= "Please <a href=\"$uurl\"  style=\"font-size:20px;\"><b> Click here</b></a> to set Returns Quantities.  Thank you for your cooperation.<br /><br />";
					#$msg .= "Please set Returns Quantities.  Thank you for your cooperation.\n\n";
                                        
					#$msg .= "https://" . $val_HOSTN . dirname(dirname($REQUEST_URI)) . "/em/eml06.php?db=" . $db . "&" . $encodedstr . "e";
					#$msg .= "<br /><br />";
					#$msg .= "Please click on the above link to enter data.\n\n";
					if($debug) print("msg = $msg<br />");

					//SUBJECT
					$subject = "Returns Reporting - " . $locDesc2 . "";//Task#8884

					$to = $email;

					$mail = new htmlMimeMail();

					//SET MESSAGE
					//$mail->setText($msg);
                                        $mail->setHtml($msg);

					//SEND MAIL
					$mail->setFrom($from);
					$mail->setSubject($subject);

					if($mail->send(array($to), "mail")) {
						print("<img src=\"../img/sel.gif\" border=\"0\" height=\"12\" width=\"12\" alt=\"\" />");
						$qryUp = "UPDATE specificrouteloc
									SET dateemailsent = NOW(),
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE recid = $srlId
									AND clientlocid = $ASLocationID";

						// FOR SPLITTING OF TABLES
						$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
						}
					}
					else {
						print("<div style=\"color:#ff0000\">");
						print("Problem Sending Mail");
						print("</div>\n");
					}

					unset($mail);
				}
				//else//Task#8884 comment
				if($chrDelSlip == "E" || $chrDelSlip == "B")//Task#8884
				{
					$filename = "/usr/local/twceconf/temp/TRA37_" . $RecIdAS . "_" . $srlId . ".htm";
					$fp = fopen($filename, "w");

					$output_str = "";
					$output_str .= "<html>";
					$output_str .= "<head>";
					$output_str .= "<link rel=StyleSheet href=\"../css/twce.css\" type=\"text/css\">";
					$output_str .= "<meta http-equiv=\"Pragma\" content=\"no-cache\" />";

					/*
						Call to TRA30 report printer function
						in trafunc.php
					*/
					$infoArr = array("PageNbr" => "TRA37");
					$output_str .= Print_TRA30_Report($srlId, $dbDateSked, $infoArr);

					$output_str .= "</body></html>";

					fwrite($fp, $output_str);


					fclose($fp);

					// IF DEBUG COPY THE FILE
					$client_name = GetComp($ASCompanyID, $cvtconnection);

					$from = "\"$client_name\" <$val_EMLID>";
					$to = $email;
					$dispEffDtSub= date('d-M-Y', strtotime($dispEffDt));
					$subject = "Delivery Slip for " . $dispEffDtSub . "";
					$msg = "Delivery Slip dated " . $dispEffDt . " is Attached";

					$mail = new htmlMimeMail();

					//SET MESSAGE
					$mail->setText($msg);

					//SET ATTACHMENT
					$attachment = $mail->getFile($filename);
					$mail->addAttachment($attachment, "DeliverySlip.htm");

					//SEND MAIL
					$mail->setFrom($from);
					$mail->setSubject($subject);

					if($mail->send(array($to), "mail")) {
						print("<img src=\"../img/sel.gif\" border=\"0\" height=\"12\" width=\"12\" alt=\"\" />");
						$qryUp = "UPDATE specificrouteloc
									SET dateemailsent = NOW(),
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE recid = $srlId
									AND clientlocid = $ASLocationID";

						// FOR SPLITTING OF TABLES
						$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
						}
					}
					else {
						print("<div style=\"color:#ff0000\">");
						print("Problem Sending Mail");
						print("</div>\n");
					}

					unset($mail);

					// DELETE FILE
					exec("rm -f $filename");
				}
			}
			else {
				print("<div style=\"color:#ff0000\">");
				print("eMail not found");
				print("</div>\n");
			}
			print("</td>\n");
			print("</tr>\n");
		}

		print("</table>\n");
		print("</div>\n");
		break;

	case "ShowDraw":
              	
		ValidateForInt(false, "locId");
		$dbEffDt = makedate($effDt, "MMDDYY");

		$typeArr = array(
			"SD" => "Delivery",
			"SP" => "Return"
		);
                                
                print("<div class=\"datawhite\">");

		// DISPLAYING HEADING I.E. LOCATION INFO.
		$infoArr = array( "IDNBR" => "Y");
		$fileLineNbr = __LINE__; $headerDesc = GetLocDesc_TRA($locId, $infoArr);
		$headerDesc .= " - " . get_date($dbEffDt, "MM/DD/YY");
		print("<div align=\"center\">\n");
		print("<br /><u><b>" . htmlentities($headerDesc, ENT_QUOTES) . "</b></u>\n");
		print("</div><br /><br />\n");

		$qryGetInfo = "SELECT ta.recid, ta.type type, sp.datex dbDateX,
						sp.productid prodId, p.ldesc prodDesc,
						DATE_FORMAT(sp.datex, '%m/%d/%y') dispDateX
						FROM transactivity ta, specificproduct sp, product p
						WHERE ta.locationid = $ASLocationID
						AND ta.type IN ('SD', 'SP')
						AND ta.datet = '$dbEffDt'
						AND ta.customerlocid = $locId
						AND sp.recid = ta.specificproductid
						AND p.recid = sp.productid
						ORDER BY ta.type, p.ldesc, sp.datex";

		// FOR SPLITTING OF TABLES
		$qryGetInfo = convertToSplitTables($qryGetInfo, $val_SPLIT);

		if($debug)
			print($qryGetInfo . "<br />\n");
		$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);

		print("<table border=\"1\" width=\"100%\">\n");
		print("<tr class=\"datatblhdr\">\n");
		if($debug) print("<td>taid :: ProdId :: DateX</td>\n");
		print("<td align=\"center\">Activity</td>\n");
		print("<td>Publication</td>\n");
		print("<td align=\"center\">Publication Date</td>\n");
		print("</tr>\n");

		$oddEven = 0;
		if(!$rsltGetInfo) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
				if( ( $oddEven++ % 2 ) == 0 ) {
					print("<tr class=\"datawhite\">\n");
				}
				else {
					print("<tr class=\"datagrey\">\n");
				}

				// FOR TAID :: PRODID :: DATEX
				$prodDateX = $rowGetInfo[recid] . " :: " . $rowGetInfo[prodId] . " :: " . $rowGetInfo[dbDateX];
				if($debug) print("<td>" . $prodDateX . "</td>");

				// FOR ACTIVITY
				$type = $rowGetInfo[type];
				print("<td align=\"center\">" . htmlentities($typeArr[$type], ENT_QUOTES) . "</td>\n");

				// FOR PUBLICATION
				$prodDesc = $rowGetInfo[prodDesc];
				print("<td>" . htmlentities($prodDesc, ENT_QUOTES) . "</td>\n");

				// FOR PUBLICATION DATE
				$dispDateX = $rowGetInfo[dispDateX];
				print("<td align=\"center\">" . htmlentities($dispDateX, ENT_QUOTES) . "</td>\n");

				print("</tr>\n");
			}
		}
		print("</table>\n");
		print("</div>\n");
		break;

	case "ToAddSpecificRoute":

		if($debug) {
			print("Specific Route Selection = ToAddSpecificRoute<br />\n");
			print("pdid = $pdid<br />\n");
		}

		print("<div class=\"datawhite\">\n");

		// FINDING ROUTESETID AND RETURNSROUTESETID
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "routesetid routeSetId", "returnsroutesetid returnsRouteSetId", "DATE_FORMAT(rundate, '%m%d%y') effDt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$routeSetId = $rsltArr[routeSetId];
			$returnsRouteSetId = $rsltArr[returnsRouteSetId];
			$effDt = $rsltArr[effDt];
			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$routeSetId = 0;
			$returnsRouteSetId = 0;
			$effDt = "";
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		// Display Run Date
		$dispEffDt = get_date($dbEffDt, "MM/DD/YY");
		print("<b><u>Run Date - $dispEffDt</u></b><br /><br />");

		$typeStr = "'SR', 'RS', 'LR', 'SS', 'PR'";
		if($val_ESRTE == "Y") {
			$typeStr .= ", 'ES', 'ER'";
		}
		if($val_HAWKS == "Y") {
			$typeStr .= ", 'AM', 'PM', 'TR'";
		}

		// FINDING ROUTES OF SR TYPE FROM ROUTESETID
		$srRouteIdStr = "";
		$qryGetRouteSetInfo = "SELECT r.recid routeId
								FROM routesetdetail rsd, route r, specificroutes sr
								WHERE rsd.routesetid = $routeSetId
								AND r.recid = rsd.routeid
								AND r.type IN ($typeStr)
								AND r.locationid = $ASLocationID
								AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
								OR r.endeffdt > '$curDate' )
								AND ( rsd.endeffdt IS NULL OR rsd.endeffdt = '0000-00-00'
								OR rsd.endeffdt > '$curDate' )
								AND sr.routeid = r.recid
								AND sr.datesked = '$dbEffDt'
								AND sr.dispatchlocid = $ASLocationID
								ORDER BY r.sortseqnbr, r.routenbr, r.sdesc";

		// FOR SPLITTING OF TABLES
		$qryGetRouteSetInfo = convertToSplitTables($qryGetRouteSetInfo, $val_SPLIT);

		if($debug)
			print($qryGetRouteSetInfo . "<br />\n");
		$rsltGetRouteSetInfo = mysqli_query( $cvtconnection, $qryGetRouteSetInfo);
		if(!$rsltGetRouteSetInfo) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetRouteSetInfo) == 0) {
				$srRouteIdStr = "0";
			}
			else {
				while($rowGetRouteSetInfo = mysqli_fetch_assoc($rsltGetRouteSetInfo)) {

					$routeId = $rowGetRouteSetInfo[routeId];
					if(!is_numeric($routeId))	$routeId = 0;

					if($srRouteIdStr == "") {
						$srRouteIdStr = $routeId;
					}
					else {
						$srRouteIdStr .= ", " . $routeId;
					}
				}

				if($srRouteIdStr == "")
					$srRouteIdStr = "0";
			}
		}

		if($debug)
			print("srRouteIdStr = $srRouteIdStr<br />\n");

		print("<form name=\"level2Form\" method=\"post\" action=\"tra37.php\">\n");
		print("<table  border=\"0\" cellpadding=\"6\" cellspacing=\"2\">\n");

		print("<tr><td class=\"entryscreenborder\">\n");
		print("<table  width=\"100%\" border=\"0\" bgcolor=\"white\" cellpadding=\"1\" cellspacing=\"1\">\n");

			// FOR SELECT ROUTE
			print("<tr>\n");
			print("<td class=\"datagrey\">Select Route</td>\n");
			print("<td class=\"datawhite\">\n");
			$qryGetRouteInfo = "SELECT r.recid routeId,
								CONCAT_WS(' - ', NULLIF(r.routenbr, ''), NULLIF(r.sdesc, '')) routeDesc
								FROM route r
								WHERE r.locationid = $ASLocationID
								AND r.type IN ($typeStr)
								AND r.recid NOT IN ($srRouteIdStr)";
			if($val_DRREQ == "Y") {
				$qryGetRouteInfo .= " AND ( r.defaultdriverid IS NOT NULL
										AND r.defaultdriverid != ''
										AND r.defaultdriverid != 0)";
			}

			$qryGetRouteInfo .= " AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00' OR r.endeffdt > '$curDate' )
								ORDER BY r.sortseqnbr";
			if($debug)
				print($qryGetRouteInfo . "<br />\n");
			$rsltGetRouteInfo = mysqli_query( $cvtconnection, $qryGetRouteInfo);
			if(!$rsltGetRouteInfo) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			print("<select name=\"routeId\">\n");
			print("\t<option value=\"\">Select Route</option>\n");
			if($rsltGetRouteInfo) {
				while($rowGetRouteInfo = mysqli_fetch_assoc($rsltGetRouteInfo)) {

					print("\t<option value=\"" . $rowGetRouteInfo[routeId] . "\"");
					if($routeId == $rowGetRouteInfo[routeId])
						print(" selected=\"selected\"");
					print(">");
					if($debug)
						print("" . $rowGetRouteInfo[routeId] . " - ");
					print(htmlentities($rowGetRouteInfo[routeDesc], ENT_QUOTES) . "</option>\n");
				}
			}
			print("</select>\n");
			print("</td>\n");
			print("</tr>\n");

		print("</table>\n");
		print("</td></tr>\n");

		print("<tr><td>\n");
		// HIDDEN FIELDS
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");

		print("<a href=\"javascript:submitRoute('AddSpecificRoute');\">Add Route</a>");
		print("</td></tr>\n");

		print("</table>\n");
		print("</form>\n");
		print("</div>\n");
		break;

	case "AddSpecificRoute":
		if($debug)
			print("Specific Route Addition = AddSpecificRoute<br />\n");

		ValidateForInt(false, "routeId");

		if($debug)
			print("routeId = $routeId, $pdid<br />\n");

		// FINDING ROUTESETID AND RETURNSROUTESETID
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "routesetid routeSetId", "returnsroutesetid returnsRouteSetId", "DATE_FORMAT(rundate, '%m%d%y') effDt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$routeSetId = $rsltArr[routeSetId];
			$returnsRouteSetId = $rsltArr[returnsRouteSetId];
			$effDt = $rsltArr[effDt];
			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$routeSetId = 0;
			$returnsRouteSetId = 0;
			$effDt = "";
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		//FIRST CHECK IN ROUTEFREQUENCY RECORD AND IF FOUND THEN ONLY PROCEED AHEAD
		$selectStr = "deviceid, driverid, TIME_FORMAT(timeX, '%H:%i:%s') timeX";
		$fromStr = "routefrequency";
		$whereStr = "routeId = $routeId
					AND ( endeffdt IS NULL OR endeffdt = '0000-00-00' OR endeffdt > '$dbEffDt' )";
		$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
		unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

		if($rsltArr) {
			$deviceId = $rsltArr[deviceid];
			$driverId = $rsltArr[driverid];
			$timeX = $rsltArr[timeX];
			unset($rsltArr);
		}

		ValidateForInt(false, "deviceId", "driverId");

		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "route", $routeId, "sdesc",
					"defaultdeviceid defaultDeviceId",
					"defaultdriverid defaultDriverId",
					"defaultvehicleid defaultVehicleId",
					"TIME_FORMAT(defaultstarttime, '%H:%i:%s') defaultStartTime",
					"TIME_FORMAT(defaultendtime, '%H:%i:%s') defaultEndTime",
					"type routeType");
		if($rsltArr[rtvalue]) {
			$sDesc = $rsltArr[sdesc];
			$defaultDeviceId = $rsltArr[defaultDeviceId];
			$defaultDriverId = $rsltArr[defaultDriverId];
			$defaultVehicleId = $rsltArr[defaultVehicleId];
			$defaultStartTime = $rsltArr[defaultStartTime];
			$defaultEndTime = $rsltArr[defaultEndTime];
			$routeType = $rsltArr[routeType];

			ValidateForInt(false, "defaultDeviceId", "defaultDriverId", "defaultVehicleId");
		}
		else {
			$sDesc = "";
			$defaultDeviceId = 0;
			$defaultDriverId = 0;
			$defaultVehicleId = 0;
			$defaultStartTime = "00:00:00";
			$defaultEndTime = "00:00:00";
			$routeType = "";
		}
		unset($rsltArr, $fileLineNbr);

		if($deviceId == 0) $deviceId = $defaultDeviceId;
		if($driverId == 0) $driverId = $defaultDriverId;
		$vehicleId = $defaultVehicleId;
		if($timeX == "" || $timeX == "00:00:00") $timeX = $defaultStartTime;
		$dbEndTimeX = $defaultEndTime;


		// NOW HERE WE NEED TO CREATE ONE RECORD IF IT DOES NOT EXIST
		// ELSE UPDATE IT.
		$qryChkRecs = "SELECT recid
						FROM specificroutes
						WHERE dispatchlocid = $ASLocationID
						AND routeid = $routeId
						AND datesked = '$dbEffDt'";

		// FOR SPLITTING OF TABLES
		$qryChkRecs = convertToSplitTables($qryChkRecs, $val_SPLIT);

		if($debug)
			print($qryChkRecs . "<br />\n");
		$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
		if(!$rsltChkRecs) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
				$srId = $rowChkRecs[recid];
				if(!is_numeric($srId)) $srId = 0;
			}
			else {
				$srId = 0;
			}
		}

		if($srId == 0) {
			//NOW INSERT A RECORD IN SPECIFICROUTES
			$qryIns = "INSERT INTO specificroutes(dispatchlocid, routeid, datesked,
						timesked, endtimesked, sdesc, status,
						driverid, vehicleid, deviceid, sentflag,
						message)
						VALUES($ASLocationID, $routeId, '$dbEffDt',
						'$timeX', " . ($dbEndTimeX != "" ? "'$dbEndTimeX'" : "NULL") . ", '" . addslashes($sDesc) . "', 'P',
						$driverId, $vehicleId, $deviceId, 'N',
						'" . addslashes($routeMsg) . "')";

			// FOR SPLITTING OF TABLES
			$qryIns = convertToSplitTables($qryIns, $val_SPLIT);

			if($debug)
				print("<b>" . $qryIns . "</b><br />\n");
			$rsltIns = mysqli_query( $cvtconnection, $qryIns);
			if(!$rsltIns) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				$srId = getLastInsertId();
				if(!is_numeric($srId)) $srId = 0;
			}
		}
		else {
			// update it
			$qryUp = "UPDATE specificroutes
					SET status = 'P',
					driverid = $driverId,
					vehicleid = $vehicleId,
					deviceid = $deviceId,
					sentflag = 'N',
					message = '" . addslashes($routeMsg) . "',
					archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
					WHERE recid = $srId";

			// FOR SPLITTING OF TABLES
			$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

			if($debug)
				print("<b>" . $qryUp . "</b><br />\n");
			$rsltUp = mysqli_query( $cvtconnection, $qryUp);
			if(!$rsltUp) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if($debug)
					print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
			}
		}

		if($srId != 0) {

			if($val_HWKPR == "Y") {
				$qryDel = "DELETE FROM hawkerrouteloclink
							USING hawkerrouteloclink, specificrouteloc
							WHERE specificrouteloc.clientlocid = $ASLocationID
							AND specificrouteloc.specificrouteid = $srId
							AND specificrouteloc.recid = hawkerrouteloclink.specificroutelocid";

				// FOR SPLITTING OF TABLES
				$qryDel = convertToSplitTables($qryDel, $val_SPLIT);

				if($debug) print("<b>$qryDel</b><br />");
				$rsltDel = mysqli_query( $cvtconnection, $qryDel);
				if(!$rsltDel) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 04);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " .
					$strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if($debug)
						print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
				}
			}

			// DELETING RECORDS FORM SPECIFICROUTELOC TABLE
			$qryDel = "DELETE FROM specificrouteloc
						WHERE specificrouteid = $srId
						AND clientlocid = $ASLocationID
						AND archupdt = 'N'";

			// FOR SPLITTING OF TABLES
			$qryDel = convertToSplitTables($qryDel, $val_SPLIT);

			if($debug)
				print("<b>" . $qryDel . "</b><br />\n");
			$rsltDel = mysqli_query( $cvtconnection, $qryDel);
			if(!$rsltDel) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 04);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if($debug)
					print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> affected.<br />");
			}

			$qryUp = "UPDATE specificrouteloc
						SET clientlocid = $val_DELCO,
						archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
						WHERE specificrouteid = $srId
						AND clientlocid = $ASLocationID";

			// FOR SPLITTING OF TABLES
			$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

			if($debug)
				print("<b>" . $qryUp . "</b><br />\n");
			$rsltUp = mysqli_query( $cvtconnection, $qryUp);
			if(!$rsltUp) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 04);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if($debug)
					print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> affected.<br />");
			}

			// DELETING RECORDS FORM ROUTEDRAWACCOUNTING TABLE
			$qryDel = "DELETE FROM routedrawaccounting
						WHERE specificrouteid = $srId
						AND clientlocid = $ASLocationID
						AND archupdt = 'N'";

			// FOR SPLITTING OF TABLES
			$qryDel = convertToSplitTables($qryDel, $val_SPLIT);

			if($debug)
				print("<b>" . $qryDel . "</b><br />\n");
			$rsltDel = mysqli_query( $cvtconnection, $qryDel);
			if(!$rsltDel) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 04);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if($debug)
					print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> affected.<br />");
			}

			$qryUp = "UPDATE routedrawaccounting
						SET clientlocid = $val_DELCO,
						archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
						WHERE specificrouteid = $srId
						AND clientlocid = $ASLocationID";

			// FOR SPLITTING OF TABLES
			$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

			if($debug)
				print("<b>" . $qryUp . "</b><br />\n");
			$rsltUp = mysqli_query( $cvtconnection, $qryUp);
			if(!$rsltUp) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if($debug)
					print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"])  . "</b> affected.<br />");
			}

			//NOW CREATE SPECIFICROUTELOC RECS FROM STANDARDROUTES
			$qryGetSR = "SELECT DISTINCT(sr.locationid) locId, sr.subrouteid subRouteId,
						TIME_FORMAT(sr.relativetime, '%H:%i:%s') relTime, sr.comment
						FROM standardroutes sr
						WHERE sr.routeid = $routeId
						AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00' OR sr.endeffdt > '$dbEffDt' )
						ORDER BY reltime";
			if($debug)
				print($qryGetSR . "<br />\n");
			$rsltGetSR = mysqli_query( $cvtconnection, $qryGetSR);

			if(!$rsltGetSR) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				while($rowGetSR = mysqli_fetch_assoc($rsltGetSR)) {

					$locId = $rowGetSR[locId];
					$subRouteId = $rowGetSR[subRouteId];
					$relTime = $rowGetSR[relTime];
					$comment = $rowGetSR[comment];

					ValidateForInt(false, "locId", "subRouteId");

					// CHECK WHETHER THERE ALREADY EXIST ONE RECOR OR NOT AND IF EXIST
					$qryChkRecs = "SELECT recid FROM specificrouteloc
									WHERE specificrouteid = $srId
									AND locationid = $locId
									AND clientlocid = $ASLocationID";

					// FOR SPLITTING OF TABLES
					$qryChkRecs = convertToSplitTables($qryChkRecs, $val_SPLIT);

					if($debug)
						print($qryChkRecs . "<br />\n");
					$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
					if(!$rsltChkRecs) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
							$srlId = $rowChkRecs[recid];
							if(!is_numeric($srlId)) $srlId = 0;
						}
						else {
							$srlId = 0;
						}
					}

					if($srlId == 0) {
						$qryIns = "INSERT INTO specificrouteloc(specificrouteid, locationid, subrouteid, relativetime, comment, sentflag, clientlocid)
									VALUES($srId, $locId, $subRouteId,  '$relTime', '" . addslashes($comment) . "',  'N', $ASLocationID)";

						// FOR SPLITTING OF TABLES
						$qryIns = convertToSplitTables($qryIns, $val_SPLIT);

						if($debug)
							print("<b>" . $qryIns . "</b><br />\n");
						$rsltIns = mysqli_query( $cvtconnection, $qryIns);
						if(!$rsltIns) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 02);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " .
							$strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							$srLocId = getLastInsertId();
							if($val_HWKPR == "Y") {
								// HERE WE NEED TO CONSIDER THE HAWKERROUTELOCLINK

								// FIRST LETS GET THE ROUTEID VALUE
								$selectStr = "routeid routeId";
								$fromStr = "specificroutes";
								$whereStr = "recid = $srId";
								$fileLineNbr = __LINE__;
								$rsltArray = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
								unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

								if($rsltArray) {
									$routeId = $rsltArray[routeId];
									if(!is_numeric($routeId)) $routeId = 0;
								}
								else {
									$routeId = 0;
								}
								unset($rsltArray);

								// LETS CHECK FOR EXISTANCE OF HAWKERROUTELOCSETUP
								$qryGetLocSetUp = "SELECT hls.recid lsRecId,
													hls.standardrouteid hlsSrId,
													hls.hawkernbr hlsHwkNbr,
													hls.personid hlsPersId,
													hls.role hlsRole,
													hls.supervisorid hlsSupervisorId,
													hls.shift hlsShift,
													hls.schedstart hlsSchedStart,
													hls.schedend hlsSchedEnd
													FROM hawkerroutelocsetup hls, standardroutes sr
													WHERE sr.routeid = $routeId
													AND sr.locationid = $locId
													AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00'
													OR sr.endeffdt > '$curDate' )
													AND sr.recid = hls.standardrouteid";
								if($debug)
									print($qryGetLocSetUp . "<br />\n");
								$rsltGetLocSetUp = mysqli_query( $cvtconnection, $qryGetLocSetUp);

								if(!$rsltGetLocSetUp) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}
								else {
									if(mysqli_num_rows($rsltGetLocSetUp) == 0) {
									}
									else {
										while($rowGetLocSetUp = mysqli_fetch_assoc($rsltGetLocSetUp)) {
											$hlsRecId = $rowGetLocSetUp[hlsRecId];
											$hlsSrId = $rowGetLocSetUp[hlsSrId];
											$hlsHwkNbr = $rowGetLocSetUp[hlsHwkNbr];
											$hlsPersId = $rowGetLocSetUp[hlsPersId];
											$hlsRole = $rowGetLocSetUp[hlsRole];
											$hlsSupervisorId = $rowGetLocSetUp[hlsSupervisorId];
											$hlsShift = $rowGetLocSetUp[hlsShift];
											$hlsSchedStart = $rowGetLocSetUp[hlsSchedStart];
											$hlsSchedEnd = $rowGetLocSetUp[hlsSchedEnd];

											ValidateForInt(false, "hlsRecId", "hlsSrId", "hlsPersId", "hlsSupervisorId");

											// CHECK WHETHERE THERE ALREADY EXISTS HAWKERROUTELOCLINK RECORDS FOR THE SPECIFICROUTELOC
											if(!is_numeric($srLocId)) $srLocId = 0;

											$qryChkRecs = "SELECT
															COUNT(recid) hrlCnt
															FROM hawkerrouteloclink
															WHERE specificroutelocid = $srLocId
															AND hawkernbr = '$hlsHwkNbr'
															AND personid = $hlsPersId
															AND supervisorid = $hlsSupervisorId";
											if($debug)
												print($qryChkRecs . "<br />\n");
											$rsltChkRecs = mysqli_query( $cvtconnection, $qryChkRecs);
											$flagExist = false;

											if(!$rsltChkRecs) {
												$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
												print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
												unset($fileLineNbr);
											}
											else {
												$rowChkRecs = mysqli_fetch_assoc($rsltChkRecs);
												$hrlCnt = $rowChkRecs[hrlCnt];
											}

											if($hrlCnt == 0) {
												// HERE WE WILL CREATE NEW HAWKERROUTELOCLINK RECORDS
												$qryIns = "INSERT INTO hawkerrouteloclink
															(specificroutelocid, hawkernbr,
															personid, role, supervisorid,
															shift, schedstart, schedend )
															VALUES
															($srLocId, '$hlsHwkNbr', $hlsPersId, '$hlsRole', $hlsSupervisorId, '$hlsShift', '$hlsSchedStart', '$hlsSchedEnd')";
												if($debug)
													print("<b>" . $qryIns . "</b><br />\n");
												$rsltIns = mysqli_query( $cvtconnection, $qryIns);
												if(!$rsltIns) {
													$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 02);
													print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
													unset($fileLineNbr);
												}
											}
										}
									}
								}
							}
						}
					}
					else {
						$qryUp = "UPDATE specificrouteloc
								SET sentflag = 'N',
								archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
								WHERE recid = $srlId
								AND clientlocid = $ASLocationID";

						// FOR SPLITTING OF TABLES
						$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

						if($debug)

							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
						}
					}
				}
			}

			// SET APPROPRIATE ENTRIES IN ROUTEDRAWACCOUNTING IF DELIVERY ROUTE
			SetRouteDraw_TRA37($srId, $routeType);
			SetRouteDrawSP_TRA37($srId, $routeType);
		}

		// FOR COPYING RECORDS
		$command = "perl ../rd/tra50.pl " . $ASCompanyID . "";
		exec($command);
		if($debug) print("<b>$command</b><br />\n");

		if($debug) {
			print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
		}
		else {
			header("Location: " . urldecode($Back));
		}
		break;

	case "DelSpecificRoute":

		ValidateForInt(false, "srid");

		// DELETING ROTUEDRAWACCOUNTING RECORD
		$qryUp = "UPDATE routedrawaccounting
					SET clientlocid = $val_DELCO,
					archupdt = if(archupdt IN ('X', 'P'), 'U', archupdt)
					WHERE clientlocid = $ASLocationID
					AND specificrouteid = $srid";

		// FOR SPLITTING OF TABLES
		$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
		}

		if($val_HWKPR == "Y") {
			$qryDel = "DELETE FROM hawkerrouteloclink
						USING hawkerrouteloclink, specificrouteloc
						WHERE specificrouteloc.clientlocid = $ASLocationID
						AND specificrouteloc.specificrouteid = $srid
						AND specificrouteloc.recid = hawkerrouteloclink.specificroutelocid";

			// FOR SPLITTING OF TABLES
			$qryDel = convertToSplitTables($qryDel, $val_SPLIT);

			if($debug)
				print("<b>" . $qryDel . "</b><br />\n");
			$rsltDel = mysqli_query( $cvtconnection, $qryDel);
			if(!$rsltDel) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 04);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
		}

		// DELETING SPECIFICROUTELOC RECORDS.
		$qryUp = "UPDATE specificrouteloc
					SET clientlocid = $val_DELCO,
					archupdt = if(archupdt IN ('X', 'P'), 'U', archupdt)
					WHERE clientlocid = $ASLocationID
					AND specificrouteid = $srid";

		// FOR SPLITTING OF TABLES
		$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
		}

		// DELETING SPECIFICROUTE RECORD
		$qryUp = "UPDATE specificroutes
					SET dispatchlocid = $val_DELCO,
					archupdt = if(archupdt IN ('X', 'P'), 'U', archupdt)
					WHERE dispatchlocid = $ASLocationID
					AND recid = $srid";

		// FOR SPLITTING OF TABLES
		$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
		}

		// FOR COPYING RECORDS
		$command = "perl ../rd/tra50.pl " . $ASCompanyID . "";
		exec($command);
		if($debug) print("<b>$command</b><br />\n");

		if($debug) {
			print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
		}
		else {
			header("Location: " . urldecode($Back));
		}
		break;

	case "PreBundleSlip":

		// VALIDATION
		ValidateForInt(false, "pdid", "region");

		// $phpSep = chr(129) . chr(177) . chr(254);

		$incFromStr = "";
		$incWhereStr = "";
		if($incLoc == "region") {
			$incFromStr = ", vendingsubgroup vsg ";
			$incWhereStr = " AND vsg.vendinggroupid = $region
							 AND vsg.routeid = sr.routeid ";
		}

		if($debug) {
			print("noRecs = $norecords<br />\n");
			print("<pre style=\"text-align : left\">");

			print_r($sp_array);
			print("</pre>\n");
		}

		print("<div class=\"datawhite\">\n");

		print("<div align=\"left\">\n");
		print("<form name=\"frmViewMode\" method=\"Post\" action=\"tra37.php\">\n");
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
		print("<input type=\"hidden\" name=\"incLoc\" value=\"$incLoc\" />\n");
		if($incLoc == "region") {
			print("<input type=\"hidden\" name=\"region\" value=\"$region\" />\n");
		}
		foreach($sp_array as $cnt => $spId) {
			print("<input type=\"hidden\" name=\"sp_array[$cnt]\" value=\"$spId\" />\n");
		}

		// NOW DISPLAYING SELECTION FOR ROUTES
		if(!isset($rdSelect) || $rdSelect == "")
			$rdSelect = "A";

		print("<b>Select : </b>");
		print("&nbsp;&nbsp;&nbsp;");

		print("<label for=\"rdSelectA\">All</label>\n");
		print("<input id=\"rdSelectA\" type=\"radio\" name=\"rdSelect\" value=\"A\" onclick=\"this.form.submit();\"");
		if($rdSelect == "A")
			print(" checked=\"checked\"");
		print(" />\n");
		print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\n");

		print("<label for=\"rdSelectR\">Routes</label>");
		print("<input id=\"rdSelectR\" type=\"radio\" name=\"rdSelect\" value=\"R\" onclick=\"this.form.submit();\"");
		if($rdSelect == "R")
			print(" checked=\"checked\"");
		print(" />\n");

		if($rdSelect == "R") {
			print("<br /><br />\n");
			print("<b>Routes : </b>\n");
			print("&nbsp;&nbsp;&nbsp;\n");
			print("<a href=\"javascript:openpopup1('" . htmlspecialchars("../rd/trb11.php?PageNbr=$PassedPageNbr&doAction=ToSelRoute&pdId=$pdid", ENT_QUOTES) . "');\">Select Routes</a>\n");
		}
		print("<br /><br />\n");

		if($rdSelect == "A" && isset($_SESSION[TRA37ROUTEIDSTR])) {
			unset($_SESSION[TRA37ROUTEIDSTR]);
		}

		$routeIdStr = "0";
		if($rdSelect == "R" && isset($_SESSION[TRA37ROUTEIDSTR])) {

			if(!isset($_SESSION[TRA37ROUTEIDSTR]) || $_SESSION[TRA37ROUTEIDSTR] == "") {
				$routeIdStr = "0";
			}
			else {
				$routeIdStr = str_replace($phpSep, ",", $_SESSION[TRA37ROUTEIDSTR]);
			}

			if($routeIdStr != "") {

				// QUERY TO GET ROUTENBR
				$qryGetNbr = "SELECT routenbr
								FROM route
								WHERE recid IN ($routeIdStr)";
				if($debug)
					print($qryGetNbr . "<br />\n");
				$rsltGetNbr = mysqli_query( $cvtconnection, $qryGetNbr);
				if(!$rsltGetNbr) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetNbr) == 0) {
					}
					else {
						$routeNbrStr = "";
						while($rowGetNbr = mysqli_fetch_assoc($rsltGetNbr)) {
							if($routeNbrStr != "")
								$routeNbrStr .= " - " ;
							$routeNbrStr .= $rowGetNbr[routenbr];
						}
					}
				}

				print("<b>Selected Routes : </b>");
				print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");
				print("" . htmlentities($routeNbrStr, ENT_QUOTES) . "");
				print("<br /><br />\n");
			}
		}

		print("</form>\n");
		print("</div>\n");

		//GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m/%d/%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$effdt = "";
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		//FIND THE VARIOUS ROUTES
		$qryGetR = "SELECT DISTINCT(sr.recid),
					r.routenbr routeinfo,
					sr.driverid
					FROM productdispatch pd, routesetdetail rsd, route r, specificroutes sr " . $incFromStr . "
					WHERE pd.recid = $pdid
					AND rsd.routesetid = pd.routesetid
					AND r.recid = rsd.routeid
					AND r.locationid = $ASLocationID
					" . ($rdSelect == "R" ? " AND r.recid IN ($routeIdStr)" : "") . "
					AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
					OR r.endeffdt > '$curDate' )
					AND ( rsd.endeffdt IS NULL OR rsd.endeffdt = '0000-00-00'
							OR rsd.endeffdt > '$curDate' )
					AND sr.routeid = r.recid
					AND sr.datesked = '$dbEffDt'
					AND sr.dispatchlocid = $ASLocationID " . $incWhereStr . "
					ORDER BY r.sortseqnbr, routeinfo";

		// FOR SPLITTING OF TABLES
		$qryGetR = convertToSplitTables($qryGetR, $val_SPLIT);

		if($debug)
			print($qryGetR . "<br />\n");
		$rsltGetR = mysqli_query( $cvtconnection, $qryGetR);

		if(!$rsltGetR) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetR) == 0) {
				print("<b>No Routes Found</b><br /><br />\n");
				print("<a href=\"" . urldecode(htmlentities($Back, ENT_QUOTES)) . "\">Back</a><br />\n");
			}
			else {
				//print("<br clear=all style=\"page-break-after:always\">\n");

				$fileLineNbr = __LINE__; $compName = GetComp($ASCompanyID, $cvtconnection);

				$selectStr = "a.phone";
				$fromStr = "location l, address a";
				$whereStr = "l.recid = $ASLocationID
							AND a.recid = l.addressid";
				$fileLineNbr = __LINE__; $rsltArray = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
				unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

				if($rsltArray) {
					$phone = $rsltArray[phone];
				}
				else {
					$phone = "";
				}
				unset($rsltArray);

				//NOW WE HAVE SPIDS IN THE FORM OF SP_ARRAY
				//FETCH THEM AND PRINT A REPORT FOR ALL OF THEM
				$noRecordFlag = true;
				while($rowGetR = mysqli_fetch_assoc($rsltGetR)) {
					// FOR SRID
					$srid = $rowGetR[recid];
					$driverid = $rowGetR[driverid];
					$routeinfo = $rowGetR[routeinfo];
					ValidateForInt(false, "srid", "driverid");

					if($driverid != 0) {
						$drivername = GetPer($driverid, $cvtconnection);
					}

					reset($sp_array);
					$spIdStr = implode(", ", $sp_array);
					if($spIdStr == "") {
						$spIdStr = "0";
					}

					$qryGetLocInfo = "SELECT  l.recid locId, CONCAT_WS(' - ', NULLIF(c.name, ''),
										NULLIF(l.sdesc, '')) locDesc, l.storenbr,
										CONCAT_WS(' - ', NULLIF(a.address1, ''), NULLIF(a.address2, ''), NULLIF(a.address3, ''), NULLIF(a.address4, '')) addressInfo, rl.specialinstr spInstr
										FROM locationlink ll, company c,
										specificrouteloc srl, routelink rl, transactivity ta, location l
										LEFT JOIN address a ON a.recid = l.addressid
										WHERE ta.locationid = $ASLocationID
										AND ta.type = 'SD'
										AND ta.specificproductid IN ($spIdStr)
										AND ta.customerlocid = srl.locationid
										AND srl.clientlocid = $ASLocationID
										AND srl.specificrouteid = $srid
										AND rl.locationid = srl.locationid
										AND rl.clientid = $ASCompanyID
										AND ( rl.endeffdt IS NULL OR rl.endeffdt = '0000-00-00' OR rl.endeffdt > '$curDate' )
										AND rl.prebundle = 'Y'
										AND l.recid = rl.locationid
										AND ll.locationid = l.recid
										AND ( ll.endeffdt IS NULL OR ll.endeffdt = '0000-00-00' OR ll.endeffdt > '$curDate' )
										AND c.recid = ll.companyid
										GROUP BY l.recid
										ORDER BY  srl.relativetime";

					// FOR SPLITTING OF TABLES
					$qryGetLocInfo = convertToSplitTables($qryGetLocInfo, $val_SPLIT);

					if($debug)
						print($qryGetLocInfo . "<br />\n");
					$rsltGetLocInfo = mysqli_query( $cvtconnection, $qryGetLocInfo);
					if(!$rsltGetLocInfo) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if(mysqli_num_rows($rsltGetLocInfo) != 0) {
							print("<div class=\"datawhite\">\n");

							while($rowGetLocInfo = mysqli_fetch_assoc($rsltGetLocInfo)) {
								$locId = $rowGetLocInfo[locId];
								if(!is_numeric($locId)) $locId = 0;

								$locDesc = $rowGetLocInfo[locDesc];
								$storeNbr = $rowGetLocInfo[storenbr];
								$addressInfo = $rowGetLocInfo[addressInfo];
								$spInstr = $rowGetLocInfo[spInstr];

								print("<div align=\"left\" style=\"font-size: 14pt\" >\n");
								print("<b>Route :</b> " . htmlentities($routeinfo , ENT_QUOTES) . "");
								print("</div>\n");
								print("<br /><br />\n");

								print("<div align=\"center\" style=\"font-size: 22pt\" >\n");
								print("<b>" . htmlentities($locDesc, ENT_QUOTES) . "</b>");

								print("</div>\n");
								print("<br /><br />\n");

								print("<div align=\"left\" style=\"font-size: 14pt\" >\n");
								print("<b> $compName</b>");
								if($phone != "") {
									print("<br />$phone");
								}
								print("</div>\n");
								print("<br /><br />\n");

								print("<div align=\"left\">");
								print("<table>\n");
								print("<tr class=\"datawhite\">\n");
								print("<td><b>Address</b></td>");
								print("<td width=\"8\"></td>\n");
								print("<td>" . htmlentities($addressInfo, ENT_QUOTES) . "</td>\n");
								print("</tr>\n");

								print("<tr class=\"datawhite\">\n");
								print("<td><b>ID Number</b></td>\n");
								print("<td width=\"8\"></td>\n");
								print("<td>" . htmlentities($storeNbr, ENT_QUOTES) . "</td>\n");
								print("</tr>\n");

								print("<tr class=\"datawhite\">\n");
								print("<td><b>Date</b></td>");
								print("<td width=\"8\"></td>");
								print("<td>$effdt</td>\n");
								print("</tr>\n");

								print("<tr class=\"datawhite\">\n");
								print("<td><b>Driver</b></td>");
								print("<td width=\"8\"></td>");
								print("<td>" . htmlentities($drivername, ENT_QUOTES) . "</td>\n");
								print("</tr>\n");

								if($val_DSINS == "Y" && $spInstr != "") {
									print("<tr class=\"datawhite\">\n");
									print("<td><b>Delivery Instructions : </b></td>\n");
									print("<td width=\"8\"></td>");
									print("<td>" . htmlentities($spInstr, ENT_QUOTES) .  "</td>\n");
									print("</tr>\n");
								}

								print("</table>\n");
								print("</div>\n");
								print("<br /><br />\n");

								print("<div align=\"left\" style=\"font-size: 14pt\">");
								print("<b>Deliveries :</b>\n");
								print("</div>\n");
								print("<br /><br />\n");

								$qryGetRouteQty = "SELECT ta.specificproductid spid,
													ta.customerlocid custLocId,
													SUM(ta.actquantity) qty,
													p.ldesc prod_desc, DATE_FORMAT(sp.datex, '%m/%d/%y') spDateX,
													DATE_FORMAT(sp.datex, '%a') spDay,
													sp.bundlecount
													FROM transactivity ta, specificproduct sp, product p
													WHERE ta.locationid = $ASLocationID
													AND ta.type = 'SD'
													AND ta.specificproductid IN ($spIdStr)
													AND ta.datet = '$dbEffDt'
													AND ta.customerlocid = $locId
													AND sp.recid = ta.specificproductid
													AND p.recid = sp.productid
													GROUP BY ta.specificproductid
													HAVING qty > 0
													ORDER BY prod_desc";

								// FOR SPLITTING OF TABLES
								$qryGetRouteQty = convertToSplitTables($qryGetRouteQty, $val_SPLIT);

								if($debug)
									print($qryGetRouteQty . "<br />\n");
								$rsltGetRouteQty = mysqli_query( $cvtconnection, $qryGetRouteQty);
								if(!$rsltGetRouteQty) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}
								else {
									if(mysqli_num_rows($rsltGetRouteQty) != 0) {

										$noRecordFlag = false;
										print("<table style=\"page-break-after:always\" border=\"0\" cellpadding=\"0\" cellspacing=\"2\" width=\"100%\">");
										print("<tr class=\"datawhite\" style=\"font-size: 12pt\">\n");
										print("<td><b>Publication </b></td>\n");
										print("<td align=\"center\"><b>Date</b></td>\n");
										print("<td align=\"center\"><b>Day</b></td>\n");
										print("<td align=\"right\"><b>Bundles</b></td>\n");
										print("<td align=\"right\"><b>Loose</b></td>\n");
										print("<td align=\"right\"><b>Quantity</b></td>\n");
										print("</tr>\n");

										$oddEven = 0;
										while($rowGetRouteQty = mysqli_fetch_assoc($rsltGetRouteQty)) {
											$spId = $rowGetRouteQty[spid];
											if(!is_numeric($spId))	$spId = 0;

											print("<tr class=\"datawhite\">\n");

											// FOR PRODCUT DESCRIPTION
											$prodDesc = $rowGetRouteQty[prod_desc];
											print("<td>" . ($prodDesc != "" ? htmlentities($prodDesc, ENT_QUOTES) : "&nbsp;") . "</td>");

											// FOR DATEX
											$spDateX = $rowGetRouteQty[spDateX];
											print("<td align=\"center\">" . ($spDateX != "" ? $spDateX : "&nbsp;") . "</td>");

											// FOR DAY
											$spDay = $rowGetRouteQty[spDay];
											print("<td align=\"center\">" . ($spDay != "" ? $spDay : "&nbsp;") . "</td>");

											// FOR QUANTITY
											$qty = $rowGetRouteQty[qty];
											if(!is_numeric($qty))	$qty = 0;

											// FOR BUNDLES
											$bundle_cnt = $rowGetRouteQty[bundlecount];
											if($bundle_cnt == 0) {
												$b_qty = "";
											}
											else {
												$b_qty = (int)( $qty / $bundle_cnt );
											}
											print("<td align=\"right\">" . ($b_qty != "" ? $b_qty : "&nbsp;") . "</td>\n");

											// FOR LOOSE
											if($bundle_cnt == 0) {
												$lost = "";
											}
											else {
												$lost = ( $qty % $bundle_cnt );
											}
											print("<td align=\"right\">" . ($lost != "" ? $lost : "&nbsp;") . "</td>\n");

											// FOR QUANTITY
											print("<td align=\"right\">" . ($qty != "" ? $qty : "&nbsp;") . "</td>\n");

											print("</tr>\n");
										}

										print("</table>\n");
									}
								}
								//print("<br clear=all style=\"page-break-after:always\">\n");
							}

							print("</div>\n");
						}
					}
				}

				if($noRecordFlag) {
					print("<b>No Records Found</b><br /><br />\n");
					print("<a href=\"" . urldecode(htmlentities($Back, ENT_QUOTES)) . "\">Back</a><br />\n");
				}
			}
		}
		print("</div>\n");
		break;

	case "ShowCalculatedDraw":
		
		//$debug = 1;
		ValidateForInt(false, "pdid", "spId", "regionId");

		print("<div class=\"datawhite\">");
		if($debug)
			print("pdid = $pdid, incLoc = $incLoc, spId = $spId, regionId = $regionId<br />\n");

		// FINDING THE PRODUCTDISPATCH DETAILS
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "rundate dbRunDate", "routesetid routeSetId");
		if($rsltArr[rtvalue]) {
			$dbRunDate = $rsltArr[dbRunDate];
			$routeSetId = $rsltArr[routeSetId];
			if(!is_numeric($routeSetId))	$routeSetId = 0;
		}
		else {
			$dbRunDate = "";
			$routeSetId = "";
		}
		unset($rsltArr, $fileLineNbr);

		// FINDING SPECIFICPRODUCT DETAILS
		$selectStr = "p.recid prodId, p.ldesc prodDesc, DATE_FORMAT(datex, '%Y-%m-%d') dbDateX";
		$fromStr = "product p, specificproduct sp";
		$whereStr = "p.recid = sp.productid
					AND p.clientid = $ASCompanyID
					AND sp.recid = $spId";
		$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
		unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

		if($rsltArr) {
			$prodId = $rsltArr[prodId];
			$prodDesc = $rsltArr[prodDesc];
			$dbDateX = $rsltArr[dbDateX];
		}
		else {
			$prodId = 0;
			$prodDesc = "";
			$dbDateX = "";
		}
		unset($rsltArr);

		print("<div align=\"center\">");
		print("<u><b>" . "Run Date - " . get_date($dbRunDate, 'MM/DD/YY')  . " / " . $prodDesc . " - " . get_date($dbDateX, "MM/DD/YY") . "</b></u><br />");
		print("</div><br /><br />");

		/*
		SELECT DISTINCT(SR.RECID) SRID FROM SPECIFICROUTES SR, ROUTESETDETAIL RSD, PRODUCTDISPATCH PD , VENDINGSUBGROUP VSG WHERE PD.RECID = 4030 AND RSD.ROUTESETID = PD.ROUTESETID AND SR.ROUTEID = RSD.ROUTEID AND SR.DATESKED = PD.RUNDATE AND SR.DISPATCHLOCID = 22766 AND VSG.VENDINGGROUPID = 38 AND VSG.ROUTEID = SR.ROUTEID
		*/

		// FINDING THE REGION LOCATIONS
		if($incLoc == "region" && $regionId != 0) {
			// NOW LETS GET THE LOCATIONS CORRESPONDING TO THE selected=\"selected\" REGION
			$qryGetLoc = "SELECT DISTINCT l.recid locId
							FROM location l, vendingsubgroup vsg, vendinggroup vg,
							routesetdetail rsd, standardroutes sr, route r
							WHERE vg.clientlocid = $ASLocationID
							AND vg.recid = $regionId
							AND vsg.vendinggroupid = vg.recid
							AND l.subgroupid = vsg.recid
							AND ( l.endeffdate IS NULL OR l.endeffdate = '0000-00-00'
							OR l.endeffdate > '$curDate' )
							AND rsd.routesetid = $routeSetId
							AND r.recid = rsd.routeid
							AND sr.routeid = r.recid
							AND sr.normalroute = 'Y'
							AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00' OR sr.endeffdt > '$curDate' )
							AND ( rsd.endeffdt IS NULL OR rsd.endeffdt = '0000-00-00'
							OR rsd.endeffdt > '$curDate' )
							AND l.recid = sr.locationid
							AND l.type != 'G'";
			if($debug)
				print($qryGetLoc . "<br />\n");
			$rsltGetLoc = mysqli_query( $cvtconnection, $qryGetLoc);

			if(!$rsltGetLoc) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if(mysqli_num_rows($rsltGetLoc) == 0) {
					$tempLocIdStr = "";
				}
				else {
					$tempLocIdStr = "";
					while($rowGetLoc = mysqli_fetch_assoc($rsltGetLoc)) {
						$locId = $rowGetLoc[locId];
						if(!is_numeric($locId)) $locId = 0;
						if($tempLocIdStr == "") {
							$tempLocIdStr = $locId;
						}
						else {
							$tempLocIdStr .= ", " . $locId;
						}
					}
				}
			}
		}

		if($tempLocIdStr == "")
			$tempLocIdStr = "0";
		/*Task#8550 Start*/
		$selTable = '';
		$selWhere = '';
		
		if($char_NJPEN == 'Y'){
			 $selTable = " LEFT JOIN specificroutes sr ON sr.recid = ta.specificrouteid AND sr.dispatchlocid = $ASLocationID LEFT JOIN route r ON sr.routeid = r.recid  ";
			 $selWhere = " ,r.routenbr routeNbr";
		}
		
		// FETCHING INFORMATION OF Location WITH TransActivity Quantity
		$qryGetInfo = "SELECT /*TRA37*/ DISTINCT(l.recid) locId, l.type locType,
						CONCAT_WS(' - ', NULLIF(c.name, ''), NULLIF(l.storenbr, ''), NULLIF(l.sdesc, ''), NULLIF(a.address1, '')) locDesc,
						/*SUM(ta.actquantity) actQty*/
					  	ta.actquantity actQty,
						ta.specificrouteid  $selWhere
						FROM transactivity ta $selTable
						,locationlink ll, company c, location l
						LEFT JOIN address a ON a.recid = l.addressid
						WHERE ta.locationid = $ASLocationID
						AND ta.specificproductid = $spId
						AND ta.type IN('SD','DE')
						AND ta.datet = '$dbRunDate'
						AND l.recid = ta.customerlocid
						AND ll.locationid = l.recid
						AND c.recid = ll.companyid";
						
		if($incLoc == "region") {
			$qryGetInfo .= " AND l.recid IN ($tempLocIdStr)";
		}
		$qryGetInfo .= " GROUP BY l.recid
						ORDER BY locType, locDesc";
		
		/*Task#8550 End*/
		// FOR SPLITTING OF TABLES
		$qryGetInfo = convertToSplitTables($qryGetInfo, $val_SPLIT);

		if($debug)
			print($qryGetInfo . "<br />\n");
		$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
		if(!$rsltGetInfo) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetInfo) == 0) {
			}
			else {

				print("<table border=\"1\" width=\"100%\">\n");
				print("<tr class=\"datatblhdr\">\n");
				if($debug) print("<td>locId</td>\n");
				print("<td>Location</td>\n");
				print("<td align=\"right\">Quantity</td>\n");
				/*Task#8550 Start*/
				if($char_NJPEN == 'Y'){
					
					$qryGetDemoDesc = "SELECT /*TRA37*/ d.sdesc sdesc
								FROM  demographic d
								WHERE d.recid = $int_NJPEN";

					
						
		
						if($debug)
							print("<b>" . $qryGetDemoDesc . "</b><br />\n");
						$rsltGetDemoDesc = mysqli_query( $cvtconnection, $qryGetDemoDesc);
						if(!$rsltGetDemoDesc) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}else{
						
								$rowGetDemoDesc = mysqli_fetch_assoc($rsltGetDemoDesc);
								$DemoValDesc = $rowGetDemoDesc['sdesc'];
								
						}
					print("<td align=\"right\">$DemoValDesc</td>\n");
					print("<td align=\"right\">Billing Method</td>\n");
					print("<td align=\"right\">Delivery Route</td>\n");
					
				}
				/*Task#8550 End*/
				print("</tr>\n");

				$totalQty = 0;
				$oddEven = 0;
				$totQtyType = 0;
				$prevType = "";
				$flagFirst = true;
				while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
					$locType = $rowGetInfo[locType];
					if($locType != $prevType && !$flagFirst ) {
						switch($prevType) {
							case "M":
								$dispType = $arrLocType['M'] . " Subtotal";
								break;

							case "R":
								$dispType = $arrLocType['R'] . " SubTotal";
								break;

							case "D";
							default:
								$dispType = $arrLocType['D'] . " SubTotal";
								break;
						}

						print("<tr class=\"datawhite\">\n");

						// FOR LOCID
						if($debug)  print("<td>&nbsp;</td>\n");

						// FOR LOCATION DESCRIPTION
						print("<td><b>" . ($dispType != "" ? htmlentities($dispType, ENT_QUOTES) : "&nbsp;") . "</b></td>\n");

						// FOR QUANTITY
						print("<td align=\"right\"><b>" . ($totQtyType != "" ? $totQtyType : "&nbsp;") . "</b></td>\n");
						
						
						
						
						print("</tr>\n");
						$totQtyType = 0;
					}
					$prevType = $locType;
					$flagFirst = false;
					$locId = $rowGetInfo[locId];
					$locDesc = $rowGetInfo[locDesc];
					$actQty = $rowGetInfo[actQty];
					ValidateForInt(false, "locId", "actQty");
					$totalQty += $actQty;
					$totQtyType += $actQty;

					if( ( $oddEven++ % 2 ) == 0 ) {
						print("<tr class=\"datawhite\">\n");
					}
					else {
						print("<tr class=\"datagrey\">\n");
					}

						// FOR LOCID
						if($debug)  print("<td>$locId</td>\n");


						// FOR LOCATION DESCRIPTION
						print("<td>" . ($locDesc != "" ? htmlentities($locDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");

						// FOR QUANTITY
						print("<td align=\"right\">" . ($actQty != "" ? $actQty : "&nbsp;") . "</td>\n");
						
						/*Task#8550 Start*/
						if($char_NJPEN == 'Y'){
							
							// FOR DemoGraphic
							
							$qryGetDemo = "SELECT /*TRA37*/ dv.sdesc sdesc
								FROM  demographicvalue dv , demolocation dl
								WHERE dl.locationid = $locId
								AND dl.demographicid =  $int_NJPEN
								AND dl.demographicvalueid = dv.recid
								AND dl.effdt <= '$dbRunDate'
								ORDER BY dl.effdt DESC LIMIT 1";

					
						
		
						if($debug)
							print("<b>" . $qryGetDemo . "</b><br />\n");
						$rsltGetDemo = mysqli_query( $cvtconnection, $qryGetDemo);
						if(!$rsltGetDemo) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}else{
						
								$rowGetDemo = mysqli_fetch_assoc($rsltGetDemo);
								$DemoVal = $rowGetDemo['sdesc'];
								
						}
							
							print("<td align=\"right\">$DemoVal</td>\n");
							
							
							
							//Billing Method
							$qryGetStd = "SELECT /*TRA37*/ sd.invoicingent
								FROM standarddraw sd , specificproduct sp
								WHERE sd.clientlocid = $ASLocationID
								AND sd.effdt <= sp.datex
								AND sd.customerlocid = $locId
								AND sd.productid = sp.productid
								AND sp.recid = $spId
								ORDER BY sd.effdt DESC LIMIT 1";

						
						
		
						if($debug)
							print("<b>" . $qryGetStd . "</b><br />\n");
						$rsltGetStd = mysqli_query( $cvtconnection, $qryGetStd);
						if(!$rsltGetStd) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}else{
						
								$rowGetStd = mysqli_fetch_assoc($rsltGetStd);
								$InvEnt = $rowGetStd['invoicingent'];
								if($InvEnt == 'D')
									$DispInv = 'Buy/Sell';
								elseif($InvEnt == 'W')
									$DispInv = 'Delivery Fee';
						}
							
							
							print("<td align=\"right\">$DispInv</td>\n");
							
							$routeNbr = $rowGetInfo[routeNbr];
							
							//Delivery Route
							print("<td align=\"right\">$routeNbr</td>\n");
							
						}
						/*Task#8550 End*/

					print("</tr>\n");
				}
				// TYPE TOTAL
				switch($locType) {
					case "M":
						$dispType = $arrLocType['M'] . " Subtotal";
						break;

					case "R":
						$dispType = $arrLocType['R'] . " SubTotal";
						break;

					case "D";
					default:
						$dispType = $arrLocType['D'] . " SubTotal";
						break;
				}
				print("<tr class=\"datawhite\">\n");
				// FOR LOCID
				if($debug)  print("<td>&nbsp;</td>\n");

				// FOR LOCATION DESCRIPTION
				print("<td><b>" . ($dispType != "" ? htmlentities($dispType, ENT_QUOTES) : "&nbsp;") . "</b></td>\n");

				// FOR QUANTITY
				print("<td align=\"right\"><b>" . ($totQtyType != "" ? $totQtyType : "&nbsp;") . "</b></td>\n");
				print("</tr>");

				// GRAND TOTAL
				print("<tr class=\"datawhite\">\n");
				// FOR LocId
				if($debug)  print("<td>&nbsp;</td>\n");

				// FOR LOCATION DESCRIPTION
				print("<td><b>Grand Total</b></td>\n");

				// FOR QUANTITY
				print("<td align=\"right\"><b>" . ($totalQty != "" ? $totalQty : "&nbsp;") . "</b></td>\n");
				print("</tr>\n");

				print("</table><br />\n");

				if($debug)
					print("tota quantity = $totalQty<br />\n");
			}
		}
		print("</div>\n");
		break;

	case "ToMergeRoutes":

		//$phpSep = chr(129) . chr(177) . chr(254);

		print("<div class=\"datawhite\">");

		// FINDING THE PRODUCTDISPATCH DETAILS
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "rundate dbRunDate", "routesetid routeSetId");
		if($rsltArr[rtvalue]) {
			$dbRunDate = $rsltArr[dbRunDate];
		}
		else {
			$dbRunDate = "";
		}
		unset($rsltArr, $fileLineNbr);

		$stdRtArr = GeneralArray("routetype_standard");
		$stdRtStr = MakeStrFromArray($stdRtArr, ", ", "'");
		if($stdRtStr == "") $stdRtStr = "''";
		$stdRtStr .= ", 'RR', 'SS', 'CR', 'PR'";

		if($val_ESRTE == 'Y') {
			$stdRtStr .= ", 'ER'";
		}

		if($val_HAWKS == "Y") {
			$stdRtStr .= ", 'AM', 'PM', 'TR'";
		}

		// DISPLAYING HEADER
		$headerDesc = "Merge Routes - " . get_date($dbRunDate, "MM/DD/YY");
		print("<div align=\"center\">\n");
		print("<u><b>" . $headerDesc . "</b></u><br />\n");
		print("</div>\n");

		/*if($debug) {
			print("<pre style=\"text-align : left\">");
			print_r($_SESSION[TRA37MERGEROUTELOCS]);
			print("</pre>\n");
		}*/

		print("<br /><br />\n");

		print("<form name=\"scopeForm\" method=\"GET\" action=\"tra37.php\">\n");
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");

		// FOR SCOPE
		if(!isset($rdScope) || $rdScope == "")
			$rdScope = "R";

		print("<div align=\"left\">\n");
		print("<b>Scope :</b>");
		print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");

		print("<label for=\"rdScopeR\">Route</label>\n");
		print("<input id=\"rdScopeR\" type=\"radio\" name=\"rdScope\" value=\"R\" onclick=\"this.form.submit();\"");
		if($rdScope == "R") print(" checked=\"checked\"");
		print(" />\n");
		print("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");

		print("<label for=\"rdScopeL\">Location</label>\n");
		print("<input id=\"rdScopeL\" type=\"radio\" name=\"rdScope\" value=\"L\" onclick=\"this.form.submit();\"");
		if($rdScope == "L") print(" checked=\"checked\"");
		print(" />\n");

		print("</div>\n");
		print("</form>\n");

		print("<form name=\"level1Form\" method=\"POST\" action=\"tra37.php\">\n");
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
		print("<input type=\"hidden\" name=\"rdScope\" value=\"$rdScope\" />\n");

		print("<table border=\"1\" width=\"100%\">\n");
		print("<tr class=\"datatblhdr\">\n");
		if($debug)
			print("<td align=\"center\">LocationId</td>\n");
		/*print("<td align=\"center\"><input id=\"\" type=\"checkbox\" name=\"chkAll\" value=\"CheckAll\" onclick=\"checkBoxAll(this.form, this.checked, 'chkLocId')\" /></td>\n");*/
		print("<td>&nbsp;</td>\n");
		if($rdScope == "L") {
			print("<td>Customer</td>\n");
		}
		print("<td>Route 1</td>\n");
		print("<td>Route 2</td>\n");
		print("</tr>\n");

		$tempCntId = 0;
		switch($rdScope) {
			case "L":
				for($cntId = 0; $cntId < count($_SESSION[TRA37MERGEROUTELOCS]); $cntId++) {

					$locId = $_SESSION[TRA37MERGEROUTELOCS][$cntId];
					if(!is_numeric($locId))	$locId = 0;

					// NOW FINDING DIFFERENT ROUTES
					$qryGetRouteInfo = "SELECT DISTINCT srl.recid srlId, r.recid routeId,
										CONCAT_WS(' - ', NULLIF(r.routenbr, ''), NULLIF(r.sdesc, '')) routeDesc, r.type routeType
										FROM specificrouteloc srl, specificroutes sr, route r
										WHERE srl.clientlocid = $ASLocationID
										AND srl.locationid = $locId
										AND sr.recid = srl.specificrouteid
										AND sr.datesked = '$dbRunDate'
										AND sr.dispatchlocid = $ASLocationID
										AND r.recid = sr.routeid
										AND r.locationid = $ASLocationID
										AND r.type IN (" . $stdRtStr . ")
										ORDER BY r.sortseqnbr, routeDesc
										LIMIT 2";

					// FOR SPLITTING OF TABLES
					$qryGetRouteInfo = convertToSplitTables($qryGetRouteInfo, $val_SPLIT);

					if($debug)
						print($qryGetRouteInfo . "<br />\n");
					$rsltGetRouteInfo = mysqli_query( $cvtconnection, $qryGetRouteInfo);
					if(!$rsltGetRouteInfo) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if(mysqli_num_rows($rsltGetRouteInfo) != 2) {
							continue;
						}
						else {

							if( ( $tempCntId % 2 ) == 0 ) {
								print("<tr class=\"datawhite\">\n");
							}
							else {
								print("<tr class=\"datagrey\">\n");
							}

							// FOR LOCATIONID
							if($debug) print("<td align=\"center\">" . ($locId != "" ? $locId : "&nbsp;") . "</td>\n");

							// FOR SINGLE CHECKBOX SELECTION FOR EACH LOCATION
							print("<td align=\"center\"><input type=\"checkbox\" name=\"chkLocId[" . $tempCntId . "]\" value=\"" . $locId . "\" onclick=\"checkBoxSingle(this.form, this.checked)\" /></td>\n");

							// FOR CUSTOMER
							$infoArr = array("COMPNAME" => "Y", "IDNBR" => "Y", "LOCDESC" => "Y");
							$fileLineNbr = __LINE__; $locDesc = GetLocDesc_TRA($locId, $infoArr);
							print("<td>" . ($locDesc != "" ? $locDesc : "&nbsp;") . "</td>\n");

							// FOR Route 1
							$rowGetRouteInfo = mysqli_fetch_assoc($rsltGetRouteInfo);
							$routeId1 = $rowGetRouteInfo[routeId];
							$srlId1 = $rowGetRouteInfo[srlId];
							$routeDesc1 = $rowGetRouteInfo[routeDesc];
							print("<td><input id=\"rdSrlLocRoute1_$tempCntId\" type=\"radio\" name=\"rdSrlLocRoute[$tempCntId]\" value=\"$srlId1\" onclick=\"checkOne('chkLocId', '$tempCntId')\" />&nbsp;<label for=\"rdSrlLocRoute1_$tempCntId\">" . ($routeDesc1 != "" ? htmlentities($routeDesc1, ENT_QUOTES) : "&nbsp;") . "</label></td>\n");

							// FOR Route 2
							$rowGetRouteInfo = mysqli_fetch_assoc($rsltGetRouteInfo);
							$routeId2 = $rowGetRouteInfo[routeId];
							$srlId2 = $rowGetRouteInfo[srlId];
							$routeDesc2 = $rowGetRouteInfo[routeDesc];
							print("<td><input id=\"rdSrlLocRoute2_$tempCntId\" type=\"radio\" name=\"rdSrlLocRoute[$tempCntId]\" value=\"$srlId2\" onclick=\"checkOne('chkLocId', '$tempCntId')\" />&nbsp;<label for=\"rdSrlLocRoute2_$tempCntId\">" . ($routeDesc2 != "" ? htmlentities($routeDesc2, ENT_QUOTES) : "&nbsp;") . "</label>\n");

							$srlIdStr = $srlId1 . $phpSep . $srlId2;
							print("<input type=\"hidden\" name=\"hdLocIdArr[$locId]\" value=\"$srlIdStr\" />\n");

							print("</td></tr>\n");

							$tempCntId++;
						}
					}
				}
				break;

			default:

				// NOW CREATING A ARRAY FOR COMBINATION OF ROUTE AND LOCATION
				$routeLocArr = array();
				for($cntId = 0; $cntId < count($_SESSION[TRA37MERGEROUTELOCS]); $cntId++) {

					$locId = $_SESSION[TRA37MERGEROUTELOCS][$cntId];
					if(!is_numeric($locId))	$locId = 0;

					// NOW FINDING DIFFERENT ROUTES
					$qryGetRouteInfo = "SELECT DISTINCT srl.recid srlId, r.recid routeId,
										CONCAT_WS(' - ', NULLIF(r.routenbr, ''), NULLIF(r.sdesc, '')) routeDesc, r.type routeType
										FROM specificrouteloc srl, specificroutes sr, route r
										WHERE srl.clientlocid = $ASLocationID
										AND srl.locationid = $locId
										AND sr.recid = srl.specificrouteid
										AND sr.datesked = '$dbRunDate'
										AND sr.dispatchlocid = $ASLocationID
										AND r.recid = sr.routeid
										AND r.locationid = $ASLocationID
										AND r.type IN (" . $stdRtStr . ")
										ORDER BY r.sortseqnbr, routeDesc
										LIMIT 2";

					// FOR SPLITTING OF TABLES
					$qryGetRouteInfo = convertToSplitTables($qryGetRouteInfo, $val_SPLIT);

					if($debug)
						print($qryGetRouteInfo . "<br />\n");
					$rsltGetRouteInfo = mysqli_query( $cvtconnection, $qryGetRouteInfo);
					if(!$rsltGetRouteInfo) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if(mysqli_num_rows($rsltGetRouteInfo) != 2) {
							continue;
						}
						else {

							// FOR Route 1
							$rowGetRouteInfo = mysqli_fetch_assoc($rsltGetRouteInfo);
							$routeId1 = $rowGetRouteInfo[routeId];
							$srlId1 = $rowGetRouteInfo[srlId];
							$routeDesc1 = $rowGetRouteInfo[routeDesc];

							// FOR Route 2
							$rowGetRouteInfo = mysqli_fetch_assoc($rsltGetRouteInfo);
							$routeId2 = $rowGetRouteInfo[routeId];
							$srlId2 = $rowGetRouteInfo[srlId];
							$routeDesc2 = $rowGetRouteInfo[routeDesc];

							$routeIdStr = $routeId1 . $phpSep . $routeId2;
							if(!isset($routeLocArr[$routeIdStr]))
								$routeLocArr[$routeIdStr] = array();

							array_push($routeLocArr[$routeIdStr], $locId);
						}
					}
				}

				if($debug) {
					print("<pre style=\"text-align : left\">");
					print_r($routeLocArr);
					print("</pre>\n");
				}

				foreach($routeLocArr as $routeIdStr => $locIdArr) {

					$routeIdArr = explode($phpSep, $routeIdStr);
					$routeId1 = $routeIdArr[0];
					$routeId2 = $routeIdArr[1];

					if( ( $tempCntId % 2 ) == 0 ) {
						print("<tr class=\"datawhite\">\n");
					}
					else {
						print("<tr class=\"datagrey\">\n");
					}

					// FOR LOCATIONID
					if($debug) print("<td align=\"center\">" . ($routeIdStr != "" ? $routeIdStr : "&nbsp;") . "</td>\n");

					// FOR SINGLE CHECKBOX SELECTION FOR EACH LOCATION
					print("<td align=\"center\"><input type=\"checkbox\" name=\"chkLocId[" . $tempCntId . "]\" value=\"" . $routeIdStr . "\" onclick=\"checkBoxSingle(this.form, this.checked)\" /></td>\n");

					// FOR ROUTE 1
					$fileLineNbr = __LINE__; $routeDesc1 = GetDescription("route", $routeId1, "CONCAT_WS(' - ', NULLIF(routenbr, ''), NULLIF(sdesc, ''))");
					print("<td><input id=\"rdRoute1_$tempCntId\" type=\"radio\" name=\"rdRoute[$tempCntId]\" value=\"$routeId1\" onclick=\"checkOne('chkLocId', '$tempCntId')\" />&nbsp;<label for=\"rdRoute1_$tempCntId\">" . ($routeDesc1 != "" ? htmlentities($routeDesc1, ENT_QUOTES) : "&nbsp;") . "</label></td>\n");

					// FOR ROUTE 2
					$fileLineNbr = __LINE__; $routeDesc2 = GetDescription("route", $routeId2, "CONCAT_WS(' - ', NULLIF(routenbr, ''), NULLIF(sdesc, ''))");
					print("<td><input id=\"rdRoute2_$tempCntId\" type=\"radio\" name=\"rdRoute[$tempCntId]\" value=\"$routeId2\" onclick=\"checkOne('chkLocId', '$tempCntId')\" />&nbsp;<label for=\"rdRoute2_$tempCntId\">" . ($routeDesc2 != "" ? htmlentities($routeDesc2, ENT_QUOTES) : "&nbsp;") . "</label>\n");

					foreach($locIdArr as $keyCnt => $locId) {
						print("<input type=\"hidden\" name=\"routeLocArr[$routeIdStr][$keyCnt]\" value=\"$locId\" />\n");
					}

					print("</td></tr>\n");

					$tempCntId++;
				}
				break;
		}
		print("</table>\n");


		// HIDDEN VARIABLES
		print("<input type=\"hidden\" name=\"noRecords\" value=\"$tempCntId\" />\n");

		print("<br /><a href=\"javascript:submitMergeRoutes(document.level1Form,'MergeRoutes','chkLocId')\">Merge</a>\n");

		print("</form>\n");
		print("</div>\n");
		break;

	case "MergeRoutes":

		// $phpSep = chr(129) . chr(177) . chr(254);

		// FINDING THE PRODUCTDISPATCH DETAILS
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "rundate dbRunDate", "routesetid routeSetId");
		if($rsltArr[rtvalue]) {
			$dbRunDate = $rsltArr[dbRunDate];
		}
		else {
			$dbRunDate = "";
		}
		unset($rsltArr, $fileLineNbr);

		$stdRtArr = GeneralArray("routetype_standard");
		$stdRtStr = MakeStrFromArray($stdRtArr, ", ", "'");
		if($stdRtStr == "") $stdRtStr = "''";
		$stdRtStr .= ", 'RR', 'SS', 'CR'";

		if($val_ESRTE == 'Y') {
			$stdRtStr .= ", 'ER'";
		}

		if($val_HAWKS == "Y") {
			$stdRtStr .= ", 'AM', 'PM', 'TR'";
		}

		switch($rdScope) {
			case "L":
				if($debug) {
					print("<pre style=\"text-align : left\">");
					print_r($hdLocIdArr);
					print_r($chkLocId);
					print_r($rdSrlLocRoute);
					print("</pre>\n");
				}

				foreach($chkLocId as $cntId => $locId) {

					if($debug)
						print("$cntId - $locId<br />\n");

					$locSrlIdArr = explode($phpSep, $hdLocIdArr[$locId]);
					$srlId1 = $locSrlIdArr[0];
					$srlId2 = $locSrlIdArr[1];
					$selSrlId = $rdSrlLocRoute[$cntId];
					ValidateForInt(false, "srlId1", "srlId2", "selSrlId");

					if($selSrlId == 0) {
						$delSrlId = 0;
					}
					else {
						$delSrlId = ($srlId1 == $selSrlId ? $srlId2 : $srlId1);
						if(!is_numeric($delSrlId))	$delSrlId = 0;
					}

					if($debug)
						print("$srlId1, $srlId2, $selSrlId :: $delSrlId<br />\n");

					if($delSrlId != 0) {

						$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "specificrouteloc", $delSrlId, "specificrouteid srId");
						if($rsltArr[rtvalue]) {
							$srId = $rsltArr[srId];
						}
						else {
							$srId = 0;
						}
						unset($rsltArr, $fileLineNbr);

						if($val_HWKPR == "Y") {
							$qryDel = "DELETE FROM hawkerrouteloclink
										WHERE specificroutelocid = $delSrlId";

							// FOR SPLITTING OF TABLES
							$qryDel = convertToSplitTables($qryDel, $val_SPLIT);

							if($debug)
								print("<b>" . $qryDel . "</b><br />\n");
							$rsltDel = mysqli_query( $cvtconnection, $qryDel);
							if(!$rsltDel) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 04);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 04);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
						}

						// DELETING SPECIFICROUTELOC RECORD
						$qryUp = "UPDATE specificrouteloc
									SET clientlocid = $val_DELCO,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE recid = $delSrlId
									AND clientlocid = $ASLocationID";

						// FOR SPLITTING OF TABLES
						$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
						}

						// UPDATING TRANSACTIVITY RECORD
						$qryUp = "UPDATE transactivity
									SET specificrouteid = NULL,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE locationid = $ASLocationID
									AND customerlocid = $locId
									AND datet = '$dbRunDate'
									AND type IN ('SD', 'SP')
									AND specificrouteid = $srId";

						// FOR SPLITTING OF TABLES
						$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
						}
					}
				}
				break;

			default:

				if($debug) {
					print("<pre style=\"text-align : left\">");
					print_r($routeLocArr);
					print_r($chkLocId);
					print_r($rdRoute);
					print("</pre>\n");
				}

				foreach($chkLocId as $cntId => $routeIdStr) {

					if($debug)
						print("$cntId - $routeIdStr<br />\n");

					$routeIdArr = explode($phpSep, $routeIdStr);
					$routeId1 = $routeIdArr[0];
					$routeId2 = $routeIdArr[1];
					$selRouteId = $rdRoute[$cntId];
					ValidateForInt(false, "routeId1", "routeId2", "selRouteId");

					if($selRouteId == 0) {
						$delRouteId = 0;
					}
					else {
						$delRouteId = ($routeId1 == $selRouteId ? $routeId2 : $routeId1);
						if(!is_numeric($delRouteId))	$delRouteId = 0;
					}

					$locIdStr = implode(", ", $routeLocArr[$routeIdStr]);
					if($locIdStr == "")
						$locIdStr = "0";

					if($delRouteId != 0) {

						// FINDING THE SPECIFICROUTEID
						$selectStr = "sr.recid srId";
						$fromStr = "specificroutes sr";
						$whereStr = "sr.dispatchlocid = $ASLocationID
									AND sr.datesked = '$dbRunDate'
									AND sr.routeid = $delRouteId";
						$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
						unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

						if($rsltArr) {
							$srId = $rsltArr[srId];
							if(!is_numeric($srId))	$srId = 0;
						}
						else {
							$srId = 0;
						}
						unset($rsltArr);

						// LETS DELETE HAWKERROUTELOCLINK RECORDS FOR THE CORRESPONDING SPECIFICROUTELOCRECORDS
						if($val_HWKPR == "Y") {

							// FIND SPECIFICROUTLOCRECORDS
							$qryGetSrlRec = "SELECT DISTINCT srl.recid srlId
											FROM specificrouteloc srl, specificroutes sr, route r
											WHERE srl.clientlocid = $ASLocationID
											AND srl.locationid IN ($locIdStr)
											AND sr.recid = srl.specificrouteid
											AND sr.datesked = '$dbRunDate'
											AND sr.dispatchlocid = $ASLocationID
											AND r.recid = sr.routeid
											AND r.locationid = $ASLocationID
											AND r.type IN (" . $stdRtStr . ")
											AND r.recid = $delRouteId";

							// FOR SPLITTING OF TABLES
							$qryGetSrlRec = convertToSplitTables($qryGetSrlRec, $val_SPLIT);

							if($debug)
								print($qryGetSrlRec . "<br />\n");
							$rsltGetSrlRec = mysqli_query( $cvtconnection, $qryGetSrlRec);

							if(!$rsltGetSrlRec) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if(mysqli_num_rows($rsltGetSrlRec) == 0) {
								}
								else {
									while($rowGetSrlRec = mysqli_fetch_assoc($rsltGetSrlRec)) {
										$srlId = $rowGetSrlRec[srlId];
										if(!is_numeric($srlId)) $srlId = 0;

										// DELETE HAWKERROUTELOCLINK
										$qryDel = "DELETE FROM hawkerrouteloclink
													WHERE specificroutelocid = $srlId";

										// FOR SPLITTING OF TABLES
										$qryDel = convertToSplitTables($qryDel, $val_SPLIT);

										if($debug)
											print("<b>" . $qryDel . "</b><br />\n");
										$rsltDel = mysqli_query( $cvtconnection, $qryDel);
										if(!$rsltDel) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 04);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
									}
								}
							}
						}

						// DELETING SPECIFICROUTELOC RECORDS
						$qryUp = "UPDATE specificrouteloc srl, specificroutes sr, route r
									SET srl.clientlocid = $val_DELCO,
									srl.archupdt = IF(srl.archupdt IN ('X', 'P'), 'U', srl.archupdt)
									WHERE srl.clientlocid = $ASLocationID
									AND srl.locationid IN ($locIdStr)
									AND sr.recid = srl.specificrouteid
									AND sr.datesked = '$dbRunDate'
									AND sr.dispatchlocid = $ASLocationID
									AND r.recid = sr.routeid
									AND r.locationid = $ASLocationID
									AND r.type IN (" . $stdRtStr . ")
									AND r.recid = $delRouteId";

						// FOR SPLITTING OF TABLES
						$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
						}

						// UPDATING TRANSACTIVITY RECORDS
						$qryUp = "UPDATE transactivity
									SET specificrouteid = NULL,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE locationid = $ASLocationID
									AND customerlocid IN ($locIdStr)
									AND datet = '$dbRunDate'
									AND type IN ('SD', 'SP')
									AND specificrouteid = $srId";

						// FOR SPLITTING OF TABLES
						$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />");
						}
					}
				}
				break;
		}

		/*// For copying records
		$command = "perl ../rd/tra50.pl " . $ASCompanyID . "";
		exec($command);
		if($debug) print("<b>$command</b><br />\n");*/

		if($debug) {
			print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
		}
		else {
			header("Location: " . urldecode($Back));
		}
		break;

	case "SetBundleRound":

		if(!is_numeric($spId)) $spId = 0;
		$dbEffDt = makedate($effdt, 'MMDDYY');

		$numBurnd = GetLSVar("BURND", "realvar", $ASLocationID, $cvtconnection);
		if(!is_numeric($numBurnd)) $numBurnd = 0;
		if($debug) print("dbEffDt= $dbEffDt :: spId = $spId :: numBurnd = $numBurnd<br />");

		// Lets first get the locationid and routeid using routedrawaccounting
		$srRecIdArray = array();
		$srRouteIdArray = array();

		$routeTypeStr = "'SR', 'PR'";
		if($val_HAWKS == "Y") {
			$routeTypeStr .= ", 'AM', 'PM', 'TR'";
		}
		$qryGetRouteLoc = "SELECT DISTINCT sr.recid srRecId,
							sr.routeid routeId
							FROM routedrawaccounting rda, specificroutes sr, route r
							WHERE rda.clientlocid = $ASLocationID
							AND rda.actspecificproductid = $spId
							AND rda.type = 'SD'
							AND rda.specificrouteid = sr.recid
							AND sr.dispatchlocid = $ASLocationID
							AND sr.datesked = '$dbEffDt'
							AND r.recid = sr.routeid
							AND r.type IN($routeTypeStr)";

		// FOR SPLITTING OF TABLES
		$qryGetRouteLoc = convertToSplitTables($qryGetRouteLoc, $val_SPLIT);

		if($debug)
			print($qryGetRouteLoc . "<br />\n");
		$rsltGetRouteLoc = mysqli_query( $cvtconnection, $qryGetRouteLoc);

		if(!$rsltGetRouteLoc) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetRouteLoc) == 0) {
			}
			else {
				while($rowGetRouteLoc = mysqli_fetch_assoc($rsltGetRouteLoc)) {
					$locId = $rowGetRouteLoc[locId];
					$srRecId = $rowGetRouteLoc[srRecId];
					$routeId = $rowGetRouteLoc[routeId];
					ValidateForInt(false, "routeId", "srRecId");

					if(is_array($srRouteIdArray) && !in_array($routeId, $srRouteIdArray)) {
						array_push($srRouteIdArray, $routeId);
					}
					if(is_array($srRecIdArray) && !in_array($srRecId, $srRecIdArray)) {
						array_push($srRecIdArray, $srRecId);
					}

				}
				$srRouteIdStr = implode(", ", $srRouteIdArray);
				$srRecIdStr = implode(", ", $srRecIdArray);
			}
		}

		if($srRouteIdStr == "") {
			$srRouteIdStr = "0";
		}

		if($srRecIdStr == "") {
			$srRecIdStr = "0";
		}

		while(list($key, $srRecId) = each($srRecIdArray)) {
			$qryGetSRLInfo = "SELECT DISTINCT locationid locId
								FROM specificrouteloc
								WHERE clientlocid = $ASLocationID
								AND specificrouteid = $srRecId";

			// FOR SPLITTING OF TABLES
			$qryGetSRLInfo = convertToSplitTables($qryGetSRLInfo, $val_SPLIT);

			if($GLOBALS[debug])
				print($qryGetSRLInfo . "<br />\n");
			$rsltGetSRLInfo = mysqli_query( $GLOBALS[cvtconnection], $qryGetSRLInfo);
			$srlLocIdStr = "";
			if(!$rsltGetSRLInfo) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				while($rowGetSRLInfo = mysqli_fetch_assoc($rsltGetSRLInfo)) {

					$locId = $rowGetSRLInfo[locId];
					if(!is_numeric($locId))	$locId = 0;

					if($srlLocIdStr == "") {
						$srlLocIdStr = $locId;
					}
					else {
						$srlLocIdStr .= ", " . $locId;
					}
				}
			}
			if($srlLocIdStr == "")
				$srlLocIdStr = "0";

			$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "specificroutes", $srRecId, "routeid");
			if($rsltArr[rtvalue]) {
				$routeId = $rsltArr[routeid];
				if(!is_numeric($routeId)) $routeId = 0;
			}
			else {
				$routeId = 0;
			}
			unset($rsltArr, $fileLineNbr);

			$qryGetSDQty = "SELECT
							SUM(IF(ta.specificrouteid = $srRecId, ta.actquantity, IF((ta.specificrouteid IS NULL OR ta.specificrouteid = 0 OR ta.specificrouteid = '') , ta.actquantity, 0))) actQty
							FROM transactivity ta
							WHERE ta.locationid = $ASLocationID
							AND ta.specificproductid = $spId
							AND ta.datet = '$dbEffDt'
							AND ta.type = 'SD'
							AND ta.customerlocid IN (" . $srlLocIdStr . ")";

			// FOR SPLITTING OF TABLES
			$qryGetSDQty = convertToSplitTables($qryGetSDQty, $val_SPLIT);

			if($debug)
				print($qryGetSDQty . "<br />\n");
			$rsltGetSDQty = mysqli_query( $cvtconnection, $qryGetSDQty);

			if(!$rsltGetSDQty) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if(mysqli_num_rows($rsltGetSDQty) == 0) {
				}
				else {
					$rowGetSDQty = mysqli_fetch_assoc($rsltGetSDQty);
					$actQty = $rowGetSDQty[actQty];
					if(!is_numeric($actQty)) $actQty = 0;
					if( ($actQty % $bCount) != 0) {
						// Here we will find out the amount needs to be updated to make bundle rounding
						$roundingPnt = 	$bCount * (1 - $numBurnd);
						$bundleFact = (int)(( $actQty + $roundingPnt ) / $bCount);
						$newQty = $bCount * $bundleFact;
						if($debug) print("<b>routeId = $routeId :: actQty = $actQty :: newQty = $newQty<br /></b>");
						$locIdStr = "";
						if($actQty == $newQty) {
						}
						elseif($newQty == 0) {
							// Get customerlocid
							/*$qryGetCustLoc = "SELECT DISTINCT ta.customerlocid locId
												FROM transactivity ta
												WHERE ta.locationid = $ASLocationID
												AND ta.specificproductid = $spId
												AND ta.datet = '$dbEffDt'
												AND ta.type = 'SD'
												AND ta.customerlocid IN (" . $srlLocIdStr . ")";*/
							$qryGetCustLoc = "SELECT
												IF(ta.specificrouteid = $srRecId, ta.customerlocid,
												IF((ta.specificrouteid IS NULL OR ta.specificrouteid = 0 OR ta.specificrouteid = ''), ta.customerlocid, 0)) custLocId
												FROM transactivity ta
												WHERE ta.locationid = $ASLocationID
												AND ta.specificproductid = $spId
												AND ta.datet = '$dbEffDt'
												AND ta.type = 'SD'
												AND ta.customerlocid IN (" . $srlLocIdStr . ")
												HAVING custLocId > 0";

							// FOR SPLITTING OF TABLES
							$qryGetCustLoc = convertToSplitTables($qryGetCustLoc, $val_SPLIT);

							if($debug)
								print($qryGetCustLoc . "<br />\n");
							$rsltGetCustLoc = mysqli_query( $cvtconnection, $qryGetCustLoc);
							if(!$rsltGetCustLoc) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if(mysqli_num_rows($rsltGetCustLoc) == 0) {
								}
								else {
									while($rowGetCustLoc = mysqli_fetch_assoc($rsltGetCustLoc)) {
										$locId = $rowGetCustLoc[custLocId];
										if(!is_numeric($locId))	$locId = 0;
										if($locId != 0) {
											if($locIdStr == "") {
												$locIdStr = $locId;
											}
											else {
												$locIdStr .= ", " . $locId;
											}
										}
									}
								}
							}

							if($locIdStr == "")
								$locIdStr = "0";

							//SET ALL TRANSACTIVITY ACTQTY TO ZERO
							$qryUp = "UPDATE transactivity
										SET actquantity = 0,
										archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
										WHERE locationid = $ASLocationID
										AND specificproductid = $spId
										AND datet = '$dbEffDt'
										AND customerlocid IN (" . $locIdStr . ")";

							// FOR SPLITTING OF TABLES
							$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

							if($debug)
								print("<b>" . $qryUp . "</b><br />\n");
							$rsltUp = mysqli_query( $cvtconnection, $qryUp);
							if(!$rsltUp) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if($debug)
									print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
							}
						}
						else {
							// THIS IS THE CASE WHERE WE REALLY NEEDS TO APPLY THE LOGIC OF NEW QTY
							// CHANGED.

							if($newQty < $actQty) {
								$unitInc = -1;
							}
							else {
								$unitInc = 1;
							}

							if($actQty == 0) {
								$factor = 1;
							}
							else {
								$factor = ( $newQty - $actQty ) / $actQty;
							}
							$factor = round($factor, 4);

							if($debug) {
								print("unitInc = $unitInc<br />");
								print("factor = $factor<br />");
							}

							$qryGetInfo = "SELECT ta.customerlocid locId,
											SUM(IF(ta.specificrouteid = $srRecId, ta.actquantity, IF((ta.specificrouteid IS NULL OR ta.specificrouteid = 0 OR ta.specificrouteid = '') , ta.actquantity, 0))) qty
											FROM transactivity ta
											WHERE ta.locationid = $ASLocationID
											AND ta.specificproductid = $spId
											AND ta.datet = '$dbEffDt'
											AND ta.type = 'SD'
											AND ta.customerlocid IN (" . $srlLocIdStr . ")
											GROUP BY ta.customerlocid
											ORDER BY qty DESC, ta.customerlocid";

							// FOR SPLITTING OF TABLES
							$qryGetInfo = convertToSplitTables($qryGetInfo, $val_SPLIT);

							if($debug)
								print($qryGetInfo . "<br />\n");
							$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
							if(!$rsltGetInfo) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
									$locId = $rowGetInfo[locId];
									$qty = $rowGetInfo[qty];
									ValidateForInt(false, "locId", "qty");

									//HERES WE WILL GET QTY ADDED OR SUBTRACTED
									if($debug) print("subqty = " . ($qty * $factor) . "<br />\n");
									$qtyAdded = ( floor( abs($qty * $factor) ) ) * $unitInc;
									if(!is_numeric($qtyAdded)) $qtyAdded = 0;

									//NOW UPDATE ANY ONE OF THE TA RECORD FOR THIS CUST AND PRODUCT
									//BY QTY_ADDED
									if($qtyAdded != 0) {
										$qryGetTaID = "SELECT recid FROM transactivity
														WHERE locationid = $ASLocationID
														AND customerlocid = $locId
														AND specificproductid = $spId
														AND datet = '$dbEffDt'
														AND type = 'SD'
														LIMIT 1";

										// FOR SPLITTING OF TABLES
										$qryGetTaID = convertToSplitTables($qryGetTaID, $val_SPLIT);

										if($debug)
											print($qryGetTaID . "<br />\n");
										$rsltGetTaID = mysqli_query( $cvtconnection, $qryGetTaID);
										if(!$rsltGetTaID) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											if(mysqli_num_rows($rsltGetTaID) != 0) {
												$rowGetTaID = mysqli_fetch_assoc($rsltGetTaID);
												$taid = $rowGetTaID[recid];
												if(!is_numeric($taid)) $taid = 0;

												$qryUp = "UPDATE transactivity
															SET actquantity = actquantity + $qtyAdded,
															archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
															WHERE recid = $taid";

												// FOR SPLITTING OF TABLES
												$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

												if($debug)
													print("<b>" . $qryUp . "</b><br />\n");
												$rsltUp = mysqli_query( $cvtconnection, $qryUp);
												if(!$rsltUp) {
													$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
													print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
													unset($fileLineNbr);
												}
												else {
													$actQty += $qtyAdded;
												}
											}
										}
									}
								}
							}

							//NOW UNTIL QTYACT REACHES QTYRECD INCREMENT EACH QTYS TO 1
							if(mysqli_num_rows($rsltGetInfo) > 0)
								mysqli_data_seek($rsltGetInfo,  0);

							while($actQty != $newQty && $rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
								$locId = $rowGetInfo[locId];
								ValidateForInt(false, "locId");

								$qryGetTaID =  "SELECT recid
												FROM transactivity
												WHERE locationid = $ASLocationID
												AND customerlocid = $locId
												AND specificproductid = $spId
												AND datet = '$dbEffDt'
												AND type = 'SD'
												LIMIT 1";

								// FOR SPLITTING OF TABLES
								$qryGetTaID = convertToSplitTables($qryGetTaID, $val_SPLIT);

								if($debug)
									print("<b>" . $qryGetTaID . "</b><br />\n");
								$rsltGetTaID = mysqli_query( $cvtconnection, $qryGetTaID);
								if(!$rsltGetTaID) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}
								else {
									if(mysqli_num_rows($rsltGetTaID) != 0) {
										$rowGetTaID = mysqli_fetch_assoc($rsltGetTaID);
										$taId = $rowGetTaID[recid];

										$qryUp = "UPDATE transactivity
													SET actquantity = actquantity + ( $unitInc ),
													archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
													WHERE recid = $taId";

										// FOR SPLITTING OF TABLES
										$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

										if($debug)
											print("<b>" . $qryUp . "</b><br />\n");
										$rsltUp = mysqli_query( $cvtconnection, $qryUp);
										if(!$rsltUp) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											$actQty += $unitInc;
										}
									}
								}
							}
						}
					}
				}
			}
		}

		ReCalculateQtySked_TRA37($dbEffDt, $spId);

		if($debug) {
			print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
		}
		else {
		    header("Location: " . urldecode($Back));
		}
		break;

	case "ShowCostCode":
	case "ShowCostCodeEmail":
	case "PubRegion":
	case "PubRegionEmail":
	case "DistRegion":
	case "DistRegionEmail":
	case "Group":
	case "GroupEmail":
	case "Route":
	case "RouteEmail":
	case "ActualRouteEmail":
	case "Manual":
	case "Demographic":
	case "ManualEmail":
	case "DemoEmail":
	case "ActualRoute":
	case "RouteGroup":
	case "RouteGroupEmail":
	

		print("<div class=\"datawhite\">");
		if($debug) print("spId = $spId :: effDt = $effDt<br />");
		$dbEffDt = makedate($effDt, 'MMDDYY');
		// first lets get the customerlocid
		$custLocIdArray = array();
		$qtyArray = array();
		$qryGetLoc = "SELECT DISTINCT customerlocid locId, SUM(actquantity) sdQty
						FROM transactivity
						WHERE locationid = $ASLocationID
						AND type = 'SD'
                                                AND datet = '$dbEffDt'
						AND specificproductid = $spId
						GROUP BY customerlocid";

		// FOR SPLITTING OF TABLES
		$qryGetLoc = convertToSplitTables($qryGetLoc, $val_SPLIT);

		if($debug)
			print($qryGetLoc . "<br />\n");
		$rsltGetLoc = mysqli_query( $cvtconnection, $qryGetLoc);
		if(!$rsltGetLoc) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetLoc) == 0) {
			}
			else {
				while($rowGetLoc = mysqli_fetch_assoc($rsltGetLoc)) {
					$locId = $rowGetLoc[locId];
					if(!is_numeric($locId)) $locId = 0;
					array_push($custLocIdArray, $locId);
					$sdQty = $rowGetLoc[sdQty];
					if(!is_numeric($sdQty)) $sdQty = 0;
					$qtyArray[$locId] = $sdQty;
				}

				$custLocIdStr = implode(", ", $custLocIdArray);
			}
		}
		if($custLocIdStr == "") {
			$custLocIdStr = "0";
		}

		if($debug) {
			print("<pre style=\"text-align: left;\">");
			print_r($custLocIdArray);
			print("</pre>\n");
			print("<pre style=\"text-align: left;\">");
			print_r($qtyArray);
			print("</pre>\n");
		}

		// GET DATEX FOR THE SOECIFICPRODUCTID
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "specificproduct", $spId, "datex", "productid", "bundlecount");
		if($rsltArr[rtvalue]) {
			$dbDateX = $rsltArr[datex];
			$prodId = $rsltArr[productid];
			$bndlCnt = $rsltArr[bundlecount];
			if(!is_numeric($prodId)) $prodId = 0;
			if(!is_numeric($bndlCnt)) $bndlCnt = 0;
		}
		else {
			$dbDateX = "";
			$prodId = "";
			$bndlCnt = 0;
		}
		unset($rsltArr, $fileLineNbr);

		// GETPUBGROUPMETHOD
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "product", $prodId, "pubgroupmethod", "sdesc", "ldesc", "vendorlocid");
		if($rsltArr[rtvalue]) {
			$pubGMethod = $rsltArr[pubgroupmethod];
			$prodDesc = $rsltArr[sdesc];
			$prodLDesc = $rsltArr[ldesc];
			$vendorLocId = $rsltArr[vendorlocid];
			if(!is_numeric($vendorLocId)) $vendorLocId = 0;
		}
		else {
			$pubGMethod = "";
			$prodDesc = "";
			$prodLDesc = "";
			$vendorLocId = 0;
		}
		unset($rsltArr, $fileLineNbr);

		switch($doAction) {

			case "ShowCostCode":
				// LETS GET THE RECENT STANDARDDRAW RECORDS FOR THE ABOVE PRODUCT
				// CREATE TEMPORARY TABLE
				$qryIns = "CREATE TEMPORARY TABLE tmp_stddraw_tra37 (
					productid BIGINT(20) NOT NULL,
					customerlocid BIGINT(20) NOT NULL,
					seasondetailid BIGINT(20) NOT NULL,
					effdt DATE NOT NULL DEFAULT '0000-00-00'
				)";
				if($debug)
					print("<b>" . $qryIns . "</b><br />\n");
				$rsltIns = mysqli_query( $cvtconnection, $qryIns);
				if(!$rsltIns) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 05);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}

				#### MODIFIED FOR ARCHIVING
				$qryGetInfo = "SELECT sd.productid, sd.customerlocid,
								sd.seasondetailid, MAX(sd.effdt) effdt
								FROM standarddraw sd
								WHERE sd.clientlocid = $ASLocationID
								AND sd.effdt <= '$dbDateX'
								AND sd.customerlocid IN (" . $custLocIdStr . ")
								AND sd.productid = $prodId
								AND ( sd.endeffdt IS NULL OR sd.endeffdt = '0000-00-00'
								OR sd.endeffdt > '$dbDateX' )
								GROUP BY sd.productid, sd.customerlocid,
								sd.seasondetailid";

				// TO INSERT RECORD IN TMP_STDDRAW WHERE THE EFFDT IS LESS THEN FORMDATE
				$qryIns = "INSERT INTO tmp_stddraw_tra37 " . $qryGetInfo . " ";

				if($debug)
					print("<b>" . $qryIns . "</b><br />\n");
				$rsltIns = mysqli_query( $cvtconnection, $qryIns);
				if(!$rsltIns) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}

				// LETS GET THE PRICECODE VALUES HERE
                                //$custLocIdStr = '';
				$qryToGetPriceCode = "SELECT sd.customerlocid custLocId, sd.costcodeid costCodeId,
										sd.pricecodevendid priceCodeVendId
										FROM tmp_stddraw_tra37 tmp, standarddraw sd
										LEFT JOIN pricecode pc ON pc.recid = sd.costcodeid
										LEFT JOIN pricecode pcv ON pcv.recid = sd.pricecodevendid
										WHERE sd.clientlocid = $ASLocationID
										AND sd.effdt <= '$dbDateX'
										AND sd.customerlocid IN (" . $custLocIdStr . ")
										AND sd.productid = $prodId
										AND ( sd.endeffdt IS NULL OR sd.endeffdt = '0000-00-00' OR sd.endeffdt > '$dbDateX' )
										AND sd.effdt = tmp.effdt
										AND sd.productid = tmp.productid
										AND sd.customerlocid = tmp.customerlocid
										AND sd.seasondetailid = tmp.seasondetailid
										ORDER BY pc.sortseqnbr, pcv.sortseqnbr";
				if($debug)
					print($qryToGetPriceCode . "<br />\n");
				$rsltToGetPriceCode = mysqli_query( $cvtconnection, $qryToGetPriceCode);
				if(!$rsltToGetPriceCode) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltToGetPriceCode) != 0) {
						$priceCodeArray = array();
						while($rowToGetPriceCode = mysqli_fetch_assoc($rsltToGetPriceCode)) {
							$custLocId = $rowToGetPriceCode[custLocId];
							$costCodeId = $rowToGetPriceCode[costCodeId];
							$priceCodeVendId = $rowToGetPriceCode[priceCodeVendId];
                                                        if(!is_numeric($priceCodeVendId)) $priceCodeVendId = 0;
							ValidateForInt(false, "custlocid", "costcodeid", "pricecodevendid");

							if(!isset($priceCodeArray[$custLocId])) {
								$priceCodeArray[$custLocId] = array(
									COSTCODE => $costCodeId,
									PRICECODEV => $priceCodeVendId
								);
							}
						}
                                                
						if($debug) {
							print("<pre style=\"text-align: left;\">");
							print_r($priceCodeArray);
							print("</pre>\n");
						}

						if($val_REGIN != "N") {
							$regionArray = array();
							if($pubGMethod == "R") {
								$qryToGetRegion = "SELECT sr.locationid locId, pg.recid vgId,
													pg.sdesc vgDesc
													FROM pubgroup pg, accessrights ar,
													companymap cm, standardroutes sr
													WHERE ar.clientid = $ASCompanyID
													AND ar.clientpubid = $prodId
													AND pg.publisherid = ar.publisherid
													AND pg.recid = cm.companyvalue
													AND cm.clientid = $ASCompanyID
													AND cm.companyid = ar.publisherid
													AND cm.fieldcode = 'RG'
													AND sr.routeid = cm.twcerecid
													AND sr.locationid IN (" . $custLocIdStr . " )
													AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00'
													OR sr.endeffdt > '$dbEffDt' )";
							}
							else {
								$qryToGetRegion = "SELECT l.recid locId, vg.recid vgId, vg.sdesc vgDesc
													FROM vendinggroup vg, vendingsubgroup vsg, location l
													WHERE l.recid IN (" . $custLocIdStr . ")
													AND vsg.recid = l.subgroupid
													AND vg.recid = vsg.vendinggroupid
													AND vg.clientlocid = $ASLocationID";
							}

							if($debug)
								print($qryToGetRegion . "<br />\n");
							$rsltToGetRegion = mysqli_query( $cvtconnection, $qryToGetRegion);
							if(!$rsltToGetRegion) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if(mysqli_num_rows($rsltToGetRegion) != 0) {
									while($rowToGetRegion = mysqli_fetch_assoc($rsltToGetRegion)) {
										$locId = $rowToGetRegion[locId];
										$vgId = $rowToGetRegion[vgId];
										$vgDesc = $rowToGetRegion[vgDesc];
										ValidateForInt(false, "locId", "vgId");

										if(!isset($regionArray[$locId])) {
											$regionArray[$locId] = array( VGID => $vgId,
																		 VGDESC => $vgDesc
																		);
										}
									}
									if($debug) {
										if($debug) {
											print("<pre> REGION_ARRAY");
											print_r($regionArray);
											print("</pre>\n");
										}
									}
								}
							}
						}
						if(is_array($regionArray))
							reset($regionArray);

						if(is_array($custLocIdArray))
							reset($custLocIdArray);

						if(is_array($priceCodeArray))
							reset($priceCodeArray);

						if($val_REGIN != "N") {
							if(is_array($regionArray)) {
								while(list($custLocId, $regInfo) = each($regionArray)) {
									$vgId = $regInfo[VGID];
									$vgDesc = $regInfo[VGDESC];
									$sdQty = $qtyArray[$custLocId];

									$costCodeId = $priceCodeArray[$custLocId][COSTCODE];
									if(!is_numeric($costCodeId)) $costCodeId = 0;
									$priceCodeVendId = $priceCodeArray[$custLocId][PRICECODEV];
									if(!is_numeric($priceCodeVendId)) $priceCodeVendId = 0;

									if(!isset($displayArr[$vgId])) {
										$displayArr[$vgId] = array(
											"VGDESC" => $vgDesc,
											"INFO" => array()
										);
									}

									if(!isset($displayArr[$vgId][INFO][$costCodeId])) {
										$pcDesc = GetDescription("pricecode", $costCodeId, "sdesc");
										$priceCodeId = $costCodeId;
										$displayArr[$vgId][INFO][$costCodeId] = array(
											"PCDESC" => $pcDesc,
											"INFO2" => array()
										);
									}
									if(!isset($displayArr[$vgId][INFO][$costCodeId][INFO2][$priceCodeVendId])) {
										$pcvDesc = GetDescription("pricecode", $priceCodeVendId, "sdesc");
										$priceCodeId = $priceCodeVendId;
										$displayArr[$vgId][INFO][$costCodeId][INFO2][$priceCodeVendId] = array(
										"PCVDESC" => $pcvDesc,
										"QTY" => $sdQty
										);
									}
									else {
										$displayArr[$vgId][INFO][$costCodeId][INFO2][$priceCodeVendId][QTY] += $sdQty;
									}
								}
							}
						}
						else {
							if(is_array($priceCodeArray)) {
								while(list($custLocId, $infoArray) = each($priceCodeArray)) {

									$costCodeId = $priceCodeArray[$custLocId][COSTCODE];
									$priceCodeVendId = $priceCodeArray[$custLocId][PRICECODEV];

									$sdQty = $qtyArray[$custLocId];
									if(!isset($displayArr[$costCodeId])) {
										$pcDesc = GetDescription("pricecode", $costCodeId, "sdesc");
										$priceCodeId = $costCodeId;
										$displayArr[$costCodeId] = array(
																			"PCDESC" => $pcDesc,
																			"INFO" => array()
																		);
									}

									if(!isset($displayArr[$costCodeId][INFO][$priceCodeVendId])) {
                                                                            
										$pcvDesc = GetDescription("pricecode", $priceCodeVendId, "sdesc");
										$priceCodeId = $priceCodeVendId;
										$displayArr[$costCodeId][INFO][$priceCodeVendId] = array(
												"PCVDESC" => $pcvDesc,
												"QTY" => $sdQty
											);
									}
									else {
										// JUST ADD THE QTY
										$displayArr[$costCodeId][INFO][$priceCodeVendId][QTY] += $sdQty;
									}
								}
							}
						}

						if($debug) {
							print("<pre style=\"text-align: left;\">");
							print_r($displayArr);
							print("</pre>\n");
						}

						if(is_array($displayArr)) {

							reset($displayArr);

							$htmlStr .= ("<table border=\"1\" width=\"50%\">\n");
							$htmlStr .= ("<tr class=\"datatblhdr\">\n");
							if($val_REGIN != "N") {
								$htmlStr .= ("<td align=\"center\">Region</td>\n");
							}
							$htmlStr .= ("<td align=\"center\">Per-copy Price Code Cost</td>\n");
							$htmlStr .= ("<td align=\"center\">Delivery Fee</td>\n");
							$htmlStr .= ("<td align=\"right\">Quantity</td>\n");
							$htmlStr .= ("</tr>\n");

							$oddEven = 0;
							$qtyReq = 0;
                                                        
							while(list($mainId, $infoArray) = each($displayArr)) {

								/*NOW WE WILL FIND EXTRADRAW FOR THIS REGION. FOR THAT WE WILL FIRST FIND ALL THE ROUTES IN THIS REGION*/

								if($val_REGIN != "N") {
									if($pubGMethod == "R") {
										$qryGetEDRouteId = "SELECT
															DISTINCT(cm.twcerecid) routeId
															FROM accessrights ar, companymap cm
															WHERE ar.clientid = $ASCompanyID
															AND ar.clientpubid = $prodId
															AND cm.companyid = ar.publisherid
															AND cm.clientid = $ASCompanyID
															AND cm.companyvalue = $mainId
															AND cm.fieldcode = 'RG'";
									}
									else {
										$qryGetEDRouteId = "SELECT
															DISTINCT(vsg.routeid)routeId
															FROM vendinggroup vg,
															vendingsubgroup vsg
															WHERE vg.recid = $mainId
															AND vg.clientlocid = $ASLocationID
															AND vsg.vendinggroupid = vg.recid";
									}
								}
								else {
									$qryGetEDRouteId = "SELECT
														DISTINCT(ed.routeid) routeId
														FROM extradraw ed
														WHERE clientlocid = $ASLocationID
														AND productid = $prodId
														AND effdt <= '$dbEffDt'";

								}
								if($debug)
									print($qryGetEDRouteId . "<br />\n");
								$rsltGetEDRouteId = mysqli_query( $cvtconnection, $qryGetEDRouteId);
								$routeIdArr = array();
								$routeIdStr = "";
								if(!$rsltGetEDRouteId) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}
								else {
									while($rowGetEDRouteId = mysqli_fetch_assoc($rsltGetEDRouteId)) {
										$edRouteId = $rowGetEDRouteId[routeId];
										if(!is_numeric($edRouteId)) $edRouteId = 0;

										array_push($routeIdArr, $edRouteId);
									}
									$routeIdStr = implode(", ", $routeIdArr);
								}
								if($routeIdStr == "") $routeIdStr = "0";

								if($val_REGIN != "N") {
									while(list($costCodeId, $pcInfo) = each($infoArray[INFO])) {
										while(list($pcVendId, $pcvInfo) = each($pcInfo[INFO2])) {
											$edQty = 0;
											if( ( $oddEven++ % 2 ) == 0 ) {
												$htmlStr .= ("<tr class=\"datawhite\">");
											}
											else {
												$htmlStr .= ("<tr class=\"datagrey\">");
											}

											$edQty = GetCCWiseExtraDraw_TRA37($routeIdStr, $costCodeId, $pcVendId, $prodId, $dbEffDt);

											// FOR REGION
											$vgDesc = $infoArray[VGDESC];
											$htmlStr .= ("<td align=\"center\">");
											if($debug) $htmlStr .= ("$mainId - ");
											$htmlStr .= ("" . ( $vgDesc != "" ? htmlentities($vgDesc, ENT_QUOTES) : "&nbsp;" ) . "</td>\n");

											// FOR PRICE CODE COST
											$pcDesc = $pcInfo[PCDESC];
											$htmlStr .= ("<td align=\"center\">");
											if($debug) $htmlStr .= ("$costCodeId - ");
											$htmlStr .= ("" . ( $pcDesc != "" ? htmlentities($pcDesc, ENT_QUOTES) : "&nbsp;" ) . "</td>\n");

											// FOR DELIVERY FEE COST
											$pcvDesc = $pcvInfo[PCVDESC];
											$htmlStr .= ("<td align=\"center\">");
											if($debug) $htmlStr .= ("$pcVendId - ");
											$htmlStr .= ("" . ( $pcvDesc != "" ? htmlentities($pcvDesc, ENT_QUOTES) : "&nbsp;" ) . "</td>");

											// FOR QUANTITY
											$qty = $pcvInfo[QTY] + $edQty;
											if(!is_numeric($qty)) $qty = 0;
											$qtyReq += $qty;

											/*$htmlStr .= ("<td align=\"right\">
													<a href=\"javascript:openpopup1('../rd/tra57.php?PageNbr=$PassedPageNbr&doAction=LocationPop&custlocid=$mainid&costcodeid=$ccid&pcvid=$pcvid&pubmethod=$pubgroupmethod&spid=$spid&dbeffdt=$dbeffdt');\">$qty</a>&nbsp;</td>");*/
											$htmlStr .= ("<td align=\"right\">$qty&nbsp;</td>");
											$htmlStr .= ("</tr>");
										}
									}
								}
								else {
									while(list($pcvid, $pcv_info) = each($infoArray[INFO])) {
										if( ( $oddEven++ % 2 ) == 0 ) {
											$htmlStr .= ("<tr class=\"datawhite\">");
										}
										else {
											$htmlStr .= ("<tr class=\"datagrey\">");
										}
										if($debug) print("here = $pcvid");
										if($debug) print("ppid = $pricecodeid");
										$edQty = 0;

										$edQty = GetCCWiseExtraDraw_TRA37($routeIdStr, $mainId, $pcvid, $prodId, $dbEffDt);

										// FOR PRICE CODE COST
										$pcdesc = $infoArray[PCDESC];
										$htmlStr .= ("<td align=\"center\">");
										if($debug) $htmlStr .= ("$mainid - ");
										$htmlStr .= ("" . htmlentities($pcdesc, ENT_QUOTES) . "&nbsp;</td>");

										// FOR DELIVERY FEE COST
										$pcvdesc = $pcv_info[PCVDESC];
										$htmlStr .= ("<td align=\"center\">");
										if($debug) $htmlStr .= ("$pcvid - ");
										$htmlStr .= ("" . htmlentities($pcvdesc, ENT_QUOTES) . "&nbsp;</td>");

										// FOR QUANTITY
										$qty = $pcv_info[QTY] + $edQty;
										if(!is_numeric($qty)) $qty = 0;
										$qtyrequested += $qty;
										/*$htmlStr .= ("<td align=\"right\"><a href=\"../rd/tra37.php?PageNbr=$PassedPageNbr&doAction=LocationPop&costcodeid=$mainid&pcvid=$pcvid&spid=$spid&dbeffdt=$dbeffdt\">
											$qty</a></td>");
										$htmlStr .= ("</tr>");*/

										$htmlStr .= ("<td align=\"right\">$qty&nbsp;</td>");
										$htmlStr .= ("</tr>\n");
									}
								}
							}
							$htmlStr .= ("</table>\n");

							print($htmlStr);

							$_SESSION[TRA37DISPHTMLSTR] = $htmlStr;

							print("<br /><a href=\"" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=ShowCostCodeEmail&spId=$spId&qtyReq=$qtyReq&effDt=$effDt", ENT_QUOTES) . "\">eMail</a>\n");
						}
						else {
							print("<b>No Information Available</b>\n");
						}
					}
				}

				// TRUNCATE TEMPTABLE
				$qryDel = "TRUNCATE TABLE tmp_stddraw_tra37";
				if($debug)
					print("<b>" . $qryDel . "</b><br />\n");
				$rsltDel = mysqli_query( $cvtconnection, $qryDel);
				if(!$rsltDel) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 07);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				break;

			case "ShowCostCodeEmail":
				if( isset($_SESSION[TRA37DISPHTMLSTR]) )
					$dispHtmlStr = $_SESSION[TRA37DISPHTMLSTR];

				if($debug)
					print($dispHtmlStr);
					
				$qryGetInfo1 = "SELECT c.personid, p.email
								FROM product pd, vendorlink vl, locationlink ll,
								company c, person p
								WHERE pd.clientid = $ASCompanyID
								AND pd.recid = $prodId
								AND vl.locationid = pd.vendorlocid
								AND ll.locationid = vl.locationid
								AND c.recid = ll.companyid
								AND p.recid = c.personid";
								
				if($debug)
					print($qryGetInfo1 . "<br />\n");
				$persEmailIdArray = array();
				$rsltGetInfo1 = mysqli_query( $cvtconnection, $qryGetInfo1);
				if(!$rsltGetInfo1) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo1) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo1 = mysqli_fetch_assoc($rsltGetInfo1)) {
							$persEmailId = $rowGetInfo1[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}	

				
				$qryGetInfo = "SELECT pl.personid, p.email
								FROM personlink pl, person p, notifyperson np
								WHERE pl.locationid = $ASLocationID
								AND pl.personid = p.recid
								AND pl.recid = np.personlinkid
								AND np.groupcode = 'DIS'
								AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00' OR pl.endeffdt > '$dbEffDt' )";

								
				if($debug)
					print($qryGetInfo . "<br />\n");
				//$persEmailIdArray = array();
				$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
				if(!$rsltGetInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
							$persEmailId = $rowGetInfo[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}

				if(COUNT($persEmailIdArray) == 0) {
					$mailMsg = "Email Address - not found for Person <br /><br />\n";
				}
				else {
					$fileLineNbr = __LINE__; $fromCompName = GetComp($ASCompanyID, $cvtconnection);
					if($debug)
						print("$fromCompName <br />\n");

					$from = "\"$fromCompName\" <$val_EMLID>";
					$toArr = $persEmailIdArray;
					$subject = $prodDesc;
					$msg = $dispHtmlStr;
					$mail = new htmlMimeMail();

					// SET MESSAGE
					$mail->setHtml($msg);

					// SEND MAIL
					$mail->setFrom($from);
					$mail->setSubject($subject);
					if($mail->send($toArr, "mail")) {
						$qryUp = "UPDATE totaldrawaccounting
									SET qtyrequested = $qtyReq,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE actspecificproductid = $spId";
						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
						}

						$to = implode(', ', $toArr);
						$mailMsg = "Mail Sent to $to";
					}
					else {
						$mailMsg = "Mail Not Sent for Price Code - Some problem exist";
					}
				}

				include('../cm/html-secondwindow.php');
				print("<div class=\"datawhite\">\n");
				print("<br /><b>$mailMsg</b><br />\n");
				print("<br /><a href=\"" . htmlspecialchars($Back, ENT_QUOTES) . "\">OK</a>\n");
				print("</div>\n");
				include('../cm/html-bottom-secondwindow.php');
				break;

			case "PubRegion":
				reset($qtyArray);
				$compId = GetCompId($cvtconnection, $vendorLocId);
				if(!is_numeric($compId))	$compId = 0;

				// GETTING THE DIFFERENT REGIONS.
                                //echo "$pubGMethod<br>";
                                if($pubGMethod == "R" || $pubGMethod == "L") {
					$fieldCode = "RG";
				}
				else {
					$fieldCode = '';
				}
                                
				$qryGetRegionInfo = "SELECT DISTINCT pg.recid pgRecId, pg.sdesc pgDesc,
                                                            pg.regioncode rgCode
                                                            FROM pubgroup pg, accessrights ar, companymap cm
                                                            WHERE ar.clientid = $ASCompanyID
                                                            AND ar.clientpubid = $prodId
                                                            AND pg.publisherid = ar.publisherid
                                                            AND pg.recid = cm.companyvalue
                                                            AND cm.clientid = $ASCompanyID
                                                            AND cm.companyid = ar.publisherid
                                                            AND cm.fieldcode = '$fieldCode'
                                                            AND (cm.endeffdt IS NULL OR cm.endeffdt = '0000-00-00' OR cm.endeffdt > '$curDate' ) 
                                                            ORDER BY pg.sortseqnbr";
				if($debug)
					print($qryGetRegionInfo . "<br />\n");
				$rsltGetRegionInfo = mysqli_query( $cvtconnection, $qryGetRegionInfo);
				if(!$rsltGetRegionInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetRegionInfo) == 0) {
						print("<b>No Information Available</b><br />\n");
					}
					else {
						$htmlStr1 = "";
						$htmlStr1 = $htmlStr1 . ("<u><b>Publisher Region - " . $prodDesc . "</b></u><br /><br />\n");
						$htmlStr = "";

						$htmlStr .= ("<br />\n");
						$htmlStr .= ("<table border=\"1\" width=\"65%\">\n");
						$htmlStr .= ("<tr class=\"datatblhdr\">\n");
						if($debug)
							$htmlStr .= ("<td align=\"center\">RecId</td>\n");
						$htmlStr .= ("<td>Region</td> <td>Region Code</td> <td align=\"right\">Quantity</td>\n");
						$htmlStr .= ("</tr>\n");

						$oddEven = 0;
						$qtyReq = 0;
						while($rowGetRegionInfo = mysqli_fetch_assoc($rsltGetRegionInfo)) {
							$pgRecId = $rowGetRegionInfo[pgRecId];
							if(!is_numeric($pgRecId))	$pgRecId = 0;
							
                                                        if($pubGMethod == "L"){
                                                            $qryGetLoc = "SELECT DISTINCT(ta.customerlocid) locId
                                                                            FROM transactivity ta, companymap cm,
                                                                            standardroutes sr, pubgroup pg, route r
                                                                            WHERE ta.locationid = '$ASLocationID'
                                                                            AND ta.specificproductid = '$spId'
                                                                            AND ta.datet = '$dbEffDt'
                                                                            AND pg.recid = '$pgRecId'
                                                                            AND cm.companyvalue = pg.recid
                                                                            AND cm.clientid = '$ASCompanyID'
                                                                            AND cm.companyid = pg.publisherid
                                                                            AND cm.fieldcode = '$fieldCode'
                                                                            AND cm.twcerecid = r.recid
                                                                            AND r.type = 'LB'
                                                                            AND sr.routeid = cm.twcerecid
                                                                            AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00'
                                                                            OR sr.endeffdt > '$dbEffDt' )
                                                                            AND ta.customerlocid = sr.locationid
                                                                            AND ta.customerlocid IN (" . $custLocIdStr . ")";
                                                        } else {
                                                            $qryGetLoc = "SELECT DISTINCT(ta.customerlocid) locId
                                                                            FROM transactivity ta, companymap cm,
                                                                            standardroutes sr, pubgroup pg
                                                                            WHERE ta.locationid = $ASLocationID
                                                                            AND ta.specificproductid = $spId
                                                                            AND ta.datet = '$dbEffDt'
                                                                            AND pg.recid = $pgRecId
                                                                            AND cm.companyvalue = pg.recid
                                                                            AND cm.clientid = $ASCompanyID
                                                                            AND cm.companyid = pg.publisherid
                                                                            AND cm.fieldcode = '$fieldCode'
                                                                            AND sr.routeid = cm.twcerecid
                                                                            AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00'
                                                                            OR sr.endeffdt > '$dbEffDt' )
                                                                            AND ta.customerlocid = sr.locationid
                                                                            AND ta.customerlocid IN (" . $custLocIdStr . ")";
                                                        }
							

							// FOR SPLITTING OF TABLES
							$qryGetLoc = convertToSplitTables($qryGetLoc, $val_SPLIT);

							if($debug)
								print($qryGetLoc . "<br />\n");
							$rsltGetLoc = mysqli_query( $cvtconnection, $qryGetLoc);
							$totQty = 0;
							if(!$rsltGetLoc) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if(mysqli_num_rows($rsltGetLoc) != 0) {
									while($rowGetLoc = mysqli_fetch_assoc($rsltGetLoc)) {
										$locId = $rowGetLoc[locId];
										$totQty += $qtyArray[$locId];
									}
								}
							}
							if(!is_numeric($totQty)) $totQty = 0;
                                                        
                                                        if($totQty > 0){
                                                            if(($oddEven++ % 2) == 0) {
								$htmlStr .= ("<tr class=\"datawhite\">\n");
                                                            }
                                                            else {
                                                                $htmlStr .= ("<tr class=\"datagrey\">\n");
                                                            }

                                                            if($debug)
                                                                $htmlStr .= ("<td align=\"center\">$rowGetRegionInfo[pgRecId]</td>\n");

                                                            // DISPLAY REGION
                                                            $htmlStr .= ("<td>");
                                                            $htmlStr .= (htmlentities($rowGetRegionInfo[pgDesc], ENT_QUOTES));
                                                            $htmlStr .= ("&nbsp;</td>\n");

                                                            // DISPLAY REGION CODE
                                                            $htmlStr .= ("<td>");
                                                            $htmlStr .= (htmlentities($rowGetRegionInfo[rgCode], ENT_QUOTES));
                                                            $htmlStr .= ("&nbsp;</td>\n");

                                                            $qtyReq += $totQty;
                                                            $htmlStr .= ("<td align=\"right\">&nbsp;");
                                                            $htmlStr .= (number_format($totQty));
                                                            $htmlStr .= ("</td>\n");
                                                            $htmlStr .= ("</tr>\n");
                                                        }
                                                        
						}

						$htmlStr .= ("</table>\n");
						$htmlStr .= ("<br />\n");
						$dispHtmlStr = $htmlStr1 . $htmlStr;
						print($dispHtmlStr);

						$_SESSION[TRA37DISPHTMLSTR] = $dispHtmlStr;

						print("<a href=\"" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=PubRegionEmail&spId=$spId&qtyReq=$qtyReq&effDt=$effDt", ENT_QUOTES) . "\">eMail</a>\n");
					}
				}
				break;

			case "PubRegionEmail":
				if( isset($_SESSION[TRA37DISPHTMLSTR]) )
				 $dispHtmlStr = $_SESSION[TRA37DISPHTMLSTR];

				if($debug)
					print($dispHtmlStr);

				$qryGetInfo1 = "SELECT c.personid, p.email
								FROM product pd, vendorlink vl, locationlink ll,
								company c, person p
								WHERE pd.clientid = $ASCompanyID
								AND pd.recid = $prodId
								AND vl.locationid = pd.vendorlocid
								AND ll.locationid = vl.locationid
								AND c.recid = ll.companyid
								AND p.recid = c.personid";
								
				if($debug)
					print($qryGetInfo1 . "<br />\n");
				$persEmailIdArray = array();
				$rsltGetInfo1 = mysqli_query( $cvtconnection, $qryGetInfo1);
				if(!$rsltGetInfo1) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo1) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo1 = mysqli_fetch_assoc($rsltGetInfo1)) {
							$persEmailId = $rowGetInfo1[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}	

				
				$qryGetInfo = "	SELECT pl.personid, p.email
								FROM personlink pl, person p, notifyperson np
								WHERE pl.locationid = $ASLocationID
								AND pl.personid = p.recid
								AND pl.recid = np.personlinkid
								AND np.groupcode = 'DIS'
								AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00'
								OR pl.endeffdt > '$dbEffDt' )";

								
				if($debug)
					print($qryGetInfo . "<br />\n");
				//$persEmailIdArray = array();
				$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
				if(!$rsltGetInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
							$persEmailId = $rowGetInfo[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}

				if(COUNT($persEmailIdArray) == 0) {
					$mailMsg = "Email Address - not found for Person";
				}
				else {
					$fileLineNbr = __LINE__; $fromCompName = GetComp($ASCompanyID, $cvtconnection);
					if($debug)
						print("$fromCompName <br />\n");

					$dispDateX = set_date($dbEffDt, "YYYY-MM-DD", "MM/DD/YY");
					$dispDateXSub= date('d-M-Y', strtotime($dbEffDt));
					$prodDesc = $prodDesc . " for " . $dispDateXSub;

					$from = "\"$fromCompName\" <$val_EMLID>";
					$toArr = $persEmailIdArray;
					$subject = $prodDesc;
					$msg = $dispHtmlStr;

					$mail = new htmlMimeMail();


					// SET MESSAGE
					$mail->setHtml($msg);

					// SEND MAIL
					$mail->setFrom($from);
					$mail->setSubject($subject);

					if($mail->send($toArr, "mail")) {
						$qryUp = "UPDATE totaldrawaccounting
									SET qtyrequested = $qtyReq,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE actspecificproductid = $spId";
						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
						}

						$to = implode(', ', $toArr);
						$mailMsg = "Mail Sent to $to";
					}
					else {
						$mailMsg = "Mail Not Sent for Publisher Region- Some problem exist";
					}
				}
				include('../cm/html-secondwindow.php');
				print("<div class=\"datawhite\">");
				print("<br /><b>$mailMsg</b><br />");
				print("<br /><a href=\"" . htmlspecialchars($Back, ENT_QUOTES) . "\">OK</a>");
				print("</div>\n");
				include('../cm/html-bottom-secondwindow.php');
				break;

			case "DistRegion":
				// GETTING THE DIFFERENT REGIONS.
				$qryGetRegionInfo = "SELECT DISTINCT vg.recid groupId, vg.sdesc vgDesc
									FROM vendinggroup vg
									WHERE vg.clientlocid = $ASLocationID
									ORDER BY vg.sortseqnbr, vg.sdesc";
				if($debug)
					print($qryGetRegionInfo . "<br />\n");
				$rsltGetRegionInfo = mysqli_query( $cvtconnection, $qryGetRegionInfo);
				if(!$rsltGetRegionInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetRegionInfo) == 0) {
						print("<b>No Information Available</b><br />");
					}
					else {
						$htmlStr1 = "";
						$htmlStr1 = $htmlStr1 . ("<u><b>Distributor Region - " . $prodDesc . "</b></u><br /><br />\n");
						$htmlStr = "";

						$htmlStr .= ("<br />\n");
						$htmlStr .= ("<table border=\"1\" width=\"65%\">\n");
						$htmlStr .= ("<tr class=\"datatblhdr\">\n");
						if($debug)
							$htmlStr .= ("<td align=\"center\">RecId</td>\n");
						$htmlStr .= ("<td>Region</td><td align=\"right\">Quantity</td>\n");
						$htmlStr .= ("</tr>\n");

						$oddEven = 0;
						$qtyReq = 0;
						while($rowGetRegionInfo = mysqli_fetch_assoc($rsltGetRegionInfo)) {
							$groupId = $rowGetRegionInfo[groupId];
							if(!is_numeric($groupId)) $groupId = 0;
							if(($oddEven++ % 2) == 0) {
								$htmlStr .= ("<tr class=\"datawhite\">\n");
							}
							else {
								$htmlStr .= ("<tr class=\"datagrey\">\n");
							}

							if($debug)
								$htmlStr .= ("<td align=\"center\">" . $groupId . "</td>\n");

							// DISPLAY Region
							//if($val_REGIN == "G") {
								$htmlStr .= ("<td>");
								$htmlStr .= (htmlentities($rowGetRegionInfo[vgDesc], ENT_QUOTES));
								$htmlStr .= ("&nbsp;</td>\n");
							/*}else {
								$htmlStr .= ("<td>");
								$htmlStr .= ("<a href=\"javascript:openpopup1('../rd/tra57.php?PageNbr=$PassedPageNbr&doAction=GroupDetail&groupId=$groupId');\">" . htmlentities($rowGetRegionInfo[vgDesc], ENT_QUOTES) . "</a>");
								$htmlStr .= ("</td>\n");
							}*/


							// FOR QUANTITY
							reset($qtyArray);
							$qryGetLoc = "SELECT DISTINCT(ta.customerlocid) locId
											FROM transactivity ta, location l, vendingsubgroup vsg
											WHERE ta.locationid = $ASLocationID
											AND ta.specificproductid = $spId
                                                                                        AND ta.datet = '$dbEffDt'
											AND l.recid = ta.customerlocid
											AND ( l.endeffdate IS NULL OR l.endeffdate = '0000-00-00'
											OR l.endeffdate > '$dbEffDt' )
											AND vsg.recid = l.subgroupid
											AND vsg.vendinggroupid = $groupId
											AND ta.customerlocid IN (" . $custLocIdStr . ")";

							// FOR SPLITTING OF TABLES
							$qryGetLoc = convertToSplitTables($qryGetLoc, $val_SPLIT);

							if($debug)
								print($qryGetLoc . "<br />\n");
							$rsltGetLoc = mysqli_query( $cvtconnection, $qryGetLoc);
							$totQty = 0;
							if(!$rsltGetLoc) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if(mysqli_num_rows($rsltGetLoc) != 0) {
									while($rowGetLoc = mysqli_fetch_assoc($rsltGetLoc)) {
										$locId = $rowGetLoc[locId];
										$totQty += $qtyArray[$locId];
									}
								}
							}
							if(!is_numeric($totQty)) $totQty = 0;

							// NOW FIRST WE WILL FIND ROUTE RELATED TO THIS REGION TO GET EXTRADRAW QUANTITY*/
							$qryGetEDRouteId = "SELECT DISTINCT vsg.routeid routeId
												FROM vendinggroup vg, vendingsubgroup vsg

												WHERE vg.recid = $groupId
												AND vg.clientlocid = $ASLocationID
												AND vsg.vendinggroupid = vg.recid";
							if($debug)
								print($qryGetEDRouteId . "<br />\n");
							$rsltGetEDRouteId = mysqli_query(
							$cvtconnection, $qryGetEDRouteId);
							$edQty = 0;
							if(!$rsltGetEDRouteId) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								while($rowGetEDRouteId = mysqli_fetch_assoc($rsltGetEDRouteId)) {
									$edRouteId = $rowGetEDRouteId[routeId];
									if(!is_numeric($edRouteId)) $edRouteId = 0;

									$edQty += GetExtraDrawQty($prodId, $edRouteId, $dbEffDt);
								}
							}
							$totQty += $edQty;

							$qtyReq += $totQty;
							$htmlStr .= ("<td align=\"right\">");
							$htmlStr .= (number_format($totQty));
							$htmlStr .= ("</td>\n");
							$htmlStr .= ("</tr>\n");
						}

						//$htmlStr .= ("</tr>\n");
						$htmlStr .= ("</table>\n");
						$htmlStr .= ("<br />\n");
						$dispHtmlStr = $htmlStr1 . $htmlStr;
						print($dispHtmlStr);

						$newHtmlStr = $dispHtmlStr;
						$newHtmlStr = preg_replace("'<a.*;\">'", " ", $newHtmlStr);
						$newHtmlStr = preg_replace("'<\/A>'", " ", $newHtmlStr);

						// print($newhtmlstr);
						$_SESSION[TRA37DISPHTMLSTR] = $newHtmlStr;

						print("<a href=\"" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=DistRegionEmail&spId=$spId&qtyReq=$qtyReq&effDt=$effDt", ENT_QUOTES) . "\">eMail</a>\n");
					}
				}
				break;

			case "DistRegionEmail":
				if( isset($_SESSION[TRA37DISPHTMLSTR]) )
				 $dispHtmlStr = $_SESSION[TRA37DISPHTMLSTR];

				if($debug)
					print($dispHtmlStr);
					
				$qryGetInfo1 = "SELECT c.personid, p.email
								FROM product pd, vendorlink vl, locationlink ll,
								company c, person p
								WHERE pd.clientid = $ASCompanyID
								AND pd.recid = $prodId
								AND vl.locationid = pd.vendorlocid
								AND ll.locationid = vl.locationid
								AND c.recid = ll.companyid
								AND p.recid = c.personid";
								
				if($debug)
					print($qryGetInfo1 . "<br />\n");
				$persEmailIdArray = array();
				$rsltGetInfo1 = mysqli_query( $cvtconnection, $qryGetInfo1);
				if(!$rsltGetInfo1) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo1) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo1 = mysqli_fetch_assoc($rsltGetInfo1)) {
							$persEmailId = $rowGetInfo1[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}	
	

				
				$qryGetInfo = " SELECT pl.personid, p.email
								FROM personlink pl, person p, notifyperson np
								WHERE pl.locationid = $ASLocationID
								AND pl.personid = p.recid
								AND pl.recid = np.personlinkid
								AND np.groupcode = 'DIS'
								AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00'
								OR pl.endeffdt > '$dbEffDt' )";

								
				if($debug)
					print($qryGetInfo . "<br />\n");
				//$persEmailIdArray = array();
				$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
				if(!$rsltGetInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
							$persEmailId = $rowGetInfo[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}

				if(count($persEmailIdArray) == 0 ) {
					$mailMsg = "Email Address - not found for Person";
				}
				else {
					$fileLineNbr = __LINE__; $fromCompName = GetComp($ASCompanyID, $cvtconnection);
					if($debug)
						print("$fromCompName <br />\n");

					$dispDateX = set_date($dbEffDt, "YYYY-MM-DD", "MM/DD/YY");
					$dispDateXSub= date('d-M-Y', strtotime($dbEffDt));
					
					$prodDesc = $prodDesc . " for " . $dispDateXSub;

					$from = "\"$fromCompName\" <$val_EMLID>";
					$toArr = $persEmailIdArray;
					$subject = $prodDesc;
					$msg = $dispHtmlStr;

					$mail = new htmlMimeMail();

					// SET MESSAGE
					$mail->setHtml($msg);

					// SEND MAIL
					$mail->setFrom($from);
					$mail->setSubject($subject);

					if($mail->send($toArr, "mail")) {
						$qryUp = "UPDATE totaldrawaccounting
									SET qtyrequested = $qtyReq,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE actspecificproductid = $spId";
						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
						}

						$to = implode(', ', $toArr);
						$mailMsg = "Mail Sent to $to";
					}
					else {
						$mailMsg = "Mail Not Sent for Distributor Region";
					}
				}
				include('../cm/html-secondwindow.php');
				print("<div class=\"datawhite\">\n");
				print("<br /><b>$mailMsg</b><br />");
				print("<br /><a href=\"" . htmlspecialchars($Back, ENT_QUOTES) . "\">OK</a>\n");
				print("</div>\n");
				include('../cm/html-bottom-secondwindow.php');
				break;

			case "Group":
				$htmlStr = "";
				$htmlStr .= ("<div class=\"datawhite\">\n");

				$dowEffDt = strtoupper(date("D", mktime(0, 0, 0, substr($dbEffDt, 5, 2), substr($dbEffDt, 8, 2), substr($dbEffDt, 0, 4))));

				$dispDateX = set_date($dbEffDt, "YYYY-MM-DD", "MM/DD/YY");
				$prodDesc = $prodDesc . " - " . $dispDateX;
				$htmlStr .= ("<b> Group - " . htmlentities($prodDesc, ENT_QUOTES) . "</b><br /><br />");
				reset($qtyArray);
				if($val_REGIN == "G") {
					/*$qryGetLocGroup = "SELECT sr.locationid locId, sr.routeid routeId,
										IF(sr.normalroute = 'Y', 'Yes', 'No') normalRt,
										g.recid grpId, g.code grpCode, g.sdesc grpDesc,
										vsg.vendinggroupid vgId, vg.sdesc vgDesc
										FROM standardroutes sr, routefrequency rf,
										personlink pl, groups g,
										location l, vendingsubgroup vsg, vendinggroup vg
										WHERE l.recid = sr.locationid
										AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00' OR sr.endeffdt > '$dbEffDt' )
										AND ( l.endeffdate IS NULL OR l.endeffdate = '0000-00-00' OR l.endeffdate > '$dbEffDt' )
										AND vsg.recid = l.subgroupid
										AND vg.recid = vsg.vendinggroupid
										AND rf.routeid = sr.routeid
										AND rf.dow = '$dowEffDt'
										AND  ( rf.endeffdt IS NULL OR rf.endeffdt = '0000-00-00' OR rf.endeffdt > '$dbEffDt' )
										AND pl.personid = rf.driverid
										AND pl.locationid = $ASLocationID
										AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00' OR pl.endeffdt > '$dbEffDt' )
										AND g.code = pl.role
										AND g.locationid = $ASLocationID
										AND ( g.endeffdt IS NULL OR g.endeffdt = '0000-00-00' OR g.endeffdt > '$dbEffDt' )
										GROUP BY sr.recid, routeId, vgId, grpId
										ORDER BY vg.sdesc, grpDesc";*/

				// BASED ON SPECIFICROUTES
				$qryGetLocGroup = "SELECT ta.customerlocid locId,
										ta.specificrouteid srId, SUM(ta.actquantity) actQty, g.recid grpId, g.code grpCode, g.sdesc grpDesc, spr.routeid routeId, vsg.vendinggroupid vgId, vg.sdesc vgDesc

										FROM transactivity ta, specificroutes spr, routefrequency rf, personlink pl, groups g,
										location l, vendingsubgroup vsg, vendinggroup vg

										WHERE ta.locationid = $ASLocationID
										AND ta.type = 'SD'
                                                                                AND ta.datet = '$dbEffDt'
										AND ta.specificproductid = $spId
										AND spr.recid = ta.specificrouteid
										AND l.recid = ta.customerlocid
										AND ( l.endeffdate IS NULL OR l.endeffdate = '0000-00-00' OR l.endeffdate > '$dbEffDt' )
										AND vsg.recid = l.subgroupid
										AND vg.recid = vsg.vendinggroupid
										AND rf.routeid = spr.routeid
										AND rf.dow = '$dowEffDt'
										AND  ( rf.endeffdt IS NULL OR rf.endeffdt = '0000-00-00' OR rf.endeffdt > '$dbEffDt' )
										AND pl.personid = rf.driverid
										AND pl.locationid = $ASLocationID
										AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00' OR pl.endeffdt > '$dbEffDt' )
										AND g.code = pl.role
										AND g.locationid = $ASLocationID
										AND ( g.endeffdt IS NULL OR g.endeffdt = '0000-00-00' OR g.endeffdt > '$dbEffDt' )
										GROUP BY locId, srId, vgId, grpId
										ORDER BY vg.sdesc, grpDesc";

					// FOR SPLITTING OF TABLES
					$qryGetLocGroup = convertToSplitTables($qryGetLocGroup, $val_SPLIT);
					if($debug)
						print($qryGetLocGroup . "<br />\n");
					$rsltGetLocGroup = mysqli_query( $cvtconnection, $qryGetLocGroup);
					if(!$rsltGetLocGroup) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						$vgGrpInfoArray = array();
						if(mysqli_num_rows($rsltGetLocGroup) != 0) {
							while($rowGetLocGroup = mysqli_fetch_assoc($rsltGetLocGroup)) {
								$locId = $rowGetLocGroup[locId];
								$grpId = $rowGetLocGroup[grpId];
								$srId = $rowGetLocGroup[srId];
								$vgId = $rowGetLocGroup[vgId];
								ValidateForInt(false, "locId", "grpId", "vgId", "srId");
								$vgDesc = $rowGetLocGroup[vgDesc];
								$grpCode = $rowGetLocGroup[grpCode];
								$grpDesc = $rowGetLocGroup[grpDesc];						$srId = $rowGetLocGroup[srId];
								$actQty = $rowGetLocGroup[actQty];

								// HERE WE NEED TO FIND THE LOCATION FROM TRANSACTIVITY AND STANDARD ROUTES

								/*if($normalRt == "Yes") {
									$grpQty = $qtyArray[$locId];
									if(!is_numeric($grpQty)) $grpQty = 0;
								}
								else {
									$grpQty = 0;
								}*/

								$grpQty = $actQty;
								if(!is_numeric($grpQty)) $grpQty = 0;

								if(!is_array($vgGrpInfoArray[$vgId])) {
									$vgGrpInfoArray[$vgId] = array(
										"VGDESC" => $vgDesc,
										"GRP" => array()
									);
								}

								if(!isset($vgGrpInfoArray[$vgId][GRP][$grpId])) {
									$vgGrpInfoArray[$vgId][GRP][$grpId] = array(
										"GRPCODE" => $grpCode,
										"GRPDESC" => $grpDesc,
										"GRPQTY" => 0
									);
								}

								$vgGrpInfoArray[$vgId][GRP][$grpId][GRPQTY] += $grpQty;

								if(!is_array($vgGrpInfoArray[$vgId][GRP][$grpId][LOCSTR])) {
									$vgGrpInfoArray[$vgId][GRP][$grpId][LOCSTR] = array();
								}
								if($lsIntPlord == $prodId) {
									array_push($vgGrpInfoArray[$vgId][GRP][$grpId][LOCSTR], $locId);
								}

								if(!is_array($vgGrpInfoArray[$vgId][GRP][$grpId][ROUTESTR])) {
									$vgGrpInfoArray[$vgId][GRP][$grpId][ROUTESTR] = array();
								}

								if(!in_array($routeId, $vgGrpInfoArray[$vgId][GRP][$grpId][ROUTESTR])) {
									array_push($vgGrpInfoArray[$vgId][GRP][$grpId][ROUTESTR], $routeId);
								}
							}
						}
					}
					if($debug) {
						print("<br />vgGrpInfoArray : <pre>");
						print_r($vgGrpInfoArray);
						print("<br /></pre>");
					}

				}
				else {
					/*$qryGetLocGroup = "SELECT DISTINCT(sr.locationid) locId, sr.routeid routeId,
										IF(sr.normalroute = 'Y', 'Yes', 'No') normalRt,
										g.recid grpId, g.code grpCode, g.sdesc grpDesc
										FROM standardroutes sr, routefrequency rf,
										personlink pl, groups g
										WHERE rf.routeid = sr.routeid
										AND rf.dow = '$dowEffDt'
										AND  ( rf.endeffdt IS NULL OR rf.endeffdt = '0000-00-00' OR rf.endeffdt > '$dbEffDt')
										AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00' OR sr.endeffdt > '$dbEffDt')
										AND pl.personid = rf.driverid
										AND pl.locationid = $ASLocationID
										AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00' OR pl.endeffdt > '$dbEffDt' )
										AND g.code = pl.role
										AND g.locationid = $ASLocationID
										AND ( g.endeffdt IS NULL OR g.endeffdt = '0000-00-00' OR g.endeffdt > '$dbEffDt' )
										GROUP BY sr.recid, routeId, grpId
										ORDER BY g.sdesc";*/

					$qryGetLocGroup = "SELECT ta.customerlocid locId,
										ta.specificrouteid srId, SUM(ta.actquantity) actQty, spr.routeid routeId, g.recid grpId, g.code grpCode, g.sdesc grpDesc

										FROM transactivity ta, specificroutes spr, routefrequency rf, personlink pl, groups g

										WHERE ta.locationid = $ASLocationID
										AND ta.type = 'SD'
                                                                                AND ta.datet = '$dbEffDt'
										AND ta.specificproductid = $spId
										AND spr.recid = ta.specificrouteid					AND rf.routeid = spr.routeid
										AND rf.dow = '$dowEffDt'
										AND  ( rf.endeffdt IS NULL OR rf.endeffdt = '0000-00-00' OR rf.endeffdt > '$dbEffDt')
										AND pl.personid = rf.driverid
										AND pl.locationid = $ASLocationID
										AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00' OR pl.endeffdt > '$dbEffDt' )
										AND g.code = pl.role
										AND g.locationid = $ASLocationID
										AND ( g.endeffdt IS NULL OR g.endeffdt = '0000-00-00' OR g.endeffdt > '$dbEffDt' )
										GROUP BY locId, srId, routeId, grpId
										ORDER BY g.sdesc";

					$qryGetLocGroup = convertToSplitTables($qryGetLocGroup, $val_SPLIT);

					if($debug)
						print($qryGetLocGroup . "<br />\n");
					$rsltGetLocGroup = mysqli_query( $cvtconnection, $qryGetLocGroup);
					$grpInfoArray = array();
					if(!$rsltGetLocGroup) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {

						if(mysqli_num_rows($rsltGetLocGroup) != 0) {
							while($rowGetLocGroup = mysqli_fetch_assoc($rsltGetLocGroup)) {
								$locId = $rowGetLocGroup[locId];
								$grpId = $rowGetLocGroup[grpId];
								$routeId = $rowGetLocGroup[routeId];
								$grpCode = $rowGetLocGroup[grpCode];
								$grpDesc = $rowGetLocGroup[grpDesc];
								$srId = $rowGetLocGroup[srId];
								$actQty = $rowGetLocGroup[actQty];
								ValidateForInt(false, "locId", "grpId", "routeId", "actQty");

								/*if($normalRt == "Yes") {
									$grpQty = $qtyArray[$locId];
									if(!is_numeric($grpQty)) $grpQty = 0;
								}
								else {
									$grpQty = 0;
								}*/

								$grpQty = $actQty;
								if(!is_numeric($grpQty)) $grpQty = 0;

								if(!isset($grpInfoArray[$grpId])) {
									$grpInfoArray[$grpId] = array(
										"GRPCODE" => $grpCode,
										"GRPDESC" => $grpDesc,
										"GRPQTY" => 0
									);
								}

								$grpInfoArray[$grpId][GRPQTY] += $grpQty;

								if(!is_array($grpInfoArray[$grpId][LOCSTR])) {
									$grpInfoArray[$grpId][LOCSTR] = array();
								}
								if($lsIntPlord == $prodId) {
									array_push($grpInfoArray[$grpId][LOCSTR], $locId);
								}

								if(!is_array($grpInfoArray[$grpId][ROUTESTR])) {
									$grpInfoArray[$grpId][ROUTESTR] = array();
								}

								if(!in_array($routeId, $grpInfoArray[$grpId][ROUTESTR])) {
									array_push($grpInfoArray[$grpId][ROUTESTR], $routeId);
								}
							}
						}
					}

					if($debug) {
						print("<br />grpInfoArray : <pre>");
						print_r($grpInfoArray);
						print("<br /></pre>");
					}
				}

				$qtyReq = 0;
				if($val_REGIN == "G") {

					$htmlStr .= ("<table border=\"1\" width=\"50%\">\n");
					$htmlStr .= ("<tr class=\"datatblhdr\">\n");
					$htmlStr .= ("<td align=\"left\">Group</td>\n");
					if($lsIntPlord == $prodId)
						$htmlStr .= ("<td align=\"left\">Zone</td>\n");
					$htmlStr .= ("<td align=\"right\">Quantity</td>\n");
					$htmlStr .= ("<td align=\"right\">Extra Copies</td>\n");
					$htmlStr .= ("<td align=\"right\">Bundles</td>\n");
					$htmlStr .= ("</tr>\n");

					$grandGrpQty = 0;
					$grandBndleQty = 0;
					$grandExtraQty = 0;
					while(list($vgId, $vgInfoArr) = each($vgGrpInfoArray)) {
						$vgDesc = $vgInfoArr[VGDESC];
						$htmlStr .= ("<tr class=\"datawhite\">\n");
						$cloSpan = 4;
						if($lsIntPlord == $prodId) $cloSpan = 5;

						$htmlStr .= ("<td align=\"left\" colspan=\"" . $cloSpan . "\"><b>" . htmlentities($vgDesc, ENT_QUOTES) . "</b></td>\n");
						$htmlStr .= ("</tr>\n");

						$totGrpQty = 0;
						$totBndleQty = 0;
						$totExtraQty = 0;
						while(list($grpId, $grpInfoArr) = each($vgInfoArr[GRP])) {
							$grpDesc = $grpInfoArr[GRPDESC];
							$grpQty = $grpInfoArr[GRPQTY];
							$grpCode = $grpInfoArr[GRPCODE];

							$totGrpQty += $grpQty;
							$grandGrpQty += $grpQty;
							$qtyReq += $grpQty;

							$routeIdStr = "";
							while(list($rtKey, $routeId) = each($grpInfoArr[ROUTESTR])) {
								if($routeIdStr == "") {
									$routeIdStr = $routeId;
								}
								else {
									$routeIdStr .= ", " . $routeId;
								}
							}

							if($routeIdStr == "") {
								$routeIdStr = "0";
							}

							$edRouteIdStr = "";
							/* NOW WE WILL FIND THE ROUTES FOR EXTRADRAW */
							$qryGetEDRouteId = "SELECT DISTINCT(rf.routeid) edRouteId
												FROM vendingsubgroup vsg,
												routefrequency rf, personlink pl
												WHERE vsg.vendinggroupid = $vgId
												AND rf.routeid = vsg.routeid
												AND  ( rf.endeffdt IS NULL OR rf.endeffdt = '0000-00-00' OR rf.endeffdt > '$dbEffDt')
												AND pl.personid = rf.driverid
												AND pl.locationid = $ASLocationID
												AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00' OR pl.endeffdt > '$dbEffDt' )
												AND pl.role = '$grpCode'";
							if($debug)
								print($qryGetEDRouteId . "<br />\n");
							$rsltGetEDRouteId = mysqli_query(
							$cvtconnection, $qryGetEDRouteId);
							$extraQty = 0;
							if(!$rsltGetEDRouteId) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								while($rowGetEDRouteId = mysqli_fetch_assoc($rsltGetEDRouteId)) {
									$edRouteId = $rowGetEDRouteId[edRouteId];
									if(!is_numeric($edRouteId)) $edRouteId = 0;

									if($edRouteIdStr == "") {
										$edRouteIdStr = $edRouteId;
									}
									else {
										$edRouteIdStr .= ", " . $edRouteId;
									}
									// $extraQty += GetExtraDrawQty($prodId, $edRouteId, $dbEffDt);
								}
							}
							if($edRouteIdStr == "") {
								$edRouteIdStr = 0;
							}

							// HERE LETS GET THE EXTRA PAPERS VALUES
							$qryGetExtra = "SELECT SUM(rda.qtyissued) qtyIssued, SUM(rda.qtysked) qtySked
											FROM routedrawaccounting rda, specificroutes sr
											WHERE rda.clientlocid = $ASLocationID
											AND rda.specificrouteid = sr.recid
											AND rda.actspecificproductid = $spId
											AND sr.dispatchlocid = $ASLocationID
											AND sr.routeid IN (" . $edRouteIdStr . ")
											AND sr.datesked = '$dbEffDt'";

							// FOR SPLITTING OF TABLES
							$qryGetExtra = convertToSplitTables($qryGetExtra, $val_SPLIT);

							if($debug)
								print($qryGetExtra . "<br />\n");
							$rsltGetExtra = mysqli_query( $cvtconnection, $qryGetExtra);

							if(!$rsltGetExtra) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if(mysqli_num_rows($rsltGetExtra) == 0) {
								}
								else {
									$rowGetExtra = mysqli_fetch_assoc($rsltGetExtra);
									$qtyIssued = $rowGetExtra[qtyIssued];
									$qtySked = $rowGetExtra[qtySked];
									ValidateForInt(false, "qtySked", "qtyIssued");
								}
							}

							$extraQty = $qtyIssued - $qtySked;
							if(!is_numeric($extraQty))	$extraQty = 0;
							if($debug) print("spId = $spId :: effDt = $effDt<br />");

							$totExtraQty += $extraQty;
							$grandExtraQty += $extraQty;

							$bndleQty = 0;
							if($bndlCnt != 0) {
								$bndleQty  = (int)(($grpQty + $extraQty)/ $bndlCnt);
							}
							$totBndleQty += $bndleQty;
							$grandBndleQty += $bndleQty;
                                                        
							if($grpQty != 0 || $extraQty != 0) {

								$locIdStr = "";
								if($lsIntPlord == $prodId) {
									while(list($lcKey, $locId) = each($grpInfoArr[LOCSTR])) {
										if($locIdStr == "") {
											$locIdStr = $locId;
										}
										else {
											$locIdStr .= ", " . $locId;
										}
									}
									$dgvDesc = getZone_TRA37($locIdStr, $dbEffDt);
								}

								$htmlStr .= ("<tr class=\"datawhite\">\n");
								$htmlStr .= ("<td align=\"left\"> " . htmlentities($grpDesc, ENT_QUOTES) . "&nbsp;</td>\n");
								if($lsIntPlord == $prodId)
									$htmlStr .= ("<td align=\"left\"> " . htmlentities($dgvDesc, ENT_QUOTES) . "&nbsp;</td>\n");
								$htmlStr .= ("<td align=\"right\">&nbsp;" . $grpQty . "</td>\n");
								$htmlStr .= ("<td align=\"right\">&nbsp;" . $extraQty . "</td>\n");
								$htmlStr .= ("<td align=\"right\">&nbsp;" . $bndleQty . "</td>\n");
								$htmlStr .= ("</tr>\n");
							}
						}

						$htmlStr .= ("<tr class=\"datawhite\">\n");
						$htmlStr .= ("<td align=\"left\"><b>SubTotal</b></td>\n");
						if($lsIntPlord == $prodId)
							$htmlStr .= ("<td>&nbsp;</td>\n");
						$htmlStr .= ("<td align=\"right\"><b>&nbsp;" . $totGrpQty . "</b></td>\n");
						$htmlStr .= ("<td align=\"right\"><b>&nbsp;" . $totExtraQty . "</b></td>\n");
						$htmlStr .= ("<td align=\"right\"><b>&nbsp;" . $totBndleQty . "</b></td>\n");
						$htmlStr .= ("</tr>\n");
					}

					$htmlStr .= ("<tr class=\"datawhite\">\n");
					$htmlStr .= ("<td align=\"left\"><b>GrandTotal </b></td>\n");
					if($lsIntPlord == $prodId)
						$htmlStr .= ("<td>&nbsp;</td>\n");
					$htmlStr .= ("<td align=\"right\"><b>&nbsp;" . $grandGrpQty . "</b></td>\n");
					$htmlStr .= ("<td align=\"right\"><b>&nbsp;" . $grandExtraQty . "</b></td>\n");
					$htmlStr .= ("<td align=\"right\"><b>&nbsp;" . $grandBndleQty . "</b></td>\n");
					$htmlStr .= ("</tr>\n");

					$htmlStr .= ("</table>\n");

				}
				else {
					$htmlStr .= ("<table border=\"1\" width=\"50%\">\n");
					$htmlStr .= ("<tr class=\"datatblhdr\">\n");
					$htmlStr .= ("<td align=\"left\">Group</td>\n");
					if($lsIntPlord == $prodId)
						$htmlStr .= ("<td align=\"left\">Zone</td>\n");
					$htmlStr .= ("<td align=\"right\">Quantity</td>\n");
					$htmlStr .= ("<td align=\"right\">Extra Copies</td>\n");
					$htmlStr .= ("<td align=\"right\">Bundles</td>\n");
					$htmlStr .= ("</tr>\n");

					$grandGrpQty = 0;
					$grandExtraQty = 0;
					while(list($grpId, $grpDetInfoArr) = each($grpInfoArray)) {
						$grpDesc = $grpDetInfoArr[GRPDESC];
						$grpQty = $grpDetInfoArr[GRPQTY];
						$grpCode = $grpDetInfoArr[GRPCODE];
						if(!is_numeric($grpQty))	$grpQty = 0;

						$grandGrpQty += $grpQty;
						$routeIdStr = "";
						while(list($rtKey, $routeId) = each($grpDetInfoArr[ROUTESTR])) {
							if($routeIdStr == "") {
								$routeIdStr = $routeId;
							}
							else {
								$routeIdStr .= ", " . $routeId;
							}
						}

						if($routeIdStr == "") {
							$routeIdStr = "0";
						}

						$edRouteIdStr = "";
						/* NOW WE WILL FIND THE ROUTES FOR EXTRADRAW */
						$qryGetEDRouteId = "SELECT DISTINCT(rf.routeid) edRouteId
											FROM routefrequency rf, personlink pl
											WHERE pl.locationid = $ASLocationID
											AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00'
											OR pl.endeffdt > '$dbEffDt' )
											AND pl.role = '$grpCode'
											AND rf.driverid = pl.personid
											AND ( rf.endeffdt IS NULL OR rf.endeffdt = '0000-00-00'
											OR rf.endeffdt > '$dbEffDt')";
						if($debug)
							print($qryGetEDRouteId . "<br />\n");
						$rsltGetEDRouteId = mysqli_query(
						$cvtconnection, $qryGetEDRouteId);
						$extraQty = 0;
						if(!$rsltGetEDRouteId) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							while($rowGetEDRouteId = mysqli_fetch_assoc($rsltGetEDRouteId)) {
								$edRouteId = $rowGetEDRouteId[edRouteId];
								if(!is_numeric($edRouteId)) $edRouteId = 0;

								if($edRouteIdStr == "") {
									$edRouteIdStr = $edRouteId;
								}
								else {
									$edRouteIdStr .= ", " . $edRouteId;
								}
								//$extraQty += GetExtraDrawQty($prodId, $edRouteId, $dbEffDt);
							}
						}
						if($edRouteIdStr == "") {
							$edRouteIdStr = 0;
						}

						// HERE LETS GET THE EXTRA PAPERS VALUES
						$qryGetExtra = "SELECT SUM(rda.qtyissued) qtyIssued, SUM(rda.qtysked) qtySked
										FROM routedrawaccounting rda, specificroutes sr
										WHERE rda.clientlocid = $ASLocationID
										AND rda.specificrouteid = sr.recid
										AND rda.actspecificproductid = $spId
										AND sr.dispatchlocid = $ASLocationID
										AND sr.routeid IN (" . $edRouteIdStr . ")
										AND sr.datesked = '$dbEffDt'";

						// FOR SPLITTING OF TABLES
						$qryGetExtra = convertToSplitTables($qryGetExtra, $val_SPLIT);

						if($debug)
							print($qryGetExtra . "<br />\n");
						$rsltGetExtra = mysqli_query( $cvtconnection, $qryGetExtra);

						if(!$rsltGetExtra) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if(mysqli_num_rows($rsltGetExtra) == 0) {
							}
							else {
								$rowGetExtra = mysqli_fetch_assoc($rsltGetExtra);
								$qtyIssued = $rowGetExtra[qtyIssued];
								$qtySked = $rowGetExtra[qtySked];
								ValidateForInt(false, "qtySked", "qtyIssued");
							}
						}

						$extraQty = $qtyIssued - $qtySked;
						if(!is_numeric($extraQty))	$extraQty = 0;
						if($debug) print("spId = $spId :: effDt = $effDt<br />");

						$grandExtraQty += $extraQty;
						$bndleQty = 0;
						if($bndlCnt != 0) {
							$bndleQty  = (int) ( ($grpQty + $extraQty) / $bndlCnt );
						}
						$grandBndleQty += $bndleQty;
						$qtyReq += $grpQty;

						if($grpQty != 0 || $extraQty != 0) {
							$locIdStr = "";
							if($lsIntPlord == $prodId) {
								while(list($lcKey, $locId) = each($grpDetInfoArr[LOCSTR])) {
									if($locIdStr == "") {
										$locIdStr = $locId;
									}
									else {
										$locIdStr .= ", " . $locId;
									}
								}
								if($locIdStr == "") $locIdStr = "0";
								$dgvDesc = getZone_TRA37($locIdStr, $dbEffDt);
							}

							$htmlStr .= ("<tr class=\"datawhite\">\n");
							$htmlStr .= ("<td align=\"left\"> " . htmlentities($grpDesc, ENT_QUOTES) . "&nbsp;</td>\n");
							if($lsIntPlord == $prodId)
								$htmlStr .= ("<td align=\"left\"> " . htmlentities($dgvDesc, ENT_QUOTES) . "&nbsp;</td>\n");
							$htmlStr .= ("<td align=\"right\"> &nbsp;" . $grpQty . "</td>\n");
							$htmlStr .= ("<td align=\"right\"> &nbsp;" . $extraQty . "</td>\n");
							$htmlStr .= ("<td align=\"right\"> &nbsp;" . $bndleQty . "</td>\n");
							$htmlStr .= ("</tr>\n");
						}
					}
					$htmlStr .= ("<tr class=\"datawhite\">\n");
					$htmlStr .= ("<td align=\"left\"><b>GrandTotal </b></td>\n");
					if($lsIntPlord == $prodId)
						$htmlStr .= ("<td>&nbsp;</td>\n");
					$htmlStr .= ("<td align=\"right\"><b>&nbsp;" . $grandGrpQty . "</b></td>\n");
					$htmlStr .= ("<td align=\"right\"><b>&nbsp;" . $grandExtraQty . "</b></td>\n");
					$htmlStr .= ("<td align=\"right\"><b>&nbsp;" . $grandBndleQty . "</b></td>\n");
					$htmlStr .= ("</tr>\n");

					$htmlStr .= ("</table>\n");
				}
                                
                                
				print($htmlStr);

				$_SESSION[TRA37DISPHTMLSTR] = $htmlStr;

				print("<br /><a href=\"" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=GroupEmail&spId=$spId&qtyReq=$qtyReq&effDt=$effDt", ENT_QUOTES) . "\">eMail</a>\n");
				print("</div>\n");
				break;

			case "GroupEmail":
				if( isset($_SESSION[TRA37DISPHTMLSTR]) )
					$dispHtmlStr = $_SESSION[TRA37DISPHTMLSTR];

				if($debug)
					print($dispHtmlStr);

				$qryGetInfo1 = "SELECT c.personid, p.email
								FROM product pd, vendorlink vl, locationlink ll,
								company c, person p
								WHERE pd.clientid = $ASCompanyID
								AND pd.recid = $prodId
								AND vl.locationid = pd.vendorlocid
								AND ll.locationid = vl.locationid
								AND c.recid = ll.companyid
								AND p.recid = c.personid";
								
				if($debug)
					print($qryGetInfo1 . "<br />\n");
				$persEmailIdArray = array();
				$rsltGetInfo1 = mysqli_query( $cvtconnection, $qryGetInfo1);
				if(!$rsltGetInfo1) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo1) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo1 = mysqli_fetch_assoc($rsltGetInfo1)) {
							$persEmailId = $rowGetInfo1[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}	

				
				
				$qryGetInfo = "SELECT pl.personid, p.email
								FROM personlink pl, person p, notifyperson np
								WHERE pl.locationid = $ASLocationID
								AND pl.personid = p.recid
								AND pl.recid = np.personlinkid
								AND np.groupcode = 'DIS'
								AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00'
								OR pl.endeffdt > '$dbEffDt' )";

								
				if($debug)
					print($qryGetInfo . "<br />\n");
				//$persEmailIdArray = array();
				$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
				if(!$rsltGetInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
							$persEmailId = $rowGetInfo[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}

				if(COUNT($persEmailIdArray) == 0) {
					$mailMsg = "Email Address - not found for Person <br /><br />";
				}
				else {
					$fileLineNbr = __LINE__; $fromCompName = GetComp($ASCompanyID, $cvtconnection);
					if($debug)
						print("$fromCompName <br />\n");

					$dispDateX = set_date($dbEffDt, "YYYY-MM-DD", "MM/DD/YY");
					$dispDateXSub= date('d-M-Y', strtotime($dbEffDt));
					$prodDesc = $prodDesc . " for " . $dispDateXSub;

					$from = "\"$fromCompName\" <$val_EMLID>";
					$toArr = $persEmailIdArray;
					$subject = $prodDesc;
					$msg = $dispHtmlStr;
					$mail = new htmlMimeMail();

					// SET MESSAGE
					$mail->setHtml($msg);

					// SEND MAIL
					$mail->setFrom($from);
					$mail->setSubject($subject);
					if($mail->send($toArr, "mail")) {
						$qryUp = "UPDATE totaldrawaccounting
									SET qtyrequested = $qtyReq,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE actspecificproductid = $spId";
						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
						}
						$to = implode(', ', $toArr);
						$mailMsg = "Mail Sent to $to";
					}
					else {
						$mailMsg = "Mail Not Sent for Driver Group - Some problem exist";
					}
				}

				include('../cm/html-secondwindow.php');
				print("<div class=\"datawhite\">\n");
				print("<br /><b>$mailMsg</b><br />");
				print("<br /><a href=\"" . htmlspecialchars($Back, ENT_QUOTES) . "\">OK</a>");
				print("</div>\n");
				include('../cm/html-bottom-secondwindow.php');
				break;

			case "RouteGroup":
			
				ValidateForInt(false, "totCalculatedDraw");

				$htmlStr = "";
				$htmlStr .= ("<div class=\"datawhite\">");
				print("<form name=\"level1Form\" method=\"get\" action=\"tra37.php\" style=\"margin: 0;\">\n");
				print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
				print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
				print("<input type=\"hidden\" name=\"spId\" value=\"$spId\" />\n");
				print("<input type=\"hidden\" name=\"effDt\" value=\"$effDt\" />\n");
				print("<input type=\"hidden\" name=\"totCalculatedDraw\" value=\"$totCalculatedDraw\" />\n");

				if(!isset($rdSort) || $rdSort == "")
					$rdSort = "RGS";

				print("<b>Sort : </b>");
				// FOR ROUTE GROUP SEQUENCE
				print("<label for=\"rdRGS\">Route Group Sequence</label>\n");
				print("<input id=\"rdRGS\" type=\"radio\" name=\"rdSort\" value=\"RGS\" onclick=\"this.form.submit();\"");
				if($rdSort == "RGS") {
					print(" checked=\"checked\"");
				}
				print(" />\n");
				print("&nbsp;&nbsp;&nbsp;&nbsp;");

				// FOR ROUTE GROUP NUMBER
				print("<label for=\"rdRGN\">Route Group</label>\n");
				print("<input id=\"rdRGN\" type=\"radio\" name=\"rdSort\" value=\"RGN\" onclick=\"this.form.submit();\"");
				if($rdSort == "RGN") {
					print(" checked=\"checked\"");
				}
				print(" />\n");
				print("<br /><br />\n");
				print("</form>\n");

				$dowEffDt = strtoupper(date("D", mktime(0, 0, 0, substr($dbEffDt, 5, 2), substr($dbEffDt, 8, 2), substr($dbEffDt, 0, 4))));

				// FOR HEADER
				$dispDateX = set_date($dbEffDt, "YYYY-MM-DD", "MM/DD/YY");
				$prodDesc = $prodDesc . " - " . $dispDateX;
				$htmlStr .= ("<b> Group - " . htmlentities($prodDesc, ENT_QUOTES) . "</b><br /><br />\n");
				reset($qtyArray);

				if($val_REGIN == "G") {
					// QRY TO GET ROUTEGROUP RECORDS REGION WISE
					/*$qryGetLocGroup = "SELECT sr.locationid custLocId, rg.recid rtGrpId,
										rg.groupsdesc grpDesc, rg.subgroupsdesc subGrpDesc,
										CONCAT_WS(' - ', NULLIF(rg.groupsdesc, ''), NULLIF(rg.subgroupsdesc, '')) strGroupDesc,
										rgl.routeid routeId, vsg.vendinggroupid vgId, IF(vsg.vendinggroupid = 0 OR vsg.vendinggroupid IS NULL , 'Z', vg.sdesc) vgDesc,
										IF(sr.normalroute = 'Y', 'Yes', 'No') normalRt
										FROM routegroup rg, routegrouplink rgl, standardroutes sr, location l
										LEFT JOIN vendingsubgroup vsg ON vsg.recid = l.subgroupid
										LEFT JOIN vendinggroup vg ON vg.recid = vsg.vendinggroupid
										WHERE rg.clientlocid = $ASLocationID
										AND rg.type = 'D'
										AND ( rg.endeffdt IS NULL OR rg.endeffdt = '0000-00-00'
										OR rg.endeffdt > '$dbEffDt')
										AND rgl.clientlocid = $ASLocationID
										AND rgl.routegroupid = rg.recid
										AND sr.routeid = rgl.routeid
										AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00' OR sr.endeffdt > '$dbEffDt')
										AND l.recid = sr.locationid
										AND l.type != 'G'
										GROUP BY sr.recid, routeId, vgId, rtGrpId";*/

					// QRY TO GET ROUTEGROUP RECORDS REGION WISE
					$qryGetLocGroup = "SELECT ta.customerlocid custLocId,
										ta.specificrouteid srId,  rg.recid rtGrpId, SUM(actquantity) actQty, rg.groupsdesc grpDesc, rg.subgroupsdesc subGrpDesc,
										CONCAT_WS(' - ', NULLIF(rg.groupsdesc, ''), NULLIF(rg.subgroupsdesc, '')) strGroupDesc,
										spr.routeid routeId, vsg.vendinggroupid vgId, IF(vsg.vendinggroupid = 0 OR vsg.vendinggroupid IS NULL , 'Z', vg.sdesc) vgDesc

										FROM transactivity ta, specificroutes spr, routegroup rg, routegrouplink rgl, location l
										LEFT JOIN vendingsubgroup vsg ON vsg.recid = l.subgroupid
										LEFT JOIN vendinggroup vg ON vg.recid = vsg.vendinggroupid

										WHERE  ta.locationid = $ASLocationID
										AND ta.type = 'SD'
										AND ta.datet = '$dbEffDt'
										AND ta.specificproductid = $spId
										AND spr.recid = ta.specificrouteid
										AND l.recid = ta.customerlocid
										AND l.type != 'G'
										AND rg.clientlocid = $ASLocationID
										AND rg.type = 'D'
										AND ( rg.endeffdt IS NULL OR rg.endeffdt = '0000-00-00'
										OR rg.endeffdt > '$dbEffDt')
										AND rgl.clientlocid = $ASLocationID
										AND rgl.routegroupid = rg.recid
										AND rgl.routeid = spr.routeid
										GROUP BY custLocId, srId, vgId, rtGrpId";

					if($rdSort == "RGS") {
						$qryGetLocGroup .= " ORDER BY vgDesc, rg.sortseqnbr";
					}
					else {
						$qryGetLocGroup .= " ORDER BY vgDesc, strGroupDesc";
					}

					// FOR SPLITTING OF TABLES
					$qryGetLocGroup = convertToSplitTables($qryGetLocGroup, $val_SPLIT);

					if($debug)
						print($qryGetLocGroup . "<br />\n");
					$rsltGetLocGroup = mysqli_query( $cvtconnection, $qryGetLocGroup);


					if(!$rsltGetLocGroup) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						
						$vgGrpInfoArray = array();
						if(mysqli_num_rows($rsltGetLocGroup) != 0) {
						
							while($rowGetLocGroup = mysqli_fetch_assoc($rsltGetLocGroup)) {
								$custLocId = $rowGetLocGroup[custLocId];
								$rtGrpId = $rowGetLocGroup[rtGrpId];
								$grpDesc = $rowGetLocGroup[grpDesc];
								$subGrpDesc = $rowGetLocGroup[subGrpDesc];
								$strGroupDesc = $rowGetLocGroup[strGroupDesc];
								$routeId = $rowGetLocGroup[routeId];
								$vgId = $rowGetLocGroup[vgId];
								$vgDesc = $rowGetLocGroup[vgDesc];
								$srId = $rowGetLocGroup[srId];
								$actQty = $rowGetLocGroup[actQty];

								ValidateForInt(false, "custLocId", "rtGrpId", "routeId", "vgId");

								$grpQty = $actQty;
								if(!is_numeric($grpQty)) $grpQty = 0;

								if(!is_array($vgGrpInfoArray[$vgId])) {
									$vgGrpInfoArray[$vgId] = array(
										"VGDESC" => $vgDesc,
										"GRP" => array()
									);
								}

								if(!isset($vgGrpInfoArray[$vgId][GRP][$rtGrpId])) {
									$vgGrpInfoArray[$vgId][GRP][$rtGrpId] = array(
										"GRPSDESC" => $grpDesc,
										"SUBGRPSDESC" => $subGrpDesc,
										"STRGRPDESC" => $strGroupDesc,
										"GRPQTY" => 0,
										"EDITION" =>  array()
									);
								}

								$vgGrpInfoArray[$vgId][GRP][$rtGrpId][GRPQTY] += $grpQty;

								if(!is_array($vgGrpInfoArray[$vgId][GRP][$rtGrpId][LOCSTR])) {
									$vgGrpInfoArray[$vgId][GRP][$rtGrpId][LOCSTR] = array();
								}
								if($lsIntPlord == $prodId) {
									if(!in_array($custLocId, $vgGrpInfoArray[$vgId][GRP][$rtGrpId][LOCSTR])) {
										array_push($vgGrpInfoArray[$vgId][GRP][$rtGrpId][LOCSTR], $custLocId);
									}
								}

								if(!is_array($vgGrpInfoArray[$vgId][GRP][$rtGrpId][ROUTESTR])) {
									$vgGrpInfoArray[$vgId][GRP][$rtGrpId][ROUTESTR] = array();
								}

								if(!in_array($routeId, $vgGrpInfoArray[$vgId][GRP][$rtGrpId][ROUTESTR])) {
									array_push($vgGrpInfoArray[$vgId][GRP][$rtGrpId][ROUTESTR], $routeId);
								}

								if($val_EDITN == 'Y') {
									// HERE FETCH THE EDITION FOR THE CUSTOMER LOCATION
									$fileLineNbr = __LINE__; $editionArr = getEditionDesc_EDTFUNC($custLocId, $prodId, $dbEffDt);

									$editionId = $editionArr[editionId];
									$editionDesc = $editionArr[editionDesc];
									if(!is_numeric($editionId))	$editionId = 0;

									if($editionId != 0) {
										if(!is_array($vgGrpInfoArray[$vgId][GRP][$rtGrpId][EDITION][$editionId])) {
											$vgGrpInfoArray[$vgId][GRP][$rtGrpId][EDITION][$editionId] = array(
												"EDITIONDESC" => $editionDesc,
												"EDITIONQTY" => 0
											);
										}
										$vgGrpInfoArray[$vgId][GRP][$rtGrpId][EDITION][$editionId][EDITIONQTY] += $grpQty;
									}
								}
							}
						}
					}

					if($debug) {
						print("<pre style=\"text-align : left\">");
						print_r($vgGrpInfoArray);
						print("</pre>\n");
					}
				}
				else {
					// QRY TO GET THE ROUTEGROUP RECORDS
					/*$qryGetLocGroup = "SELECT sr.locationid custLocId, rg.recid rtGrpId,
										rg.groupsdesc grpDesc, rg.subgroupsdesc subGrpDesc,
										CONCAT_WS(' - ', NULLIF(rg.groupsdesc, ''), NULLIF(rg.subgroupsdesc, '')) strGroupDesc,
										rgl.routeid routeId, IF(sr.normalroute = 'Y', 'Yes', 'No') normalRt
										FROM routegroup rg, routegrouplink rgl, standardroutes sr, location l
										WHERE rg.clientlocid = $ASLocationID
										AND rg.type = 'D'
										AND ( rg.endeffdt IS NULL OR rg.endeffdt = '0000-00-00' OR rg.endeffdt > '$dbEffDt')
										AND rgl.clientlocid = $ASLocationID
										AND rgl.routegroupid = rg.recid
										AND sr.routeid = rgl.routeid
										AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00' OR sr.endeffdt > '$dbEffDt')
										AND l.recid = sr.locationid
										AND l.type != 'G'
										GROUP BY sr.recid, routeId, rtGrpId";*/

					// QRY TO GET ROUTEGROUP RECORDS REGION WISE
					$qryGetLocGroup = "SELECT ta.customerlocid custLocId,
										ta.specificrouteid srId,  rg.recid rtGrpId, SUM(ta.actquantity) actQty, rg.groupsdesc grpDesc, rg.subgroupsdesc subGrpDesc,
										CONCAT_WS(' - ', NULLIF(rg.groupsdesc, ''), NULLIF(rg.subgroupsdesc, '')) strGroupDesc,
										spr.routeid routeId
										FROM transactivity ta, specificroutes spr, routegroup rg, routegrouplink rgl, location l

										WHERE  ta.locationid = $ASLocationID
										AND ta.type = 'SD'
										AND ta.specificproductid = $spId
										AND ta.datet = '$dbEffDt'
										AND spr.recid = ta.specificrouteid
										AND l.recid = ta.customerlocid
										AND l.type != 'G'
										AND rg.clientlocid = $ASLocationID
										AND rg.type = 'D'
										AND ( rg.endeffdt IS NULL OR rg.endeffdt = '0000-00-00'
										OR rg.endeffdt > '$dbEffDt')
										AND rgl.clientlocid = $ASLocationID
										AND rgl.routegroupid = rg.recid
										AND rgl.routeid = spr.routeid
										GROUP BY custLocId, srId, rtGrpId";

					if($rdSort == "RGS") {
						$qryGetLocGroup .= " ORDER BY rg.sortseqnbr";
					}
					else {
						$qryGetLocGroup .= " ORDER BY strGroupDesc";
					}

					$qryGetLocGroup = convertToSplitTables($qryGetLocGroup, $val_SPLIT);

					if($debug)
						print($qryGetLocGroup . "<br />\n");
					$rsltGetLocGroup = mysqli_query( $cvtconnection, $qryGetLocGroup);
					$grpInfoArray = array();
					if(!$rsltGetLocGroup) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						
						if(mysqli_num_rows($rsltGetLocGroup) != 0) {
							while($rowGetLocGroup = mysqli_fetch_assoc($rsltGetLocGroup)) {
								$custLocId = $rowGetLocGroup[custLocId];

								$rtGrpId = $rowGetLocGroup[rtGrpId];
								$grpDesc = $rowGetLocGroup[grpDesc];
								$subGrpDesc = $rowGetLocGroup[subGrpDesc];
								$strGroupDesc = $rowGetLocGroup[strGroupDesc];
								$routeId = $rowGetLocGroup[routeId];
								$srId = $rowGetLocGroup[srId];
								$actQty = $rowGetLocGroup[actQty];

								ValidateForInt(false, "custLocId", "rtGrpId", "routeId");

								$grpQty = $actQty;
								if(!is_numeric($grpQty)) $grpQty = 0;

								if(!isset($grpInfoArray[$rtGrpId])) {
									$grpInfoArray[$rtGrpId] = array(
										"GRPSDESC" => $grpDesc,
										"SUBGRPSDESC" => $subGrpDesc,
										"STRGRPDESC" => $strGroupDesc,
										"GRPQTY" => 0,
										"EDITION" =>  array()
									);
								}

								$grpInfoArray[$rtGrpId][GRPQTY] += $grpQty;

								if(!is_array($grpInfoArray[$rtGrpId][LOCSTR])) {
									$grpInfoArray[$rtGrpId][LOCSTR] = array();
								}
								if($lsIntPlord == $prodId) {
									if(!in_array($custLocId, $grpInfoArray[$rtGrpId][LOCSTR])) {
										array_push($grpInfoArray[$rtGrpId][LOCSTR], $custLocId);
									}
								}

								if(!is_array($grpInfoArray[$rtGrpId][ROUTESTR])) {
									$grpInfoArray[$rtGrpId][ROUTESTR] = array();
								}

								if(!in_array($routeId, $grpInfoArray[$rtGrpId][ROUTESTR])) {
									array_push($grpInfoArray[$rtGrpId][ROUTESTR], $routeId);
								}

								if($val_EDITN == 'Y') {
									// HERE FETCH THE EDITION FOR THE CUSTOMER LOCATION
									$editionArr = getEditionDesc_EDTFUNC($custLocId, $prodId, $dbEffDt);

									$editionId = $editionArr[editionId];
									$editionDesc = $editionArr[editionDesc];
									if(!is_numeric($editionId))	$editionId = 0;

									if($editionId != 0) {
										if(!is_array($grpInfoArray[$rtGrpId][EDITION][$editionId])) {
											$grpInfoArray[$rtGrpId][EDITION][$editionId] = array(
												"EDITIONDESC" => $editionDesc,
												"EDITIONQTY" => 0
											);
										}
										$grpInfoArray[$rtGrpId][EDITION][$editionId][EDITIONQTY] += $grpQty;
									}
								}
							}
						}
					}
					if($debug) {
						print("<pre style=\"text-align : left\">");
						print_r($grpInfoArray);
						print("</pre>\n");
					}
				}

				$qtyReq = 0;
				if($val_REGIN == "G") {

					if($val_EDITN == 'Y') {
						$dispEditionArr = array();
						$dispTotEditionArr = array();
						while(list($vgId, $vgInfoArr) = each($vgGrpInfoArray)) {
							while(list($rtGrpId, $grpInfoArr) = each($vgInfoArr[GRP])) {
								while(list($editionId, $editionArr) = each($grpInfoArr[EDITION])) {
									if(!in_array($editionId, $dispEditionArr)) {
										array_push($dispEditionArr, $editionId);
									}
								}
							}
						}
						if(isset($vgGrpInfoArray))
							reset($vgGrpInfoArray);
						ksort($dispEditionArr);
					}

					$htmlStr .= ("<table border=\"1\" width=\"50%\">\n");
					$htmlStr .= ("<tr class=\"datatblhdr\">\n");
					$htmlStr .= ("<td align=\"left\">Group</td>\n");
					if($lsIntPlord == $prodId)
						$htmlStr .= ("<td align=\"left\">Zone</td>\n");
					$htmlStr .= ("<td align=\"right\">Quantity</td>\n");
					$htmlStr .= ("<td align=\"right\">Extra Copies</td>\n");

					if($val_EDITN == 'Y') {
						$editionCnt = 0;
						while(list($key, $editionId) = each($dispEditionArr)) {
							$fileLineNbr = __LINE__; $editionDesc = GetDescription("edition", $editionId, "sdesc");
							$htmlStr .= ("<td align=\"right\">" . ($editionDesc != "" ? htmlentities($editionDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");
							$editionCnt++;
						}
						if(isset($dispEditionArr))
							reset($dispEditionArr);

						$htmlStr .= ("<td align=\"right\">Non-Edition</td>\n");
						$editionCnt++;
					}
					$htmlStr .= ("<td align=\"right\">Bundles</td>\n");
					$htmlStr .= ("<td align=\"right\">Loose</td>\n");
					$htmlStr .= ("</tr>\n");

					$grandGrpQty = 0;
					$grandEditionGrpQty = 0;
					$nonGrandEditionQty = 0;
					$grandBndleQty = 0;
					$grandExtraQty = 0;
					$grantLooseQty = 0;
					while(list($vgId, $vgInfoArr) = each($vgGrpInfoArray)) {

						$colSpan = 5 + $editionCnt;
						if($lsIntPlord == $prodId) $colSpan = 6 + $editionCnt;

						$vgDesc = $vgInfoArr[VGDESC];
						if($vgDesc == "Z") {
							$vgDesc = "No Region Defined";
						}
						$htmlStr .= ("<tr class=\"datawhite\">\n");
						$htmlStr .= ("<td align=\"left\" colspan=\"" . $colSpan . "\"><b>" . ($vgDesc != "" ? htmlentities($vgDesc, ENT_QUOTES) : "&nbsp;") . "</b></td>\n");
						$htmlStr .= ("</tr>\n");
						if(!is_numeric($vgId))	$vgId = 0;

						$totGrpQty = 0;
						$totEditionGrpQty = 0;
						$nonTotEditionQty = 0;
						$totBndleQty = 0;
						$totExtraQty = 0;
						$totLooseQty = 0;

						if($val_EDITN == 'Y') {
							while(list($key, $editionId) = each($dispEditionArr)) {
								if(is_array($dispTotEditionArr[$editionId])) {
									$dispTotEditionArr[$editionId][TOTEDITQTY] = 0;
								}
							}
							if(isset($dispEditionArr))
								reset($dispEditionArr);
						}

						while(list($rtGrpId, $grpInfoArr) = each($vgInfoArr[GRP])) {
							$grpSDesc = $grpInfoArr[GRPSDESC];
							$subGrpSDesc = $grpInfoArr[SUBGRPSDESC];
							$strGroupDesc = $grpInfoArr[STRGRPDESC];
							$grpQty = $grpInfoArr[GRPQTY];

							$totGrpQty += $grpQty;
							$grandGrpQty += $grpQty;
							$qtyReq += $grpQty;

							$edRouteIdStr = "";

							if($vgId == 0) {
								$qryGetEDRouteId = "SELECT DISTINCT(rgl.routeid) edRouteId
													FROM routegrouplink rgl
													WHERE rgl.clientlocid = $ASLocationID
													AND rgl.routegroupid = $rtGrpId";
							}
							else {
								// NOW WE WILL FIND THE ROUTES FOR EXTRADRAW
								$qryGetEDRouteId = "SELECT DISTINCT(rgl.routeid) edRouteId
													FROM routegrouplink rgl, vendingsubgroup vsg
													WHERE rgl.clientlocid = $ASLocationID
													AND rgl.routegroupid = $rtGrpId
													AND vsg.routeid = rgl.routeid
													AND vsg.vendinggroupid = $vgId";
							}
							if($debug)
								print($qryGetEDRouteId . "<br />\n");
							$rsltGetEDRouteId = mysqli_query(
							$cvtconnection, $qryGetEDRouteId);
							$extraQty = 0;
							if(!$rsltGetEDRouteId) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								while($rowGetEDRouteId = mysqli_fetch_assoc($rsltGetEDRouteId)) {
									$edRouteId = $rowGetEDRouteId[edRouteId];
									if(!is_numeric($edRouteId)) $edRouteId = 0;
									if($edRouteIdStr == "") {
										$edRouteIdStr = $edRouteId;
									}
									else {
										$edRouteIdStr .= ", " . $edRouteId;
									}
								}
							}
							if($edRouteIdStr == "") {
								$edRouteIdStr = 0;
							}

							$editionArr = array();
							// HERE LETS GET THE EXTRA PAPERS VALUES
							$qryGetExtra = "SELECT
											SUM(rda.qtyissued) qtyIssued,
											SUM(rda.qtysked) qtySked, rda.editionid editionId
											FROM routedrawaccounting rda, specificroutes sr
											WHERE rda.clientlocid = $ASLocationID
											AND rda.specificrouteid = sr.recid
											AND rda.actspecificproductid = $spId
											AND sr.dispatchlocid = $ASLocationID
											AND sr.routeid IN (" . $edRouteIdStr . ")
											AND sr.datesked = '$dbEffDt'
											GROUP BY rda.editionid";

							// FOR SPLITTING OF TABLES
							$qryGetExtra = convertToSplitTables($qryGetExtra, $val_SPLIT);

							if($debug)
								print($qryGetExtra . "<br />\n");
							$rsltGetExtra = mysqli_query( $cvtconnection, $qryGetExtra);
							if(!$rsltGetExtra) {

								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {

								if(mysqli_num_rows($rsltGetExtra) == 0) {
									$qtyIssuedTot = 0;
									$qtySkedTot = 0;
								}
								else {
									$qtyIssuedTot = 0;
									$qtySkedTot = 0;
									while($rowGetExtra = mysqli_fetch_assoc($rsltGetExtra)) {
										$editionId = $rowGetExtra[editionId];
										$qtyIssued = $rowGetExtra[qtyIssued];
										$qtySked = $rowGetExtra[qtySked];
										ValidateForInt(false, "qtySked", "qtyIssued", "editionId");

										$qtyIssuedTot += $qtyIssued;
										$qtySkedTot += $qtySked;

										if($editionId != 0 && $editionId != 1 && $editionId != 2) {
											if(!is_array($editionArr[$editionId])) {
												$editionArr[$editionId] = array(
													"EDITIONQTY" => 0
												);
											}

											$tempExtraDraw =  $qtyIssued - $qtySked;
											$editionArr[$editionId][EDITIONQTY] = $tempExtraDraw;
										}
										elseif($editionId == 1) {

											// HERE WE NEED TO FETCH THE QUANTITIES FROM RDAEXTRADRAWSPLIT
											$qryGetRdaExtraDraw = "SELECT res.editionid rdaEditionId, res.quantity rdaExtraQty
																FROM rdaextradrawsplit res, specificroutes sr
																WHERE res.clientlocid = $ASLocationID
																AND res.specificproductid = $spId
																AND res.specificrouteid = sr.recid
																AND sr.dispatchlocid = $ASLocationID
																AND sr.routeid IN (" . $edRouteIdStr . ")
																AND sr.datesked = '$dbEffDt'
																GROUP BY res.editionid";

											$qryGetRdaExtraDraw = convertToSplitTables($qryGetRdaExtraDraw, $val_SPLIT);

											if($debug)
												print($qryGetRdaExtraDraw . "<br />\n");
											$rsltGetRdaExtraDraw = mysqli_query( $cvtconnection, $qryGetRdaExtraDraw);
											if(!$rsltGetRdaExtraDraw) {
												$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
												print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
												unset($fileLineNbr);
											}
											else {
												if(mysqli_num_rows($rsltGetRdaExtraDraw) == 0) {
												}
												else {
													while($rowGetRdaExtraDraw = mysqli_fetch_assoc($rsltGetRdaExtraDraw)) {
														$rdaEditionId = $rowGetRdaExtraDraw[rdaEditionId];
														$rdaExtraQty = $rowGetRdaExtraDraw[rdaExtraQty];

														ValidateForInt(false, "rdaEditionId", "rdaExtraQty");

														if(!is_array($editionArr[$rdaEditionId])) {
															$editionArr[$rdaEditionId] = array(
																"EDITIONQTY" => 0
															);

														}

														$editionArr[$rdaEditionId][EDITIONQTY] = $rdaExtraQty;
													}
												}
											}
										}
									}
								}
							}

							if($debug) {
								print("<pre style=\"text-align : left\">");
								print_r($editionArr);
								print("</pre>\n");
							}

							$extraQty = $qtyIssuedTot - $qtySkedTot;
							if(!is_numeric($extraQty))	$extraQty = 0;

							$totExtraQty += $extraQty;
							$grandExtraQty += $extraQty;

							// DISPLAY THE GROUPS, IF QUANTITY IS NOT NULL
							if($grpQty != 0 || $extraQty != 0) {


								$htmlStr .= ("<tr class=\"datawhite\">\n");
								if($val_RTGRP == "S") {
									$htmlStr .= ("<td align=\"left\"> " . ($strGroupDesc != "" ?  htmlentities($strGroupDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");
								}
								else {
									$htmlStr .= ("<td align=\"left\"> " . ($subGrpSDesc != "" ?  htmlentities($subGrpSDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");
								}

								$locIdStr = "";
								if($lsIntPlord == $prodId) {
									// FIND THE ZONE HERE
									while(list($lcKey, $locId) = each($grpInfoArr[LOCSTR])) {
										if($locIdStr == "") {
											$locIdStr = $locId;
										}
										else {
											$locIdStr .= ", " . $locId;
										}
									}
									$dgvDesc = getZone_TRA37($locIdStr, $dbEffDt);

									$htmlStr .= ("<td align=\"left\"> " . ($dgvDesc != "" ?  htmlentities($dgvDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");
								}

								$htmlStr .= ("<td align=\"right\">" . $grpQty . "</td>\n");
								$htmlStr .= ("<td align=\"right\">" . $extraQty . "</td>\n");

								if($val_EDITN == 'Y') {

									$nonEditionQty = 0;
									$subEditionQty = 0;
									while(list($key, $editionId) = each($dispEditionArr)) {
										$editionQty = $grpInfoArr[EDITION][$editionId][EDITIONQTY];
										if(!is_numeric($editionQty)) $editionQty = 0;

										// FIRST WE NEED TO FETCH ANY EXTRA COPIES FOR EDITION
										$rdaExtraQty = 0;
										if(is_array($editionArr[$editionId])) {
											$rdaExtraQty = $editionArr[$editionId][EDITIONQTY];
											$editionQty += $rdaExtraQty;
										}

										$htmlStr .= ("<td align=\"right\">" . $editionQty . "</td>\n");

										$subEditionQty += $editionQty;
										$totEditionGrpQty += $editionQty;
										$grandEditionGrpQty += $editionQty;

										// HERE WE NEED TO STORE THE TOTAL EDITION
										if(!is_array($dispTotEditionArr[$editionId])) {
											$dispTotEditionArr[$editionId] =  array(
												"TOTEDITQTY" => 0,
												"GRANDEDITQTY" => 0
											);
										}
										$dispTotEditionArr[$editionId][TOTEDITQTY] += $editionQty;
										$dispTotEditionArr[$editionId][GRANDEDITQTY] += $editionQty;

									}
									if(isset($dispEditionArr))
										reset($dispEditionArr);

									$nonEditionQty = ($grpQty + $extraQty) - $subEditionQty;

									$nonTotEditionQty += $nonEditionQty;
									$nonGrandEditionQty += $nonEditionQty;
									$htmlStr .= ("<td align=\"right\">" . $nonEditionQty . "</td>\n");
								}

								$bndleQty = 0;
								if($bndlCnt != 0) {
									//echo "<br>nonEditionQty ".$nonEditionQty;
									//echo "\n extraQty ".$extraQty;
									//echo "\n bndlCnt ".$bndlCnt;
									if($val_EDITN == 'Y') {
										//echo "in if";
										$bndleQty  = (int)(($nonEditionQty)/ $bndlCnt);
									}
									else {
										//echo "in else";
										$bndleQty  = (int)(($grpQty + $extraQty )/ $bndlCnt);
									}
								}
								$totBndleQty += $bndleQty;
								$grandBndleQty += $bndleQty;
								$htmlStr .= ("<td align=\"right\">" . $bndleQty . "</td>\n");

								$looseQty = 0;
								if($bndlCnt != 0) {
									// LETS CALCULATE THE LOOSE QUANTITY HERE
								
									if($val_EDITN == 'Y') {
										$looseQty = (($nonEditionQty) % $bndlCnt);
									}
									else {
										$looseQty = (($grpQty + $extraQty) % $bndlCnt);
									}


								}
								$totLooseQty += $looseQty;
								$grantLooseQty += $looseQty;
								$htmlStr .= ("<td align=\"right\">" . $looseQty . "</td>\n");
								$htmlStr .= ("</tr>\n");
							}
						}
						// FOR SUB TOTAL
						$htmlStr .= ("<tr class=\"datawhite\">\n");
						$htmlStr .= ("<td align=\"left\"><b>SubTotal</b></td>\n");
						if($lsIntPlord == $prodId)
							$htmlStr .= ("<td>&nbsp;</td>\n");
						$htmlStr .= ("<td align=\"right\"><b>" . $totGrpQty . "</b></td>\n");
						$htmlStr .= ("<td align=\"right\"><b>" . $totExtraQty . "</b></td>\n");
						if($val_EDITN == 'Y') {
							while(list($key, $editionId) = each($dispEditionArr)) {
								if(is_array($dispTotEditionArr[$editionId])) {
									$totEditionGrpQty = $dispTotEditionArr[$editionId][TOTEDITQTY];
								}
								$htmlStr .= ("<td align=\"right\"><b>" . $totEditionGrpQty . "</b></td>\n");
							}
							if(isset($dispEditionArr))
								reset($dispEditionArr);
							$htmlStr .= ("<td align=\"right\"><b>" . $nonTotEditionQty . "</b></td>\n");
						}
						$htmlStr .= ("<td align=\"right\"><b>" . $totBndleQty . "</b></td>\n");
						$htmlStr .= ("<td align=\"right\"><b>" . $totLooseQty . "</b></td>\n");
						$htmlStr .= ("</tr>\n");
					}

					// FOR GRAND TOTAL
					$htmlStr .= ("<tr class=\"datawhite\">\n");
					$htmlStr .= ("<td align=\"left\"><b>GrandTotal </b></td>\n");
					if($lsIntPlord == $prodId)
						$htmlStr .= ("<td>&nbsp;</td>\n");
					$htmlStr .= ("<td align=\"right\"><b>" . $grandGrpQty . "</b></td>\n");
					$htmlStr .= ("<td align=\"right\"><b>" . $grandExtraQty . "</b></td>\n");
					if($val_EDITN == 'Y') {
						while(list($key, $editionId) = each($dispEditionArr)) {
							if(is_array($dispTotEditionArr[$editionId])) {
								$grandEditionGrpQty = $dispTotEditionArr[$editionId][GRANDEDITQTY];
							}
							$htmlStr .= ("<td align=\"right\"><b>" . $grandEditionGrpQty . "</b></td>\n");
						}
						if(isset($dispEditionArr))
							reset($dispEditionArr);

						$htmlStr .= ("<td align=\"right\"><b>" . $nonGrandEditionQty . "</b></td>\n");
					}
					$htmlStr .= ("<td align=\"right\"><b>" . $grandBndleQty . "</b></td>\n");
					$htmlStr .= ("<td align=\"right\"><b>" . $grantLooseQty . "</b></td>\n");
					$htmlStr .= ("</tr>\n");
					$htmlStr .= ("</table>\n");
				}
				else {

					if($val_EDITN == 'Y') {
						$dispEditionArr = array();
						$dispTotEditionArr = array();
						while(list($rtGrpId, $infoArr) = each($grpInfoArray)) {
							while(list($editionId, $editionArr) = each($infoArr[EDITION])) {
								if(!in_array($editionId, $dispEditionArr)) {
									array_push($dispEditionArr, $editionId);
								}
							}
						}

						if(isset($grpInfoArray))
							reset($grpInfoArray);
						ksort($dispEditionArr);
					}
					$htmlStr .= ("<table border=\"1\" width=\"50%\">\n");
					$htmlStr .= ("<tr class=\"datatblhdr\">\n");
					$htmlStr .= ("<td align=\"left\">Group</td>\n");
					if($lsIntPlord == $prodId)
						$htmlStr .= ("<td align=\"left\">Zone</td>\n");
					$htmlStr .= ("<td align=\"right\">Quantity</td>\n");
					$htmlStr .= ("<td align=\"right\">Extra Copies</td>\n");

					if($val_EDITN == 'Y') {
						$editionCnt = 0;
						while(list($key, $editionId) = each($dispEditionArr)) {
							$editionDesc = GetDescription("edition", $editionId, "sdesc");
							$htmlStr .= ("<td align=\"right\">" . ($editionDesc != "" ? htmlentities($editionDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");
							$editionCnt++;
						}
						if(isset($dispEditionArr))
							reset($dispEditionArr);

						$htmlStr .= ("<td align=\"right\">Non-Edition</td>\n");
						$editionCnt++;
					}

					$htmlStr .= ("<td align=\"right\">Bundles</td>\n");
					$htmlStr .= ("<td align=\"right\">Loose</td>\n");
					$htmlStr .= ("</tr>\n");

					$grandGrpQty = 0;
					$grandEditionGrpQty = 0;
					$grandExtraQty = 0;
					$grantLooseQty = 0;
					while(list($rtGrpId, $grpDetInfoArr) = each($grpInfoArray)) {
						$grpSDesc = $grpDetInfoArr[GRPSDESC];
						$subGrpSDesc = $grpDetInfoArr[SUBGRPSDESC];
						$strGroupDesc = $grpDetInfoArr[STRGRPDESC];
						$grpQty = $grpDetInfoArr[GRPQTY];

						ValidateForInt(false, "grpQty", "rtGrpId");

						$grandGrpQty += $grpQty;
						$edRouteIdStr = "";
						// NOW WE WILL FIND THE ROUTES FOR EXTRADRAW
						$qryGetEDRouteId = "SELECT DISTINCT(rgl.routeid) edRouteId
											FROM routegrouplink rgl
											WHERE rgl.clientlocid = $ASLocationID
											AND rgl.routegroupid = $rtGrpId";

						if($debug)
							print($qryGetEDRouteId . "<br />\n");
						$rsltGetEDRouteId = mysqli_query( $cvtconnection, $qryGetEDRouteId);
						$extraQty = 0;
						if(!$rsltGetEDRouteId) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							while($rowGetEDRouteId = mysqli_fetch_assoc($rsltGetEDRouteId)) {
								$edRouteId = $rowGetEDRouteId[edRouteId];
								if(!is_numeric($edRouteId)) $edRouteId = 0;
								if($edRouteIdStr == "") {
									$edRouteIdStr = $edRouteId;
								}
								else {
									$edRouteIdStr .= ", " . $edRouteId;
								}
							}
						}
						if($edRouteIdStr == "") {
							$edRouteIdStr = 0;
						}

						$editionArr = array();
						// HERE LETS GET THE EXTRA PAPERS VALUES
						$qryGetExtra = "SELECT
										SUM(rda.qtyissued) qtyIssued,
										SUM(rda.qtysked) qtySked, rda.editionid editionId
										FROM routedrawaccounting rda, specificroutes sr
										WHERE rda.clientlocid = $ASLocationID
										AND rda.specificrouteid = sr.recid
										AND rda.actspecificproductid = $spId
										AND sr.dispatchlocid = $ASLocationID
										AND sr.routeid IN (" . $edRouteIdStr . ")
										AND sr.datesked = '$dbEffDt'
										GROUP BY rda.editionid";

						// FOR SPLITTING OF TABLES
						$qryGetExtra = convertToSplitTables($qryGetExtra, $val_SPLIT);

						if($debug)
							print($qryGetExtra . "<br />\n");
						$rsltGetExtra = mysqli_query( $cvtconnection, $qryGetExtra);

						if(!$rsltGetExtra) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if(mysqli_num_rows($rsltGetExtra) == 0) {
								$qtyIssuedTot = 0;
								$qtySkedTot = 0;
							}
							else {
								$qtyIssuedTot = 0;
								$qtySkedTot = 0;
								while($rowGetExtra = mysqli_fetch_assoc($rsltGetExtra)) {
									$tempExtraDraw = 0;

									$qtyIssued = $rowGetExtra[qtyIssued];
									$qtySked = $rowGetExtra[qtySked];
									$editionId = $rowGetExtra[editionId];
									ValidateForInt(false, "qtySked", "qtyIssued", "editionId");

									$qtyIssuedTot += $qtyIssued;
									$qtySkedTot += $qtySked ;

									if($editionId != 0 && $editionId != 1 && $editionId != 2) {
										if(!is_array($editionArr[$editionId])) {
											$editionArr[$editionId] = array(
												"EDITIONQTY" => 0
											);
										}

										$tempExtraDraw =  $qtyIssued - $qtySked;
										$editionArr[$editionId][EDITIONQTY] = $tempExtraDraw;
									}
									elseif($editionId == 1) {

										// HERE WE NEED TO FETCH THE QUANTITIES FROM RDAEXTRADRAWSPLIT
										$qryGetRdaExtraDraw = "SELECT res.editionid rdaEditionId, res.quantity rdaExtraQty
															FROM rdaextradrawsplit res, specificroutes sr
															WHERE res.clientlocid = $ASLocationID
															AND res.specificproductid = $spId
															AND res.specificrouteid = sr.recid
															AND sr.dispatchlocid = $ASLocationID
															AND sr.routeid IN (" . $edRouteIdStr . ")
															AND sr.datesked = '$dbEffDt'
															GROUP BY res.editionid";

										$qryGetRdaExtraDraw = convertToSplitTables($qryGetRdaExtraDraw, $val_SPLIT);

										if($debug)
											print($qryGetRdaExtraDraw . "<br />\n");
										$rsltGetRdaExtraDraw = mysqli_query( $cvtconnection, $qryGetRdaExtraDraw);
										if(!$rsltGetRdaExtraDraw) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											if(mysqli_num_rows($rsltGetRdaExtraDraw) == 0) {
											}
											else {
												while($rowGetRdaExtraDraw = mysqli_fetch_assoc($rsltGetRdaExtraDraw)) {
													$rdaEditionId = $rowGetRdaExtraDraw[rdaEditionId];
													$rdaExtraQty = $rowGetRdaExtraDraw[rdaExtraQty];

													ValidateForInt(false, "rdaEditionId", "rdaExtraQty");

													if(!is_array($editionArr[$rdaEditionId])) {
														$editionArr[$rdaEditionId] = array(
															"EDITIONQTY" => 0
														);
													}

													$editionArr[$rdaEditionId][EDITIONQTY] = $rdaExtraQty;
												}
											}
										}
									}
								}
							}
						}

						$extraQty = $qtyIssuedTot - $qtySkedTot;
						if(!is_numeric($extraQty))	$extraQty = 0;

						$grandExtraQty += $extraQty;
						$qtyReq += $grpQty;

						if($grpQty != 0 || $extraQty != 0) {
							$htmlStr .= ("<tr class=\"datawhite\">\n");
							if($val_RTGRP == "S") {
								$htmlStr .= ("<td align=\"left\"> " . ($strGroupDesc != "" ?  htmlentities($strGroupDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");
							}
							else {
								$htmlStr .= ("<td align=\"left\"> " . ($subGrpSDesc != "" ?  htmlentities($subGrpSDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");
							}

							$locIdStr = "";
							if($lsIntPlord == $prodId) {
								// FIND THE ZONE HERE
								while(list($lcKey, $locId) = each($grpDetInfoArr[LOCSTR])) {
									if($locIdStr == "") {
										$locIdStr = $locId;
									}
									else {
										$locIdStr .= ", " . $locId;
									}
								}
								if($locIdStr == "") $locIdStr = "0";
								$dgvDesc = getZone_TRA37($locIdStr, $dbEffDt);

								$htmlStr .= ("<td align=\"left\"> " . ($dgvDesc != "" ?  htmlentities($dgvDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");
							}

							$htmlStr .= ("<td align=\"right\">" . $grpQty . "</td>\n");
							$htmlStr .= ("<td align=\"right\">" . $extraQty . "</td>\n");
							if($val_EDITN == 'Y') {

								$nonEditionQty = 0;
								$subEditionQty = 0;
								while(list($key, $editionId) = each($dispEditionArr)) {
									$tempNonEditionQty = 0;
									$editionQty = $grpDetInfoArr[EDITION][$editionId][EDITIONQTY];
									if(!is_numeric($editionQty)) $editionQty = 0;

									// FIRST WE NEED TO FETCH ANY EXTRA COPIES FOR EDITION
									$rdaExtraQty = 0;
									if(is_array($editionArr[$editionId])) {
										$rdaExtraQty = $editionArr[$editionId][EDITIONQTY];
										$editionQty += $rdaExtraQty;
									}

									$htmlStr .= ("<td align=\"right\">" . $editionQty . "</td>\n");
									$subEditionQty += $editionQty;
									$grandEditionGrpQty += $editionQty;

									if(!is_array($dispTotEditionArr[$editionId])) {
										$dispTotEditionArr[$editionId] =  array(
											"GRANDEDITQTY" => 0
										);
									}
									$dispTotEditionArr[$editionId][GRANDEDITQTY] += $editionQty;
								}
								if(isset($dispEditionArr))
									reset($dispEditionArr);

								$nonEditionQty = ($grpQty + $extraQty) - $subEditionQty;
								$nonGrandEditionQty += $nonEditionQty;
								$htmlStr .= ("<td align=\"right\">" . $nonEditionQty . "</td>\n");
							}
							$bndleQty = 0;
							if($bndlCnt != 0) {
								if($val_EDITN == 'Y') {
									$bndleQty  = (int) ( ($nonEditionQty) / $bndlCnt );
								}
								else {
									$bndleQty  = (int) ( ($grpQty + $extraQty) / $bndlCnt );
								}
							}
							$grandBndleQty += $bndleQty;
							$htmlStr .= ("<td align=\"right\">" . $bndleQty . "</td>\n");

							$looseQty = 0;
							if($bndlCnt != 0) {
								// LETS CALCULATE THE LOOSE QUANTITY HERE
								if($val_EDITN == 'Y') {
									$looseQty = (($nonEditionQty) % $bndlCnt);
								}
								else {
									$looseQty = (($grpQty + $extraQty) % $bndlCnt);
								}
							}
							$grantLooseQty += $looseQty;
							$htmlStr .= ("<td align=\"right\">" . $looseQty . "</td>\n");
							$htmlStr .= ("</tr>\n");
						}
					}

					// FOR TOTAL
					$htmlStr .= ("<tr class=\"datawhite\">\n");
					$htmlStr .= ("<td align=\"left\"><b>GrandTotal</b></td>\n");
					if($lsIntPlord == $prodId)
						$htmlStr .= ("<td>&nbsp;</td>\n");
					$htmlStr .= ("<td align=\"right\"><b>" . $grandGrpQty . "</b></td>\n");
					$htmlStr .= ("<td align=\"right\"><b>" . $grandExtraQty . "</b></td>\n");

					if($val_EDITN == 'Y') {
						while(list($key, $editionId) = each($dispEditionArr)) {
							if(is_array($dispTotEditionArr[$editionId])) {
								$grandEditionGrpQty = $dispTotEditionArr[$editionId][GRANDEDITQTY];
							}
							$htmlStr .= ("<td align=\"right\"><b>" . $grandEditionGrpQty . "</b></td>\n");
							$tempgrandEditionGrpQty += $grandEditionGrpQty;
						}
						if(isset($dispEditionArr))
							reset($dispEditionArr);
						$htmlStr .= ("<td align=\"right\"><b>" . $nonGrandEditionQty . "</b></td>\n");

					}
					$htmlStr .= ("<td align=\"right\"><b>" . $grandBndleQty . "</b></td>\n");
					$htmlStr .= ("<td align=\"right\"><b>" . $grantLooseQty . "</b></td>\n");
					$htmlStr .= ("</tr>\n");
					$htmlStr .= ("</table>\n");
				}
				$htmlStr .= ("</div>");
				$_SESSION[TRA37DISPHTMLSTR] = $htmlStr;
                               
				if($totCalculatedDraw != $grandGrpQty) {
					$htmlStr .= ("<br />\n");
					$htmlStr .= ("<div class=\"datawhite\" style=\"color:#ff0000\"><b>Warning: The total is not equal to the Calculated Draw.  Please check for routes not assigned to a route group</b>\n");
					$htmlStr .= ("</div>\n");
				}

				// TO PRINT
				print($htmlStr);

				// FOR EMAIL
				print("<div class=\"datawhite\" align=\"center\">\n");
				print("<br /><a href=\"" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=RouteGroupEmail&spId=$spId&qtyReq=$qtyReq&effDt=$effDt", ENT_QUOTES) . "\">eMail</a>\n");
				print("</div>\n");
				break;


			case "RouteGroupEmail":
				if( isset($_SESSION[TRA37DISPHTMLSTR]) )
					$dispHtmlStr = $_SESSION[TRA37DISPHTMLSTR];

				if($debug)
					print($dispHtmlStr);
					
				$qryGetInfo1 = "SELECT c.personid, p.email
								FROM product pd, vendorlink vl, locationlink ll,
								company c, person p
								WHERE pd.clientid = $ASCompanyID
								AND pd.recid = $prodId
								AND vl.locationid = pd.vendorlocid
								AND ll.locationid = vl.locationid
								AND c.recid = ll.companyid
								AND p.recid = c.personid";
								
				if($debug)
					print($qryGetInfo1 . "<br />\n");
				$persEmailIdArray = array();
				$rsltGetInfo1 = mysqli_query( $cvtconnection, $qryGetInfo1);
				if(!$rsltGetInfo1) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo1) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo1 = mysqli_fetch_assoc($rsltGetInfo1)) {
							$persEmailId = $rowGetInfo1[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}	
	

				$qryGetInfo = "SELECT pl.personid, p.email
								FROM personlink pl, person p, notifyperson np
								WHERE pl.locationid = $ASLocationID
								AND pl.personid = p.recid
								AND pl.recid = np.personlinkid
								AND np.groupcode = 'DIS'
								AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00'
								OR pl.endeffdt > '$dbEffDt' )";

				if($debug)
					print($qryGetInfo . "<br />\n");
				//$persEmailIdArray = array();
				$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
				if(!$rsltGetInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
							$persEmailId = $rowGetInfo[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}

				if(count($persEmailIdArray) == 0) {
					$mailMsg = "Email Address - not found for Person <br /><br />";
				}
				else {
					$fileLineNbr = __LINE__; $fromCompName = GetComp($ASCompanyID, $cvtconnection);
					if($debug)
						print("$fromCompName <br />\n");

					$dispDateX = set_date($dbEffDt, "YYYY-MM-DD", "MM/DD/YY");
					$dispDateXSub= date('d-M-Y', strtotime($dbEffDt));
					$prodDesc = $prodDesc . " for " . $dispDateXSub;

					$from = "\"$fromCompName\" <$val_EMLID>";
					$toArr = $persEmailIdArray;
					$subject = $prodDesc;
					$msg = $dispHtmlStr;
					$mail = new htmlMimeMail();

					// SET MESSAGE
					$mail->setHtml($msg);

					// SEND MAIL
					$mail->setFrom($from);
					$mail->setSubject($subject);
					if($mail->send($toArr, "mail")) {
						$qryUp = "UPDATE totaldrawaccounting
									SET qtyrequested = $qtyReq,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE actspecificproductid = $spId";
						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
						}
						$to = implode(', ', $toArr);
						$mailMsg = "Mail Sent to $to";
					}
					else {
						$mailMsg = "Mail Not Sent for Route Group- Some problem exist";
					}
				}

				include('../cm/html-secondwindow.php');
				print("<div class=\"datawhite\">");
				print("<br /><b>$mailMsg</b><br />");
				print("<br /><a href=\"" . htmlspecialchars($Back, ENT_QUOTES) . "\">OK</a>");
				print("</div>\n");
				include('../cm/html-bottom-secondwindow.php');
				break;

			case "Route":
				$fileLineNbr = __LINE__; $compId = GetCompId($cvtconnection, $vendorLocId);
				if(!is_numeric($compId)) $compId = 0;

				print("<form name=\"level2Form\" method=\"GET\" action=\"tra37.php\">\n");
				print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
				print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
				print("<input type=\"hidden\" name=\"spId\" value=\"$spId\" />\n");
				print("<input type=\"hidden\" name=\"ScreenRefresh\" value=\"Route\" />\n");
				print("<input type=\"hidden\" name=\"effDt\" value=\"$effDt\" />");
				print("</form>\n");

				$qryGetRouteInfo = "SELECT DISTINCT(r.recid) routeId, r.sdesc routeDesc,
									r.routenbr routeNbr, vg.recid vgId, vg.sdesc vgDesc
									FROM route r
									LEFT JOIN vendingsubgroup vsg ON vsg.routeid = r.recid
									LEFT JOIN vendinggroup vg ON vg.recid = vsg.vendinggroupid
									WHERE r.locationid = $ASLocationID
									AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00' OR r.endeffdt > '$curDate' )
									ORDER BY vgDesc, r.sortseqnbr";
				if($debug)
					print($qryGetRouteInfo . "<br />\n");
				$rsltGetRouteInfo = mysqli_query( $cvtconnection, $qryGetRouteInfo);
				if(!$rsltGetRouteInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetRouteInfo) == 0) {
						print("<b>No Routes Available</b><br />\n");
					}
					else {
						$dispDateX = get_date($dbEffDt, "MM/DD/YY");
						$htmlStr1 = "";
						$htmlStr1 = $htmlStr1 . ("<u><b>Normal Route - " . $prodDesc . " - " . $dispDateX . "</b></u><br /><br />");

						$htmlStr = "";
						if($val_MNZIP != "Y") {
							$htmlStr .= ("<b>Note: Extra Copies are not included in this view.</b><br /><br />");
						}

						$htmlStr .= ("<table border=\"1\" width=\"65%\">\n");
						$htmlStr .= ("<tr class=\"datatblhdr\">\n");
						if($debug)
							$htmlStr .= ("<td align=\"center\">RecId</td>\n");
						$htmlStr .= ("<td>Normal Route</td> <td>Normal Route Nbr</td> <td align=\"right\">Quantity</td>\n");
						$htmlStr .= ("</tr>\n");

						$oddEven = 0;
						$qtyReq = 0;
						$tmpStdCustArr = array();
						reset($custLocIdArray);
						reset($qtyArray);
						if(is_array($custLocIdArray) && count($custLocIdArray) >0) {
							while(list($key, $locId) = each($custLocIdArray)) {
								$sdQty = $qtyArray[$locId];

								// FOLLOWING CODE IS ONLY FOR TESTING PURPOSE
								if($sdQty != 0) {
									array_push($tmpStdCustArr, $locId);
								}
							}
						}

						$tmpRotCustArr = array();
						$grpTotal = 0;
						$flagFirst = true;
						$oldVgId = "";
						$grantTotal = 0;
						while($rowGetRouteInfo = mysqli_fetch_assoc($rsltGetRouteInfo)) {

							$routeId = $rowGetRouteInfo[routeId];
							$vgId = $rowGetRouteInfo[vgId];
							if(!is_numeric($routeId))	$routeId = 0;
							if(!is_numeric($vgId ))	$vgId = 0;
							$routeDesc = $rowGetRouteInfo[routeDesc];
							$routeNbr = $rowGetRouteInfo[routeNbr];
							$vgDesc = $rowGetRouteInfo[vgDesc];

							reset($qtyArray);
							$qryGetLoc = "SELECT DISTINCT(sr.locationid) locId
											FROM standardroutes sr
											WHERE sr.routeid = $routeId
											AND sr.normalroute = 'Y'
											AND sr.locationid IN (" . $custLocIdStr . ")
											AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00'
											OR sr.endeffdt > '$dbEffDt' )";
							if($debug)
								print($qryGetLoc . "<br />\n");
							$rsltGetLoc = mysqli_query( $cvtconnection, $qryGetLoc);
							$totQty = 0;
							reset($qtyArray);

							if(!$rsltGetLoc) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if(mysqli_num_rows($rsltGetLoc) != 0) {
									while($rowGetLoc = mysqli_fetch_assoc($rsltGetLoc)) {
										$locId = $rowGetLoc[locId];
										$totQty += $qtyArray[$locId];

										// FOLLOWING CODE IS ONLY FOR TESTING PURPOSE
										if(!in_array($locId, $tmpRotCustArr)) {
											array_push($tmpRotCustArr, $locId);
										}
									}
								}
							}

							if(!is_numeric($totQty)) $totQty = 0;
							if($totQty == 0) continue;

							if(!$flagFirst && $oldVgId != $vgId) {
								$htmlStr .= ("<tr class=\"datawhite\">\n");

								if($debug)
									$htmlStr .= ("<td align=\"center\">$routeId</td>\n");

								// DISPLAY Route
								$htmlStr .= ("<td colspan=\"2\"><b>Total :</b></td>\n");

								// DISPLAY Total
								$htmlStr .= ("<td align=\"right\"><b>$grpTotal</b></td>\n");
								$htmlStr .= ("</tr>\n");

								$grpTotal = 0;
							}

							if($flagFirst || $vgId != $oldVgId) {

								$htmlStr .= ("<tr class=\"datawhite\">\n");
								if($debug)
									$htmlStr .= ("<td align=\"center\">$routeId</td>\n");

								// DISPLAY Route
								$htmlStr .= ("<td colspan=\"3\" align=\"center\">");
								$htmlStr .= ("<b>" . htmlentities($vgDesc, ENT_QUOTES) . "</b>");
								$htmlStr .= ("</td>\n");

								$htmlStr .= ("</tr>\n");
								$flagFirst = false;
							}

							$qtyReq += $totQty;
							$grpTotal += $totQty;
							$grantTotal += $totQty;

							if(($oddEven++ % 2) == 0) {
								$htmlStr .= ("<tr class=\"datawhite\">\n");
							}
							else {
								$htmlStr .= ("<tr class=\"datagrey\">\n");
							}

							if($debug)
								$htmlStr .= ("<td align=\"center\">$routeId</td>\n");


							// DISPLAY Route
							$htmlStr .= ("<td>");
							$htmlStr .= (htmlentities($routeDesc, ENT_QUOTES));
							$htmlStr .= ("&nbsp;</td>\n");

							// DISPLAY Route Nbr
							$htmlStr .= ("<td>");
							$htmlStr .= (htmlentities($routeNbr, ENT_QUOTES));
							$htmlStr .= ("&nbsp;</td>\n");

							$htmlStr .= ("<td align=\"right\">&nbsp;");
							$htmlStr .= (number_format($totQty));
							$htmlStr .= ("</td>\n");

							$htmlStr .= ("</tr>\n");

							$oldVgId = $vgId;
						}

						if($grpTotal != 0) {
							$htmlStr .= ("<tr class=\"datawhite\">\n");

							if($debug)
								$htmlStr .= ("<td align=\"center\">$routeId</td>\n");

							// DISPLAY Route
							$htmlStr .= ("<td colspan=\"2\"><b>Total :</b></td>\n");

							// DISPLAY Total
							$htmlStr .= ("<td align=\"right\"><b>$grpTotal</b></td>\n");
							$htmlStr .= ("</tr>\n");

							$grpTotal = 0;
						}

						/*NOW FIRST WE WILL FETCH EXTRACOPIES FOR THIS PUBLICATION*/
						//----------------------------------------------------------
						/*FIRST WE WILL FETCH ALL THE ROUTES ON WHICH THIS PUBLICATION IS BEING DELIVERED*/
						$qryGetEDRouteId = "SELECT DISTINCT(ed.routeid) edRouteId
											FROM extradraw ed
											WHERE clientlocid = $ASLocationID
											AND productid = $prodId
											AND effdt <= '$dbEffDt'";
						if($debug)
							print($qryGetEDRouteId . "<br />\n");
						$rsltGetEDRouteId = mysqli_query( $cvtconnection, $qryGetEDRouteId);
						if(!$rsltGetEDRouteId) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							$edQty = 0;
							while($rowGetEDRouteId = mysqli_fetch_assoc($rsltGetEDRouteId)) {
								$edRouteId = $rowGetEDRouteId[edRouteId];
								if(!is_numeric($edRouteId)) $edRouteId = 0;

								$edQty += GetExtraDrawQty($prodId, $edRouteId, $dbEffDt);
							}
						}
						//-------------------------------------------------------
						$qtyReq += $edQty;

						if($val_MNZIP == "Y") {
							$grantTotal += $edQty;

							$htmlStr = $htmlStr . ("<tr class=\"datawhite\">\n");
							if($debug)
								$htmlStr = $htmlStr . ("<td>&nbsp;</td>\n");
							$htmlStr = $htmlStr . ("<td><b>Extra Copies</b></td>");

							$htmlStr = $htmlStr . ("<td align=\"right\" colspan=\"2\"><b>&nbsp;" . $edQty . "</b></td>\n");
							$htmlStr = $htmlStr . ("</tr>\n");
						}

						// FOR GRANT TOTAL
						if($grantTotal != 0) {

							$htmlStr .= ("<tr class=\"datawhite\">\n");

							if($debug)
								$htmlStr .= ("<td align=\"center\">&nbsp;</td>\n");

							// DISPLAY ROUTE
							$htmlStr .= ("<td colspan=\"2\"><b>Grant Total :</b></td>\n");

							// DISPLAY TOTAL
							$htmlStr .= ("<td align=\"right\"><b>$grantTotal</b></td>\n");
							$htmlStr .= ("</tr>\n");
						}

						// FOLLOWING ARRAY IS ONLY FOR TESTING PURPOSE
						$tmpDiffArr = array_diff($tmpStdCustArr, $tmpRotCustArr);

						if($debug) {
							print("<pre>tmpStdCustArr");
							print_r($tmpStdCustArr);
							print("</pre>\n");

							print("<pre>tmpRotCustArr");
							print_r($tmpRotCustArr);
							print("</pre>\n");

							print("<pre>Locations Not On Route");
							print_r($tmpDiffArr);
							print("</pre>\n");
						}

						$htmlStr .= ("</table>\n");
						$htmlStr .= ("<br />\n");

						$selectStr = "qtyprojected";
						$fromStr = "totaldrawaccounting";
						$whereStr = "actspecificproductid = $spId";
						$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
						unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

						if($rsltArr) {
							$qtyProj = $rsltArr[qtyprojected];
						}
						else {
							$qtyProj = 0;
						}
						unset($rsltArr);
						if($debug) {
							print("qtyProj - $qtyProj <br />\n");
							print("qtyReq = $qtyReq<br />");
						}

						if($qtyProj != $qtyReq) {
							if(isset($tmpDiffArr) && count($tmpDiffArr) > 0) {
								if($debug)
									print("REQUEST_URI = $REQUEST_URI<br />");

								print("<form name=\"level1FormRoute\" method=\"Post\" action=\"tra37.php\">\n");
								print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
								print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
								print("<input type=\"hidden\" name=\"spId\" value=\"$spId\" />\n");
								print("<input type=\"hidden\" name=\"ScreenRefresh\" value=\"Route\" />\n");
								print("<input type=\"hidden\" name=\"Back\" value=\"{$REQUEST_URI}\" />");
								print("<input type=\"hidden\" name=\"effDt\" value=\"$effDt\" />");

								print("<b>Locations Not On Any Route</b><br /><br />");
								print("<table border=\"1\" width=\"70%\">\n");
								print("<tr class=\"datatblhdr\">\n");
								if($debug)
									print("<td align=\"center\">locId</td>\n");
								print("<td>&nbsp;</td>");
								print("<td>Location</td>\n");
								print("<td>Route</td>\n");
								print("</tr>\n");

								$routeTypeStr = "'SR', 'PR'";
								if($val_HAWKS == "Y") {
									$routeTypeStr .= ", 'AM', 'PM', 'TR'";
								}

								$qryGetRoute = "SELECT DISTINCT(r.recid) routeId,
												CONCAT_WS(' - ', NULLIF(r.routenbr, ''), NULLIF(r.sdesc, '')) routeDesc
												FROM route r
												WHERE r.locationid = $ASLocationID
												AND r.type IN($routeTypeStr)
												AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00' OR r.endeffdt > '$curDate')
												ORDER BY r.sortseqnbr";
								if($debug)
									print($qryGetRoute . "<br />\n");
								$rsltGetRoute = mysqli_query( $cvtconnection, $qryGetRoute);

								$oddEven = 0;
								$routeCnt = 0;
								if(!$rsltGetRoute) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}
								else {
									while(list($key, $locId) = each($tmpDiffArr)) {
										if( ( $oddEven++ % 2 ) == 0 ) {
											print("<tr class=\"datawhite\">\n");
										}
										else {
											print("<tr class=\"datagrey\">\n");
										}

										print("<td align=\"center\"><input type=\"checkbox\" name=\"locIdArr[" . $routeCnt . "]\" value=\"" . $locId . "\" onclick=\"\" /></td>\n"); //CheckBoxSingle(this.form, this.checked)

										$qryGetLocDesc = "SELECT CONCAT_WS(' - ', NULLIF(c.name, ''),
															NULLIF(l.storenbr, ''), NULLIF(l.sdesc, ''),
															NULLIF(a.address1, ''), NULLIF(a.address2, ''), NULLIF(a.address3, '')) locDesc
															FROM locationlink ll, company c, location l LEFT JOIN address a ON a.recid = l.addressid
															WHERE l.recid = $locId
															AND ll.locationid = l.recid
															AND c.recid = ll.companyid";
										if($debug)
											print($qryGetLocDesc . "<br />\n");
										$rsltGetLocDesc = mysqli_query( $cvtconnection, $qryGetLocDesc);
										if(!$rsltGetLocDesc) {
											$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 01);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($fileLineNbr);
										}
										else {
											$rowGetLocDesc = mysqli_fetch_assoc($rsltGetLocDesc);
											$locDesc = $rowGetLocDesc[locDesc];
										}

										if($debug) print("<td>$locId</td>");
										print("<td>" . htmlentities($locDesc, ENT_QUOTES) . "</td>");

										// For Route Droplist
										print("<td>");
										if(mysqli_num_rows($rsltGetRoute) != 0)
											mysqli_data_seek($rsltGetRoute,  0);
										print("<select name=\"routeIdArr[" . $routeCnt . "]\"  onchange=\"checkOne('locIdArr', '$routeCnt')\">");
										print("\t<option value=\"\">Select Route</option>");
										if($rsltGetRoute) {
											while($rowGetRoute = mysqli_fetch_assoc($rsltGetRoute)) {
												print("\t<option value=\"" . $rowGetRoute[routeId] . "\"");
												if($routeIdArr[$routeCnt] == $rowGetRoute[routeId])
													print(" selected=\"selected\"");
												print(">");
												if($debug)
													print("" . $rowGetRoute[routeId] . " - ");
												print("" . htmlentities($rowGetRoute[routeDesc], ENT_QUOTES) . "</option>");
											}
										}
										print("</select>\n");
										print("</td>\n");
										print("</tr>\n");
										$routeCnt++;
									}
								}
								print("</table>\n");
								print("<input type=\"hidden\" name=\"noRecords\" value=\"$routeCnt\" />\n");
								print("<br /><br /><a href=\"javascript:submitLevel1FormRoute(document.level1FormRoute, 'PostRoute', 'locIdArr');\">Post</a>");
								print("</form>\n");
							}
							else {
								print("<b>Sorry, this option is not available since locations are either missing or duplicated on one or more routes.</b>");
							}
						}
						else {
							$dispHtmlStr = $htmlStr1 . $htmlStr;
							print($dispHtmlStr);
							$_SESSION[TRA37DISPHTMLSTR] = $dispHtmlStr;

							print("<a href=\"" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=RouteEmail&spId=$spId&qtyReq=$qtyReq&effDt=$effDt", ENT_QUOTES) . "\">eMail</a>\n");
						}
					}
				}
				break;

			case "RouteEmail":
				if( isset($_SESSION[TRA37DISPHTMLSTR]) )
				 $dispHtmlStr = $_SESSION[TRA37DISPHTMLSTR];

				if($debug)
					print($dispHtmlStr);

				$qryGetInfo1 = "SELECT c.personid, p.email
								FROM product pd, vendorlink vl, locationlink ll,
								company c, person p
								WHERE pd.clientid = $ASCompanyID
								AND pd.recid = $prodId
								AND vl.locationid = pd.vendorlocid
								AND ll.locationid = vl.locationid
								AND c.recid = ll.companyid
								AND p.recid = c.personid";
								
				if($debug)
					print($qryGetInfo1 . "<br />\n");
				$persEmailIdArray = array();
				$rsltGetInfo1 = mysqli_query( $cvtconnection, $qryGetInfo1);
				if(!$rsltGetInfo1) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo1) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo1 = mysqli_fetch_assoc($rsltGetInfo1)) {
							$persEmailId = $rowGetInfo1[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}	


				$qryGetInfo = "	SELECT pl.personid, p.email
								FROM personlink pl, person p, notifyperson np
								WHERE pl.locationid = $ASLocationID
								AND pl.personid = p.recid
								AND pl.recid = np.personlinkid
								AND np.groupcode = 'DIS'
								AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00'
								OR pl.endeffdt > '$dbEffDt' )";

								
				if($debug)
					print($qryGetInfo . "<br />\n");
				//$persEmailIdArray = array();
				$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
				if(!$rsltGetInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
							$persEmailId = $rowGetInfo[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}

				if(count($persEmailIdArray) == 0) {
					$mailMsg = "Email Address - not found for Person";
				}
				else {
					$fileLineNbr = __LINE__; $fromCompName = GetComp($ASCompanyID, $cvtconnection);
					if($debug)
						print("$fromCompName <br />\n");

					$dispDateX = set_date($dbEffDt, "YYYY-MM-DD", "MM/DD/YY");
					
					$dispDateXSub= date('d-M-Y', strtotime($dbEffDt));			
					$prodDesc = $prodDesc . " for " . $dispDateXSub;

					$from = "\"$fromCompName\" <$val_EMLID>";
					$toArr = $persEmailIdArray;
					$subject = $prodDesc;
					$msg = $dispHtmlStr;

					$mail = new htmlMimeMail();

					// SET MESSAGE
					$mail->setHtml($msg);

					// SEND MAIL
					$mail->setFrom($from);
					$mail->setSubject($subject);

					if($mail->send($toArr, "mail")) {
						$qryUp = "UPDATE totaldrawaccounting
									SET qtyrequested = $qtyReq,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE actspecificproductid = $spId";
						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
						}

						$to = implode(', ', $toArr);
						$mailMsg = "Mail Sent to $to";
					}
					else {
						$mailMsg = "Mail Not Sent for Normal Route - Some problem exist";
					}
				}
				include('../cm/html-secondwindow.php');
				print("<div class=\"datawhite\">");
				print("<br /><b>$mailMsg</b><br />");
				print("<br /><a href=\"" . htmlspecialchars($Back, ENT_QUOTES) . "\">OK</a>");
				print("</div>\n");
				include('../cm/html-bottom-secondwindow.php');
				break;

			case "ActualRoute":

				$fileLineNbr = __LINE__; $compId = GetCompId($cvtconnection, $vendorLocId);
				if(!is_numeric($compId)) $compId = 0;

				$dowEffDt = strtoupper(date("D", mktime(0, 0, 0, substr($dbEffDt, 5, 2), substr($dbEffDt, 8, 2), substr($dbEffDt, 0, 4))));

				print("<form name=\"level2Form\" method=\"GET\" action=\"tra37.php\" style=\"margin: 0;\">\n");
				print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
				print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
				print("<input type=\"hidden\" name=\"spId\" value=\"$spId\" />\n");
				print("<input type=\"hidden\" name=\"ScreenRefresh\" value=\"Route\" />\n");
				print("<input type=\"hidden\" name=\"effDt\" value=\"$effDt\" />");

				/*// FOR ROUTE SET DROP LIST
				$qryGetRouteSet = "SELECT rs.recid routeSetId, rs.sdesc routeSetDesc
									FROM routeset rs
									WHERE rs.clientlocid = $ASLocationID";
				if($debug)
					print($qryGetRouteSet . "<br />\n");
				$rsltGetRouteSet = mysql_query($qryGetRouteSet, $cvtconnection);
				if(!$rsltGetRouteSet) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					print("<div align=\"center\">\n");
					print("<b>Select Route Set: </b>&nbsp;");
					print("<select name=\"lstRouteSet\" onchange=\"this.form.submit()\">\n");
					print("\t<option value=\"\">Select Route Set</option>\n");
					if(mysql_num_rows($rsltGetRouteSet) == 0) {
					}
					else {
						while($rowGetRouteSet = mysql_fetch_assoc($rsltGetRouteSet)) {
							$routeSetId = $rowGetRouteSet[routeSetId];
							$routeSetDesc = $rowGetRouteSet[routeSetDesc];
							if(!is_numeric($routeSetId)) $routeSetId = 0;

							print("\t<option value=\"$routeSetId\"");
							if($lstRouteSet == $routeSetId) {
								print(" selected=\"selected\"");
							}
							print(">");
							if($debug) {
								print($routeSetId . " - ");
							}
							print(htmlentities($routeSetDesc, ENT_QUOTES));
							print("</option>\n");
						}
					}
					print("</select>\n");
					print("</div>\n");
					print("<br />\n");
				}
				if(!is_numeric($lstRouteSet)) $lstRouteSet = 0;
				print("</form>\n");*/

				//FIRST FIND THE ROUTESET VALUES
				$selectStr = "routesetid, returnsroutesetid  ";
				$fromStr = "productdispatch ";
				$whereStr = "clientlocid = $ASLocationID
							 AND rundate = '$dbEffDt'";

				$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
				unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

				if($rsltArr) {
					$routeSetId = $rsltArr[routesetid];
					$retRouteSetId = $rsltArr[returnsroutesetid];
				}
				else {
					$routeSetId = 0;
					$retRouteSetId = 0;
				}
				unset($rsltArr);

				$routeTypeStr = "'SR', 'RD', 'RS', 'LR', 'PR'";
				if($val_HAWKS == "Y") {
					$routeTypeStr .= ", 'AM', 'PM', 'TR'";
				}

				$qryGetRouteInfo = "SELECT DISTINCT(r.recid) routeId, r.sdesc routeDesc, r.type routeType,
									r.routenbr routeNbr, rf.driverid driverId,
									vg.recid vgId, vg.sdesc vgDesc
									FROM routesetdetail rsd, routefrequency rf, route r

									LEFT JOIN vendingsubgroup vsg ON vsg.routeid = r.recid
									LEFT JOIN vendinggroup vg ON vg.recid = vsg.vendinggroupid
									WHERE r.locationid = $ASLocationID
									AND rsd.routesetid IN ($routeSetId, $retRouteSetId)
									AND rsd.routeid = r.recid
									AND rf.routeid = r.recid
									AND rf.dow = '$dowEffDt'
									AND r.type IN ($routeTypeStr)
									AND  ( rf.endeffdt IS NULL OR rf.endeffdt = '0000-00-00' OR rf.endeffdt > '$dbEffDt')
									AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00' OR r.endeffdt > '$curDate' )
									AND ( rsd.endeffdt IS NULL OR rsd.endeffdt = '0000-00-00'
									OR rsd.endeffdt > '$curDate' )
									ORDER BY vgDesc, r.sortseqnbr";

				if($debug)
					print($qryGetRouteInfo . "<br />\n");
				$rsltGetRouteInfo = mysqli_query( $cvtconnection, $qryGetRouteInfo);

				if(!$rsltGetRouteInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetRouteInfo) == 0) {
						print("<b>No Routes Available</b><br />\n");
					}
					else {
						$dispDateX = get_date($dbEffDt, "MM/DD/YY");
						$htmlStr1 = "";
						$htmlStr1 .= ("<u><b>Actual Route - " . $prodDesc . " - " . $dispDateX . "</b></u><br /><br />");

						$htmlStr = "";
						$htmlStr .= ("<table border=\"1\" width=\"65%\">\n");
						$htmlStr .= ("<tr class=\"datatblhdr\">\n");
						if($debug)
							$htmlStr .= ("<td align=\"center\">RecId</td>\n");
						$htmlStr .= ("<td>Route</td> <td>Normal Route Nbr</td> <td>Driver</td><td align=\"right\">Quantity</td>\n");
						$htmlStr .= ("</tr>\n");

						$oddEven = 0;
						$qtyReq = 0;
						$tmpStdCustArr = array();
						reset($custLocIdArray);
						reset($qtyArray);
						if(is_array($custLocIdArray) && count($custLocIdArray) > 0) {
							while(list($key, $locId) = each($custLocIdArray)) {
								$sdQty = $qtyArray[$locId];

								// FOLLOWING CODE IS ONLY FOR TESTING PURPOSE
								if($sdQty != 0) {
									array_push($tmpStdCustArr, $locId);
								}
							}
						}

						$tmpRotCustArr = array();
						$grpTotal = 0;
						$flagFirst = true;
						$oldVgId = "";
						$grantTotal = 0;
						while($rowGetRouteInfo = mysqli_fetch_assoc($rsltGetRouteInfo)) {

							$routeId = $rowGetRouteInfo[routeId];
							$vgId = $rowGetRouteInfo[vgId];
							$routeDesc = $rowGetRouteInfo[routeDesc];
							$routeNbr = $rowGetRouteInfo[routeNbr];
							$vgDesc = $rowGetRouteInfo[vgDesc];
							$routeType = $rowGetRouteInfo[routeType];
							$driverId = $rowGetRouteInfo[driverId];

							ValidateForInt(false, "routeId", "vgId", "driverId");

							reset($qtyArray);
							$qryGetLoc = "SELECT DISTINCT(sr.locationid) locId
											FROM standardroutes sr
											WHERE sr.routeid = $routeId
											/*AND sr.normalroute = 'Y'*/
											AND sr.locationid IN (" . $custLocIdStr . ")
											AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00'
											OR sr.endeffdt > '$dbEffDt' )";
							if($debug)
								print($qryGetLoc . "<br />\n");
							$rsltGetLoc = mysqli_query( $cvtconnection, $qryGetLoc);
							$totQty = 0;
							reset($qtyArray);

							if(!$rsltGetLoc) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if(mysqli_num_rows($rsltGetLoc) != 0) {
									while($rowGetLoc = mysqli_fetch_assoc($rsltGetLoc)) {
										$locId = $rowGetLoc[locId];
										$totQty += $qtyArray[$locId];
									}
								}
							}

							if(!is_numeric($totQty)) $totQty = 0;
                                                        
							// HERE LETS GET THE EXTRA PAPERS VALUES
							$qryGetExtra = "SELECT SUM(rda.qtyissued) qtyIssued, SUM(rda.qtysked) qtySked
											FROM routedrawaccounting rda, specificroutes sr
											WHERE rda.clientlocid = $ASLocationID
											AND rda.specificrouteid = sr.recid
											AND rda.actspecificproductid = $spId
											AND sr.dispatchlocid = $ASLocationID
											AND sr.routeid IN ($routeId)
											AND sr.datesked = '$dbEffDt'
                                                                                        
                                                                                            
                                                                ";

							// FOR SPLITTING OF TABLES
							$qryGetExtra = convertToSplitTables($qryGetExtra, $val_SPLIT);
							$edQty = 0;

							if($debug)
								print($qryGetExtra . "<br />\n");
							$rsltGetExtra = mysqli_query( $cvtconnection, $qryGetExtra);

							if(!$rsltGetExtra) {
								$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
								print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
								unset($fileLineNbr);
							}
							else {
								if(mysqli_num_rows($rsltGetExtra) == 0) {
								}
								else {
									$rowGetExtra = mysqli_fetch_assoc($rsltGetExtra);
									$qtyIssued = $rowGetExtra[qtyIssued];
									$qtySked = $rowGetExtra[qtySked];
									ValidateForInt(false, "qtySked", "qtyIssued");
								}
							}

							$edQty = $qtyIssued - $qtySked;
							$totQty += $edQty;

							/*$edQty = GetExtraDrawQty($prodId, $routeId, $dbEffDt);
							$totQty += $edQty;*/

							if(!$flagFirst && $oldVgId != $vgId) {
								$htmlStr .= ("<tr class=\"datawhite\">\n");

								if($debug)

									$htmlStr .= ("<td align=\"center\">$routeId</td>\n");

								// DISPLAY ROUTE
								$htmlStr .= ("<td colspan=\"3\"><b>Total :</b></td>\n");

								// DISPLAY TOTAL
								$htmlStr .= ("<td align=\"right\"><b>$grpTotal</b></td>\n");
								$htmlStr .= ("</tr>\n");

								$grpTotal = 0;
							}

							if($flagFirst || $vgId != $oldVgId) {

								$htmlStr .= ("<tr class=\"datawhite\">\n");
								if($debug)
									$htmlStr .= ("<td align=\"center\">$routeId</td>\n");

								// DISPLAY ROUTE
								$htmlStr .= ("<td colspan=\"4\" align=\"center\">");
								$htmlStr .= ("<b>" . htmlentities($vgDesc, ENT_QUOTES) . "</b>");
								$htmlStr .= ("&nbsp;</td>\n");

								$htmlStr .= ("</tr>\n");
								$flagFirst = false;
							}

							$qtyReq += $totQty;
							$grpTotal += $totQty;
							$grantTotal += $totQty;

							if(($oddEven++ % 2) == 0) {
								$htmlStr .= ("<tr class=\"datawhite\">\n");
							}
							else {
								$htmlStr .= ("<tr class=\"datagrey\">\n");
							}

							if($debug)
								$htmlStr .= ("<td align=\"center\">$routeId</td>\n");

							// DISPLAY ROUTE
							$htmlStr .= ("<td>");
							$htmlStr .= (htmlentities($routeDesc, ENT_QUOTES));
							$htmlStr .= ("&nbsp;</td>\n");

							// DISPLAY ROUTE NBR
							$htmlStr .= ("<td>");
							$htmlStr .= (htmlentities($routeNbr, ENT_QUOTES));
							$htmlStr .= ("&nbsp;</td>\n");

							$fileLineNbr = __LINE__; $driverName = GetDescription("person", $driverId, "CONCAT_WS(', ', NULLIF(lastname, ''), NULLIF(firstname, ''))");

							// FOR DRIVER
							$htmlStr .= ("<td>");
							$htmlStr .= (htmlentities($driverName, ENT_QUOTES));
							$htmlStr .= ("&nbsp;</td>\n");

							// FOR QUANTITY
							$htmlStr .= ("<td align=\"right\">&nbsp;");
							$htmlStr .= (number_format($totQty));
							$htmlStr .= ("</td>\n");

							$htmlStr .= ("</tr>\n");
							$oldVgId = $vgId;
						}

						if($grpTotal != 0) {
							$htmlStr .= ("<tr class=\"datawhite\">\n");

							if($debug)
								$htmlStr .= ("<td align=\"center\">$routeId</td>\n");

							// DISPLAY ROUTE
							$htmlStr .= ("<td colspan=\"3\"><b>Total :</b></td>\n");

							// DISPLAY TOTAL
							$htmlStr .= ("<td align=\"right\"><b>$grpTotal</b></td>\n");
							$htmlStr .= ("</tr>\n");

							$grpTotal = 0;
						}

						// FOR GRANT TOTAL
						if($grantTotal != 0) {

							$htmlStr .= ("<tr class=\"datawhite\">\n");
							if($debug)
								$htmlStr .= ("<td align=\"center\">&nbsp;</td>\n");

							// DISPLAY ROUTE
							$htmlStr .= ("<td colspan=\"3\"><b>Grant Total :</b></td>\n");

							// DISPLAY TOTAL
							$htmlStr .= ("<td align=\"right\"><b>$grantTotal</b></td>\n");
							$htmlStr .= ("</tr>\n");
						}
						
						if($val_DCART == 'Y')
							{
								$qryGetcomm = "SELECT pd.dispatchcomment
												FROM productdispatch pd
												WHERE pd.clientlocid = $ASLocationID
												AND pd.rundate = '$dbEffDt'";
								if($debug)
								print($qryGetcomm . "<br />\n");
								$rsltGetcomm = mysqli_query( $cvtconnection, $qryGetcomm);
								if(!$rsltGetcomm)
								{
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}
									else
									{
										$rowGetcomm = mysqli_fetch_assoc($rsltGetcomm);
										$dispatchcomment = $rowGetcomm['dispatchcomment'];
										//$htmlStr2 .= ("<table border=\"1\" width=\"65%\">\n");
										//$htmlStr2 .= ("<tr class=\"datatblhdr\">\n");
										$htmlStr2 .= ("<tr class=\"datawhite\">\n");
										$htmlStr2 .= ("<td ><b>Dispatcher Comments</b></td>\n");
										$htmlStr2 .= ("<td colspan=\"3\"><b>$dispatchcomment</b></td>\n");
										$htmlStr2 .= ("</tr>\n");
										//$htmlStr2 .= ("</table>\n");
						
										
										
									}	
							
							}
						$htmlStr3 .= ("</table>\n");
						$htmlStr3 .= ("<br />\n");
						
						if($val_DCART == 'Y')
						{
							$dispHtmlStr1 = $htmlStr1 . $htmlStr . $htmlStr3 ;
							print($dispHtmlStr1);
							$dispHtmlStr = $htmlStr1 . $htmlStr . $htmlStr2 . $htmlStr3 ;
							
						}
						else
						{
							$dispHtmlStr = $htmlStr1 . $htmlStr . $htmlStr3;
							print($dispHtmlStr);
						}

						$_SESSION[TRA37DISPHTMLSTR] = $dispHtmlStr;

						print("<a href=\"" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=ActualRouteEmail&spId=$spId&qtyReq=$qtyReq&effDt=$effDt", ENT_QUOTES) . "\">eMail</a>\n");
					}
				}
				print("</form>\n");
				break;

			case "ActualRouteEmail":
				if( isset($_SESSION[TRA37DISPHTMLSTR]) )
				 $dispHtmlStr = $_SESSION[TRA37DISPHTMLSTR];

				if($debug)
					print($dispHtmlStr);
					
				$qryGetInfo1 = "SELECT c.personid, p.email
								FROM product pd, vendorlink vl, locationlink ll,
								company c, person p
								WHERE pd.clientid = $ASCompanyID
								AND pd.recid = $prodId
								AND vl.locationid = pd.vendorlocid
								AND ll.locationid = vl.locationid
								AND c.recid = ll.companyid
								AND p.recid = c.personid";
								
				if($debug)
					print($qryGetInfo1 . "<br />\n");
				$persEmailIdArray = array();
				$rsltGetInfo1 = mysqli_query( $cvtconnection, $qryGetInfo1);
				if(!$rsltGetInfo1) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo1) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo1 = mysqli_fetch_assoc($rsltGetInfo1)) {
							$persEmailId = $rowGetInfo1[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}	
	

				$qryGetInfo = "	SELECT pl.personid, p.email
								FROM personlink pl, person p, notifyperson np
								WHERE pl.locationid = $ASLocationID
								AND pl.personid = p.recid
								AND pl.recid = np.personlinkid
								AND np.groupcode = 'DIS'
								AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00'
								OR pl.endeffdt > '$dbEffDt' )";
				if($debug)
					print($qryGetInfo . "<br />\n");
				//$persEmailIdArray = array();
				$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
				if(!$rsltGetInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
							$persEmailId = $rowGetInfo[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}

				if(COUNT($persEmailIdArray) == 0) {
					$mailMsg = "Email Address - not found for Person";
				}
				else {
					$fileLineNbr = __LINE__; $fromCompName = GetComp($ASCompanyID, $cvtconnection);
					if($debug)
						print("$fromCompName <br />\n");

					$dispDateX = set_date($dbEffDt, "YYYY-MM-DD", "MM/DD/YY");
					$dispDateXSub= date('d-M-Y', strtotime($dbEffDt));	
					$prodDesc = $prodDesc . " for " . $dispDateXSub;

					$from = "\"$fromCompName\" <$val_EMLID>";
					$toArr = $persEmailIdArray;
					$subject = $prodDesc;
					$msg = $dispHtmlStr;

					$mail = new htmlMimeMail();

					// SET MESSAGE
					$mail->setHtml($msg);

					// SEND MAIL
					$mail->setFrom($from);
					$mail->setSubject($subject);

					if($mail->send($toArr, "mail")) {
						$qryUp = "UPDATE totaldrawaccounting
									SET qtyrequested = $qtyReq,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE actspecificproductid = $spId";
						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						$to = implode(', ', $toArr);
						$mailMsg = "Mail Sent to $to";
					}
					else {
						$mailMsg = "Mail Not Sent for Actual Route - Some problem exist";
					}
				}
				include('../cm/html-secondwindow.php');
				print("<div class=\"datawhite\">\n");
				print("<br /><b>$mailMsg</b><br />\n");
				print("<br /><a href=\"" . htmlspecialchars($Back, ENT_QUOTES) . "\">OK</a>\n");
				print("</div>\n");
				include('../cm/html-bottom-secondwindow.php');
				break;

			case "Manual":

				$fileLineNbr = __LINE__; $compId = GetCompId($cvtconnection, $vendorLocId);
				if(!is_numeric($compId)) $compId = 0;

				$dispDateX = get_date($dbEffDt, "MM/DD/YY");

				print("<u><b>Manual - " . $prodDesc . " - " . $dispDateX . "</b></u><br /><br />");

				print("<form name=\"level1Form\" method=\"POST\" action=\"tra37.php\">\n");
				print("<table  border=\"0\" cellpadding=\"6\" cellspacing=\"2\">");

				print("<tr><td class=\"entryscreenborder\">\n");
				print("<table  width=\"100%\" border=\"0\" bgcolor=\"white\" cellpadding=\"1\" cellspacing=\"1\" >\n");

				// FOR QTYREQUESTED
				$selectStr = "qtyprojected";
				$fromStr = "totaldrawaccounting";
				$whereStr = "actspecificproductid = $spId";
				$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
				unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

				if($rsltArr) {
					$qtyProj = $rsltArr[qtyprojected];
				}
				else {
					$qtyProj = 0;
				}
				unset($rsltArr);

				print("<tr>\n");
				print("<td class=\"datagrey\">Quantity Requested</td>\n");
				print("<td class=\"datawhite\">\n");
				print("<input type=\"text\" name=\"qtyReq\" value=\"$qtyProj\" size=\"10\" maxlength=\"10\" />\n");
				print("</td>\n");
				print("</tr>\n");
				print("</table>\n");

				// TO SET DOACTION
				print("<input type=\"hidden\" name=\"doAction\" value=\"\" />\n");
				print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
				print("<input type=\"hidden\" name=\"spId\" value=\"$spId\" />\n");
				print("<input type=\"hidden\" name=\"effDt\" value=\"$effDt\" />");

				// SUBMITCHK TO CHECK FOR EMPTY FIELDS AND SUBMIT
				print("</td></tr>\n");
				print("<tr><td><a href=\"javascript:SubmitAdd('ManualEmail');\">Post</a>\n");
				print("</td></tr>\n");

				print("</table>\n");
				print("</form>\n");
				break;
				
			case "Demographic":
			
			reset($custLocIdArray);
			reset($qtyArray);
			
			if($debug) {
				print("<pre>");
				print("<br /><br /><br /> final_custloc_qty_array :");
				print_r($custLocIdArray);
				print("</pre>");
			}

						
			$tmpStdCustArr = array();
			reset($custLocIdArray);
			reset($qtyArray);
			if(is_array($custLocIdArray) && count($custLocIdArray) > 0) {
				while(list($key, $locId) = each($custLocIdArray)) {
					$sdQty = $qtyArray[$locId];

					// FOLLOWING CODE IS ONLY FOR TESTING PURPOSE
					if($sdQty != 0) {
						array_push($tmpStdCustArr, $locId);
					}
				}
			}
			
			print("<div class=\"datawhite\">");
			print("<form name=\"Level0Form\" method=\"get\" action=\"tra37.php\">\n");
			print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
			print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
			print("<input type=\"hidden\" name=\"spid\" value=\"$spid\" />\n");
			print("<input type=\"hidden\" name=\"ScreenRefresh\" value=\"Demographic\" />\n");
			
			print("</form>\n");
			print("</div>");
			
			
			$dgId = $val_DEMPO;
			
			
			if(!is_numeric($dgId)) $dgId= 0;
			$qryGetDemoLoc = "SELECT DISTINCT(dv.recid) dValId, dv.sdesc dvDesc,
							dml.locationid dLocId
							FROM demographicvaluelink dvl, demographicvalue dv,
							demolocation dml
							WHERE dvl.locationid = $ASLocationID
							AND dv.recid = dvl.demographicvalueid
							AND dvl.demographicid = $dgId
							AND dml.demographicvalueid = dvl.demographicvalueid
							AND dml.demographicid = dvl.demographicid
							AND ( dml.endeffdt IS NULL OR dml.endeffdt = '0000-00-00'
							OR dml.endeffdt > '$dbEffDt' )
							ORDER BY dvl.sortseqnbr";

			if($debug) print("$qryGetDemoLoc<br />");
			$rsltGetDemoLoc = mysqli_query( $cvtconnection, $qryGetDemoLoc);
			$demoValArr = array();
			if(!$rsltGetDemoLoc) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(12, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if(mysqli_num_rows($rsltGetDemoLoc) != 0) {
					while($rowGetDemoLoc = mysqli_fetch_assoc($rsltGetDemoLoc)) {
						$dLocId = $rowGetDemoLoc[dLocId];
						$dValId = $rowGetDemoLoc[dValId];
						$dvDesc = $rowGetDemoLoc[dvDesc];

						ValidateForInt(false, "dLocId", "dValId");

						if(!isset($demoValArr[$dValId]))
							$demoValArr[$dValId] = array(	"dvDesc" => $dvDesc,
															"qty" => 0);

						$demoValArr[$dValId][qty] += $qtyArray[$dLocId];
						
						$qtty = $custlocid_array[$dLocId];						

						
					}
				}
			}
					
			if(is_array($demoValArr) && count($demoValArr) > 0) {
				$htmlstr = "";
				$htmlStr .= ("<div class=\"datawhite\">");
				if($debug) {
					print("<br /><br /><pre>");
					print_r($demoValArr);
					print("</pre><br /><br />");
					print("<br /><br />custlocid_array<pre>");
					print_r($custlocid_array);
					print("</pre><br /><br />");
				}
				
				$dispDateX = date('F d, Y', strtotime("$dbEffDt"));				
				
				$prodDesc = $prodLDesc . " - " . $dispDateX;
								
				$htmlstr = $htmlstr .("<b>" . htmlentities($prodDesc, ENT_QUOTES) . "</b><br /><br />");

				$htmlstr = $htmlstr . ("<table border=\"1\" width=\"65%\">\n");
				$htmlstr = $htmlstr . ("<tr class=\"datatblhdr\">\n");
				if($debug)
					$htmlstr = $htmlstr . ("<td align=\"center\">RecId</td>\n");
				$htmlstr = $htmlstr . ("<td>Demographic Value</td> 	<td align=\"right\">Quantity</td>\n");
				$htmlstr = $htmlstr . ("</tr>\n");

				reset($demoValArr);
				$oddeven = 0;
				while(list($dvId, $dvQtyArr) = each($demoValArr)) {
					$dvDesc = $dvQtyArr[dvDesc];
					$qty = $dvQtyArr[qty];
					$qtyrequested += $qty;

					if(($oddeven++ % 2) == 0) {
						$htmlstr = $htmlstr . ("<tr class=\"datawhite\">\n");
					}
					else {
						$htmlstr = $htmlstr . ("<tr class=\"datagrey\">\n");
					}

					if($debug)
						$htmlstr = $htmlstr . ("<td align=\"center\">$dvId</td>\n");

					## Display dvDesc
					$htmlstr = $htmlstr . ("<td>");
					$htmlstr = $htmlstr . (htmlentities($dvDesc, ENT_QUOTES));
					$htmlstr = $htmlstr . ("&nbsp;</td>\n");

					## Display Quantity
					$htmlstr = $htmlstr . ("<td align=\"right\">&nbsp;");
					$htmlstr = $htmlstr . (number_format($qty));
					$htmlstr = $htmlstr . ("</td>\n");

					$htmlstr = $htmlstr . ("</tr>\n");
				}
				
				$fileLineNbr = __LINE__; $rsltArray = GetTableInfo($debug, $cvtconnection, "demographic", $dgId, "single");
				if($rsltArray[rtvalue]) {
					$demoSingle = $rsltArray[single];
				}
				else {
					$demoSingle = "";
				}
				unset($rsltArray, $fileLineNbr);

				if($demoSingle == "R") {
					/*First we will fetch all the routes on which this publication is being delivered*/
					$qryGetEDRouteId = "SELECT DISTINCT(ed.routeid) edRouteId
										FROM extradraw ed
										WHERE clientlocid = $ASLocationID
										AND productid = $prodId
										AND effdt <= '$dbEffDt'";
					if($debug) print("$qryGetEDRouteId<br />");
					$rsltGetEDRouteId = mysqli_query(
					$cvtconnection, $qryGetEDRouteId);
					$edQty = 0;
					if(!$rsltGetEDRouteId) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(12, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						while($rowGetEDRouteId = mysqli_fetch_assoc($rsltGetEDRouteId)) {
							$edRouteId = $rowGetEDRouteId[edRouteId];
							if(!is_numeric($edRouteId)) $edRouteId = 0;

							$edQty += GetExtraDrawQty($prodId, $edRouteId, $dbDateX);
						}
					}

					if(($oddeven++ % 2) == 0) {
						$htmlstr = $htmlstr . ("<tr class=\"datawhite\">\n");
					}
					else {
						$htmlstr = $htmlstr . ("<tr class=\"datagrey\">\n");
					}
					if($debug)
						$htmlstr = $htmlstr . ("<td align=\"center\">&nbsp;</td>\n");

					$htmlstr = $htmlstr . ("<td>Extra Copies</td>\n");
					$htmlstr = $htmlstr . ("<td align=\"right\">&nbsp;");
					$htmlstr = $htmlstr . (number_format($edQty));
					$htmlstr = $htmlstr . ("</td>\n");
					$htmlstr = $htmlstr . ("</tr>\n");

					$qtyrequested += $edQty;
				}
				
				$htmlstr = $htmlstr . ("<tr>\n");
				
				$htmlstr = $htmlstr . ("<td align=\"left\">Total:</td>\n");
				
				$htmlstr = $htmlstr . ("<td align=\"right\">&nbsp;");
				$htmlstr = $htmlstr . (number_format($qtyrequested));
				$htmlstr = $htmlstr . ("</td>\n");
				
				$htmlstr = $htmlstr . ("</tr>\n");

				$htmlstr = $htmlstr . ("</table>\n");

				if($demoSingle != "R") {
					$htmlstr = $htmlstr . ("<br />");
					$htmlstr = $htmlstr . ("<b>Extra Papers are not included in this view.</b>");
				}
				$htmlStr .= ("</div>");
				print($htmlstr);
			
				$_SESSION[TRA37DISPHTMLSTR] = $htmlstr;

				print("<div class=\"datawhite\" align=\"center\">\n");
				print("<br /><br /><a href=\"" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=DemoEmail&spId=$spId&qtyrequested=$qtyrequested", ENT_QUOTES) . "\">eMail</a>\n");
				print("</div>\n");

			}
			else {
				if($ScreenRefresh == "Demographic") {
					print("<div class=\"datawhite\">");
					print("<b>No Information Available</b>");
					print("</div>\n");
				}
			}
		
			break;
					
			case "DemoEmail":
				if( isset($_SESSION[TRA37DISPHTMLSTR]) )
					$dispHtmlStr = $_SESSION[TRA37DISPHTMLSTR];

				if($debug)
					print($dispHtmlStr);

				 $qryGetInfo = "SELECT c.personid, p.email
								FROM product pd, vendorlink vl, locationlink ll,
								company c, person p
								WHERE pd.clientid = $ASCompanyID
								AND pd.recid = $prodId
								AND vl.locationid = pd.vendorlocid
								AND ll.locationid = vl.locationid
								AND c.recid = ll.companyid
								AND p.recid = c.personid";
								
				if($debug)
					print($qryGetInfo . "<br />\n");
				$persEmailIdArray = array();
				$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
				if(!$rsltGetInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
							$persEmailId = $rowGetInfo[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}
				
				$qryGetInfo1 = "SELECT pl.personid, p.email
								FROM personlink pl, person p, notifyperson np
								WHERE pl.locationid = $ASLocationID
								AND pl.personid = p.recid
								AND pl.recid = np.personlinkid
								AND np.groupcode = 'DIS'
								AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00' OR pl.endeffdt > '$dbEffDt' )";
								
				if($debug)
					print($qryGetInfo1 . "<br />\n");
				
				$rsltGetInfo1 = mysqli_query( $cvtconnection, $qryGetInfo1);
				if(!$rsltGetInfo1) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo1) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo1 = mysqli_fetch_assoc($rsltGetInfo1)) {
							$persEmailId = $rowGetInfo1[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");


							if(!in_array($persEmailId,$persEmailIdArray))array_push($persEmailIdArray, $persEmailId);
						}
					}
				}				
								
				if(count($persEmailIdArray) == 0) {
					$mailMsg = "Email Address - not found for Person <br /><br />";
				}
				else {
					$fileLineNbr = __LINE__; $fromCompName = GetComp($ASCompanyID, $cvtconnection);
					if($debug)
						print("$fromCompName <br />\n");

					$dispDateX = set_date($dbEffDt, "YYYY-MM-DD", "MM/DD/YY");
					
					$dispDateXSub= date('d-M-Y', strtotime($dbEffDt));
					$prodDesc = $prodDesc . " for " . $dispDateXSub;

					$from = "\"$fromCompName\" <$val_EMLID>";
					$toArr = $persEmailIdArray;
					$subject = $prodDesc;
					$msg = $dispHtmlStr;
					$mail = new htmlMimeMail();

					// SET MESSAGE
					$mail->setHtml($msg);

					// SEND MAIL
					$mail->setFrom($from);
					$mail->setSubject($subject);
					if($mail->send($toArr, "mail")) {
						$qryUp = "UPDATE totaldrawaccounting
									SET qtyrequested = $qtyrequested,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE actspecificproductid = $spId";
						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
						}
						$to = implode(', ', $toArr);
						$mailMsg = "Mail Sent to $to";
					}
					else {
						$mailMsg = "Mail Not Sent for Route Group- Some problem exist";
					}
				}

				include('../cm/html-secondwindow.php');
				print("<div class=\"datawhite\">");
				print("<br /><b>$mailMsg</b><br />");
				print("<br /><a href=\"" . htmlspecialchars($Back, ENT_QUOTES) . "\">OK</a>");
				print("</div>\n");
				include('../cm/html-bottom-secondwindow.php');
				break;


			case "ManualEmail":
				ValidateForInt(false,  "spId");
				

				$compId = GetCompId($cvtconnection, $vendorLocId);
				if(!is_numeric($compId)) $compId = 0;

				$prodDesc = $prodDesc . " - " . get_date($dbEffDt, "MM/DD/YY");
				
				$qryGetInfo1 = "SELECT c.personid, p.email
								FROM product pd, vendorlink vl, locationlink ll,
								company c, person p
								WHERE pd.clientid = $ASCompanyID
								AND pd.recid = $prodId
								AND vl.locationid = pd.vendorlocid
								AND ll.locationid = vl.locationid
								AND c.recid = ll.companyid
								AND p.recid = c.personid";
								
				if($debug)
					print($qryGetInfo1 . "<br />\n");
				$persEmailIdArray = array();
				$rsltGetInfo1 = mysqli_query( $cvtconnection, $qryGetInfo1);
				if(!$rsltGetInfo1) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo1) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo1 = mysqli_fetch_assoc($rsltGetInfo1)) {
							$persEmailId = $rowGetInfo1[email];
							$persEmailId =  str_replace(";", ",", "$persEmailId");

							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}	


				$qryGetInfo = "SELECT pl.personid, p.email
								FROM personlink pl, person p, notifyperson np
								WHERE pl.locationid = $ASLocationID
								AND pl.personid = p.recid
								AND pl.recid = np.personlinkid
								AND np.groupcode = 'DIS'
								AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00'
								OR pl.endeffdt > '$dbEffDt' )";

								
				if($debug)
					print($qryGetInfo . "<br />\n");
				//$persEmailIdArray = array();
				$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
				if(!$rsltGetInfo) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if(mysqli_num_rows($rsltGetInfo) == 0) {
						$persEmailId = "";
					}
					else {
						while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
							$persEmailId = $rowGetInfo[email];
							array_push($persEmailIdArray, $persEmailId);
						}
					}
				}

				if(COUNT($persEmailIdArray) == 0) {
					$mailMsg = "Email Address - not found for Person <br /><br />";
				}
				else {
					$fromCompName = GetComp($ASCompanyID, $cvtconnection);
					if($debug)
						print("$fromCompName <br />\n");

					$dispDateX = set_date($dbEffDt, "YYYY-MM-DD", "MM/DD/YY");
					$dispDateXSub= date('d-M-Y', strtotime($dbEffDt));
					$prodDesc = $prodDesc . " for " . $dispDateXSub;

					$from = "\"$fromCompName\" <$val_EMLID>";
					$toArr = $persEmailIdArray;
					$subject = $prodDesc;
					$msg = "Quantity required for $prodDesc is $qtyReq.";

					$mail = new htmlMimeMail();

					// SET MESSAGE
					$mail->setText($msg);

					// SEND MAIL
					$mail->setFrom($from);
					$mail->setSubject($subject);

					if($mail->send(array($to), "mail")) {
						$qryUp = "UPDATE totaldrawaccounting
									SET qtyrequested = $qtyReq,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE actspecificproductid = $spId";
						if($debug)
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $cvtconnection, $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($debug)
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
						}
						$to = implode(', ', $toArr);
						$mailMsg = "Mail Sent to $to";
					}
					else {
						$mailMsg = "Mail Not Sent for Manual - Some problem exist";
					}
				}

				include('../cm/html-secondwindow.php');
				print("<div class=\"datawhite\">");
				print("<br /><b>$mailMsg</b><br />");
				print("<br /><a href=\"" . htmlspecialchars($Back, ENT_QUOTES) . "\">OK</a>");
				print("</div>\n");
				include('../cm/html-bottom-secondwindow.php');
				break;
		}
		print("</div>\n");
		break;

	case "PostRoute":

		if($debug) {
			print("<pre style=\"text-align: left;\">");
			print_r($locIdArr);
			print("</pre>\n");

			print("<pre style=\"text-align: left;\">");
			print_r($routeIdArr);
			print("</pre>\n");
		}

		$exceedFlag = false;
		if(is_array($locIdArr) && count($locIdArr) > 0) {
			while(list($key, $locId) = each($locIdArr)) {
				$routeId = $routeIdArr[$key];
				if(!is_numeric($routeId)) $routeId = 0;
				if($routeId != 0) {
					$selectStr = "TIME_FORMAT(sr.relativetime, '%H:%i:%s') maxRelTime";
					$fromStr = "standardroutes sr, location l";
					$whereStr = "sr.routeid = $routeId
								AND l.recid = sr.locationid
								AND l.type != 'G'
								AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00' OR sr.endeffdt > '$curDate' )
								ORDER BY sr.relativetime DESC
								LIMIT 1";
					$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
					unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

					if($rsltArr) {
						$maxRelTime = $rsltArr[maxRelTime];
					}
					else {
						$maxRelTime = 0;
					}
					unset($rsltArr);

					$maxRelTimeSecs = ( substr($maxRelTime, 0, 2) * 3600 ) + ( substr($maxRelTime, 3, 2) * 60 ) + substr($maxRelTime, -2);

					$timeDiffSec = ( substr($tempRelTime, 0, 2) * 3600 ) + ( substr($tempRelTime, 3, 2) * 60 ) + substr($tempRelTime, -2);

					//ADD DIFF_SECS
					$newMaxRelTimeSecs = $maxRelTimeSecs + $timeDiffSec;
					if($newMaxRelTimeSecs >= ( 3600 * 24 )) $exceedFlag = true;

					// NOW GET THE RELATIVE TIME FOR THE NEWLY ADDED LOCATION
					$qryGetTime = "SELECT DATE_FORMAT(DATE_ADD('2001-01-01 $maxRelTime', INTERVAL $timeDiffSec SECOND), '%H:%i:%s') relTime";
					if($debug)
						print($qryGetTime . "<br />\n");
					$rsltGetTime = mysqli_query( $cvtconnection, $qryGetTime);
					if(!$rsltGetTime) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if(mysqli_num_rows($rsltGetTime) == 0) {
							$relTime = "00:00:00";
						}
						else {
							$rowGetTime = mysqli_fetch_assoc($rsltGetTime);
							$relTime = $rowGetTime[relTime];
						}
					}

					// HERE WE WILL INSERT THE LOCATION IN TO THE STANDARDROUTE TABLE AS A LOAST LOCATION
					if(!$exceedFlag) {
						$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "route", $routeId, "type");
						if($rsltArr[rtvalue]) {
							$routeType = $rsltArr[type];
						}
						else {
							$routeType = "";
						}
						unset($rsltArr, $fileLineNbr);

						$normalRoute = "N";
						if($routeType == "SR") $normalRoute = "Y";

						if($val_HAWKS == "Y") {
							if($routeType == "AM" || $routeType == "TR" || $routeType == "TR") $normalRoute = "Y";
						}
						// NOW INSERT ONE RECORD IN STANDARDROUTE
						$qryIns = "INSERT INTO standardroutes(routeid, locationid,
									relativetime, normalroute)
									VALUES($routeId, $locId,
									'$relTime', '$normalRoute')";
						if($debug)
							print("<b>" . $qryIns . "</b><br />\n");
						$rsltIns = mysqli_query( $cvtconnection, $qryIns);
						if(!$rsltIns) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							$tempSRRecId = getLastInsertId();

							if($val_VSGRT == "Y" && $val_REGIN == "S") {

								// GET VENDINGSUBGROUPID TO SET IN VENDINGLOCATIONLINK
								$selectStr = "vsg.recid vsgId";
								$fromStr = "vendingsubgroup vsg, vendinggroup vg";
								$whereStr = "vsg.routeid = $routeId
												AND vg.recid = vsg.vendinggroupid
												AND vg.clientlocid = $ASLocationID";
								$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
								unset($selectStr, $fromStr, $whereStr, $fileLineNbr);
								if($rsltArr) {
									$vsgId = $rsltArr[vsgId];
									if(!is_numeric($vsgId)) $vsgId = 0;
								}
								else {
									$vsgId = 0;
								}
								unset($rsltArr);

								// UPDATE LOCATION TO SET SUBGROUPID
								$qryUp = "UPDATE location
											SET subgroupid = $vsgId
											WHERE recid = $locId";
								if($debug)
									print("<b>" . $qryUp . "</b><br />\n");
								$rsltUp = mysqli_query( $cvtconnection, $qryUp);
								if(!$rsltUp) {
									$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($fileLineNbr);
								}
								else {
									if($debug)
										print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
								}
							}
						}
					}
				}
			}
		}

		if($debug) {
			print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
		}
		else {
		    header("Location: " . urldecode($Back));
		}
		break;

	case "LagSlips":

		// VALIDATION
		ValidateForInt(false, "pdid", "region");
		$incFromStr = "";
		$incWhereStr = "";
		if($incLoc == "region") {
			$incFromStr = ", vendingsubgroup vsg ";
			$incWhereStr = " AND vsg.vendinggroupid = $region
							 AND vsg.routeid = sr.routeid ";

		}

		print("<div class=\"datawhite\">");

		// GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$effdt = "";
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		$dowEffDt = strtoupper(date("D", mktime(0, 0, 0, substr($dbEffDt, 5, 2), substr($dbEffDt, 8, 2), substr($dbEffDt, 0, 4))));

		/*$spIdStr = implode(", ", $sp_array);
		if($debug) print("spIdStr= $spIdStr<br />dowEffDt = $dowEffDt<br />");

		if($spIdStr == "") {
			$spIdStr = "0";
		}*/

		//if($spIdStr != "0") {

			// from - specificproduct sp,
			// where - AND sd.productid = sp.productid AND sp.recid IN (" . $spIdStr . ")

			// Lets Get the standarddrawleadlag for the selected product location combination
			$qryGetLoc = "SELECT DISTINCT sr.routeid routeId, sd.customerlocid locId,
							sd.productid prodId,
							sdl.leadlag leadLg, sdl.quantity lagQty
							FROM standarddraw sd, stddrawleadlag sdl, standardroutes sr " . $incFromStr . "
							WHERE sd.clientlocid = $ASLocationID
							AND sd.effdt <= '$dbEffDt'
							AND ( sd.endeffdt IS NULL OR sd.endeffdt = '0000-00-00'
							OR sd.endeffdt > '$dbEffDt' )
							AND sr.locationid = sd.customerlocid
							AND sr.normalroute = 'Y'
							AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00'
							OR sr.endeffdt > '$dbEffDt' )
							AND sdl.customerlocid = sd.customerlocid
							AND sdl.productid = sd.productid
							AND sdl.day = '$dowEffDt'
							AND sdl.leadlag > 0 " . $incWhereStr . "
							ORDER BY sr.relativetime";
			if($debug)
				print($qryGetLoc . "<br />\n");
			$rsltGetLoc = mysqli_query( $cvtconnection, $qryGetLoc);
			if(!$rsltGetLoc) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if(mysqli_num_rows($rsltGetLoc) == 0) {
					print("<div align=\"center\">");
					print("<b>No Information Available</b>");
					print("</div>\n");
				}
				else {

					$noSlip = false;
					$mainArray = array();
					while($rowGetLoc = mysqli_fetch_assoc($rsltGetLoc)) {
						$locId = $rowGetLoc[locId];
						$routeId = $rowGetLoc[routeId];
						ValidateForInt(false, "locId", "routeId");

						// HERE LETS GET THE ROUTE INFORMATION
						$fileLineNbr = __LINE__; $routeNbr = GetDescription("route", $routeId, "routenbr");
						/*$qryGetR = "SELECT DISTINCT r.recid routeId, r.routenbr routeNbr
										FROM route r, standardroutes sr
										WHERE r.locationid = $ASLocationID
										AND r.recid = sr.routeid
										AND sr.locationid = $locId
										AND sr.normalroute = 'Y'
										AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00'
										OR sr.endeffdt > '$dbEffDt' )
										AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
										OR r.endeffdt > '$dbEffDt' )";
						if($debug) print("$qryGetR<br />");
						$rsltGetR = mysql_query($qryGetR, $cvtconnection);
						if(mysql_num_rows($rsltGetR) == 0) {
							$routeId = 0;
						}
						else {
							$rowGetR = mysql_fetch_assoc($rsltGetR);
							$routeId = $rowGetR[routeId];
							if(!is_numeric($routeId)) $routeId = 0;
							$routeNbr = $rowGetR[routeNbr];
						}*/
						if($routeId != 0) {
							if(!is_array($mainArray[$routeId])) {
								$mainArray[$routeId] = array(
									"DESC" => $routeNbr,
									"INFO" => array()
								);
							}

							$leadLg = $rowGetLoc[leadLg];
							if(!is_numeric($leadLg)) $leadLg = 0;
							$prodId = $rowGetLoc[prodId];
							$lagQty = $rowGetLoc[lagQty];
							if(!is_numeric($lagQty)) $lagQty = 0;

							//$dbLeadDate = DateOperations_TRADATE($dbEffDt, $leadLg, "ADD");
							$dbLeadDate = $dbEffDt;

							// CHECK WHETHERE ANY SPECIALDRAW EXISTS ON THAT DATE
							$selectStr = "COUNT(recid) spCnt, SUM(quantity) spQty";
							$fromStr = "specialdraw";
							$whereStr = "clientlocid = $ASLocationID
										AND productid = $prodId
										AND specificproductdate = '$dbLeadDate'
										AND locationid = $locId";
							$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
							unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

							if($rsltArr) {
								$spCnt = $rsltArr[spCnt];
								$spQty = $rsltArr[spQty];
								if(!is_numeric($spQty)) $spQty = 0;
							}
							else {
								$spQty = 0;
								$spCnt = 0;
							}

							unset($rsltArr);

							if($lagQty == 0) {
								if($spCnt > 0) {
									$lagQty = $spQty;
								}
								else {
									// WE NEED TO FETCH QTY FRO STANDARDDRAW
									$dispQty = "qty" . strtolower($dowEffDt);
									$qryStdDraw = "SELECT " . $dispQty . " qty
													FROM standarddraw
													WHERE clientlocid = $ASLocationID
													AND customerlocid = $locId
													AND productid = $prodId
													AND effdt <= '$dbEffDt'
													AND ( endeffdt IS NULL OR endeffdt = '0000-00-00'
													OR endeffdt > '$dbEffDt' )
													ORDER BY effdt DESC LIMIT 1";

									if($debug)
										print($qryStdDraw . "<br />\n");
									$rsltStdDraw = mysqli_query( $cvtconnection, $qryStdDraw);
									if(!$rsltStdDraw) {
										$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
										print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
										unset($fileLineNbr);
									}
									else {
										if(mysqli_num_rows($rsltStdDraw) == 0) {
											$sdQty = 0;
										}
										else {
											$rowStdDraw = mysqli_fetch_assoc($rsltStdDraw);
											$sdQty = $rowStdDraw[qty];
											if(!is_numeric($sdQty)) $sdQty = 0;
										}
									}
									$lagQty = $sdQty;
								}

							}
							else {
								if($spCnt > 0) {
									$lagQty = $spQty;
								}
							}
							if($debug) print("$locId :: $leadLg :: $prodId :: $lagQty<br />");
							if(!is_array($mainArray[$routeId][INFO][$locId][$leadLg])) {
								$mainArray[$routeId][INFO][$locId][$leadLg] = array();
							}
							if($lagQty != 0) {
								$mainArray[$routeId][INFO][$locId][$leadLg][$prodId] = $lagQty;
							}
						}
					}

					if($debug) {
						print("<pre style=\"text-align : left\">");
						print_r($mainArray);
						print("</pre>\n");
					}

					if(is_array($mainArray) && count($mainArray) > 0) {

						$qryCName = "SELECT name
									FROM company
									WHERE recid = $ASCompanyID";
						if($debug)
							print($qryCName . "<br />\n");
						$rsltCName = mysqli_query( $cvtconnection, $qryCName);
						if(!$rsltCName) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							$rowCName = mysqli_fetch_assoc($rsltCName);
						}

						print("<br clear=\"all\" style=\"page-break-after:always\">\n");

						while(list($routeId, $routeIdArray) = each($mainArray)) {
							while(list($locId, $locIdArray) = each($routeIdArray[INFO])) {
								while(list($lag, $leadArray) = each($locIdArray)) {
									if(!is_array($leadArray) || count($leadArray) == 0) {
										continue;
									}

									$noSlip = true;
									//print("<br />$routeId :: $locId :: $lead :: ");
									print("<div align=\"left\" style=\"font-size: 14pt\" >");
									print("<b>Normal Route :</b> " . htmlentities($routeIdArray[DESC] , ENT_QUOTES) . "");
									print("</div>\n");
									print("<br /><br />\n");

									print("<div align=\"center\" style=\"font-size: 26pt\" >");
									print(" <b>Lag Slip</b>");
									print("</div>\n");
									print("<br /><br />\n");

									print("<div align=\"center\" style=\"font-size: 16pt\" >");
									$deliverDt = get_date(DateOperations_TRADATE($dbEffDt, $lag, "ADD"), 'MM/DD/YY');
									print(" <b>Deliver " . $deliverDt . "</b>");
									print("</div>\n");

									// LTES GET THE LOCATIO RELATED INFORMATIONS HERE
									$selectStr = "a.phone";
									$fromStr = "location l, address a";
									$whereStr = "l.recid = $ASLocationID
												AND a.recid = l.addressid";
									$fileLineNbr = __LINE__; $rsltArray = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
									unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

									if($rsltArray) {
										$phone = $rsltArray[phone];
									}
									else {
										$phone = "";
									}
									unset($rsltArray);

									$selectStr = "l.sdesc locDesc, l.storenbr strNbr, c.name,
													l.addressid addrId,rl.specialinstr spInstr";
									$fromStr = "location l, locationlink ll, company c,routelink rl";
									$whereStr = "l.recid = $locId
												AND ll.locationid = l.recid
												AND rl.locationid = l.recid
												AND rl.clientid = '$ASCompanyID'

												AND c.recid = ll.companyid";
									$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
									unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

									if($rsltArr) {
										$locDesc = $rsltArr[locDesc];
										$cmpName = $rsltArr[name];
										$strNbr = $rsltArr[strNbr];
										$addrId = $rsltArr[addrId];
										$spInstr = $rsltArr[spInstr];
										if(!is_numeric($addrId)) $addrId = 0;
									}
									else {
										$locDesc = "";
										$cmpName = "";
										$strNbr = "";
										$addrId = 0;
										$spInstr = "";
									}
									unset($rsltArr);

									print("<br />\n");
									print("<div align=\"left\" style=\"font-size: 14pt\" >");
									print("<b> $rowCName[name]</b>");
									if($phone != "") {
										print("<br />$phone");
									}
									print("</div>\n");

									print("<br /><br /><br />\n");
									print("<div align=\"left\">\n");
									print("<table>");
									print("<tr class=\"datawhite\">\n");
									print("<td style=\"font-size: 10pt\"><b>Company</b></td>\n");
									print("<td width=\"8\"></td>\n");
									print("<td style=\"font-size: 10pt\">$cmpName</td>");
									print("</tr>\n");

									print("<tr class=\"datawhite\">\n");
									print("<td style=\"font-size: 10pt\"><b>Location</b></td>\n");
									print("<td width=\"8\"></td>\n");
									print("<td style=\"font-size: 10pt\">$locDesc</td>");
									print("</tr>\n");

									print("<tr class=\"datawhite\">\n");
									print("<td style=\"font-size: 10pt\"><b>Address</b></td>\n");
									print("<td width=\"8\"></td>\n");
									$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "address", $addrId, "address1");
									if($rsltArr[rtvalue]) {
										$address1 = $rsltArr[address1];
									}
									else {
										$address1 = "";
									}
									unset($rsltArr, $fileLineNbr);
									print("<td style=\"font-size: 10pt\">$address1</td>\n");
									print("</tr>\n");

									print("<tr class=\"datawhite\">\n");
									print("<td style=\"font-size: 10pt\"><b>ID Number</b></td>\n");
									print("<td width=\"8\"></td>\n");
									print("<td style=\"font-size: 10pt\">$strNbr</td>");
									print("</tr>\n");
									
									//$spInstr = "Chinmay";
									if($val_DSINS == "Y" && $spInstr != "") {
									print("<tr class=\"datawhite\">\n");
									print("<td style=\"font-size: 10pt\"><b>Delivery Instructions : </b></td>\n");
									print("<td width=\"8\"></td>");
									print("<td style=\"font-size: 10pt\">$spInstr</td>\n");
									print("</tr>\n");
									}
									print("</table>\n");

									print("<br /><br />\n");
									print("<table  border=\"0\" cellpadding=\"0\" cellspacing=\"2\" width=\"100%\">\n");
									print("<tr class=\"datawhite\" style=\"font-size: 12pt\">");
									print("<td><b>Publication </b></td>\n");
									print("<td align=\"center\"><b>Date</b></td>\n");
									print("<td align=\"center\"><b>Day</b></td>\n");
									print("<td align=\"right\"><b>Quantity</b></td>\n");
									print("</tr>\n");

									while(list($prodId, $qty) = each($leadArray)) {
										print("<tr class=\"datawhite\" style=\"font-size: 13pt\">\n");
										// FOR Publication
										$prodDesc = GetDescription("product", $prodId, "ldesc");
										print("<td>" . htmlentities($prodDesc, ENT_QUOTES) . "</td>\n");

										// FOR DATEX
										print("<td align=\"center\">" . get_date($dbEffDt, "MM/DD/YY") . "</td>\n");

										// FOR DAY
										$dowEffDt = date("D", mktime(0, 0, 0, substr($dbEffDt, 5, 2), substr($dbEffDt, 8, 2), substr($dbEffDt, 0, 4)));

										print("<td align=\"center\">" . htmlentities($dowEffDt, ENT_QUOTES) . "</td>\n");

										// FOR QUANTITY
										if(!is_numeric($qty)) $qty = 0;
										print("<td align=\"right\">$qty</td>\n");

										print("</tr>\n");
									}
									print("</table>\n");
									print("</div>\n");

									print("<br clear=\"all\" style=\"page-break-after:always\">\n");
									print("<br /><br />\n");
								}
							}
						}
					}

					if(!$noSlip) {
						print("<div align=\"center\">");
						print("<b>No Information Available</b>");
						print("</div>\n");
					}
				}
			}
		//}
		print("</div>\n");
		break;

	case "DispRoute":
		$rsIdArr = array_values($rsIdArr);
		for($tempi = 0; $tempi < count($rsIdArr); $tempi++) {
			if(!is_numeric($rsIdArr[$tempi])) $rsIdArr[$tempi] = 0;
			if($rsIdArr[$tempi] == 0)
				unset($rsIdArr[$tempi]);
		}
		$rsIdArr = array_values($rsIdArr);

		$routeSetIdStr = MakeStr_TRA37($rsIdArr);
		if($routeSetIdStr == "") $routeSetIdStr = "0";

		$qryGetRoute = "SELECT DISTINCT(r.recid) routeId, r.routenbr routeNbr, r.sdesc routeDesc
						FROM routesetdetail rsd, route r
						WHERE rsd.routesetid IN (" . $routeSetIdStr . ")
						AND r.recid = rsd.routeid
						AND ( r.endeffdt IS NULL OR r.endeffdt = '0000-00-00'
						OR r.endeffdt > '$dbEffDt' )
						AND ( rsd.endeffdt IS NULL OR rsd.endeffdt = '0000-00-00'
							OR rsd.endeffdt > '$curDate' )
						AND ( r.defaultdriverid IS NULL OR r.defaultdriverid = 0 OR r.defaultdriverid = '')";
		if($debug)
			print($qryGetRoute . "<br />\n");
		$rsltGetRoute = mysqli_query( $cvtconnection, $qryGetRoute);
		if(!$rsltGetRoute) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetRoute) == 0) {
			}
			else {
				print("<div class=\"datawhite\" align=\"center\" style=\"color:#ff0000\">\n");
				print("Driver Does not Exist For Following Routes<br /><br />\n");

				print("<table border=\"1\" width=\"60%\">\n");
				print("<tr class=\"datatblhdr\">\n");
				if($debug) print("<td>RouteID</td>\n");
				print("<td>RouteNbr</td>\n");
				print("<td align=\"\">Description</td>\n");
				print("</tr>\n");
				$oddEven = 0;
				while($rowGetRoute = mysqli_fetch_assoc($rsltGetRoute)) {
					$routeId = $rowGetRoute[routeId];
					if(!is_numeric($routeId)) $routeId = 0;
					$routeDesc = $rowGetRoute[routeDesc];
					$routeNbr = $rowGetRoute[routeNbr];
					if( ( $oddEven++ % 2 ) == 0 ) {
						print("<tr class=\"datawhite\">\n");
					}
					else {
						print("<tr class=\"datagrey\">\n");
					}

					// RouteId
					if($debug) print("<td>$routeId</td>\n");

					// RouteNbr
					print("<td>" . htmlentities($routeNbr, ENT_QUOTES) . "</td>\n");

					// Description
					print("<td>" . htmlentities($routeDesc, ENT_QUOTES) . "</td>\n");

					print("</tr>\n");
				}
				print("</table>\n");
				print("</div>\n");
			}
		}
		break;

	case "DispExtraDrawSplit":
		ValidateForInt(false, "prodId", "srId", "spId");

		$dispDate = get_date($dbEffDate, "MM/DD/YY");
		$headerDesc = GetDescription("product", $prodId, "ldesc");

		print("<div class=\"datawhite\" align=\"center\">\n");
		print("<u><b>" . htmlentities($headerDesc . " " . $dispDate, ENT_QUOTES) . "</b></u><br /><br />");

		print("<form name=\"level1Form\" method=\"post\" action=\"tra37.php\" style=\"margin: 0;\">\n");

		$addExtraDrawSplitLink = htmlspecialchars("../rd/tra37.php?PageNbr=$PassedPageNbr&doAction=ToAddExtraDrawSplit&dbEffDate=$dbEffDate&prodId=$prodId&srId=$srId&spId=$spId", ENT_QUOTES);


		print("<div align=\"left\">\n");
		print("<a href=\"" . $addExtraDrawSplitLink . " \">Add</a>\n");
		print("<br /><br />\n");
		print("</div>\n");

		print("<table border=\"1\" width=\"100%\">\n");
		print("<tr class=\"datatblhdr\">\n");
		if($debug)
			print("<td>EdsRecId</td>\n");
		print("<td align=\"center\"><input type=\"checkbox\" name=\"checkall\" value=\"checkall\" onclick=\"CheckBoxAll(this.form, this.checked, 'extraDrawSplitArr')\" /></td>\n");
		print("<td align=\"center\">Del</td>\n");
		print("<td>Edition</td>\n");
		print("<td>Quantity</td>\n");
		print("</tr>\n");

		// QRY TO FIND THE RECORD FROM RDAEXTRADRAWSPLIT
		$qryGetExtraDrawSplit = "SELECT eds.recid edsId, eds.editionid editionId,
								eds.quantity extraQty
								FROM rdaextradrawsplit eds
								WHERE clientlocid = $ASLocationID
								AND eds.specificproductid = $spId
								AND eds.specificrouteid = $srId";
		if($debug)
			print($qryGetExtraDrawSplit . "<br />\n");
		$rsltGetExtraDrawSplit = mysqli_query( $cvtconnection, $qryGetExtraDrawSplit);
		if(!$rsltGetExtraDrawSplit) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetExtraDrawSplit) == 0) {
			}
			else {
				$cntId = 0;
				$oddEven = 0;
				while($rowGetExtraDrawSplit = mysqli_fetch_assoc($rsltGetExtraDrawSplit)) {
					if(($oddEven++ % 2) == 0) {
						print("<tr class=\"datawhite\">\n");
					}
					else {
						print("<tr class=\"datagrey\">\n");
					}

					$edsId = $rowGetExtraDrawSplit[edsId];
					$editionId = $rowGetExtraDrawSplit[editionId];
					$extraQty = $rowGetExtraDrawSplit[extraQty];
					ValidateForInt(false, "editionId", "extraQty");

					$fileLineNbr = __LINE__; $editionDesc = GetDescription("edition", $editionId, "sdesc");

					// FOR EXTRADRAWSPLITID
					if($debug)
						print("<td>" . $edsId . "</td>\n");

					// FOR CHECK BOX
					print("<td align=\"center\"><input type=\"checkbox\" name=\"extraDrawSplitArr[" . $cntId . "]\" value=\"" . $edsId . "\" onclick=\"CheckBoxSingle(this.form, this.checked)\" /></td>\n");

					// FOR DEL
					print("<td align=\"center\"><a href=\"javascript:delConfirmExtraDrawSplit('$PassedPageNbr','$edsId','$srId','$spId');\"><img src=\"../img/del.gif\" border=\"0\" height=\"12\" width=\"12\" alt=\"\" /></a></td>\n");

					// FOR EDITION
					print("<td>" . ($editionDesc != "" ? htmlentities($editionDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");

					// FOR QUANTITY
					print("<td>");
					print("<input type=\"text\" name=\"extraDrawQtyArr[" . $cntId . "]\" value=\"$extraQty\" size=\"5\" maxlength=\"5\" onchange=\"CheckOne('extraDrawSplitArr', '" . $cntId . "')\" />");
					print("</td>\n");

					print("</tr>\n");
					$cntId++;
				}
			}
		}
		print("</table>\n");

		// FOR ADD LINK
		print("<br /><div align=\"left\"><a href=\"" . $addExtraDrawSplitLink . "\">Add</a></div>\n");

		// FOR HIDDEN VARIABLE
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"srId\" value=\"$srId\" />\n");
		print("<input type=\"hidden\" name=\"spId\" value=\"$spId\" />\n");
		print("<input type=\"hidden\" name=\"prodId\" value=\"$prodId\" />\n");
		print("<input type=\"hidden\" name=\"noRecords\" value=\"$cntId\" />\n");

		// FOR POST LINK
		print("<br /><div align=\"center\"><a href=\"javascript:SubmitLevel1Form(document.level1Form,'UpdateExtraDrawSplit')\">Post</a></div>\n");

		print("</form>\n");
		print("</div>\n");
		break;

	case "ToAddExtraDrawSplit":
		ValidateForInt(false, "srId", "spId", "prodId");
		print("<div align=\"center\" class=\"datawhite\">\n");
		print("<form name=\"level2Form\" method=\"post\" action=\"tra37.php\" style=\"margin: 0;\">\n");

		print("<table  border=\"0\" cellpadding=\"6\" cellspacing=\"2\" width=\"50%\"><tr><td class=\"entryscreenborder\">\n");
		print("<table  width=\"100%\" border=\"0\" bgcolor=\"white\" cellpadding=\"1\" cellspacing=\"1\">\n");

		// FOR EDITION
		print("<tr>\n");
		print("<td class=\"datagrey\">Edition</td>\n");

		print("<td class=\"datawhite\">\n");
		// QRY GET EDITION
		$qryGetEdition = "SELECT DISTINCT e.recid editionId, e.sdesc editionDesc
							FROM edition e, editionproduct ep
							WHERE ep.productid = $prodId
							AND e.recid = ep.editionid
							AND ( ep.endeffdt IS NULL OR ep.endeffdt = '0000-00-00' OR ep.endeffdt > '$curDate' )";
		if($debug)
			print($qryGetEdition . "<br />\n");
		$rsltGetEdition = mysqli_query( $cvtconnection, $qryGetEdition);
		if(!$rsltGetEdition) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		print("<select name=\"lstEditionId\">\n");
		print("\t<option value=\"9\">No Edition Defined</option>\n");
		if(!$rsltGetEdition) {
			while($rowGetEdition = mysqli_fetch_assoc($rsltGetEdition)) {
				$editionId = $rowGetEdition[editionId];
				$editionDesc = $rowGetEdition[editionDesc];

				print("\t<option value=\"$editionId\">");
				if($debug)
					print($editionId . " - ");
				print("" . htmlentities($editionDesc, ENT_QUOTES) . "</option>\n");
			}
		}
		print("</select>\n");
		print("</td></tr>\n");

		// FOR QUANTITY
		print("<tr>\n");
		print("<td class=\"datagrey\">Quantity</td>\n");

		print("<td class=\"datawhite\">\n");
		print("<input type=\"text\" name=\"txtExtraQty\" value=\"\" size=\"5\" maxlength=\"5\" />\n");
		print("</td></tr>\n");
		print("</table>\n");

		// HIDDEN VARIABLE
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"srId\" value=\"$srId\" />\n");
		print("<input type=\"hidden\" name=\"spId\" value=\"$spId\" />\n");
		print("<input type=\"hidden\" name=\"prodId\" value=\"$prodId\" />\n");

		// FOR ADD LINK
		print("</td></tr>\n");
		print("<tr><td class=\"datawhite\"><a href=\"javascript:SubmitLevel2Form(document.level2Form,'AddExtraDrawSplit')\">Add</a>\n");
		print("</td></tr>\n");
		print("</table>\n");

		print("</form>\n");
		print("</div>\n");
		break;

	case "AddExtraDrawSplit":
		ValidateForInt(false, "srId", "spId", "lstEditionId", "txtExtraQty");

		if($lstEditionId == 0) {
			$lstEditionId = 9;
		}

		// QRY TO INSERT RECORD IN RDAEXTRADRAWSPLIT
		$qryIns = "INSERT INTO rdaextradrawsplit(clientlocid, specificrouteid, specificproductid ,
					editionid, quantity)
					VALUES($ASLocationID, $srId, $spId, $lstEditionId, $txtExtraQty)";
		if($debug)
			print("<b>" . $qryIns . "</b><br />\n");
		$rsltIns = mysqli_query( $cvtconnection, $qryIns);
		if(!$rsltIns) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 02);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
		}

		// FETCH THE COUNT OF EDITION IN EXTRADRAWSPLIT TABLE
		$qryGetEditionCnt = "SELECT COUNT(editionid) cntEdition, editionid editionId
							FROM rdaextradrawsplit
							WHERE clientlocid = $ASLocationID
							AND specificproductid = $spId
							AND specificrouteid = $srId
							GROUP BY specificproductid, specificrouteid";
		if($debug)
			print($qryGetEditionCnt . "<br />\n");
		$rsltGetEditionCnt = mysqli_query( $cvtconnection, $qryGetEditionCnt);
		if(!$rsltGetEditionCnt) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");

			unset($fileLineNbr);
		}
		else {
			$rowGetEditionCnt = mysqli_fetch_assoc($rsltGetEditionCnt);
			$cntEdition = $rowGetEditionCnt[cntEdition];
			$editionId = $rowGetEditionCnt[editionId];
			if(!is_numeric($editionId))	$editionId = 0;
		}
		if($cntEdition > 1) {
			$rdaEditionId = 1;
		}
		elseif($cntEdition == 1) {
			$rdaEditionId = $editionId;
		}
		else {
			$rdaEditionId = 2;
		}

		// UPDATE ROUTEDRAWACCOUNTING
		$qryUp = "UPDATE routedrawaccounting
				SET qtyissued = qtyissued + $txtExtraQty,
				editionid = $rdaEditionId,
				archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
				WHERE clientlocid = $ASLocationID
				AND specificrouteid = $srId
				AND actspecificproductid = $spId
				AND type = 'SD'";

		// FOR SPLITTING OF TABLES
		$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
		}

		if($debug) {
			print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
		}
		else {
			header("Location: " . urldecode($Back));
		}
		break;

	case "DeleteExtraDrawSplit":
		ValidateForInt(false, "edsId", "srId", "spId" );

		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "rdaextradrawsplit", $edsId, "quantity");
		if($rsltArr[rtvalue]) {
			$extraQty = $rsltArr[quantity];
			if(!is_numeric($extraQty)) $extraQty = 0;
		}
		else {
			$extraQty = 0;
		}

		// QRY TO DELETE THE RECORD FROM RDAEXTRADRAWSPLIT
		$qryDel = "DELETE FROM rdaextradrawsplit
					WHERE recid = $edsId";
		if($debug)
			print("<b>" . $qryDel . "</b><br />\n");
		$rsltDel = mysqli_query( $cvtconnection, $qryDel);
		if(!$rsltDel) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 04);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
		}

		// FETCH THE COUNT OF EDITION IN EXTRADRAWSPLIT TABLE
		$qryGetEditionCnt = "SELECT COUNT(editionid) cntEdition, editionid editionId
							FROM rdaextradrawsplit
							WHERE clientlocid = $ASLocationID
							AND specificproductid = $spId
							AND specificrouteid = $srId
							GROUP BY specificproductid, specificrouteid";
		if($debug)
			print($qryGetEditionCnt . "<br />\n");
		$rsltGetEditionCnt = mysqli_query( $cvtconnection, $qryGetEditionCnt);
		if(!$rsltGetEditionCnt) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			$rowGetEditionCnt = mysqli_fetch_assoc($rsltGetEditionCnt);
			$cntEdition = $rowGetEditionCnt[cntEdition];
			$editionId = $rowGetEditionCnt[editionId];
			if(!is_numeric($editionId))	$editionId = 0;
		}
		if($cntEdition > 1) {
			$rdaEditionId = 1;
		}
		elseif($cntEdition == 1) {
			$rdaEditionId = $editionId;
		}
		else {
			$rdaEditionId = 2;
		}

		// UPDATE ROUTEDRAWACCOUNTING
		$qryUp = "UPDATE routedrawaccounting
				SET qtyissued = qtyissued - $extraQty,
				editionid = $rdaEditionId,
				archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
				WHERE clientlocid = $ASLocationID
				AND specificrouteid = $srId
				AND actspecificproductid = $spId
				AND type = 'SD'";

		// FOR SPLITTING OF TABLES
		$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

		if($debug)
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $cvtconnection, $qryUp);
		if(!$rsltUp) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if($debug)
				print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
		}

		if($debug) {
			print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
		}
		else {
			header("Location: " . urldecode($Back));
		}

		break;

	case "UpdateExtraDrawSplit":
		ValidateForInt(false, "srId", "spId", "prodId");

		if($debug) {
			print("<pre style=\"text-align : left\">");
			print_r($extraDrawSplitArr);
			print("<br /><br />\n");
			print_r($extraDrawQtyArr);
			print("</pre>\n");
		}

		if(isset($extraDrawSplitArr) && isset($extraDrawQtyArr)) {
			$totOldExtraQty = 0;
			$totNewExtraQty = 0;
			$currExtraQty = 0;
			while(list($cntId, $edsId) = each($extraDrawSplitArr)) {
				$newExtraDrawQty = $extraDrawQtyArr[$cntId];
				if(!is_numeric($edsId))	$edsId = 0;
				if(!is_numeric($newExtraDrawQty))	$newExtraDrawQty = 0;
				$totNewExtraQty += $newExtraDrawQty;

				// FETCH THE OLD EXTRADRAWSPILT QTY
				$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "rdaextradrawsplit", $edsId, "quantity");
				if($rsltArr[rtvalue]) {
					$oldExtraQty = $rsltArr[quantity];
					if(!is_numeric($oldExtraQty)) $oldExtraQty = 0;
				}
				else {
					$oldExtraQty = 0;
				}
				$totOldExtraQty += $oldExtraQty;

				// UPDATE THE RDAEXTRADRAWSPLIT WITH NEW QUANTITY
				$qryUpdExtraDrawSplit = "UPDATE rdaextradrawsplit
										SET quantity = $newExtraDrawQty
										WHERE recid = $edsId";
				if($debug)
					print("<b>" . $qryUpdExtraDrawSplit . "</b><br />\n");
				$rsltUpdExtraDrawSplit = mysqli_query( $cvtconnection, $qryUpdExtraDrawSplit);
				if(!$rsltUpdExtraDrawSplit) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if($debug)
						print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
				}
			}

			if($debug)
				print("Old Qty = " . $totOldExtraQty . ", New Qty = " . $totNewExtraQty . "<br />\n");

			// UPDATE ROUTEDRAWACCOUNTING
			$qryUp = "UPDATE routedrawaccounting
					SET qtyissued = qtyissued + $totNewExtraQty - $totOldExtraQty,
					archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
					WHERE clientlocid = $ASLocationID
					AND specificrouteid = $srId
					AND actspecificproductid = $spId
					AND type = 'SD'";

			// FOR SPLITTING OF TABLES
			$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

			if($debug)
				print("<b>" . $qryUp . "</b><br />\n");
			$rsltUp = mysqli_query( $cvtconnection, $qryUp);
			if(!$rsltUp) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if($debug)
					print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
			}
		}

		if(!isset($extraDrawQtyArr) || count($extraDrawQtyArr) == 0) {
			// UPDATE ROUTEDRAWACCOUNTING
			$qryUp = "UPDATE routedrawaccounting
					SET qtyissued = qtysked,
					archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
					WHERE clientlocid = $ASLocationID
					AND specificrouteid = $srId
					AND actspecificproductid = $spId
					AND type = 'SD'";

			// FOR SPLITTING OF TABLES
			$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

			if($debug)
				print("<b>" . $qryUp . "</b><br />\n");
			$rsltUp = mysqli_query( $cvtconnection, $qryUp);
			if(!$rsltUp) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if($debug)
					print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
			}
		}

		if($debug) {
			print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
		}
		else {
			header("Location: " . urldecode($Back));
		}
		break;

	case "DispReturnsAudit":

		ValidateForInt(false, "pdid");
		
		print("<div class=\"datawhite\" align=\"center\">\n");
		print("<form name=\"level2Form\" method=\"post\" action=\"tra37.php\" style=\"margin: 0;\">\n");

		// GET EFFDT
		$fileLineNbr = __LINE__; $rsltArr = GetTableInfo($debug, $cvtconnection, "productdispatch", $pdid, "DATE_FORMAT(rundate, '%m%d%y') effdt", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$effdt = $rsltArr[effdt];
			$dbEffDt = $rsltArr[dbEffDt];
		}
		else {
			$effdt = "";
			$dbEffDt = "";
		}
		unset($rsltArr, $fileLineNbr);

		// SHOW DISP_RUNDATE
		$dispEffDt = set_date($dbEffDt, "YYYY-MM-DD", "MM/DD/YY");
		print("<b><u>Run Date - $dispEffDt</u></b><br /><br />\n");

		$spIdStr = "";
		// FIND THE DISTINCT SPECIFICPRODUCTS FROM TRANSACTIVITY
		$qryGetSpecProducts = "SELECT DISTINCT sp.recid spId
							FROM transactivity ta, specificproduct sp
							WHERE ta.locationid = $ASLocationID
							AND ta.datet = '$dbEffDt'
							AND ta.type = 'SP'
							AND sp.recid = ta.specificproductid
							AND ( sp.endeffdt IS NULL OR sp.endeffdt = '0000-00-00' OR sp.endeffdt > '$dbEffDt' )
							ORDER BY spId";

		// FOR SPLITTING OF TABLES
		$qryGetSpecProducts = convertToSplitTables($qryGetSpecProducts, $val_SPLIT);

		if($debug)
			print($qryGetSpecProducts . "<br />\n");
		$rsltGetSpecProducts = mysqli_query( $cvtconnection, $qryGetSpecProducts);
		if(!$rsltGetSpecProducts) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {
			if(mysqli_num_rows($rsltGetSpecProducts) == 0) {
			}
			else {
				while($rowGetSpecProducts = mysqli_fetch_assoc($rsltGetSpecProducts)) {
					$spId = $rowGetSpecProducts[spId];
					if(!is_numeric($spId))	$spId = 0;

					if($spIdStr == "") {
						$spIdStr = $spId;
					}
					else {
						$spIdStr .= ", " . $spId;
					}
				}
			}
		}
		if($spIdStr == "") {
			$spIdStr = 0;
		}

		$routeTypeStr = "'SR', 'RR', 'CR', 'PR'";
		if($val_HAWKS == "Y") {
			$routeTypeStr .= ", 'AM', 'PM', 'TR'";
		}
		
		

		if($val_RAGRP == "Y"){
			//echo "in if";
			$sel= " ,rg.recid as routegroupid,CONCAT_WS(' - ', NULLIF(rg.groupsdesc, ''), NULLIF(rg.subgroupsdesc, '')) groupDesc ";
			$frm=" ,routegrouplink rgl, routegroup rg ";
			$condi=" AND rgl.clientlocid=rda.clientlocid
						AND rgl.routeid=r.recid
						AND rg.recid=rgl.routegroupid
						AND rg.type='D' " ;
						$orderby=" ORDER BY rg.sortseqnbr,r.sortseqnbr, p.ldesc, sp.datex ";
		}else{
			//	echo "in elsae";
			$sel= "";
			$frm="";
			$condi="" ;
		$orderby="ORDER BY r.sortseqnbr, p.ldesc, sp.datex";
			
		}
	
			$qryGetRoutes = "SELECT DISTINCT r.recid routeId, sr.recid srId, sp.recid spId,
						CONCAT_WS(' - ', NULLIF(r.routenbr, ''), NULLIF(r.sdesc, '')) routedesc, p.recid prodId, p.ldesc prodDesc, DATE_FORMAT(sp.datex, '%m/%d/%y') dateXRet,
						rda.recid rdaId, rda.qtyretd qtyRetd $sel
						FROM routedrawaccounting rda, specificproduct sp, product p,
						route r, specificroutes sr $frm
						WHERE rda.clientlocid = $ASLocationID
						AND rda.type = 'SP'
						AND sp.recid = rda.actspecificproductid
						AND sp.recid IN ($spIdStr)
						AND sr.recid = rda.specificrouteid
						AND r.recid = sr.routeid
						AND r.type IN ($routeTypeStr)
						AND sr.datesked = '$dbEffDt'
						AND ( sp.endeffdt IS NULL OR sp.endeffdt = '0000-00-00' OR sp.endeffdt > '$dbEffDt' )
						AND p.recid = sp.productid
						AND p.clientid = $ASCompanyID
						AND ( p.endeffdt IS NULL OR p.endeffdt = '0000-00-00' OR p.endeffdt > '$dbEffDt' )
						$condi
						$orderby ";
						
		// QRY TO FIND ROUTES
	/*	$qryGetRoutes = "SELECT DISTINCT r.recid routeId, sr.recid srId, sp.recid spId,
						CONCAT_WS(' - ', NULLIF(r.routenbr, ''), NULLIF(r.sdesc, '')) routedesc, p.recid prodId, p.ldesc prodDesc, DATE_FORMAT(sp.datex, '%m/%d/%y') dateXRet,
						rda.recid rdaId, rda.qtyretd qtyRetd,rg.recid as routegroupid,CONCAT_WS(' - ', NULLIF(rg.groupsdesc, ''), NULLIF(rg.subgroupsdesc, '')) groupDesc
						FROM routedrawaccounting rda, specificproduct sp, product p,
						route r, specificroutes sr,routegrouplink rgl, routegroup rg
						WHERE rda.clientlocid = $ASLocationID
						AND rda.type = 'SP'
						AND sp.recid = rda.actspecificproductid
						AND sp.recid IN ($spIdStr)
						AND sr.recid = rda.specificrouteid
						AND r.recid = sr.routeid
						AND r.type IN ($routeTypeStr)
						AND sr.datesked = '$dbEffDt'
						AND ( sp.endeffdt IS NULL OR sp.endeffdt = '0000-00-00' OR sp.endeffdt > '$dbEffDt' )
						AND p.recid = sp.productid
						AND p.clientid = $ASCompanyID
						AND ( p.endeffdt IS NULL OR p.endeffdt = '0000-00-00' OR p.endeffdt > '$dbEffDt' )
						AND rgl.clientlocid=rda.clientlocid
						AND rgl.routeid=r.recid
						AND rg.recid=rgl.routegroupid
						AND rg.type='D'
						ORDER BY rg.sortseqnbr,r.sortseqnbr, p.ldesc, sp.datex
						";*/

		// FOR SPLITTING THE TABLE
		$qryGetRoutes = convertToSplitTables($qryGetRoutes, $val_SPLIT);
$htmlStr = "";
$htmlStr1='';	
		$htmlStr .= ("<div class=\"datawhite\">");
		if($debug)
			print($qryGetRoutes . "<br />\n");
		$rsltGetRoutes = mysqli_query( $cvtconnection, $qryGetRoutes);
		
	
				
		if(!$rsltGetRoutes) {
			$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($fileLineNbr);
		}
		else {

			
			


			print("<table border=\"1\" width=\"100%\">\n");
			print("<tr class=\"datatblhdr\">\n");
			
			print("<tr class=\"datatblhdr\">\n");
			if($debug) {
				print("<td colspan=\"4\">&nbsp;</td>\n");
			}
			else {
				print("<td colspan=\"3\">&nbsp;</td>\n");
			}
			
			print("<td colspan=\"2\" align=\"center\">Audited Returns</td>\n");
			print("<td colspan=\"2\" align=\"center\">Excess Undelivered</td>\n");
			print("</tr>");

			print("<tr class=\"datatblhdr\">\n");
			if($debug)
				print("<td>srId - spId</td>\n");
			print("<td align=\"center\"><input type=\"checkbox\" name=\"checkall\" value=\"checkall\" onclick=\"CheckBoxAll(this.form, this.checked, 'auditRtRDAIdArr')\" /></td>\n");
			print("<td>Route</td>\n");
			print("<td>Publication</td>\n");
			print("<td align=\"center\">Pub Date</td>\n");
			print("<td>Quantity</td>\n");
			print("<td align=\"center\">Pub Date</td>\n");
			print("<td>Quantity</td>\n");
			
			if($val_RAGRP != "Y"){
		
			$htmlStr.=("<table border=\"1\" width=\"100%\">\n");
			
			$htmlStr.=("<tr class=\"datatblhdr\">\n");
			if($debug) {
				$htmlStr.=("<td colspan=\"3\">&nbsp;</td>\n");
			}
			else {
				$htmlStr.=("<td colspan=\"2\">&nbsp;</td>\n");
			}
			
			$htmlStr.=("<td colspan=\"2\" align=\"center\" style=\"font-size: 1.4em;\" ><b>Audited Returns</b></td>\n");
			$htmlStr.=("<td colspan=\"2\" align=\"center\" style=\"font-size: 1.4em;\" ><b>Excess Undelivered</b></td>\n");
			$htmlStr.=("</tr>");

			$htmlStr.=("<tr class=\"datatblhdr\">\n");
			if($debug)
			$htmlStr.("<td style=\"font-size: 1.2em;\">srId - spId</td>\n");	
			//print("<td align=\"center\"><input type=\"checkbox\" name=\"checkall\" value=\"checkall\" onclick=\"CheckBoxAll(this.form, this.checked, 'auditRtRDAIdArr')\" /></td>\n");
			$htmlStr.=("<td style=\"font-size: 1.2em;\" ><b>Route</b></td>\n");
			$htmlStr.=("<td style=\"font-size: 1.2em;\"> <b>Publication<b></td>\n");
			$htmlStr.=("<td  style=\"font-size: 1.2em;\" align=\"center\"><b>Pub Date</b></td>\n");
			$htmlStr.=("<td style=\"font-size: 1.2em;\"><b>Quantity</b></td>\n");
			$htmlStr.=("<td style=\"font-size: 1.2em;\" align=\"center\"><b>Pub Date</b></td>\n");
			$htmlStr.=("<td style=\"font-size: 1.2em;\"><b>Quantity</b></td>\n");
			$htmlStr.=("</tr>");
			}
			
			$grouparray=array();
			$groupdata = array();
			if(mysqli_num_rows($rsltGetRoutes) == 0) {
			}
			else {
		
				$oddEven = 0;
				$cntId = 0;
				//	$htmlStr.=("<table border=\"1\" width=\"100%\">\n");
				while($rowGetRoutes = mysqli_fetch_assoc($rsltGetRoutes)) {
				$srId = $rowGetRoutes[srId];
				$routegroupid = $rowGetRoutes[routegroupid];
				$groupDesc = $rowGetRoutes[groupDesc];

				if(!in_array ($routegroupid,$grouparray))
				{
					if($val_RAGRP == "Y"){	
					print("</tr>\n");
					print("<tr class=\"datawhite\"> \n ");
					print("<td colspan=\"8\" style=\" text-align: center;font-size: 1.6em;\" align=\"center\">$groupDesc</td>\n");
					print("</tr>\n");
					}
				
			
					
				//	$htmlStr.= ("<div style=\"padding-bottom: 3px; text-align: left;font-size: 1.6em;\"><b>$groupDesc</b></div>\n");
					//$htmlStr.=("<td colspan=\"8\" style=\" text-align: center;font-size: 1.6em;\" >$groupDesc</td>\n");
				
					array_push($grouparray,$routegroupid);
				
					
					
				}
				//echo "<pre>";print_r($grouparray);
			
			
					if( ( $oddEven++ % 2 ) == 0 ) {
						print("<tr class=\"datawhite\">\n");
						$htmlStr.=("<tr class=\"datawhite\">\n");
					}
					else {
						print("<tr class=\"datagrey\">\n");
							$htmlStr.=("<tr class=\"datagrey\">\n");
					}

					$routeId = $rowGetRoutes[routeId];
					$rdaId = $rowGetRoutes[rdaId];
					$srId = $rowGetRoutes[srId];
					$spId = $rowGetRoutes[spId];
					$routedesc = $rowGetRoutes[routedesc];
					$prodId = $rowGetRoutes[prodId];
					$prodDesc = $rowGetRoutes[prodDesc];
					$dateXRet = $rowGetRoutes[dateXRet];
					$qtyRetd = $rowGetRoutes[qtyRetd];
					
					ValidateForInt(false, "srId", "spId", "qtyRetd", "qtyUndelivered", "prodId", "routeId");
					if($qtyRetd == 0)
						$qtyRetd='';

					// FOR RECID
					if($debug)
						print("<td>" . $srId . " - " . $spId .  " - " . $prodId . "</td>\n");

					// FOR SEL
					print("<td align=\"center\"><input type=\"checkbox\" name=\"auditRtRDAIdArr[" . $cntId . "]\" value=\"" . $rdaId . "\" onclick=\"CheckBoxSingle(this.form, this.checked)\" />\n");

					// FOR ROUTE
					print("<td>" . ($routedesc != "" ? htmlentities($routedesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");

					// FOR PRODUCT
					print("<td>" . ($prodDesc != "" ? htmlentities($prodDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");

					// FOR PUB DATE
					print("<td align=\"center\">" . ($dateXRet != "" ? htmlentities($dateXRet, ENT_QUOTES) : "&nbsp;") . "</td>\n");

					// FOR AUDITED RETURNS QUANTITY
					print("<td>");
					print("<input type=\"text\" name=\"qtyRetdArr[" . $cntId . "]\" value=\"$qtyRetd\" size=\"5\" maxlength=\"5\" onchange=\"CheckOne('auditRtRDAIdArr', '" . $cntId . "')\" tabindex=\"" . ( $cntId + 1 ) . "\" />");
					print("</td>\n");
					

					/* =======for email======== */
					$htmlStr.=("<td>" . ($routedesc != "" ? htmlentities($routedesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");
					$htmlStr.=("<td>" . ($prodDesc != "" ? htmlentities($prodDesc, ENT_QUOTES) : "&nbsp;") . "</td>\n");
					$htmlStr.=("<td align=\"center\">" . ($dateXRet != "" ? htmlentities($dateXRet, ENT_QUOTES) : "&nbsp;") . "</td>\n");
					$htmlStr.=("<td>");
					$htmlStr.=("<input type=\"text\" name=\"qtyRetdArr[" . $cntId . "]\" value=\"$qtyRetd\" size=\"5\" maxlength=\"5\" onchange=\"CheckOne('auditRtRDAIdArr', '" . $cntId . "')\" tabindex=\"" . ( $cntId + 1 ) . "\" />");
					$htmlStr.=("</td>\n");
					

					// HERE WE NEED TO FIND THE SPECIFICPRODUCT AND SPECIFICROUTES FOR GETIING EXCESS UNDELIVERED QUANTITY
					$selectStr = "sp.recid specProdId";
					$fromStr = "specificproduct sp";
					$whereStr = " sp.productid = $prodId
								AND datex = '$dbEffDt'";

					$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
					unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

					if($rsltArr) {
						$specProdId = $rsltArr[specProdId];
					}
					else {
						$specProdId = 0;
					}
					unset($rsltArr);

					// FOR SPECIFICROUTES
					$selectStr = "recid specRtId";
					$fromStr = "specificroutes";
					$whereStr = " dispatchlocid = $ASLocationID
								AND datesked = '$dbEffDt'
								AND routeid = $routeId";
					$fileLineNbr = __LINE__; $rsltArr = GetSingleRecInfo($cvtconnection, $debug, $selectStr, $fromStr, $whereStr);
					unset($selectStr, $fromStr, $whereStr, $fileLineNbr);

					if($rsltArr) {
						$specRtId = $rsltArr[specRtId];
					}
					else {
						$specRtId = 0;
					}
					unset($rsltArr);
					ValidateForInt(false, "specProdId", "specRtId");

					// QRY TO GET EXCESS UNDELIVERED QUANTITY
					$qryGetInfo = "SELECT rda.recid rdaRecId, rda.qtyundelivered qtyUndelivered
									FROM routedrawaccounting rda
									WHERE rda.clientlocid = $ASLocationID
									AND rda.type = 'SD'
									AND rda.actspecificproductid = $specProdId
									AND rda.specificrouteid = $specRtId";

					// FOR SPLITTING THE TABLE
					$qryGetInfo = convertToSplitTables($qryGetInfo, $val_SPLIT);

					if($debug)
						print($qryGetInfo . "<br />\n");

					$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
					if(!$rsltGetInfo) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if(mysqli_num_rows($rsltGetInfo) == 0) {
						}
						else {
							
							$rowGetInfo = mysqli_fetch_assoc($rsltGetInfo);
							$rdaRecId = $rowGetInfo[rdaRecId];
							$qtyUndelivered = $rowGetInfo[qtyUndelivered];

							//if(!is_numeric($qtyUndelivered)) $qtyUndelivered = 0;
						}
					}
					if(!is_numeric($rdaRecId))	$rdaRecId = 0;

					if($specProdId == 0 || $specRtId == 0 || $rdaRecId == 0) {
						print("<td>&nbsp;</td>\n");
						print("<td>&nbsp;<input type=\"hidden\"name=\"excessRDAIdArr[" . $cntId . "]\" value=\"\" /></td>\n");
						
						$htmlStr.=("<td>&nbsp;</td>\n");
						$htmlStr.=("<td>&nbsp;<input type=\"hidden\"name=\"excessRDAIdArr[" . $cntId . "]\" value=\"\" /></td>\n");
						
					}
					else {
							if($qtyUndelivered == 0)
								$qtyUndelivered='';
						// FOR PUB DATE
						print("<td align=\"center\">" . ($dispEffDt != "" ? htmlentities($dispEffDt, ENT_QUOTES) : "&nbsp;") . "</td>\n");

						// FOR EXCESS UNDELIVERED QUANTITY
						
						print("<td>");
						print("<input type=\"hidden\"name=\"excessRDAIdArr[" . $cntId . "]\" value=\"$rdaRecId\" />\n");
						print("<input type=\"text\" name=\"qtyUnDeliveredArr[" . $cntId . "]\" value=\"$qtyUndelivered\" size=\"5\" maxlength=\"5\" onchange=\"CheckOne('auditRtRDAIdArr', '" . $cntId . "')\" tabindex=\"" . ( $cntId + 1 ) . "\" />");
						print("</td>\n");
						
						/*=======For email ========*/
						$htmlStr.=("<td align=\"center\">" . ($dispEffDt != "" ? htmlentities($dispEffDt, ENT_QUOTES) : "&nbsp;") . "</td>\n");

						// FOR EXCESS UNDELIVERED QUANTITY
						
						$htmlStr.=("<td>");
						$htmlStr.=("<input type=\"text\" name=\"qtyUnDeliveredArr[" . $cntId . "]\" value=\"$qtyUndelivered\" size=\"5\" maxlength=\"5\" onchange=\"CheckOne('auditRtRDAIdArr', '" . $cntId . "')\" tabindex=\"" . ( $cntId + 1 ) . "\" />");
						$htmlStr.=("</td>\n");
						
					}

					print("</tr>\n");
					$htmlStr.=("</tr>\n");
					$cntId++;
					
					//if(!isset($groupdata[$routegroupid]) || $groupdata[$routegroupid]== "")
						$groupdata[$routegroupid][] = array(
							"routedesc" => $routedesc,
							"prodDesc" => $prodDesc,
							"dateXRet" => $dateXRet,
							"qtyRetd" => $qtyRetd,
							"specProdId" => $specProdId,
							"specRtId" => $specRtId,
							"rdaRecId" => $rdaRecId,
							"dispEffDt" => $dispEffDt,
							"qtyUndelivered" => $qtyUndelivered
						);
					
		
				}
				
						
			
			}
			print("</table>\n");
			$htmlStr.=("</table>\n");	
			
	if($val_RAGRP == "Y"){	
			
		foreach( $groupdata as $routegroupid => $groupsdatails) { 

			$fileLineNbr = __LINE__; $rsltArray = GetTableInfo($debug, $cvtconnection, "routegroup", $routegroupid, "CONCAT_WS(' - ', NULLIF(groupsdesc, ''), NULLIF(subgroupsdesc, '')) groupDesc");
			if($rsltArray[rtvalue]) {
				$groupDesc = $rsltArray[groupDesc];
			}
			else {
				$groupDesc = "";
			}
 $htmlStr1 .= ("<div class=\"datawhite\">");	


			$htmlStr1.= ("<div class=\"pagebreakdata\" style=\"text-align:center;font-size:1.6em;\"><b>". htmlentities($groupDesc, ENT_QUOTES) . "</b></div><br />");
				$htmlStr1.= ("<table border=\"1\" width=\"100%\" cellspacing=\"0\" cellpadding=0>\n");
				$htmlStr1.=("<tr class=\"datatblhdr\">\n");
					if($debug) {
						$htmlStr1.=("<td colspan=\"3\">&nbsp;</td>\n");
					}
					else {
						$htmlStr1.=("<td colspan=\"2\">&nbsp;</td>\n");
					}
					
					
					$htmlStr1.=("<td colspan=\"2\" align=\"center\" style=\"font-size: 1.4em;\" ><b>Audited Returns</b></td>\n");
					$htmlStr1.=("<td colspan=\"2\" align=\"center\" style=\"font-size: 1.4em;\"><b>Excess Undelivered</b></td>\n");
				$htmlStr1.=("</tr>");

				$htmlStr1.=("<tr class=\"datatblhdr\">\n");
					$htmlStr1.("<td>srId - spId</td>\n");	
					//print("<td align=\"center\"><input type=\"checkbox\" name=\"checkall\" value=\"checkall\" onclick=\"CheckBoxAll(this.form, this.checked, 'auditRtRDAIdArr')\" /></td>\n");
					$htmlStr1.=("<td style=\"font-size: 1.2em;\"  ><b>Route</b></td>\n");
					$htmlStr1.=("<td style=\"font-size: 1.2em;\" ><b>Publication</b></td>\n");
					$htmlStr1.=("<td style=\"font-size: 1.2em;\"  align=\"center\"><b>Pub Date</b></td>\n");
					$htmlStr1.=("<td style=\"font-size: 1.2em;\"  ><b>Quantity</b></td>\n");
					$htmlStr1.=("<td style=\"font-size: 1.2em;\" align=\"center\"><b>Pub Date</b></td>\n");
					$htmlStr1.=("<td style=\"font-size: 1.2em;\" ><b>Quantity</b></td>\n");
					$htmlStr1.=("</tr>");
					
					foreach( $groupsdatails as $key => $groups) {   
						$htmlStr1.= ("<tr class=\"datawhite\">\n");
							$htmlStr1.= ("<td>".$groups['routedesc']."</td>\n");
							$htmlStr1.= ("<td >".$groups['prodDesc']."</td>\n");
							$htmlStr1.= ("<td >".$groups['dateXRet']."</td>\n");
							$htmlStr1.=("<td>");
							$htmlStr1.=("<input type=\"text\" name=\"qtyRetd\" value=\"".$groups['qtyRetd']."\" size=\"5\" maxlength=\"5\" />");
							$htmlStr1.=("</td>\n");

							if($groups['specProdId'] == 0 || $groups['specRtId'] == 0 || $groups['rdaRecId'] == 0) {
								$htmlStr1.=("<td>&nbsp;</td>\n");
								$htmlStr1.=("<td>&nbsp;</td>\n");
								
							}
							else {
								$htmlStr1.= ("<td align=\"right\">".$groups['dispEffDt']."</td>\n");						
								$htmlStr1.=("<td>");
								$htmlStr1.=("<input type=\"text\" name=\"qtyUnDeliveredArr\" value=\"".$groups['qtyUndelivered']."\" size=\"5\" maxlength=\"5\" />");
								$htmlStr1.=("</td>\n");
								
							}		
						$htmlStr1.= ("</tr>\n");
				  // echo '<br>'.$groups['routedesc']; // Prints something like Nov 18, 2011
					}   
				$htmlStr1.= ("</table>\n");	
			//	$htmlStr1.= ("<br clear=all style=\"page-break-after:always\">\n");
				$htmlStr1.= ("<br><br>\n");	
			$htmlStr1.= ("</div>\n");
		} 

	}
		
}
		$htmlStr .= ("</div>");
		//print($htmlStr1);
		
		if($val_RAGRP != "Y"){
			$_SESSION[TRA37DISPHTMLSTR]=$htmlStr;
		}
		else{
			$_SESSION[TRA37DISPHTMLSTR]=$htmlStr1;
		}
				
		
		// FOR HIDDEN
		print("<input type=\"hidden\" name=\"PageNbr\" value=\"$PassedPageNbr\" />\n");
		print("<input type=\"hidden\" name=\"doAction\" value=\"$doAction\" />\n");
		print("<input type=\"hidden\" name=\"pdid\" value=\"$pdid\" />\n");
		print("<input type=\"hidden\" name=\"Act\" value=\"$Act\" />\n");
		print("<input type=\"hidden\" name=\"incLoc\" value=\"$incLoc\" />\n");
		print("<input type=\"hidden\" name=\"noRecords\" value=\"$cntId\" />\n");
			print("<br /><br />\n");
			// HERE DISPLAY THE EMAIL LINK
			
				print("<div class=\"datawhite\" align=\"center\">\n");
				print("<br /><a href=\"" . htmlspecialchars("tra37.php?PageNbr=$PassedPageNbr&doAction=AuditQtyEmail&dispEffDt=$dispEffDt", ENT_QUOTES) . "\">EMail</a>\n");
				
		// FOR POST
		print("&nbsp;&nbsp;&nbsp;\n");
		print("<a href=\"javascript:SubmitLevel2Form(document.level2Form,'AddReturnsAudit');\">Post</a><br />\n");

		print("</form>\n");
		print("</div>\n");
		break;
		
		
	case "AuditQtyEmail":
	$debug=0;
			if( isset($_SESSION[TRA37DISPHTMLSTR]) )
				$dispHtmlStr = $_SESSION[TRA37DISPHTMLSTR];
		
			if($debug)
				print($dispHtmlStr);
		

			$persEmailIdArray = array();
			$qryGetInfo = "SELECT pl.personid, p.email
							FROM personlink pl, person p, notifyperson np
							WHERE pl.locationid = $ASLocationID
							AND pl.personid = p.recid
							AND pl.recid = np.personlinkid
							AND np.groupcode = 'RAU'
							AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00'
							OR pl.endeffdt > '$dbEffDt' )";

			if($debug)
				print($qryGetInfo . "<br />\n");
			//$persEmailIdArray = array();
			$rsltGetInfo = mysqli_query( $cvtconnection, $qryGetInfo);
			if(!$rsltGetInfo) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($fileLineNbr);
			}
			else {
				if(mysqli_num_rows($rsltGetInfo) == 0) {
					
					$persEmailId = "";
				}
				else {
					
					while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
						$persEmailId = $rowGetInfo[email];
						$persEmailId =  str_replace(";", ",", "$persEmailId");

						array_push($persEmailIdArray, $persEmailId);
					}
				}
			}
			
			if(count($persEmailIdArray) == 0) {
				$mailMsg = "Email Address - not found for Person <br /><br />";
			}
			else {
				$fileLineNbr = __LINE__; $fromCompName = GetComp($ASCompanyID, $cvtconnection);
				if($debug)
					print("$fromCompName <br />\n");
				
				$dispEffDtSub= date('d-M-Y', strtotime($dispEffDt));	
				$dispachgroups = "Record Returns Audit" . " for " . $dispEffDtSub;	
				$from = "\"$fromCompName\" <$val_EMLID>";
				$toArr = $persEmailIdArray;
				$subject = $dispachgroups;
				$msg = $dispHtmlStr;
				$mail = new htmlMimeMail();

				// SET MESSAGE
				$mail->setHtml($msg);

				// SEND MAIL
				$mail->setFrom($from);
				$mail->setSubject($subject);
				if($mail->send($toArr, "mail")) {
					$to = implode(', ', $toArr);
					$mailMsg = "Mail Sent to $to";
				}
				else {
					$mailMsg = "Mail Not Sent for Route Group- Some problem exist";
				}
			}

			include('../cm/html-secondwindow.php');
			print("<div class=\"datawhite\">");
			print("<br /><b>$mailMsg</b><br />");
			print("<br /><a href=\"" . htmlspecialchars($Back, ENT_QUOTES) . "\">OK</a>");
			print("</div>\n");
			include('../cm/html-bottom-secondwindow.php');
		break;
		

	case "AddReturnsAudit":

		if(isset($auditRtRDAIdArr) && count($auditRtRDAIdArr) > 0) {

			while(list($cntId, $rdaId) = each($auditRtRDAIdArr)) {
				$qtyRetd = $qtyRetdArr[$cntId];
				ValidateForInt(false, "rdaId", "qtyRetd");

				// QRY TO UPDATE AUDIT RETURNS QUANTITIES
				$qryUp = "UPDATE routedrawaccounting
							SET qtyretd = $qtyRetd,
							archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
							WHERE recid = $rdaId";

				// FOR SPLITTING THE TABLE
				$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

				if($debug)
					print("<b>" . $qryUp . "</b><br />\n");
				$rsltUp = mysqli_query( $cvtconnection, $qryUp);
				if(!$rsltUp) {
					$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($fileLineNbr);
				}
				else {
					if($debug)
						print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
				}

				// UPDATE THE EXCESS UNDELIVERED QUANTITY IF EXIST
				$rdaRecid = $excessRDAIdArr[$cntId];
				if(!is_numeric($rdaRecid))	$rdaRecid = 0;
				if($rdaRecid != 0) {
					$qtyUndelivered = $qtyUnDeliveredArr[$cntId];
					if(!is_numeric($qtyUndelivered)) $qtyUndelivered = 0;

					// QRY TO UPDATE ROUTEDRAWACCOUNTING
					$qryUp = "UPDATE routedrawaccounting
								SET qtyundelivered = $qtyUndelivered,
								archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
								WHERE recid = $rdaRecid";

					// FOR SPLITTING THE TABLE
					$qryUp = convertToSplitTables($qryUp, $val_SPLIT);

					if($debug)
						print("<b>" . $qryUp . "</b><br />\n");
					$rsltUp = mysqli_query( $cvtconnection, $qryUp);
					if(!$rsltUp) {
						$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(19, 03);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($fileLineNbr);
					}
					else {
						if($debug)
							print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
					}
				}
			}
		}

		if($debug) {
			print("<a href=\"" . urldecode($Back) . "\">Back</a><br />\n");
		}
		else {
			header("Location: " . urldecode($Back));
		}
		break;

	default:
		print("You have left the case for <b>" . htmlentities($doAction, ENT_QUOTES) . "</b><br /><br />\n");
		print("Go To <a href=\"../cm/men01.php\">Data</a> Pages<br /><br />\n");
		break;
}
?>
<?
##################
#	B JAVASCRIPT:
##################
?>
<?
##################
#	FOOTER:
##################
$PageNbr = $PassedPageNbr;
switch($doAction) {
		case "ToQtyRecd":
		case "ToSelRouteSet":
                case "ToCheckDrivers":
		case "EditDriver":
		case "ToCheckRuns":
		case "ToAddLoc":
		case "ToDelLoc":
		case "PrintForms":
		case "ToAddAddlDr":
		case "ToAddSpecificRoute":
		case "ToMergeRoutes":
		case "DispExtraDrawSplit":
		case "ToAddExtraDrawSplit":
		case "DispReturnsAudit":
		case "ToSelectRoutes":
			include('../cm/html-bottomentryscreen1.php');
			break;

		case "PrintSheet":
		case "DrawPrintSheet" : //Task#8891
		case "PrintRouteSheet":
		case "PrintRecdReport":
		case "EmBack":
		case "WarnSelRouteSet":
		case "ToCloseDraw":
		case "ToCloseDrawForce":
		case "ActExistMsg":
		case "SelRoutes":
		case "AutoFillRemaining":
		case "ShowDeliverySlips":
		case "DeliverySlipPost":
		case "ShowDraw":
		case "PreBundleSlip":
		case "ShowCalculatedDraw":
		case "ShowCostCode":
		case "PubRegion":
		case "DistRegion":
		case "Group":
		case "Route":
		case "Manual":
		case "Demographic":
		case "LagSlips":
		case "DispRoute":
		case "PrintRouteSummary":
		case "PrintEditionLocation":
		case "EmailRegion":
		case "WarnEmRegion":
		case "EmailRegionForce":
		case "ActualRoute":
		case "RouteGroup":
		case "AddQtyRoute":
		case "InsertQtyRoute":
     /* 3.2 */  case "ToSelRouteGroup": /* 3.2 */
                case "ProcessERP":
			include('../cm/html-bottom-secondwindow.php');
			break;

		case "QtyRecd":
		case "QtyRoute":
		case "SelRouteSet":
		case "SelRouteSetForce":
		case "UpdateDriver":
		case "Update":
		case "UpdateRegDispatch":
		case "AddAddlDr":
		case "DeleteAddlDr":
		case "AddSpecificRoute":
		case "DelSpecificRoute":
		case "MergeRoutes":
		case "SetBundleRound":
		case "ShowCostCodeEmail":
		case "PubRegionEmail":
		case "DistRegionEmail":
		case "GroupEmail":
		case "RouteEmail":
		case "ActualRouteEmail":
		case "ManualEmail":
		case "DemoEmail":
		case "PostRoute":
		case "AddExtraDrawSplit":
		case "DeleteExtraDrawSplit":
		case "UpdateExtraDrawSplit":
		case "AddReturnsAudit":
		case "RouteGroupEmail":
		case "RouteNotifyGroupEmail":
		case "AuditQtyEmail":
		case "EmailEditionLocation":
      /* 3.2 */ case "SelRouteGroup": /* 3.2 */
			break;

		case "CreateRunRecs":
			// ABOVE ALL ARE CASE WHICH ARE CALLING BACK LINK
			// AND THEIR BACK VALUE SET IN THAT CASE ONLY

			break;
		default:
			if(!isset($OtherPageNbr) || $OtherPageNbr == "") {
				include('../cm/html-bottom1.php');
			}
			else {
				include('../cm/html-bottomentryscreen1.php');
			}
			break;
}
?>
<?
##################
#	FUNCTIONS:
##################
/* HERE ALL THE SCREEN SPECIFIC FUNCTIONS WILL COME */

/*
	FUNCTION TO GET LAST HISTORY PageNbr
*/
function GetPageQueryStringInfo($Back, $cvtconnection, $RecIdAS) {

    $urlArr = parse_url($Back);
	$urlQueryStr = $urlArr[query];
	parse_str($urlQueryStr, $urlQueryStrArr);
	$urlQueryStrArr[LASTFILE] = basename($urlArr[path]);

	return $urlQueryStrArr;
}

function MapSpecRtToSched($srid, $routeType) {
	if(!is_numeric($srid)) $srid = 0;

	if($srid == 0) return false;

	// UPDATE BASED ON ROUTETYPE
	if(in_array($routeType, $GLOBALS[stdrt_array])) {
		$routeType = "SR";
	}
	elseif(in_array($routeType, $GLOBALS[rtcolrt_array])) {
		$routeType = "CR";
	}
	elseif(in_array($routeType, $GLOBALS[rtcolrt_array])) {
		$routeType = "CO";
	}
	elseif(in_array($routeType, $GLOBALS[rtcolrt_array])) {
		$routeType = "RR";
	}
	elseif($routeType == "PR") {
		$routeType = "SR";
	}elseif($routeType == "ND") {
		$routeType = "SR";
	}
	else {
		$routeType = "";
	}


	if($routeType == "") return false;

	if($routeType == "RR") {
		$rtflag = "R";
		$tatype_str = "'SP'";
	}
	elseif($routeType == "CR") {
		$rtflag = "R";
		$tatype_str = "'SP'";
	}
	elseif($routeType == "CO") {
		$rtflag = "R";
		$tatype_str = "'SP'";
	}
	else {
		$rtflag = "D";
		$tatype_str = "'SD', 'SP'";
	}
	//echo $routeType."------>";
	// GET SPECIFICROUTES.DRIVERID
	$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetTableInfo($GLOBALS[debug], $GLOBALS[cvtconnection], "specificroutes", $srid, "driverid", "DATE_FORMAT(datesked, '%Y-%m-%d') datesked");
	if($rsltArr[rtvalue]) {
		$driverid = $rsltArr[driverid];
		$datesked = $rsltArr[datesked];

		if(!is_numeric($driverid)) $driverid = 0;
	}
	else {
		$driverid = 0;
		$datesked = "";
	}
	unset($GLOBALS[fileLineNbr]);

	// FINDIND LOCATIONS FOR SELECTED ROUTE FOR SP.
	$qryGetLocs = "SELECT DISTINCT srl.locationid locid
					FROM specificrouteloc srl, specificroutes sr, location l
					WHERE sr.dispatchlocid = $GLOBALS[ASLocationID]
					AND sr.recid = $srid
					AND srl.specificrouteid = sr.recid
					AND srl.clientlocid = $GLOBALS[ASLocationID]
					AND srl.locationid = l.recid
					AND l.type != 'G'";

	// FOR SPLITTING OF TABLES
	$qryGetLocs = convertToSplitTables($qryGetLocs, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print($qryGetLocs . "<br />\n");
	$rsltGetLocs = mysqli_query( $GLOBALS[cvtconnection], $qryGetLocs);

	if(!$rsltGetLocs) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " .
		$strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		if(mysqli_num_rows($rsltGetLocs) == 0) {
			$locIdStr = "";
		}
		else {
			$locIdArr = array();
			while($rowGetLocs = mysqli_fetch_assoc($rsltGetLocs)) {
				array_push($locIdArr, $rowGetLocs[locid]);
			}
			$locIdStr = implode(", ", $locIdArr);
			unset($locIdArr);
		}
	}

	if($locIdStr == "") {
		$locIdStr = "0";
	}

	if($routeType == "SR") {
		// lets first do for SD
		$qryUp = "UPDATE transactivity ta 
					SET ta.specificrouteid = $srid,
					ta.personid = $driverid,
					ta.activesession = $GLOBALS[RecIdAS],
					ta.archupdt = IF(ta.archupdt IN ('X', 'P'), 'U', ta.archupdt)
					WHERE ta.customerlocid IN (" . $locIdStr . ")
					AND ta.locationid = $GLOBALS[ASLocationID]
					AND ta.datet = '$datesked'
					AND ta.type IN ('SD','DE')
					AND ( ta.specificrouteid IS NULL OR ta.specificrouteid = 0 )";

		// FOR SPLITTING OF TABLES
		$qryUp = convertToSplitTables($qryUp, $GLOBALS[val_SPLIT]);

		if($GLOBALS[debug])
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
		if(!$rsltUp) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(14, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			if($GLOBALS[debug]) print("<b>Affected Rows = " . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b><br />\n");
		}
	}

	if($routeType != "CR" && $routeType != "CO" && $routeType != "RR" && $rtflag != "R") {

	// FINDIND LOCATIONS FOR selected=\"selected\" ROUTE FOR SP.
	$qryGetLocs = "SELECT DISTINCT srl.locationid locid
					FROM specificrouteloc srl, specificroutes sr,
					routelink rl
					WHERE sr.dispatchlocid = $GLOBALS[ASLocationID]
					AND sr.recid = $srid
					AND srl.specificrouteid = sr.recid
					AND srl.clientlocid = $GLOBALS[ASLocationID]
					AND rl.locationid = srl.locationid
					AND rl.clientid = $GLOBALS[ASCompanyID]
					AND rl.returnsflag = '$rtflag'
					AND ( rl.endeffdt IS NULL OR rl.endeffdt = '0000-00-00' OR rl.endeffdt > '$curDate' )";

	// FOR SPLITTING OF TABLES
	$qryGetLocs = convertToSplitTables($qryGetLocs, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print($qryGetLocs . "<br />\n");
	$rsltGetLocs = mysqli_query( $GLOBALS[cvtconnection], $qryGetLocs);

	if(!$rsltGetLocs) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " .
		$strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		if(mysqli_num_rows($rsltGetLocs) == 0) {
			$spLocIdStr = "";
		}
		else {
			$locIdArr = array();
			while($rowGetLocs = mysqli_fetch_assoc($rsltGetLocs)) {
				array_push($locIdArr, $rowGetLocs[locid]);
			}
			$spLocIdStr = implode(", ", $locIdArr);
			unset($locIdArr);
		}
	}

	if($spLocIdStr == "") {
		$spLocIdStr = "0";
	}

	// now for SP
####	$qryUp = "UPDATE transactivity ta, specificroutes sr, specificrouteloc srl,
####				routelink rl
####				SET ta.specificrouteid = $srid,
####				ta.personid = sr.driverid,
####				ta.activesession = $GLOBALS[RecIdAS]
####				WHERE sr.recid = $srid
####				AND srl.specificrouteid = sr.recid
####				AND ta.customerlocid = srl.locationid
####				AND ta.locationid = $GLOBALS[ASLocationID]
####				AND ta.datet = sr.datesked
####				AND ta.type IN ('SP')
####				AND ( ta.specificrouteid IS NULL OR ta.specificrouteid = 0 )
####				AND rl.locationid = srl.locationid
####				AND rl.clientid = $GLOBALS[ASCompanyID]
####				AND rl.returnsflag = '$rtflag'";

	$qryUp = "UPDATE transactivity ta 
				SET ta.specificrouteid = $srid,
				ta.personid = $driverid,
				ta.activesession = $GLOBALS[RecIdAS],
				ta.archupdt = IF(ta.archupdt IN ('X', 'P'), 'U', ta.archupdt)
				WHERE ta.customerlocid IN (" . $spLocIdStr . ")
				AND ta.locationid = $GLOBALS[ASLocationID]
				AND ta.datet = '$datesked'
				AND ta.type IN ('SP')
				AND ( ta.specificrouteid IS NULL OR ta.specificrouteid = 0 )";

	// FOR SPLITTING OF TABLES
	$qryUp = convertToSplitTables($qryUp, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print("<b>" . $qryUp . "</b><br />\n");
	$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
	if(!$rsltUp) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(14, 03);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " .
		$strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
		return false;
	}
	else {
		if($GLOBALS[debug]) print("<b>Affected Rows = " . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b><br />\n");
		return true;
	}
  }
  else
  {
  return true;
  }	
}

// THIS FUNCTION WILL CHECK WHETHER ALL LOCATIONS ON THIS SPECRT HAVE VALID BARCODE OR NOT
function NullBarcode($srid) {
	if(!is_numeric($srid)) $srid = 0;

	if($srid == 0) {
		return false;
	}
	else {
		$qryChkRecs = "SELECT COUNT(*)
						FROM specificrouteloc srl, routelink rl
						WHERE srl.clientlocid = $GLOBALS[ASLocationID]
						AND srl.specificrouteid = $srid
						AND rl.locationid = srl.locationid
						AND rl.clientid = $GLOBALS[ASCompanyID]
						AND ( rl.barcode IS NULL OR rl.barcode = '' )";

		// FOR SPLITTING OF TABLES
		$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);

		if($GLOBALS[debug])
			print($qryChkRecs . "<br />\n");
		$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
		$flagExist = false;

		if(!$rsltChkRecs) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			if($rowChkRecs = mysqli_fetch_row($rsltChkRecs)) {
				$NoRecs = $rowChkRecs[0];
				if(!is_numeric($NoRecs)) $NoRecs = 0;
				if($NoRecs > 0) $flagExist = true;
			}
		}

		return $flagExist;
	}
}

// THIS FUNCTION IS USED TO CHECK WHETHER THE SPECIFIED LOCATION IS ACTIVE ON THE
//GIVEN DATE OR NOT - DEPENDING ON THE ROUTESET.TYPE
function IsActiveLoc($locid, $dbEffDt) {
	if(!is_numeric($locid)) $locid = 0;

	//if($locid == 0 || $rstype == "" || $dbEffDt == "") return false;
	if($locid == 0 || $dbEffDt == "") {
		return false;
	}
	else {
		//FIRST THREE CONDITIONS ARE COMMON SO LET'S TRY WITH IT
		$qryChkRecs = "SELECT COUNT(*) FROM location
						WHERE recid = $locid
						AND effdate > '$dbEffDt'
						AND endeffdate < '$dbEffDt'";
		if($GLOBALS[debug])
			print($qryChkRecs . "<br />\n");
		$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
		$flagExist = false;
		if(!$rsltChkRecs) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			if($rowChkRecs = mysqli_fetch_row($rsltChkRecs)) {
				$NoRecs = $rowChkRecs[0];
				if(!is_numeric($NoRecs)) $NoRecs = 0;
				if($NoRecs > 0) $flagExist = true;
			}
		}

		if($flagExist) return false;

		$qryChkRecs = "SELECT COUNT(*) FROM customervacation
						WHERE locationid = $locid
						AND todate = '{$GLOBALS[val_INDEF]}'";
		if($GLOBALS[debug])
			print($qryChkRecs . "<br />\n");
		$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
		$flagExist = false;
		if(!$rsltChkRecs) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			if($rowChkRecs = mysqli_fetch_row($rsltChkRecs)) {
				$NoRecs = $rowChkRecs[0];
				if(!is_numeric($NoRecs)) $NoRecs = 0;
				if($NoRecs > 0) $flagExist = true;
			}
		}

		if($flagExist) return false;

		//NOW FOR  HOLIDAYS
		$qryChkRecs = "SELECT COUNT(*)
						FROM holidays h, holidayslink hl, holidaylocationlink hll
						WHERE hll.locationid = $locid
						AND h.recid = hll.holidaysid
						AND ( h.endeffdt IS NULL OR h.endeffdt = '0000-00-00'
						OR h.endeffdt > '$curDate' )
						AND hl.holidaysid = hll.holidaysid
						AND h.holidaydate = '$dbEffDt'
						AND hl.clientid = $ASCompanyID
						AND ( hl.endeffdt IS NULL OR hl.endeffdt = '0000-00-00' OR hl.endeffdt > '$effectiveDate' )";
		if($GLOBALS[debug])
			print($qryChkRecs . "<br />\n");
		$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
		$flagExist = false;
		if(!$rsltChkRecs) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			if($rowChkRecs = mysqli_fetch_row($rsltChkRecs)) {
				$NoRecs = $rowChkRecs[0];
				if(!is_numeric($NoRecs)) $NoRecs = 0;
				if($NoRecs > 0) $flagExist = true;
			}
		}

		if($flagExist) return false;

		//GET THE DAY
		$qryGetD = "SELECT LCASE(DATE_FORMAT('$dbEffDt', '%a')) dow";
		if($GLOBALS[debug])
			print($qryGetD . "<br />\n");
		$rsltGetD = mysqli_query( $GLOBALS[cvtconnection], $qryGetD);
		if(!$rsltGetD) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			$rowGetD = mysqli_fetch_assoc($rsltGetD);
			$dow_effdt = $rowGetD[dow];
			$qtyfield = "qty" . $dow_effdt;
		}

		// CREATE TEMPORARY TABLE FOR COMPARISON WITH STANDARDDRAW
		CreateTemp_StdDraw($dbEffDt, array("locid" => $locid));

		$qryGetSD = "SELECT sd.productid prodid, sd.$qtyfield qty
					FROM standarddraw sd, tmp_stddraw tsd
					WHERE sd.customerlocid = $locid
					AND sd.clientlocid = $GLOBALS[ASLocationID]
					AND sd.effdt <= '$dbEffDt'
					AND ( sd.endeffdt IS NULL OR sd.endeffdt = '0000-00-00'
					OR sd.endeffdt > '$dbEffDt' )
					AND sd.productid = tsd.productid
					AND sd.seasondetailid = tsd.seasondetailid
					AND sd.effdt = tsd.effdt
					ORDER BY qty DESC";
		if($GLOBALS[debug])
			print($qryGetSD . "<br />\n");
		$rsltGetSD = mysqli_query( $GLOBALS[cvtconnection], $qryGetSD);

		if(!$rsltGetSD) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			// FOR CHECKING WHETHER SD EXIST OR NOT
			$flag_sd_exist = false;
			if(mysqli_num_rows($rsltGetSD) > 0)
				$flag_sd_exist = true;

			$flagExist = false;

			while($rowGetSD = mysqli_fetch_assoc($rsltGetSD)) {
				$prodid = $rowGetSD[prodid];
				$qty = $rowGetSD[qty];

				ValidateForInt(false, "prodid", "qty");
				if($qty > 0) {
					// COMPARE WITH THE LEADLAG QTY
					$rsltArr = GetLeadLagQty_StdDraw($locid, $prodid, $dbEffDt);
					if($rsltArr[flagExist]) {
						if($rsltArr[leadlagqty] == 0) {
							continue;
						}
						else {
							if(( $qty - $rsltArr[leadlagqty] ) > 0) {
								$flagExist = true;
								break;
							}
						}
					}
					else {
						$flagExist = true;
						break;
					}
					unset($rsltArr);
				}
			}
		}

		// TRUNCATE TABLE
		DropTmp_TRA37("tmp_stddraw");

		if($flagExist) return true;

		if($flag_sd_exist) {
			// ARRAYS FOR INDEX TO DAY AND DAY TO INDEX CONVERSION
			$index2dow_array = GeneralArray("dowtoday");
			//$dow2index_array = array_reverse($index2dow_array, TRUE);
			$dow2index_array = array_flip($index2dow_array);

			// HERE WE NEED TO CHECK WHETHER ANY OF THE LEADLAG ENTRY EXIST
			// FOR TODAY OR NOT.
			$qryGetSL = "SELECT DISTINCT(day), leadlag
						FROM stddrawleadlag
						WHERE customerlocid = $locid
						ORDER BY day";
			if($GLOBALS[debug])
				print($qryGetSL . "<br />\n");
			$rsltGetSL = mysqli_query( $GLOBALS[cvtconnection], $qryGetSL);
			if(!$rsltGetSL) {
				$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($GLOBALS[fileLineNbr]);
			}
			else {
				while($rowGetSL = mysqli_fetch_assoc($rsltGetSL)) {
					$day_stdll = $rowGetSL[day];
					$leadlag = $rowGetSL[leadlag];
					if(!is_numeric($leadlag)) $leadlag = 0;

					$index_dow_stdll = $dow2index_array[strtoupper($day_stdll)];
					$index_dow_leadlag = $index_dow_stdll + $leadlag;
					if($index_dow_leadlag < 0) $index_dow_leadlag += 7;
					$dow_leadlag = $index2dow_array[$index_dow_leadlag % 7];

					if($GLOBALS[debug]) print("dow_leadlag = $dow_leadlag && dow_effdt = $dow_effdt<br />");
					if(strtoupper($dow_leadlag) == strtoupper($dow_effdt)) {
						$flagExist = true;
						break;
					}
				}
			}
		}

		if(!$flagExist) return false;

		return true;
	}
}


/*
// THIS FUNCTION IS USED TO CHECK WHETHER THE SPECIFIED LOCATION IS ACTIVE ON THE
//GIVEN DATE OR NOT - DEPENDING ON THE ROUTESET.TYPE
function IsActiveLoc($locid, $rstype, $dbEffDt) {
	if(!is_numeric($locid)) $locid = 0;

	if($locid == 0 || $rstype == "" || $dbEffDt == "") return false;
	else {
		//FIRST THREE CONDITIONS ARE COMMON SO LET'S TRY WITH IT
		$qryChkRecs = "SELECT COUNT(*) FROM location
						WHERE recid = $locid
						AND effdate >= '$dbEffDt'
						AND endeffdate < '$dbEffDt'";
		if($GLOBALS[debug]) print($qryChkRecs . "<br />\n");
		$rsltChkRecs = mysql_query($qryChkRecs, $GLOBALS[cvtconnection]);
		$flagExist = false;
		if($rowChkRecs = mysql_fetch_row($rsltChkRecs)) {
			$NoRecs = $rowChkRecs[0];
			if(!is_numeric($NoRecs)) $NoRecs = 0;
			if($NoRecs > 0) $flagExist = true;
		}



		if($flagExist) return false;

		//NOW FOR CUSTOMER VACATION
		$qryChkRecs = "SELECT COUNT(*) FROM customervacation
						WHERE locationid = $locid
						AND todate = '{$GLOBALS[val_INDEF]}'";
		if($GLOBALS[debug]) print($qryChkRecs . "<br />\n");
		$rsltChkRecs = mysql_query($qryChkRecs, $GLOBALS[cvtconnection]);
		$flagExist = false;
		if($rowChkRecs = mysql_fetch_row($rsltChkRecs)) {
			$NoRecs = $rowChkRecs[0];
			if(!is_numeric($NoRecs)) $NoRecs = 0;
			if($NoRecs > 0) $flagExist = true;
		}

		if($flagExist) return false;

		//NOW FOR  HOLIDAYS
		$qryChkRecs = "SELECT COUNT(*)
						FROM holidays h, holidaylocationlink hll
						WHERE hll.locationid = $locid
						AND h.recid = hll.holidaysid
						AND ( h.endeffdt IS NULL OR h.endeffdt = '0000-00-00'
						OR h.endeffdt > '$curDate' )
						AND h.holidaydate = '$dbEffDt'";
		if($GLOBALS[debug]) print($qryChkRecs . "<br />\n");
		$rsltChkRecs = mysql_query($qryChkRecs, $GLOBALS[cvtconnection]);
		$flagExist = false;
		if($rowChkRecs = mysql_fetch_row($rsltChkRecs)) {
			$NoRecs = $rowChkRecs[0];
			if(!is_numeric($NoRecs)) $NoRecs = 0;
			if($NoRecs > 0) $flagExist = true;
		}

		if($flagExist) return false;

		switch($rstype) {
			case "SR":
			case "HO":
				//GET THE DAY
				$qryGetD = "SELECT LCASE(DATE_FORMAT('$dbEffDt', '%a')) dow";
				if($GLOBALS[debug]) print("$qryGetD<br />");
				$rsltGetD = mysql_query($qryGetD, $GLOBALS[cvtconnection]);
				$rowGetD = mysql_fetch_assoc($rsltGetD);
				$dow_effdt = $rowGetD[dow];
				$qtyfield = "qty" . $dow_effdt;

				$qryChkRecs = "SELECT COUNT(*) FROM standarddraw
								WHERE customerlocid = $locid
								AND clientlocid = $GLOBALS[ASLocationID]
								AND effdt <= '$dbEffDt'
								AND ( endeffdt IS NULL OR endeffdt = '0000-00-00'
								OR endeffdt > '$dbEffDt' )
								AND $qtyfield <> 0
								AND $qtyfield IS NOT NULL";
				if($GLOBALS[debug]) print($qryChkRecs . "<br />\n");
				$rsltChkRecs = mysql_query($qryChkRecs, $GLOBALS[cvtconnection]);
				$flagExist = false;
				if($rowChkRecs = mysql_fetch_row($rsltChkRecs)) {
					$NoRecs = $rowChkRecs[0];
					if(!is_numeric($NoRecs)) $NoRecs = 0;
					if($NoRecs > 0) $flagExist = true;
				}

				if(!$flagExist) {
					// arrays for index to day and day to index conversion
					$index2dow_array = GeneralArray("dowtoday");
					$dow2index_array = array_flip($index2dow_array);

					// here we need to check whether any of the leadlag entry exist
					// for today or not.
					$qryGetSL = "SELECT DISTINCT(day), leadlag
								FROM stddrawleadlag
								WHERE customerlocid = $locid
								ORDER BY day";
					if($GLOBALS[debug]) print("$qryGetSL<br />");
					$rsltGetSL = mysql_query($qryGetSL, $GLOBALS[cvtconnection]);
					while($rowGetSL = mysql_fetch_assoc($rsltGetSL)) {
						$day_stdll = $rowGetSL[day];
						$leadlag = $rowGetSL[leadlag];
						if(!is_numeric($leadlag)) $leadlag = 0;

						$index_dow_stdll = $dow2index_array[strtoupper($day_stdll)];
						$index_dow_leadlag = $index_dow_stdll + $leadlag;
						if($index_dow_leadlag < 0) $index_dow_leadlag += 7;
						$dow_leadlag = $index2dow_array[$index_dow_leadlag  % 7];

						if($GLOBALS[debug]) print("dow_leadlag = $dow_leadlag && dow_effdt = $dow_effdt<br />");
						if(strtoupper($dow_leadlag) == strtoupper($dow_effdt)) {
							$flagExist = true;
							break;
						}
					}
				}

				if(!$flagExist) return false;

				break;

			case "RR":
				//CHECK ROUTELINK.RETURNSFLAG
				$selectStr = "returnsflag";
				$fromStr = "routelink";
				$whereStr = "clientid = $GLOBALS[ASCompanyID]
							AND locationid = $locid";
				$rsltArr = GetSingleRecInfo($GLOBALS[cvtconnection], $GLOBALS[debug], $selectStr, $fromStr, $whereStr);
				unset($selectStr, $fromStr, $whereStr);

				if($rsltArr) $retflag = $rsltArr[returnsflag];
				else $retflag = "";
				unset($rsltArr);

				if($returnsFlag == "D") return false;
				break;
		}

		return true;
	}
}
*/

/*
	this function is used to process all locations in a batch. This will be same as
	IsActiveLoc but it will be in batch.

	It will return an array of open locations
*/
function IsActiveLocArray_TRA37($locid_array, $dbEffDt) {
	$rt_array = array();

	if(!is_array($locid_array) || count($locid_array) == 0 || $dbEffDt == "")
		return $rt_array;

	// MAKE STRING
	$locIdStr = MakeStrFromArray($locid_array, ", ", "");
	if($locIdStr == "") $locIdStr = "0";

	/*// first check with effectiveness
	$qryGetL = "SELECT recid FROM location
				WHERE recid IN ($locIdStr)
				AND effdate <= '$dbEffDt'
				AND ( endeffdate IS NULL OR endeffdate = '0000-00-00'
				OR endeffdate > '$dbEffDt' )";
	if($GLOBALS[debug]) print("$qryGetL<br />");
	$rsltGetL = mysql_query($qryGetL, $GLOBALS[cvtconnection]);
	while($rowGetL = mysql_fetch_assoc($rsltGetL)) {
		$locid = $rowGetL[recid];
		if(!is_numeric($locid)) $locid = 0;

		if($locid != 0)
			array_push($rt_array, $locid);
	}

	if(count($rt_array) == 0) return $rt_array;

	$locid_array = $rt_array;

	// remake str from rt_array
	$locIdStr = MakeStrFromArray($rt_array, ", ", "");
	if($locIdStr == "") $locIdStr = "0";

	// now check in customervacation
	$qryGetCV = "SELECT DISTINCT(locationid) locid
				FROM customervacation
				WHERE locationid IN ($locIdStr)
				AND todate = '{$GLOBALS[val_INDEF]}'";
	if($GLOBALS[debug]) print("$qryGetCV<br />");
	$rsltGetCV = mysql_query($qryGetCV, $GLOBALS[cvtconnection]);
	$templocid_array = array();
	while($rowGetCV = mysql_fetch_assoc($rsltGetCV)) {
		$locid = $rowGetCV[locid];
		if(!is_numeric($locid)) $locid = 0;

		if($locid != 0)
			array_push($templocid_array, $locid);
	}
	$rt_array = array_values(array_diff($locid_array, $templocid_array));
	if($GLOBALS[debug]) {
		print_r($rt_array);
		print("<br />\n");
	}
	unset($templocid_array);

	if(count($rt_array) == 0) return $rt_array;

	$locid_array = $rt_array;

	// remake str from rt_array
	$locIdStr = MakeStrFromArray($rt_array, ", ", "");
	if($locIdStr == "") $locIdStr = "0";

	// now for holidays

	$qryGetCV = "SELECT DISTINCT(hll.locationid) locid
				FROM holidays h, holidaylocationlink hll
				WHERE hll.locationid IN ($locIdStr)
				AND h.recid = hll.holidaysid
				AND ( h.endeffdt IS NULL OR h.endeffdt = '0000-00-00'
				OR h.endeffdt > '$curDate' )
				AND h.holidaydate = '$dbEffDt'";
	if($GLOBALS[debug]) print("$qryGetCV<br />");
	$rsltGetCV = mysql_query($qryGetCV, $GLOBALS[cvtconnection]);
	$templocid_array = array();
	while($rowGetCV = mysql_fetch_assoc($rsltGetCV)) {
		$locid = $rowGetCV[locid];
		if(!is_numeric($locid)) $locid = 0;

		if($locid != 0)
			array_push($templocid_array, $locid);
	}

	$rt_array = array_values(array_diff($locid_array, $templocid_array));
	unset($templocid_array);

	if(count($rt_array) == 0) return $rt_array;

	$locid_array = $rt_array;

	// remake str from rt_array
	$locIdStr = MakeStrFromArray($rt_array, ", ", "");
	if($locIdStr == "") $locIdStr = "0";*/

	## CHECKING FOR 'SD' OR 'SP' EXISTS IN THE TRANSACTIVITY
	#// FOR THE GIVEN RUNDATE
	$qryGetTA = "SELECT customerlocid locid
					FROM transactivity 
					WHERE locationid = $GLOBALS[ASLocationID]
					AND type IN ('SD', 'SP')
					AND datet = '$dbEffDt'
					AND customerlocid IN ($locIdStr)
					GROUP BY customerlocid";

	// FOR SPLITTING OF TABLES
	$qryGetTA = convertToSplitTables($qryGetTA, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print("<b>" . $qryGetTA . "</b><br />\n");
	$rsltGetTA = mysqli_query( $GLOBALS[cvtconnection], $qryGetTA);
	$templocid_array = array();
	if(!$rsltGetTA) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		while($rowGetTA = mysqli_fetch_assoc($rsltGetTA)) {
			$locid = $rowGetTA[locid];
			if(!is_numeric($locid)) $locid = 0;

			if($locid != 0)
				array_push($templocid_array, $locid);
		}
	}

	$rt_array = array_values(array_intersect($templocid_array, $locid_array));
	unset($templocid_array);

	// now checking with StandardDraw
	/*//GET THE DAY
	$dow_effdt = strtolower(date("D", mktime(0, 0, 0, substr($dbEffDt, 5, 2), substr($dbEffDt, 8, 2), substr($dbEffDt, 0, 4))));
	$qtyfield = "qty" . $dow_effdt;

	// create temporary table for comparison with standarddraw
	CreateTemp_StdDraw($dbEffDt, array("locid_array" => $rt_array, "flag_donotcreate" => true, "flag_donotlock" => true));*/

	// process the data now for each location
	/*$templocid_array = array();
	for($cntid = 0; $cntid < count($rt_array); $cntid++) {
		$locid = $rt_array[$cntid];

		$qryGetSD = "SELECT sd.productid prodid, sd.$qtyfield qty, sd.ndc
					FROM standarddraw sd, tmp_stddraw tsd
					WHERE sd.customerlocid = $locid
					AND sd.clientlocid = $GLOBALS[ASLocationID]
					AND sd.effdt <= '$dbEffDt'
					AND ( sd.endeffdt IS NULL OR sd.endeffdt = '0000-00-00'
					OR sd.endeffdt > '$dbEffDt' )
					AND sd.productid = tsd.productid
					AND sd.seasondetailid = tsd.seasondetailid
					AND sd.effdt = tsd.effdt
					ORDER BY qty DESC";
		if($GLOBALS[debug]) print("$qryGetSD<br />");
		$rsltGetSD = mysql_query($qryGetSD, $GLOBALS[cvtconnection]);

		// for checking whether sd exist or not
		$flag_sd_exist = false;
		if(mysql_num_rows($rsltGetSD) > 0) {
			$flag_sd_exist = true;
			if($GLOBALS[debug])
				print("$locid, $dbEffDt " . mysql_num_rows($rsltGetSD) . "<br />\n");
		}

		$flagExist = false;
		while($rowGetSD = mysql_fetch_assoc($rsltGetSD)) {
			$prodid = $rowGetSD[prodid];
			$qty = $rowGetSD[qty];
			$ndc = $rowGetSD[ndc];


			ValidateForInt(false, "prodid", "qty");
			if($qty > 0) {
				// compare with the leadlag qty
				$rsltArr = GetLeadLagQty_StdDraw($locid, $prodid, $dbEffDt);
				if($rsltArr[flagExist]) {
					if($rsltArr[leadlagqty] == 0)
						continue;
					else {
						if(( $qty - $rsltArr[leadlagqty] ) > 0) {
							$flagExist = true;
							break;
						}
					}
				}
				else {
					$flagExist = true;
					break;
				}
				unset($rsltArr);
			} elseif($qty == 0 && $ndc == "B") {
				$flagExist = true;
				break;
			}
		}

		if($flagExist) continue;

		if($flag_sd_exist) {
			// arrays for index to day and day to index conversion
			$index2dow_array = GeneralArray("dowtoday");
			//$dow2index_array = array_reverse($index2dow_array, TRUE);
			$dow2index_array = array_flip($index2dow_array);

			if($GLOBALS[debug]) {
				print("<br />\n");
				print_r($index2dow_array);
				print("<br />\n");
				print_r($dow2index_array);
				print("<br />\n");
			}

			## Here we not check the SpecialDraw for the selected Date
			## records exists or not.
			$qryGetSP = "SELECT productid, specificproductdate,
						quantity
						FROM specialdraw
						WHERE locationid = $locid
						AND specificproductdate = '$dbEffDt'";
			if($GLOBALS[debug])
				print($qryGetSP . "<br />\n");
			$rsltGetInfo = mysql_query($qryGetSP, $GLOBALS[cvtconnection]);
			if(mysql_num_rows($rsltGetInfo) == 0) {
			}
			else {
				$flagExist = true;
				continue;
			}

			// here we need to check whether any of the leadlag entry exist
			// for today or not.
			$qryGetSL = "SELECT DISTINCT(day), leadlag
						FROM stddrawleadlag
						WHERE customerlocid = $locid
						ORDER BY day";
			if($GLOBALS[debug]) print("$qryGetSL<br />");
			$rsltGetSL = mysql_query($qryGetSL, $GLOBALS[cvtconnection]);
			while($rowGetSL = mysql_fetch_assoc($rsltGetSL)) {
				$day_stdll = $rowGetSL[day];
				$leadlag = $rowGetSL[leadlag];
				if(!is_numeric($leadlag)) $leadlag = 0;

				$index_dow_stdll = $dow2index_array[strtoupper($day_stdll)];
				$index_dow_leadlag = $index_dow_stdll + $leadlag;
				if($index_dow_leadlag < 0) $index_dow_leadlag += 7;
				$dow_leadlag = $index2dow_array[$index_dow_leadlag  % 7];

				if($GLOBALS[debug]) print("$index_dow_stdll - $index_dow_leadlag  dow_leadlag = $dow_leadlag && dow_effdt = $dow_effdt<br />");
				if(strtoupper($dow_leadlag) == strtoupper($dow_effdt)) {
					$flagExist = true;
					break;
				}

			}
		}

		if(!$flagExist)
			array_push($templocid_array, $locid);
	}*/

	/*// Truncate the table
	TruncateTable_TRA37("tmp_stddraw");*/

	/*$rt_array = array_values(array_diff($locid_array, $templocid_array));
	unset($templocid_array);*/

	return $rt_array;
}

/*
	this function is used to set all previous SP records' datex and specificrouteid
	to the currently run routes.
	Provided the currently run route is a Returns popup i.e. RETURNS popup
*/
function MapPreviousSP_TRA37($srid) {
	if($GLOBALS[debug]) {
		print("###############################<br />");
		print("<b>Mapping of previous SP recs </b><br />");
	}
	if(!is_numeric($srid)) $srid = 0;

	if($srid == 0) {
		return false;
	}
	else {
		/*$val_RETNT = GetLSVar("RETNT", "intvar", $GLOBALS[ASLocationID], $GLOBALS[cvtconnection]);
		if(!is_numeric($val_RETNT)) $val_RETNT = 0;
		if($GLOBALS[debug]) print("RETNT = $val_RETNT<br />");*/

		$val_RETNU = GetLSVar("RETNU", "intvar", $GLOBALS[ASLocationID], $GLOBALS[cvtconnection]);
		if(!is_numeric($val_RETNU)) $val_RETNU = 0;
		if($GLOBALS[debug]) print("RETNU = $val_RETNU<br />\n");
		
		$char_RETNU = GetLSVar("RETNU", "charvar", $GLOBALS[ASLocationID], $GLOBALS[cvtconnection]);
		
		if($GLOBALS[debug]) print("RETNU = $val_RETNU<br />\n");
		
		$val_PDEND = GetLSVar("PDEND", "strvar", $GLOBALS[ASLocationID], $GLOBALS[cvtconnection]);
		
		if($GLOBALS[debug]) print("PDEND = $val_PDEND<br />\n");
		
                $val_CRMOD = GetLSVar("CRMOD", "charvar", $GLOBALS[ASLocationID], $GLOBALS[cvtconnection]);
		
		if($GLOBALS[debug]) print("CRMOD = $val_CRMOD<br />\n");
		
	
		
		/*if($val_RETNU == 0)
			$val_RETNU = 7;*/

		// GET SPECIFICROUTES.DRIVERID
		$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetTableInfo($GLOBALS[debug], $GLOBALS[cvtconnection], "specificroutes", $srid, "driverid driverId", "DATE_FORMAT(datesked, '%Y-%m-%d') dbDateSked" , "routeid routeId");
		if($rsltArr[rtvalue]) {
			$driverId = $rsltArr[driverId];
			$dbDateSked = $rsltArr[dbDateSked];
			if(!is_numeric($driverId)) $driverId = 0;
			$routeId = $rsltArr[routeId];
			if(!is_numeric($routeId)) $routeId = 0;
		}
		else {
			$driverId = 0;
			$routeId = 0;
			$dbDateSked = "";
		}
		unset($rsltArr, $GLOBALS[fileLineNbr]);
		
		
		
			$val_PDEND = trim($val_PDEND);
		
			switch($val_PDEND) {
				case "SUN":
					$toDate = date("Y-m-d", strtotimelocal("last Sunday", strtotime($dbDateSked)));
					break;
				case "MON":
					$toDate = date("Y-m-d", strtotimelocal("last Monday", strtotime($dbDateSked)));
					break;
				case "TUE":
					$toDate = date("Y-m-d", strtotimelocal("last Tuesday", strtotime($dbDateSked)));
					break;
				case "WED":
					$toDate = date("Y-m-d", strtotimelocal("last Wednesday", strtotime($dbDateSked)));
					break;
				case "THU":
					$toDate = date("Y-m-d", strtotimelocal("last Thursday", strtotime($dbDateSked)));
					break;
				case "FRI":
					$toDate = date("Y-m-d", strtotimelocal("last Friday", strtotime($dbDateSked)));
					break;
				case "SAT":
					$toDate = date("Y-m-d", strtotimelocal("last Saturday", strtotime($dbDateSked)));
					break;
			
		}
		
			$fromDate = DateOperations_TRADATE($toDate, 6, "SUB");
			
		
		if($GLOBALS[debug])
			print("$fromDate - $toDate<br />\n");
		
		
		
		// GET ROUTE.TYPE
		$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetTableInfo($GLOBALS[debug], $GLOBALS[cvtconnection], "route", $routeId, "type");
		if($rsltArr[rtvalue]) {
			$rtType = $rsltArr[type];
		}
		else {
			$rtType = "";
		}
		unset($rsltArr, $GLOBALS[fileLineNbr]);
		
		
		

		// FINDIND LOCATIONS FOR SELECTED ROUTE.
		$qryGetLocs = "SELECT DISTINCT srl.locationid locid
						FROM specificrouteloc srl, specificroutes sr,
						routelink rl
						WHERE sr.dispatchlocid = $GLOBALS[ASLocationID]
						AND sr.recid = $srid
		 				AND srl.specificrouteid = sr.recid
						AND srl.clientlocid = $GLOBALS[ASLocationID]
						AND rl.locationid = srl.locationid
						AND rl.clientid = $GLOBALS[ASCompanyID]
						AND rl.returnsflag = 'R'
						AND ( rl.endeffdt IS NULL OR rl.endeffdt = '0000-00-00' OR rl.endeffdt > '$curDate' )";

		// FOR SPLITTING OF TABLES
		$qryGetLocs = convertToSplitTables($qryGetLocs, $GLOBALS[val_SPLIT]);

		if($GLOBALS[debug])
			print($qryGetLocs . "<br />\n");
		$rsltGetLocs = mysqli_query( $GLOBALS[cvtconnection], $qryGetLocs);
		if(!$rsltGetLocs) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			if(mysqli_num_rows($rsltGetLocs) == 0) {
				$locIdStr = "";
			}
			else {
				$locIdArr = array();
				while($rowGetLocs = mysqli_fetch_assoc($rsltGetLocs)) {
					array_push($locIdArr, $rowGetLocs[locid]);
				}
				$locIdStr = implode(", ", $locIdArr);
			}
		}
		if($locIdStr == "") {
			$locIdStr = "0";
		}
		//echo $routeType."<---------------->";
	
	if($char_RETNU == 'W')
	{
		
		$qryGetSP = "SELECT ta.customerlocid locId, ta.specificproductid spId,
					DATE_FORMAT(ta.datet, '%Y-%m-%d') datet
					FROM transactivity ta,specificproduct sp
					WHERE ta.locationid = $GLOBALS[ASLocationID]
					AND ta.customerlocid IN (" . $locIdStr . ")
					AND ta.type = 'SP'
					AND ta.specificproductid = sp.recid
					AND sp.datex <= '$toDate'";
			$qryGetSP .= " AND sp.datex >= '$fromDate'";
		$qryGetSP .= " GROUP BY ta.customerlocid, ta.specificproductid, ta.datet";

		// FOR SPLITTING OF TABLES
		$qryGetSP = convertToSplitTables($qryGetSP, $GLOBALS[val_SPLIT]);

		if($GLOBALS[debug])
			print($qryGetSP . "<br />\n");
		$rsltGetSP = mysqli_query( $GLOBALS[cvtconnection], $qryGetSP);
		$tmpCnt = 1;
		if(!$rsltGetSP) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			while($rowGetSP = mysqli_fetch_assoc($rsltGetSP)) {
				$locId = $rowGetSP[locId];
				$spId = $rowGetSP[spId];
				$datet = $rowGetSP[datet];
				ValidateForInt(false, "locid", "spid");
				
				
				
				
				
								
				

				// NOW WE WILL FIND THE PRODUCTID AND DAYCODE.PERIOD
				$qryGetProdInfo = "SELECT p.recid prodId, sp.datex dbDateX
									FROM specificproduct sp, product p
									
									WHERE p.clientid = $GLOBALS[ASCompanyID]
									AND p.recid = sp.productid
									AND sp.recid = $spId ";
									
				if(($rtType == "CR" || $rtType == "CO" || $rtType == "RR") && $endDateNew != ""){
				$qryGetProdInfo .= " AND sp.datex <= '$toDate' ";
				}
									
				if($GLOBALS[debug])
					print($qryGetProdInfo . "<br />\n");
				$rsltGetProdInfo = mysqli_query( $GLOBALS[cvtconnection], $qryGetProdInfo);
				$periodDays = 0;
				if(!$rsltGetProdInfo) {
					$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($GLOBALS[fileLineNbr]);
				}
				else {
					if(mysqli_num_rows($rsltGetProdInfo) == 0) {
						$prodId = 0;

						$dcPeriod = "";
						$dbDateX = "";
					}
					else {
						while($rowGetProdInfo = mysqli_fetch_assoc($rsltGetProdInfo)) {

							$prodId = $rowGetProdInfo[prodId];
							if(!is_numeric($prodId))	$prodId = 0;

							$dcPeriod = $rowGetProdInfo[dcPeriod];
							$dbDateX = $rowGetProdInfo[dbDateX];
						}
					}
				}


				

				
//print("$fromDate - $toDate<br />\n");
				
				if($dbDateX >= $fromDate && $dbDateX <= $toDate) {

					// CHECK FOR PU RECORD
					$qryChkRecs = "SELECT COUNT(*)
									FROM transactivity
									WHERE locationid = $GLOBALS[ASLocationID]
									AND customerlocid = $locId
									AND specificproductid = $spId
									AND type = 'PU'
									/*AND datet >= '$datet'*/";

					// FOR SPLITTING OF TABLES
					$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);

					if($GLOBALS[debug])
						print($qryChkRecs . "<br />\n");
					$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
					$flagExist = false;
					if(!$rsltChkRecs) {
						$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($GLOBALS[fileLineNbr]);
					}
					else {
						if($rowChkRecs = mysqli_fetch_row($rsltChkRecs)) {
							$NoRecs = $rowChkRecs[0];
							if(!is_numeric($NoRecs)) $NoRecs = 0;
							if($NoRecs > 0) $flagExist = true;
						}
					}

					if(!$flagExist) {
						// UPDATE TRANSACTIVITY RECORD
						$qryUp = "UPDATE transactivity
								SET specificrouteid = $srid,
								personid = $driverId,
								datet = '$dbDateSked',
								activesession = $GLOBALS[RecIdAS],
								archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
								WHERE locationid = $GLOBALS[ASLocationID]
								AND customerlocid = $locId
								AND specificproductid = $spId
								AND type = 'SP'
								AND datet = '$datet'";

						// FOR SPLITTING OF TABLES
						$qryUp = convertToSplitTables($qryUp, $GLOBALS[val_SPLIT]);

						if($GLOBALS[debug])
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
						if(!$rsltUp) {
							$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($GLOBALS[fileLineNbr]);
						}
						else {
							if($GLOBALS[debug]) print("<b>Affected Rows : " . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b><br />\n");
						}
					}
				}

				if(($tmpCnt % 10) == 0) {
					ob_flush();
				}

				$tmpCnt++;
			}
		}
	
	
	         
	}
	else{
		$qryGetSP = "SELECT ta.customerlocid locId, ta.specificproductid spId,
					DATE_FORMAT(ta.datet, '%Y-%m-%d') datet
					FROM transactivity ta,specificproduct sp
					WHERE ta.locationid = $GLOBALS[ASLocationID]
					AND ta.customerlocid IN (" . $locIdStr . ")
					AND ta.type = 'SP'
					AND ta.specificproductid = sp.recid
					AND sp.datex < '$dbDateSked'";
		if($val_RETNU != 0)
			$qryGetSP .= " AND sp.datex >= ( '$dbDateSked' - INTERVAL " . $val_RETNU . " DAY )";
		$qryGetSP .= " GROUP BY ta.customerlocid, ta.specificproductid, ta.datet";

		// FOR SPLITTING OF TABLES
		$qryGetSP = convertToSplitTables($qryGetSP, $GLOBALS[val_SPLIT]);

		if($GLOBALS[debug])
			print($qryGetSP . "<br />\n");
		$rsltGetSP = mysqli_query( $GLOBALS[cvtconnection], $qryGetSP);
		$tmpCnt = 1;
		if(!$rsltGetSP) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			while($rowGetSP = mysqli_fetch_assoc($rsltGetSP)) {
				$locId = $rowGetSP[locId];
				$spId = $rowGetSP[spId];
				$datet = $rowGetSP[datet];
				ValidateForInt(false, "locid", "spid");
				
				// GET SPECIFICROUTES.DRIVERID
				$qryGetRouteLink = "SELECT rl.billingperioddaycodeid, rl.billingperiodbasedate
							FROM routelink rl, location l
							WHERE rl.locationid = $locId
							AND rl.clientid = $GLOBALS[ASCompanyID]
							AND l.recid = rl.locationid";
				
				if($GLOBALS[debug])
					print($qryGetRouteLink . "<br />");
					
				$rsltGetRouteLink = mysqli_query( $GLOBALS[cvtconnection], $qryGetRouteLink);
				
				if(!$rsltGetRouteLink) {
					$GLOBALS[$fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($GLOBALS[$fileLineNbr]);
				}
				else {
					$rowGetRouteLink = mysqli_fetch_assoc($rsltGetRouteLink);
					$billingPeriodDayCodeId = $rowGetRouteLink[billingperioddaycodeid];
					$billingPeriodBaseDate = $rowGetRouteLink[billingperiodbasedate];
				}
				
				if(!is_numeric($billingPeriodDayCodeId))	$billingPeriodDayCodeId = 0;
				
								
				$GLOBALS[$fileLineNbr] = __LINE__; $endDateNew = getCurEndingDate_TRA( $dbDateSked, $billingPeriodDayCodeId, $billingPeriodBaseDate);
				

				// NOW WE WILL FIND THE PRODUCTID AND DAYCODE.PERIOD
				$qryGetProdInfo = "SELECT p.recid prodId, dc.period dcPeriod,
									sp.datex dbDateX
									FROM specificproduct sp, product p
									LEFT JOIN daycode dc ON dc.recid = p.daycodeid
									WHERE p.clientid = $GLOBALS[ASCompanyID]
									AND p.recid = sp.productid
									AND sp.recid = $spId ";
									
				if(($rtType == "CR" || $rtType == "CO" || $rtType == "RR") && $endDateNew != ""){
                                   if($val_CRMOD == 'B' || $val_CRMOD == '' ) 
				   $qryGetProdInfo .= " AND sp.datex <= '$endDateNew' ";
                                   else if($val_CRMOD == 'P' ) 
                                   $qryGetProdInfo .= " AND sp.datex <= '$toDate' ";
				}
									
				if($GLOBALS[debug])
					print($qryGetProdInfo . "<br />\n");
				$rsltGetProdInfo = mysqli_query( $GLOBALS[cvtconnection], $qryGetProdInfo);
				$periodDays = 0;
				if(!$rsltGetProdInfo) {
					$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($GLOBALS[fileLineNbr]);
				}
				else {
					if(mysqli_num_rows($rsltGetProdInfo) == 0) {
						$prodId = 0;

						$dcPeriod = "";
						$dbDateX = "";
					}
					else {
						while($rowGetProdInfo = mysqli_fetch_assoc($rsltGetProdInfo)) {

							$prodId = $rowGetProdInfo[prodId];
							if(!is_numeric($prodId))	$prodId = 0;

							$dcPeriod = $rowGetProdInfo[dcPeriod];
							$dbDateX = $rowGetProdInfo[dbDateX];
						}
					}
				}


				switch($dcPeriod) {
					case "W":
						$periodDays = 7;
						break;

					case "B":
						$periodDays = 14;
						break;

					case "E":
						$periodDays = 15;
						break;

					case "M":
						$periodDays = 30;
						break;

					case "F":
						$periodDays = 28;
						break;

					case "Q":
						$periodDays = 90;
						break;

					case "S":
						$periodDays = 183;
						break;

					case "A":
						$periodDays = 365;
						break;

					default:
						$periodDays = 0;
						break;
				}
				$totalDays = $val_RETNU + $periodDays;
				$fromDateSked = DateOperations_TRADATE($dbDateSked, $totalDays, "SUB");

				if($GLOBALS[debug])
					print("$fromDateSked : $dbDateX : $dbDateSked<br />\n");

				//if($dbDateX >= $fromDateSked && $dbDateX <= $dbDateSked && $datet <= $endDateNew) {
				if($dbDateX >= $fromDateSked && $dbDateX <= $dbDateSked) {

					// CHECK FOR PU RECORD
					$qryChkRecs = "SELECT COUNT(*)
									FROM transactivity
									WHERE locationid = $GLOBALS[ASLocationID]
									AND customerlocid = $locId
									AND specificproductid = $spId
									AND type = 'PU'
									/*AND datet >= '$datet'*/";

					// FOR SPLITTING OF TABLES
					$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);

					if($GLOBALS[debug])
						print($qryChkRecs . "<br />\n");
					$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
					$flagExist = false;
					if(!$rsltChkRecs) {
						$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($GLOBALS[fileLineNbr]);
					}
					else {
						if($rowChkRecs = mysqli_fetch_row($rsltChkRecs)) {
							$NoRecs = $rowChkRecs[0];
							if(!is_numeric($NoRecs)) $NoRecs = 0;
							if($NoRecs > 0) $flagExist = true;
						}
					}

					if(!$flagExist) {
						// UPDATE TRANSACTIVITY RECORD
						$qryUp = "UPDATE transactivity
								SET specificrouteid = $srid,
								personid = $driverId,
								datet = '$dbDateSked',
								activesession = $GLOBALS[RecIdAS],
								archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
								WHERE locationid = $GLOBALS[ASLocationID]
								AND customerlocid = $locId
								AND specificproductid = $spId
								AND type = 'SP'
								AND datet = '$datet'";

						// FOR SPLITTING OF TABLES
						$qryUp = convertToSplitTables($qryUp, $GLOBALS[val_SPLIT]);

						if($GLOBALS[debug])
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
						if(!$rsltUp) {
							$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($GLOBALS[fileLineNbr]);
						}
						else {
							if($GLOBALS[debug]) print("<b>Affected Rows : " . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b><br />\n");
						}
					}
				}

				if(($tmpCnt % 10) == 0) {
					ob_flush();
				}

				$tmpCnt++;
			}
		}
	}
	
	}
}


/*
	THIS FUNCTION WILL PROCESS RDSEND RECORDS. IT IS CALLED FROM CREATE RUN RECORDS
*/
function SetRDSend_TRA37($srId, $deviceId, $deviceTypeId, $chrDeviceStatus, $routeType) {
	ValidateForInt(false, "srId", "deviceId", "deviceTypeId");

	if($srId == 0) {
	}
	else {

		switch($routeType) {
			case "SR":
				//$dpVersion = $GLOBALS[val_VERSR];
				$dpVersion = getDPVersion_TRA37($deviceTypeId, $GLOBALS[val_VERSR]);
				break;

			case "RR":
				//$dpVersion = $GLOBALS[val_VERRR];
				$dpVersion = getDPVersion_TRA37($deviceTypeId, $GLOBALS[val_VERRR]);
				break;

			case "CO":
			case "CR":
				//$dpVersion = $GLOBALS[val_VERCO];
				$dpVersion = getDPVersion_TRA37($deviceTypeId, $GLOBALS[val_VERCO]);
				break;

			default:
				$dpVersion = "";
		}

		//NOW HERE CHECK FOR RDSEND RECORD WITH TYPE = C FOR THIS
		//DEVICEID AND IF EXIST UPDATE IT
		if($deviceId != 0) {
			$qryChkRecs = "SELECT recid
							FROM rdsend
							WHERE type = 'C'
							AND deviceid = $deviceId";
			if($GLOBALS[debug])
				print($qryChkRecs . "<br />\n");
			$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
			if(!$rsltChkRecs) {
				$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($GLOBALS[fileLineNbr]);
			}
			else {
				if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
					$rdSendId = $rowChkRecs[recid];
					if(!is_numeric($rdSendId)) $rdSendId = 0;
				}
				else {
					$rdSendId = 0;
				}
			}

			if($rdSendId == 0) {
				//INSERT A RECORD
				$qryIns = "INSERT INTO rdsend(devicestatus, datastatus,
							type, deviceid, dpversion)
							VALUES('N', 'Y',
							'C', $deviceId, '$dpVersion')";
				if($GLOBALS[debug])
					print("<b>" . $qryIns . "</b><br />\n");
				$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
				if(!$rsltIns) {
					$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(14, 02);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($GLOBALS[fileLineNbr]);
				}
				else {
					if($GLOBALS[debug])
						print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
				}
			}
			else {
				$qryUp = "UPDATE rdsend
							SET datastatus = 'Y',
							devicestatus = 'N',
							dpversion = '$dpVersion'
							WHERE recid = $rdSendId";
				if($GLOBALS[debug])
					print("<b>" . $qryUp . "</b><br />\n");
				$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
				if(!$rsltUp) {
					$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(14, 03);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($GLOBALS[fileLineNbr]);
				}
				else {
					if($GLOBALS[debug])
						print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
				}
			}

			unset($rdSendId);
		}


		//echo "<b>check rdsend--><bR></b>";
		//NOW CHECK FOR RDSEND RECORD AND IF NOT EXIST INSERT ONE
		// AND IF EXIST THEN UPDATE ITS DEVICEID
		$qryChkRecs = "SELECT recid FROM rdsend
						WHERE devicestatus = '$chrDeviceStatus'
						AND type = 'T'
						AND specificroutesid = $srId
						AND deviceid = $deviceId";
		if($GLOBALS[debug])
			print($qryChkRecs . "<br />\n");
		$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
		if(!$rsltChkRecs) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(14, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
				$rdSendId = $rowChkRecs[recid];
				if(!is_numeric($rdSendId)) $rdSendId = 0;
			}
			else {
				$rdSendId = 0;
			}
		}

		if($rdSendId == 0) {
			// INSERT A RECORD

			$qryIns = "INSERT INTO rdsend(devicestatus, datastatus, type, specificroutesid, deviceid, dpversion)
						VALUES('$chrDeviceStatus', 'Y', 'T', $srId, $deviceId, '$dpVersion')";
			if($GLOBALS[debug])
				print("<b>" . $qryIns . "</b><br />\n");
			$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
			if(!$rsltIns) {
				$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(14, 02);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($GLOBALS[fileLineNbr]);
			}
			else {

				if($GLOBALS[debug])
					print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
			}

		}
		else {
			// UPDATE THE DEVICEID
			$qryUp = "UPDATE rdsend
						SET deviceid = $deviceId,
						dpversion = '$dpVersion',
						datastatus = 'Y'
						WHERE recid = $rdSendId";
			if($GLOBALS[debug])
				print("<b>" . $qryUp . "</b><br />\n");
			$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
			if(!$GLOBALS[rsltUp]) {
				$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(14, 03);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($GLOBALS[fileLineNbr]);
			}
			else {
				if($GLOBALS[debug])
					print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
			}
		}

		unset($rdSendId);
	}
}

/*
	THIS FUNCTION WILL UPDATE SPECIFICPRODUCT.BUNDLECOUNT
	IF PRODUCTDISPATCH.QTYRECDAS IS NOT SET
*/
function Update_SPBundleCount($pdid) {
	if(!is_numeric($pdid)) $pdid = 0;

	if($pdid != 0) {
		$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetTableInfo($GLOBALS[debug], $GLOBALS[cvtconnection], "productdispatch", $pdid, "qtyrecdas", "DATE_FORMAT(rundate, '%Y-%m-%d') dbEffDt");
		if($rsltArr[rtvalue]) {
			$qtyrecdas = $rsltArr[qtyrecdas];
			$dbEffDt = $rsltArr[dbEffDt];
			if(!is_numeric($qtyrecdas)) $qtyrecdas = 0;
		}
		else {
			$qtyrecdas = 0;
			$dbEffDt = "";
		}
		unset($rsltArr, $GLOBALS[fileLineNbr]);

		if($qtyrecdas == 0) {
			// LETS FIRST FIND ALL SPECIFICPRODUCTS
			$qryGetSP = "SELECT DISTINCT(specificproductid) spid
						FROM transactivity
						WHERE locationid = $GLOBALS[ASLocationID]
						AND datet = '$dbEffDt'
						AND type = 'SD'
						ORDER BY specificproductid";

			// FOR SPLITTING OF TABLES
			$qryGetSP = convertToSplitTables($qryGetSP, $GLOBALS[val_SPLIT]);

			if($GLOBALS[debug])
				print($qryGetSP . "<br />\n");
			$rsltGetSP = mysqli_query( $GLOBALS[cvtconnection], $qryGetSP);
			if(!$rsltGetSP) {
				$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($GLOBALS[fileLineNbr]);
			}
			else {
				while($rowGetSP = mysqli_fetch_assoc($rsltGetSP)) {
					$spid = $rowGetSP[spid];
					if(!is_numeric($spid)) $spid = 0;

					// GET LAST WEEKS BUNDLECOUNT
					$bundleCount = GetBundleCount_TRA37($spid);
					if($bundleCount == 0) $bundleCount = 1;

					// UPDATE IT
					$qryUp = "UPDATE specificproduct
							SET bundlecount = $bundleCount,
							archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
							WHERE recid = $spid";
					if($GLOBALS[debug])
						print("<b>" . $qryUp . "</b><br />\n");
					$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
					if(!$rsltUp) {
						$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 03);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($GLOBALS[fileLineNbr]);
					}
					else {
						if($GLOBALS[debug])
							print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
					}
				}
			}
		}
	}

	return;
}

/*
	THIS FUNCTION WILL RETURN BUNDLE COUNT OF LAST WEEK GIVEN SPID
*/
function GetBundleCount_TRA37($spid) {
	if(!is_numeric($spid)) $spid = 0;

	if($spid == 0) {
		$bundleCount = 0;
	}
	else {
		$selectStr = "sp2.recid, sp2.bundlecount";
		$fromStr = "specificproduct sp1, specificproduct sp2";
		$whereStr = "sp1.recid = $spid
					AND sp2.productid = sp1.productid
					AND sp2.datex = ( sp1.datex - INTERVAL 7 DAY )
					AND sp2.skeddeliv = ( sp1.skeddeliv - INTERVAL 7 DAY )";
		$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetSingleRecInfo($GLOBALS[cvtconnection], $GLOBALS[debug], $selectStr, $fromStr, $whereStr);
		unset($selectStr, $fromStr, $whereStr, $GLOBALS[fileLineNbr]);

		if($rsltArr) {
			$sp2id = $rsltArr[recid];
			$bundleCount = $rsltArr[bundlecount];
			ValidateForInt(false, "sp2id", "bundleCount");
		}
		else {
			$sp2id = 0;
			$bundleCount = 0;
		}
		unset($rsltArr);

		if($sp2id == 0) {
			$selectStr = "sp2.bundlecount";
			$fromStr = "specificproduct sp1, specificproduct sp2";
			$whereStr = "sp1.recid = $spid
						AND sp2.productid = sp1.productid
						AND sp2.datex = ( sp1.datex - INTERVAL 7 DAY )";
			$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetSingleRecInfo($GLOBALS[cvtconnection], $GLOBALS[debug], $selectStr, $fromStr, $whereStr);
			unset($selectStr, $fromStr, $whereStr, $GLOBALS[fileLineNbr]);

			if($rsltArr) {
				$bundleCount = $rsltArr[bundlecount];
				if(!is_numeric($bundleCount)) $bundleCount = 0;
			}
			else {
				$bundleCount = 0;
			}
			unset($rsltArr);
		}
	}

	return $bundleCount;
}

/*
	THIS FUNCTION IS USED TO CHECK WHETHER THERE EXIST ANY DE, PU RECORDS WITH
	THE CURRENT DATE AS DATESKED
*/
function IsActualActivitiyDone_TRA37($dbEffDt) {
	if($dbEffDt == "") return false;

	$qryChkRecs = "SELECT COUNT(*) FROM transactivity ta, specificroutes sr, location l
				WHERE ta.locationid = $GLOBALS[ASLocationID]
				AND ta.type IN ('DE', 'PU')
				AND sr.recid = ta.specificrouteid
				AND sr.datesked = '$dbEffDt'
				AND sr.dispatchlocid = $GLOBALS[ASLocationID]
				AND l.recid = ta.customerlocid
				AND l.type != 'R'";

	// FOR SPLITTING OF TABLES
	$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print($qryChkRecs . "<br />\n");
	$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
	$flagExist = false;
	if(!$rsltChkRecs) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		if($rowChkRecs = mysqli_fetch_row($rsltChkRecs)) {
			$NoRecs = $rowChkRecs[0];
			if(!is_numeric($NoRecs)) $NoRecs = 0;
			if($NoRecs > 0) $flagExist = true;
		}
	}

	return $flagExist;
}

/*
	THIS FUNCTION IS USED TO CHECK WHETHER THERE EXIST ANY SD, SP RECORDS WITH
	THE CURRENT DATE AS DATESKED
*/
function IsScheduledActivityDone_TRA37($dbEffDt) {
	if($dbEffDt == "") return false;

	$qryChkRecs = "SELECT COUNT(*) FROM transactivity ta
				WHERE ta.locationid = $GLOBALS[ASLocationID]
				AND ta.type IN ('SD', 'SP')
				AND ta.datet = '$dbEffDt'";

	// FOR SPLITTING OF TABLES
	$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print($qryChkRecs . "<br />\n");
	$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
	$flagExist = false;
	if(!$rsltChkRecs) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		if($rowChkRecs = mysqli_fetch_row($rsltChkRecs)) {
			$NoRecs = $rowChkRecs[0];
			if(!is_numeric($NoRecs)) $NoRecs = 0;
			if($NoRecs > 0) $flagExist = true;
		}
	}

	return $flagExist;
}

/*
	THIS FUNCTION IS USED TO CHECK WHETHER THERE EXIST ANY SD, SP RECORDS WITH
	THE CURRENT DATE AS DATESKED
*/
function IsPrevDayRunExists_TRA37($dbEffDt) {
		
	if($dbEffDt == "") return false;
	$addType ='';
	$NoLocRType ='';
	$qryChkLocType = "Select count(*) cnt from customerlink cl, locationlink ll, location l where cl.clientlocid = $GLOBALS[ASLocationID] and cl.customerid = ll.companyid and ll.locationid = l.recid and l.type = 'R' AND ( l.endeffdate IS NULL OR l.endeffdate = '0000-00-00' OR l.endeffdate > '$curDate' ) ";
		
	$rslChkLocType = mysqli_query($GLOBALS["___mysqli_ston"], $qryChkLocType);
	if(!$rslChkLocType) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		
			$rowChkLocType = mysqli_fetch_assoc($rslChkLocType);
			
			$NoLocRType = $rowChkLocType['cnt'];
			
			if($NoLocRType > 0)
			{
				$addType = ", 'DE'";
			}
		
	}

	$qryChkRecs = "SELECT COUNT(*) FROM transactivity ta
				WHERE ta.locationid = $GLOBALS[ASLocationID]
				AND ta.type IN ('SD', 'SP' ".$addType.")
				AND ta.datet = DATE_SUB('$dbEffDt', INTERVAL 1 DAY)";

// FOR SPLITTING OF TABLES

	$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print($qryChkRecs . "<br />\n");
	$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
	$flagExist = false;
	if(!$rsltChkRecs) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		if($rowChkRecs = mysqli_fetch_row($rsltChkRecs)) {
			$NoRecs = $rowChkRecs[0];
			if(!is_numeric($NoRecs)) $NoRecs = 0;
			if($NoRecs > 0) $flagExist = true;
		}
		return $flagExist;
	}
}

/*
	THIS FUNCTION WILL RETURN A STRING SEPARATED BY SOME CHAR
*/
function MakeStr_TRA37($info_array, $sep = ",", $surround = "") {
	if(!is_array($info_array) || count($info_array) == 0)
		return "";

	if($surround != "") {
		for($tempi = 0; $tempi < count($info_array); $tempi++)
			$info_array[$tempi] = $surround . $info_array[$tempi] . $surround;
	}

	$rtvalue = implode($sep, $info_array);

	return $rtvalue;
}

/*
	THIS FUNCTION IS USED TO CREATE/UPDATE ROUTEDRAWACCOUNTING RECORDS BASED ON THE
	SELECTED SPECIFICROUTE
*/
function SetRouteDraw_TRA37($srId, $routeType) {
	ValidateForInt(false, "srId");

	if($srId == 0) return;

	// FINDING DATESKED
	$selectStr = "datesked dbDateSked, routeid routeId";
	$fromStr = "specificroutes";
	$whereStr = "recid = $srId
				AND dispatchlocid = $GLOBALS[ASLocationID]";
	$GLOBALS[fileLineNbr] = __LINE__; $rsltArray = GetSingleRecInfo($GLOBALS[cvtconnection], $GLOBALS[debug], $selectStr, $fromStr, $whereStr);
	unset($selectStr, $fromStr, $whereStr, $GLOBALS[fileLineNbr]);

	if($rsltArray) {
		$dbDateSked = $rsltArray[dbDateSked];
		$routeId = $rsltArray[routeId];
		if(!is_numeric($routeId))	$routeId = 0;
	}
	else {
		$dbDateSked = "";
		$routeId = 0;
	}
	unset($rsltArray);

	// FINDING LOCATIONS BASED ON THE SPECIFICROUTES AND SPECIFICROTUELOC
	// PASS THEM TO TRANSACTIVITY
	$qryGetLocs = "SELECT DISTINCT srl.locationid locId
					FROM specificroutes sr, specificrouteloc srl
					WHERE sr.dispatchlocid = $GLOBALS[ASLocationID]
					AND sr.recid = $srId
					AND srl.specificrouteid = sr.recid
					AND srl.clientlocid = $GLOBALS[ASLocationID]";

	// FOR SPLITTING OF TABLES
	$qryGetLocs = convertToSplitTables($qryGetLocs, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print($qryGetLocs . "<br />\n");
	$rsltGetLocs = mysqli_query( $GLOBALS[cvtconnection], $qryGetLocs);
	if(!$rsltGetLocs) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		if(mysqli_num_rows($rsltGetLocs) == 0) {
			$custLocIdStr = "0";
		}
		else {
			$custLocIdArr = array();
			while($rowGetLocs = mysqli_fetch_assoc($rsltGetLocs)) {

				$custLocId = $rowGetLocs[locId];
				if(!is_numeric($custLocId))	$custLocId = 0;

				array_push($custLocIdArr, $custLocId);
			}

			$custLocIdStr = implode(", ", $custLocIdArr);

		}
	}

	if($custLocIdStr == "")
		$custLocIdStr = "0";

	// GET QUANTITY FROM RELATED RECORDS IN TRANSACTIVITY GROUP BY SPID AND UPDATE
	// ROUTEDRAWACCOUNTING RECORDS
	$qryGetTA = "SELECT ta.specificproductid spId, SUM(ta.actquantity) qty
				FROM transactivity ta 
				WHERE ta.locationid = $GLOBALS[ASLocationID]
				AND ta.datet = '$dbDateSked'
				AND ta.type IN('SD','DE')
				AND ta.customerlocid IN ($custLocIdStr)
				GROUP BY ta.specificproductid
				ORDER BY ta.specificproductid";

	// FOR SPLITTING OF TABLES
	$qryGetTA = convertToSplitTables($qryGetTA, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print($qryGetTA . "<br />\n");
	$rsltGetTA = mysqli_query( $GLOBALS[cvtconnection], $qryGetTA);

	if(!$rsltGetTA) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		while($rowGetTA = mysqli_fetch_assoc($rsltGetTA)) {
			$spId = $rowGetTA[spId];
			$qty = $rowGetTA[qty];
			if($routeType == "SS" || $routeType == "RS" || $routeType == "LR") {
				$qty = 0;
			}
			ValidateForInt(false, "spId", "qty");

			if($spId != 0) {

				// CHECK IF ROUTEDRAWACCOUNTING RECORD EXIST THEN UPDATE IT ELSE CREATE IT
				$qryChkRecs = "SELECT recid
								FROM routedrawaccounting
								WHERE clientlocid = $GLOBALS[ASLocationID]
								AND specificrouteid = $srId
								AND actspecificproductid = $spId
								AND type = 'SD'";

				// FOR SPLITTING OF TABLES
				$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);

				if($GLOBALS[debug])
					print($qryChkRecs . "<br />\n");
				$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
				if(!$rsltChkRecs) {
					$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($GLOBALS[fileLineNbr]);
				}
				else {
					if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
						$rdaId = $rowChkRecs[recid];
						if(!is_numeric($rdaId)) $rdaId = 0;
					}
					else {
						$rdaId = 0;
					}

					// FINDING EXTRADRAW QUANTITY
					//$extraDrawQty = getExtraDrawQty_TRA($srId, $spId);
					//$qtyIssued = $qty + $extraDrawQty;

					if($rdaId != 0) {

						// UPDATE ROUTEDRAWACCOUNTING
						$qryUp = "UPDATE routedrawaccounting
								SET qtysked = $qty,
								qtyissued = $qty,
								archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
								WHERE recid = $rdaId
								AND clientlocid = $GLOBALS[ASLocationID]";

						// FOR SPLITTING OF TABLES
						$qryUp = convertToSplitTables($qryUp, $GLOBALS[val_SPLIT]);

						if($GLOBALS[debug])
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
						if(!$rsltUp) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
					}
					else {
						// INSERT INTO ROUTEDRAWACCOUNTING
						$qryIns = "INSERT INTO routedrawaccounting(clientlocid, specificrouteid, actspecificproductid, qtysked, qtyissued)
						VALUES($GLOBALS[ASLocationID], $srId, $spId, $qty, $qty)";

						// FOR SPLITTING OF TABLES
						$qryIns = convertToSplitTables($qryIns, $GLOBALS[val_SPLIT]);

						if($GLOBALS[debug])
							print("<b>" . $qryIns . "</b><br />\n");
						$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
						if(!$rsltIns) {
							$fileLineNbr = __LINE__; $strErrorCode = getErrorCode(01, 02);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($fileLineNbr);
						}
						else {
							if($GLOBALS[debug])
								print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
						}
					}
				}
			}
		}
	}

	$fileLineNbr = __LINE__; updateSRExtraDraw_TRA($srId, $dbDateSked);
}


/*
	THIS FUNCTION IS USED TO CREATE/UPDATE ROUTEDRAWACCOUNTING RECORDS BASED ON THE
	SELECTED SPECIFICROUTE
*/
function SetRouteDrawSP_TRA37($srId, $routeType) {

	ValidateForInt(false, "srId");

	if($srId == 0) return;

	// FINDING DATESKED
	$selectStr = "datesked";
	$fromStr = "specificroutes";
	$whereStr = "recid = $srId
				AND dispatchlocid = $GLOBALS[ASLocationID]";
	$GLOBALS[fileLineNbr] = __LINE__; $rsltArray = GetSingleRecInfo($GLOBALS[cvtconnection], $GLOBALS[debug], $selectStr, $fromStr, $whereStr);
	unset($selectStr, $fromStr, $whereStr, $GLOBALS[fileLineNbr]);

	if($rsltArray) {
		$dbDateSked = $rsltArray[datesked];
	}
	else {
		$dbDateSked = "";
	}
	unset($rsltArray);

	// FINDING LOCATIONS BASED ON THE SPECIFICROUTES AND SPECIFICROTUELOC
	// PASS THEM TO TRANSACTIVITY
	$qryGetLocs = "SELECT DISTINCT srl.locationid locId
					FROM specificroutes sr, specificrouteloc srl
					WHERE sr.dispatchlocid = $GLOBALS[ASLocationID]
					AND sr.recid = $srId
					AND srl.specificrouteid = sr.recid
					AND srl.clientlocid = $GLOBALS[ASLocationID]";

	// FOR SPLITTING OF TABLES
	$qryGetLocs = convertToSplitTables($qryGetLocs, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print($qryGetLocs . "<br />\n");
	$rsltGetLocs = mysqli_query( $GLOBALS[cvtconnection], $qryGetLocs);
	if(!$rsltGetLocs) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		if(mysqli_num_rows($rsltGetLocs) == 0) {
			$custLocIdStr = "0";
		}
		else {
			$custLocIdArr = array();
			while($rowGetLocs = mysqli_fetch_assoc($rsltGetLocs)) {

				$custLocId = $rowGetLocs[locId];
				if(!is_numeric($custLocId))	$custLocId = 0;

				array_push($custLocIdArr, $custLocId);
			}

			$custLocIdStr = implode(", ", $custLocIdArr);

		}
	}

	if($custLocIdStr == "")
		$custLocIdStr = "0";

	// GET QUANTITY FROM RELATED RECORDS IN TRANSACTIVITY GROUP BY SPID AND UPDATE
	// ROUTEDRAWACCOUNTING RECORDS
	$qryGetTA = "SELECT ta.specificproductid spId
					FROM transactivity ta 
					WHERE ta.locationid = $GLOBALS[ASLocationID]
					AND ta.datet = '$dbDateSked'
					AND ta.type = 'SP'
					AND ta.customerlocid IN ($custLocIdStr)
					GROUP BY ta.specificproductid
					ORDER BY ta.specificproductid";

	// FOR SPLITTING OF TABLES
	$qryGetTA = convertToSplitTables($qryGetTA, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print($qryGetTA . "<br />\n");
	$rsltGetTA = mysqli_query( $GLOBALS[cvtconnection], $qryGetTA);

	if(!$rsltGetTA) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		while($rowGetTA = mysqli_fetch_assoc($rsltGetTA)) {
			$spId = $rowGetTA[spId];

			ValidateForInt(false, "spId");

			if($spId != 0) {
				// CHECK IF ROUTEDRAWACCOUNTING RECORD EXIST THEN UPDATE IT ELSE CREATE IT
				$qryChkRecs = "SELECT recid
								FROM routedrawaccounting
								WHERE clientlocid = $GLOBALS[ASLocationID]
								AND specificrouteid = $srId
								AND actspecificproductid = $spId
								AND type = 'SP'";

				// FOR SPLITTING OF TABLES
				$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);

				if($GLOBALS[debug])
					print($qryChkRecs . "<br />\n");
				$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
				if(!$rsltChkRecs) {
					$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($GLOBALS[fileLineNbr]);
				}
				else {
					if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
						$rdaId = $rowChkRecs[recid];
						if(!is_numeric($rdaId)) $rdaId = 0;
					}
					else {
						$rdaId = 0;
					}

					if($rdaId != 0) {

						// UPDATE ROUTEDRAWACCOUNTING
						$qryUp = "UPDATE routedrawaccounting
									SET qtyretd = 0,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE recid = $rdaId
									AND clientlocid = $GLOBALS[ASLocationID]";

						// FOR SPLITTING OF TABLES
						$qryUp = convertToSplitTables($qryUp, $GLOBALS[val_SPLIT]);

						if($GLOBALS[debug])
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
						if(!$rsltUp) {
							$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 03);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($GLOBALS[fileLineNbr]);
						}
					}
					else {
						// INSERT INTO ROUTEDRAWACCOUNTING
						$qryIns = "INSERT INTO routedrawaccounting(clientlocid, specificrouteid, actspecificproductid, qtyretd, type)
						VALUES($GLOBALS[ASLocationID], $srId, $spId, 0, 'SP')";

						// FOR SPLITTING OF TABLES
						$qryIns = convertToSplitTables($qryIns, $GLOBALS[val_SPLIT]);

						if($GLOBALS[debug])
							print("<b>" . $qryIns . "</b><br />\n");
						$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
						if(!$rsltIns) {
							$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 02);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($GLOBALS[fileLineNbr]);
						}
					}
				}
			}
		}
	}
}


/*
	THIS FUNCTION IS USED TO TRUNCATE THE PASSED TABLE
*/
function DropTmp_TRA37($tablename) {
	if($tablename == "") return;

	$qryIns = "DROP TABLE $tablename";
	if($GLOBALS[debug])
		print("<b>" . $qryIns . "</b><br />\n");
	$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
	if(!$rsltIns) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 8);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		if($GLOBALS[debug])

			print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
	}
}

/*
	THIS FUNCTION IS USED TO GET THE QTYSKED FROM THE RELATED ROUTEDRAWACCOUNTING
	RECORDS FOR THE GIVEN PRODUCTDISPATCHID AND SPECIFICPRODUCTID
*/
function GetQtySked_TRA37($pdid, $spid, $incLoc, $region) {
	if(!is_numeric($pdid)) $pdid = 0;
	if(!is_numeric($spid)) $spid = 0;

	$returnArray = array();
	if($pdid == 0 || $spid == 0) return 0;
	$incFromStr = "";
	$incWhereStr = "";
	if($incLoc == "region") {
		$incFromStr = ", vendingsubgroup vsg ";
		$incWhereStr = " AND vsg.vendinggroupid = $region
							 AND vsg.routeid = sr.routeid ";
	}

	// GET SPECIFICROUTEID SET
	$qryGetSR = "SELECT DISTINCT(sr.recid) srid
				FROM specificroutes sr/*, routesetdetail rsd*/, productdispatch pd " . $incFromStr . "
				WHERE pd.recid = $pdid
				/*AND rsd.routesetid = pd.routesetid
				AND sr.routeid = rsd.routeid*/
				AND sr.datesked = pd.rundate
				AND sr.dispatchlocid = $GLOBALS[ASLocationID] " . $incWhereStr . "";

	// FOR SPLITTING OF TABLES
	$qryGetSR = convertToSplitTables($qryGetSR, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print($qryGetSR . "<br />\n");
	$rsltGetSR = mysqli_query( $GLOBALS[cvtconnection], $qryGetSR);
	$srid_str = "";
	if(!$rsltGetSR) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		while($rowGetSR = mysqli_fetch_assoc($rsltGetSR)) {
			$srid = $rowGetSR[srid];
			if(!is_numeric($srid)) $srid = 0;
			if($srid != 0) {
				if($srid_str != "") $srid_str .= ", ";
				$srid_str .= $srid;
			}
		}
	}

	if($srid == "") return 0;

	// FIND SPECIFICPRODUCT.DATEX AND PRODUCTID
	 $selectStr = "productid prodid, DATE_FORMAT(datex, '%Y-%m-%d') dbdatex";
	 $fromStr = "specificproduct";
	 $whereStr = "recid = $spid";
	$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetSingleRecInfo($GLOBALS[cvtconnection], $GLOBALS[debug], $selectStr, $fromStr, $whereStr);
	unset($selectStr, $fromStr, $whereStr, $GLOBALS[fileLineNbr]);

	if($rsltArr) {
		$prodid = $rsltArr[prodid];
		$dbdatex = $rsltArr[dbdatex];
		if(!is_numeric($prodid)) $prodid = 0;
	}
	else {
		$prodid = 0;
		$dbdatex = 0;
	}
	unset($rsltArr);

	if($prodid == 0) return 0;

	// get quantity now
	$selectStr = "SUM(rda.qtysked) qtysked, SUM(rda.qtyissued) qtyissued";
	$fromStr = "routedrawaccounting rda, specificproduct sp";
	$whereStr = "rda.clientlocid = $GLOBALS[ASLocationID]
				AND sp.recid = rda.actspecificproductid
				AND rda.specificrouteid IN ($srid_str)
				AND sp.productid = $prodid
				AND sp.datex = '$dbdatex'
				AND rda.type = 'SD'";
	$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetSingleRecInfo($GLOBALS[cvtconnection], $GLOBALS[debug], $selectStr, $fromStr, $whereStr);
	unset($selectStr, $fromStr, $whereStr, $GLOBALS[fileLineNbr]);

	if($rsltArr) {
		$qtysked = $rsltArr[qtysked];
		$qtyissued = $rsltArr[qtyissued];
	}
	else {
		$qtysked = 0;
		$qtyissued = 0;
	}
	unset($rsltArr);
	if(!is_numeric($qtysked)) $qtysked = 0;
	if(!is_numeric($qtyissued)) $qtyissued = 0;

	$returnArray[QTYSKED] = $qtysked;
	$returnArray[QTYISSUED] = $qtyissued;

	return $returnArray;
}

/*
	TO DECIDE WHETHER THE DATEX IS DIFFERENT THAN THE SKEDDELIV FOR THE PSSED SPID
*/
function IsDateXDifferent_TRA37($spid) {
	if(!is_numeric($spid)) $spid = 0;

	if($spid == 0) return false;

	$qryChkRecs = "SELECT COUNT(*) FROM specificproduct
				WHERE recid = $spid
				AND datex <> skeddeliv";
	if($GLOBALS[debug])
		print($qryChkRecs . "<br />\n");
	$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
	$flagExist = false;
	if(!$rsltChkRecs) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		if($rowChkRecs = mysqli_fetch_row($rsltChkRecs)) {
			$NoRecs = $rowChkRecs[0];
			if(!is_numeric($NoRecs)) $NoRecs = 0;
			if($NoRecs > 0) $flagExist = true;
		}
	}
	return $flagExist;
}

/*
	THIS FUNCTION WILL TRUNCATE THE GIVEN TABLE
*/
function TruncateTable_TRA37($tablename) {
	if($tablename == "") return;

	$qryIns = "TRUNCATE TABLE $tablename";
	if($GLOBALS[debug])
		print("<b>" . $qryIns . "</b><br />\n");
	$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
	if(!$rsltIns) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 07);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		if($GLOBALS[debug])
			print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
	}
}

/*
	THIS WILL CHECK WHETHER THERE EXIST ANY LOCATIONS/PUBLICATION COMBINATION WITH
	REDEPLOY MULTIPLE CASE.
*/
function ReDepMulExists_TRA37($dbEffDt) {
	$rt_array = array("flagExist" => false);

	if($dbEffDt == "") return $rt_array;

	$stdrt_array = GeneralArray("routetype_standard");
	$stdrt_str = MakeStrFromArray($stdrt_array, ", ", "'");
	if($stdrt_str == "") $stdrt_str = "''";

	$stdrt_str .= ", 'RR', 'SS', 'CR', 'PR'";

	if($GLOBALS[val_ESRTE] == "Y") {
		$stdrt_str .= ", 'ER'";
	}

	if($GLOBALS[val_HAWKS] == 'Y') {
		$stdrt_str .= ", 'AM', 'PM', 'TR'";
	}

	// FINDING ALL SPECIFICROUTES RECORDS
	/*$tSrIdStr = "";
	$qryGetSrInfo = "SELECT recid tSrId
					FROM specificroutes
					WHERE dispatchlocid = $GLOBALS[ASLocationID]
					AND datesked = '$dbEffDt'";

	// FOR SPLITTING TABLES
	$qryGetSrInfo = convertToSplitTables($qryGetSrInfo, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print($qryGetSrInfo . "<br />\n");
	$rsltGetSrInfo = mysql_query($qryGetSrInfo, $GLOBALS[cvtconnection]);
	while($rowGetSrInfo = mysql_fetch_assoc($rsltGetSrInfo)) {

		$tSrId = $rowGetSrInfo[tSrId];
		if(!is_numeric($tSrId))	$tSrId = 0;

		if($tSrIdStr == "") {
			$tSrIdStr .= $tSrId;
		}
		else {
			$tSrIdStr .= ", " . $tSrId;
		}
	}
	$tSrIdStr = ($tSrIdStr == "" ? "0" : $tSrIdStr);*/

	// NOW CREATING TEMPORARY TABLE FOR SPECIFICROUTES AND SPECIFICROUTELOC
	// CREATING TEMPORARY TABLE
	$qryCreateTemp = "CREATE TEMPORARY TABLE tmpTRA37ChkRuns (
		srid BIGINT(20) NOT NULL,
		routeid BIGINT(20) NOT NULL,
		locationid BIGINT(20) NOT NULL,
		routetype char(2) NOT NULL,
		datesked DATE NOT NULL DEFAULT '0000-00-00',
		KEY srid (srid),
		KEY locationid (locationid),
		KEY datesked (datesked)
	)";
	if($GLOBALS[debug])
		print("<b>" . $qryCreateTemp . "</b><br />\n");
	$rsltCreateTemp = mysqli_query( $GLOBALS[cvtconnection], $qryCreateTemp);
	if(!$rsltCreateTemp) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(14, 05);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}

	$qryIns = "INSERT INTO tmpTRA37ChkRuns SELECT sr.recid, sr.routeid, srl.locationid, r.type, sr.datesked FROM specificroutes sr, specificrouteloc srl, route r WHERE r.locationid = $GLOBALS[ASLocationID] AND r.type IN ($stdrt_str) AND r.recid = sr.routeid AND sr.dispatchlocid = $GLOBALS[ASLocationID] AND sr.datesked = '$dbEffDt' AND sr.recid = srl.specificrouteid AND srl.clientlocid = $GLOBALS[ASLocationID]";

	// FOR SPLITTING OF TABLES -- ADDED ON
	$qryIns = convertToSplitTables($qryIns, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print("<b>" . $qryIns . "</b><br />\n");
	$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
	if(!$rsltIns) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(14, 06);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		if($debug)
			print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
	}

	// FINDING MULTIPLE RECORDS
	/*$qryGetRM = "SELECT ta.customerlocid locid, ta.specificproductid spid,
				ta.type tatype, COUNT( DISTINCT( IF( ta.type = 'SP' AND rl.returnsflag = 'R' AND r.type IN ('RR', 'SS', 'ER', 'CR'), sr.recid, IF( ta.type = 'SP' AND rl.returnsflag = 'D' AND r.type IN ('SR', 'HO'), sr.recid, IF( ta.type = 'SD' AND r.type <> 'RR' AND r.type <> 'CR' AND r.type <> 'SS' AND r.type <> 'ER',  sr.recid, NULL) ) ) ) ) cnt_rt, rl.returnsflag
				FROM transactivity ta, specificrouteloc srl, specificroutes sr,
				route r, routelink rl
				WHERE ta.locationid = $GLOBALS[ASLocationID]
				AND ta.datet = '$dbEffDt'
				AND ta.type IN ('SD', 'SP')
				AND ( ta.specificrouteid IS NULL OR ta.specificrouteid = 0 )
				AND ( ta.specificproductid IS NOT NULL AND ta.specificproductid != 0 )
				AND srl.locationid = ta.customerlocid
				AND srl.clientlocid = $GLOBALS[ASLocationID]
				AND sr.recid = srl.specificrouteid
				AND sr.recid IN ($tSrIdStr)
				AND sr.datesked = ta.datet
				AND sr.dispatchlocid = $GLOBALS[ASLocationID]
				AND r.recid = sr.routeid
				AND r.locationid = $GLOBALS[ASLocationID]
				AND r.type IN ($stdrt_str)
				AND rl.locationid = ta.customerlocid
				AND rl.clientid = $GLOBALS[ASCompanyID]
				GROUP BY ta.customerlocid, ta.specificproductid, ta.type
				HAVING cnt_rt > 1
				ORDER BY ta.customerlocid, ta.specificproductid";*/

	/*$qryGetRM = "SELECT ta.customerlocid locid, ta.specificproductid spid, ta.type tatype,
				COUNT( DISTINCT( IF( ta.type = 'SP' AND tsrl.rlReturnsFlag = 'R' AND tsrl.routeType IN ('RR', 'SS', 'ER', 'CR'), tsrl.srId, IF( ta.type = 'SP' AND tsrl.rlReturnsFlag = 'D' AND tsrl.routeType IN ('SR', 'HO'), tsrl.srId, IF( ta.type = 'SD' AND tsrl.routeType NOT IN ('RR', 'SS', 'ER', 'CR'), tsrl.srId, NULL) ) ) ) ) cnt_rt,
				tsrl.rlReturnsFlag returnsflag
				FROM transactivity ta,
				(
					SELECT srl.locationid srlLocId, rl.returnsflag rlReturnsFlag, r.type routeType, sr.recid srId
					FROM specificrouteloc srl, specificroutes sr, route r, routelink rl
					WHERE srl.clientlocid = $GLOBALS[ASLocationID]
					AND sr.recid = srl.specificrouteid
					AND sr.dispatchlocid = $GLOBALS[ASLocationID]
					AND sr.routeid = r.recid
					AND r.locationid = $GLOBALS[ASLocationID]
					AND r.type IN ($stdrt_str)
					AND rl.clientid = $GLOBALS[ASCompanyID]
					AND srl.locationid = rl.locationid
					AND sr.datesked = '$dbEffDt'
				) tsrl
				WHERE ta.locationid = $GLOBALS[ASLocationID]
				AND ta.customerlocid = tsrl.srlLocId
				AND ta.datet = '$dbEffDt'
				AND ta.type IN ('SD', 'SP')
				AND ( ta.specificrouteid IS NULL OR ta.specificrouteid = 0 )
				AND ( ta.specificproductid IS NOT NULL AND ta.specificproductid != 0 )
				GROUP BY ta.customerlocid, ta.specificproductid, ta.type
				HAVING cnt_rt > 1
				ORDER BY ta.customerlocid, ta.specificproductid";*/

	$routeTypeStr = "'SR', 'HO', 'PR'";
	if($GLOBALS[val_HAWKS] == "Y") {
		$routeTypeStr .= ", 'AM', 'PM', 'TR'";
	}

	$qryGetRM = "SELECT ta.customerlocid locid, ta.specificproductid spid,
				ta.type tatype, COUNT( DISTINCT( IF( ta.type = 'SP' AND rl.returnsflag = 'R' AND tsr.routetype IN ('RR', 'SS', 'ER', 'CR'), tsr.srid, IF( ta.type = 'SP' AND rl.returnsflag = 'D' AND tsr.routetype IN ($routeTypeStr), tsr.srid, IF( ta.type = 'SD' AND tsr.routetype <> 'RR' AND tsr.routetype <> 'SS' AND tsr.routetype <> 'ER' AND tsr.routetype <> 'CR',  tsr.srid, NULL) ) ) ) ) cnt_rt, rl.returnsflag
				FROM transactivity ta, routelink rl, tmpTRA37ChkRuns tsr
				WHERE ta.locationid = $GLOBALS[ASLocationID]
				AND ta.datet = '$dbEffDt'
				AND ta.type IN ('SD', 'SP')
				AND ( ta.specificrouteid IS NULL OR ta.specificrouteid = 0 )
				AND ( ta.specificproductid IS NOT NULL AND ta.specificproductid != 0 )
				AND ta.customerlocid = tsr.locationid
				AND ta.datet = tsr.datesked
				AND rl.clientid = $GLOBALS[ASCompanyID]
				AND tsr.locationid = rl.locationid
				GROUP BY ta.customerlocid, ta.specificproductid, ta.type
				HAVING cnt_rt > 1
				ORDER BY ta.customerlocid, ta.specificproductid";

	// FOR SPLITTING OF TABLES
	$qryGetRM = convertToSplitTables($qryGetRM, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print($qryGetRM . "<br />\n");
	$rsltGetRM = mysqli_query( $GLOBALS[cvtconnection], $qryGetRM);

	if(!$rsltGetRM) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		if(mysqli_num_rows($rsltGetRM) == 0) {
			return $rt_array;
		}
		else {
			$flagExist = false;
			$temp_rdm_array = array();
			while($rowGetRM = mysqli_fetch_assoc($rsltGetRM)) {
				// for each such locid and spid we need to see whether there exist data
				// in previous week or not
				$locid = $rowGetRM[locid];
				$spid = $rowGetRM[spid];
				$type = $rowGetRM[tatype];
				$returnsFlag = $rowGetRM[returnsflag];
				ValidateForInt(false, "locid", "spid");

				if($type == "SP" && $returnsFlag == "S") {
				}
				else {

					$old_srid = ReDupMulPrevWeekExist_TRA37($locid, $spid, $dbEffDt, $type);
					if($old_srid == 0) {
						$flagExist = true;
						break;
					}
					else {
						array_push($temp_rdm_array,
							array(
								"locid" => $locid,
								"spid" => $spid,
								"srid" => $old_srid,
								"type" => $type

							)
						);
					}
				}
			}

			if($flagExist) {
				$rt_array[flagExist] = true;
			}
			else {
				$rt_array[redepmul_array] = $temp_rdm_array;
			}
			return $rt_array;
		}
	}
}

/*
	THIS WILL CHECK WHETHER ANY SPECIFICROUTEID IS SET FOR THE SAME LOCID AND SPID RELATED
	TO PASSED SPID EXIST IN LAST WEEK.
*/
function ReDupMulPrevWeekExist_TRA37($locid, $spid, $dbEffDt, $type, $tmpTableExist = false) {

	ValidateForInt(false, "locid", "spid");
	if($locid == 0 || $spid == 0 || $dbEffDt == "") return 0;

	// GET THE CURRENT ROUTEIDS FOR THE LOCATIONS
	if($tmpTableExist) {
		$qryGetInfo = "SELECT DISTINCT r.recid routeid
						FROM tmpTRA37ChkRuns tsr, route r
						WHERE tsr.locationid = $locid
						AND r.recid = tsr.routeid
						AND r.locationid = $GLOBALS[ASLocationID]
						ORDER BY r.routenbr";
	}
	else {
		$qryGetInfo = "SELECT DISTINCT sr.routeid
						FROM specificroutes sr, specificrouteloc srl, route r
						WHERE srl.clientlocid = $GLOBALS[ASLocationID]
						AND srl.locationid = $locid
						AND sr.recid = srl.specificrouteid
						AND sr.datesked = '$dbEffDt'
						AND sr.dispatchlocid = $GLOBALS[ASLocationID]
						AND r.locationid = $GLOBALS[ASLocationID]
						AND sr.routeid = r.recid
						/*AND r.type != 'RS'*/";

		// FOR SPLITTING OF TABLES
		$qryGetInfo = convertToSplitTables($qryGetInfo, $GLOBALS[val_SPLIT]);
	}

	if($GLOBALS[debug])
		print($qryGetInfo . "<br />\n");
	$rsltGetInfo = mysqli_query( $GLOBALS[cvtconnection], $qryGetInfo);
	if(!$rsltGetInfo) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		if(mysqli_num_rows($rsltGetInfo) == 0) {
			$routeIdStr = "0";
		}
		else {
			$routeIdArr = array();
			while($rowGetInfo = mysqli_fetch_assoc($rsltGetInfo)) {
				$routeId = $rowGetInfo[routeid];
				if(!is_numeric($routeId))	$routeId = 0;
				array_push($routeIdArr, $routeId);
			}

			$routeIdStr = implode(", ", $routeIdArr);
			if($routeIdStr == "") {
				$routeIdStr = "0";
			}
		}
	}

	// GET DATEX AND PRODUCT FIRST
	$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetTableInfo($GLOBALS[debug], $GLOBALS[cvtconnection], "specificproduct", $spid,
		"DATE_FORMAT(datex, '%Y-%m-%d') dbdatex",
		"DATE_FORMAT(skeddeliv, '%Y-%m-%d') dbskeddeliv", "productid prodid");
	if($rsltArr[rtvalue]) {
		$dbdatex = $rsltArr[dbdatex];
		$dbskeddeliv = $rsltArr[dbskeddeliv];
		$prodid = $rsltArr[prodid];
		if(!is_numeric($prodid)) $prodid = 0;
	}
	else {
		$dbdatex = "";
		$dbskeddeliv = "";
		$prodid = 0;
	}
	unset($rsltArr, $GLOBALS[fileLineNbr]);

	if($dbdatex == "" || $dbskeddeliv == "") return 0;

	// HERE I NEED TO FIND THE DAYCODEID FOR THE PRODUCT
	$selectStr = "dc.recid dayCodeId, dc.day dcDay, dc.period dcPeriod";
	$fromStr = "product p, daycode dc";
	$whereStr = "p.recid = $prodid
				AND (p.endeffdt IS NULL OR p.endeffdt = '0000-00-00'
				OR p.endeffdt > '$dbdatex')
				AND p.daycodeid = dc.recid";
	$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetSingleRecInfo($GLOBALS[cvtconnection], $GLOBALS[debug], $selectStr, $fromStr, $whereStr);
	unset($selectStr, $fromStr, $whereStr);

	if($rsltArr) {
		$dcDay = $rsltArr[dcDay];
		$dcPeriod = $rsltArr[dcPeriod];
		$dayCodeId = $rsltArr[dayCodeId];
	}
	else {
		$dcDay = "";
		$dcPeriod = "";
		$dayCodeId = 0;
	}
	unset($rsltArr);
	if(!is_numeric($dayCodeId))	$dayCodeId = 0;

	if(($dcDay == "IND") &&  $dcPeriod == "B" || $dcPeriod == "E" || $dcPeriod == "M" || $dcPeriod == "Q" ) {

		// HERE WE NEED TO FIND THE PRECEDENCE FOR THE MONTHLY PUBLICATION

		if($dcPeriod != "Q") {

			// GET THE DATE PRIORS TO ONE MONTH
			$oldDbDatex = date("Y-m-d", mktime(0, 0, 0, substr($dbdatex, 5, 2), substr($dbdatex, 8, 2) - 60, substr($dbdatex, 0, 4)));

			// CHECK WHETHER THERE EXIST A TRANSACTIVITY FOR THIS OLD_DBDATEX
			$selectStr = "DISTINCT(ta.specificrouteid) srid";
			$fromStr = "transactivity ta, specificproduct sp, specificroutes sr";
			$whereStr = "ta.locationid = $GLOBALS[ASLocationID]
						AND ta.type = '$type'
						AND ta.customerlocid = $locid
						AND ta.specificrouteid IS NOT NULL
						AND ta.specificrouteid <> 0
						AND sp.recid = ta.specificproductid
						AND sp.datex >= '$oldDbDatex'
						AND sp.datex < '$dbdatex'
						AND sr.recid = ta.specificrouteid
						AND sr.dispatchlocid = $GLOBALS[ASLocationID]
						AND sp.productid = $prodid
						AND sr.routeid IN ($routeIdStr)
						ORDER BY sp.datex DESC LIMIT 1";

			$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetSingleRecInfo($GLOBALS[cvtconnection], $GLOBALS[debug], $selectStr, $fromStr, $whereStr);
			unset($selectStr, $fromStr, $whereStr, $GLOBALS[fileLineNbr]);

			if($rsltArr) {
				$srid = $rsltArr[srid];
			}
			else {
				$srid = 0;
			}
			unset($rsltArr);
			if(!is_numeric($srid)) $srid = 0;
		}
		else {

			// GET THE DATE PRIORS TO ONE MONTH
			$oldDbDatex = date("Y-m-d", mktime(0, 0, 0, substr($dbdatex, 5, 2), substr($dbdatex, 8, 2) - 100, substr($dbdatex, 0, 4)));

			// CHECK WHETHER THERE EXIST A TRANSACTIVITY FOR THIS OLD_DBDATEX

			$selectStr = "DISTINCT(ta.specificrouteid) srid";
			$fromStr = "transactivity ta, specificproduct sp, specificroutes sr";
			$whereStr = "ta.locationid = $GLOBALS[ASLocationID]
						AND ta.type = '$type'
						AND ta.customerlocid = $locid
						AND ta.specificrouteid IS NOT NULL
						AND ta.specificrouteid <> 0
						AND sp.recid = ta.specificproductid
						AND sp.datex >= '$oldDbDatex'
						AND sp.datex < '$dbdatex'
						AND sr.recid = ta.specificrouteid
						AND sr.dispatchlocid = $GLOBALS[ASLocationID]
						AND sp.productid = $prodid
						AND sr.routeid IN ($routeIdStr)
						ORDER BY sp.datex DESC LIMIT 1";

			$arrInfo_ARCHIVE = array(
				"arrLookup" => array(
					"specificproduct" => array(
						"datex" => array(
							"dbFromDate" => $dbdatex,
							"dbToDate" => $oldDbDatex
						)
					)
				)
			);

			$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetSingleRecInfo($GLOBALS[cvtconnection], $GLOBALS[debug], $selectStr, $fromStr, $whereStr, $arrInfo_ARCHIVE);
			unset($selectStr, $fromStr, $whereStr, $GLOBALS[fileLineNbr]);

			if($rsltArr) {
				$srid = $rsltArr[srid];
			}
			else {
				$srid = 0;
			}
			unset($rsltArr);
			if(!is_numeric($srid)) $srid = 0;
		}
	}
	else {
		for($cntId = 7; $cntId <= 21; $cntId+=7) {

			// GET SEVEN DAYS PRIOR VALUE
			$old_dbdatex = date("Y-m-d", mktime(0, 0, 0, substr($dbdatex, 5, 2), substr($dbdatex, 8, 2) - $cntId, substr($dbdatex, 0, 4)));
			//$old_dbskeddeliv = date("Y-m-d", mktime(0, 0, 0, substr($dbskeddeliv, 5, 2), substr($dbskeddeliv, 8, 2) - 7, substr($dbskeddeliv, 0, 4)));
			$old_datesked = date("Y-m-d", mktime(0, 0, 0, substr($dbEffDt, 5, 2), substr($dbEffDt, 8, 2) - $cntId, substr($dbEffDt, 0, 4)));

			// CHECK WHETHER THERE EXIST A TRANSACTIVITY FOR THIS OLD_DBDATEX
			$selectStr = "DISTINCT(ta.specificrouteid) srid";
			$fromStr = "transactivity ta, specificproduct sp, specificroutes sr";
			$whereStr = "ta.locationid = $GLOBALS[ASLocationID]
						AND ta.type = '$type'
						AND ta.customerlocid = $locid
						AND ta.specificrouteid IS NOT NULL
						AND ta.specificrouteid <> 0
						AND sp.recid = ta.specificproductid
						AND sp.datex = '$old_dbdatex'
						/*AND sp.skeddeliv = '$old_dbskeddeliv'*/
						AND sr.recid = ta.specificrouteid
						AND sr.dispatchlocid = $GLOBALS[ASLocationID]
						AND sr.datesked = '$old_datesked'
						AND sp.productid = $prodid
						AND sr.routeid IN ($routeIdStr)";
			$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetSingleRecInfo($GLOBALS[cvtconnection], $GLOBALS[debug], $selectStr, $fromStr, $whereStr);
			unset($selectStr, $fromStr, $whereStr, $GLOBALS[fileLineNbr]);

			if($rsltArr) {
				$srid = $rsltArr[srid];
			}
			else {
				$srid = 0;
			}
			unset($rsltArr);
			if(!is_numeric($srid)) $srid = 0;

			if($srid != 0) {
				break;
			}
		}
	}

	if($srid == 0) return 0;
	// FIND THE RELATED SRID NOW
	$selectStr = "sr2.recid new_srid";
	$fromStr = "specificroutes sr1, specificroutes sr2";
	$whereStr = "sr1.recid = $srid
				AND sr1.routeid = sr2.routeid
				AND sr2.datesked = '$dbEffDt'
				AND sr1.dispatchlocid = $GLOBALS[ASLocationID]
				AND sr2.dispatchlocid = $GLOBALS[ASLocationID]";
	$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetSingleRecInfo($GLOBALS[cvtconnection], $GLOBALS[debug], $selectStr, $fromStr, $whereStr);
	unset($selectStr, $fromStr, $whereStr, $GLOBALS[fileLineNbr]);


	if($rsltArr) {
		$new_srid = $rsltArr[new_srid];
	}
	else {
		$new_srid = 0;
	}
	unset($rsltArr);
	if(!is_numeric($new_srid)) $new_srid = 0;

	return $new_srid;
}

/*
	THIS FUNCTION IS USED TO SET ALL THOSE TRANSACTIVITY RECORDS
	WHERE WE NEED THE REDEPLOY MULTIPLE CASE

	THE ARRAY IS IN THIS FORMAT------>
	INDEX		ARRAY
	0		->	ARRAY(
					LOCID => $LOCID,
					SPID => $SPID,
					SRID => $SRID
					TYPE => $TYPE
				)
*/
function SetReDepMulTA_TRA37($info_array, $dbEffDt) {
	if(!is_array($info_array)) return;

	if($GLOBALS[debug]) {
		print("<b>info_array = </b>");
		print_r($info_array);
		print("<br />\n");
	}

	for($cntid = 0; $cntid < count($info_array); $cntid++) {
		$locid = $info_array[$cntid][locid];
		$spid = $info_array[$cntid][spid];
		$srid = $info_array[$cntid][srid];
		$type = $info_array[$cntid][type];
		ValidateForInt(false, "locid", "spid", "srid");

		if($locid == 0 || $spid == 0 || $srid == 0) return;

		// UPDATE THESE RECORDS
		$qryUp = "UPDATE transactivity
                            SET specificrouteid = $srid,
                            archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
                            WHERE locationid = $GLOBALS[ASLocationID]
                            AND datet = '$dbEffDt'
                            AND type = '$type'
                            AND customerlocid = $locid
                            AND specificproductid = $spid";

		// FOR SPLITTING OF TABLES
		$qryUp = convertToSplitTables($qryUp, $GLOBALS[val_SPLIT]);

		if($GLOBALS[debug])
			print("<b>" . $qryUp . "</b><br />\n");
		$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);

		if(!$rsltUp) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 03);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
		    if($GLOBALS[debug])
		        print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . " rows updated.</b><br />");
		}
	}
}

/*
	THIS FUNCTION WILL CHECK FOR CREATE RUN RECORDS PROCESS IS RUN
	OR NOT. IF IT IS ALREADY PROCESSED IT WILL RETURN TRUE ELSE FALSE.
*/
function isCreateRunRecsDone_TRA37($pdId) {

	if(!is_numeric($pdId))	$pdId = 0;

	if($GLOBALS[debug])
		print("isCreateRunRecsDone_TRA37 called. $pdId<br />\n");

	if($pdId != 0) {

		$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetTableInfo($GLOBALS[debug], $GLOBALS[cvtconnection], "productdispatch", $pdId, "runrecordsdt", "runrecordsas");
		if($rsltArr[rtvalue]) {
			$runRecordDt = $rsltArr[runrecordsdt];
			$runRecordAs = $rsltArr[runrecordsas];
			if(!is_numeric($runRecordAs))	$runRecordAs = 0;
		}
		else {
			$runRecordDt = "";
			$runRecordAs = 0;
		}
		unset($rsltArr, $GLOBALS[fileLineNbr]);

		if($GLOBALS[debug])
			print("$runRecordDt - $runRecordAs<br />\n");

		if($runRecordDt != "" /*&& $runRecordAs != 0*/) {
			return true;
		}
		else {
			return false;
		}
	}
	else {
		return false;
	}
}

/*
	THIS FUNCTION IS USE TO FIND THE NO OF RECORDS FOR THE
	GIVEN LOCATION.
*/
function GetTASkedQty_TRA37($srlId) {

	if(!isset($GLOBALS[val_RDSRT]) && $GLOBALS[val_RDSRT] == "") {
		$val_RDSRT = GetLSVar("RDSRT", "charvar", $GLOBALS[ASLocationID], $GLOBALS[cvtconnection]);
		if($debug) print("RDSRT = $val_RDSRT<br />\n");
	}
	else {
		$val_RDSRT = $GLOBALS[val_RDSRT];
	}

	if(!is_numeric($srlId)) $srlId = 0;

	if($srlId == 0) {
		return false;
	}
	else {
		// PUBLICATION SORTING
		$fromStr = "";
		$whereStr = "";
		$orderByStr = "";
		// FOR GETTING STRINGS FOR SORTING
		switch($GLOBALS[val_RDSRT]) {
			case "Q":
				$orderByStr = " actqty DESC, p.ldesc";
				break;

			case "A":
				$fromStr = ", location l, locationlink ll, company c";

				$whereStr = " AND l.recid = p.vendorlocid
							AND ll.locationid = l.recid
							AND c.recid = ll.companyid";

				$orderByStr = " c.name, l.sdesc, p.ldesc";
				break;

			case "S":
				$orderByStr = " p.sortseqnbr";
				break;

			case "C":
				$orderByStr = " p.sdesc";
				break;

			case "B":
				$orderByStr = " p.adesc";
				break;

			default:
				$orderByStr = " p.ldesc";
				break;
		}

		// NOW GET THE PRODID LIST AND ACTQTY
		$qryGetP = "SELECT sp.recid spid, SUM(ta.actquantity) actqty,
					p.recid prodid, p.ldesc proddesc, ta.type,
					DATE_FORMAT(sp.datex, '%m/%d/%y') datex
					FROM specificproduct sp, transactivity ta, product p,
					specificrouteloc srl, specificroutes sr " . $fromStr . "
					WHERE srl.clientlocid = $GLOBALS[ASLocationID]
					AND srl.recid = $srlId
					AND sr.recid = srl.specificrouteid
					AND sr.dispatchlocid = $GLOBALS[ASLocationID]
					AND ta.specificrouteid = sr.recid
					AND ta.datet = sr.datesked
					AND ta.locationid = $GLOBALS[ASLocationID]
					AND ta.customerlocid = srl.locationid
					AND ta.type IN ('SD', 'SP')
					AND sp.recid = ta.specificproductid
					AND p.recid = sp.productid
					AND p.clientid = $GLOBALS[ASCompanyID] " . $whereStr . "
					GROUP BY sp.recid, ta.type
					ORDER BY " . $orderByStr . ", sp.datex DESC";


		// FOR SPLITTING OF TABLES
		$qryGetP = convertToSplitTables($qryGetP, $GLOBALS[val_SPLIT]);

		if($GLOBALS[debug])
			print($qryGetP . "<br />\n");
		$rsltGetP = mysqli_query( $GLOBALS[cvtconnection], $qryGetP);
		if(!$rsltGetP) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			if(mysqli_num_rows($rsltGetP) > 0) {
				$finalArr = array();
				$tempArr = array();

				while($rowGetP = mysqli_fetch_assoc($rsltGetP)) {

					$spId = $rowGetP[spid];
					$actQty = $rowGetP[actqty];
					$prodId = $rowGetP[prodid];
					$prodDesc = $rowGetP[proddesc];
					$dateX = $rowGetP[datex];
					$type = $rowGetP[type];

					ValidateForInt(false, "spId", "actQty", "prodId");

					if(!isset($final_array[$spId])) {
						$finalArr[$spId] = array();

						$tempArr[type] = $type;
						$tempArr[prodid] = $prodId;
						$tempArr[qty] = $actQty;
						$tempArr[proddesc] = $prodDesc;
						$tempArr[datex] = $dateX;

						$finalArr[$spId] = $tempArr;
					}
					else {
						$finalArr[$spId][qty] += $qty;
					}
				}
			}
		}

		/*//NOW GET THE PRODID LIST AND ACTQTY
		$qryGetP = "SELECT sp.recid spid, SUM(ta.actquantity) actqty,
					p.recid prodid, p.ldesc proddesc, ta.type,
					DATE_FORMAT(sp.datex, '%m/%d/%y') datex
					FROM specificproduct sp, transactivity ta, product p,
					specificrouteloc srl, specificroutes sr " . $fromStr . "
					WHERE srl.recid = $srlId
					AND sr.recid = srl.specificrouteid
					AND ta.datet = sr.datesked
					AND ta.locationid = $GLOBALS[ASLocationID]
					AND ta.customerlocid = srl.locationid
					AND ta.type = 'SP'
					AND sp.recid = ta.specificproductid
					AND p.recid = sp.productid
					AND p.clientid = $GLOBALS[ASCompanyID] " . $whereStr . "
					GROUP BY sp.recid, ta.type
					ORDER BY " . $orderByStr . " , sp.datex DESC";
		if($GLOBALS[debug])
			print($qryGetP . "<br />\n");
		$rsltGetP = mysql_query($qryGetP, $GLOBALS[cvtconnection]);
		if(mysql_num_rows($rsltGetP) > 0) {

			if(!isset($finalArr))
				$finalArr = array();

			if(!isset($tempArr))
				$tempArr = array();

			while($rowGetP = mysql_fetch_assoc($rsltGetP)) {

				$spId = $rowGetP[spid];
				$actQty = $rowGetP[actqty];
				$prodId = $rowGetP[prodid];
				$prodDesc = $rowGetP[proddesc];
				$dateX = $rowGetP[datex];
				$type = $rowGetP[type];

				ValidateForInt(false, "spId", "actQty", "prodId");

				if(isset($finalArr[$spId][PU])) continue;

				if(!isset($finalArr[$spId])) {
					$finalArr[$spId] = array();

					$tempArr[type] = $type;
					$tempArr[prodid] = $prodId;
					$tempArr[qty] = $actQty;
					$tempArr[proddesc] = $prodDesc;
					$tempArr[datex] = $dateX;

					$finalArr[$spId] = $tempArr;
				}
				else {
					$finalArr[$spId][qty] += $qty;
				}
			}
		}*/

		if(isset($finalArr)) {
			return $finalArr;
		}
		else {
			return false;
		}
	}
}

/*
	THIS FUNCTION WILL CREATE TRANSACTIVITY RECORDS FOR RESUPPLY ROUTES
*/
function createReSupplyRecs_TRA37($dbEffDt) {

	//$dayToDowArr = GeneralArray("daytodow");

	if($GLOBALS[debug])
		print("dbEffDt = $dbEffDt<br />\n");

	if($dbEffDt == "") {
		return;
	}

	// NOW FINDING RESUPPLY ROUTE LOCATIONS
	$qryGetReSupRouteLocs = "SELECT DISTINCT sr.recid rsSrId, srl.locationid srLocId,
							sr.driverid srDriverId, r.type routeT
							FROM specificroutes sr, specificrouteloc srl, route r, location l
							WHERE sr.dispatchlocid = $GLOBALS[ASLocationID]
							AND sr.datesked = '$dbEffDt'
							AND r.recid = sr.routeid
							AND r.type IN ('RS', 'SS', 'LR')
							AND r.locationid = $GLOBALS[ASLocationID]
							AND srl.specificrouteid = sr.recid
							AND srl.clientlocid = $GLOBALS[ASLocationID]
							AND srl.locationid = l.recid
							AND l.type != 'G'
							ORDER BY r.sortseqnbr, r.routenbr, r.sdesc";

	// FOR SPLITTING OF TABLES
	$qryGetReSupRouteLocs = convertToSplitTables($qryGetReSupRouteLocs, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print($qryGetReSupRouteLocs . "<br />\n");
	$rsltGetReSupRouteLocs = mysqli_query( $GLOBALS[cvtconnection], $qryGetReSupRouteLocs);
	if(!$rsltGetReSupRouteLocs) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		if(mysqli_num_rows($rsltGetReSupRouteLocs) == 0) {
		}
		else {
			// FINDING THE DAY OF RUNDATE
			$strDay = strtolower(DayNameOfWeek_TRADATE($dbEffDt, "S"));

			// FINDING SPECIFICPRODUCT OF THE RUNDAY
			$qryGetSpInfo = "SELECT sp.recid spId, p.recid prodId
							FROM specificproduct sp, product p
							WHERE p.clientid = $GLOBALS[ASCompanyID]
							AND ( p.endeffdt IS NULL OR p.endeffdt = '0000-00-00' OR p.endeffdt > '$dbEffDt' )
							AND sp.productid = p.recid
							AND sp.skeddeliv = '$dbEffDt'
							AND ( sp.endeffdt IS NULL OR sp.endeffdt = '0000-00-00' OR sp.endeffdt > '$dbEffDt' )";
			if($GLOBALS[debug])
				print($qryGetSpInfo . "<br />\n");
			$rsltGetSpInfo = mysqli_query( $GLOBALS[cvtconnection], $qryGetSpInfo);
			$spProdIdArr = array();
			if(!$rsltGetSpInfo) {
				$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($GLOBALS[fileLineNbr]);
			}
			else {
				while($rowGetSpInfo = mysqli_fetch_assoc($rsltGetSpInfo)) {

					$spId = $rowGetSpInfo[spId];
					$prodId = $rowGetSpInfo[prodId];
					ValidateForInt(false, "spId", "prodId");

					if(!isset($spProdIdArr[$prodId])) {
						$spProdIdArr[$prodId] = array();
					}

					array_push($spProdIdArr[$prodId], $spId);
				}
			}

			$crtLocCnt = 0;

			$flagUpdateRouteDraw = false;
			$rsRouteTypeArray = array();
			while($rowGetReSupRouteLocs = mysqli_fetch_assoc($rsltGetReSupRouteLocs)) {

				$rsSrId = $rowGetReSupRouteLocs[rsSrId];
				$srLocId = $rowGetReSupRouteLocs[srLocId];
				$srDriverId = $rowGetReSupRouteLocs[srDriverId];
				$routeT = $rowGetReSupRouteLocs[routeT];
				ValidateForInt(false, "rsSrId", "srLocId", "srDriverId");

				if($GLOBALS[debug])
					print("$rsSrId, $srLocId<br />\n");

				// NOW CHECKINF FOR CUSTOMER IS OPEN OR NOT
				if(IsCustomerOpen_SPECDRAW($srLocId, $dbEffDt)) {

					$routeTypeStr = "'SR', 'PR'";
					if($GLOBALS[val_HAWKS] == "Y") {
						$routeTypeStr .= ", 'AM', 'PM', 'TR'";
					}

					// LETS CHECK FOR THE EXISTANCE OF SR ROUTE FOR THIS LOCATION
					$qryChkRecs = "SELECT COUNT(DISTINCT(sr.recid)) srCntRs
									FROM route r, specificroutes sr, specificrouteloc srl 
									WHERE r.locationid = $GLOBALS[ASLocationID]
									AND r.type IN ($routeTypeStr)
									AND sr.routeid = r.recid
									AND sr.dispatchlocid = $GLOBALS[ASLocationID]
									AND sr.datesked = '$dbEffDt'
									AND srl.specificrouteid = sr.recid
									AND srl.clientlocid = $GLOBALS[ASLocationID]
									AND srl.locationid = $srLocId";

					// FOR SPLITTING OF TABLES
					$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);

					if($GLOBALS[debug])
						print($qryChkRecs . "<br />\n");
					$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);

					if(!$rsltChkRecs) {
						$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($GLOBALS[fileLineNbr]);
						$srCntRs = 0;
					}
					else {
						$rowChkRecs = mysqli_fetch_assoc($rsltChkRecs);
						$srCntRs = $rowChkRecs[srCntRs];
					}

					// NOW FINDING PRODUCTID FROM STANDARDDDRAW
					$qryGetStdDrawInfo = "SELECT DISTINCT productid prodId, max(effdt) sdEffDt
											FROM standarddraw
											WHERE clientlocid = $GLOBALS[ASLocationID]
											AND customerlocid = $srLocId
											AND effdt <= '$dbEffDt'
											AND ( endeffdt IS NULL OR endeffdt = '0000-00-00'
											OR endeffdt > '$dbEffDt' )
											GROUP BY productid
											ORDER BY productid";
					if($GLOBALS[debug])
						print($qryGetStdDrawInfo . "<br />\n");
					$rsltGetStdDrawInfo = mysqli_query( $GLOBALS[cvtconnection], $qryGetStdDrawInfo);
					if(!$rsltGetStdDrawInfo) {
						$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
						print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
						unset($GLOBALS[fileLineNbr]);
					}
					else {
						while($rowGetStdDrawInfo = mysqli_fetch_assoc($rsltGetStdDrawInfo)) {

							$prodId = $rowGetStdDrawInfo[prodId];
							if(!is_numeric($prodId))	$prodId = 0;
							$sdEffDt = $rowGetStdDrawInfo[sdEffDt];

							if($routeT == 'LR') {

								// NOW LETS CHECK FOR THE PUBLICATION SCHEDULE
								//LET'S FIRST GET DAYCODEIDS RELATED TO CUSTLOCID AND PRODUCTID
								$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetTableInfo($GLOBALS[debug], $GLOBALS[cvtconnection], "product", $prodId, "daycodeid");
								if($rsltArr[rtvalue]) {
									$prodDayCodeId = $rsltArr[daycodeid];
								}
								else {
									$prodDayCodeId = 0;
								}
								unset($rsltArr, $GLOBALS[fileLineNbr]);
								if(!is_numeric($prodDayCodeId)) $prodDayCodeId = 0;

								$prodDc = new DayCode();
								$prodDc->Set($prodDayCodeId);

								$GLOBALS[fileLineNbr] = __LINE__;
								if( $prodDc->IsIndeterminate() ) {

									// CHECKING FOR PUBLICATION IS OPEN OR NOT
									$GLOBALS[fileLineNbr] = __LINE__;
									if(IsPublicationOpen_SPECDRAW($prodId, $dbEffDt)) {

										// NOW CHECKING PUBLICATION HAVE AUTODRAW = ("Q/M/N") OR NOT.
										$selectStr = "dc.autodraw strAutoDraw";
										$fromStr = "product p, daycode dc";
										$whereStr = "p.recid = '$prodId'
													AND p.producttype = 'PU'
													AND (p.endeffdt IS NULL OR p.endeffdt = '0000-00-00' OR p.endeffdt > '$dbEffDt')
													AND p.daycodeid = dc.recid";
										$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetSingleRecInfo($GLOBALS[cvtconnection], $GLOBALS[debug], $selectStr, $fromStr, $whereStr);
										unset($selectStr, $fromStr, $whereStr, $GLOBALS[fileLineNbr]);

										if($rsltArr) {
											$strAutoDraw = $rsltArr[strAutoDraw];
										}
										else {
											$strAutoDraw = "";
										}
										unset($rsltArr);

										/*if($strAutoDraw == "Q" || $strAutoDraw == "N")
											continue;*/

										$qryGetTaSpInfo = "SELECT ta.specificproductid spId
															FROM transactivity ta, specificproduct sp
															WHERE ta.locationid = $GLOBALS[ASLocationID]
															AND ta.type = 'SD'
															AND ta.customerlocid = '$srLocId'
															AND sp.recid = ta.specificproductid
															AND sp.productid = $prodId
															ORDER BY ta.datet DESC LIMIT 1";

										// FOR SPLITTING OF TABLES
										$qryGetTaSpInfo = convertToSplitTables($qryGetTaSpInfo, $GLOBALS[val_SPLIT]);

										if($GLOBALS[debug])
											print($qryGetTaSpInfo . "<br />\n");
										$rsltGetTaSpInfo = mysqli_query( $GLOBALS[cvtconnection], $qryGetTaSpInfo);

										if(!$rsltGetTaSpInfo) {
											$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($GLOBALS[fileLineNbr]);
										}
										else {
											if(mysqli_num_rows($rsltGetTaSpInfo) == 0) {
												$spId = 0;
											}
											else {
												while($rowGetTaSpInfo = mysqli_fetch_assoc($rsltGetTaSpInfo)) {

													$spId = $rowGetTaSpInfo[spId];
													if(!is_numeric($spId))	$spId = 0;

													$qryChkRecs = "SELECT COUNT(*) sdCnt
																	FROM transactivity
																	WHERE locationid = $GLOBALS[ASLocationID]
																	AND customerlocid = $srLocId
																	AND specificproductid = $spId
																	AND datet = '$dbEffDt'
																	AND type = 'SD'";

													// FOR SPLITTING OF TABLES
													$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);
													if($GLOBALS[debug])
														print($qryChkRecs . "<br />\n");
													$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);

													$sdCnt = 0;
													if(!$rsltChkRecs) {
														$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
														print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
														unset($GLOBALS[fileLineNbr]);
													}
													else {
														$rowChkRecs = mysqli_fetch_assoc($rsltChkRecs);
														$sdCnt = $rowChkRecs[sdCnt];
													}

													if($srCntRs == 0 && $sdCnt > 0) {
														$qryUp = "UPDATE transactivity
																	SET specificrouteid = $rsSrId
																	WHERE locationid = $GLOBALS[ASLocationID]
																	AND customerlocid = $srLocId
																	AND specificproductid = $spId
																	AND datet = '$dbEffDt'
																	AND type = 'SD'";

														// FOR SPLITTING OF TABLES
														$qryUp = convertToSplitTables($qryUp, $GLOBALS[val_SPLIT]);

														if($GLOBALS[debug])
															print("<b>" . $qryUp . "</b><br />\n");
														$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
														if(!$rsltUp) {
															$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 03);
															print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " .
															$strErrorCode . "</span><br /><br />\n");
															unset($GLOBALS[fileLineNbr]);
														}
														if(!in_array($rsSrId, $rsRouteTypeArray)) {
															array_push($rsRouteTypeArray, $rsSrId);
														}
														$flagUpdateRouteDraw = true;
													}
													else {
														// CHECK FOR DUPLICATE
														$qryChkRecs = "SELECT COUNT(*) rowCnt
																		FROM transactivity
																		WHERE locationid = $GLOBALS[ASLocationID]
																		AND type = 'SD'
																		AND customerlocid = $srLocId
																		AND specificrouteid = $rsSrId
																		AND specificproductid = $spId
																		AND datet = '$dbEffDt'";
																		/*AND actquantity = 0*/

														// FOR SPLITTING OF TABLES
														$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);

														if($GLOBALS[debug])
															print($qryChkRecs . "<br />\n");
														$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
														if(!$rsltChkRecs) {
															$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
															print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
															unset($GLOBALS[fileLineNbr]);
														}
														else {
															if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
																$noRecs = $rowChkRecs[rowCnt];
																if(!is_numeric($noRecs)) $noRecs = 0;
															}
														}

														if($noRecs == 0) {
															$qryIns = "INSERT INTO transactivity(locationid, type,
																		customerlocid, specificrouteid, personid,
																		specificproductid, actquantity,
																		datet, activesession, closeddatecust,
																		closeddatevend, closeddatevendinv, closeddatecustpay)
																		VALUES('$GLOBALS[ASLocationID]', 'SD',
																		'$srLocId', '$rsSrId', '$srDriverId',
																		'$spId', 0,
																		'$dbEffDt', '$GLOBALS[RecIdAS]', '$GLOBALS[val_INDEF]',
																		'$GLOBALS[val_INDEF]', '$GLOBALS[val_INDEF]', '$GLOBALS[val_INDEF]')";

																// FOR SPLITTING OF TABLES
																$qryIns = convertToSplitTables($qryIns, $GLOBALS[val_SPLIT]);

																if($GLOBALS[debug])
																	print("<b>" . $qryIns . "</b><br />\n");
																$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
																if(!$rsltIns) {
																	$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 02);
																	print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
																	unset($GLOBALS[fileLineNbr]);
																}
														}
														else {
															if(!in_array($rsSrId, $rsRouteTypeArray)) {
																array_push($rsRouteTypeArray, $rsSrId);
															}
															$flagUpdateRouteDraw = true;
														}
													}
												}
											}
										}
									}
								}
							}
							else {

								$GLOBALS[fileLineNbr] = __LINE__;
								if(IsPublicationOpen_SPECDRAW($prodId, $dbEffDt)) {

									// NOW CHECKING PUBLICATION HAVE AUTODRAW = ("Q/N") OR NOT.
									$selectStr = "dc.autodraw strAutoDraw";
									$fromStr = "product p, daycode dc";
									$whereStr = "p.recid = '$prodId'
												AND p.producttype = 'PU'
												AND (p.endeffdt IS NULL OR p.endeffdt = '0000-00-00' OR p.endeffdt > '$dbEffDt')
												AND p.daycodeid = dc.recid";
									$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetSingleRecInfo($GLOBALS[cvtconnection], $GLOBALS[debug], $selectStr, $fromStr, $whereStr);
									unset($selectStr, $fromStr, $whereStr, $GLOBALS[fileLineNbr]);

									if($rsltArr) {
										$strAutoDraw = $rsltArr[strAutoDraw];
									}
									else {
										$strAutoDraw = "";
									}
									unset($rsltArr);

//									if($strAutoDraw == "Q" || $strAutoDraw == "M" || $strAutoDraw == "N")
									if($strAutoDraw == "Q" || $strAutoDraw == "N")
										continue;

									// NOW CHECKING FOR SPECIALDRAW RECORD EXISTS OR NOT
									$specialDrawFlag = false;
									$qryCheck = "SELECT COUNT(*) rowCnt
												FROM specialdraw
												WHERE clientlocid = $GLOBALS[ASLocationID]
												AND locationid = $srLocId
												AND productid = $prodId
												AND specificproductdate = '$dbEffDt'";
									if($GLOBALS[debug])
										print($qryCheck . "<br />\n");
									$rsltCheck = mysqli_query( $GLOBALS[cvtconnection], $qryCheck);
									if(!$rsltCheck) {
										$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
										print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
										unset($GLOBALS[fileLineNbr]);
									}
									else {
										$rowCheck = mysqli_fetch_assoc($rsltCheck);
										if($rowCheck[rowCnt] != 0) {
											$specialDrawFlag = true;
										}
									}

									// NOW CHECKING FOR SPECIALDRAW RECORD EXISTS OR NOT
									$leadLagFlag = false;
									$qryCheck = "SELECT COUNT(*) rowCnt
												FROM stddrawleadlag
												WHERE customerlocid = $srLocId
												AND productid = $prodId";
									if($GLOBALS[debug])
										print($qryCheck . "<br />\n");
									$rsltCheck = mysqli_query( $GLOBALS[cvtconnection], $qryCheck);
									if(!$rsltCheck) {
										$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
										print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
										unset($GLOBALS[fileLineNbr]);
									}
									else {
										$rowCheck = mysqli_fetch_assoc($rsltCheck);
										if($rowCheck[rowCnt] != 0) {
											$leadLagFlag = true;
										}
									}

									if($GLOBALS[debug])
										print("specialDrawFlag = $specialDrawFlag, leadLagFlag = $leadLagFlag<br />\n");

									if($leadLagFlag) {

										// GET ALL LEAD/LAG RECORD FOR LOCATION-PUBLICATION COMBINATION.
										$qryGetLeadLag = "SELECT day leadLagDay, leadlag leadLag,
															quantity leadLagQty
															FROM stddrawleadlag
															WHERE productid = $prodId
															AND customerlocid = $srLocId";
										if($GLOBALS[debug])
											print($qryGetLeadLag . "<br />\n");
										$rsltGetLeadLag = mysqli_query( $GLOBALS[cvtconnection], $qryGetLeadLag);
										if(!$rsltGetLeadLag) {
											$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
											print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
											unset($GLOBALS[fileLineNbr]);
										}
										else {
											if(mysqli_num_rows($rsltGetLeadLag) == 0) {
											}
											else {

												$rowGetLeadLag = mysqli_fetch_assoc($rsltGetLeadLag);
												$leadLagDay = $rowGetLeadLag[leadLagDay];
												$leadLag = $rowGetLeadLag[leadLag];
												$leadLagQty = $rowGetLeadLag[leadLagQty];
												if(!is_numeric($leadLagQty)) $leadLagQty = 0;

												if($GLOBALS[debug]) {
													print("<pre>ARRY = ");
													print_r($GLOBALS[dayToDowArr]);
													print("</pre>\n");
												}

												// LEAD LAG DAY OF WORD (0 TO 6 0 FOR "SUN")
												$leadLagDow = $GLOBALS[dayToDowArr][$leadLagDay];

												// RUN DATE DAY OF WORD (0 TO 6 0 FOR "SUN")
												$dowRunDate = date("w", mktime(0, 0, 0, substr($dbEffDt, 5, 2), substr($dbEffDt, 8, 2), substr($dbEffDt, 0, 4)));

												$leadLagDiff = $leadLagDow + $leadLag;

												if($leadLagDiff < 0) {
													$leadLagDiff = 7 + $leadLagDiff;
												}
												elseif($leadLagDiff >= 0) {
													$leadLagDiff = $leadLagDiff - 7;
												}

												if($dowRunDate == $leadLagDiff) {
													if($leadLag < 0) {
														$tempDate = DateOperations_TRADATE($dbEffDt, ($leadLag * -1), "ADD");
													}
													else {
														$tempDate = DateOperations_TRADATE($dbEffDt, $leadLag, "SUB");
													}

													// GET SPECIFICPRODUCTID
													$qryGetSpId = "SELECT recid spId
																	FROM specificproduct
																	WHERE productid = '$prodId'
																	AND datex = '$tempDate'
																	AND skeddeliv = '$tempDate'
																	AND (endeffdt IS NULL OR endeffdt = '0000-00-00' OR endeffdt > '$tempDate')";
													if($GLOBALS[debug])
														print($qryGetSpId . "<br />\n");
													$rsltGetSpId = mysqli_query( $GLOBALS[cvtconnection], $qryGetSpId);

													if(!$rsltGetSpId) {
														$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
														print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
														unset($GLOBALS[fileLineNbr]);
													}
													else {
														if(mysqli_num_rows($rsltGetSpId) == 0) {
														}
														else {
															$rowGetSpId = mysqli_fetch_assoc($rsltGetSpId);
															$spId = $rowGetSpId[spId];
															if(!is_numeric($spId)) $spId = 0;

															$qryChkRecs = "SELECT COUNT(*) sdCnt
																			FROM transactivity
																			WHERE locationid = $GLOBALS[ASLocationID]
																			AND customerlocid = $srLocId
																			AND specificproductid = $spId
																			AND datet = '$dbEffDt'
																			AND type = 'SD'";

															// FOR SPLITTING OF TABLES
															$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);
															if($GLOBALS[debug])
																print($qryChkRecs . "<br />\n");
															$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);

															$sdCnt = 0;
															if(!$rsltChkRecs) {
																$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
																print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
																unset($GLOBALS[fileLineNbr]);
															}
															else {
																$rowChkRecs = mysqli_fetch_assoc($rsltChkRecs);
																$sdCnt = $rowChkRecs[sdCnt];
															}

															if($srCntRs == 0 && $sdCnt > 0) {
																$qryUp = "UPDATE transactivity
																			SET specificrouteid  = $rsSrId
																			WHERE locationid = $GLOBALS[ASLocationID]
																			AND customerlocid = $srLocId
																			AND specificproductid = $spId
																			AND datet = '$dbEffDt'
																			AND type = 'SD'";

																// FOR SPLITTING OF TABLES
																$qryUp = convertToSplitTables($qryUp, $GLOBALS[val_SPLIT]);

																if($GLOBALS[debug])
																	print("<b>" . $qryUp . "</b><br />\n");
																$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
																if(!$rsltUp) {
																	$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 03);
																	print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
																	unset($GLOBALS[fileLineNbr]);
																}

																if(!in_array($rsSrId, $rsRouteTypeArray)) {
																	array_push($rsRouteTypeArray, $rsSrId);
																}
																$flagUpdateRouteDraw = true;
															}
															else {
																// HERE WE WILL CREATE TRANSACTIIVTY SD RECORD
																// CHECK FOR DUPLICATE
																$qryChkRecs = "SELECT COUNT(*) rowCnt
																				FROM transactivity
																				WHERE locationid = $GLOBALS[ASLocationID]
																				AND type = 'SD'
																				AND customerlocid = $srLocId
																				AND specificrouteid = $rsSrId
																				AND specificproductid = $spId
																				AND datet = '$dbEffDt'";
																				/*AND actquantity = 0*/

																// FOR SPLITTING OF TABLES
																$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);

																if($GLOBALS[debug])
																	print($qryChkRecs . "<br />\n");
																$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
																if(!$rsltChkRecs) {
																	$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
																	print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
																	unset($GLOBALS[fileLineNbr]);
																}
																else {
																	if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
																		$noRecs = $rowChkRecs[rowCnt];
																		if(!is_numeric($noRecs)) $noRecs = 0;
																	}
																}

																if($noRecs == 0) {
																	$qryIns = "INSERT INTO transactivity(locationid, type,
																				customerlocid, specificrouteid, personid,
																				specificproductid, actquantity,
																				datet, activesession, closeddatecust,
																				closeddatevend, closeddatevendinv, closeddatecustpay)
																				VALUES('$GLOBALS[ASLocationID]', 'SD',
																				'$srLocId', '$rsSrId', '$srDriverId',
																				'$spId', 0,
																				'$dbEffDt', '$GLOBALS[RecIdAS]', '$GLOBALS[val_INDEF]',
																				'$GLOBALS[val_INDEF]', '$GLOBALS[val_INDEF]', '$GLOBALS[val_INDEF]')";

																	// FOR SPLITTING OF TABLES
																	$qryIns = convertToSplitTables($qryIns, $GLOBALS[val_SPLIT]);

																	if($GLOBALS[debug])
																		print("<b>" . $qryIns . "</b><br />\n");

																	$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
																	if(!$rsltIns) {
																		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 02);
																		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
																		unset($GLOBALS[fileLineNbr]);
																	}
																}
																else {
																	if(!in_array($rsSrId, $rsRouteTypeArray)) {
																		array_push($rsRouteTypeArray, $rsSrId);
																	}
																	$flagUpdateRouteDraw = true;
																}
															}
														}
													}
												}
											}
										}
									}

									if(count($spProdIdArr[$prodId]) == 0) {

										for($cntId = 1; $cntId <= $GLOBALS[val_RSMAX]; $cntId++) {

											$dbCheckDate = DateOperations_TRADATE($dbEffDt, $cntId, "SUB");

											$qryGetTaSpInfo = "SELECT ta.specificproductid spId
																FROM transactivity ta, specificproduct sp
																WHERE ta.locationid = $GLOBALS[ASLocationID]
																AND ta.type = 'SD'
																AND ta.customerlocid = '$srLocId'
																AND sp.recid = ta.specificproductid
																AND sp.productid = $prodId
																AND ta.datet = '$dbCheckDate'
																ORDER BY ta.datet DESC LIMIT 1";


											// FOR SPLITTING OF TABLES
											$qryGetTaSpInfo = convertToSplitTables($qryGetTaSpInfo, $GLOBALS[val_SPLIT]);

											if($GLOBALS[debug])
												print($qryGetTaSpInfo . "<br />\n");
											$rsltGetTaSpInfo = mysqli_query( $GLOBALS[cvtconnection], $qryGetTaSpInfo);
											if(!$rsltGetTaSpInfo) {
												$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
												print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
												unset($GLOBALS[fileLineNbr]);
											}
											else {
												if(mysqli_num_rows($rsltGetTaSpInfo) == 0) {
													$spId = 0;
												}
												else {
													while($rowGetTaSpInfo = mysqli_fetch_assoc($rsltGetTaSpInfo)) {

														$spId = $rowGetTaSpInfo[spId];
														if(!is_numeric($spId))	$spId = 0;

														$qryChkRecs = "SELECT COUNT(*) sdCnt
																		FROM transactivity
																		WHERE locationid = $GLOBALS[ASLocationID]
																		AND customerlocid = $srLocId
																		AND specificproductid = $spId
																		AND datet = '$dbEffDt'
																		AND type = 'SD'";

														// FOR SPLITTING OF TABLES
														$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);
														if($GLOBALS[debug])
															print($qryChkRecs . "<br />\n");
														$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);

														$sdCnt = 0;
														if(!$rsltChkRecs) {
															$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
															print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " .
															$strErrorCode . "</span><br /><br />\n");
															unset($GLOBALS[fileLineNbr]);
														}
														else {
															$rowChkRecs = mysqli_fetch_assoc($rsltChkRecs);
															$sdCnt = $rowChkRecs[sdCnt];
														}

														if($srCntRs == 0 && $sdCnt > 0) {
															$qryUp = "UPDATE transactivity
																		SET specificrouteid = $rsSrId
																		WHERE locationid = $GLOBALS[ASLocationID]
																		AND customerlocid = $srLocId
																		AND specificproductid = $spId
																		AND datet = '$dbEffDt'
																		AND type = 'SD'";

															// FOR SPLITTING OF TABLES
															$qryUp = convertToSplitTables($qryUp, $GLOBALS[val_SPLIT]);

															if($GLOBALS[debug])
																print("<b>" . $qryUp . "</b><br />\n");
															$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
															if(!$rsltUp) {
																$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 03);
																print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
																unset($GLOBALS[fileLineNbr]);
															}
															if(!in_array($rsSrId, $rsRouteTypeArray)) {
																array_push($rsRouteTypeArray, $rsSrId);
															}
															$flagUpdateRouteDraw = true;
														}
														else {
															// CHECK FOR DUPLICATE
															$qryChkRecs = "SELECT COUNT(*) rowCnt
																			FROM transactivity
																			WHERE locationid = $GLOBALS[ASLocationID]
																			AND type = 'SD'
																			AND customerlocid = $srLocId
																			AND specificrouteid = $rsSrId
																			AND specificproductid = $spId
																			AND datet = '$dbEffDt'";
																			/*AND actquantity = 0*/

															// FOR SPLITTING OF TABLES
															$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);

															if($GLOBALS[debug])
																print($qryChkRecs . "<br />\n");
															$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
															if(!$rsltChkRecs) {
																$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
																print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
																unset($GLOBALS[fileLineNbr]);
															}
															else {
																if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
																	$noRecs = $rowChkRecs[rowCnt];
																	if(!is_numeric($noRecs)) $noRecs = 0;
																}
															}

															if($noRecs == 0) {
																$qryIns = "INSERT INTO transactivity(locationid, type,
																			customerlocid, specificrouteid, personid,
																			specificproductid, actquantity,
																			datet, activesession, closeddatecust,
																			closeddatevend, closeddatevendinv, closeddatecustpay)
																			VALUES('$GLOBALS[ASLocationID]', 'SD',
																			'$srLocId', '$rsSrId', '$srDriverId',
																			'$spId', 0,
																			'$dbEffDt', '$GLOBALS[RecIdAS]', '$GLOBALS[val_INDEF]',
																			'$GLOBALS[val_INDEF]', '$GLOBALS[val_INDEF]', '$GLOBALS[val_INDEF]')";

																	// FOR SPLITTING OF TABLES
																	$qryIns = convertToSplitTables($qryIns, $GLOBALS[val_SPLIT]);

																	if($GLOBALS[debug])
																		print("<b>" . $qryIns . "</b><br />\n");
																	$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
																	if(!$rsltIns) {
																		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 02);
																		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
																		unset($GLOBALS[fileLineNbr]);
																	}
															}
															else {
																if(!in_array($rsSrId, $rsRouteTypeArray)) {
																	array_push($rsRouteTypeArray, $rsSrId);
																}
																$flagUpdateRouteDraw = true;
															}
														}
													}
												}
											}

											if($spId != 0) {
												break;
											}
										}
									}
									else {

										foreach($spProdIdArr[$prodId] as $index => $spId) {

											if($GLOBALS[debug])
												print("spId = $spId<br />\n");

											// HERE LETS CHECK FOR LEAD LAG
											if($leadLagFlag && $leadLagQty == 0) {
												continue;
											}

											/*// NOW FINDING THE PRICES
											$rsltAmt = GetPrices_StdDraw($locId, $prodId, $dbEffDt,
												array(
													"flag_datex" => array(
														"dbdatex" => $dbEffDt
													)
												)
											);*/

											$qryChkRecs = "SELECT COUNT(*) sdCnt
															FROM transactivity
															WHERE locationid = $GLOBALS[ASLocationID]
															AND customerlocid = $srLocId
															AND specificproductid = $spId
															AND datet = '$dbEffDt'
															AND type = 'SD'";

											// FOR SPLITTING OF TABLES
											$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);
											if($GLOBALS[debug])
												print($qryChkRecs . "<br />\n");
											$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);

											$sdCnt = 0;
											if(!$rsltChkRecs) {
												$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
												print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
												unset($GLOBALS[fileLineNbr]);
											}
											else {
												$rowChkRecs = mysqli_fetch_assoc($rsltChkRecs);
												$sdCnt = $rowChkRecs[sdCnt];
											}

											if($srCntRs == 0 && $sdCnt > 0) {
												$qryUp = "UPDATE transactivity
															SET specificrouteid = $rsSrId
															WHERE locationid = $GLOBALS[ASLocationID]
															AND customerlocid = $srLocId
															AND specificproductid = $spId
															AND datet = '$dbEffDt'
															AND type = 'SD'";

												// FOR SPLITTING OF TABLES
												$qryUp = convertToSplitTables($qryUp, $GLOBALS[val_SPLIT]);

												if($GLOBALS[debug])
													print("<b>" . $qryUp . "</b><br />\n");
												$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
												if(!$rsltUp) {
													$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 03);
													print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
													unset($GLOBALS[fileLineNbr]);
												}
												if(!in_array($rsSrId, $rsRouteTypeArray)) {
													array_push($rsRouteTypeArray, $rsSrId);
												}
												$flagUpdateRouteDraw = true;
											}
											else {
												// CHECK FOR DUPLICATE
												$qryChkRecs = "SELECT COUNT(*) rowCnt
																FROM transactivity
																WHERE locationid = $GLOBALS[ASLocationID]
																AND type = 'SD'
																AND customerlocid = $srLocId
																AND specificrouteid = $rsSrId
																AND specificproductid = $spId
																AND datet = '$dbEffDt'";
																/*AND actquantity = 0*/

												// FOR SPLITTING OF TABLES
												$qryChkRecs = convertToSplitTables($qryChkRecs, $GLOBALS[val_SPLIT]);

												if($GLOBALS[debug])
													print($qryChkRecs . "<br />\n");
												$rsltChkRecs = mysqli_query( $GLOBALS[cvtconnection], $qryChkRecs);
												if(!$rsltChkRecs) {
													$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
													print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
													unset($GLOBALS[fileLineNbr]);
												}
												else {
													if($rowChkRecs = mysqli_fetch_assoc($rsltChkRecs)) {
														$noRecs = $rowChkRecs[rowCnt];
														if(!is_numeric($noRecs)) $noRecs = 0;
													}
												}

												if($noRecs == 0) {
													$qryIns = "INSERT INTO transactivity(locationid, type,
																customerlocid, specificrouteid, personid,
																specificproductid, actquantity,
																datet, activesession, closeddatecust,
																closeddatevend, closeddatevendinv, closeddatecustpay)
																VALUES('$GLOBALS[ASLocationID]', 'SD',
																'$srLocId', '$rsSrId', '$srDriverId',
																'$spId', 0,
																'$dbEffDt', '$GLOBALS[RecIdAS]', '$GLOBALS[val_INDEF]',
																'$GLOBALS[val_INDEF]', '$GLOBALS[val_INDEF]', '$GLOBALS[val_INDEF]')";

													// FOR SPLITTING OF TABLES
													$qryIns = convertToSplitTables($qryIns, $GLOBALS[val_SPLIT]);

													if($GLOBALS[debug])
														print("<b>" . $qryIns . "</b><br />\n");
													$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
													if(!$rsltIns) {
														$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 02);
														print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
														unset($GLOBALS[fileLineNbr]);
													}
												}
												else {
													if(!in_array($rsSrId, $rsRouteTypeArray)) {
														array_push($rsRouteTypeArray, $rsSrId);
													}
													$flagUpdateRouteDraw = true;
												}
											}
										}
									}
								}
							}
						}
					}
				}

				if($GLOBALS[debug])	print("<hr />");
			}

			if($flagUpdateRouteDraw) {

				// HERE WE NEED TO UPDATE THE ROUTEDRAWACCOUNTING VALUES FOR RS ROUTES
				if(is_array($rsRouteTypeArray) && count($rsRouteTypeArray) > 0) {
					$rsSrRouteIdStr = implode(", ", $rsRouteTypeArray);

					if($rsSrRouteIdStr == "") $rsSrRouteIdStr = "0";

					if($rsSrRouteIdStr != "0") {

						// FETCH TRANSACTIVITY RECORDS

						$qryGetTaQty = "SELECT specificrouteid rsSrId,
										specificproductid spId, SUM(actquantity) sdQty
										FROM transactivity
										WHERE locationid = $GLOBALS[ASLocationID]
										AND specificrouteid IN (" . $rsSrRouteIdStr . ")
										AND datet = '$dbEffDt'
										AND type = 'SD'
										GROUP BY specificrouteid, specificproductid";

						// FOR SPLITTING OF TABLES
						$qryGetTaQty = convertToSplitTables($qryGetTaQty, $GLOBALS[val_SPLIT]);

						if($GLOBALS[debug])
							print($qryGetTaQty . "<br />\n");
						$rsltGetTaQty = mysqli_query( $GLOBALS[cvtconnection], $qryGetTaQty);

						if(!$rsltGetTaQty) {
							$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($GLOBALS[fileLineNbr]);
						}
						else {
							while($rowGetTaQty = mysqli_fetch_assoc($rsltGetTaQty)) {
								$rsSrId = $rowGetTaQty[rsSrId];
								$spId = $rowGetTaQty[spId];
								$sdQty = $rowGetTaQty[sdQty];

								ValidateForInt(false, "sdQty", "rsSrId", "spId");

								// FINDING EXTRADRAW QUANTITY
								//$extraDrawQty = getExtraDrawQty_TRA($rsSrId, $spId);

								$extraDrawArr = getExtraDrawQty_TRA($rsSrId, $spId);

								$extraDrawQty = 0;
								if(isset($extraDrawArr) && count($extraDrawArr) > 0) {
									while(list($editionId, $edQty) = each($extraDrawArr) ) {
										ValidateForInt(false, "editionId", "edQty");
										$extraDrawQty += $edQty;
									}
								}
								$qtyIssued = $sdQty + $extraDrawQty;

								// NOW LETS UPADTE ROUETDRAWACCOUNTING TABLE WITH THIS SD QTY
								$qryUp = "UPDATE routedrawaccounting
											SET qtysked = $sdQty,
											qtyissued = $qtyIssued,
											archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
											WHERE clientlocid = $GLOBALS[ASLocationID]
											AND specificrouteid = $rsSrId
											AND actspecificproductid = $spId
											AND type = 'SD'";

								// FOR SPLITTING OF TABLES
								$qryUp = convertToSplitTables($qryUp, $GLOBALS[val_SPLIT]);

								if($GLOBALS[debug])
									print("<b>" . $qryUp . "</b><br />\n");
								$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
								if(!$rsltUp) {
									$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 03);
									print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
									unset($GLOBALS[fileLineNbr]);
								}
							}
						}
					}
				}
			}
		}
	}
}

/*
	THIS FUNCTION IS USED TO RECALCULATE THE TOTALDRAWACCCOUNTING.QTYSKED
	AND ROUTEDRAWACCOUNTING.QTYSKED
*/
function ReCalculateQtySked_TRA37($dbEffDt, $spId) {

	$val_REDIS = $GLOBALS[val_REDIS];
	$val_REGIN = $GLOBALS[val_REGIN];
	$val_VSGRT = $GLOBALS[val_VSGRT];
	if(!is_numeric($spId)) $spId = 0;

	if($dbEffDt == "") {
		return;
	}
	else {
		// FIRST OF ALL WE WILL GET THE SPECIFICPRODUCTID AND THEIR QUANTITIES
		$qryGetQ = "SELECT SUM(ta.actquantity) qty
					FROM transactivity ta
					WHERE ta.locationid = $GLOBALS[ASLocationID]
					AND ta.type = 'SD'
					AND ta.datet = '$dbEffDt'
					AND ta.specificproductid = $spId
					GROUP BY ta.specificproductid";

		// FOR SPLITTING OF TABLES
		$qryGetQ = convertToSplitTables($qryGetQ, $GLOBALS[val_SPLIT]);

		if($GLOBALS[debug])
			print($qryGetQ . "<br />\n");
		$rsltGetQ = mysqli_query( $GLOBALS[cvtconnection], $qryGetQ);
		if(!$rsltGetQ) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			while($rowGetQ = mysqli_fetch_assoc($rsltGetQ)) {
				$qty = $rowGetQ[qty];
				ValidateForInt(false, "qty");

				// UPDATE TOTALDRAWACCOUNTING
				$qryUp = "UPDATE totaldrawaccounting
						SET qtysked = $qty,
						archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
						WHERE clientlocid = $GLOBALS[ASLocationID]
						AND actspecificproductid = $spId
						AND type = 'S'";
				if($GLOBALS[debug])
					print("<b>" . $qryUp . "</b><br />\n");
				$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
				if(!$rsltUp) {
					$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 03);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($GLOBALS[fileLineNbr]);
				}
			}
		}

		// FOR ROUTEDRAWACCOUNTING
		// NOW WE WILL FIND THE SPECIFICROUTEID AND THEN BASED ON THIS
		// FIND THE SPECIFICPRODUCTID AND ITS QUANTITY

		$routeTypeStr = "'SR', 'PR'";
		if($GLOBALS[val_HAWKS] == "Y") {
			$routeTypeStr .= ", 'AM', 'PM', 'TR'";
		}

		$qryGetSRInfo = "SELECT sr.recid srId
						FROM specificroutes sr, route r
						WHERE sr.dispatchlocid = $GLOBALS[ASLocationID]
						AND sr.datesked = '$dbEffDt'
						AND sr.routeid = r.recid
						AND r.type IN($routeTypeStr)
						AND r.locationid = $GLOBALS[ASLocationID]";

		// FOR SPLITTING OF TABLES
		$qryGetSRInfo = convertToSplitTables($qryGetSRInfo, $GLOBALS[val_SPLIT]);

		if($GLOBALS[debug])
			print($qryGetSRInfo . "<br />\n");
		$rsltGetSRInfo = mysqli_query( $GLOBALS[cvtconnection], $qryGetSRInfo);
		if(!$rsltGetSRInfo) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			while($rowGetSRInfo = mysqli_fetch_assoc($rsltGetSRInfo)) {

				$srId = $rowGetSRInfo[srId];
				if(!is_numeric($srId))	$srId = 0;

				// FINDING THE LOCATIONS FROM SPECIFICROUTELOC
				$qryGetSRLInfo = "SELECT DISTINCT locationid locId
									FROM specificrouteloc
									WHERE clientlocid = $GLOBALS[ASLocationID]
									AND specificrouteid = $srId";

				// FOR SPLITTING OF TABLES
				$qryGetSRLInfo = convertToSplitTables($qryGetSRLInfo, $GLOBALS[val_SPLIT]);

				if($GLOBALS[debug])
					print($qryGetSRLInfo . "<br />\n");
				$rsltGetSRLInfo = mysqli_query( $GLOBALS[cvtconnection], $qryGetSRLInfo);
				$srlLocIdStr = "";
				if(!$rsltGetSRLInfo) {
					$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($GLOBALS[fileLineNbr]);
				}
				else {
					while($rowGetSRLInfo = mysqli_fetch_assoc($rsltGetSRLInfo)) {

						$locId = $rowGetSRLInfo[locId];
						if(!is_numeric($locId))	$locId = 0;

						if($srlLocIdStr == "") {
							$srlLocIdStr = $locId;
						}
						else {
							$srlLocIdStr .= ", " . $locId;
						}
					}
				}
				if($srlLocIdStr == "")
					$srlLocIdStr = "0";

				// GET ROUTEID
				$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetTableInfo($GLOBALS[debug], $GLOBALS[cvtconnection], "specificroutes", $srId, "routeid");
				if($rsltArr[rtvalue]) {
					$routeId = $rsltArr[routeid];
					if(!is_numeric($routeId)) $routeId = 0;
				}
				else {
					$routeId = 0;
				}
				unset($rsltArr, $GLOBALS[fileLineNbr]);

				$qryGetSPQtyInfo = "SELECT
									SUM(IF( ( ta.specificrouteid IS NULL OR ta.specificrouteid = 0 OR ta.specificrouteid = '') , ta.actquantity, 0)) qty, SUM( IF( ta.specificrouteid = $srId, ta.actquantity, 0)) srQty
									FROM transactivity ta
									WHERE ta.locationid = $GLOBALS[ASLocationID]
									AND ta.type = 'SD'
									AND ta.datet = '$dbEffDt'
									AND ta.specificproductid = $spId
									AND ta.customerlocid IN ($srlLocIdStr)
									GROUP BY ta.specificproductid";

				// FOR SPLITTING OF TABLES
				$qryGetSPQtyInfo = convertToSplitTables($qryGetSPQtyInfo, $GLOBALS[val_SPLIT]);

				if($GLOBALS[debug])
					print($qryGetSPQtyInfo . "<br />\n");
				$rsltGetSPQtyInfo = mysqli_query( $GLOBALS[cvtconnection], $qryGetSPQtyInfo);
				if(!$rsltGetSPQtyInfo) {
					$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($GLOBALS[fileLineNbr]);
				}
				else {
					$rowGetSPQtyInfo = mysqli_fetch_assoc($rsltGetSPQtyInfo);
					$qty = $rowGetSPQtyInfo[qty];
					$srQty = $rowGetSPQtyInfo[srQty];
				}
				ValidateForInt(false, "qty", "srQty");
				$qty += $srQty;

				// FINDING EXTRADRAW QUANTITY
				// $extraDrawQty = getExtraDrawQty_TRA($srId, $spId);

				$GLOBALS[fileLineNbr] = __LINE__;
				$extraDrawArr = getExtraDrawQty_TRA($srId, $spId);

				$extraDrawQty = 0;
				if(isset($extraDrawArr) && count($extraDrawArr) > 0) {
					while(list($editionId, $edQty) = each($extraDrawArr) ) {
						ValidateForInt(false, "editionId", "edQty");
						$extraDrawQty += $edQty;
					}
				}
				$qtyIssued = $qty + $extraDrawQty;

				// UPDATE ROUTEDRAWACCOUNTING
				$qryUp = "UPDATE routedrawaccounting
						SET qtysked = $qty,
						qtyissued = $qtyIssued,
						archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
						WHERE clientlocid = $GLOBALS[ASLocationID]
						AND actspecificproductid = $spId
						AND specificrouteid = $srId
						AND type = 'SD'";

				// FOR SPLITTING OF TABLES
				$qryUp = convertToSplitTables($qryUp, $GLOBALS[val_SPLIT]);

				if($GLOBALS[debug])
					print("<b>" . $qryUp . "</b><br />\n");
				$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
				if(!$rsltUp) {
					$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 03);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($GLOBALS[fileLineNbr]);

				}
				else {
					if($debug)
						print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
				}

				unset($srlLocIdStr);
			}
		}

		// FOR REGION DRAWACCOUNTING
		if($val_REDIS == "Y" && ( ($val_REGIN == "S" && $val_VSGRT == "Y") || $val_REGIN == "G")) {

			$qryGetRegion = "SELECT recid regionId
							FROM vendinggroup
							WHERE clientlocid = $GLOBALS[ASLocationID]";
			if($GLOBALS[debug])
				print($qryGetRegion . "<br />\n");
			$rsltGetRegion = mysqli_query( $GLOBALS[cvtconnection], $qryGetRegion);
			if(!$rsltGetRegion) {
				$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($GLOBALS[fileLineNbr]);
			}
			else {
				if(mysqli_num_rows($rsltGetRegion) == 0) {
				}
				else {
					while($rowGetRegion = mysqli_fetch_assoc($rsltGetRegion)) {
						// UPDATE REGIONDRAWACCOUNTING
						$regionId = $rowGetRegion[regionId];
						if(!is_numeric($regionId)) $regionId = 0;
						$qryGetLoc = "SELECT DISTINCT sr.locationid locId
										FROM standardroutes sr, vendingsubgroup vsg, vendinggroup vg
										WHERE vg.clientlocid = $GLOBALS[ASLocationID]
										AND vg.recid = $regionId
										AND vsg.vendinggroupid = vg.recid
										AND sr.routeid = vsg.routeid
										AND ( sr.endeffdt IS NULL OR sr.endeffdt = '0000-00-00'
										OR sr.endeffdt > '$curDate' )";
						if($GLOBALS[debug])
							print($qryGetLoc . "<br />\n");
						$rsltGetLoc = mysqli_query( $GLOBALS[cvtconnection], $qryGetLoc);
						if(!$rsltGetLoc) {
							$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($GLOBALS[fileLineNbr]);
						}
						else {
							if(mysqli_num_rows($rsltGetLoc) == 0) {
								$tempLocIdStr = "";
							}
							else {
								$tempLocIdStr = "";
								while($rowGetLoc = mysqli_fetch_assoc($rsltGetLoc)) {
									$locId = $rowGetLoc[locId];
									if(!is_numeric($locId)) $locId = 0;
									if($tempLocIdStr == "") $tempLocIdStr = $locId;
									else $tempLocIdStr .= ", " . $locId;

								}
							}
						}

						// FIRST OF ALL WE WILL GET THE SPECIFICPRODUCTID AND THEIR QUANTITIES
						$qryGetQ = "SELECT SUM(ta.actquantity) qty
									FROM transactivity ta
									WHERE ta.locationid = $GLOBALS[ASLocationID]
									AND ta.type = 'SD'
									AND ta.datet = '$dbEffDt'
									AND ta.specificproductid = $spId
									AND ta.customerlocid IN (" . $tempLocIdStr . ")
									GROUP BY ta.specificproductid";

						// FOR SPLITTING OF TABLES
						$qryGetQ = convertToSplitTables($qryGetQ, $GLOBALS[val_SPLIT]);

						if($GLOBALS[debug])
							print($qryGetQ . "<br />\n");
						$rsltGetQ = mysqli_query( $GLOBALS[cvtconnection], $qryGetQ);
						if(!$rsltGetQ) {
							$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($GLOBALS[fileLineNbr]);
						}
						else {
							$rowGetQ = mysqli_fetch_assoc($rsltGetQ);
							$qty = $rowGetQ[qty];
							ValidateForInt(false, "spId", "qty");
						}

						// UPDATE TOTALDRAWACCOUNTING
						$qryUp = "UPDATE regiondrawaccounting
									SET qtysked = $qty,
									archupdt = IF(archupdt IN ('X', 'P'), 'U', archupdt)
									WHERE clientlocid = $GLOBALS[ASLocationID]
									AND specificproductid = $spId
									AND vendinggroupid = $regionId";
						if($GLOBALS[debug])
							print("<b>" . $qryUp . "</b><br />\n");
						$rsltUp = mysqli_query( $GLOBALS[cvtconnection], $qryUp);
						if(!$rsltUp) {
							$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 02);
							print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
							unset($GLOBALS[fileLineNbr]);
						}
					}
				}
			}
		}
	}
}

/*
	THIS FUNCTION IS USED TO GET THE ZONE i.e. DemoGraphicValue.SDesc
	FOR GIVEN LOCATION USING DemoLocation
*/
function getZone_TRA37($locIdStr , $dbPubDate) {

	if($locIdStr == "") {
		$locIdStr = "0";
	}

	if($locIdStr == "0") {
		return "";
	}
	else {
		$qryGetInfo = "SELECT DISTINCT(dgv.recid) dgvId,
						SUBSTRING(dgv.sdesc, 1, 3) dgvDesc
						FROM demographicvalue dgv,
						demolocation dml, demographicvaluelink dgvl
						WHERE dml.locationid IN ( " . $locIdStr . ")
						AND dgv.recid = dml.demographicvalueid
						AND dgv.demographicid = 24
						AND ( dml.endeffdt IS NULL OR dml.endeffdt > '$dbPubDate' )
						AND dgvl.demographicvalueid = dgv.recid
						AND dgvl.locationid = $GLOBALS[ASLocationID]";
		if($GLOBALS[debug])
			print($qryGetInfo . "<br />\n");
		$rsltGetInfo = mysqli_query( $GLOBALS[cvtconnection], $qryGetInfo);
		if(!$rsltGetInfo) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			if(mysqli_num_rows($rsltGetInfo) == 0) {
				$dgvDesc = "";
			}
			elseif(mysqli_num_rows($rsltGetInfo) == 1) {
				$rowGetInfo = mysqli_fetch_assoc($rsltGetInfo);
				$dgvDesc = $rowGetInfo[dgvDesc];
			}
			else {
				$dgvDesc = "Multiple";
			}
		}

		return $dgvDesc;
	}
}

function IsNextDayCloseDrawDtSet_TRA37($dbEffDt) {

	$currDate = date('Y-m-d');

	$qryGetClosedDrawDt = "SELECT COUNT(recid) recCnt
							FROM productdispatch
							WHERE clientlocid = $GLOBALS[ASLocationID]
							AND DATE_FORMAT(closedrawdt, '%Y-%m-%d') = '$currDate' + INTERVAL 1 DAY";
	if($GLOBALS[debug])

		print($qryGetClosedDrawDt . "<br />\n");
	$rsltGetClosedDrawDt = mysqli_query( $GLOBALS[cvtconnection], $qryGetClosedDrawDt);

	if(!$rsltGetClosedDrawDt) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(01, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
		return false;
	}
	else {
		$rowGetClosedDrawDt = mysqli_fetch_assoc($rsltGetClosedDrawDt);
		$recCnt = $rowGetClosedDrawDt[recCnt];

		if($recCnt > 0) {
			return true;

		}
		else {
			return false;
		}
	}
}

function GetCCWiseExtraDraw_TRA37($regRouteIdStr, $costCodeId, $pcVendId, $prodId, $dbEffDt) {
	//Validation
	ValidateForInt(false, "costCodeId", "pcVendId", "prodId");

	//return value
	$edQty = 0;
	if($regRouteIdStr == "") $regRouteIdStr = "0";

	if($pcVendId != 0) {
		return $edQty;
	}
	else {
		/*NOW FIRST WE WILL FETCH EXTRACOPIES FOR THIS PUBLICATION*/
		//----------------------------------------
		/*FIRST WE WILL FETCH ALL THE ROUTES ON WHICH THIS PUBLICATION IS BEING DELIVERED*/
		# CREATE TEMPORARY TABLE
		$qryIns = "CREATE TEMPORARY TABLE
					tmpExtraDrawTRA37(
					clientlocid BIGINT(20) NOT NULL,
					routeid BIGINT(20) NOT NULL,
					productid BIGINT(20) NOT NULL,
					effdt DATE NOT NULL DEFAULT '0000-00-00',
					KEY tmpKey(clientlocid, routeid, productid, effdt)
		)";
		
		if($GLOBALS[debug])
			print("<br /><b>" . $qryIns . "</b><br />\n");
		$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
		if(!$rsltIns) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 05);
			print("<span class=\"dataerror\">Error Occurred. ErrorCode: " .
			$strErrorCode ."</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		$qryIns = "INSERT INTO tmpExtraDrawTRA37
					SELECT ed.clientlocid,
					ed.routeid,
					ed.productid,
					MAX(ed.effdt) effdt
					FROM extradraw ed
					WHERE ed.clientlocid = $GLOBALS[ASLocationID]
					AND ed.productid = $prodId
					AND ed.routeid IN ($regRouteIdStr)
					AND ed.effdt <= '$dbEffDt'
					AND (ed.endeffdt IS NULL OR ed.endeffdt = '0000-00-00' OR ed.endeffdt > '$dbEffDt')
					GROUP BY ed.clientlocid, ed.routeid,

					ed.productid";
					
		if($GLOBALS[debug])
			print($qryIns . "<br />\n");
		$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
		if(!$rsltIns) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}

		/*IF SPECIFICPRODUCT FOR THIS DATE DOES NOT EXIST THEN WE WILL RETURN EXTRADRAW QUANTITY AS 0*/
		$qryChkRecs = "SELECT COUNT(*) FROM specificproduct
						WHERE productid = $prodId
						AND datex = '$dbEffDt'
						AND ( endeffdt IS NULL OR endeffdt = '0000-00-00' OR endeffdt > '$dbEffDt' )";
						
		$arrInfo_ARCHIVE = array(
			"arrLookup" => array(
				"specificproduct" => array(
					"datex" => array(
						"dbFromDate" => $dbEffDt,
						"dbToDate" => $dbEffDt
					)
				)
			)
		);
		$rsltChkRecs = getQryResultSELECT($qryChkRecs, $arrInfo_ARCHIVE);
		$flagExist = false;
		if(!$rsltChkRecs) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			if($rowChkRecs = mysqli_fetch_row($rsltChkRecs)) {
				$noRecs = $rowChkRecs[0];
				if(!is_numeric($noRecs)) $noRecs = 0;
				if($noRecs > 0) $flagExist = true;
			}
		}
		if(!$flagExist) {
			$qryDropTmpTable = "DROP TEMPORARY TABLE tmpExtraDrawTRA37";
			if($GLOBALS[debug])
				print("<b>" . $qryDropTmpTable . "</b><br />\n");
			$rsltDropTmpTable = mysqli_query( $GLOBALS[cvtconnection], $qryDropTmpTable);
			if(!$rsltDropTmpTable) {
				$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
				print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
				unset($GLOBALS[fileLineNbr]);
			}
		
			return($edQty);
		}

		//GET DAYCODE RELATED INFORMATION
		$selectStr = "dc.day";
		$fromStr = "product p, daycode dc";
		$whereStr = "p.recid = $prodId
					AND (p.endeffdt IS NULL OR p.endeffdt = '0000-00-00'
					OR p.endeffdt > '$dbEffDt')
					AND p.daycodeid = dc.recid";
		$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetSingleRecInfo($GLOBALS[cvtconnection], $GLOBALS[debug], $selectStr, $fromStr, $whereStr);
		unset($selectStr, $fromStr, $whereStr, $GLOBALS[fileLineNbr]);
		if($rsltArr) {
			$dcDay = $rsltArr[day];
		}
		else {
			$dcDay = "";
		}

		// QRERY TO GET HOLIDAYDRAW, AND COUNT OF SPECIFICPRODUCT ON THIS DATE
		$selectStr = "holidaydraw";
		$fromStr = "specificproduct";
		$whereStr = "productid = $prodId
					AND datex = '$dbEffDt'
					AND (endeffdt IS NULL OR endeffdt = '0000-00-00' OR endeffdt > '$dbEffDt')
					GROUP BY productid, datex";
		$arrInfo_ARCHIVE = array(
			"arrLookup" => array(
				"specificproduct" => array(
					"datex" => array(
						"dbFromDate" => $dbEffDt,
						"dbToDate" => $dbEffDt
					)
				)
			)
		);
		$GLOBALS[fileLineNbr] = __LINE__; $rsltArr = GetSingleRecInfo($GLOBALS[cvtconnection], $GLOBALS[debug], $selectStr, $fromStr, $whereStr, $arrInfo_ARCHIVE);
		unset($selectStr, $fromStr, $whereStr, $arrInfo_ARCHIVE, $GLOBALS[fileLineNbr]);
		if($rsltArr) {
			$holidayDraw = $rsltArr[holidaydraw];
		}
		else {
			$holidayDraw = "";
		}
		unset($rsltArr);

		// GETTING PROPER SEASONDETAILID
		$qryGetSD = "SELECT sd.recid,
					CONCAT_WS('-', YEAR('$dbEffDt'), NULLIF(sd.frommonth, ''), NULLIF(sd.fromdate, ''))fromDt, CONCAT_WS('-', YEAR('$dbEffDt'), NULLIF(sd.tomonth, ''), NULLIF(sd.todate, '')) toDt
					FROM season s, seasondetail sd, product p
					WHERE p.recid = $prodId
					AND p.seasonid = s.recid
					AND s.recid = sd.seasonid
					AND (s.endeffdt IS NULL OR s.endeffdt = '0000-00-00'
					OR s.endeffdt > '$dbEffDt')";
		if($GLOBALS[debug])
			print($qtyGetSD . "<br />\n");
		$rsltGetSD = mysqli_query( $GLOBALS[cvtconnection], $qryGetSD);
		if(!$rsltGetSD) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			while($rowGetSD = mysqli_fetch_assoc($rsltGetSD)) {
				$tmpSeasonDetId = $rowGetSD[recid];
				$fromDt = $rowGetSD[fromDt];
				$toDt = $rowGetSD[toDt];
				if(!is_numeric($tmpSeasonDetId)) $tmpSeasonDetId = 0;

				if($fromDt > $toDt)
					$toDt = date("Y-m-d", mktime(0, 0, 0, substr($toDt, 5, 2), substr($toDt, 8, 2), substr($toDt, 0, 4) + 1));

				if($dbEffDt >= $fromDt && $dbEffDt <= $toDt)
					$seasonDetId = $tmpSeasonDetId;
			}
		}
		// SET SEASONDETAILSTR
		if(!is_numeric($seasonDetId)) $seasonDetId = 0;
		if($seasonDetId == 0) {
			$seasonStr = "( seasondetailid IS NULL OR seasondetailid = 0 OR seasondetailid = '' )";
		}
		else {
			$seasonStr = "seasondetailid = " . $seasonDetId . "";
		}

		/*NOW WE WILL FIND EXTRADRAW QUANTITY*/
		$dayOfEffDt = strtolower(date("D", mktime(0, 0, 0, substr($dbEffDt, 5, 2), substr($dbEffDt, 8, 2), substr($dbEffDt, 0, 4))));
		$edQtyDayStr = "qty" . $dayOfEffDt;

		$qryGetEdQty = "SELECT ed.recid edId, $edQtyDayStr edQty,
						ed.qtyind, ed.qtyhol, ed.qtyhol2,
						ed.qtyhol3, ed.qtyhol4
						FROM extradraw ed, tmpExtraDrawTRA37 ted
						WHERE ed.clientlocid = $GLOBALS[ASLocationID]
						AND ed.routeid = ted.routeid
						AND ed.productid = ted.productid
						AND " . $seasonStr . "
						AND ed.effdt = ted.effdt
						AND (ed.endeffdt IS NULL OR ed.endeffdt = '0000-00-00'
						OR ed.endeffdt > '$dbEffDt')
						AND ed.costcodeid = '$costCodeId'";

		if($GLOBALS[debug])
			print($qryGetEdQty . "<br />\n");
		$rsltGetEdQty = mysqli_query( $GLOBALS[cvtconnection], $qryGetEdQty);
		if(!$rsltGetEdQty) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		else {
			while($rowGetEdQty = mysqli_fetch_assoc($rsltGetEdQty)) {
				if($dcDay == "IND") {
					$edQty += $rowGetEdQty[qtyind];
				}
				elseif($holidayDraw == "Y") {
					$edQty += $rowGetEdQty[qtyhol];
				}
				elseif($holidayDraw == "2") {
					$edQty += $rowGetEdQty[qtyhol2];
				}
				elseif($holidayDraw == "3") {
					$edQty += $rowGetEdQty[qtyhol3];
				}
				elseif($holidayDraw == "4") {
					$edQty += $rowGetEdQty[qtyhol4];
				}
				else {
					$edQty += $rowGetEdQty[edQty];
				}
			}
			if(!is_numeric($edQty)) $edQty = 0;
		}

		$qryDropTmpTable = "DROP TEMPORARY TABLE tmpExtraDrawTRA37";
		if($GLOBALS[debug])
			print("<b>" . $qryDropTmpTable . "</b><br />\n");
		$rsltDropTmpTable = mysqli_query( $GLOBALS[cvtconnection], $qryDropTmpTable);
		if(!$rsltDropTmpTable) {
			$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
			print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
			unset($GLOBALS[fileLineNbr]);
		}
		return($edQty);
	}
}
/*
THIS FUNCTION WILL CREATE THE TRANSACTIVITYMC RECORDS FOR EACH HAWKER LOCATIONS
*/
function createHawkerTransMC_TRA37($dbEffDt) {

	if($dbEffDt == "") {
		return;
	}

	// FIRST DELETE THE TRANSACTIVITYMC RECORDS IF ALREADY EXIST FOR THE RUN DATE
	$qryDel = "DELETE FROM transactivitymc
				WHERE locationid = $GLOBALS[ASLocationID]
				AND type = 'HA'
				AND datet = '$dbEffDt'";

	if($GLOBALS[debug])
		print("<b>" . $qryDel . "</b><br />\n");
	$rsltDel = mysqli_query( $GLOBALS[cvtconnection], $qryDel);
	if(!$rsltDel) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 04);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		if($GLOBALS[debug])
			print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
	}


	// HERE WE NEED TO FIND THE TRANSACTIVITY "SD" RECORDS FOR EACH LOCATION
	$qryGetLocs = "SELECT DISTINCT ta.customerlocid custLocId,
					ta.specificproductid spId, ta.specificrouteid srId
					FROM transactivity ta
					WHERE ta.locationid = $GLOBALS[ASLocationID]
					AND ta.type = 'SD'
					AND ta.datet = '$dbEffDt'";

	// FOR SPLITTING OF TABLES
	$qryGetLocs = convertToSplitTables($qryGetLocs, $GLOBALS[val_SPLIT]);

	if($GLOBALS[debug])
		print($qryGetLocs . "<br />\n");
	$rsltGetLocs = mysqli_query( $GLOBALS[cvtconnection], $qryGetLocs);

	if(!$rsltGetLocs) {
		$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 01);
		print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " .
		$strErrorCode . "</span><br /><br />\n");
		unset($GLOBALS[fileLineNbr]);
	}
	else {
		while($rowGetLocs = mysqli_fetch_assoc($rsltGetLocs)) {
			$custLocId = $rowGetLocs[custLocId];
			$spId = $rowGetLocs[spId];
			$srId = $rowGetLocs[srId];
			ValidateForInt(false, "custLocId", "spId", "srId");

			if($srId != 0) {


				// HERE CREATE THE NEW TRANSACTIVITYMC RECORDS FOR EACH SD RECORDS
				$qryIns = "INSERT INTO transactivitymc(locationid, type, datet, specificproductid,
							specificrouteid, customerlocid, auditpresent, creationdt)
							VALUES($GLOBALS[ASLocationID], 'HA', '$dbEffDt', $spId, $srId, $custLocId, 'N', NOW())";

				if($GLOBALS[debug])
					print("<b>" . $qryIns . "</b><br />\n");

				$rsltIns = mysqli_query( $GLOBALS[cvtconnection], $qryIns);
				if(!$rsltIns) {
					$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(19, 02);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($GLOBALS[fileLineNbr]);
				}
				else {
					if($GLOBALS[debug])
						print("<b>" . mysqli_affected_rows($GLOBALS["___mysqli_ston"]) . "</b> affected.<br />\n");
				}
			}
		}
	}
}

/*
	THIS FUNCTION WILL SPLIT VALUE OF LOCATIONSYSTEM VERXX AND
	RETURN VALUE RELATED TO PASSED DEVICEID.
*/
function getDPVersion_TRA37($deviceTypeId, $strVERXX) {

	$strVersionNbr = "";
	$deviceVersionArr = array();

	$versionArr = explode("|", $strVERXX);

	for($cntId = 0; $cntId < count($versionArr); $cntId++) {
		$tmpDeviceTypeId = 0;
		$tempVersionNbr = "";
		list($tmpDeviceTypeId, $tmpVersionNbr) = explode("~", $versionArr[$cntId]);

		$deviceVersionArr[$tmpDeviceTypeId] = $tmpVersionNbr;
		unset($tmpDeviceTypeId, $tmpVersionNbr);
	}

	$strVersionNbr = $deviceVersionArr[$deviceTypeId];

	return $strVersionNbr;
}
/* 3.2 */
// FUNCTION FOR GET THE ROUTE GROUP DESCRIPTION USING ROUTE GROUP ID STRING
function GetRouteGroupDesc($routeGroupIdStr)
{
				
				$routeGroupIdArray = explode(", ", $routeGroupIdStr);
				$WhereRoute = '';
				$FromRoute = '';
				if(count($routeGroupIdArray) > 1)
				{
					foreach($routeGroupIdArray as $id)
					$routeGroupid[] = "(" . addslashes($id) . ")";
				
					$routeGroupid = implode("," , $routeGroupid);	
					
					
					// Create temporary table for routegroupid
					$queryCreateroute_Tmp="Create /*tra37*/ temporary Table if not exists tmp_route_data (routeGroupid bigint(20) NOT NULL,KEY routeGroupid (routeGroupid))";
					if($debug)
					{
						print("queryCreateroute_Tmp:$queryCreateroute_Tmp");
					}
					$resCreateroute_Tmp=mysqli_query($GLOBALS["___mysqli_ston"], $queryCreateroute_Tmp);
					
					$queryCreatTempprod="Truncate tmp_route_data";
					if($debug)
					{
						print("queryCreatTempprod:$queryCreatTempprod");
					}
					$resCreatTemp=mysqli_query($cvtconnection, $queryCreatTempprod);
                                        
                                        // Create routegroupid into temporary table
					$QryInsTemp_route="insert /*tra37*/ into tmp_route_data (routeGroupid) values $routeGroupid ";
					
					if($debug)
						echo "<br>$QryInsTemp_route";
						
					$resroute = mysqli_query($GLOBALS["___mysqli_ston"], $QryInsTemp_route);
					
					$WhereRoute = "AND rg.recid = tempdata.routeGroupid";
					$FromRoute = ", tmp_route_data tempdata ";
				}
				else
				{
					$FromRoute = '';
					$WhereRoute = "AND rg.recid in ($routeGroupIdStr)";
				}
				
                                // get the route Group description using routegroupid
				$qryGetRoute = "select /*tra37*/ DISTINCT(rg.recid),
							CONCAT_WS(' - ', NULLIF(rg.groupsdesc, ''), NULLIF(subGroupSDesc, '')) routeGroupDesc
							FROM routegroup rg $FromRoute
							WHERE rg.clientlocid = '".$GLOBALS[ASLocationID]."'
							$WhereRoute
							ORDER BY sortSeqNbr";
							
				if($GLOBALS[debug])
					print($qryGetRoute . "<br />\n");
					
				$rsltGetRoute = mysqli_query( $GLOBALS[cvtconnection], $qryGetRoute);
				
				if(!$rsltGetRoute) {
					$GLOBALS[fileLineNbr] = __LINE__; $strErrorCode = getErrorCode(12, 01);
					print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
					unset($GLOBALS[fileLineNbr]);
				}

				$flagFirstDVal = true;
				$selectedroute = '';
				if($rsltGetRoute) {
					while($rowGetRoute = mysqli_fetch_assoc($rsltGetRoute)) {
						$routeinfo = $rowGetRoute[routeGroupDesc];
						if(!$flagFirstDVal) {
							$selectedroute .= " , ";
						}
						else {
							$flagFirstDVal = false;
						}
						$selectedroute .= $routeinfo;
					}
				}
				return $selectedroute;
}
/* 3.2 */
function fn_process_EMR($twochar, $dbEffDt, $debug, $cvtconnection) {
    $twochar = trim($twochar);
    $ARSstrvar = "ARS" . $twochar;
    $ARXstrvar = "ARX" . $twochar;
    if($twochar == "65"){
        $groupcode = "RCA";
        $clientmsg_str = "DTI Mid-week files";
    } else if($twochar == "66"){
        $groupcode = "RSR";
        $clientmsg_str = "Draw file to RS";
    } else if($twochar == "67"){
        $groupcode = "DSS";
        $clientmsg_str = "DSI Mid-week files";
    }
    
    $str_ARS = GetLSVar($ARSstrvar, "strvar", $GLOBALS[ASLocationID], $cvtconnection);
    if ($debug)
        print("$ARSstrvar = $str_ARS<br />\n");

    if ($str_ARS != '2099-01-01 00:00:00') {
        //Send Email
        $fromCompName = GetComp($GLOBALS[ASCompanyID], $cvtconnection);

        $strSubject = "$clientmsg_str could not be created";
        $msg = "<p>$clientmsg_str could not be created for $fromCompName for Run Date " . get_date($dbEffDt, "MM/DD/YY") . ", Please check System setting $ARSstrvar and set it to run manually</p>";

        $from = "\"$fromCompName\" <$GLOBALS[val_EMLID]>";
        #$to = "support@teaksi.com";
        $qryGetPersonInfo = "SELECT p.email email, p.recid
                                    FROM notifyperson np, notifygrouplink ngl, personlink pl, person p
                                    WHERE ngl.locationid = '$GLOBALS[ASLocationID]' 
                                    AND ngl.groupcode = '$groupcode' 
                                    AND ngl.groupcode = np.groupcode
                                    AND np.personlinkid = pl.recid
                                    AND pl.locationid = '$GLOBALS[ASLocationID]' 
                                    AND p.recid = pl.personid
                                    AND ( pl.endeffdt IS NULL OR pl.endeffdt = '0000-00-00' OR pl.endeffdt > '$dbEffDt' ) ";
        if ($debug)
            print("<b>" . $qryGetPersonInfo . "</b><br />\n");
        $rsltGetPersonInfo = mysqli_query($cvtconnection, $qryGetPersonInfo);
        $email_ary = array();
        if (!$rsltGetPersonInfo) {
            $GLOBALS[fileLineNbr] = __LINE__;
            $strErrorCode = getErrorCode(19, 02);
            print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
            unset($GLOBALS[fileLineNbr]);
        } else {
            while ($rowGetPersonInfo = mysqli_fetch_assoc($rsltGetPersonInfo)) {
                $email = $rowGetPersonInfo[email];

                if ($email != '') {
                    array_push($email_ary, $email);
                }
            }
        }
        $email_ary = array_values($email_ary);
        $to = MakeStr_TRA37($email_ary);
        if ($debug)
            print("to = $to<br />\n");


        // CREATING MAIL CLASS OBJECT\
        $mailExObj = new htmlMimeMailEx();

        // SETTING THE "FROM" VALUES
        $mailExObj->setFrom($from);

        // SETTING THE "TO" VALUES
        $mailExObj->addTo($to);

        // SETTING THE "SUBJECT" VALUES
        $mailExObj->setSubject($strSubject);

        // SETTING THE "MESSAGE" VALUES
        $mailExObj->setHtml($msg);

        if ($mailExObj->send("mail")) {
            if ($debug) {
                echo "Mail send to $to<br>";
            }
        } else {
            if ($debug) {
                echo "Mail Not Sent - Some problem exist<br>";
            }
        }
    } else {
        $datevar_ARX = GetLSVar($ARXstrvar, "datevar", $GLOBALS[ASLocationID], $cvtconnection);
        if (strtotime($dbEffDt) < strtotime($datevar_ARX)) {
            
        } else {
            $qryUp = "UPDATE locationsystem
                            SET strvar = NOW()
                            WHERE locationid = '$GLOBALS[ASLocationID]'
                            AND recid = '$ARSstrvar'";
            if ($debug)
                print("<b>" . $qryUp . "</b><br />\n");
            $rsltUp = mysqli_query($cvtconnection, $qryUp);
            if (!$rsltUp) {
                $GLOBALS[fileLineNbr] = __LINE__;
                $strErrorCode = getErrorCode(19, 02);
                print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
                unset($GLOBALS[fileLineNbr]);
            }

            $qryUp = "UPDATE locationsystem
                            SET datevar = '$dbEffDt'
                            WHERE locationid = '$GLOBALS[ASLocationID]'
                            AND recid = '$ARXstrvar'";
            if ($debug)
                print("<b>" . $qryUp . "</b><br />\n");
            $rsltUp = mysqli_query($cvtconnection, $qryUp);
            if (!$rsltUp) {
                $GLOBALS[fileLineNbr] = __LINE__;
                $strErrorCode = getErrorCode(19, 02);
                print("<br /><span class=\"dataerror\">Error Occurred. ErrorCode: " . $strErrorCode . "</span><br /><br />\n");
                unset($GLOBALS[fileLineNbr]);
            }
        }
    }
}

?>
